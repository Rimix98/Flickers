п»ї<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flickers Messenger РІСљРЃ</title>
    
    <!-- PWA (manifest Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµРЎвЂљРЎРѓРЎРЏ РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎвЂЎР ВµРЎР‚Р ВµР В· HTTP) -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flickers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Flickers Messenger">
    <script>
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С manifest РЎвЂљР С•Р В»РЎРЉР С”Р С• Р ВµРЎРѓР В»Р С‘ Р Р…Р Вµ file:// Р С—РЎР‚Р С•РЎвЂљР С•Р С”Р С•Р В»
        if (location.protocol !== 'file:') {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = 'manifest.json';
            document.head.appendChild(link);
        }
    </script>
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-TileImage" content="icon-256.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icon-48.png">
    <link rel="apple-touch-icon" sizes="128x128" href="icon-128.png">
    <link rel="apple-touch-icon" sizes="256x256" href="icon-256.png">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --transition-speed: 0.3s;
        }

        body { font-family: 'Inter', sans-serif; transition: background 0.5s ease, color 0.5s ease; }
        
        /* Р В¦Р Р†Р ВµРЎвЂљР С•Р Р†РЎвЂ№Р Вµ РЎРѓРЎвЂ¦Р ВµР СРЎвЂ№ */
        body.theme-light { --bg-app: #f1f5f9; --bg-card: #ffffff; --text: #1e293b; --border: #e2e8f0; --accent: #4f46e5; }
        body.theme-dark { --bg-app: #0f172a; --bg-card: #1e293b; --text: #f1f5f9; --border: #334155; --accent: #6366f1; }
        body.theme-cosmic { 
            --bg-app: #020617; 
            --bg-card: rgba(30, 41, 59, 0.7); 
            --text: #e2e8f0; 
            --border: rgba(99, 102, 241, 0.3); 
            --accent: #818cf8;
            background: linear-gradient(135deg, #020617 0%, #1e1b4b 50%, #020617 100%);
        }
        
        /* Р С™Р С•РЎРѓР СР С‘РЎвЂЎР ВµРЎРѓР С”Р В°РЎРЏ РЎвЂљР ВµР СР В° - РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљРЎвЂ№ */
        body.theme-cosmic::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(236, 72, 153, 0.1) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
            animation: cosmic-shift 20s ease-in-out infinite;
        }
        @keyframes cosmic-shift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        body.theme-cosmic .glass-panel {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.1);
        }
        
        body.theme-cosmic .message-bubble.sent {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.8)) !important;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        body.theme-cosmic .message-bubble.received {
            background: rgba(30, 41, 59, 0.8) !important;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        /* Р СћР ВµР СР В° Р С’Р СР ВµРЎвЂљР С‘РЎРѓРЎвЂљ - Premium */
        body.theme-amethyst { 
            --bg-app: #0c0015; 
            --bg-card: rgba(45, 20, 60, 0.8); 
            --text: #f5e6ff; 
            --border: rgba(168, 85, 247, 0.3); 
            --accent: #c084fc;
            background: linear-gradient(135deg, #0c0015 0%, #2d1440 30%, #1a0a2e 70%, #0c0015 100%);
        }
        
        body.theme-amethyst::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 30% 70%, rgba(168, 85, 247, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 60%);
            pointer-events: none;
            z-index: -1;
            animation: amethyst-glow 15s ease-in-out infinite;
        }
        @keyframes amethyst-glow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        body.theme-amethyst .glass-panel {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(168, 85, 247, 0.25);
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.15);
        }
        
        body.theme-amethyst .message-bubble.sent {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.9), rgba(236, 72, 153, 0.8)) !important;
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
            color: white !important;
        }
        
        body.theme-amethyst .message-bubble.received {
            background: rgba(45, 20, 60, 0.9) !important;
            border: 1px solid rgba(168, 85, 247, 0.25);
        }

        body { background-color: var(--bg-app); color: var(--text); }
        .glass-panel { background-color: var(--bg-card); border: 1px solid var(--border); backdrop-filter: blur(16px); }
        
        /* Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В° - Р С—Р ВµРЎР‚Р ВµР С•Р С—РЎР‚Р ВµР Т‘Р ВµР В»Р ВµР Р…Р С‘Р Вµ РЎвЂљР ВµР СР Р…РЎвЂ№РЎвЂ¦ РЎвЂћР С•Р Р…Р С•Р Р† */
        body.theme-light .glass-panel,
        body.theme-light [class*="bg-slate-800"],
        body.theme-light [class*="bg-slate-900"],
        body.theme-light [class*="dark:bg-slate"] {
            background-color: var(--bg-card) !important;
        }
        body.theme-light [class*="bg-slate-100"],
        body.theme-light [class*="bg-slate-50"] {
            background-color: #f8fafc !important;
        }
        body.theme-light [class*="text-slate-400"] {
            color: #64748b !important;
        }
        body.theme-light [class*="text-slate-500"] {
            color: #64748b !important;
        }
        body.theme-light [class*="border-slate"] {
            border-color: var(--border) !important;
        }
        body.theme-light input,
        body.theme-light textarea,
        body.theme-light select {
            background-color: #f8fafc !important;
            color: var(--text) !important;
        }
        body.theme-light button:not(.message-bubble):not([class*="bg-indigo"]):not([class*="bg-purple"]):not([class*="bg-red"]):not([class*="bg-green"]):not([class*="bg-blue"]):not([class*="bg-yellow"]):not([class*="bg-gradient"]) {
            background-color: #f8fafc !important;
        }
        body.theme-light button:hover:not(.message-bubble):not([class*="bg-indigo"]):not([class*="bg-purple"]):not([class*="bg-red"]):not([class*="bg-green"]):not([class*="bg-blue"]):not([class*="bg-yellow"]):not([class*="bg-gradient"]) {
            background-color: #e2e8f0 !important;
        }
        
        /* Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В° - РЎРЊР С”РЎР‚Р В°Р Р… Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ */
        body.theme-light #loading-overlay {
            background-color: #f1f5f9 !important;
        }
        body.theme-light #loading-overlay .text-white {
            color: #1e293b !important;
        }
        
        /* Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В° - Р В°Р Т‘Р СР С‘Р Р… Р С—Р В°Р Р…Р ВµР В»РЎРЉ */
        body.theme-light #admin-panel .bg-white {
            background-color: #ffffff !important;
        }
        body.theme-light #admin-panel [class*="dark:bg-slate"] {
            background-color: #ffffff !important;
        }
        body.theme-light #admin-panel [class*="dark:border-slate"] {
            border-color: #e2e8f0 !important;
        }
        body.theme-light #admin-panel .text-slate-400,
        body.theme-light #admin-panel .text-slate-500 {
            color: #64748b !important;
        }
        
        /* Р В­Р С”РЎР‚Р В°Р Р… Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ - Р В°Р Т‘Р В°Р С—РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р С—Р С•Р Т‘ РЎвЂљР ВµР СРЎС“ */
        #loading-overlay {
            background-color: var(--bg-app);
        }
        #loading-overlay .text-white {
            color: var(--text);
        }
        
        /* ========== Р Р€Р вЂєР Р€Р В§Р РЃР вЂўР СњР СњР В«Р в„ў Р В­Р С™Р В Р С’Р Сњ Р вЂ”Р С’Р вЂњР В Р Р€Р вЂ”Р С™Р В ========== */
        
        /* Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– РЎвЂћР С•Р Р… */
        .loading-bg-animation {
            position: absolute;
            inset: 0;
            overflow: hidden;
            opacity: 0.3;
        }
        
        .loading-bg-animation::before,
        .loading-bg-animation::after {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            filter: blur(80px);
            animation: float 8s ease-in-out infinite;
        }
        
        .loading-bg-animation::before {
            background: var(--accent);
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }
        
        .loading-bg-animation::after {
            background: #8b5cf6;
            bottom: -200px;
            right: -200px;
            animation-delay: 4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(50px, 50px) scale(1.1); }
        }
        
        /* Р С™Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ Р В»Р С•Р С–Р С•РЎвЂљР С‘Р С—Р В° */
        .loading-logo-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
        }
        
        /* Р вЂєР С•Р С–Р С•РЎвЂљР С‘Р С— */
        .loading-logo {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 30px;
            font-size: 48px;
            color: white;
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4);
            animation: logo-pulse 2s ease-in-out infinite;
            z-index: 2;
        }
        
        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 25px 80px rgba(99, 102, 241, 0.6); }
        }
        
        /* Р С™Р С•Р В»РЎРЉРЎвЂ Р В° Р Р†Р С•Р С”РЎР‚РЎС“Р С– Р В»Р С•Р С–Р С•РЎвЂљР С‘Р С—Р В° */
        .loading-ring {
            position: absolute;
            inset: 0;
            border: 3px solid var(--accent);
            border-radius: 30px;
            opacity: 0;
        }
        
        .loading-ring-1 {
            animation: ring-expand 2s ease-out infinite;
            animation-delay: 0s;
        }
        
        .loading-ring-2 {
            animation: ring-expand 2s ease-out infinite;
            animation-delay: 0.7s;
        }
        
        .loading-ring-3 {
            animation: ring-expand 2s ease-out infinite;
            animation-delay: 1.4s;
        }
        
        @keyframes ring-expand {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.8);
                opacity: 0;
            }
        }
        
        /* Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ */
        .loading-title {
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 0.1em;
            background: linear-gradient(135deg, var(--accent), #8b5cf6, var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease infinite;
            margin-bottom: 10px;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Р РЋР В»Р С•Р С–Р В°Р Р… */
        .loading-subtitle {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            opacity: 0.7;
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .loading-subtitle-text {
            display: inline-block;
            animation: slide-in 1s ease-out;
        }
        
        @keyframes slide-in {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Р СџРЎР‚Р С•Р С–РЎР‚Р ВµРЎРѓРЎРѓ-Р В±Р В°РЎР‚ */
        .loading-progress-container {
            width: 200px;
            height: 4px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            border-radius: 2px;
            animation: progress-loading 2s ease-in-out infinite;
            box-shadow: 0 0 10px var(--accent);
        }
        
        @keyframes progress-loading {
            0% { width: 0%; transform: translateX(0); }
            50% { width: 70%; }
            100% { width: 100%; transform: translateX(0); }
        }
        
        /* Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓ */
        .loading-status {
            font-size: 14px;
            color: var(--text);
            opacity: 0.5;
            animation: fade-pulse 2s ease-in-out infinite;
        }
        
        @keyframes fade-pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
        
        /* ========== Р СћР вЂўР СљР В« Р вЂќР вЂєР Р‡ Р В­Р С™Р В Р С’Р СњР С’ Р вЂ”Р С’Р вЂњР В Р Р€Р вЂ”Р С™Р В ========== */
        
        /* Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В° */
        body.theme-light #loading-overlay {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
        }
        
        body.theme-light .loading-logo {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            box-shadow: 0 20px 60px rgba(59, 130, 246, 0.4);
        }
        
        body.theme-light .loading-ring {
            border-color: #3b82f6;
        }
        
        body.theme-light .loading-title {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #3b82f6);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        body.theme-light .loading-progress-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            box-shadow: 0 0 10px #3b82f6;
        }
        
        body.theme-light .loading-bg-animation::before {
            background: #3b82f6;
        }
        
        /* Р СћРЎвЂР СР Р…Р В°РЎРЏ РЎвЂљР ВµР СР В° */
        body.theme-dark #loading-overlay {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        
        /* Р С™Р С•РЎРѓР СР С‘РЎвЂЎР ВµРЎРѓР С”Р В°РЎРЏ РЎвЂљР ВµР СР В° */
        body.theme-cosmic #loading-overlay {
            background: linear-gradient(135deg, #020617 0%, #1e1b4b 50%, #020617 100%);
        }
        
        body.theme-cosmic .loading-bg-animation::before {
            background: #818cf8;
        }
        
        body.theme-cosmic .loading-bg-animation::after {
            background: #ec4899;
        }
        
        body.theme-cosmic .loading-logo {
            background: linear-gradient(135deg, #818cf8, #ec4899);
            box-shadow: 0 20px 60px rgba(129, 140, 248, 0.5);
        }
        
        /* Р С’Р СР ВµРЎвЂљР С‘РЎРѓРЎвЂљ РЎвЂљР ВµР СР В° */
        body.theme-amethyst #loading-overlay {
            background: linear-gradient(135deg, #0c0015 0%, #2d1440 50%, #0c0015 100%);
        }
        
        body.theme-amethyst .loading-bg-animation::before {
            background: #a855f7;
        }
        
        body.theme-amethyst .loading-bg-animation::after {
            background: #ec4899;
        }
        
        body.theme-amethyst .loading-logo {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            box-shadow: 0 20px 60px rgba(168, 85, 247, 0.5);
        }
        
        body.theme-amethyst .loading-ring {
            border-color: #c084fc;
        }
        
        body.theme-amethyst .loading-title {
            background: linear-gradient(135deg, #a855f7, #ec4899, #a855f7);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        body.theme-amethyst .loading-progress-bar {
            background: linear-gradient(90deg, #a855f7, #ec4899);
            box-shadow: 0 0 10px #a855f7;
        }
        
        /* Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…Р В°РЎРЏ Р В°Р Т‘Р В°Р С—РЎвЂљР В°РЎвЂ Р С‘РЎРЏ */
        @media (max-width: 768px) {
            .loading-logo-container {
                width: 100px;
                height: 100px;
            }
            
            .loading-logo {
                font-size: 40px;
                border-radius: 25px;
            }
            
            .loading-ring {
                border-radius: 25px;
            }
            
            .loading-title {
                font-size: 36px;
            }
            
            .loading-subtitle {
                font-size: 14px;
            }
            
            .loading-progress-container {
                width: 150px;
            }
        }
        
        /* Р С’Р С”РЎвЂљР С‘Р Р†Р Р…Р В°РЎРЏ Р С”Р Р…Р С•Р С—Р С”Р В° РЎвЂљР ВµР СРЎвЂ№ */
        .theme-btn.active {
            border-width: 2px !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2) !important;
        }
        body.theme-light .theme-btn.active {
            border-color: #f59e0b !important;
            background: rgba(251, 191, 36, 0.1) !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2) !important;
        }
        body.theme-dark .theme-btn.active {
            border-color: #6366f1 !important;
            background: rgba(99, 102, 241, 0.1) !important;
        }
        body.theme-cosmic .theme-btn.active {
            border-color: #818cf8 !important;
            background: rgba(129, 140, 248, 0.15) !important;
        }
        body.theme-amethyst .theme-btn.active {
            border-color: #c084fc !important;
            background: rgba(192, 132, 252, 0.15) !important;
            box-shadow: 0 0 0 3px rgba(192, 132, 252, 0.2) !important;
        }
        
        /* Р С™Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ РЎРѓ Р В±Р В»РЎР‹РЎР‚Р С•Р С */
        .chat-menu-blur {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Р С™Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– РЎРѓ Р В±Р В»РЎР‹РЎР‚Р С•Р С */
        .msg-context-menu {
            background: rgba(15, 23, 42, 0.9) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В° - Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ */
        body.theme-light .chat-menu-blur,
        body.theme-light .msg-context-menu {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        }
        body.theme-light .msg-context-menu button,
        body.theme-light .chat-menu-blur button {
            color: var(--text) !important;
        }
        body.theme-light .msg-context-menu button:hover,
        body.theme-light .chat-menu-blur button:hover {
            background: rgba(0, 0, 0, 0.05) !important;
        }
        
        /* Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р С—Р С•РЎРЏР Р†Р В»Р ВµР Р…Р С‘РЎРЏ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– */
        .message-bubble { 
            max-width: 80%; 
            border-radius: 1.25rem; 
            animation: msg-slide-up 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            transform-origin: bottom;
            transition: transform 0.2s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        .message-bubble p,
        .message-bubble span,
        .message-bubble div {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        /* Р РЋР Р†Р В°Р в„–Р С— Р Т‘Р В»РЎРЏ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° */
        .message-bubble.swiping {
            transition: none;
        }
        .message-bubble .swipe-reply-hint {
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            color: var(--accent);
        }
        .message-bubble.swiping .swipe-reply-hint {
            opacity: 1;
        }

        /* Р РЋРЎвЂљР С‘Р В»Р С‘ Р Т‘Р В»РЎРЏ Р С—Р С•РЎРѓРЎвЂљР С•Р Р† Р С”Р В°Р Р…Р В°Р В»Р В° */
        .channel-post {
            animation: msg-slide-up 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .channel-post:hover {
            background: var(--bg-secondary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .reaction-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reaction-badge:hover {
            background: var(--accent);
            color: white;
        }
        .reaction-badge.reacted {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--accent);
        }

        /* Р В¦Р С‘РЎвЂљР В°РЎвЂљР В° (Р С•РЎвЂљР Р†Р ВµРЎвЂљ Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ) */
        .reply-quote {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--accent);
            padding: 6px 10px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .reply-quote:hover {
            background: rgba(99, 102, 241, 0.2);
        }
        .reply-quote-author {
            font-size: 11px;
            font-weight: bold;
            color: var(--accent);
        }
        .reply-quote-text {
            font-size: 12px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .sent .reply-quote {
            background: rgba(255,255,255,0.15);
            border-left-color: rgba(255,255,255,0.5);
        }
        .sent .reply-quote-author {
            color: rgba(255,255,255,0.9);
        }
        
        /* Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ */
        .pinned-message-bar {
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            color: white;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .pinned-message-bar:hover {
            opacity: 0.9;
        }
        .pinned-message-bar i {
            font-size: 14px;
        }
        .pinned-message-content {
            flex: 1;
            overflow: hidden;
        }
        .pinned-message-label {
            font-size: 10px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .pinned-message-text {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Р СџР В°Р Р…Р ВµР В»РЎРЉ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° */
        .reply-panel {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slide-down 0.2s ease;
        }
        @keyframes slide-down {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .reply-panel-content {
            flex: 1;
            border-left: 3px solid var(--accent);
            padding-left: 10px;
        }
        .reply-panel-author {
            font-size: 12px;
            font-weight: bold;
            color: var(--accent);
        }
        .reply-panel-text {
            font-size: 12px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @keyframes msg-slide-up {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .sent { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .received { background: var(--bg-card); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
        
        /* Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В° - РЎРѓР С‘Р Р…Р С‘Р в„– РЎвЂ Р Р†Р ВµРЎвЂљ Р Т‘Р В»РЎРЏ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р Р…РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– */
        body.theme-light .sent,
        body.theme-light .message-bubble.sent {
            background: #3b82f6 !important;
            color: white !important;
        }

        /* Р В Р ВµР В°Р С”РЎвЂ Р С‘Р С‘ Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ */
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }
        .reaction-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(0,0,0,0.1);
        }
        .sent .reaction-badge {
            background: rgba(255,255,255,0.2);
        }
        .reaction-badge:hover {
            transform: scale(1.1);
        }
        .reaction-badge.my-reaction {
            background: rgba(99, 102, 241, 0.3);
            box-shadow: 0 0 0 2px var(--accent);
        }
        .reaction-badge .reaction-count {
            font-size: 11px;
            font-weight: bold;
        }
        .reaction-picker {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 6px 10px;
            display: flex;
            gap: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 100;
            animation: reaction-picker-in 0.2s ease;
        }
        @keyframes reaction-picker-in {
            from { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.9); }
            to { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }
        .reaction-picker button {
            font-size: 22px;
            padding: 4px;
            border-radius: 8px;
            transition: all 0.15s;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .reaction-picker button:hover {
            transform: scale(1.3);
            background: rgba(99, 102, 241, 0.2);
        }

        /* ========== Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№Р в„– UI (Telegram-style) ========== */
        
        /* Telegram-style Input Area */
        .tg-input-wrapper {
            display: none;
        }
        .tg-send-btn, .tg-voice-btn {
            display: none;
        }
        .desktop-input-btns {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tg-panels-container {
            flex: 1;
        }
        
        /* Sidebar resize handle */
        .sidebar-resize-handle {
            position: absolute;
            top: 0;
            right: -4px;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            z-index: 100;
            background: transparent;
            transition: background 0.2s;
        }
        .sidebar-resize-handle:hover,
        .sidebar-resize-handle.active {
            background: var(--accent);
        }
        #sidebar {
            position: relative;
            transition: none;
        }
        #sidebar.resizing {
            user-select: none;
        }
        
        /* Desktop input field */
        .desktop-msg-input {
            display: block;
        }
        
        /* Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№Р в„– input Р Р…Р В° Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—Р Вµ */
        .tg-input-row {
            display: none;
        }
        .mobile-attach-menu {
            display: none;
        }
        
        @media (max-width: 768px) {
            /* Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С resize handle Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
            .sidebar-resize-handle {
                display: none !important;
            }
            
            /* Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—Р Р…РЎвЂ№Р Вµ Р С”Р Р…Р С•Р С—Р С”Р С‘ */
            .desktop-input-btns {
                display: none !important;
            }
            
            /* Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—Р Р…РЎвЂ№Р в„– input */
            .desktop-msg-input {
                display: none !important;
            }
            
            /* Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С plus-menu-container Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
            .plus-menu-container {
                display: none !important;
            }
            
            /* Telegram-style input row */
            .tg-input-row {
                display: flex;
                align-items: flex-end;
                gap: 8px;
                padding: 8px 12px;
                background: var(--bg-primary);
                width: 100%;
            }
            
            .tg-emoji-btn-left {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: transparent;
                border: none;
                color: #9ca3af;
                font-size: 22px;
                cursor: pointer;
                flex-shrink: 0;
            }
            .tg-emoji-btn-left:active {
                color: var(--accent);
            }
            
            .tg-input-center {
                flex: 1;
                min-width: 0;
            }
            
            .tg-message-input {
                width: 100%;
                background: transparent;
                border: none;
                outline: none;
                font-size: 16px;
                color: var(--text-primary);
                resize: none;
                max-height: 120px;
                min-height: 22px;
                height: auto;
                line-height: 22px;
                padding: 0;
                margin: 10px 0;
                vertical-align: top;
                overflow-y: auto;
                box-sizing: border-box;
            }
            .tg-message-input::placeholder {
                color: #9ca3af;
            }
            
            .tg-attach-btn,
            .tg-mic-btn,
            .tg-send-btn-right {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: transparent;
                border: none;
                color: #9ca3af;
                font-size: 20px;
                cursor: pointer;
                flex-shrink: 0;
            }
            .tg-attach-btn:active,
            .tg-mic-btn:active {
                color: var(--accent);
            }
            
            .tg-mic-btn.hidden {
                display: none !important;
            }
            
            .tg-send-btn-right {
                background: var(--accent);
                color: white;
                font-size: 16px;
            }
            .tg-send-btn-right:not(.hidden) {
                display: flex !important;
            }
            .tg-send-btn-right:active {
                transform: scale(0.95);
            }
            
            /* Mobile attach menu - Telegram style */
            .mobile-attach-menu {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-primary);
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
                z-index: 1000;
                animation: slideUpMenu 0.25s ease;
                max-height: 70vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            }
            .mobile-attach-menu.hidden {
                display: none !important;
            }
            
            @keyframes slideUpMenu {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }
            
            /* Gallery section */
            .attach-gallery-section {
                flex: 1;
                overflow-y: auto;
                padding: 12px;
                min-height: 200px;
                max-height: 45vh;
                position: relative;
            }
            
            .attach-gallery-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }
            
            .attach-gallery-placeholder {
                grid-column: span 3;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px;
                color: var(--text-secondary);
                gap: 12px;
            }
            .attach-gallery-placeholder i {
                font-size: 48px;
                opacity: 0.3;
            }
            .attach-gallery-placeholder span {
                font-size: 13px;
                opacity: 0.6;
            }
            
            .attach-gallery-item {
                aspect-ratio: 1;
                position: relative;
                border-radius: 4px;
                overflow: hidden;
                cursor: pointer;
            }
            .attach-gallery-item img,
            .attach-gallery-item video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .attach-gallery-item.selected::after {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(99, 102, 241, 0.4);
                border: 3px solid var(--accent);
            }
            .attach-gallery-item .gallery-check {
                position: absolute;
                top: 6px;
                right: 6px;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background: var(--accent);
                color: white;
                display: none;
                align-items: center;
                justify-content: center;
                font-size: 12px;
            }
            .attach-gallery-item.selected .gallery-check {
                display: flex;
            }
            .attach-gallery-item .hd-badge {
                position: absolute;
                bottom: 4px;
                left: 4px;
                background: rgba(0,0,0,0.6);
                color: white;
                font-size: 9px;
                padding: 2px 4px;
                border-radius: 3px;
                font-weight: bold;
            }
            
            /* Bottom action buttons */
            .attach-actions-bar {
                display: flex;
                justify-content: space-around;
                padding: 16px 8px;
                border-top: 1px solid var(--border);
                background: var(--bg-secondary);
                position: relative;
                z-index: 1001;
            }
            
            .attach-action-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                padding: 8px;
                border-radius: 12px;
                transition: all 0.2s;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                user-select: none;
            }
            .attach-action-item:active {
                transform: scale(0.95);
                background: rgba(99, 102, 241, 0.1);
            }
            
            .attach-action-icon {
                width: 52px;
                height: 52px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 22px;
                color: white;
            }
            .attach-action-icon.gallery-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
            .attach-action-icon.file-icon { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
            .attach-action-icon.location-icon { background: linear-gradient(135deg, #22c55e, #16a34a); }
            .attach-action-icon.event-icon { background: linear-gradient(135deg, #ec4899, #db2777); }
            .attach-action-icon.poll-icon { background: linear-gradient(135deg, #f97316, #ea580c); }
            .attach-action-icon.ai-icon { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
            .attach-action-icon.game-icon { background: linear-gradient(135deg, #14b8a6, #0d9488); }
            .attach-action-icon.video-icon { background: linear-gradient(135deg, #a855f7, #9333ea); }
            .attach-action-icon.schedule-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
            .attach-action-icon.tasks-icon { background: linear-gradient(135deg, #6366f1, #4f46e5); }
            
            .attach-action-item span {
                font-size: 11px;
                color: var(--text-secondary);
                font-weight: 500;
            }
            
            /* Send selected button */
            .attach-send-btn {
                position: fixed;
                bottom: 200px;
                right: 20px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                color: white;
                display: none;
                align-items: center;
                justify-content: center;
                font-size: 22px;
                box-shadow: 0 8px 24px rgba(99, 102, 241, 0.6);
                cursor: pointer;
                z-index: 1200;
                border: none;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            .attach-send-btn.visible {
                display: flex !important;
            }
            .attach-send-btn:active {
                transform: scale(0.9);
                background: linear-gradient(135deg, #4f46e5, #7c3aed);
            }
            
            /* Hide old styles */
            .mobile-attach-grid {
                display: none !important;
            }
            
            /* Hide old toolbar */
            .tg-mobile-toolbar {
                display: none !important;
            }
            .tg-input-wrapper {
                display: none !important;
            }
            
            /* Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Telegram-style РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљРЎвЂ№ */
            .tg-input-wrapper {
                display: flex;
                align-items: flex-end;
                flex: 1;
                background: var(--bg-card);
                border-radius: 24px;
                padding: 4px 4px 4px 8px;
                border: 1px solid var(--border);
                gap: 4px;
                min-height: 48px;
                max-height: 150px;
            }
            
            .tg-attach-btn {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                background: transparent;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
                flex-shrink: 0;
            }
            .tg-attach-btn:active {
                background: rgba(99, 102, 241, 0.1);
                color: var(--accent);
            }
            .tg-attach-btn i {
                font-size: 18px;
                transform: rotate(45deg);
            }
            
            .tg-input-field {
                flex: 1;
                display: flex;
                align-items: center;
                position: relative;
                min-width: 0;
            }
            
            .tg-message-input {
                flex: 1;
                border: none;
                background: transparent;
                outline: none;
                font-size: 16px;
                padding: 8px 0;
                color: var(--text-primary);
                min-width: 0;
                resize: none;
                max-height: 120px;
                overflow-y: auto;
                line-height: 1.4;
                font-family: inherit;
            }
            .tg-message-input::placeholder {
                color: var(--text-secondary);
                opacity: 0.6;
            }
            
            .tg-input-actions {
                display: flex;
                align-items: center;
                gap: 2px;
                flex-shrink: 0;
            }
            
            .tg-emoji-btn, .tg-sticker-btn {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                background: transparent;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
            }
            .tg-emoji-btn:active, .tg-sticker-btn:active {
                background: rgba(99, 102, 241, 0.1);
                color: var(--accent);
            }
            .tg-emoji-btn i, .tg-sticker-btn i {
                font-size: 18px;
            }
            
            /* Telegram-style Send/Voice buttons (Р Р†Р Р…РЎС“РЎвЂљРЎР‚Р С‘ Р С—Р С•Р В»РЎРЏ) */
            .tg-send-btn, .tg-voice-btn {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
                flex-shrink: 0;
            }
            
            .tg-send-btn {
                background: var(--accent);
                color: white;
                display: none;
            }
            .tg-send-btn.tg-send-active {
                display: flex;
                animation: tg-btn-pop 0.2s ease;
            }
            .tg-send-btn:active {
                transform: scale(0.9);
            }
            .tg-send-btn i {
                font-size: 14px;
            }
            
            .tg-voice-btn {
                background: var(--accent);
                color: white;
                display: flex;
            }
            .tg-voice-btn.tg-voice-hidden {
                display: none;
            }
            .tg-voice-btn:active {
                transform: scale(0.9);
                background: #ef4444;
            }
            .tg-voice-btn i {
                font-size: 14px;
            }
            
            @keyframes tg-btn-pop {
                0% { transform: scale(0.8); opacity: 0; }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
            }
            
            /* Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—Р В°Р Р…Р ВµР В»Р С‘ Р С”Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
            .tg-panels-container {
                position: absolute;
                bottom: 100%;
                left: 0;
                right: 0;
                flex: none;
            }
            
            /* Р СџР В°Р Р…Р ВµР В»РЎРЉ РЎРѓРЎвЂљР С‘Р С”Р ВµРЎР‚Р С•Р Р† Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ - Р С•РЎвЂљР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµРЎвЂљРЎРѓРЎРЏ РЎРѓР В»Р ВµР Р†Р В° */
            .sticker-panel {
                position: fixed !important;
                left: 12px !important;
                right: auto !important;
                bottom: 70px !important;
                width: calc(100vw - 24px) !important;
                max-width: 350px !important;
                z-index: 9999 !important;
                transform: translateX(0) !important;
            }
            
            /* Р С’Р Т‘Р В°Р С—РЎвЂљР С‘РЎР‚РЎС“Р ВµР С footer Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
            #chat-footer {
                padding: 8px 12px !important;
            }
            #chat-footer > div.max-w-5xl {
                flex-wrap: wrap;
                gap: 8px !important;
            }
            
            /* Plus menu Р В°Р Т‘Р В°Р С—РЎвЂљР В°РЎвЂ Р С‘РЎРЏ */
            .plus-menu {
                bottom: calc(100% + 8px) !important;
                left: 8px !important;
                right: auto !important;
                min-width: 200px;
            }
            
            /* Voice recording UI - РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—Р Р…РЎвЂ№Р в„– Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
            #voice-recording-ui,
            .desktop-only-voice {
                display: none !important;
                visibility: hidden !important;
                position: absolute !important;
                left: -9999px !important;
            }
            
            /* Р В¤Р С‘Р С”РЎРѓР С‘РЎР‚РЎС“Р ВµР С Р Р†РЎвЂ№РЎРѓР С•РЎвЂљРЎС“ input row Р С—РЎР‚Р С‘ Р В·Р В°Р С—Р С‘РЎРѓР С‘ */
            .tg-input-row {
                min-height: 56px;
            }
            
            /* Р В¤Р С‘Р С”РЎРѓР С‘РЎР‚РЎС“Р ВµР С footer */
            #chat-footer {
                flex-shrink: 0;
            }
        }
        
        @media (max-width: 768px) {
            #main-app {
                flex-direction: column;
            }
            
            #main-app > aside {
                position: fixed;
                inset: 0;
                width: 100%;
                z-index: 30;
                transition: transform 0.3s ease;
            }
            
            #main-app > aside.mobile-hidden {
                transform: translateX(-100%);
            }
            
            #main-app > main {
                position: fixed;
                inset: 0;
                z-index: 25;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }
            
            #main-app > main.mobile-visible {
                transform: translateX(0);
            }
            
            #chat-placeholder {
                display: none !important;
            }
            
            .mobile-back-btn {
                display: flex !important;
            }
            
            /* Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С placeholder Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
            #main-app > main:not(.mobile-visible) {
                pointer-events: none;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-back-btn {
                display: none !important;
            }
            
            #main-app > aside {
                transform: none !important;
            }
            
            #main-app > main {
                transform: none !important;
                position: relative !important;
            }
        }

        /* Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            background: var(--bg-card);
            border: 1px solid var(--accent);
            border-left: 5px solid var(--accent);
            padding: 16px 20px;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toast-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            cursor: pointer;
            max-width: 320px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .notification-toast:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        
        body.theme-light .notification-toast {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        body.theme-light .notification-toast:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        @keyframes toast-in {
            from { 
                transform: translateX(120%) scale(0.8); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
        }

        .toast-out {
            animation: toast-out 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
        }
        
        /* Р СџРЎР‚Р С•Р СР С—РЎвЂљ Р Т‘Р В»РЎРЏ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘РЎРЏ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р в„– */
        .notification-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            animation: slide-up 0.3s ease;
        }
        .notification-prompt-content {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        @keyframes slide-up {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        /* Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ Р С• Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В° */
        .screen-share-notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
        @media (max-width: 768px) {
            #screen-share-btn {
                display: none;
            }
            #screen-share-indicator {
                display: none !important;
            }
        }
        
        /* ========== Р С›Р СџР СћР ВР СљР ВР вЂ”Р С’Р В¦Р ВР В Р вЂќР вЂєР Р‡ Р СљР С›Р вЂР ВР вЂєР В¬Р СњР В«Р Тђ Р Р€Р РЋР СћР В Р С›Р в„ўР РЋР СћР вЂ™ ========== */
        @media (max-width: 768px) {
            /* Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С РЎвЂљРЎРЏР В¶РЎвЂР В»РЎвЂ№Р Вµ РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљРЎвЂ№ (Р С”РЎР‚Р С•Р СР Вµ Р С”Р С•РЎРѓР СР С‘РЎвЂЎР ВµРЎРѓР С”Р С•Р в„– РЎвЂљР ВµР СРЎвЂ№) */
            body:not(.theme-cosmic) .glass-panel {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }
            
            /* Р С™Р С•РЎРѓР СР С‘РЎвЂЎР ВµРЎРѓР С”Р В°РЎРЏ РЎвЂљР ВµР СР В° - Р С•РЎРѓРЎвЂљР В°Р Р†Р В»РЎРЏР ВµР С Р В±Р В»РЎР‹РЎР‚ */
            body.theme-cosmic .glass-panel {
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                background: rgba(15, 23, 42, 0.75) !important;
            }
            
            /* Р С™Р С•РЎРѓР СР С‘РЎвЂЎР ВµРЎРѓР С”Р В°РЎРЏ РЎвЂљР ВµР СР В° - Р С”РЎР‚Р В°РЎРѓР С‘Р Р†РЎвЂ№Р в„– РЎвЂћР С•Р Р… */
            body.theme-cosmic {
                background: linear-gradient(135deg, #020617 0%, #1e1b4b 50%, #020617 100%) !important;
            }
            body.theme-cosmic::before {
                content: '';
                position: fixed;
                inset: 0;
                background: 
                    radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(236, 72, 153, 0.1) 0%, transparent 40%);
                pointer-events: none;
                z-index: -1;
            }
            
            /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…Р В°РЎРЏ Р С—РЎР‚Р С•Р С‘Р В·Р Р†Р С•Р Т‘Р С‘РЎвЂљР ВµР В»РЎРЉР Р…Р С•РЎРѓРЎвЂљРЎРЉ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ */
            * {
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Р СџР В»Р В°Р Р†Р Р…Р В°РЎРЏ Р С—РЎР‚Р С•Р С”РЎР‚РЎС“РЎвЂљР С”Р В° */
            html {
                scroll-behavior: smooth;
            }
            
            /* Р С›Р С—РЎвЂљР С‘Р СР С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘Р в„– */
            .message-bubble {
                will-change: transform;
            }
            
            /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ touch-РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљРЎвЂ№ */
            button:active:not(.message-bubble) {
                transform: scale(0.95);
            }
            
            /* Р СћР ВµР СР В° Р С’Р СР ВµРЎвЂљР С‘РЎРѓРЎвЂљ - Р С•РЎРѓРЎвЂљР В°Р Р†Р В»РЎРЏР ВµР С Р В±Р В»РЎР‹РЎР‚ */
            body.theme-amethyst .glass-panel {
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                background: rgba(45, 20, 60, 0.85) !important;
            }
            
            /* Р СћР ВµР СР В° Р С’Р СР ВµРЎвЂљР С‘РЎРѓРЎвЂљ - Р С”РЎР‚Р В°РЎРѓР С‘Р Р†РЎвЂ№Р в„– РЎвЂћР С•Р Р… */
            body.theme-amethyst {
                background: linear-gradient(135deg, #0c0015 0%, #2d1440 30%, #1a0a2e 70%, #0c0015 100%) !important;
            }
            body.theme-amethyst::before {
                content: '';
                position: fixed;
                inset: 0;
                background: 
                    radial-gradient(circle at 30% 70%, rgba(168, 85, 247, 0.2) 0%, transparent 50%),
                    radial-gradient(circle at 70% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                    radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 60%);
                pointer-events: none;
                z-index: -1;
            }
            
            /* Р Р€Р С—РЎР‚Р С•РЎвЂ°Р В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘Р С‘ */
            .message-bubble {
                animation: none !important;
                opacity: 1 !important;
                transform: none !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: break-word !important;
                max-width: 85% !important;
            }
            
            /* Р СџР ВµРЎР‚Р ВµР Р…Р С•РЎРѓ РЎвЂљР ВµР С”РЎРѓРЎвЂљР В° Р Р† РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏРЎвЂ¦ */
            .message-bubble p,
            .message-bubble span,
            .message-bubble div,
            .message-bubble .msg-text,
            .message-bubble .text-sm,
            .message-bubble .leading-relaxed {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: break-word !important;
            }
            
            #messages-container {
                overflow-x: hidden !important;
            }
            
            /* Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С hover РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљРЎвЂ№ (Р Р…Р Вµ Р Р…РЎС“Р В¶Р Р…РЎвЂ№ Р Р…Р В° РЎвЂљР В°РЎвЂЎ-РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р В°РЎвЂ¦) */
            .chat-item:hover,
            .emoji-item:hover,
            .reaction-badge:hover,
            .call-btn:hover,
            .plus-menu-item:hover {
                transform: none !important;
                background: inherit;
            }
            
            /* Р Р€Р С—РЎР‚Р С•РЎвЂ°Р В°Р ВµР С РЎвЂљР ВµР Р…Р С‘ */
            .notification-toast,
            .plus-menu,
            .emoji-panel,
            .call-minimized,
            .local-video {
                box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            }
            
            /* Р Р€РЎРѓР С”Р С•РЎР‚РЎРЏР ВµР С Р С—Р ВµРЎР‚Р ВµРЎвЂ¦Р С•Р Т‘РЎвЂ№ */
            #main-app > aside,
            #main-app > main {
                transition: transform 0.2s ease !important;
            }
            
            /* Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С Р С—РЎС“Р В»РЎРЉРЎРѓР В°РЎвЂ Р С‘РЎР‹ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В° Р Р† Р В·Р Р†Р С•Р Р…Р С”Р Вµ */
            .call-avatar {
                animation: none !important;
            }
            
            /* Р Р€Р С—РЎР‚Р С•РЎвЂ°Р В°Р ВµР С video controls */
            .video-controls {
                backdrop-filter: none !important;
                background: rgba(0,0,0,0.7) !important;
            }
            
            /* Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹ РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘Р в„– */
            .reaction-picker {
                animation: none !important;
            }
            
            /* Р Р€Р С—РЎР‚Р С•РЎвЂ°Р В°Р ВµР С toast */
            .notification-toast {
                animation: none !important;
                opacity: 1 !important;
                transform: none !important;
            }
            
            /* Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С blur Р Р…Р В° HTTP warning */
            .http-warning,
            .screen-share-notification {
                backdrop-filter: none !important;
            }
            
            /* Р С›Р С—РЎвЂљР С‘Р СР С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ РЎРѓР С”РЎР‚Р С•Р В»Р В»Р В° */
            #messages-container,
            .emoji-content,
            #chats-list {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: auto !important;
            }
            
            /* Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С РЎРѓР В»Р С•Р В¶Р Р…РЎвЂ№Р Вµ Р С—Р ВµРЎР‚Р ВµРЎвЂ¦Р С•Р Т‘РЎвЂ№ */
            * {
                scroll-behavior: auto !important;
            }
            
            /* Р Р€Р С—РЎР‚Р С•РЎвЂ°Р В°Р ВµР С Р С—РЎР‚Р С•Р С–РЎР‚Р ВµРЎРѓРЎРѓ-Р В±Р В°РЎР‚ */
            .progress-fill {
                box-shadow: none !important;
                transition: width 0.1s linear !important;
            }
            
            /* Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹ Р В·Р В°Р С—Р С‘РЎРѓР С‘ Р С–Р С•Р В»Р С•РЎРѓР В° */
            .voice-waveform span {
                animation: none !important;
                height: 15px !important;
            }
            
            /* Р Р€Р С—РЎР‚Р С•РЎвЂ°Р В°Р ВµР С minimize call button */
            .minimize-call-btn {
                backdrop-filter: none !important;
                background: rgba(255,255,255,0.3) !important;
            }
        }
        
        /* Р вЂќР С•Р С—Р С•Р В»Р Р…Р С‘РЎвЂљР ВµР В»РЎРЉР Р…РЎвЂ№Р Вµ Р С•Р С—РЎвЂљР С‘Р СР С‘Р В·Р В°РЎвЂ Р С‘Р С‘ Р Т‘Р В»РЎРЏ РЎРѓР В»Р В°Р В±РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р† */
        @media (max-width: 768px) and (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
        
        /* ========== Р С’Р вЂќР С’Р СџР СћР С’Р В¦Р ВР Р‡ Р вЂќР вЂєР Р‡ Р СљР С’Р вЂєР вЂўР СњР В¬Р С™Р ВР Тђ Р В­Р С™Р В Р С’Р СњР С›Р вЂ™ (Р Т‘Р С• 400px) ========== */
        @media (max-width: 400px) {
            /* Р Р€Р СР ВµР Р…РЎРЉРЎв‚¬Р В°Р ВµР С Р С•РЎвЂљРЎРѓРЎвЂљРЎС“Р С—РЎвЂ№ */
            .p-4 { padding: 0.75rem !important; }
            .p-6 { padding: 1rem !important; }
            .px-4 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
            .py-4 { padding-top: 0.75rem !important; padding-bottom: 0.75rem !important; }
            .gap-4 { gap: 0.5rem !important; }
            .gap-3 { gap: 0.375rem !important; }
            
            /* Р Р€Р СР ВµР Р…РЎРЉРЎв‚¬Р В°Р ВµР С РЎв‚¬РЎР‚Р С‘РЎвЂћРЎвЂљРЎвЂ№ */
            .text-xl { font-size: 1rem !important; }
            .text-lg { font-size: 0.9rem !important; }
            .text-base { font-size: 0.85rem !important; }
            .text-sm { font-size: 0.75rem !important; }
            .text-xs { font-size: 0.65rem !important; }
            
            /* Р С™Р С•Р СР С—Р В°Р С”РЎвЂљР Р…РЎвЂ№Р в„– header РЎвЂЎР В°РЎвЂљР В° */
            #chat-header {
                padding: 8px 12px !important;
                min-height: 50px !important;
            }
            #chat-header .w-10, #chat-header .w-12 {
                width: 36px !important;
                height: 36px !important;
            }
            #chat-header .text-lg {
                font-size: 0.9rem !important;
            }
            
            /* Р С™Р С•Р СР С—Р В°Р С”РЎвЂљР Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ */
            .message-bubble {
                max-width: 85% !important;
                padding: 8px 12px !important;
                font-size: 0.9rem !important;
                border-radius: 1rem !important;
            }
            
            /* Р С™Р С•Р СР С—Р В°Р С”РЎвЂљР Р…РЎвЂ№Р в„– input */
            .tg-input-row {
                padding: 6px 8px !important;
                gap: 4px !important;
            }
            .tg-emoji-btn-left, .tg-attach-btn, .tg-mic-btn {
                width: 34px !important;
                height: 34px !important;
                font-size: 18px !important;
            }
            .tg-message-input {
                font-size: 15px !important;
                padding: 8px 0 !important;
            }
            .tg-send-btn-right {
                width: 34px !important;
                height: 34px !important;
            }
            
            /* Р С™Р С•Р СР С—Р В°Р С”РЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ Р Р†Р В»Р С•Р В¶Р ВµР Р…Р С‘Р в„– */
            .attach-action-item {
                padding: 6px !important;
            }
            .attach-action-icon {
                width: 44px !important;
                height: 44px !important;
                font-size: 18px !important;
            }
            .attach-action-item span {
                font-size: 10px !important;
            }
            .attach-actions-bar {
                padding: 10px 4px !important;
            }
            
            /* Р С™Р С•Р СР С—Р В°Р С”РЎвЂљР Р…РЎвЂ№Р в„– РЎРѓР С—Р С‘РЎРѓР С•Р С” РЎвЂЎР В°РЎвЂљР С•Р Р† */
            .chat-item {
                padding: 10px 12px !important;
            }
            .chat-item .w-12 {
                width: 40px !important;
                height: 40px !important;
            }
            
            /* Р С™Р С•Р СР С—Р В°Р С”РЎвЂљР Р…РЎвЂ№Р Вµ Р СР С•Р Т‘Р В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р С•Р С”Р Р…Р В° */
            .modal-content, [class*="modal"] > div {
                padding: 16px !important;
                margin: 8px !important;
                border-radius: 16px !important;
            }
            
            /* Р С™Р С•Р СР С—Р В°Р С”РЎвЂљР Р…РЎвЂ№Р Вµ Р С”Р Р…Р С•Р С—Р С”Р С‘ */
            button.rounded-xl, .btn {
                padding: 10px 16px !important;
                font-size: 0.85rem !important;
            }
            
            /* Р Р€Р СР ВµР Р…РЎРЉРЎв‚¬Р В°Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚РЎвЂ№ */
            .w-16 { width: 3rem !important; height: 3rem !important; }
            .w-14 { width: 2.75rem !important; height: 2.75rem !important; }
            .w-12 { width: 2.5rem !important; height: 2.5rem !important; }
            .w-10 { width: 2rem !important; height: 2rem !important; }
        }
        
        /* ========== Р С›Р В§Р вЂўР СњР В¬ Р СљР С’Р вЂєР вЂўР СњР В¬Р С™Р ВР вЂў Р В­Р С™Р В Р С’Р СњР В« (Р Т‘Р С• 320px) ========== */
        @media (max-width: 320px) {
            .tg-input-row {
                padding: 4px 6px !important;
            }
            .tg-emoji-btn-left, .tg-attach-btn, .tg-mic-btn {
                width: 30px !important;
                height: 30px !important;
                font-size: 16px !important;
            }
            .message-bubble {
                max-width: 90% !important;
                padding: 6px 10px !important;
                font-size: 0.85rem !important;
            }
            .attach-action-icon {
                width: 38px !important;
                height: 38px !important;
                font-size: 16px !important;
            }
            .attach-action-item span {
                font-size: 9px !important;
            }
        }
        
        /* GPU РЎС“РЎРѓР С”Р С•РЎР‚Р ВµР Р…Р С‘Р Вµ Р Т‘Р В»РЎРЏ Р С”РЎР‚Р С‘РЎвЂљР С‘РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљР С•Р Р† */
        #main-app > aside,
        #main-app > main,
        #messages-container,
        .message-bubble {
            will-change: transform;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        /* Р СџРЎР‚Р ВµР Т‘РЎС“Р С—РЎР‚Р ВµР В¶Р Т‘Р ВµР Р…Р С‘Р Вµ Р С• HTTP */
        .http-warning {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        @keyframes toast-out {
            from { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
            to { 
                transform: translateX(120%) scale(0.8); 
                opacity: 0; 
            }
        }

        /* Р В­Р СР С•Р Т‘Р В·Р С‘-Р С—Р В°Р Р…Р ВµР В»РЎРЉ */
        .emoji-panel {
            display: none;
            position: absolute;
            bottom: 90px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            padding: 0;
            z-index: 100;
            animation: panel-pop 0.2s ease-out;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            overflow: hidden;
            flex-direction: column;
        }
        .emoji-panel.active { display: flex; }
        
        .emoji-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 8px;
            gap: 4px;
            overflow-x: auto;
            flex-shrink: 0;
        }
        .emoji-tab {
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .emoji-tab:hover { background: rgba(79, 70, 229, 0.1); }
        .emoji-tab.active { background: var(--accent); filter: grayscale(0); }
        
        .emoji-search {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .emoji-search input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-app);
            outline: none;
            font-size: 0.85rem;
        }
        .emoji-search input:focus { border-color: var(--accent); }
        
        .emoji-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
        }
        .emoji-category-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.5;
            margin: 10px 0 8px;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }
        
        @keyframes panel-pop {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Р СџР В»РЎР‹РЎРѓ-Р СР ВµР Р…РЎР‹ Р Т‘Р В»РЎРЏ Р Т‘Р С•Р С—Р С•Р В»Р Р…Р С‘РЎвЂљР ВµР В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ Р Т‘Р ВµР в„–РЎРѓРЎвЂљР Р†Р С‘Р в„– */
        .plus-menu-container {
            position: relative;
        }
        .plus-menu-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-app);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            font-size: 20px;
        }
        .plus-menu-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .plus-menu-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: rotate(45deg);
        }
        .plus-menu {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 8px;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.2s ease;
            z-index: 100;
        }
        .plus-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .plus-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
            font-weight: 500;
        }
        .plus-menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .plus-menu-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        .plus-menu-item.file-item i { color: #6366f1; }
        .plus-menu-item.location-item i { color: #22c55e; }
        .plus-menu-item.event-item i { color: #ec4899; }
        .plus-menu-item.poll-item i { color: #8b5cf6; }
        .plus-menu-item.game-item i { color: #f59e0b; }
        .plus-menu-item.ai-item i { color: #f97316; }
        .plus-menu-item.schedule-item { color: white; }
        .plus-menu-item.schedule-item i { color: white; }

        .emoji-item { cursor: pointer; transition: transform 0.2s; font-size: 1.4rem; display: flex; justify-content: center; align-items: center; padding: 6px; border-radius: 8px; }
        .emoji-item:hover { transform: scale(1.2); background: rgba(79, 70, 229, 0.1); }

        /* Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ */
        #settings-panel { 
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        #settings-panel.active {
            opacity: 1;
            pointer-events: all;
        }
        
        /* ========== Р СњР С›Р вЂ™Р С’Р Р‡ Р СџР С’Р СњР вЂўР вЂєР В¬ Р СњР С’Р РЋР СћР В Р С›Р вЂўР С™ (Discord-style) ========== */
        
        .settings-sidebar {
            width: 240px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .settings-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .settings-categories {
            flex: 1;
            padding: 20px 10px;
            overflow-y: auto;
        }
        
        .settings-category-group {
            margin-bottom: 20px;
        }
        
        .settings-category-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text);
            opacity: 0.5;
            padding: 0 10px;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }
        
        .settings-category-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            opacity: 0.7;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
            text-align: left;
        }
        
        .settings-category-btn:hover {
            opacity: 1;
            background: rgba(99, 102, 241, 0.1);
        }
        
        .settings-category-btn.active {
            opacity: 1;
            background: var(--accent);
            color: white;
        }
        
        body.theme-light .settings-category-btn.active {
            background: #3b82f6;
        }
        
        .settings-category-btn i {
            width: 20px;
            text-align: center;
        }
        
        .settings-sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border);
        }
        
        .settings-logout-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .settings-content {
            flex: 1;
            background: var(--bg-app);
            position: relative;
            overflow-y: auto;
        }
        
        .settings-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .settings-close-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: rotate(90deg);
        }
        
        .settings-content-inner {
            padding: 40px 60px;
            max-width: 800px;
        }
        
        .settings-section {
            margin-bottom: 40px;
        }
        
        .settings-section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .settings-section-desc {
            font-size: 14px;
            opacity: 0.6;
            margin-bottom: 20px;
        }
        
        .settings-divider {
            height: 1px;
            background: var(--border);
            margin: 30px 0;
        }
        
        /* Premium elements */
        .premium-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .premium-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .premium-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .premium-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        
        .premium-feature i {
            font-size: 24px;
            color: var(--accent);
        }
        
        .premium-pricing {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .premium-plan {
            padding: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            text-align: center;
            position: relative;
        }
        
        .premium-plan-best {
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
        }
        
        .premium-badge {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .premium-buy-btn {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .premium-buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        /* Ruby shop elements */
        .ruby-pack {
            padding: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }
        
        .ruby-pack:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
        }
        
        .ruby-pack-popular {
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
        }
        
        .ruby-pack-badge {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .ruby-pack-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .ruby-pack-amount {
            font-size: 24px;
            font-weight: bold;
            color: #ef4444;
            margin-bottom: 5px;
        }
        
        .ruby-pack-price {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .ruby-pack-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .ruby-pack-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .shop-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        
        /* Wallpaper buttons */
        .wallpaper-btn {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .wallpaper-btn.active {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        /* Font size buttons */
        .font-size-btn.active {
            border-color: var(--accent) !important;
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* Destruct buttons */
        .destruct-btn.active {
            border-color: var(--accent) !important;
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* Theme buttons */
        .theme-btn.active {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        /* Language buttons */
        .lang-btn.active {
            border-color: var(--accent) !important;
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…Р В°РЎРЏ Р В°Р Т‘Р В°Р С—РЎвЂљР В°РЎвЂ Р С‘РЎРЏ */
        @media (max-width: 768px) {
            .settings-sidebar {
                width: 200px;
            }
            
            .settings-content-inner {
                padding: 20px;
            }
            
            .settings-category-btn {
                font-size: 13px;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 640px) {
            #settings-panel .flex {
                flex-direction: column;
            }
            
            .settings-sidebar {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .settings-categories {
                display: flex;
                gap: 10px;
                overflow-x: auto;
                padding: 10px;
            }
            
            .settings-category-group {
                display: flex;
                gap: 5px;
                margin: 0;
            }
            
            .settings-category-title {
                display: none;
            }
            
            .settings-category-btn span {
                display: none;
            }
            
            .settings-category-btn {
                width: auto;
                padding: 10px;
            }
        }
        
        /* Р СџР В°Р Р…Р ВµР В»РЎРЉ Р В·Р В°Р Т‘Р В°РЎвЂЎ */
        #tasks-panel {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
        }
        #tasks-panel.active {
            transform: translateX(0);
        }
        .task-filter-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .task-filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Р СџР В°Р С—Р С”Р С‘ РЎвЂЎР В°РЎвЂљР С•Р Р† */
        .chat-folder-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text);
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        .chat-folder-btn:hover {
            opacity: 1;
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .chat-folder-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            opacity: 1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        body.theme-light .chat-folder-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        body.theme-light .chat-folder-btn:hover {
            border-color: #3b82f6;
        }
        .custom-folder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        .scheduled-msg-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        .scheduled-msg-item:last-child {
            border-bottom: none;
        }
        
        /* Р СџР С•Р Т‘Р СР ВµР Р…РЎР‹ Р С—Р В°Р С—Р С•Р С” Р Р† Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р С Р СР ВµР Р…РЎР‹ */
        .msg-context-submenu {
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin: 4px 8px;
        }
        .msg-context-submenu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
        }
        .msg-context-submenu-item:hover {
            background: var(--bg-card);
        }
        .msg-context-item.has-submenu {
            position: relative;
        }
        
        /* Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎРѓ Р С–Р ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘Р ВµР в„– */
        .location-message {
            width: 280px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .location-message:hover {
            transform: scale(1.02);
        }
        .location-map {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            position: relative;
        }
        .location-map img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .location-map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        .location-map-placeholder i {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .location-info {
            padding: 10px 12px;
            background: var(--bg-card);
        }
        .location-info-title {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .location-info-title i {
            color: #22c55e;
        }
        .location-info-coords {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 2px;
        }
        
        /* Р С™Р В°РЎР‚РЎвЂљР С•РЎвЂЎР С”Р В° Р СР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘РЎРЏ */
        .event-card {
            width: 280px;
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
        }
        .event-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .event-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .event-title {
            font-weight: 700;
            font-size: 15px;
            line-height: 1.3;
        }
        .event-body {
            padding: 0 16px 16px;
        }
        .event-info-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        .event-info-row i {
            width: 16px;
            text-align: center;
        }
        .event-description {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
            line-height: 1.4;
        }
        .event-footer {
            padding: 12px 16px;
            background: rgba(0,0,0,0.1);
            display: flex;
            gap: 8px;
        }
        .event-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .event-btn-accept {
            background: white;
            color: #8b5cf6;
        }
        .event-btn-decline {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .event-btn:hover {
            transform: scale(1.02);
        }
        .event-responses {
            padding: 8px 16px;
            background: rgba(0,0,0,0.05);
            font-size: 11px;
            display: flex;
            gap: 12px;
        }
        .event-responses span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }
        .task-item:hover {
            border-color: var(--accent);
        }
        .task-item.completed {
            opacity: 0.6;
        }
        .task-item.completed .task-text {
            text-decoration: line-through;
        }
        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .task-checkbox:hover {
            border-color: var(--accent);
        }
        .task-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        /* Р РЋР С—Р С‘Р Р…Р Р…Р ВµРЎР‚РЎвЂ№ Р С‘ Р С—РЎР‚Р С•Р С–РЎР‚Р ВµРЎРѓРЎРѓ */
        .progress-bar {
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        /* Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ РЎРѓР С—Р С‘РЎРѓР С”Р В° РЎвЂЎР В°РЎвЂљР С•Р Р† */
        .chat-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .chat-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--accent);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .chat-item:hover {
            transform: translateX(5px);
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .chat-item:hover::before {
            transform: scaleY(1);
        }
        
        body.theme-light .chat-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        body.theme-light .chat-item::before {
            background: #3b82f6;
        }
        
        /* Р С’Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ */
        .chat-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent);
            border-left: 3px solid var(--accent);
        }
        
        body.theme-light .chat-item.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
            border-left-color: #3b82f6;
        }
        
        /* Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ */
        .chat-item.pinned {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), transparent);
            border-left: 2px solid rgba(251, 191, 36, 0.3);
        }
        
        body.theme-light .chat-item.pinned {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.08), transparent);
        }
        
        /* Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ Р Р† РЎРѓР С—Р С‘РЎРѓР С”Р Вµ РЎвЂЎР В°РЎвЂљР С•Р Р† */
        .saved-messages-item {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)) !important;
            border: 1px solid rgba(99, 102, 241, 0.2) !important;
            position: relative;
        }
        
        .saved-messages-item::after {
            content: 'РІВ­С’';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            opacity: 0.5;
        }
        
        .saved-messages-item:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15)) !important;
            transform: translateX(5px) scale(1.02);
        }
        
        body.theme-light .saved-messages-item {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)) !important;
            border-color: rgba(59, 130, 246, 0.2) !important;
        }
        
        body.theme-light .saved-messages-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)) !important;
        }

        /* Р С™Р В°РЎРѓРЎвЂљР С•Р СР Р…РЎвЂ№Р в„– РЎРѓР С”РЎР‚Р С•Р В»Р В»Р В±Р В°РЎР‚ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        body.theme-dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Р В­Р С”РЎР‚Р В°Р Р… Р В·Р Р†Р С•Р Р…Р С”Р В° */
        .call-screen {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: call-fade-in 0.3s ease;
        }
        
        /* Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В° Р Т‘Р В»РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р В·Р Р†Р С•Р Р…Р С”Р В° */
        body.theme-light .call-screen {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
        }
        
        /* Р СћР ВµР С”РЎРѓРЎвЂљ Р Р…Р В° РЎРЊР С”РЎР‚Р В°Р Р…Р Вµ Р В·Р Р†Р С•Р Р…Р С”Р В° Р Т‘Р В»РЎРЏ РЎРѓР Р†Р ВµРЎвЂљР В»Р С•Р в„– РЎвЂљР ВµР СРЎвЂ№ */
        body.theme-light .call-screen .text-white {
            color: #1e293b !important;
        }
        body.theme-light .call-screen .text-white\/60 {
            color: rgba(30, 41, 59, 0.6) !important;
        }
        body.theme-light .call-screen .text-white\/40 {
            color: rgba(30, 41, 59, 0.4) !important;
        }
        
        /* ========== Р Р€Р вЂєР Р€Р В§Р РЃР вЂўР СњР СњР В«Р в„ў UI ========== */
        
        /* Р СџР В»Р В°Р Р†Р Р…РЎвЂ№Р Вµ Р С—Р ВµРЎР‚Р ВµРЎвЂ¦Р С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ Р Р†РЎРѓР ВµРЎвЂ¦ Р С‘Р Р…РЎвЂљР ВµРЎР‚Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№РЎвЂ¦ РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљР С•Р Р† */
        button, input, textarea, select, .card, .message-bubble {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ Р С”Р Р…Р С•Р С—Р С”Р С‘ */
        button:not(.message-bubble) {
            position: relative;
            overflow: hidden;
        }
        
        button:not(.message-bubble)::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:not(.message-bubble):active::before {
            width: 300px;
            height: 300px;
        }
        
        /* Р В­РЎвЂћРЎвЂћР ВµР С”РЎвЂљ hover Р Т‘Р В»РЎРЏ Р С”Р Р…Р С•Р С—Р С•Р С” */
        button:hover:not(:disabled):not(.message-bubble) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active:not(:disabled):not(.message-bubble) {
            transform: translateY(0);
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ Р С”Р В°РЎР‚РЎвЂљР С•РЎвЂЎР С”Р С‘ */
        .card, .glass-panel {
            transition: all 0.3s ease;
        }
        
        .card:hover, .glass-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ Р С‘Р Р…Р С—РЎС“РЎвЂљРЎвЂ№ */
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: scale(1.01);
        }
        
        body.theme-light input:focus,
        body.theme-light textarea:focus,
        body.theme-light select:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ */
        @keyframes pulse-glow {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 40px rgba(99, 102, 241, 0.6);
            }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite, pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ */
        .message-bubble:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .message-bubble.sent:hover {
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }
        
        body.theme-light .message-bubble.sent:hover {
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }
        
        /* Р СџР В»Р В°Р Р†Р Р…Р С•Р Вµ Р С—Р С•РЎРЏР Р†Р В»Р ВµР Р…Р С‘Р Вµ РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљР С•Р Р† */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fade-in-up 0.5s ease-out;
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р в„– РЎРѓР С”РЎР‚Р С•Р В»Р В»Р В±Р В°РЎР‚ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }
        
        body.theme-light ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
        }
        
        body.theme-light ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        /* Р В­РЎвЂћРЎвЂћР ВµР С”РЎвЂљ РЎРѓР Р†Р ВµРЎвЂЎР ВµР Р…Р С‘РЎРЏ Р Т‘Р В»РЎРЏ Р В°Р С”РЎвЂ Р ВµР Р…РЎвЂљР Р…РЎвЂ№РЎвЂ¦ РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљР С•Р Р† */
        .glow-effect {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(99, 102, 241, 0.8);
            }
        }
        
        body.theme-light .glow-effect {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        @keyframes glow-pulse-light {
            0%, 100% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
            }
        }
        
        body.theme-light .glow-effect {
            animation: glow-pulse-light 2s ease-in-out infinite;
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ РЎвЂљР ВµР Р…Р С‘ Р Т‘Р В»РЎРЏ Р С”Р В°РЎР‚РЎвЂљР С•РЎвЂЎР ВµР С” */
        .elevated-card {
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.12),
                0 1px 2px rgba(0, 0, 0, 0.24);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .elevated-card:hover {
            box-shadow: 
                0 14px 28px rgba(0, 0, 0, 0.25),
                0 10px 10px rgba(0, 0, 0, 0.22);
        }
        
        /* Р вЂњРЎР‚Р В°Р Т‘Р С‘Р ВµР Р…РЎвЂљР Р…РЎвЂ№Р в„– РЎвЂљР ВµР С”РЎРѓРЎвЂљ */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        body.theme-light .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р Т‘Р В»РЎРЏ Р С‘Р С”Р С•Р Р…Р С•Р С” */
        .icon-bounce {
            animation: icon-bounce 0.6s ease;
        }
        
        @keyframes icon-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ badge */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        
        body.theme-light .badge {
            background: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚РЎвЂ№ */
        .avatar {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .avatar::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255, 255, 255, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .avatar:hover::after {
            opacity: 1;
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р в„– toggle switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active {
            background: var(--accent);
        }
        
        body.theme-light .toggle-switch.active {
            background: #3b82f6;
        }
        
        .toggle-switch.active::after {
            left: 22px;
        }
        
        /* Ripple РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљ */
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            width: 20px;
            height: 20px;
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }
        
        @keyframes call-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: bold;
            animation: call-pulse 2s infinite;
            border: 4px solid rgba(255,255,255,0.3);
        }
        @keyframes call-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255,255,255,0); }
        }
        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .call-btn:hover { transform: scale(1.1); }
        .call-btn:active { transform: scale(0.95); }
        .call-btn-accept { background: #22c55e; color: white; }
        .call-btn-decline { background: #ef4444; color: white; }
        .call-btn-mute { background: rgba(255,255,255,0.2); color: white; }
        .call-btn-mute.active { background: #ef4444; }
        .call-btn-mute.screen-sharing { background: #3b82f6; }
        .call-btn-mute.speakerphone-active { background: #22c55e; }
        
        /* Р вЂ™Р С‘Р Т‘Р ВµР С• Р С”Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ */
        .video-container {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: #000;
        }
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .local-video {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 150px;
            height: 200px;
            border-radius: 1rem;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .video-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            padding: 15px 30px;
            background: rgba(0,0,0,0.5);
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }
        
        /* Р вЂњРЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р Р†Р С‘Р Т‘Р ВµР С• Р В·Р Р†Р С•Р Р…Р С•Р С” */
        #group-call-participants {
            background: linear-gradient(135deg, #1e293b 0%, #312e81 100%);
        }
        #group-videos-grid video {
            background: #1e293b;
        }
        
        /* Р РЋР Р†РЎвЂРЎР‚Р Р…РЎС“РЎвЂљРЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С” (Р СР С‘Р Р…Р С‘-Р С—Р В»Р ВµР ВµРЎР‚) */
        .call-minimized {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 280px;
            background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%);
            border-radius: 20px;
            padding: 12px 16px;
            z-index: 250;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            cursor: pointer;
            animation: mini-call-in 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        @keyframes mini-call-in {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .call-minimized:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
        }
        .call-minimized-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .call-minimized-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            overflow: hidden;
            flex-shrink: 0;
        }
        .call-minimized-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .call-minimized-info {
            flex: 1;
            min-width: 0;
        }
        .call-minimized-name {
            color: white;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .call-minimized-status {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .call-minimized-status .pulse-dot {
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .call-minimized-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .call-mini-btn {
            flex: 1;
            padding: 8px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .call-mini-btn-expand {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        .call-mini-btn-expand:hover {
            background: rgba(255,255,255,0.25);
        }
        .call-mini-btn-end {
            background: #ef4444;
            color: white;
        }
        .call-mini-btn-end:hover {
            background: #dc2626;
        }
        .minimize-call-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        .minimize-call-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.1);
        }
        #group-videos-grid > div {
            min-height: 150px;
        }
        @media (max-width: 640px) {
            #group-videos-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ */
        .voice-btn {
            transition: all 0.2s;
        }
        .voice-btn.recording {
            background: #ef4444 !important;
            color: white !important;
            animation: recording-pulse 1s infinite;
        }
        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }
        .voice-recording-ui {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 2rem;
            animation: slide-up 0.2s ease;
        }
        .voice-recording-ui.video-mode {
            border-color: #a855f7;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1));
        }
        .voice-recording-ui.video-mode .recording-indicator {
            background: #a855f7;
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .recording-indicator {
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Р вЂ™Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С”Р С‘ (Р С”Р В°Р С” Р Р† Telegram) */
        .video-circle-btn {
            transition: all 0.2s;
        }
        .video-circle-btn.recording {
            background: #ef4444 !important;
            color: white !important;
            animation: recording-pulse 1s infinite;
        }
        .video-circle-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fade-in 0.2s ease;
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .video-circle-preview {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #ef4444;
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.5);
            position: relative;
        }
        .video-circle-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        .video-circle-timer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .video-circle-timer::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        .video-circle-controls {
            margin-top: 30px;
            display: flex;
            gap: 20px;
        }
        .video-circle-controls button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .video-circle-controls button:hover {
            transform: scale(1.1);
        }
        .video-circle-cancel {
            background: #64748b;
            color: white;
        }
        .video-circle-send {
            background: #22c55e;
            color: white;
        }
        .video-circle-message {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .video-circle-message video {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid var(--accent);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .video-circle-message .video-circle-duration {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        /* Р СџРЎР‚Р ВµР Т‘Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ РЎРѓРЎРѓРЎвЂ№Р В»Р С•Р С” */
        .link-preview {
            margin-top: 8px;
            border-left: 3px solid var(--accent);
            padding: 8px 12px;
            background: rgba(0,0,0,0.05);
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dark .link-preview {
            background: rgba(255,255,255,0.05);
        }
        .link-preview:hover {
            background: rgba(0,0,0,0.1);
        }
        .dark .link-preview:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* YouTube embed */
        .youtube-preview {
            border-left-color: #ff0000;
            cursor: default;
        }
        .youtube-embed-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 */
            margin-bottom: 8px;
            border-radius: 8px;
            overflow: hidden;
        }
        .youtube-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        
        .link-preview-image {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .link-preview-site {
            font-size: 10px;
            color: var(--accent);
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .link-preview-title {
            font-size: 13px;
            font-weight: bold;
            line-height: 1.3;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .link-preview-description {
            font-size: 11px;
            opacity: 0.7;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Р СљР ВµР Т‘Р С‘Р В°-Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎвЂ°Р С‘Р С” */
        #media-viewer-thumbnails::-webkit-scrollbar {
            height: 6px;
        }
        #media-viewer-thumbnails::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        .media-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        .media-thumbnail:hover {
            opacity: 0.8;
        }
        .media-thumbnail.active {
            opacity: 1;
            border-color: var(--accent);
        }
        .media-thumbnail-video {
            position: relative;
        }
        .media-thumbnail-video::after {
            content: 'РІвЂ“В¶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            text-shadow: 0 0 4px rgba(0,0,0,0.5);
        }
        #media-viewer-video::-webkit-media-controls-panel {
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
        }
        
        .voice-waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 30px;
        }
        .voice-waveform span {
            width: 3px;
            background: var(--accent);
            border-radius: 3px;
            animation: wave 0.5s ease infinite;
        }
        .voice-waveform span:nth-child(1) { animation-delay: 0s; }
        .voice-waveform span:nth-child(2) { animation-delay: 0.1s; }
        .voice-waveform span:nth-child(3) { animation-delay: 0.2s; }
        .voice-waveform span:nth-child(4) { animation-delay: 0.3s; }
        .voice-waveform span:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave {
            0%, 100% { height: 8px; }
            50% { height: 25px; }
        }
        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }
        .voice-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
            border: none;
        }
        .voice-play-btn:hover { transform: scale(1.1); }
        .voice-progress {
            flex: 1;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        .voice-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }
        .voice-transcribe-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .voice-transcribe-btn:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
        }
        .voice-transcribe-btn.loading {
            animation: pulse 1s infinite;
        }
        .voice-transcript {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
            font-size: 13px;
            color: var(--text-primary);
            border-left: 3px solid var(--accent);
        }
        .sent .voice-transcript {
            background: rgba(255,255,255,0.15);
            border-left-color: rgba(255,255,255,0.5);
        }

        /* Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…Р С•РЎРѓРЎвЂљРЎРЉ Р С‘ Р В±Р ВµР В·Р С•Р С—Р В°РЎРѓР Р…Р С•РЎРѓРЎвЂљРЎРЉ */
        .encrypted-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        /* Р СћР В°Р в„–Р СР ВµРЎР‚ Р В°Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ */
        .destruct-timer {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: #ef4444;
            margin-left: 6px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }
        .destruct-timer i {
            font-size: 9px;
            animation: pulse-fire 1s infinite;
        }
        @keyframes pulse-fire {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ Р С”Р В°Р С” Р Р† Telegram */
        @keyframes telegram-destruct {
            0% { 
                opacity: 1; 
                transform: scale(1) translateY(0);
                filter: blur(0);
            }
            30% {
                transform: scale(1.02) translateY(-5px);
            }
            100% { 
                opacity: 0; 
                transform: scale(0.3) translateY(-50px);
                filter: blur(10px);
            }
        }
        .message-destructing {
            animation: telegram-destruct 0.6s ease-out forwards;
            pointer-events: none;
        }
        
        /* Р В§Р В°РЎРѓРЎвЂљР С‘РЎвЂ РЎвЂ№ Р С—РЎР‚Р С‘ РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р С‘ */
        .destruct-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: visible;
        }
        .destruct-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: particle-fly 0.6s ease-out forwards;
        }
        @keyframes particle-fly {
            0% { 
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% { 
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }
        
        .anonymous-avatar {
            background: linear-gradient(135deg, #374151, #1f2937) !important;
        }
        .privacy-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-app);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        .privacy-toggle label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: var(--accent);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        /* Р РЋРЎвЂљР С‘Р В»Р С‘ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р СР С•Р С” Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В° */
        .frame-btn.active, .chat-style-btn.active {
            border-color: #6366f1 !important;
            background: rgba(99, 102, 241, 0.1) !important;
        }
        .avatar-frame-rainbow {
            box-shadow: 0 0 0 3px transparent, 0 0 0 5px #f59e0b, 0 0 0 7px #ef4444, 0 0 0 9px #ec4899 !important;
            animation: rainbow-rotate 3s linear infinite !important;
            overflow: visible !important;
        }
        .avatar-frame-gold {
            box-shadow: 0 0 0 3px #fbbf24, 0 0 15px #fbbf24 !important;
            overflow: visible !important;
        }
        .avatar-frame-neon {
            box-shadow: 0 0 0 3px #22d3ee, 0 0 15px #22d3ee, 0 0 30px #22d3ee !important;
            animation: neon-pulse 2s ease-in-out infinite !important;
            overflow: visible !important;
        }
        .avatar-frame-fire {
            box-shadow: 0 0 0 3px #f97316, 0 0 15px #ef4444, 0 0 25px #f97316 !important;
            animation: fire-flicker 0.5s ease-in-out infinite alternate !important;
            overflow: visible !important;
        }
        .avatar-frame-purple {
            box-shadow: 0 0 0 3px #a855f7, 0 0 15px #a855f7 !important;
            overflow: visible !important;
        }
        .avatar-frame-emerald {
            box-shadow: 0 0 0 3px #10b981, 0 0 15px #10b981 !important;
            overflow: visible !important;
        }
        .avatar-frame-diamond {
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #60a5fa, 0 0 20px #60a5fa !important;
            animation: diamond-shine 2s ease-in-out infinite !important;
            overflow: visible !important;
        }
        @keyframes rainbow-rotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        @keyframes neon-pulse {
            0%, 100% { box-shadow: 0 0 0 3px #22d3ee, 0 0 15px #22d3ee, 0 0 30px #22d3ee !important; }
            50% { box-shadow: 0 0 0 3px #22d3ee, 0 0 25px #22d3ee, 0 0 50px #22d3ee !important; }
        }
        @keyframes fire-flicker {
            0% { box-shadow: 0 0 0 3px #f97316, 0 0 15px #ef4444, 0 0 25px #f97316 !important; }
            100% { box-shadow: 0 0 0 3px #ef4444, 0 0 20px #f97316, 0 0 35px #ef4444 !important; }
        }
        @keyframes diamond-shine {
            0%, 100% { box-shadow: 0 0 0 2px #fff, 0 0 0 4px #60a5fa, 0 0 20px #60a5fa !important; }
            50% { box-shadow: 0 0 0 2px #fff, 0 0 0 4px #93c5fd, 0 0 30px #60a5fa, 0 0 50px #93c5fd !important; }
        }
        
        /* Premium РЎР‚Р В°Р СР С”Р С‘ */
        .avatar-frame-aurora {
            box-shadow: 0 0 0 3px #a855f7, 0 0 0 5px #ec4899, 0 0 0 7px #f97316, 0 0 20px #a855f7 !important;
            animation: aurora-frame 3s ease-in-out infinite !important;
            overflow: visible !important;
        }
        @keyframes aurora-frame {
            0%, 100% { box-shadow: 0 0 0 3px #a855f7, 0 0 0 5px #ec4899, 0 0 0 7px #f97316, 0 0 20px #a855f7 !important; }
            33% { box-shadow: 0 0 0 3px #ec4899, 0 0 0 5px #f97316, 0 0 0 7px #a855f7, 0 0 20px #ec4899 !important; }
            66% { box-shadow: 0 0 0 3px #f97316, 0 0 0 5px #a855f7, 0 0 0 7px #ec4899, 0 0 20px #f97316 !important; }
        }
        .avatar-frame-plasma {
            box-shadow: 0 0 0 3px #06b6d4, 0 0 15px #8b5cf6, 0 0 30px #06b6d4, 0 0 45px #8b5cf6 !important;
            animation: plasma-pulse 2s ease-in-out infinite !important;
            overflow: visible !important;
        }
        @keyframes plasma-pulse {
            0%, 100% { box-shadow: 0 0 0 3px #06b6d4, 0 0 15px #8b5cf6, 0 0 30px #06b6d4 !important; }
            50% { box-shadow: 0 0 0 3px #8b5cf6, 0 0 20px #06b6d4, 0 0 40px #8b5cf6, 0 0 60px #06b6d4 !important; }
        }
        
        /* Р СџРЎР‚Р ВµР Р†РЎРЉРЎР‹ Premium РЎР‚Р В°Р СР С•Р С” Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ */
        .avatar-frame-aurora-preview {
            box-shadow: 0 0 0 2px #a855f7, 0 0 0 4px #ec4899, 0 0 0 6px #f97316 !important;
            animation: aurora-frame 3s ease-in-out infinite !important;
        }
        .avatar-frame-plasma-preview {
            box-shadow: 0 0 0 2px #06b6d4, 0 0 10px #8b5cf6, 0 0 20px #06b6d4 !important;
            animation: plasma-pulse 2s ease-in-out infinite !important;
        }
        
        /* Premium Р С•Р В±Р С•Р С‘ "Р вЂ”Р Р†РЎвЂР В·Р Т‘РЎвЂ№" */
        #messages-container.wallpaper-stars {
            position: relative;
        }
        #messages-container.wallpaper-stars::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(circle at 10% 20%, white 1px, transparent 1px),
                radial-gradient(circle at 30% 70%, white 1px, transparent 1px),
                radial-gradient(circle at 50% 30%, white 1px, transparent 1px),
                radial-gradient(circle at 70% 80%, white 1px, transparent 1px),
                radial-gradient(circle at 90% 40%, white 1px, transparent 1px),
                radial-gradient(circle at 20% 90%, white 1px, transparent 1px),
                radial-gradient(circle at 80% 10%, white 1px, transparent 1px),
                radial-gradient(circle at 40% 50%, white 1px, transparent 1px),
                radial-gradient(circle at 60% 60%, white 1px, transparent 1px),
                radial-gradient(circle at 15% 45%, white 1px, transparent 1px),
                radial-gradient(circle at 85% 65%, white 1px, transparent 1px),
                radial-gradient(circle at 25% 15%, white 1px, transparent 1px);
            opacity: 0.7;
            pointer-events: none;
            animation: twinkle-stars 3s ease-in-out infinite;
            z-index: 0;
        }
        @keyframes twinkle-stars {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.4; }
        }
        
        /* Р РЋРЎвЂљР С‘Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– */
        .msg-style-gradient .message-bubble.sent,
        body.theme-cosmic .msg-style-gradient .message-bubble.sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        .msg-style-neon .message-bubble.sent,
        body.theme-cosmic .msg-style-neon .message-bubble.sent {
            background: #0f172a !important;
            color: #22d3ee !important;
            box-shadow: 0 0 10px #22d3ee, inset 0 0 10px rgba(34, 211, 238, 0.1) !important;
            border: 1px solid #22d3ee !important;
        }
        .msg-style-glass .message-bubble.sent,
        body.theme-cosmic .msg-style-glass .message-bubble.sent {
            background: rgba(99, 102, 241, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
        }
        
        /* Premium РЎРѓРЎвЂљР С‘Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– */
        .msg-style-aurora .message-bubble.sent,
        body.theme-cosmic .msg-style-aurora .message-bubble.sent {
            background: linear-gradient(135deg, #a855f7, #ec4899, #f97316, #a855f7) !important;
            background-size: 300% 300% !important;
            animation: aurora-shift 4s ease infinite !important;
            color: white !important;
        }
        @keyframes aurora-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .msg-style-fire .message-bubble.sent,
        body.theme-cosmic .msg-style-fire .message-bubble.sent {
            background: linear-gradient(135deg, #f97316, #ef4444) !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 0 0 40px rgba(249, 115, 22, 0.3) !important;
            color: white !important;
            animation: fire-glow 1.5s ease-in-out infinite !important;
        }
        @keyframes fire-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 0 0 40px rgba(249, 115, 22, 0.3); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.7), 0 0 60px rgba(249, 115, 22, 0.5); }
        }
        .msg-style-galaxy .message-bubble.sent,
        body.theme-cosmic .msg-style-galaxy .message-bubble.sent {
            background: linear-gradient(135deg, #1e1b4b, #4c1d95, #7c3aed) !important;
            box-shadow: inset 0 0 20px rgba(124, 58, 237, 0.3), 0 0 15px rgba(124, 58, 237, 0.4) !important;
            color: white !important;
        }
        .msg-style-gold .message-bubble.sent,
        body.theme-cosmic .msg-style-gold .message-bubble.sent {
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5) !important;
            color: #78350f !important;
        }
        
        /* Р РЋРЎвЂљР С‘Р В»РЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С• Р В·Р Р†Р С•Р Р…Р С”Р Вµ */
        .call-message {
            min-width: 200px;
            max-width: 280px;
        }
        .call-message.sent {
            background: var(--bg-card) !important;
            border: 1px solid var(--border) !important;
        }
        .call-message.received {
            background: var(--bg-card) !important;
            border: 1px solid var(--border) !important;
        }
        
        /* Р РЋРЎвЂљР С‘Р В»РЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ-Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В° */
        .gift-message {
            background: linear-gradient(135deg, #ef4444, #ec4899, #f59e0b) !important;
            padding: 0 !important;
            overflow: visible;
            animation: gift-shine 2s ease-in-out infinite;
            min-width: 200px;
            max-width: 280px;
            border-radius: 20px !important;
        }
        .gift-message-content {
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .gift-icon {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            animation: gift-bounce 1s ease-in-out infinite;
        }
        .gift-icon svg {
            width: 100%;
            height: 100%;
            display: block;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));
        }
        .gift-amount {
            font-size: 24px;
            font-weight: 900;
            margin: 8px 0;
        }
        .gift-text {
            font-size: 12px;
            opacity: 0.9;
        }
        @keyframes gift-shine {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.1); }
        }
        @keyframes gift-bounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }
        
        /* Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р С—Р С•Р В»РЎС“РЎвЂЎР ВµР Р…Р С‘РЎРЏ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В° */
        .gift-received-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: gift-overlay-in 0.3s ease-out;
        }
        @keyframes gift-overlay-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .gift-received-icon {
            font-size: 120px;
            animation: gift-received-bounce 0.8s ease-out;
        }
        .gift-received-icon svg {
            width: 150px;
            height: 150px;
            filter: drop-shadow(0 0 30px rgba(255,255,255,0.5));
        }
        @keyframes gift-received-bounce {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.3) rotate(10deg); }
            70% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .gift-received-text {
            color: white;
            font-size: 24px;
            font-weight: 900;
            margin-top: 20px;
            animation: gift-text-in 0.5s ease-out 0.3s both;
        }
        @keyframes gift-text-in {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .gift-received-from {
            color: rgba(255,255,255,0.7);
            font-size: 16px;
            margin-top: 8px;
            animation: gift-text-in 0.5s ease-out 0.5s both;
        }
        .gift-received-message {
            color: white;
            font-size: 18px;
            font-style: italic;
            margin-top: 16px;
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            animation: gift-text-in 0.5s ease-out 0.7s both;
        }
        .gift-choice-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            animation: gift-text-in 0.5s ease-out 0.9s both;
        }
        .gift-choice-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 16px 24px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            min-width: 120px;
        }
        .gift-choice-btn i {
            font-size: 24px;
        }
        .gift-choice-btn span {
            font-size: 14px;
        }
        .gift-choice-desc {
            font-size: 11px !important;
            opacity: 0.8;
        }
        .gift-use-btn {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
        }
        .gift-use-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }
        .gift-keep-btn {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
        }
        .gift-keep-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        .gift-sparkles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        .gift-sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: sparkle-fly 1.5s ease-out forwards;
        }
        @keyframes sparkle-fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        .gift-confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            animation: confetti-fall 2s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Р вЂ™РЎвЂ№Р В±Р С•РЎР‚ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В° */
        .gift-option.selected {
            box-shadow: 0 0 0 2px #ec4899;
            background: rgba(236, 72, 153, 0.2) !important;
            transform: scale(1.05);
        }
        .gift-option {
            transition: all 0.2s ease;
        }
        
        /* Р вЂ™Р С‘РЎвЂљРЎР‚Р С‘Р Р…Р В° Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р С•Р Р† Р Р† Р С—РЎР‚Р С•РЎвЂћР С‘Р В»Р Вµ */
        .gifts-showcase {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(236,72,153,0.1), rgba(239,68,68,0.1));
            border-radius: 16px;
            min-height: 60px;
        }
        .showcase-gift {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 60px;
        }
        .dark .showcase-gift {
            background: #334155;
        }
        .showcase-gift-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .showcase-gift-icon svg {
            width: 100%;
            height: 100%;
        }
        .showcase-gift-count {
            font-size: 11px;
            font-weight: bold;
            color: #ec4899;
            margin-top: 4px;
        }
        
        .secret-chat-indicator {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        @keyframes msg-fade-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
        @keyframes highlight-msg {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 0 3px var(--accent), 0 0 20px rgba(99, 102, 241, 0.4); }
        }
        /* Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°Р Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ */
        .forwarded-label {
            font-size: 10px;
            color: var(--accent);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sent .forwarded-label {
            color: rgba(255,255,255,0.7);
        }
        
        /* Р С™РЎР‚Р ВµРЎРѓРЎвЂљР С‘Р С”Р С‘-Р Р…Р С•Р В»Р С‘Р С”Р С‘ */
        .ttt-game {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            min-width: 220px;
        }
        .ttt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .ttt-title {
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ttt-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }
        .ttt-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        .ttt-cell {
            aspect-ratio: 1;
            background: var(--bg-app);
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
        }
        .ttt-cell:hover:not(.taken) {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent);
        }
        .ttt-cell.taken {
            cursor: default;
        }
        .ttt-cell.x { color: #ef4444; }
        .ttt-cell.o { color: #3b82f6; }
        .ttt-cell.win {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        .ttt-actions {
            display: flex;
            gap: 8px;
        }
        .ttt-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }
        .ttt-btn-accept {
            background: #22c55e;
            color: white;
        }
        .ttt-btn-decline {
            background: #ef4444;
            color: white;
        }
        .ttt-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .ttt-invite {
            text-align: center;
            padding: 20px;
        }
        .ttt-invite-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .ttt-invite-text {
            font-size: 13px;
            margin-bottom: 12px;
        }
        
        /* Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓРЎвЂ№/Р ВРЎРѓРЎвЂљР С•РЎР‚Р С‘Р С‘ */
        .stories-container {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }
        .stories-container::-webkit-scrollbar { height: 0; }
        .story-item {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .story-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(135deg, #f59e0b, #ef4444, #ec4899, #8b5cf6);
        }
        .story-avatar.no-story {
            background: var(--border);
        }
        .story-avatar.viewed {
            background: #9ca3af;
        }
        .story-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            overflow: hidden;
            border: 3px solid var(--bg-card);
        }
        .story-avatar-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .story-add {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 22px;
            height: 22px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            border: 2px solid var(--bg-card);
        }
        .story-name {
            font-size: 10px;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }
        .story-viewer {
            position: fixed;
            inset: 0;
            z-index: 300;
            background: #000;
            display: flex;
            flex-direction: column;
        }
        .story-viewer-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            z-index: 10;
        }
        .story-progress {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }
        .story-progress-bar {
            flex: 1;
            height: 3px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .story-progress-fill {
            height: 100%;
            background: white;
            width: 0%;
        }
        .story-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .story-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р Вµ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ */
        .voice-waveform-visual {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 32px;
            padding: 0 8px;
        }
        .voice-waveform-visual .bar {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            transition: height 0.1s;
        }
        .sent .voice-waveform-visual .bar {
            background: rgba(255,255,255,0.7);
        }
        .voice-message-enhanced {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            padding: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
        }
        .sent .voice-message-enhanced {
            background: rgba(255,255,255,0.1);
        }
        
        /* Р РЋРЎвЂљР С‘Р С”Р ВµРЎР‚РЎвЂ№ Р С‘ GIF */
        .sticker-panel {
            display: none;
            position: absolute;
            bottom: 60px;
            left: 0;
            right: auto;
            width: 350px;
            max-width: calc(100vw - 24px);
            max-height: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            z-index: 100;
            animation: panel-pop 0.2s ease-out;
            overflow: hidden;
            flex-direction: column;
        }
        .sticker-panel.active { display: flex; }
        .sticker-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        .sticker-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .sticker-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .sticker-search {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }
        .sticker-search input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-app);
            outline: none;
            font-size: 13px;
        }
        .sticker-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .sticker-item, .gif-item {
            aspect-ratio: 1;
            border-radius: 10px;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.15s;
            background: var(--bg-app);
        }
        .sticker-item:hover, .gif-item:hover {
            transform: scale(1.1);
        }
        .sticker-item img, .gif-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gif-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .gif-item {
            aspect-ratio: auto;
            height: 100px;
        }
        
        .lang-btn.active {
            border-color: var(--accent) !important;
            background: rgba(79, 70, 229, 0.1);
        }
        .auth-lang-btn.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }
        
        /* Р С™Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– */
        .msg-context-menu {
            position: fixed;
            z-index: 300;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 6px;
            min-width: 160px;
            animation: context-pop 0.15s ease-out;
        }
        @keyframes context-pop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .msg-context-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
        }
        .msg-context-item:hover {
            background: rgba(79, 70, 229, 0.1);
        }
        .msg-context-item.danger {
            color: #ef4444;
        }
        .msg-context-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        .msg-context-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }
        
        /* Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• РЎР‚Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘РЎРЏ */
        .edit-modal {
            position: fixed;
            inset: 0;
            z-index: 250;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: modal-fade 0.2s ease;
        }
        @keyframes modal-fade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .edit-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modal-pop 0.2s ease;
        }
        @keyframes modal-pop {
            from { transform: scale(0.9) translateY(20px); }
            to { transform: scale(1) translateY(0); }
        }
        
        /* Р ВР Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚ РЎР‚Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘РЎРЏ */
        .edited-badge {
            font-size: 9px;
            opacity: 0.5;
            font-style: italic;
            margin-left: 6px;
        }
        
        /* AI Р С—Р В°Р Р…Р ВµР В»РЎРЉ */
        .ai-panel {
            position: absolute;
            bottom: 90px;
            left: 20px;
            width: 320px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            z-index: 100;
            animation: panel-pop 0.2s ease-out;
            overflow: hidden;
        }
        .ai-panel.hidden { display: none; }
        .ai-btn-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 14px;
        }
        .ai-btn-option:hover {
            background: rgba(79, 70, 229, 0.1);
        }
        .ai-btn-option i {
            width: 20px;
            text-align: center;
            color: var(--accent);
        }
        .ai-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            color: var(--accent);
        }
        .ai-loading i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .ai-result {
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
            border-top: 1px solid var(--border);
        }
        .ai-result-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }
        .ai-result-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        /* Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ РЎС“Р В±Р ВµР С–Р В°РЎР‹РЎвЂ°Р ВµР С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ */
        .message-running-away {
            position: relative;
            animation: runAway 1.5s ease-in forwards;
        }
        
        .message-running-away::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 12px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 12'%3E%3Cpath d='M3 0 L3 8 L0 12 L3 10 L3 8' fill='%23666' class='leg-left'/%3E%3Cpath d='M17 0 L17 8 L20 12 L17 10 L17 8' fill='%23666' class='leg-right'/%3E%3C/svg%3E");
            animation: runLegs 0.15s steps(2) infinite;
        }
        
        @keyframes runAway {
            0% {
                transform: translateX(0) rotate(0deg);
                opacity: 1;
            }
            10% {
                transform: translateX(10px) rotate(5deg);
            }
            20% {
                transform: translateX(0px) rotate(-3deg);
            }
            30% {
                transform: translateX(-30px) rotate(-5deg);
            }
            50% {
                transform: translateX(-100px) rotate(-10deg);
                opacity: 1;
            }
            100% {
                transform: translateX(-500px) rotate(-15deg);
                opacity: 0;
            }
        }
        
        @keyframes runLegs {
            0% { transform: translateX(-50%) scaleX(1); }
            50% { transform: translateX(-50%) scaleX(-1); }
        }
        
        .message-legs {
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            font-size: 14px;
        }
        
        .leg {
            animation: legMove 0.1s steps(2) infinite;
            display: inline-block;
        }
        
        .leg:nth-child(2) {
            animation-delay: 0.05s;
        }
        
        @keyframes legMove {
            0%, 100% { transform: rotate(-20deg); }
            50% { transform: rotate(20deg); }
        }
        
        /* Р СњР С•Р Р†Р С•Р С–Р С•Р Т‘Р Р…Р ВµР Вµ Р С•РЎвЂћР С•РЎР‚Р СР В»Р ВµР Р…Р С‘Р Вµ - Р вЂњР С‘РЎР‚Р В»РЎРЏР Р…Р Т‘Р В° */
        .new-year-logo {
            position: relative;
            display: inline-block;
            padding: 8px 0;
        }
        
        .garland {
            position: absolute;
            top: -5px;
            left: -10px;
            right: -10px;
            height: 30px;
            pointer-events: none;
            overflow: visible;
        }
        
        .garland-wire {
            position: absolute;
            top: 12px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                #166534 10%, 
                #166534 90%, 
                transparent 100%
            );
            border-radius: 2px;
        }
        
        .garland-light {
            position: absolute;
            top: 8px;
            width: 8px;
            height: 12px;
            border-radius: 50% 50% 50% 50% / 30% 30% 70% 70%;
            animation: glow 1s ease-in-out infinite alternate;
            box-shadow: 0 0 8px currentColor, 0 0 12px currentColor;
        }
        
        .garland-light:nth-child(2) { left: 5%; background: #ef4444; color: #ef4444; animation-delay: 0s; }
        .garland-light:nth-child(3) { left: 18%; background: #eab308; color: #eab308; animation-delay: 0.2s; }
        .garland-light:nth-child(4) { left: 31%; background: #22c55e; color: #22c55e; animation-delay: 0.4s; }
        .garland-light:nth-child(5) { left: 44%; background: #3b82f6; color: #3b82f6; animation-delay: 0.6s; }
        .garland-light:nth-child(6) { left: 57%; background: #ef4444; color: #ef4444; animation-delay: 0.8s; }
        .garland-light:nth-child(7) { left: 70%; background: #eab308; color: #eab308; animation-delay: 1s; }
        .garland-light:nth-child(8) { left: 83%; background: #22c55e; color: #22c55e; animation-delay: 1.2s; }
        
        @keyframes glow {
            0% { opacity: 0.4; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1.1); }
        }
        
        /* Р вЂєР С•Р С”Р В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ РЎРѓР Р…Р ВµР В¶Р С‘Р Р…Р С”Р С‘ Р Р†Р С•Р С”РЎР‚РЎС“Р С– Р В»Р С•Р С–Р С•РЎвЂљР С‘Р С—Р В° */
        .logo-snowflakes {
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -30px;
            pointer-events: none;
            overflow: hidden;
            border-radius: 20px;
        }
        
        .logo-snowflake {
            position: absolute;
            top: -10px;
            color: rgba(255,255,255,0.8);
            font-size: 10px;
            animation: logoSnowfall linear infinite;
            text-shadow: 0 0 3px rgba(100,150,255,0.5);
        }
        
        @keyframes logoSnowfall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(60px) rotate(180deg);
                opacity: 0;
            }
        }
        
        .new-year-hidden .garland,
        .new-year-hidden .logo-snowflakes {
            display: none !important;
        }
        
        /* ========== Р вЂРЎвЂ№РЎРѓРЎвЂљРЎР‚РЎвЂ№Р Вµ Р С•РЎвЂљР Р†Р ВµРЎвЂљРЎвЂ№ ========== */
        .quick-replies-panel {
            display: none;
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 90;
            max-height: 200px;
            overflow-y: auto;
            animation: panel-pop 0.2s ease-out;
        }
        .quick-replies-panel.active { display: block; }
        .quick-reply-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }
        .quick-reply-item:last-child { border-bottom: none; }
        .quick-reply-item:hover {
            background: rgba(79, 70, 229, 0.1);
        }
        .quick-reply-item .emoji {
            margin-right: 8px;
        }
        
        /* ========== Р В¤Р С‘РЎвЂЎР В° 3: Р вЂ”Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– ========== */
        .bookmarks-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            right: 0;
            width: 350px;
            max-width: 100%;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .bookmarks-panel.active {
            transform: translateX(0);
        }
        .bookmark-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        .bookmark-item:hover {
            background: rgba(79, 70, 229, 0.05);
        }
        .bookmark-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .bookmark-item-author {
            font-size: 12px;
            font-weight: bold;
            color: var(--accent);
        }
        .bookmark-item-time {
            font-size: 10px;
            opacity: 0.5;
        }
        .bookmark-item-text {
            font-size: 13px;
            opacity: 0.8;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .bookmark-remove {
            opacity: 0;
            transition: opacity 0.15s;
        }
        .bookmark-item:hover .bookmark-remove {
            opacity: 1;
        }
        
        /* Р СџР С•Р Т‘РЎРѓР Р†Р ВµРЎвЂљР С”Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С—РЎР‚Р С‘ Р С—Р ВµРЎР‚Р ВµРЎвЂ¦Р С•Р Т‘Р Вµ Р С‘Р В· Р В·Р В°Р С”Р В»Р В°Р Т‘Р С•Р С” */
        .highlight-msg {
            animation: highlight-pulse 2s ease-out;
        }
        @keyframes highlight-pulse {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 0 4px var(--accent), 0 0 20px var(--accent); }
        }
        
        /* ========== Р вЂ”Р В°Р СР ВµРЎвЂљР С”Р С‘ (Notes) ========== */
        .notes-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            right: 0;
            width: 380px;
            max-width: 100%;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .notes-panel.active {
            transform: translateX(0);
        }
        .note-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        .note-item:hover {
            background: rgba(79, 70, 229, 0.05);
        }
        .note-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .note-item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        .note-item-date {
            font-size: 10px;
            opacity: 0.5;
        }
        .note-item-preview {
            font-size: 13px;
            opacity: 0.6;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .note-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .note-editor textarea {
            flex: 1;
            width: 100%;
            padding: 16px;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-size: 14px;
            line-height: 1.6;
        }
        .note-color-picker {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }
        .note-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .note-color:hover { transform: scale(1.2); }
        .note-color.active { border-color: var(--text); }
        
        /* ========== Р СџРЎР‚Р С•РЎвЂЎР С‘РЎвЂљР В°Р Р…Р С• (Read receipts) ========== */
        .read-receipt {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 9px;
            opacity: 0.5;
            margin-left: 6px;
        }
        .read-receipt i {
            font-size: 10px;
        }
        .read-receipt.read {
            color: #3b82f6;
            opacity: 1;
        }
        .read-receipt-time {
            font-size: 8px;
            opacity: 0.7;
        }
        
        /* ========== Р В Р В°РЎРѓРЎв‚¬Р С‘РЎР‚Р ВµР Р…Р Р…РЎвЂ№Р в„– Р С—Р С•Р С‘РЎРѓР С” ========== */
        .search-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            right: 0;
            width: 400px;
            max-width: 100%;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .search-panel.active {
            transform: translateX(0);
        }
        .search-filters {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .search-filter-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: transparent;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .search-filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .search-filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .search-date-range {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        .search-date-range input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-app);
            font-size: 12px;
            outline: none;
        }
        .search-date-range input:focus {
            border-color: var(--accent);
        }
        .search-results {
            flex: 1;
            overflow-y: auto;
        }
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        .search-result-item:hover {
            background: rgba(79, 70, 229, 0.05);
        }
        .search-result-type {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
            margin-bottom: 6px;
        }
        .search-result-text {
            font-size: 13px;
        }
        .search-result-text mark {
            background: rgba(234, 179, 8, 0.3);
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }
        .search-result-meta {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 4px;
        }
        
        /* Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ */
        .profile-modal {
            position: fixed;
            inset: 0;
            z-index: 300;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: modal-fade 0.2s ease;
        }
        .profile-modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            width: 100%;
            max-width: 360px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modal-pop 0.25s ease;
            overflow: hidden;
        }
        .profile-header {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            padding: 30px 20px;
            text-align: center;
            color: white;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: var(--accent);
            overflow: hidden;
            border: 4px solid rgba(255,255,255,0.3);
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-name {
            font-size: 20px;
            font-weight: bold;
        }
        .profile-status {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }
        .profile-body {
            padding: 20px;
        }
        .profile-info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .profile-info-item:last-child {
            border-bottom: none;
        }
        .profile-info-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(99, 102, 241, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }
        .profile-info-label {
            font-size: 11px;
            opacity: 0.5;
            text-transform: uppercase;
        }
        .profile-info-value {
            font-size: 14px;
            font-weight: 500;
        }
        .profile-hidden {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.5;
        }
        
        /* Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘Р Вµ (Poll) */
        .poll-container {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 16px;
            padding: 16px;
            min-width: 250px;
        }
        .poll-question {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .poll-question i {
            color: var(--accent);
        }
        .poll-option {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .poll-option:hover:not(.voted):not(.poll-ended) {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }
        .poll-option.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.15);
        }
        .poll-option .poll-progress {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            transition: width 0.5s ease;
        }
        .poll-option-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .poll-option-text {
            font-size: 14px;
        }
        .poll-option-percent {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .poll-option.voted .poll-option-percent,
        .poll-option.poll-ended .poll-option-percent {
            opacity: 1;
        }
        .poll-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.6;
        }
        .poll-votes-count {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Р СљР С•Р Т‘Р В°Р В»Р С”Р В° РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ */
        .poll-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: modal-fade 0.2s ease;
        }
        .poll-modal {
            background: var(--bg-card);
            border-radius: 24px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modal-pop 0.25s ease;
            overflow: hidden;
        }
        .poll-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .poll-modal-header h3 {
            font-weight: 700;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .poll-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .poll-input-group {
            margin-bottom: 16px;
        }
        .poll-input-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            opacity: 0.7;
        }
        .poll-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-app);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .poll-input:focus {
            border-color: var(--accent);
        }
        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .poll-option-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .poll-option-input input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-app);
            font-size: 13px;
            outline: none;
        }
        .poll-option-input input:focus {
            border-color: var(--accent);
        }
        .poll-remove-option {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            cursor: pointer;
            transition: all 0.2s;
        }
        .poll-remove-option:hover {
            background: #ef4444;
            color: white;
        }
        .poll-add-option {
            padding: 10px;
            border: 2px dashed var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--accent);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .poll-add-option:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }
        .poll-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }
        .poll-modal-footer button {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .poll-btn-cancel {
            background: var(--bg-app);
            color: var(--text);
        }
        .poll-btn-cancel:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        .poll-btn-create {
            background: var(--accent);
            color: white;
        }
        .poll-btn-create:hover {
            filter: brightness(1.1);
        }
        .poll-btn-create:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ========== Р В Р Р€Р вЂР ВР СњР В« ========== */
        .rubies-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }
        .rubies-display:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }
        .rubies-display i {
            font-size: 16px;
            animation: ruby-shine 2s infinite;
        }
        @keyframes ruby-shine {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
        .ruby-earned {
            position: fixed;
            z-index: 1000;
            color: #ef4444;
            font-weight: bold;
            font-size: 16px;
            pointer-events: none;
            animation: ruby-float 1.5s ease-out forwards;
        }
        @keyframes ruby-float {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        
        /* Р СљР В°Р С–Р В°Р В·Р С‘Р Р… РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† */
        .ruby-shop-modal {
            position: fixed;
            inset: 0;
            z-index: 400;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: modal-fade 0.2s ease;
        }
        .ruby-shop-content {
            background: var(--bg-card);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            animation: modal-pop 0.25s ease;
        }
        .ruby-shop-header {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            padding: 24px;
            color: white;
            text-align: center;
        }
        .ruby-shop-header h3 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .ruby-shop-balance {
            font-size: 32px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .ruby-shop-balance i {
            animation: ruby-shine 2s infinite;
        }
        .ruby-shop-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .ruby-shop-category {
            margin-bottom: 20px;
        }
        .ruby-shop-category-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ruby-shop-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: var(--bg-app);
            border-radius: 16px;
            margin-bottom: 10px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .ruby-shop-item:hover {
            border-color: var(--accent);
            transform: translateX(5px);
        }
        .ruby-shop-item.owned {
            opacity: 0.6;
            border-color: #22c55e;
        }
        .ruby-shop-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        .ruby-shop-item-info {
            flex: 1;
        }
        .ruby-shop-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        .ruby-shop-item-desc {
            font-size: 11px;
            opacity: 0.6;
        }
        .ruby-shop-item-price {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ruby-shop-item-price:hover {
            transform: scale(1.05);
        }
        .ruby-shop-item-price.owned {
            background: #22c55e;
            cursor: default;
        }
        .ruby-shop-item-price.owned:hover {
            transform: none;
        }
        
        /* Premium РЎРѓРЎвЂљР С‘Р В»Р С‘ */
        .premium-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            animation: premium-glow 2s ease-in-out infinite;
        }
        .premium-badge i {
            font-size: 10px;
        }
        @keyframes premium-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.8), 0 0 25px rgba(239, 68, 68, 0.5); }
        }
        
        .premium-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(245, 158, 11, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .premium-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #312e81;
        }
        .premium-badge:hover .premium-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Р СљР В°Р В»Р ВµР Р…РЎРЉР С”Р С‘Р в„– Р В·Р Р…Р В°РЎвЂЎР С•Р С” Premium Р Т‘Р В»РЎРЏ РЎРѓР С—Р С‘РЎРѓР С”Р В° РЎвЂЎР В°РЎвЂљР С•Р Р† Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– */
        .premium-badge-small {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            border-radius: 50%;
            font-size: 8px;
            margin-left: 4px;
            animation: premium-glow 2s ease-in-out infinite;
            flex-shrink: 0;
        }
        .premium-badge-small i {
            font-size: 8px;
        }
        
        /* Р РЋР С”Р С‘Р Т‘Р С”Р В° Premium Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ */
        .ruby-shop-item-price s {
            color: rgba(255,255,255,0.5);
            margin-right: 4px;
        }
        
        /* Р С™Р Р…Р С•Р С—Р С”Р В° Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘ */
        .animated-avatar-btn {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .animated-avatar-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .animated-avatar-btn .premium-badge-small {
            margin-left: 8px;
            width: 18px;
            height: 18px;
            font-size: 9px;
        }
        
        /* Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р В°РЎРЏ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р В° */
        .avatar-animated {
            border: 2px solid transparent;
            background: linear-gradient(var(--bg-card), var(--bg-card)) padding-box,
                        linear-gradient(135deg, #f59e0b, #ef4444, #ec4899) border-box;
            animation: avatar-glow 3s ease-in-out infinite;
        }
        @keyframes avatar-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.6), 0 0 30px rgba(239, 68, 68, 0.3); }
        }
        
        .premium-shop-banner {
            background: linear-gradient(135deg, #f59e0b, #ef4444, #ec4899);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .premium-shop-banner::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: premium-shine 3s infinite;
        }
        @keyframes premium-shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .premium-shop-banner h4 {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 8px;
            position: relative;
        }
        .premium-shop-banner p {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 12px;
            position: relative;
        }
        .premium-shop-banner .premium-features {
            display: flex;
            justify-content: center;
            gap: 16px;
            font-size: 11px;
            margin-bottom: 12px;
            position: relative;
        }
        .premium-shop-banner .premium-price {
            font-size: 24px;
            font-weight: 900;
            position: relative;
        }
        .premium-shop-banner button {
            margin-top: 12px;
            background: white;
            color: #ef4444;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .premium-shop-banner button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .premium-shop-banner.active-premium {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }
        
        /* Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ */
        .animated-avatar {
            position: relative;
        }
        .animated-avatar::before {
            content: '';
            position: absolute;
            inset: -3px;
            background: linear-gradient(45deg, #f59e0b, #ef4444, #ec4899, #8b5cf6, #f59e0b);
            background-size: 300% 300%;
            border-radius: inherit;
            animation: avatar-gradient 3s ease infinite;
            z-index: -1;
        }
        @keyframes avatar-gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘ */
        .animated-avatar {
            position: relative;
        }
        .animated-avatar::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f59e0b, #ef4444, #ec4899, #8b5cf6, #3b82f6);
            background-size: 300% 300%;
            animation: avatar-glow 3s ease infinite;
            z-index: -1;
        }
        @keyframes avatar-glow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Р Р€Р Р…Р С‘Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•РЎвЂћР С•РЎР‚Р СР В»Р ВµР Р…Р С‘Р Вµ РЎвЂЎР В°РЎвЂљР В° */
        .premium-chat-bg {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)) !important;
        }
        .premium-messages .sent {
            background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
        }
        .premium-messages .received {
            background: linear-gradient(135deg, var(--bg-card), rgba(99, 102, 241, 0.1)) !important;
        }
        
        /* Premium РЎвЂљР ВµР СРЎвЂ№ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– */
        .premium-theme-purple .message-bubble.sent {
            background: linear-gradient(135deg, #8b5cf6, #a855f7) !important;
        }
        .premium-theme-pink .message-bubble.sent {
            background: linear-gradient(135deg, #ec4899, #f472b6) !important;
        }
        .premium-theme-orange .message-bubble.sent {
            background: linear-gradient(135deg, #f97316, #fb923c) !important;
        }
        .premium-theme-green .message-bubble.sent {
            background: linear-gradient(135deg, #22c55e, #4ade80) !important;
        }
        .premium-theme-cyan .message-bubble.sent {
            background: linear-gradient(135deg, #06b6d4, #22d3ee) !important;
        }
        .premium-theme-red .message-bubble.sent {
            background: linear-gradient(135deg, #ef4444, #f87171) !important;
        }
        .premium-theme-gold .message-bubble.sent {
            background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
            color: #78350f !important;
        }
        
        /* Premium РЎР‚Р В°Р СР С”Р С‘ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В° */
        .premium-avatar-frame {
            position: relative;
        }
        .premium-avatar-frame::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            z-index: -1;
        }
        .premium-frame-rainbow::before {
            background: linear-gradient(45deg, #f59e0b, #ef4444, #ec4899, #8b5cf6, #3b82f6, #22c55e, #f59e0b);
            background-size: 300% 300%;
            animation: rainbow-rotate 3s linear infinite;
        }
        .premium-frame-gold::before {
            background: linear-gradient(45deg, #fbbf24, #f59e0b, #fbbf24);
            box-shadow: 0 0 10px #fbbf24;
        }
        .premium-frame-purple::before {
            background: linear-gradient(45deg, #8b5cf6, #a855f7, #8b5cf6);
            box-shadow: 0 0 10px #8b5cf6;
        }
        .premium-frame-pink::before {
            background: linear-gradient(45deg, #ec4899, #f472b6, #ec4899);
            box-shadow: 0 0 10px #ec4899;
        }
        .premium-frame-cyan::before {
            background: linear-gradient(45deg, #06b6d4, #22d3ee, #06b6d4);
            box-shadow: 0 0 10px #06b6d4;
        }
        @keyframes rainbow-rotate {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }
        
        /* Р С’Р Т‘Р СР С‘Р Р… Р С—Р В°Р Р…Р ВµР В»РЎРЉ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ */
        .creator-panel {
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
        }
        .creator-panel h3 {
            color: #78350f !important;
        }
    </style>
    
    <!-- Eruda Console Р Т‘Р В»РЎРЏ Р С•РЎвЂљР В»Р В°Р Т‘Р С”Р С‘ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ -->
    <script>
        // Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ Р С”Р С•Р Р…РЎРѓР С•Р В»РЎРЉ: Р Р† Р В°Р Т‘РЎР‚Р ВµРЎРѓР Р…Р С•Р в„– РЎРѓРЎвЂљРЎР‚Р С•Р С”Р Вµ Р Р†Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ javascript:toggleEruda() Р С‘Р В»Р С‘ Р Р…Р В°Р В¶Р СР С‘РЎвЂљР Вµ Р С”Р Р…Р С•Р С—Р С”РЎС“ Р Р† Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В°РЎвЂ¦
        window.toggleEruda = function() {
            if (window.eruda) {
                if (window.eruda._isInit) {
                    window.eruda.destroy();
                    window.eruda._isInit = false;
                    if (window.showToast) showToast('Р С™Р С•Р Р…РЎРѓР С•Р В»РЎРЉ Р В·Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР В°', 'СЂСџвЂќВ§');
                } else {
                    window.eruda.init();
                    window.eruda._isInit = true;
                    if (window.showToast) showToast('Р С™Р С•Р Р…РЎРѓР С•Р В»РЎРЉ Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљР В°', 'СЂСџвЂќВ§');
                }
            } else {
                if (window.showToast) showToast('Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р С”Р С•Р Р…РЎРѓР С•Р В»Р С‘...', 'РІРЏС–');
                var script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/eruda';
                script.onerror = function() {
                    // Fallback URL
                    var script2 = document.createElement('script');
                    script2.src = 'https://unpkg.com/eruda';
                    script2.onerror = function() {
                        if (window.showToast) showToast('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С‘РЎвЂљРЎРЉ Р С”Р С•Р Р…РЎРѓР С•Р В»РЎРЉ', 'РІСњРЉ');
                        alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С‘РЎвЂљРЎРЉ Р С”Р С•Р Р…РЎРѓР С•Р В»РЎРЉ РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”Р В°. Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЉРЎвЂљР Вµ Р С‘Р Р…РЎвЂљР ВµРЎР‚Р Р…Р ВµРЎвЂљ-РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р ВµР Р…Р С‘Р Вµ.');
                    };
                    script2.onload = function() {
                        window.eruda.init();
                        window.eruda._isInit = true;
                        if (window.showToast) showToast('Р С™Р С•Р Р…РЎРѓР С•Р В»РЎРЉ Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљР В°', 'СЂСџвЂќВ§');
                    };
                    document.body.appendChild(script2);
                };
                script.onload = function() {
                    window.eruda.init();
                    window.eruda._isInit = true;
                    if (window.showToast) showToast('Р С™Р С•Р Р…РЎРѓР С•Р В»РЎРЉ Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљР В°', 'СЂСџвЂќВ§');
                };
                document.body.appendChild(script);
            }
        };
    </script>
</head>
<body class="theme-light h-screen flex flex-col overflow-hidden">

<!-- Р С™Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ Р Т‘Р В»РЎРЏ РЎвЂљР С•РЎРѓРЎвЂљР С•Р Р† -->
<div id="toast-container"></div>

<!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ -->
<div id="profile-modal" class="profile-modal" style="display: none;" onclick="if(event.target === this) closeProfileModal()">
    <div class="profile-modal-content">
        <div class="profile-header">
            <div class="profile-avatar" id="profile-modal-avatar">?</div>
            <div class="profile-name" id="profile-modal-name">@username</div>
            <div class="profile-status" id="profile-modal-status">Р С›РЎвЂћР В»Р В°Р в„–Р Р…</div>
        </div>
        <div class="profile-body" id="profile-modal-body">
            <!-- Р вЂ”Р В°Р С—Р С•Р В»Р Р…РЎРЏР ВµРЎвЂљРЎРѓРЎРЏ Р Т‘Р С‘Р Р…Р В°Р СР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ -->
        </div>
        <div class="p-4 border-t border-[var(--border)]">
            <button onclick="closeProfileModal()" class="w-full py-3 bg-slate-100 dark:bg-slate-800 rounded-xl font-bold text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ
            </button>
        </div>
    </div>
</div>

<!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ -->
<div id="poll-modal" class="poll-modal-overlay" style="display: none;" onclick="if(event.target === this) closePollModal()">
    <div class="poll-modal" onclick="event.stopPropagation()">
        <div class="poll-modal-header">
            <h3><i class="fas fa-poll text-purple-500"></i> Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘Р Вµ</h3>
            <button onclick="closePollModal()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="poll-modal-body">
            <div class="poll-input-group">
                <label>Р вЂ™Р С•Р С—РЎР‚Р С•РЎРѓ</label>
                <input type="text" id="poll-question" class="poll-input" placeholder="Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р Р†Р С•Р С—РЎР‚Р С•РЎРѓ..." maxlength="200">
            </div>
            <div class="poll-input-group">
                <label>Р вЂ™Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљРЎвЂ№ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° (Р СР С‘Р Р…Р С‘Р СРЎС“Р С 2)</label>
                <div id="poll-options-container" class="poll-options-list">
                    <div class="poll-option-input">
                        <input type="text" placeholder="Р вЂ™Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ 1" maxlength="100">
                        <button class="poll-remove-option" onclick="removePollOption(this)" style="visibility: hidden;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="poll-option-input">
                        <input type="text" placeholder="Р вЂ™Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ 2" maxlength="100">
                        <button class="poll-remove-option" onclick="removePollOption(this)" style="visibility: hidden;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button class="poll-add-option" onclick="addPollOption()">
                    <i class="fas fa-plus"></i> Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ
                </button>
            </div>
            <div class="poll-input-group">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="poll-anonymous" class="w-4 h-4 accent-indigo-500">
                    <span class="text-sm">Р С’Р Р…Р С•Р Р…Р С‘Р СР Р…Р С•Р Вµ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘Р Вµ</span>
                </label>
            </div>
            <div class="poll-input-group">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="poll-multiple" class="w-4 h-4 accent-indigo-500">
                    <span class="text-sm">Р СљР С•Р В¶Р Р…Р С• Р Р†РЎвЂ№Р В±РЎР‚Р В°РЎвЂљРЎРЉ Р Р…Р ВµРЎРѓР С”Р С•Р В»РЎРЉР С”Р С• Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљР С•Р Р†</span>
                </label>
            </div>
        </div>
        <div class="poll-modal-footer">
            <button class="poll-btn-cancel" onclick="closePollModal()">Р С›РЎвЂљР СР ВµР Р…Р В°</button>
            <button class="poll-btn-create" onclick="createPoll()">Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ</button>
        </div>
    </div>
</div>

<!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ Р В·Р В°Р С”Р В»Р В°Р Т‘Р С•Р С” -->
<div id="bookmarks-panel" class="bookmarks-panel">
    <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
        <div class="flex items-center gap-3">
            <i class="fas fa-bookmark text-yellow-500 text-xl"></i>
            <div>
                <p class="font-bold" data-i18n="bookmarks">Р вЂ”Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘</p>
                <p class="text-xs opacity-50" data-i18n="savedMessages">Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ</p>
            </div>
        </div>
        <button onclick="toggleBookmarks()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="bookmarks-list" class="flex-1 overflow-y-auto">
        <div class="p-8 text-center opacity-50">
            <i class="fas fa-bookmark text-4xl mb-3"></i>
            <p class="text-sm" data-i18n="noBookmarks">Р СњР ВµРЎвЂљ Р В·Р В°Р С”Р В»Р В°Р Т‘Р С•Р С”</p>
        </div>
    </div>
</div>

<!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ Р В·Р В°Р СР ВµРЎвЂљР С•Р С” -->
<div id="notes-panel" class="notes-panel">
    <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
        <div class="flex items-center gap-3">
            <i class="fas fa-sticky-note text-orange-500 text-xl"></i>
            <div>
                <p class="font-bold">Р вЂ”Р В°Р СР ВµРЎвЂљР С”Р С‘</p>
                <p class="text-xs opacity-50">Р вЂєР С‘РЎвЂЎР Р…РЎвЂ№Р Вµ Р В·Р В°Р С—Р С‘РЎРѓР С‘</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="createNewNote()" class="w-10 h-10 rounded-full hover:bg-green-50 hover:text-green-500 flex items-center justify-center transition-all" title="Р СњР С•Р Р†Р В°РЎРЏ Р В·Р В°Р СР ВµРЎвЂљР С”Р В°">
                <i class="fas fa-plus"></i>
            </button>
            <button onclick="toggleNotes()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div id="notes-list" class="flex-1 overflow-y-auto">
        <div class="p-8 text-center opacity-50">
            <i class="fas fa-sticky-note text-4xl mb-3"></i>
            <p class="text-sm">Р СњР ВµРЎвЂљ Р В·Р В°Р СР ВµРЎвЂљР С•Р С”</p>
            <p class="text-xs mt-2">Р СњР В°Р В¶Р СР С‘РЎвЂљР Вµ + РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ</p>
        </div>
    </div>
</div>

<!-- Р В Р ВµР Т‘Р В°Р С”РЎвЂљР С•РЎР‚ Р В·Р В°Р СР ВµРЎвЂљР С”Р С‘ -->
<div id="note-editor-panel" class="notes-panel">
    <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
        <button onclick="closeNoteEditor()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
            <i class="fas fa-arrow-left"></i>
        </button>
        <input type="text" id="note-title-input" placeholder="Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р В·Р В°Р СР ВµРЎвЂљР С”Р С‘..." class="flex-1 mx-3 bg-transparent border-none outline-none font-bold text-lg">
        <button onclick="saveCurrentNote()" class="w-10 h-10 rounded-full hover:bg-green-50 text-green-500 flex items-center justify-center" title="Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р С‘РЎвЂљРЎРЉ">
            <i class="fas fa-check"></i>
        </button>
        <button onclick="deleteCurrentNote()" class="w-10 h-10 rounded-full hover:bg-red-50 text-red-500 flex items-center justify-center" title="Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    <div class="note-editor">
        <textarea id="note-content-input" placeholder="Р СњР В°Р С—Р С‘РЎв‚¬Р С‘РЎвЂљР Вµ РЎвЂЎРЎвЂљР С•-Р Р…Р С‘Р В±РЎС“Р Т‘РЎРЉ..."></textarea>
    </div>
    <div class="note-color-picker">
        <div class="note-color active" style="background: #f1f5f9;" data-color="#f1f5f9" onclick="setNoteColor(this)"></div>
        <div class="note-color" style="background: #fef3c7;" data-color="#fef3c7" onclick="setNoteColor(this)"></div>
        <div class="note-color" style="background: #dcfce7;" data-color="#dcfce7" onclick="setNoteColor(this)"></div>
        <div class="note-color" style="background: #dbeafe;" data-color="#dbeafe" onclick="setNoteColor(this)"></div>
        <div class="note-color" style="background: #fce7f3;" data-color="#fce7f3" onclick="setNoteColor(this)"></div>
        <div class="note-color" style="background: #f3e8ff;" data-color="#f3e8ff" onclick="setNoteColor(this)"></div>
    </div>
</div>

<!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ РЎР‚Р В°РЎРѓРЎв‚¬Р С‘РЎР‚Р ВµР Р…Р Р…Р С•Р С–Р С• Р С—Р С•Р С‘РЎРѓР С”Р В° -->
<div id="search-panel" class="search-panel">
    <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
        <div class="flex items-center gap-3">
            <i class="fas fa-search text-blue-500 text-xl"></i>
            <div>
                <p class="font-bold">Р В Р В°РЎРѓРЎв‚¬Р С‘РЎР‚Р ВµР Р…Р Р…РЎвЂ№Р в„– Р С—Р С•Р С‘РЎРѓР С”</p>
                <p class="text-xs opacity-50">Р СџР С•Р С‘РЎРѓР С” Р С—Р С• РЎвЂЎР В°РЎвЂљРЎС“</p>
            </div>
        </div>
        <button onclick="toggleSearchPanel()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="p-3 border-b border-[var(--border)]">
        <input type="text" id="advanced-search-input" placeholder="Р СџР С•Р С‘РЎРѓР С”..." class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" oninput="performAdvancedSearch()">
    </div>
    <div class="search-filters">
        <button class="search-filter-btn active" data-filter="all" onclick="setSearchFilter('all')">
            <i class="fas fa-globe"></i> Р вЂ™РЎРѓРЎвЂ
        </button>
        <button class="search-filter-btn" data-filter="text" onclick="setSearchFilter('text')">
            <i class="fas fa-font"></i> Р СћР ВµР С”РЎРѓРЎвЂљ
        </button>
        <button class="search-filter-btn" data-filter="images" onclick="setSearchFilter('images')">
            <i class="fas fa-image"></i> Р В¤Р С•РЎвЂљР С•
        </button>
        <button class="search-filter-btn" data-filter="files" onclick="setSearchFilter('files')">
            <i class="fas fa-file"></i> Р В¤Р В°Р в„–Р В»РЎвЂ№
        </button>
        <button class="search-filter-btn" data-filter="links" onclick="setSearchFilter('links')">
            <i class="fas fa-link"></i> Р РЋРЎРѓРЎвЂ№Р В»Р С”Р С‘
        </button>
    </div>
    <div class="search-date-range">
        <input type="date" id="search-date-from" placeholder="Р С›РЎвЂљ" onchange="performAdvancedSearch()">
        <input type="date" id="search-date-to" placeholder="Р вЂќР С•" onchange="performAdvancedSearch()">
    </div>
    <div id="search-results" class="search-results">
        <div class="p-8 text-center opacity-50">
            <i class="fas fa-search text-4xl mb-3"></i>
            <p class="text-sm">Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р В·Р В°Р С—РЎР‚Р С•РЎРѓ Р Т‘Р В»РЎРЏ Р С—Р С•Р С‘РЎРѓР С”Р В°</p>
        </div>
    </div>
</div>

<!-- Р СџРЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ Р СР ВµР Т‘Р С‘Р В° Р Р…Р В° Р Р†Р ВµРЎРѓРЎРЉ РЎРЊР С”РЎР‚Р В°Р Р… (РЎвЂћР С•РЎвЂљР С• Р С‘ Р Р†Р С‘Р Т‘Р ВµР С•) -->
<div id="media-viewer" class="fixed inset-0 z-[9999] bg-black/95 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeMediaViewer(event)">
    <button onclick="closeMediaViewer()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all z-10">
        <i class="fas fa-times text-xl"></i>
    </button>
    <button id="media-viewer-prev" onclick="navigateMedia(-1); event.stopPropagation();" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all z-10">
        <i class="fas fa-chevron-left text-xl"></i>
    </button>
    <button id="media-viewer-next" onclick="navigateMedia(1); event.stopPropagation();" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all z-10">
        <i class="fas fa-chevron-right text-xl"></i>
    </button>
    
    <!-- Р С™Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ Р Т‘Р В»РЎРЏ Р СР ВµР Т‘Р С‘Р В° -->
    <div id="media-viewer-content" class="max-w-[90vw] max-h-[90vh] flex items-center justify-center" onclick="event.stopPropagation()">
        <img id="media-viewer-img" src="" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl hidden">
        <video id="media-viewer-video" src="" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl hidden" controls playsinline></video>
    </div>
    
    <!-- Р РЋРЎвЂЎРЎвЂРЎвЂљРЎвЂЎР С‘Р С” Р С‘ Р С”Р Р…Р С•Р С—Р С”Р С‘ -->
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2">
        <span id="media-viewer-counter" class="text-white/70 text-sm"></span>
        <div class="flex gap-2">
            <a id="media-viewer-download" href="" download class="px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm flex items-center gap-2 transition-all">
                <i class="fas fa-download"></i>
                <span>Р РЋР С”Р В°РЎвЂЎР В°РЎвЂљРЎРЉ</span>
            </a>
        </div>
    </div>
    
    <!-- Р СљР С‘Р Р…Р С‘Р В°РЎвЂљРЎР‹РЎР‚РЎвЂ№ -->
    <div id="media-viewer-thumbnails" class="absolute bottom-20 left-1/2 -translate-x-1/2 flex gap-2 max-w-[80vw] overflow-x-auto p-2 bg-black/50 rounded-xl hidden"></div>
</div>

<!-- Р РЋРЎвЂљР В°РЎР‚РЎвЂ№Р в„– Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎвЂ°Р С‘Р С” Р Т‘Р В»РЎРЏ РЎРѓР С•Р Р†Р СР ВµРЎРѓРЎвЂљР С‘Р СР С•РЎРѓРЎвЂљР С‘ -->
<div id="image-viewer" class="fixed inset-0 z-[9999] bg-black/95 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeImageViewer(event)">
    <button onclick="closeImageViewer()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
        <i class="fas fa-times text-xl"></i>
    </button>
    <button id="image-viewer-prev" onclick="navigateImage(-1); event.stopPropagation();" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
        <i class="fas fa-chevron-left text-xl"></i>
    </button>
    <button id="image-viewer-next" onclick="navigateImage(1); event.stopPropagation();" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
        <i class="fas fa-chevron-right text-xl"></i>
    </button>
    <img id="image-viewer-img" src="" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
        <a id="image-viewer-download" href="" download class="px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm flex items-center gap-2 transition-all">
            <i class="fas fa-download"></i>
            <span data-i18n="downloadFile">Р РЋР С”Р В°РЎвЂЎР В°РЎвЂљРЎРЉ</span>
        </a>
    </div>
</div>

<!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№ -->
<div id="create-group-modal" class="fixed inset-0 z-[9998] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeCreateGroup(event)">
    <div class="bg-[var(--bg-primary)] rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onclick="event.stopPropagation()">
        <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
            <h3 class="font-bold text-lg" data-i18n="createGroup">Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С–РЎР‚РЎС“Р С—Р С—РЎС“</h3>
            <button onclick="closeCreateGroup()" class="w-8 h-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4">
            <input type="text" id="group-name-input" data-i18n-placeholder="groupName" placeholder="Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№..." class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-indigo-500 transition-all mb-4">
            
            <p class="text-xs text-slate-500 mb-2"><span data-i18n="selectedMembers">Р вЂ™РЎвЂ№Р В±РЎР‚Р В°Р Р…Р С• РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†</span>: <span id="selected-count">0</span>/12</p>
            
            <div id="selected-members" class="flex flex-wrap gap-2 mb-4 min-h-[40px] p-2 bg-slate-50 dark:bg-slate-800/50 rounded-xl"></div>
            
            <div class="relative mb-4">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="group-search-input" data-i18n-placeholder="searchUsers" placeholder="Р СџР С•Р С‘РЎРѓР С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–..." class="w-full p-3 pl-10 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-indigo-500 transition-all">
            </div>
            
            <div id="group-search-results" class="max-h-48 overflow-y-auto space-y-2 mb-4"></div>
            
            <button onclick="createGroup()" id="create-group-btn" class="w-full p-3 bg-indigo-500 hover:bg-indigo-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl font-bold transition-colors" disabled>
                <i class="fas fa-users mr-2"></i>
                <span data-i18n="createGroupBtn">Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С–РЎР‚РЎС“Р С—Р С—РЎС“</span>
            </button>
        </div>
    </div>
</div>

<!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ Р С”Р В°Р Р…Р В°Р В»Р В° -->
<div id="create-channel-modal" class="fixed inset-0 z-[9998] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeCreateChannel(event)">
    <div class="bg-[var(--bg-primary)] rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onclick="event.stopPropagation()">
        <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
            <h3 class="font-bold text-lg"><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С”Р В°Р Р…Р В°Р В»</h3>
            <button onclick="closeCreateChannel()" class="w-8 h-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-1 block">Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р С”Р В°Р Р…Р В°Р В»Р В°</label>
                <input type="text" id="channel-name-input" placeholder="Р СљР С•Р в„– Р С”Р В°Р Р…Р В°Р В»..." class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-indigo-500 transition-all">
            </div>
            
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-1 block">Р С›Р С—Р С‘РЎРѓР В°Р Р…Р С‘Р Вµ (Р Р…Р ВµР С•Р В±РЎРЏР В·Р В°РЎвЂљР ВµР В»РЎРЉР Р…Р С•)</label>
                <textarea id="channel-description-input" placeholder="Р С› РЎвЂЎРЎвЂР С РЎРЊРЎвЂљР С•РЎвЂљ Р С”Р В°Р Р…Р В°Р В»..." rows="2" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-indigo-500 transition-all resize-none"></textarea>
            </div>
            
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-2 block">Р СћР С‘Р С— Р С”Р В°Р Р…Р В°Р В»Р В°</label>
                <div class="flex gap-2">
                    <button onclick="setChannelType('public')" id="channel-type-public" class="flex-1 p-3 rounded-xl border-2 border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-sm font-medium transition-all">
                        <i class="fas fa-globe mr-2"></i>Р СџРЎС“Р В±Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р в„–
                    </button>
                    <button onclick="setChannelType('private')" id="channel-type-private" class="flex-1 p-3 rounded-xl border-2 border-[var(--border)] text-sm font-medium transition-all hover:border-indigo-500">
                        <i class="fas fa-lock mr-2"></i>Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…РЎвЂ№Р в„–
                    </button>
                </div>
                <p class="text-[10px] text-slate-400 mt-2" id="channel-type-hint">Р СџРЎС“Р В±Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р в„– Р С”Р В°Р Р…Р В°Р В» Р Р†Р С‘Р Т‘Р ВµР Р… Р Р†РЎРѓР ВµР С Р Р† Р С—Р С•Р С‘РЎРѓР С”Р Вµ</p>
            </div>
            
            <button onclick="createChannel()" id="create-channel-btn" class="w-full p-3 bg-indigo-500 hover:bg-indigo-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl font-bold transition-colors" disabled>
                <i class="fas fa-bullhorn mr-2"></i>
                Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С”Р В°Р Р…Р В°Р В»
            </button>
        </div>
    </div>
</div>

<!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С” Р С”Р В°Р Р…Р В°Р В»Р В° -->
<div id="channel-settings-modal" class="fixed inset-0 z-[9999] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeChannelSettings(event)">
    <div class="bg-[var(--bg-primary)] rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
            <h3 class="font-bold text-lg"><i class="fas fa-cog mr-2 text-purple-500"></i>Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р С”Р В°Р Р…Р В°Р В»Р В°</h3>
            <button onclick="closeChannelSettings()" class="w-8 h-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 overflow-y-auto flex-1">
            <!-- Р С’Р Р†Р В°РЎвЂљР В°РЎР‚ Р С”Р В°Р Р…Р В°Р В»Р В° -->
            <div class="flex items-center gap-4 mb-6">
                <div id="channel-settings-avatar" class="w-20 h-20 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity" onclick="uploadChannelAvatar()">
                    <i class="fas fa-bullhorn text-white text-2xl"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-bold">Р С’Р Р†Р В°РЎвЂљР В°РЎР‚ Р С”Р В°Р Р…Р В°Р В»Р В°</p>
                    <p class="text-xs text-slate-400">Р СњР В°Р В¶Р СР С‘РЎвЂљР Вµ РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ Р С‘Р В·Р СР ВµР Р…Р С‘РЎвЂљРЎРЉ</p>
                    <input type="file" id="channel-avatar-input" accept="image/*" class="hidden" onchange="handleChannelAvatarUpload(event)">
                </div>
            </div>
            
            <!-- Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ -->
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-1 block">Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р С”Р В°Р Р…Р В°Р В»Р В°</label>
                <input type="text" id="channel-settings-name" placeholder="Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ..." class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-purple-500 transition-all">
            </div>
            
            <!-- Р С›Р С—Р С‘РЎРѓР В°Р Р…Р С‘Р Вµ -->
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-1 block">Р С›Р С—Р С‘РЎРѓР В°Р Р…Р С‘Р Вµ</label>
                <textarea id="channel-settings-description" placeholder="Р С› РЎвЂЎРЎвЂР С РЎРЊРЎвЂљР С•РЎвЂљ Р С”Р В°Р Р…Р В°Р В»..." rows="3" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-purple-500 transition-all resize-none"></textarea>
            </div>
            
            <!-- Р СћР С‘Р С— Р С”Р В°Р Р…Р В°Р В»Р В° -->
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-2 block">Р СћР С‘Р С— Р С”Р В°Р Р…Р В°Р В»Р В°</label>
                <div class="flex gap-2">
                    <button onclick="setChannelSettingsType('public')" id="channel-settings-type-public" class="flex-1 p-3 rounded-xl border-2 border-[var(--border)] text-sm font-medium transition-all hover:border-purple-500">
                        <i class="fas fa-globe mr-2"></i>Р СџРЎС“Р В±Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р в„–
                    </button>
                    <button onclick="setChannelSettingsType('private')" id="channel-settings-type-private" class="flex-1 p-3 rounded-xl border-2 border-[var(--border)] text-sm font-medium transition-all hover:border-purple-500">
                        <i class="fas fa-lock mr-2"></i>Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…РЎвЂ№Р в„–
                    </button>
                </div>
            </div>
            
            <!-- Р РЋРЎвЂљР В°РЎвЂљР С‘РЎРѓРЎвЂљР С‘Р С”Р В° -->
            <div class="mb-4 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                <p class="text-xs text-slate-500 mb-2">Р РЋРЎвЂљР В°РЎвЂљР С‘РЎРѓРЎвЂљР С‘Р С”Р В°</p>
                <div class="grid grid-cols-2 gap-3">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-500" id="channel-stats-subscribers">0</p>
                        <p class="text-[10px] text-slate-400">Р СџР С•Р Т‘Р С—Р С‘РЎРѓРЎвЂЎР С‘Р С”Р С•Р Р†</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-pink-500" id="channel-stats-posts">0</p>
                        <p class="text-[10px] text-slate-400">Р СџРЎС“Р В±Р В»Р С‘Р С”Р В°РЎвЂ Р С‘Р в„–</p>
                    </div>
                </div>
            </div>
            
            <!-- Р РЋРЎРѓРЎвЂ№Р В»Р С”Р В°-Р С—РЎР‚Р С‘Р С–Р В»Р В°РЎв‚¬Р ВµР Р…Р С‘Р Вµ -->
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-1 block">Р РЋРЎРѓРЎвЂ№Р В»Р С”Р В°-Р С—РЎР‚Р С‘Р С–Р В»Р В°РЎв‚¬Р ВµР Р…Р С‘Р Вµ</label>
                <div class="flex gap-2">
                    <input type="text" id="channel-invite-link" readonly class="flex-1 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-xs border border-transparent">
                    <button onclick="copyChannelLink()" class="px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl transition-colors">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <!-- Р С’Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚РЎвЂ№ -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-xs text-slate-500">Р С’Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚РЎвЂ№</label>
                    <button onclick="openAddAdminModal()" class="text-xs text-purple-500 hover:text-purple-600">
                        <i class="fas fa-plus mr-1"></i>Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ
                    </button>
                </div>
                <div id="channel-admins-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
            </div>
            
            <!-- Р С™Р Р…Р С•Р С—Р С”Р В° РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С‘РЎРЏ -->
            <button onclick="saveChannelSettings()" class="w-full p-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold transition-colors mb-3">
                <i class="fas fa-save mr-2"></i>Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р С‘РЎвЂљРЎРЉ Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ
            </button>
            
            <!-- Р С›Р С—Р В°РЎРѓР Р…Р В°РЎРЏ Р В·Р С•Р Р…Р В° -->
            <div class="border-t border-[var(--border)] pt-4 mt-4">
                <p class="text-xs text-red-500 font-bold mb-3">Р С›Р С—Р В°РЎРѓР Р…Р В°РЎРЏ Р В·Р С•Р Р…Р В°</p>
                <button onclick="deleteChannel()" class="w-full p-3 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-xl font-bold transition-colors">
                    <i class="fas fa-trash mr-2"></i>Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ Р С”Р В°Р Р…Р В°Р В»
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р В°Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚Р В° -->
<div id="add-admin-modal" class="fixed inset-0 z-[10000] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeAddAdminModal(event)">
    <div class="bg-[var(--bg-primary)] rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden" onclick="event.stopPropagation()">
        <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
            <h3 class="font-bold">Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р В°Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚Р В°</h3>
            <button onclick="closeAddAdminModal()" class="w-8 h-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="relative mb-4">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="admin-search-input" placeholder="Р СџР С•Р С‘РЎРѓР С” Р С—Р С•Р Т‘Р С—Р С‘РЎРѓРЎвЂЎР С‘Р С”Р С•Р Р†..." class="w-full p-3 pl-10 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-purple-500 transition-all" oninput="searchChannelSubscribers(this.value)">
            </div>
            <div id="admin-search-results" class="max-h-60 overflow-y-auto space-y-2"></div>
        </div>
    </div>
</div>

<!-- Р В­Р С”РЎР‚Р В°Р Р… Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° -->
<div id="incoming-call-screen" class="call-screen hidden">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl -top-20 -left-20 animate-pulse"></div>
        <div class="absolute w-96 h-96 bg-purple-500/20 rounded-full blur-3xl -bottom-20 -right-20 animate-pulse" style="animation-delay: 1s"></div>
    </div>
    <div class="relative z-10 flex flex-col items-center">
        <div class="relative">
            <div class="call-avatar overflow-hidden" id="caller-avatar">?</div>
            <div class="absolute inset-0 rounded-full border-4 border-green-400 animate-ping opacity-50"></div>
        </div>
        <p class="text-white text-2xl font-bold mt-6" id="caller-name" data-i18n="incomingCall">Р вЂ™РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”</p>
        <p class="text-white/60 text-sm mt-2 flex items-center gap-2">
            <i class="fas fa-phone-alt text-green-400 animate-bounce"></i>
            <span id="call-type-label" data-i18n="audioCallType">Р С’РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С•Р С”</span>
        </p>
        <p class="text-white/40 text-xs mt-4" data-i18n="flickersCall">Flickers Р В·Р Р†Р С•Р Р…Р С•Р С”</p>
        <div class="flex gap-6 mt-10">
            <div class="flex flex-col items-center">
                <button class="call-btn call-btn-decline shadow-lg shadow-red-500/30" onclick="declineCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
                <span class="text-white/60 text-xs mt-2" data-i18n="decline">Р С›РЎвЂљР С”Р В»Р С•Р Р…Р С‘РЎвЂљРЎРЉ</span>
            </div>
            <div class="flex flex-col items-center">
                <button class="call-btn call-btn-accept shadow-lg shadow-green-500/30 animate-pulse" onclick="acceptCall()">
                    <i class="fas fa-phone-alt"></i>
                </button>
                <span class="text-white/60 text-xs mt-2" data-i18n="accept">Р СџРЎР‚Р С‘Р Р…РЎРЏРЎвЂљРЎРЉ</span>
            </div>
        </div>
    </div>
</div>

<!-- Р В­Р С”РЎР‚Р В°Р Р… Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° -->
<div id="outgoing-call-screen" class="call-screen hidden">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl -top-20 -right-20 animate-pulse"></div>
        <div class="absolute w-96 h-96 bg-blue-500/20 rounded-full blur-3xl -bottom-20 -left-20 animate-pulse" style="animation-delay: 0.5s"></div>
    </div>
    <div class="relative z-10 flex flex-col items-center">
        <div class="relative">
            <div class="call-avatar overflow-hidden" id="callee-avatar">?</div>
            <div class="absolute -inset-2 rounded-full border-2 border-white/20 animate-spin" style="animation-duration: 3s"></div>
            <div class="absolute -inset-4 rounded-full border border-white/10 animate-spin" style="animation-duration: 5s; animation-direction: reverse"></div>
        </div>
        <p class="text-white text-2xl font-bold mt-6" id="callee-name" data-i18n="calling">Р вЂ”Р Р†Р С•Р Р…Р С‘Р С...</p>
        <div class="flex items-center gap-1 mt-2">
            <span class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 0s"></span>
            <span class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            <span class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
        </div>
        <p class="text-white/40 text-xs mt-4" id="outgoing-call-status" data-i18n="waitingAnswer">Р С›Р В¶Р С‘Р Т‘Р В°Р Р…Р С‘Р Вµ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°...</p>
        <div class="flex gap-6 mt-10">
            <div class="flex flex-col items-center">
                <button class="call-btn call-btn-decline shadow-lg shadow-red-500/30" onclick="cancelCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
                <span class="text-white/60 text-xs mt-2" data-i18n="cancelCall">Р С›РЎвЂљР СР ВµР Р…Р В°</span>
            </div>
        </div>
    </div>
</div>

<!-- Р В­Р С”РЎР‚Р В°Р Р… Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° -->
<div id="active-call-screen" class="video-container hidden">
    <!-- Р С™Р Р…Р С•Р С—Р С”Р В° РЎРѓР Р†Р С•РЎР‚Р В°РЎвЂЎР С‘Р Р†Р В°Р Р…Р С‘РЎРЏ -->
    <button class="minimize-call-btn" onclick="minimizeCall()" title="Р РЋР Р†Р ВµРЎР‚Р Р…РЎС“РЎвЂљРЎРЉ Р В·Р Р†Р С•Р Р…Р С•Р С”">
        <i class="fas fa-compress-alt"></i>
    </button>
    
    <video id="remote-video" class="remote-video" autoplay playsinline></video>
    <video id="local-video" class="local-video" autoplay playsinline muted></video>
    
    <!-- Р С™Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ Р Т‘Р В»РЎРЏ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° -->
    <div id="group-call-participants" class="absolute inset-0 hidden">
        <div id="group-videos-grid" class="w-full h-full grid gap-2 p-2"></div>
    </div>
    
    <!-- Р С›Р Р†Р ВµРЎР‚Р В»Р ВµР в„– Р Т‘Р В»РЎРЏ Р В°РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° -->
    <div id="audio-call-overlay" class="absolute inset-0 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 flex flex-col items-center justify-center">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute w-[500px] h-[500px] bg-indigo-500/10 rounded-full blur-3xl top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 animate-pulse"></div>
        </div>
        <!-- Р С™Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ Р Т‘Р В»РЎРЏ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С•Р Р† РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В°РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° -->
        <div id="group-audio-participants" class="hidden flex-wrap justify-center gap-4 max-w-md"></div>
        <div class="relative z-10 flex flex-col items-center" id="single-call-avatar-container">
            <div class="w-32 h-32 rounded-full bg-indigo-500/30 flex items-center justify-center text-5xl font-bold text-white border-4 border-indigo-400/50 overflow-hidden" id="active-call-avatar">?</div>
            <p class="text-white text-xl font-bold mt-6" id="active-call-name-audio">Р вЂ”Р Р†Р С•Р Р…Р С•Р С”</p>
            <div class="flex items-center gap-2 mt-2 text-green-400">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                <span class="text-sm" id="call-timer-audio">00:00</span>
            </div>
            <div class="flex items-center gap-1 mt-4" id="audio-visualizer">
                <span class="w-1 h-4 bg-indigo-400 rounded-full animate-pulse"></span>
                <span class="w-1 h-6 bg-indigo-400 rounded-full animate-pulse" style="animation-delay: 0.1s"></span>
                <span class="w-1 h-8 bg-indigo-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></span>
                <span class="w-1 h-6 bg-indigo-400 rounded-full animate-pulse" style="animation-delay: 0.3s"></span>
                <span class="w-1 h-4 bg-indigo-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></span>
            </div>
        </div>
    </div>
    
    <div class="video-controls">
        <button class="call-btn call-btn-mute" id="mute-btn" onclick="toggleMute()" title="Р СљР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="call-btn call-btn-mute" id="video-btn" onclick="toggleVideo()" title="Р С™Р В°Р СР ВµРЎР‚Р В°">
            <i class="fas fa-video"></i>
        </button>
        <button class="call-btn call-btn-mute" id="screen-share-btn" onclick="toggleScreenShare()" title="Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В°">
            <i class="fas fa-desktop"></i>
        </button>
        <button class="call-btn call-btn-mute" id="speaker-btn" onclick="toggleSpeaker()" title="Р вЂ™РЎвЂ№Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ Р В·Р Р†РЎС“Р С”">
            <i class="fas fa-volume-up"></i>
        </button>
        <button class="call-btn call-btn-mute" id="speakerphone-btn" onclick="toggleSpeakerphone()" title="Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ">
            <i class="fas fa-phone-volume"></i>
        </button>
        <button class="call-btn call-btn-decline" onclick="endCall()" title="Р вЂ”Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р С‘РЎвЂљРЎРЉ">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>
    
    <div class="absolute top-6 left-1/2 -translate-x-1/2 text-white text-center bg-black/30 px-4 py-2 rounded-full backdrop-blur-sm">
        <p class="font-bold text-sm" id="active-call-name">Р вЂ”Р Р†Р С•Р Р…Р С•Р С”</p>
        <p class="text-xs opacity-60" id="call-timer">00:00</p>
        <div id="screen-share-indicator" class="hidden text-xs text-blue-300 mt-1">
            <i class="fas fa-desktop"></i> <span id="screen-share-user">Р С™РЎвЂљР С•-РЎвЂљР С•</span> Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚РЎС“Р ВµРЎвЂљ РЎРЊР С”РЎР‚Р В°Р Р…
            <button id="watch-screen-btn" class="ml-2 px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs transition-colors" onclick="toggleScreenWatch()">
                Р РЋР СР С•РЎвЂљРЎР‚Р ВµРЎвЂљРЎРЉ
            </button>
        </div>
    </div>
</div>

<!-- Р РЋР Р†РЎвЂРЎР‚Р Р…РЎС“РЎвЂљРЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С” (Р СР С‘Р Р…Р С‘-Р С—Р В»Р ВµР ВµРЎР‚) -->
<div id="minimized-call" class="call-minimized" style="display: none;">
    <div class="call-minimized-header" onclick="expandCall()">
        <div class="call-minimized-avatar" id="mini-call-avatar">?</div>
        <div class="call-minimized-info">
            <div class="call-minimized-name" id="mini-call-name">Р вЂ”Р Р†Р С•Р Р…Р С•Р С”</div>
            <div class="call-minimized-status">
                <span class="pulse-dot"></span>
                <span id="mini-call-timer">00:00</span>
            </div>
        </div>
    </div>
    <div class="call-minimized-actions">
        <button class="call-mini-btn call-mini-btn-expand" onclick="expandCall()">
            <i class="fas fa-expand-alt"></i> Р В Р В°Р В·Р Р†Р ВµРЎР‚Р Р…РЎС“РЎвЂљРЎРЉ
        </button>
        <button class="call-mini-btn call-mini-btn-end" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>
</div>

<!-- Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С•РЎвЂЎР Р…РЎвЂ№Р в„– РЎРЊР С”РЎР‚Р В°Р Р… -->
<div id="loading-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
    <!-- Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– РЎвЂћР С•Р Р… -->
    <div class="loading-bg-animation"></div>
    
    <!-- Р С›РЎРѓР Р…Р С•Р Р†Р Р…Р С•Р в„– Р С”Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљ -->
    <div class="relative z-10 flex flex-col items-center">
        <!-- Р вЂєР С•Р С–Р С•РЎвЂљР С‘Р С— РЎРѓ Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘Р ВµР в„– -->
        <div class="loading-logo-container">
            <div class="loading-logo">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="loading-ring loading-ring-1"></div>
            <div class="loading-ring loading-ring-2"></div>
            <div class="loading-ring loading-ring-3"></div>
        </div>
        
        <!-- Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ -->
        <div class="loading-title">FLICKERS</div>
        
        <!-- Р РЋР В»Р С•Р С–Р В°Р Р… -->
        <div class="loading-subtitle">
            <span class="loading-subtitle-text">Р вЂР В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р С”Р С‘ Р Р…Р В°Р С Р Р…Р Вµ РЎРѓРЎвЂљРЎР‚Р В°РЎв‚¬Р Р…РЎвЂ№! СЂСџС™Р‚</span>
        </div>
        
        <!-- Р СџРЎР‚Р С•Р С–РЎР‚Р ВµРЎРѓРЎРѓ-Р В±Р В°РЎР‚ -->
        <div class="loading-progress-container">
            <div class="loading-progress-bar"></div>
        </div>
        
        <!-- Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓ -->
        <div class="loading-status">Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В°...</div>
    </div>
</div>

<!-- Р В­Р С”РЎР‚Р В°Р Р… Р В°Р Р†РЎвЂљР С•РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘Р С‘ -->
<div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center hidden p-4 transition-colors duration-300">
    <!-- Р СџР ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР В°РЎвЂљР ВµР В»РЎРЉ РЎРЏР В·РЎвЂ№Р С”Р В° Р С‘ РЎвЂљР ВµР СРЎвЂ№ -->
    <div class="absolute top-4 right-4 flex gap-2">
        <button onclick="cycleAuthTheme()" id="auth-theme-btn" class="auth-lang-btn px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/20 transition-all text-sm font-medium" title="Р РЋР СР ВµР Р…Р С‘РЎвЂљРЎРЉ РЎвЂљР ВµР СРЎС“">
            РІВР‚РїС‘РЏ
        </button>
        <button onclick="setLanguage('ru')" class="auth-lang-btn px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/20 transition-all text-sm font-medium" data-lang="ru">RU</button>
        <button onclick="setLanguage('en')" class="auth-lang-btn px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/20 transition-all text-sm font-medium" data-lang="en">EN</button>
    </div>
    
    <div id="auth-card" class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center transform transition-all">
        <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-[2rem] flex items-center justify-center mx-auto text-4xl mb-2 animate-bounce">
            <i class="fas fa-bolt"></i>
        </div>
        <h1 id="auth-title" class="text-3xl font-black text-slate-800 mb-1 new-year-logo">
            FLICKERS
            <div class="garland">
                <div class="garland-wire"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
            </div>
            <div class="logo-snowflakes" id="auth-snowflakes"></div>
        </h1>
        <p class="text-indigo-500 text-sm font-medium mb-4" data-i18n="aiTagline">Р вЂР В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р С”Р С‘ Р Р…Р В°Р С Р Р…Р Вµ РЎРѓРЎвЂљРЎР‚Р В°РЎв‚¬Р Р…РЎвЂ№! СЂСџС™Р‚</p>
        
        <!-- Р вЂ™Р С”Р В»Р В°Р Т‘Р С”Р С‘ Р вЂ™РЎвЂ¦Р С•Р Т‘/Р В Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ -->
        <div class="flex mb-6 bg-slate-100 rounded-2xl p-1">
            <button id="tab-login" onclick="switchAuthTab('login')" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all bg-white shadow text-indigo-600">
                <i class="fas fa-sign-in-alt mr-2"></i><span data-i18n="loginTab">Р вЂ™РЎвЂ¦Р С•Р Т‘</span>
            </button>
            <button id="tab-register" onclick="switchAuthTab('register')" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all text-slate-500">
                <i class="fas fa-user-plus mr-2"></i><span data-i18n="registerTab">Р В Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ</span>
            </button>
        </div>
            
        <!-- Р В¤Р С•РЎР‚Р СР В° Р Р†РЎвЂ¦Р С•Р Т‘Р В° -->
        <div id="login-form">
            <h2 class="text-2xl font-black text-slate-800 mb-2" data-i18n="welcomeBack">Р РЋ Р Р†Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р ВµР Р…Р С‘Р ВµР С!</h2>
            <p class="text-slate-500 mb-6 text-sm" data-i18n="enterCredentials">Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р Т‘Р В»РЎРЏ Р Р†РЎвЂ¦Р С•Р Т‘Р В°</p>
            
            <input type="text" id="login-username" data-i18n-placeholder="username" placeholder="Р ВР СРЎРЏ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ" class="w-full p-4 bg-slate-100 rounded-2xl outline-none mb-3 focus:ring-2 focus:ring-indigo-500 transition-all">
            <input type="password" id="login-password" data-i18n-placeholder="password" placeholder="Р СџР В°РЎР‚Р С•Р В»РЎРЉ" class="w-full p-4 bg-slate-100 rounded-2xl outline-none mb-4 focus:ring-2 focus:ring-indigo-500 transition-all">
            
            <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
            
            <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg active:scale-95">
                <span data-i18n="loginBtn">Р вЂ™Р С•Р в„–РЎвЂљР С‘</span>
            </button>
        </div>
        
        <!-- Р В¤Р С•РЎР‚Р СР В° РЎР‚Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ -->
        <div id="register-form" class="hidden">
            <h2 class="text-2xl font-black text-slate-800 mb-2" data-i18n="createAccount">Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ</h2>
            <p class="text-slate-500 mb-6 text-sm" data-i18n="fillToRegister">Р вЂ”Р В°Р С—Р С•Р В»Р Р…Р С‘РЎвЂљР Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р Т‘Р В»РЎРЏ РЎР‚Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘</p>
            
            <input type="text" id="register-username" data-i18n-placeholder="username" placeholder="Р ВР СРЎРЏ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ" class="w-full p-4 bg-slate-100 rounded-2xl outline-none mb-3 focus:ring-2 focus:ring-indigo-500 transition-all">
            <input type="password" id="register-password" data-i18n-placeholder="password" placeholder="Р СџР В°РЎР‚Р С•Р В»РЎРЉ" class="w-full p-4 bg-slate-100 rounded-2xl outline-none mb-3 focus:ring-2 focus:ring-indigo-500 transition-all">
            <input type="password" id="register-password-confirm" data-i18n-placeholder="confirmPassword" placeholder="Р СџР С•Р Т‘РЎвЂљР Р†Р ВµРЎР‚Р Т‘Р С‘РЎвЂљР Вµ Р С—Р В°РЎР‚Р С•Р В»РЎРЉ" class="w-full p-4 bg-slate-100 rounded-2xl outline-none mb-4 focus:ring-2 focus:ring-indigo-500 transition-all">
            
            <p id="register-error" class="text-red-500 text-sm mb-4 hidden"></p>
            
            <button onclick="handleRegister()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg active:scale-95">
                <span data-i18n="registerBtn">Р вЂ”Р В°РЎР‚Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉРЎРѓРЎРЏ</span>
            </button>
        </div>
    </div>
</div>

<!-- Р С›РЎРѓР Р…Р С•Р Р†Р Р…Р С•Р Вµ Р С—РЎР‚Р С‘Р В»Р С•Р В¶Р ВµР Р…Р С‘Р Вµ -->
<div id="main-app" class="hidden h-full flex flex-col md:flex-row overflow-hidden">
    <!-- Р вЂР С•Р С”Р С•Р Р†Р В°РЎРЏ Р С—Р В°Р Р…Р ВµР В»РЎРЉ -->
    <aside id="sidebar" class="w-full md:w-80 glass-panel flex flex-col h-full z-20 border-r border-[var(--border)]" style="min-width: 280px; max-width: 500px;">
        <!-- Resize handle -->
        <div id="sidebar-resize" class="sidebar-resize-handle"></div>
        <div class="p-6 flex justify-between items-center border-b border-[var(--border)]">
            <span class="text-2xl font-black text-indigo-500 italic tracking-tighter new-year-logo" id="sidebar-logo">
                FLICKERS
                <div class="garland">
                    <div class="garland-wire"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                </div>
                <div class="logo-snowflakes" id="sidebar-snowflakes"></div>
            </span>
            <div class="flex items-center gap-1">
                <button onclick="openTasksPanel()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Р вЂ”Р В°Р Т‘Р В°РЎвЂЎР С‘">
                    <i class="fas fa-tasks text-xl"></i>
                </button>
                <button onclick="toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-4 relative">
            <div class="relative group">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                <input type="text" id="search-input" data-i18n-placeholder="searchNickname" placeholder="Р СџР С•Р С‘РЎРѓР С” Р Р…Р С‘Р С”Р В°..." class="w-full p-3 pl-10 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-indigo-500 transition-all" oninput="doNicknameSearch(this.value)">
            </div>
            <div id="nickname-search-results" class="absolute left-4 right-4 mt-2 glass-panel rounded-xl shadow-2xl z-50 hidden max-h-60 overflow-y-auto animate-panel-pop"></div>
        </div>
        
        <!-- Р ВРЎРѓРЎвЂљР С•РЎР‚Р С‘Р С‘/Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓРЎвЂ№ -->
        <div id="stories-container" class="stories-container">
            <div class="story-item" onclick="addMyStory()">
                <div class="story-avatar no-story relative">
                    <div class="story-avatar-inner" id="my-story-avatar">
                        <i class="fas fa-plus text-slate-400"></i>
                    </div>
                    <div class="story-add"><i class="fas fa-plus"></i></div>
                </div>
                <span class="story-name" data-i18n="myStory">Р СљР С•РЎРЏ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ</span>
            </div>
        </div>
        
        <!-- Р СџР В°Р С—Р С”Р С‘ РЎвЂЎР В°РЎвЂљР С•Р Р† -->
        <div id="chat-folders-bar" class="flex gap-1 px-4 py-2 overflow-x-auto border-b border-[var(--border)]">
            <button onclick="selectChatFolder('all')" class="chat-folder-btn active px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all" data-folder="all">
                <i class="fas fa-comments mr-1"></i> Р вЂ™РЎРѓР Вµ
            </button>
            <button onclick="selectChatFolder('personal')" class="chat-folder-btn px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all" data-folder="personal">
                <i class="fas fa-user mr-1"></i> Р вЂєР С‘РЎвЂЎР Р…РЎвЂ№Р Вµ
            </button>
            <button onclick="selectChatFolder('groups')" class="chat-folder-btn px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all" data-folder="groups">
                <i class="fas fa-users mr-1"></i> Р вЂњРЎР‚РЎС“Р С—Р С—РЎвЂ№
            </button>
            <button onclick="openFolderSettings()" class="chat-folder-btn px-3 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all" title="Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р С‘РЎвЂљРЎРЉ Р С—Р В°Р С—Р С”Р С‘">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto relative">
            <!-- Р С’РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ -->
            <div id="archived-chats-header" class="hidden px-4 pt-4">
                <button onclick="toggleArchivedChats()" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center gap-3 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">
                    <i class="fas fa-archive text-purple-500"></i>
                    <span class="font-bold text-sm">Р С’РЎР‚РЎвЂ¦Р С‘Р Р†</span>
                    <span id="archived-count" class="ml-auto text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full">0</span>
                    <i class="fas fa-chevron-down text-xs opacity-50" id="archived-chevron"></i>
                </button>
            </div>
            <div id="archived-chats-list" class="hidden px-4 pb-2 space-y-2"></div>
            
            <div id="chats-list" class="p-4 space-y-3 pb-24"></div>
            <div class="sticky bottom-4 right-4 flex flex-col gap-2 ml-auto mr-4 w-fit z-10">
                <button onclick="openCreateChannel()" class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white shadow-lg shadow-purple-500/30 flex items-center justify-center transition-all hover:scale-110" title="Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С”Р В°Р Р…Р В°Р В»">
                    <i class="fas fa-bullhorn text-lg"></i>
                </button>
                <button onclick="openCreateGroup()" class="w-12 h-12 rounded-full bg-indigo-500 hover:bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 flex items-center justify-center transition-all hover:scale-110" title="Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С–РЎР‚РЎС“Р С—Р С—РЎС“">
                    <i class="fas fa-plus text-lg"></i>
                </button>
            </div>
        </div>
        <div class="p-4 border-t border-[var(--border)] flex items-center space-x-3 bg-slate-50/50 dark:bg-slate-900/50">
            <div class="p-1">
                <div id="my-avatar" class="w-12 h-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center font-bold text-xl shadow-lg shadow-indigo-500/20">?</div>
            </div>
            <div class="flex-1 min-w-0">
                <p class="font-bold text-sm truncate" id="my-name">Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В°...</p>
                <p class="text-[10px] text-green-500 font-bold uppercase tracking-wider" data-i18n="online">Р вЂ™ РЎРѓР ВµРЎвЂљР С‘</p>
            </div>
            <div class="rubies-display" onclick="openRubyShop()" title="Р СљР В°Р С–Р В°Р В·Р С‘Р Р… РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†">
                <i class="fas fa-gem"></i>
                <span id="rubies-count">0.00</span>
            </div>
        </div>
    </aside>

    <!-- Р С›Р С”Р Р…Р С• РЎвЂЎР В°РЎвЂљР В° -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <div id="chat-placeholder" class="flex-1 flex flex-col items-center justify-center text-slate-400 opacity-20 animate-pulse">
            <i class="fas fa-bolt text-9xl mb-4"></i>
            <p class="font-black uppercase tracking-[0.4em]" data-i18n="selectContact">Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С”Р С•Р Р…РЎвЂљР В°Р С”РЎвЂљ</p>
        </div>

        <div id="active-chat" class="hidden flex-1 flex flex-col h-full">
            <header class="p-4 border-b border-[var(--border)] glass-panel flex items-center justify-between z-10">
                <div class="flex items-center space-x-3">
                    <!-- Р С™Р Р…Р С•Р С—Р С”Р В° Р Р…Р В°Р В·Р В°Р Т‘ Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ -->
                    <button onclick="mobileGoBack()" class="mobile-back-btn hidden w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors items-center justify-center -ml-2">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="relative cursor-pointer" oncontextmenu="event.preventDefault(); openPartnerProfile();" onclick="openPartnerProfile();">
                        <div id="target-avatar" class="w-10 h-10 rounded-xl bg-indigo-100 text-indigo-500 flex items-center justify-center font-bold">?</div>
                        <div id="online-indicator" class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-gray-400 rounded-full border-2 border-white dark:border-slate-900 hidden"></div>
                    </div>
                    <div>
                        <p id="target-name" class="font-bold">Р В§Р В°РЎвЂљ</p>
                        <p id="online-status" class="text-[10px] text-slate-400"></p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="openGiftRubies()" class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-red-500" title="Р СџР С•Р Т‘Р В°РЎР‚Р С‘РЎвЂљРЎРЉ РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№"><i class="fas fa-gem"></i></button>
                    <button onclick="startCall(false)" class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Р С’РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С•Р С”"><i class="fas fa-phone-alt"></i></button>
                    <button onclick="startCall(true)" class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Р вЂ™Р С‘Р Т‘Р ВµР С• Р В·Р Р†Р С•Р Р…Р С•Р С”"><i class="fas fa-video"></i></button>
                    <div class="relative">
                        <button onclick="toggleChatMenu()" class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><i class="fas fa-ellipsis-v"></i></button>
                        <div id="chat-menu" class="hidden absolute right-0 top-12 w-56 rounded-2xl shadow-xl overflow-hidden z-50 chat-menu-blur">
                            <button onclick="searchInChat()" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-[var(--bg-secondary)] transition-colors text-left">
                                <i class="fas fa-search text-indigo-500 w-5"></i>
                                <span data-i18n="searchInChat">Р СџР С•Р С‘РЎРѓР С” Р Р† РЎвЂЎР В°РЎвЂљР Вµ</span>
                            </button>
                            <button onclick="showChatMedia()" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-[var(--bg-secondary)] transition-colors text-left">
                                <i class="fas fa-images text-indigo-500 w-5"></i>
                                <span data-i18n="mediaFiles">Р СљР ВµР Т‘Р С‘Р В°РЎвЂћР В°Р в„–Р В»РЎвЂ№</span>
                            </button>
                            <button onclick="toggleBookmarks()" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-[var(--bg-secondary)] transition-colors text-left">
                                <i class="fas fa-bookmark text-yellow-500 w-5"></i>
                                <span data-i18n="bookmarks">Р вЂ”Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘</span>
                            </button>
                            <button onclick="toggleNotes()" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-[var(--bg-secondary)] transition-colors text-left">
                                <i class="fas fa-sticky-note text-orange-500 w-5"></i>
                                <span>Р вЂ”Р В°Р СР ВµРЎвЂљР С”Р С‘</span>
                            </button>
                            <button onclick="toggleSearchPanel()" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-[var(--bg-secondary)] transition-colors text-left">
                                <i class="fas fa-search-plus text-blue-500 w-5"></i>
                                <span>Р В Р В°РЎРѓРЎв‚¬Р С‘РЎР‚Р ВµР Р…Р Р…РЎвЂ№Р в„– Р С—Р С•Р С‘РЎРѓР С”</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ -->
            <div id="pinned-message-bar" class="pinned-message-bar hidden" onclick="scrollToPinnedMessage()">
                <i class="fas fa-thumbtack"></i>
                <div class="pinned-message-content">
                    <div class="pinned-message-label">Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ</div>
                    <div id="pinned-message-text" class="pinned-message-text"></div>
                </div>
                <button onclick="event.stopPropagation(); unpinMessage()" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <div id="messages-container" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>

            <!-- Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ Р Р…Р В° Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ -->
            <div id="chat-request-banner" class="hidden p-4 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 border-t border-indigo-500/20">
                <div class="flex items-center justify-between max-w-2xl mx-auto">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user-plus text-indigo-500 text-xl"></i>
                        <div>
                            <p class="font-bold text-sm" data-i18n="chatRequest">Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ Р Р…Р В° Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ</p>
                            <p class="text-xs opacity-60" data-i18n="chatRequestDesc">Р В­РЎвЂљР С•РЎвЂљ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎвЂ¦Р С•РЎвЂЎР ВµРЎвЂљ Р Р…Р В°РЎвЂЎР В°РЎвЂљРЎРЉ РЎРѓ Р Р†Р В°Р СР С‘ РЎвЂЎР В°РЎвЂљ</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="declineChatRequest()" class="px-4 py-2 rounded-xl bg-red-500/10 hover:bg-red-500/20 text-red-500 text-sm font-bold transition-colors">
                            <i class="fas fa-times mr-1"></i>
                            <span data-i18n="declineRequest">Р С›РЎвЂљР С”Р В»Р С•Р Р…Р С‘РЎвЂљРЎРЉ</span>
                        </button>
                        <button onclick="acceptChatRequest()" class="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-bold transition-colors">
                            <i class="fas fa-check mr-1"></i>
                            <span data-i18n="acceptRequest">Р СџРЎР‚Р С‘Р Р…РЎРЏРЎвЂљРЎРЉ</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Р С›Р В¶Р С‘Р Т‘Р В°Р Р…Р С‘Р Вµ Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљР С‘РЎРЏ Р В·Р В°Р С—РЎР‚Р С•РЎРѓР В° -->
            <div id="chat-pending-banner" class="hidden p-4 bg-gradient-to-r from-orange-500/10 to-yellow-500/10 border-t border-orange-500/20">
                <div class="flex items-center justify-center gap-3">
                    <i class="fas fa-clock text-orange-500 animate-pulse"></i>
                    <p class="text-sm" data-i18n="waitingAccept">Р С›Р В¶Р С‘Р Т‘Р В°Р Р…Р С‘Р Вµ Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљР С‘РЎРЏ Р В·Р В°Р С—РЎР‚Р С•РЎРѓР В°...</p>
                </div>
            </div>

            <footer id="chat-footer" class="p-4 border-t border-[var(--border)] glass-panel relative z-10">
                <div id="emoji-panel" class="emoji-panel glass-panel">
                    <div class="emoji-tabs" id="emoji-tabs"></div>
                    <div class="emoji-search">
                        <input type="text" id="emoji-search-input" data-i18n-placeholder="searchEmoji" placeholder="Р СџР С•Р С‘РЎРѓР С” РЎРЊР СР С•Р Т‘Р В·Р С‘...">
                    </div>
                    <div class="emoji-content" id="emoji-content"></div>
                </div>

                <div id="upload-status" class="hidden px-4 py-3 bg-indigo-500/10 rounded-xl mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-indigo-500 italic">Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° РЎвЂћР В°Р в„–Р В»Р В° (100MB Р СР В°Р С”РЎРѓ)...</span>
                        <span id="p-percent" class="text-[10px] font-bold text-indigo-500">0%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div>
                </div>

                <!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ -->
                <div id="reply-panel" class="reply-panel hidden max-w-5xl mx-auto mb-2 rounded-xl">
                    <i class="fas fa-reply text-indigo-500"></i>
                    <div class="reply-panel-content">
                        <div id="reply-panel-author" class="reply-panel-author"></div>
                        <div id="reply-panel-text" class="reply-panel-text"></div>
                    </div>
                    <button onclick="cancelReply()" class="w-8 h-8 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-slate-400"></i>
                    </button>
                </div>

                <div class="max-w-5xl mx-auto flex items-center space-x-2">
                    <!-- Р СџР В»РЎР‹РЎРѓ-Р СР ВµР Р…РЎР‹ -->
                    <div class="plus-menu-container">
                        <button class="plus-menu-btn" id="plus-menu-btn" onclick="togglePlusMenu()">
                            <i class="fas fa-plus"></i>
                        </button>
                        <div class="plus-menu" id="plus-menu">
                            <div class="plus-menu-item file-item" onclick="triggerFile(); togglePlusMenu();">
                                <i class="fas fa-paperclip"></i>
                                <span>Р В¤Р В°Р в„–Р В»</span>
                            </div>
                            <div class="plus-menu-item location-item" onclick="sendLocation(); togglePlusMenu();">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Р вЂњР ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘РЎРЏ</span>
                            </div>
                            <div class="plus-menu-item event-item" onclick="openEventModal(); togglePlusMenu();">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Р СљР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘Р Вµ</span>
                            </div>
                            <div class="plus-menu-item poll-item" onclick="openPollModal(); togglePlusMenu();">
                                <i class="fas fa-poll"></i>
                                <span>Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘Р Вµ</span>
                            </div>
                            <div class="plus-menu-item game-item" onclick="inviteToGame(); togglePlusMenu();">
                                <i class="fas fa-gamepad"></i>
                                <span>Р С™РЎР‚Р ВµРЎРѓРЎвЂљР С‘Р С”Р С‘-Р Р…Р С•Р В»Р С‘Р С”Р С‘</span>
                            </div>
                            <div class="plus-menu-item ai-item" onclick="toggleAI(); togglePlusMenu();">
                                <i class="fas fa-robot"></i>
                                <span>AI Р С’РЎРѓРЎРѓР С‘РЎРѓРЎвЂљР ВµР Р…РЎвЂљ</span>
                            </div>
                            <div class="plus-menu-item schedule-item" onclick="openScheduleModal(); togglePlusMenu();" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                                <i class="fas fa-clock"></i>
                                <span>Р вЂ”Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ</span>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="file-input" class="hidden" onchange="handleFile(this)">

                    <!-- Telegram-style input area (mobile) -->
                    <div class="tg-input-row" style="position: relative;">
                        <!-- Emoji button left -->
                        <button onclick="toggleEmoji()" class="tg-emoji-btn-left">
                            <i class="far fa-smile"></i>
                        </button>
                        
                        <!-- Stickers/GIF button -->
                        <button onclick="toggleStickers()" class="tg-emoji-btn-left" style="margin-left: -8px;">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                        
                        <!-- Input field -->
                        <div class="tg-input-center" id="tg-input-center">
                            <textarea id="msg-input" data-i18n-placeholder="writeMessage" placeholder="Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ" class="tg-message-input" rows="1" oninput="autoResizeTextarea(this); syncInputs(this); handleInputChange(); if(typeof onTyping==='function')onTyping()" onkeydown="if(event.key==='Enter' && !event.shiftKey){sendMsg(); event.preventDefault();}"></textarea>
                        </div>
                        
                        <!-- Mobile voice recording UI - fixed overlay -->
                        <div id="mobile-voice-ui" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; height: 64px; align-items: center; gap: 12px; background: var(--bg-card); border-top: 2px solid #ef4444; padding: 10px 16px; z-index: 9999;">
                            <div style="width: 14px; height: 14px; background: #ef4444; border-radius: 50%; animation: recording-pulse 1.5s infinite; flex-shrink: 0;"></div>
                            <div class="voice-waveform" style="display: flex; gap: 3px; align-items: center;">
                                <span></span><span></span><span></span><span></span><span></span>
                            </div>
                            <span id="mobile-voice-timer" class="font-mono font-bold" style="color: #ef4444; font-size: 18px; flex: 1;">0:00</span>
                            <button onclick="cancelVoice()" style="color: #ef4444; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(239,68,68,0.15); border-radius: 50%; border: none; font-size: 18px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <!-- Right buttons -->
                        <button onclick="openMobileAttachMenu()" class="tg-attach-btn" id="tg-attach-btn">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        
                        <!-- Voice/Send button -->
                        <button id="tg-voice-btn" ontouchstart="startVoice()" ontouchend="stopVoice()" onmousedown="startVoice()" onmouseup="stopVoice()" class="tg-mic-btn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button id="tg-send-btn-right" onclick="sendMsg()" class="tg-send-btn-right hidden">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Mobile attach menu Р В±РЎС“Р Т‘Р ВµРЎвЂљ РЎРѓР С•Р В·Р Т‘Р В°Р Р†Р В°РЎвЂљРЎРЉРЎРѓРЎРЏ Р Т‘Р С‘Р Р…Р В°Р СР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ Р Р† JS -->

                    <div class="flex-1 relative tg-panels-container" id="input-container">
                        <!-- Desktop input (hidden on mobile) -->
                        <input type="text" id="msg-input-desktop" data-i18n-placeholder="writeMessage" placeholder="Р СњР В°Р С—Р С‘РЎв‚¬Р С‘РЎвЂљР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ..." class="desktop-msg-input w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all border border-transparent" oninput="syncInputs(this); handleInputChange(); if(typeof onTyping==='function')onTyping()">
                        
                        <!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ Р В±РЎвЂ№РЎРѓРЎвЂљРЎР‚РЎвЂ№РЎвЂ¦ Р С•РЎвЂљР Р†Р ВµРЎвЂљР С•Р Р† -->
                        <div id="quick-replies-panel" class="quick-replies-panel">
                            <div class="quick-reply-item" onclick="useQuickReply('СЂСџвЂвЂ№ Р СџРЎР‚Р С‘Р Р†Р ВµРЎвЂљ!')">
                                <span class="emoji">СЂСџвЂвЂ№</span> Р СџРЎР‚Р С‘Р Р†Р ВµРЎвЂљ!
                            </div>
                            <div class="quick-reply-item" onclick="useQuickReply('СЂСџвЂРЊ Р ТђР С•РЎР‚Р С•РЎв‚¬Р С•, Р Т‘Р С•Р С–Р С•Р Р†Р С•РЎР‚Р С‘Р В»Р С‘РЎРѓРЎРЉ!')">
                                <span class="emoji">СЂСџвЂРЊ</span> Р ТђР С•РЎР‚Р С•РЎв‚¬Р С•, Р Т‘Р С•Р С–Р С•Р Р†Р С•РЎР‚Р С‘Р В»Р С‘РЎРѓРЎРЉ!
                            </div>
                            <div class="quick-reply-item" onclick="useQuickReply('РІРЏВ° Р СљР С‘Р Р…РЎС“РЎвЂљР С”РЎС“, РЎРѓР С”Р С•РЎР‚Р С• Р С•РЎвЂљР Р†Р ВµРЎвЂЎРЎС“')">
                                <span class="emoji">РІРЏВ°</span> Р СљР С‘Р Р…РЎС“РЎвЂљР С”РЎС“, РЎРѓР С”Р С•РЎР‚Р С• Р С•РЎвЂљР Р†Р ВµРЎвЂЎРЎС“
                            </div>
                            <div class="quick-reply-item" onclick="useQuickReply('СЂСџВР‰ Р РЋР С—Р В°РЎРѓР С‘Р В±Р С•!')">
                                <span class="emoji">СЂСџВР‰</span> Р РЋР С—Р В°РЎРѓР С‘Р В±Р С•!
                            </div>
                            <div class="quick-reply-item" onclick="useQuickReply('СЂСџВ¤вЂќ Р вЂќР В°Р в„– Р С—Р С•Р Т‘РЎС“Р СР В°РЎвЂљРЎРЉ...')">
                                <span class="emoji">СЂСџВ¤вЂќ</span> Р вЂќР В°Р в„– Р С—Р С•Р Т‘РЎС“Р СР В°РЎвЂљРЎРЉ...
                            </div>
                            <div class="quick-reply-item" onclick="useQuickReply('СЂСџвЂР‚ Р РЋР ВµР в„–РЎвЂЎР В°РЎРѓ Р С—Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎР‹')">
                                <span class="emoji">СЂСџвЂР‚</span> Р РЋР ВµР в„–РЎвЂЎР В°РЎРѓ Р С—Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎР‹
                            </div>
                            <div class="quick-reply-item" onclick="useQuickReply('РІСњВ¤РїС‘РЏ Р вЂєРЎР‹Р В±Р В»РЎР‹ РЎвЂљР ВµР В±РЎРЏ!')">
                                <span class="emoji">РІСњВ¤РїС‘РЏ</span> Р вЂєРЎР‹Р В±Р В»РЎР‹ РЎвЂљР ВµР В±РЎРЏ!
                            </div>
                            <div class="quick-reply-item" onclick="useQuickReply('СЂСџВвЂљ Р С’РЎвЂ¦Р В°РЎвЂ¦Р В°РЎвЂ¦')">
                                <span class="emoji">СЂСџВвЂљ</span> Р С’РЎвЂ¦Р В°РЎвЂ¦Р В°РЎвЂ¦
                            </div>
                        </div>
                        
                        <!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ РЎРѓРЎвЂљР С‘Р С”Р ВµРЎР‚Р С•Р Р† Р С‘ GIF -->
                        <div id="sticker-panel" class="sticker-panel glass-panel">
                            <div class="sticker-tabs">
                                <div class="sticker-tab active" onclick="switchStickerTab('stickers')">СЂСџР‹РЃ Р РЋРЎвЂљР С‘Р С”Р ВµРЎР‚РЎвЂ№</div>
                                <div class="sticker-tab" onclick="switchStickerTab('gif')">СЂСџР‹В¬ GIF</div>
                            </div>
                            <div class="sticker-search">
                                <input type="text" id="sticker-search-input" placeholder="Р СџР С•Р С‘РЎРѓР С”..." oninput="searchStickersOrGif(this.value)">
                            </div>
                            <div class="sticker-content" id="sticker-content"></div>
                        </div>
                        
                        <!-- AI Р С—Р В°Р Р…Р ВµР В»РЎРЉ -->
                        <div id="ai-panel" class="ai-panel hidden">
                            <div class="p-4 border-b border-[var(--border)] flex items-center gap-3">
                                <i class="fas fa-robot text-orange-500 text-xl"></i>
                                <div>
                                    <p class="font-bold text-sm">AI Assistant</p>
                                    <p class="text-[10px] opacity-50">Powered by Groq (Llama)</p>
                                </div>
                            </div>
                            <div id="ai-options">
                                <div class="ai-btn-option" onclick="aiGenerateReply()">
                                    <i class="fas fa-reply"></i>
                                    <span data-i18n="aiGenerateReply">Р РЋР С–Р ВµР Р…Р ВµРЎР‚Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р С•РЎвЂљР Р†Р ВµРЎвЂљ</span>
                                </div>
                                <div class="ai-btn-option" onclick="aiImproveText()">
                                    <i class="fas fa-magic"></i>
                                    <span data-i18n="aiImproveText">Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р С‘РЎвЂљРЎРЉ РЎвЂљР ВµР С”РЎРѓРЎвЂљ</span>
                                </div>
                                <div class="ai-btn-option" onclick="aiSummarize()">
                                    <i class="fas fa-compress-alt"></i>
                                    <span data-i18n="aiSummarize">Р РЋРЎС“Р СР СР С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ РЎР‚Р В°Р В·Р С–Р С•Р Р†Р С•РЎР‚</span>
                                </div>
                                <div class="ai-btn-option" onclick="aiTranslate()">
                                    <i class="fas fa-language"></i>
                                    <span data-i18n="aiTranslate">Р СџР ВµРЎР‚Р ВµР Р†Р ВµРЎРѓРЎвЂљР С‘</span>
                                </div>
                            </div>
                            <div id="ai-loading" class="ai-loading hidden">
                                <i class="fas fa-spinner"></i>
                                <span data-i18n="aiThinking">AI Р Т‘РЎС“Р СР В°Р ВµРЎвЂљ...</span>
                            </div>
                            <div id="ai-result" class="ai-result hidden"></div>
                            <div id="ai-result-actions" class="ai-result-actions hidden">
                                <button onclick="aiUseResult()" class="ai-result-btn bg-purple-500 text-white hover:bg-purple-600" data-i18n="aiUse">Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљРЎРЉ</button>
                                <button onclick="aiCopyResult()" class="ai-result-btn bg-slate-200 dark:bg-slate-700 hover:bg-slate-300" data-i18n="aiCopy">Р С™Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ</button>
                            </div>
                        </div>
                        
                        <!-- UI Р В·Р В°Р С—Р С‘РЎРѓР С‘ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р С–Р С• (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—) -->
                        <div id="voice-recording-ui" class="voice-recording-ui hidden absolute inset-0 desktop-only-voice">
                            <div class="recording-indicator"></div>
                            <div class="voice-waveform">
                                <span></span><span></span><span></span><span></span><span></span>
                            </div>
                            <span id="voice-timer" class="text-sm font-mono font-bold">0:00</span>
                            <button onclick="cancelVoice()" class="ml-auto text-red-500 hover:bg-red-50 w-8 h-8 rounded-full flex items-center justify-center">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Desktop buttons (hidden on mobile) -->
                    <div class="desktop-input-btns">
                        <button onclick="openVideoCircle()" class="video-circle-btn w-12 h-12 flex items-center justify-center text-slate-400 hover:text-purple-500 hover:bg-purple-50 rounded-xl transition-all" title="Р вЂ™Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С•Р С”">
                            <i class="fas fa-circle text-xl"></i>
                        </button>

                        <button id="voice-btn" onmousedown="startVoice()" onmouseup="stopVoice()" ontouchstart="startVoice()" ontouchend="stopVoice()" class="voice-btn w-12 h-12 flex items-center justify-center text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-xl transition-all">
                            <i class="fas fa-microphone text-xl"></i>
                        </button>

                        <button onclick="sendMsg()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center hover:bg-indigo-700 shadow-xl active:scale-90 transition-all">
                            <i class="fas fa-paper-plane text-xl"></i>
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </main>

    <!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ Р В·Р В°Р Т‘Р В°РЎвЂЎ -->
    <div id="tasks-panel" class="fixed inset-y-0 right-0 w-96 max-w-full glass-panel shadow-[-20px_0_50px_rgba(0,0,0,0.1)] z-50 overflow-hidden hidden flex flex-col">
        <div class="p-6 border-b border-[var(--border)] flex justify-between items-center">
            <h3 class="text-xl font-black flex items-center gap-2">
                <i class="fas fa-tasks text-indigo-500"></i> Р вЂ”Р В°Р Т‘Р В°РЎвЂЎР С‘
            </h3>
            <button onclick="closeTasksPanel()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-50 hover:text-red-500 transition-all">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Р вЂќР С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘ -->
        <div class="p-4 border-b border-[var(--border)]">
            <div class="flex gap-2">
                <input type="text" id="new-task-input" placeholder="Р СњР С•Р Р†Р В°РЎРЏ Р В·Р В°Р Т‘Р В°РЎвЂЎР В°..." class="flex-1 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-indigo-500 transition-all" onkeypress="if(event.key==='Enter')addTask()">
                <button onclick="addTask()" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-bold transition-colors">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        
        <!-- Р В¤Р С‘Р В»РЎРЉРЎвЂљРЎР‚РЎвЂ№ -->
        <div class="p-4 border-b border-[var(--border)] flex gap-2">
            <button onclick="filterTasks('all')" class="task-filter-btn active flex-1 py-2 px-3 rounded-xl text-xs font-bold transition-all" data-filter="all">
                Р вЂ™РЎРѓР Вµ
            </button>
            <button onclick="filterTasks('active')" class="task-filter-btn flex-1 py-2 px-3 rounded-xl text-xs font-bold transition-all" data-filter="active">
                Р С’Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р Вµ
            </button>
            <button onclick="filterTasks('completed')" class="task-filter-btn flex-1 py-2 px-3 rounded-xl text-xs font-bold transition-all" data-filter="completed">
                Р вЂ™РЎвЂ№Р С—Р С•Р В»Р Р…Р ВµР Р…Р Р…РЎвЂ№Р Вµ
            </button>
        </div>
        
        <!-- Р РЋР С—Р С‘РЎРѓР С•Р С” Р В·Р В°Р Т‘Р В°РЎвЂЎ -->
        <div id="tasks-list" class="flex-1 overflow-y-auto p-4 space-y-2">
            <div class="text-center opacity-50 py-8">
                <i class="fas fa-clipboard-list text-4xl mb-2"></i>
                <p class="text-sm">Р СњР ВµРЎвЂљ Р В·Р В°Р Т‘Р В°РЎвЂЎ</p>
            </div>
        </div>
        
        <!-- Р РЋРЎвЂљР В°РЎвЂљР С‘РЎРѓРЎвЂљР С‘Р С”Р В° -->
        <div class="p-4 border-t border-[var(--border)] text-xs opacity-70 flex justify-between">
            <span id="tasks-stats">0 Р В·Р В°Р Т‘Р В°РЎвЂЎ</span>
            <button onclick="clearCompletedTasks()" class="text-red-500 hover:underline">Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р Р†РЎвЂ№Р С—Р С•Р В»Р Р…Р ВµР Р…Р Р…РЎвЂ№Р Вµ</button>
        </div>
    </div>

    <!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р С—Р В°Р С—Р С•Р С” -->
    <div id="folders-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-primary)] rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-[var(--border)] flex justify-between items-center">
                <h3 class="text-xl font-black flex items-center gap-2">
                    <i class="fas fa-folder text-indigo-500"></i> Р СџР В°Р С—Р С”Р С‘ РЎвЂЎР В°РЎвЂљР С•Р Р†
                </h3>
                <button onclick="closeFolderSettings()" class="w-10 h-10 rounded-full hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-96 overflow-y-auto">
                <div id="custom-folders-list" class="space-y-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-folder-name" placeholder="Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р С—Р В°Р С—Р С”Р С‘..." class="flex-1 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm">
                    <button onclick="createCustomFolder()" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-bold transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 border-t border-[var(--border)] text-xs opacity-50 text-center">
                Р СџР ВµРЎР‚Р ВµРЎвЂљР В°РЎвЂ°Р С‘РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ Р Р† Р С—Р В°Р С—Р С”Р С‘ РЎвЂЎР ВµРЎР‚Р ВµР В· Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹
            </div>
        </div>
    </div>

    <!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р В·Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ -->
    <div id="schedule-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-primary)] rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-[var(--border)] flex justify-between items-center">
                <h3 class="text-xl font-black flex items-center gap-2">
                    <i class="fas fa-clock text-orange-500"></i> Р вЂ”Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ
                </h3>
                <button onclick="closeScheduleModal()" class="w-10 h-10 rounded-full hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold opacity-50 mb-2 block">Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ</label>
                    <textarea id="scheduled-message-text" placeholder="Р СћР ВµР С”РЎРѓРЎвЂљ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ..." class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm resize-none h-24"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold opacity-50 mb-2 block">Р вЂќР В°РЎвЂљР В°</label>
                        <input type="date" id="schedule-date" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold opacity-50 mb-2 block">Р вЂ™РЎР‚Р ВµР СРЎРЏ</label>
                        <input type="time" id="schedule-time" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeScheduleModal()" class="flex-1 p-3 bg-slate-200 dark:bg-slate-700 rounded-xl font-bold transition-colors">
                        Р С›РЎвЂљР СР ВµР Р…Р В°
                    </button>
                    <button onclick="confirmScheduleMessage()" class="flex-1 p-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold transition-colors">
                        <i class="fas fa-clock mr-2"></i>Р вЂ”Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ
                    </button>
                </div>
            </div>
            <div id="scheduled-messages-list" class="border-t border-[var(--border)] max-h-48 overflow-y-auto hidden">
                <div class="p-4 text-xs font-bold opacity-50">Р вЂ”Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ</div>
            </div>
        </div>
    </div>

    <!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ Р СР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘РЎРЏ -->
    <div id="event-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-primary)] rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-[var(--border)] flex justify-between items-center bg-gradient-to-r from-pink-500 to-purple-500 text-white">
                <h3 class="text-xl font-black flex items-center gap-2">
                    <i class="fas fa-calendar-alt"></i> Р СњР С•Р Р†Р С•Р Вµ Р СР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘Р Вµ
                </h3>
                <button onclick="closeEventModal()" class="w-10 h-10 rounded-full hover:bg-white/20 flex items-center justify-center transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold opacity-50 mb-2 block">Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р СР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘РЎРЏ</label>
                    <input type="text" id="event-title" placeholder="Р вЂќР ВµР Р…РЎРЉ РЎР‚Р С•Р В¶Р Т‘Р ВµР Р…Р С‘РЎРЏ, Р Р†РЎРѓРЎвЂљРЎР‚Р ВµРЎвЂЎР В°..." class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold opacity-50 mb-2 block">Р вЂќР В°РЎвЂљР В°</label>
                        <input type="date" id="event-date" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold opacity-50 mb-2 block">Р вЂ™РЎР‚Р ВµР СРЎРЏ</label>
                        <input type="time" id="event-time" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold opacity-50 mb-2 block">Р СљР ВµРЎРѓРЎвЂљР С• (Р Р…Р ВµР С•Р В±РЎРЏР В·Р В°РЎвЂљР ВµР В»РЎРЉР Р…Р С•)</label>
                    <input type="text" id="event-location" placeholder="Р С’Р Т‘РЎР‚Р ВµРЎРѓ Р С‘Р В»Р С‘ Р Р…Р В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р СР ВµРЎРѓРЎвЂљР В°" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold opacity-50 mb-2 block">Р С›Р С—Р С‘РЎРѓР В°Р Р…Р С‘Р Вµ (Р Р…Р ВµР С•Р В±РЎРЏР В·Р В°РЎвЂљР ВµР В»РЎРЉР Р…Р С•)</label>
                    <textarea id="event-description" placeholder="Р СџР С•Р Т‘РЎР‚Р С•Р В±Р Р…Р С•РЎРѓРЎвЂљР С‘ Р СР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘РЎРЏ..." class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm resize-none h-20"></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeEventModal()" class="flex-1 p-3 bg-slate-200 dark:bg-slate-700 rounded-xl font-bold transition-colors">
                        Р С›РЎвЂљР СР ВµР Р…Р В°
                    </button>
                    <button onclick="createEvent()" class="flex-1 p-3 bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white rounded-xl font-bold transition-colors">
                        <i class="fas fa-calendar-plus mr-2"></i>Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Р СџР В°Р Р…Р ВµР В»РЎРЉ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С” (Discord-style) -->
    <div id="settings-panel" class="fixed inset-0 z-50 hidden">
        <div class="flex h-full">
            <!-- Р вЂР С•Р С”Р С•Р Р†Р С•Р Вµ Р СР ВµР Р…РЎР‹ Р С”Р В°РЎвЂљР ВµР С–Р С•РЎР‚Р С‘Р в„– -->
            <div class="settings-sidebar">
                <div class="settings-sidebar-header">
                    <h3 class="text-lg font-bold">Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘</h3>
                </div>
                
                <div class="settings-categories">
                    <!-- Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉРЎРѓР С”Р С‘Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ -->
                    <div class="settings-category-group">
                        <p class="settings-category-title">Р СџР С›Р вЂєР В¬Р вЂ”Р С›Р вЂ™Р С’Р СћР вЂўР вЂєР В¬</p>
                        <button class="settings-category-btn active" data-category="profile">
                            <i class="fas fa-user"></i>
                            <span>Р СљР С•Р в„– Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ</span>
                        </button>
                        <button class="settings-category-btn" data-category="account">
                            <i class="fas fa-id-card"></i>
                            <span>Р С’Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ</span>
                        </button>
                        <button class="settings-category-btn" data-category="privacy">
                            <i class="fas fa-shield-alt"></i>
                            <span>Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…Р С•РЎРѓРЎвЂљРЎРЉ</span>
                        </button>
                    </div>
                    
                    <!-- Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р С—РЎР‚Р С‘Р В»Р С•Р В¶Р ВµР Р…Р С‘РЎРЏ -->
                    <div class="settings-category-group">
                        <p class="settings-category-title">Р СџР В Р ВР вЂєР С›Р вЂ“Р вЂўР СњР ВР вЂў</p>
                        <button class="settings-category-btn" data-category="appearance">
                            <i class="fas fa-palette"></i>
                            <span>Р вЂ™Р Р…Р ВµРЎв‚¬Р Р…Р С‘Р в„– Р Р†Р С‘Р Т‘</span>
                        </button>
                        <button class="settings-category-btn" data-category="chat">
                            <i class="fas fa-comments"></i>
                            <span>Р В§Р В°РЎвЂљ</span>
                        </button>
                        <button class="settings-category-btn" data-category="notifications">
                            <i class="fas fa-bell"></i>
                            <span>Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ</span>
                        </button>
                        <button class="settings-category-btn" data-category="language">
                            <i class="fas fa-globe"></i>
                            <span>Р Р‡Р В·РЎвЂ№Р С”</span>
                        </button>
                    </div>
                    
                    <!-- Р вЂќР С•Р С—Р С•Р В»Р Р…Р С‘РЎвЂљР ВµР В»РЎРЉР Р…Р С• -->
                    <div class="settings-category-group">
                        <p class="settings-category-title">Р вЂќР С›Р СџР С›Р вЂєР СњР ВР СћР вЂўР вЂєР В¬Р СњР С›</p>
                        <button class="settings-category-btn" data-category="premium">
                            <i class="fas fa-crown"></i>
                            <span>Premium</span>
                        </button>
                        <button class="settings-category-btn" data-category="shop">
                            <i class="fas fa-shopping-bag"></i>
                            <span>Р СљР В°Р С–Р В°Р В·Р С‘Р Р…</span>
                        </button>
                        <button class="settings-category-btn" data-category="advanced">
                            <i class="fas fa-cog"></i>
                            <span>Р В Р В°РЎРѓРЎв‚¬Р С‘РЎР‚Р ВµР Р…Р Р…РЎвЂ№Р Вµ</span>
                        </button>
                    </div>
                </div>
                
                <div class="settings-sidebar-footer">
                    <button onclick="handleLogout()" class="settings-logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Р вЂ™РЎвЂ№Р в„–РЎвЂљР С‘</span>
                    </button>
                </div>
            </div>
            
            <!-- Р С™Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С” -->
            <div class="settings-content">
                <button onclick="toggleSettings()" class="settings-close-btn">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="settings-content-inner" id="settings-content-container">
                    <!-- Р С™Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљ Р В±РЎС“Р Т‘Р ВµРЎвЂљ Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°РЎвЂљРЎРЉРЎРѓРЎРЏ Р Т‘Р С‘Р Р…Р В°Р СР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Р С’Р Т‘Р СР С‘Р Р…-Р С—Р В°Р Р…Р ВµР В»РЎРЉ -->
    <div id="admin-panel" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-4xl max-h-[80vh] overflow-hidden flex">
            <!-- Р С›РЎРѓР Р…Р С•Р Р†Р Р…Р В°РЎРЏ РЎвЂЎР В°РЎРѓРЎвЂљРЎРЉ Р В°Р Т‘Р СР С‘Р Р…Р С”Р С‘ -->
            <div class="flex-1 flex flex-col">
                <!-- Р вЂ”Р В°Р С–Р С•Р В»Р С•Р Р†Р С•Р С” -->
                <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-red-500 text-white">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-shield-alt text-2xl"></i>
                        <div>
                            <h3 class="text-xl font-black" data-i18n="adminPanel">Р С’Р Т‘Р СР С‘Р Р… Р С—Р В°Р Р…Р ВµР В»РЎРЉ</h3>
                            <p class="text-xs opacity-80">Р СљР С•Р Р…Р С‘РЎвЂљР С•РЎР‚Р С‘Р Р…Р С– Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–</p>
                        </div>
                    </div>
                    <button onclick="closeAdminPanel()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20 transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Р В¤Р С•РЎР‚Р СР В° Р Р†РЎвЂ¦Р С•Р Т‘Р В° Р Р† Р В°Р Т‘Р СР С‘Р Р…Р С”РЎС“ -->
                <div id="admin-login" class="p-8 text-center">
                    <i class="fas fa-lock text-5xl text-slate-300 mb-4"></i>
                    <p class="text-slate-500 mb-6" data-i18n="enterAdminPassword">Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р С—Р В°РЎР‚Р С•Р В»РЎРЉ Р В°Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚Р В°</p>
                    <div class="relative w-full max-w-xs mx-auto mb-4">
                        <input type="password" id="admin-password" data-i18n-placeholder="password" placeholder="Р СџР В°РЎР‚Р С•Р В»РЎРЉ" class="w-full p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl outline-none focus:ring-2 focus:ring-red-500 transition-all text-center">
                        <div id="admin-code-hint" class="hidden mt-2 p-2 bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 rounded-xl">
                            <p class="text-xs text-green-600 dark:text-green-400"><i class="fas fa-key mr-1"></i> Р С™Р С•Р Т‘: <span id="admin-code-value" class="font-bold select-all"></span></p>
                        </div>
                    </div>
                    <p id="admin-error" class="text-red-500 text-sm mb-4 hidden" data-i18n="wrongAdminPassword">Р СњР ВµР Р†Р ВµРЎР‚Р Р…РЎвЂ№Р в„– Р С—Р В°РЎР‚Р С•Р В»РЎРЉ</p>
                    <button onclick="adminLogin()" class="px-8 py-3 bg-red-500 text-white font-bold rounded-2xl hover:bg-red-600 transition-all">
                        <i class="fas fa-unlock mr-2"></i> <span data-i18n="access">Р вЂ™Р С•Р в„–РЎвЂљР С‘</span>
                    </button>
                </div>
                
                <!-- Р РЋР С•Р Т‘Р ВµРЎР‚Р В¶Р С‘Р СР С•Р Вµ Р В°Р Т‘Р СР С‘Р Р…Р С”Р С‘ -->
                <div id="admin-content" class="hidden flex-1 overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-200 dark:border-slate-700">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="admin-search" data-i18n-placeholder="searchUsers" placeholder="Р СџР С•Р С‘РЎРѓР С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–..." class="w-full p-3 pl-10 bg-slate-100 dark:bg-slate-700 rounded-xl outline-none text-sm" oninput="filterAdminUsers()">
                        </div>
                    </div>
                    <div id="admin-users-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
                    <div class="p-4 border-t border-slate-200 dark:border-slate-700 text-center text-xs text-slate-400">
                        <span id="admin-users-count">0 Р С•Р Р…Р В»Р В°Р в„–Р Р… / 0</span> Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
                    </div>
                </div>
            </div>
            
            <!-- Р вЂР С•Р С”Р С•Р Р†Р В°РЎРЏ Р С—Р В°Р Р…Р ВµР В»РЎРЉ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ (РЎРѓР С”РЎР‚РЎвЂ№РЎвЂљР В° Р С—Р С• РЎС“Р СР С•Р В»РЎвЂЎР В°Р Р…Р С‘РЎР‹) -->
            <div id="creator-sidebar" class="hidden w-72 border-l border-slate-200 dark:border-slate-700 bg-gradient-to-b from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 flex-col" style="display: none;">
                <div class="p-4 bg-gradient-to-r from-yellow-400 to-orange-400 text-yellow-900">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-crown"></i>
                        <span class="font-black">Р СџР В°Р Р…Р ВµР В»РЎРЉ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ</span>
                    </div>
                    <p class="text-xs opacity-80">Р В РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р С‘ РЎС“Р С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ</p>
                </div>
                
                <div class="p-4 flex-1 overflow-y-auto">
                    <div class="mb-4 relative">
                        <label class="text-xs font-bold text-slate-500 mb-2 block">Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ</label>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" id="creator-user-search" placeholder="Р СџР С•Р С‘РЎРѓР С” Р С—Р С• Р Р…Р С‘Р С”РЎС“..." class="w-full p-3 pl-9 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500 text-sm" oninput="searchCreatorUsers(this.value)">
                        </div>
                        <div id="creator-user-results" class="absolute left-0 right-0 mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-lg max-h-40 overflow-y-auto z-10 hidden"></div>
                    </div>
                    
                    <div id="creator-selected-user-container" class="mb-4 hidden">
                        <label class="text-xs font-bold text-slate-500 mb-2 block">Р вЂ™РЎвЂ№Р В±РЎР‚Р В°Р Р…</label>
                        <div id="creator-selected-user" class="p-3 bg-white dark:bg-slate-800 rounded-xl border-2 border-yellow-400 text-sm"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-xs font-bold text-slate-500 mb-2 block">Р СћР ВµР С”РЎС“РЎвЂ°Р С‘Р в„– Р В±Р В°Р В»Р В°Р Р…РЎРѓ</label>
                        <div class="text-2xl font-black text-red-500 flex items-center gap-2">
                            <i class="fas fa-gem"></i>
                            <span id="creator-user-rubies">0.00</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-xs font-bold text-slate-500 mb-2 block">Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№</label>
                        <input type="number" id="creator-add-amount" placeholder="Р С™Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С•" class="w-full p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500 text-sm">
                    </div>
                    
                    <button onclick="creatorAddRubiesToUser()" class="w-full p-3 bg-gradient-to-r from-yellow-400 to-orange-400 text-yellow-900 font-bold rounded-xl hover:from-yellow-500 hover:to-orange-500 transition-all text-sm">
                        <i class="fas fa-plus mr-2"></i> Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ
                    </button>
                    
                    <div class="mt-4">
                        <label class="text-xs font-bold text-slate-500 mb-2 block">Р вЂРЎвЂ№РЎРѓРЎвЂљРЎР‚РЎвЂ№Р Вµ Р Т‘Р ВµР в„–РЎРѓРЎвЂљР Р†Р С‘РЎРЏ</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="creatorQuickAdd(10)" class="p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-bold hover:border-yellow-400 transition-all">+10 СЂСџвЂ™Р‹</button>
                            <button onclick="creatorQuickAdd(50)" class="p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-bold hover:border-yellow-400 transition-all">+50 СЂСџвЂ™Р‹</button>
                            <button onclick="creatorQuickAdd(100)" class="p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-bold hover:border-yellow-400 transition-all">+100 СЂСџвЂ™Р‹</button>
                            <button onclick="creatorQuickAdd(1000)" class="p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-bold hover:border-yellow-400 transition-all">+1000 СЂСџвЂ™Р‹</button>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold text-slate-500 mb-2 block">Р Р€Р С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљР С•Р С</label>
                        <button onclick="creatorDeleteUserAccount()" class="w-full p-2 bg-red-500 text-white border border-red-600 rounded-lg text-xs font-bold hover:bg-red-600 transition-all mb-2">
                            <i class="fas fa-user-times mr-1"></i> Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
                        </button>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold text-slate-500 mb-2 block">Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С”Р В° Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦</label>
                        <button onclick="cleanDeletedUsersStories()" class="w-full p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 rounded-lg text-xs font-bold hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
                            <i class="fas fa-trash-alt mr-1"></i> Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓРЎвЂ№ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Р СљР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В° -->
<div id="gift-rubies-modal" class="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4" onclick="if(event.target === this) closeGiftRubies()">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-panel-pop max-h-[90vh] flex flex-col">
        <div class="p-5 bg-gradient-to-r from-pink-500 via-red-500 to-orange-500 text-white text-center flex-shrink-0">
            <div class="w-16 h-16 mx-auto mb-2 bg-white/20 rounded-full flex items-center justify-center">
                <span id="gift-preview-icon" class="text-4xl">СЂСџР‹Рѓ</span>
            </div>
            <h3 class="text-lg font-black">Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С”</h3>
            <p class="text-xs opacity-80">Р Т‘Р В»РЎРЏ <span id="gift-recipient-name" class="font-bold">@user</span></p>
        </div>
        <div class="p-4 overflow-y-auto flex-1">
            <div class="flex items-center justify-between mb-3 p-2 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm">
                <span class="opacity-60">Р вЂР В°Р В»Р В°Р Р…РЎРѓ:</span>
                <span class="font-bold text-red-500"><i class="fas fa-gem"></i> <span id="gift-my-balance">0.00</span></span>
            </div>
            
            <label class="text-[10px] font-bold text-slate-500 mb-2 block uppercase tracking-wider">Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С”</label>
            <div class="grid grid-cols-4 gap-2 mb-3" id="gifts-grid">
                <!-- Р вЂ”Р В°Р С—Р С•Р В»Р Р…РЎРЏР ВµРЎвЂљРЎРѓРЎРЏ Р Т‘Р С‘Р Р…Р В°Р СР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ -->
            </div>
            
            <div class="p-3 bg-pink-50 dark:bg-pink-900/20 rounded-xl mb-3 text-center">
                <p class="text-xs opacity-60 mb-1">Р вЂ™РЎвЂ№Р В±РЎР‚Р В°Р Р…Р С•:</p>
                <div class="flex items-center justify-center gap-2">
                    <span id="gift-selected-icon" class="w-8 h-8"></span>
                    <span class="font-bold"><span id="gift-selected-name">Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С”</span> РІР‚вЂќ <span id="gift-selected-price" class="text-red-500">100СЂСџвЂ™Р‹</span></span>
                </div>
            </div>
            
            <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase tracking-wider">Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ</label>
            <input type="text" id="gift-message" maxlength="100" placeholder="Р С›РЎвЂљ Р Р†РЎРѓР ВµР С–Р С• РЎРѓР ВµРЎР‚Р Т‘РЎвЂ Р В°! СЂСџвЂ™вЂў" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl outline-none focus:ring-2 focus:ring-pink-500 text-sm mb-3">
            
            <div class="flex gap-2">
                <button onclick="closeGiftRubies()" class="flex-1 p-3 bg-slate-200 dark:bg-slate-600 rounded-xl font-bold hover:bg-slate-300 dark:hover:bg-slate-500 transition-all text-sm">
                    Р С›РЎвЂљР СР ВµР Р…Р В°
                </button>
                <button onclick="sendGiftRubies()" class="flex-1 p-3 bg-gradient-to-r from-pink-500 to-red-500 text-white rounded-xl font-bold hover:from-pink-600 hover:to-red-600 transition-all text-sm">
                    <i class="fas fa-paper-plane mr-1"></i>Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљРЎРЉ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Р СљР В°Р С–Р В°Р В·Р С‘Р Р… РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† -->
<div id="ruby-shop-modal" class="ruby-shop-modal" style="display: none;" onclick="if(event.target === this) closeRubyShop()">
    <div class="ruby-shop-content">
        <div class="ruby-shop-header">
            <button onclick="closeRubyShop()" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20 transition-all">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3><i class="fas fa-gem"></i> Р СљР В°Р С–Р В°Р В·Р С‘Р Р… РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†</h3>
            <p class="text-sm opacity-80 mb-4">Р СћРЎР‚Р В°РЎвЂљРЎРЉ РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р Р…Р В° Р С”РЎР‚РЎС“РЎвЂљРЎвЂ№Р Вµ РЎв‚¬РЎвЂљРЎС“Р С”Р С‘!</p>
            <div class="ruby-shop-balance">
                <i class="fas fa-gem"></i>
                <span id="shop-rubies-count">0.00</span>
            </div>
        </div>
        <div class="ruby-shop-body">
            <!-- Premium Р С—Р С•Р Т‘Р С—Р С‘РЎРѓР С”Р В° -->
            <div id="premium-banner" class="premium-shop-banner">
                <h4>РІВ­С’ Flick-Prem</h4>
                <p>Р СџР С•Р В»РЎС“РЎвЂЎР С‘ РЎРЊР С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№Р Вµ Р Р†Р С•Р В·Р СР С•Р В¶Р Р…Р С•РЎРѓРЎвЂљР С‘!</p>
                <div class="premium-features">
                    <span>СЂСџвЂ™Р‹ -25% Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ</span>
                    <span>СЂСџР‹В¬ Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚</span>
                    <span>РІВ­С’ Р вЂ”Р Р…Р В°РЎвЂЎР С•Р С” Premium</span>
                </div>
                <div class="premium-features" style="margin-top: 8px;">
                    <span>СЂСџР‹РЃ Р В­Р С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№Р Вµ РЎвЂљР ВµР СРЎвЂ№</span>
                    <span>СЂСџвЂ“СРїС‘РЏ Р В Р В°Р СР С”Р С‘ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В°</span>
                    <span>РІСљРЃ Р С›Р В±Р С•Р С‘ РЎвЂЎР В°РЎвЂљР В°</span>
                </div>
                <div class="premium-price">
                    <i class="fas fa-gem"></i> 50 / Р СР ВµРЎРѓРЎРЏРЎвЂ 
                </div>
                <button onclick="buyPremium()">Р СџР С•Р Т‘Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ Premium</button>
            </div>
            
            <!-- Р В Р В°Р СР С”Р С‘ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В° -->
            <div class="ruby-shop-category">
                <div class="ruby-shop-category-title">
                    <i class="fas fa-circle-notch"></i> Р В Р В°Р СР С”Р С‘ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В°
                </div>
                <div id="shop-frames-list">
                    <div class="ruby-shop-item" data-item="frame-rainbow">
                        <div class="ruby-shop-item-icon" style="background: linear-gradient(45deg, #f59e0b, #ef4444, #ec4899, #8b5cf6); border-radius: 50%;">
                            <div style="width: 30px; height: 30px; background: #6366f1; border-radius: 50%; margin: 5px;"></div>
                        </div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">СЂСџРЉв‚¬ Р В Р В°Р Т‘РЎС“Р В¶Р Р…Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                            <div class="ruby-shop-item-desc">Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р В°РЎРЏ РЎР‚Р В°Р Т‘РЎС“Р В¶Р Р…Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В° РЎРѓ Р С—Р ВµРЎР‚Р ВµР В»Р С‘Р Р†Р В°Р СР С‘</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyFrameFromShop('rainbow', 50)">
                            <i class="fas fa-gem"></i> 50
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="frame-gold">
                        <div class="ruby-shop-item-icon" style="background: #fbbf24; box-shadow: 0 0 15px #fbbf24; border-radius: 50%;">
                            <div style="width: 30px; height: 30px; background: #6366f1; border-radius: 50%; margin: 5px;"></div>
                        </div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">СЂСџвЂвЂ Р вЂ”Р С•Р В»Р С•РЎвЂљР В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                            <div class="ruby-shop-item-desc">Р РЋР С‘РЎРЏРЎР‹РЎвЂ°Р В°РЎРЏ Р В·Р С•Р В»Р С•РЎвЂљР В°РЎРЏ РЎР‚Р В°Р СР С”Р В° Р Т‘Р В»РЎРЏ VIP</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyFrameFromShop('gold', 75)">
                            <i class="fas fa-gem"></i> 75
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="frame-neon">
                        <div class="ruby-shop-item-icon" style="background: #0f172a; box-shadow: 0 0 15px #22d3ee, 0 0 30px #22d3ee; border-radius: 50%;">
                            <div style="width: 30px; height: 30px; background: #22d3ee; border-radius: 50%; margin: 5px;"></div>
                        </div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">РІС™РЋ Р СњР ВµР С•Р Р…Р С•Р Р†Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                            <div class="ruby-shop-item-desc">Р СџРЎС“Р В»РЎРЉРЎРѓР С‘РЎР‚РЎС“РЎР‹РЎвЂ°Р ВµР Вµ Р Р…Р ВµР С•Р Р…Р С•Р Р†Р С•Р Вµ РЎРѓР Р†Р ВµРЎвЂЎР ВµР Р…Р С‘Р Вµ</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyFrameFromShop('neon', 100)">
                            <i class="fas fa-gem"></i> 100
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="frame-fire">
                        <div class="ruby-shop-item-icon" style="background: linear-gradient(45deg, #f97316, #ef4444); box-shadow: 0 0 15px #ef4444; border-radius: 50%;">
                            <div style="width: 30px; height: 30px; background: #6366f1; border-radius: 50%; margin: 5px;"></div>
                        </div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">СЂСџвЂќТђ Р С›Р С–Р Р…Р ВµР Р…Р Р…Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                            <div class="ruby-shop-item-desc">Р СљР ВµРЎР‚РЎвЂ Р В°РЎР‹РЎвЂ°Р ВµР Вµ Р С—Р В»Р В°Р СРЎРЏ Р Р†Р С•Р С”РЎР‚РЎС“Р С– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В°</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyFrameFromShop('fire', 100)">
                            <i class="fas fa-gem"></i> 100
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="frame-purple">
                        <div class="ruby-shop-item-icon" style="background: #a855f7; box-shadow: 0 0 15px #a855f7; border-radius: 50%;">
                            <div style="width: 30px; height: 30px; background: #6366f1; border-radius: 50%; margin: 5px;"></div>
                        </div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">СЂСџвЂ™Сљ Р В¤Р С‘Р С•Р В»Р ВµРЎвЂљР С•Р Р†Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                            <div class="ruby-shop-item-desc">Р СљР В°Р С–Р С‘РЎвЂЎР ВµРЎРѓР С”Р С•Р Вµ РЎвЂћР С‘Р С•Р В»Р ВµРЎвЂљР С•Р Р†Р С•Р Вµ РЎРѓР Р†Р ВµРЎвЂЎР ВµР Р…Р С‘Р Вµ</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyFrameFromShop('purple', 75)">
                            <i class="fas fa-gem"></i> 75
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="frame-emerald">
                        <div class="ruby-shop-item-icon" style="background: #10b981; box-shadow: 0 0 15px #10b981; border-radius: 50%;">
                            <div style="width: 30px; height: 30px; background: #6366f1; border-radius: 50%; margin: 5px;"></div>
                        </div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">СЂСџвЂ™С™ Р ВР В·РЎС“Р СРЎР‚РЎС“Р Т‘Р Р…Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                            <div class="ruby-shop-item-desc">Р вЂР В»Р В°Р С–Р С•РЎР‚Р С•Р Т‘Р Р…Р С•Р Вµ Р С‘Р В·РЎС“Р СРЎР‚РЎС“Р Т‘Р Р…Р С•Р Вµ РЎРѓР С‘РЎРЏР Р…Р С‘Р Вµ</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyFrameFromShop('emerald', 75)">
                            <i class="fas fa-gem"></i> 75
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="frame-diamond">
                        <div class="ruby-shop-item-icon" style="background: linear-gradient(135deg, #60a5fa, #93c5fd, #fff); box-shadow: 0 0 20px #60a5fa; border-radius: 50%;">
                            <div style="width: 30px; height: 30px; background: #6366f1; border-radius: 50%; margin: 5px;"></div>
                        </div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">СЂСџвЂ™Р‹ Р вЂРЎР‚Р С‘Р В»Р В»Р С‘Р В°Р Р…РЎвЂљР С•Р Р†Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                            <div class="ruby-shop-item-desc">Р В Р С•РЎРѓР С”Р С•РЎв‚¬Р Р…Р В°РЎРЏ РЎРѓР Р†Р ВµРЎР‚Р С”Р В°РЎР‹РЎвЂ°Р В°РЎРЏ РЎР‚Р В°Р СР С”Р В°</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyFrameFromShop('diamond', 150)">
                            <i class="fas fa-gem"></i> 150
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Р РЋРЎвЂљР С‘Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– -->
            <div class="ruby-shop-category">
                <div class="ruby-shop-category-title">
                    <i class="fas fa-comment-dots"></i> Р РЋРЎвЂљР С‘Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
                </div>
                <div id="shop-styles-list">
                    <div class="ruby-shop-item" data-item="style-gradient">
                        <div class="ruby-shop-item-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">СЂСџРЉв‚¬</div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">Р вЂњРЎР‚Р В°Р Т‘Р С‘Р ВµР Р…РЎвЂљ</div>
                            <div class="ruby-shop-item-desc">Р С™РЎР‚Р В°РЎРѓР С‘Р Р†РЎвЂ№Р Вµ Р С–РЎР‚Р В°Р Т‘Р С‘Р ВµР Р…РЎвЂљР Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyStyleFromShop('gradient', 100)">
                            <i class="fas fa-gem"></i> 100
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="style-neon">
                        <div class="ruby-shop-item-icon" style="background: #0f172a; color: #22d3ee; box-shadow: 0 0 10px #22d3ee; border-radius: 12px; display: flex; align-items: center; justify-content: center;">РІС™РЋ</div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">Р СњР ВµР С•Р Р…</div>
                            <div class="ruby-shop-item-desc">Р РЋР Р†Р ВµРЎвЂљРЎРЏРЎвЂ°Р С‘Р ВµРЎРѓРЎРЏ Р Р…Р ВµР С•Р Р…Р С•Р Р†РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyStyleFromShop('neon', 150)">
                            <i class="fas fa-gem"></i> 150
                        </div>
                    </div>
                    <div class="ruby-shop-item" data-item="style-glass">
                        <div class="ruby-shop-item-icon" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); border-radius: 12px;">СЂСџвЂ™Р‹</div>
                        <div class="ruby-shop-item-info">
                            <div class="ruby-shop-item-name">Р РЋРЎвЂљР ВµР С”Р В»Р С•</div>
                            <div class="ruby-shop-item-desc">Р СџРЎР‚Р С•Р В·РЎР‚Р В°РЎвЂЎР Р…РЎвЂ№Р в„– РЎРѓРЎвЂљР ВµР С”Р В»РЎРЏР Р…Р Р…РЎвЂ№Р в„– РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљ</div>
                        </div>
                        <div class="ruby-shop-item-price" onclick="buyStyleFromShop('glass', 200)">
                            <i class="fas fa-gem"></i> 200
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Р РЋР ВµР С”РЎР‚Р ВµРЎвЂљР Р…РЎвЂ№Р Вµ Р С”Р С•Р Т‘РЎвЂ№ -->
            <div class="ruby-shop-category">
                <div class="ruby-shop-category-title">
                    <i class="fas fa-key"></i> Р РЋР ВµР С”РЎР‚Р ВµРЎвЂљР Р…РЎвЂ№Р Вµ Р С”Р С•Р Т‘РЎвЂ№
                </div>
                <div class="ruby-shop-item" data-item="admin-code">
                    <div class="ruby-shop-item-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">СЂСџвЂќС’</div>
                    <div class="ruby-shop-item-info">
                        <div class="ruby-shop-item-name">Р С™Р С•Р Т‘ Р В°Р Т‘Р СР С‘Р Р…-Р С—Р В°Р Р…Р ВµР В»Р С‘</div>
                        <div class="ruby-shop-item-desc">Р Р€Р В·Р Р…Р В°Р в„– РЎРѓР ВµР С”РЎР‚Р ВµРЎвЂљР Р…РЎвЂ№Р в„– Р С—Р В°РЎР‚Р С•Р В»РЎРЉ Р В°Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚Р В°</div>
                    </div>
                    <div class="ruby-shop-item-price" onclick="buyShopItem('admin-code', 1000)">
                        <i class="fas fa-gem"></i> 1000
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Р вЂњР В»Р С•Р В±Р В°Р В»РЎРЉР Р…Р В°РЎРЏ РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ Р С—Р С•Р С‘РЎРѓР С”Р В° - Р С•Р С—РЎР‚Р ВµР Т‘Р ВµР В»РЎРЏР ВµРЎвЂљРЎРѓРЎРЏ Р Т‘Р С• Р СР С•Р Т‘РЎС“Р В»РЎРЏ
window.doNicknameSearch = function(val) {
    if (window.handleNicknameSearch) {
        window.handleNicknameSearch(val);
    } else {
        console.log('handleNicknameSearch not ready yet');
    }
};
</script>

<script type="module">
    // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р Р…РЎС“РЎР‹ РЎвЂљР ВµР СРЎС“ Р вЂќР С› Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ Firebase Р Т‘Р В»РЎРЏ Р В±РЎвЂ№РЎРѓРЎвЂљРЎР‚Р С•Р С–Р С• Р С•РЎвЂљР С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘РЎРЏ
    (function() {
        const savedTheme = localStorage.getItem('flickers-theme');
        if (savedTheme) {
            document.body.className = `theme-${savedTheme} h-screen flex flex-col overflow-hidden`;
        } else {
            // Р СџР С• РЎС“Р СР С•Р В»РЎвЂЎР В°Р Р…Р С‘РЎР‹ РЎвЂљР ВµР СР Р…Р В°РЎРЏ РЎвЂљР ВµР СР В°
            document.body.className = 'theme-dark h-screen flex flex-col overflow-hidden';
        }
    })();
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, collection, query, onSnapshot, addDoc, serverTimestamp, orderBy, limit, where, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Obfuscated config
    const _fb = {
        a: atob('QUl6YVN5RGtGalVfNlhJcDdQNER1YVlOZnZZUGNyWGltbXZ0bWdn'),
        b: 'govno-kakoeto-messanger',
        c: atob('MjE2Nzg0NDUyMTEw'),
        d: atob('MToyMTY3ODQ0NTIxMTA6d2ViOmMzMmNlZTI1ZDM4ZTQ5YmM0NDlhNWY=')
    };
    const firebaseConfig = {
        apiKey: _fb.a,
        authDomain: _fb.b + ".firebaseapp.com",
        projectId: _fb.b,
        messagingSenderId: _fb.c,
        appId: _fb.d
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'flickers-pro-v2';

    let me = null, activeChatPartner = null, msgUnsub = null, partnerUnsub = null, chatListeners = {}, activeGroupCallUnsub = null;
    let onlineStatusInterval = null;
    let isMobileView = window.innerWidth <= 768;
    
    // Р С™РЎРЊРЎв‚¬ Premium РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР С•Р Р† Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
    const premiumCache = {};

    const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');
    
    // ========== Р РЋР ВР РЋР СћР вЂўР СљР С’ Р В Р Р€Р вЂР ВР СњР С›Р вЂ™ ==========
    const RUBY_PER_MESSAGE = 0.01;
    const ADMIN_PASSWORD = 'RimixLegenda98!';
    const CREATOR_PASSWORD = 'Р В Р Р€Р вЂР ВР СњР В«_Р вЂ”Р вЂќР вЂўР РЋР В¬!1!1Ye';
    
    // Р В¤РЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р С•РЎвЂљР С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘РЎРЏ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
    function updateRubiesDisplay() {
        const rubies = me?.rubies || 0;
        const formatted = rubies.toFixed(2);
        const rubiesCount = document.getElementById('rubies-count');
        const shopRubiesCount = document.getElementById('shop-rubies-count');
        const settingsRubies = document.getElementById('settings-rubies');
        
        if (rubiesCount) rubiesCount.textContent = formatted;
        if (shopRubiesCount) shopRubiesCount.textContent = formatted;
        if (settingsRubies) settingsRubies.textContent = formatted;
    }
    
    // Р СњР В°РЎвЂЎР С‘РЎРѓР В»Р ВµР Р…Р С‘Р Вµ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р В·Р В° Р Р†РЎР‚Р ВµР СРЎРЏ Р Р† Р С—РЎР‚Р С‘Р В»Р С•Р В¶Р ВµР Р…Р С‘Р С‘ (1 РЎР‚РЎС“Р В±Р С‘Р Р… Р Р† Р СР С‘Р Р…РЎС“РЎвЂљРЎС“)
    let chatRubyInterval = null;
    function startChatRubyEarning() {
        if (chatRubyInterval) clearInterval(chatRubyInterval);
        
        chatRubyInterval = setInterval(async () => {
            if (me && me.uid) {
                me.rubies = (me.rubies || 0) + 1;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                    rubies: me.rubies
                }, { merge: true });
                updateRubiesDisplay();
                showToast('+1СЂСџвЂ™Р‹ Р В·Р В° Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•РЎРѓРЎвЂљРЎРЉ', 'РІРЏВ±РїС‘РЏ');
            }
        }, 60000); // Р С™Р В°Р В¶Р Т‘РЎС“РЎР‹ Р СР С‘Р Р…РЎС“РЎвЂљРЎС“
    }
    
    // Р СњР В°РЎвЂЎР С‘РЎРѓР В»Р ВµР Р…Р С‘Р Вµ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р В·Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
    async function earnRubies(amount = RUBY_PER_MESSAGE) {
        if (!me) return;
        
        const newBalance = (me.rubies || 0) + amount;
        me.rubies = newBalance;
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Firebase (Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С setDoc РЎРѓ merge Р Т‘Р В»РЎРЏ РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ/Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ)
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
            rubies: newBalance
        }, { merge: true });
        
        updateRubiesDisplay();
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹ Р В·Р В°РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р В°
        showRubyEarnedAnimation(amount);
    }
    
    // Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р В·Р В°РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р В° РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
    function showRubyEarnedAnimation(amount) {
        const rubyDisplay = document.querySelector('.rubies-display');
        if (!rubyDisplay) return;
        
        const rect = rubyDisplay.getBoundingClientRect();
        const anim = document.createElement('div');
        anim.className = 'ruby-earned';
        anim.innerHTML = `<i class="fas fa-gem"></i> +${amount.toFixed(2)}`;
        anim.style.left = rect.left + 'px';
        anim.style.top = rect.top + 'px';
        document.body.appendChild(anim);
        
        setTimeout(() => anim.remove(), 1500);
    }
    
    // Р С›РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р СР В°Р С–Р В°Р В·Р С‘Р Р… РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
    window.openRubyShop = async () => {
        if (!me) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†Р С•Р в„–Р Т‘Р С‘РЎвЂљР Вµ Р Р† Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ', 'РІСњРЉ');
            return;
        }
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В°Р С”РЎвЂљРЎС“Р В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С‘Р В· Firebase
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                me.ownedFrames = data.ownedFrames || ['none'];
                me.ownedStyles = data.ownedStyles || ['default'];
                me.ownedItems = data.ownedItems || [];
                me.avatarFrame = data.avatarFrame || 'none';
                me.chatStyle = data.chatStyle || 'default';
                me.rubies = data.rubies || 0;
            }
        } catch (e) {
            console.error('Error loading shop data:', e);
        }
        
        updateRubiesDisplay();
        updatePremiumBanner();
        updateShopItems();
        updateShopPricesWithDiscount();
        document.getElementById('ruby-shop-modal').style.display = 'flex';
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ РЎвЂ Р ВµР Р…РЎвЂ№ Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ РЎРѓР С• РЎРѓР С”Р С‘Р Т‘Р С”Р С•Р в„– Premium
    function updateShopPricesWithDiscount() {
        if (!hasPremium()) return;
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎвЂ Р ВµР Р…РЎвЂ№ РЎР‚Р В°Р СР С•Р С” (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Р СњР вЂўР С”РЎС“Р С—Р В»Р ВµР Р…Р Р…РЎвЂ№РЎвЂ¦)
        document.querySelectorAll('.ruby-shop-item-price[onclick*="buyFrameFromShop"]').forEach(btn => {
            // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р ВµРЎРѓР В»Р С‘ РЎС“Р В¶Р Вµ Р С”РЎС“Р С—Р В»Р ВµР Р…Р С•
            if (btn.classList.contains('owned')) return;
            
            const onclick = btn.getAttribute('onclick');
            const match = onclick.match(/buyFrameFromShop\('([^']+)',\s*(\d+)\)/);
            if (match && !btn.dataset.discounted) {
                const originalPrice = parseInt(match[2]);
                const discountedPrice = applyPremiumDiscount(originalPrice);
                btn.innerHTML = `<i class="fas fa-gem"></i> <s style="opacity:0.5;font-size:10px">${originalPrice}</s> ${discountedPrice}`;
                btn.dataset.discounted = 'true';
            }
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎвЂ Р ВµР Р…РЎвЂ№ РЎРѓРЎвЂљР С‘Р В»Р ВµР в„– (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Р СњР вЂўР С”РЎС“Р С—Р В»Р ВµР Р…Р Р…РЎвЂ№РЎвЂ¦)
        document.querySelectorAll('.ruby-shop-item-price[onclick*="buyStyleFromShop"]').forEach(btn => {
            if (btn.classList.contains('owned')) return;
            
            const onclick = btn.getAttribute('onclick');
            const match = onclick.match(/buyStyleFromShop\('([^']+)',\s*(\d+)\)/);
            if (match && !btn.dataset.discounted) {
                const originalPrice = parseInt(match[2]);
                const discountedPrice = applyPremiumDiscount(originalPrice);
                btn.innerHTML = `<i class="fas fa-gem"></i> <s style="opacity:0.5;font-size:10px">${originalPrice}</s> ${discountedPrice}`;
                btn.dataset.discounted = 'true';
            }
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎвЂ Р ВµР Р…РЎвЂ№ Р С•Р В±РЎвЂ№РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ РЎвЂљР С•Р Р†Р В°РЎР‚Р С•Р Р† (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Р СњР вЂўР С”РЎС“Р С—Р В»Р ВµР Р…Р Р…РЎвЂ№РЎвЂ¦)
        document.querySelectorAll('.ruby-shop-item-price[onclick*="buyShopItem"]').forEach(btn => {
            if (btn.classList.contains('owned')) return;
            
            const onclick = btn.getAttribute('onclick');
            const match = onclick.match(/buyShopItem\('([^']+)',\s*(\d+)\)/);
            if (match && !btn.dataset.discounted) {
                const originalPrice = parseInt(match[2]);
                const discountedPrice = applyPremiumDiscount(originalPrice);
                btn.innerHTML = `<i class="fas fa-gem"></i> <s style="opacity:0.5;font-size:10px">${originalPrice}</s> ${discountedPrice}`;
                btn.dataset.discounted = 'true';
            }
        });
    }
    
    // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р СР В°Р С–Р В°Р В·Р С‘Р Р… РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
    window.closeRubyShop = () => {
        document.getElementById('ruby-shop-modal').style.display = 'none';
    };
    
    // ========== PREMIUM Р СџР С›Р вЂќР СџР ВР РЋР С™Р С’ ==========
    const PREMIUM_PRICE = 50; // РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р Р† Р СР ВµРЎРѓРЎРЏРЎвЂ 
    const PREMIUM_DISCOUNT = 0.25; // 25% РЎРѓР С”Р С‘Р Т‘Р С”Р В°
    
    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•РЎРѓРЎвЂљР С‘ Premium
    window.hasPremium = () => {
        if (!me?.premium) return false;
        const expiresAt = me.premium.expiresAt;
        if (!expiresAt) return false;
        return new Date(expiresAt.seconds ? expiresAt.seconds * 1000 : expiresAt) > new Date();
    };
    
    // Р СџР С•Р С”РЎС“Р С—Р С”Р В° Premium
    window.buyPremium = async () => {
        if (!me) return;
        
        const rubies = me.rubies || 0;
        
        if (hasPremium()) {
            showToast('Р Р€ Р Р†Р В°РЎРѓ РЎС“Р В¶Р Вµ Р ВµРЎРѓРЎвЂљРЎРЉ Premium!', 'РІВ­С’');
            return;
        }
        
        if (rubies < PREMIUM_PRICE) {
            showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${PREMIUM_PRICE}СЂСџвЂ™Р‹`, 'РІСњРЉ');
            return;
        }
        
        // Р СџР С•Р Т‘РЎвЂљР Р†Р ВµРЎР‚Р В¶Р Т‘Р ВµР Р…Р С‘Р Вµ - Р С—Р С•Р С”РЎС“Р С—Р В°Р ВµР С РЎРѓРЎР‚Р В°Р В·РЎС“ Р В±Р ВµР В· confirm (Р СР С•Р В¶Р ВµРЎвЂљ Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦)
        try {
            // Р вЂ™РЎвЂ№РЎвЂЎР С‘РЎРѓР В»РЎРЏР ВµР С Р Т‘Р В°РЎвЂљРЎС“ Р С•Р С”Р С•Р Р…РЎвЂЎР В°Р Р…Р С‘РЎРЏ (30 Р Т‘Р Р…Р ВµР в„–)
            const expiresAt = new Date();
            expiresAt.setDate(expiresAt.getDate() + 30);
            
            // Р РЋР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р С‘ Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚РЎС“Р ВµР С Premium
            const newBalance = rubies - PREMIUM_PRICE;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: newBalance,
                premium: {
                    active: true,
                    expiresAt: expiresAt,
                    purchasedAt: new Date()
                }
            }, { merge: true });
            
            me.rubies = newBalance;
            me.premium = { active: true, expiresAt: expiresAt };
            
            updateRubiesDisplay();
            updatePremiumBanner();
            updateShopPricesWithDiscount(); // Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° РЎРѓР С”Р С‘Р Т‘Р С”Р С‘
            updateShopItems(); // Р СџР С•РЎвЂљР С•Р С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ Р С”РЎС“Р С—Р В»Р ВµР Р…Р Р…РЎвЂ№РЎвЂ¦
            
            // Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ
            showToast('СЂСџР‹вЂ° Premium Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…!', 'РІВ­С’');
            showPremiumActivationAnimation();
            
        } catch (e) {
            console.error('Premium purchase error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—Р С•Р С”РЎС“Р С—Р С”Р С‘', 'РІСњРЉ');
        }
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р В±Р В°Р Р…Р Р…Р ВµРЎР‚Р В° Premium Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ
    window.updatePremiumBanner = () => {
        const banner = document.getElementById('premium-banner');
        if (!banner) return;
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С badge Р Р† Р В±Р С•Р С”Р С•Р Р†Р С•Р в„– Р С—Р В°Р Р…Р ВµР В»Р С‘
        const myNameEl = document.getElementById('my-name');
        if (myNameEl) {
            const premiumBadge = hasPremium() ? ` ${getPremiumBadgeHtml(true)}` : '';
            myNameEl.innerHTML = `@${me.username}${premiumBadge}`;
        }
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С/РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓР ВµР С”РЎвЂ Р С‘РЎР‹ Р С”Р В°РЎРѓРЎвЂљР С•Р СР С‘Р В·Р В°РЎвЂ Р С‘Р С‘ Premium
        const customSection = document.getElementById('premium-customization');
        if (customSection) {
            customSection.classList.toggle('hidden', !hasPremium());
        }
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎвЂ№Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Premium
        if (hasPremium()) {
            applyPremiumCustomization();
        } else {
            removePremiumCustomization();
        }
        
        if (hasPremium()) {
            const expiresAt = new Date(me.premium.expiresAt.seconds ? me.premium.expiresAt.seconds * 1000 : me.premium.expiresAt);
            const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));
            
            banner.classList.add('active-premium');
            banner.innerHTML = `
                <h4>РІВ­С’ Flick-Prem</h4>
                <p>Р вЂ™Р В°РЎв‚¬Р В° Р С—Р С•Р Т‘Р С—Р С‘РЎРѓР С”Р В° Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р В°!</p>
                <div class="premium-features">
                    <span>СЂСџвЂ™Р‹ -25% Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ</span>
                    <span>СЂСџР‹В¬ Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚</span>
                    <span>РІВ­С’ Р вЂ”Р Р…Р В°РЎвЂЎР С•Р С” Premium</span>
                </div>
                <div class="premium-features" style="margin-top: 8px;">
                    <span>СЂСџР‹РЃ Р В­Р С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№Р Вµ РЎвЂљР ВµР СРЎвЂ№</span>
                    <span>СЂСџвЂ“СРїС‘РЏ Р В Р В°Р СР С”Р С‘ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В°</span>
                    <span>РІСљРЃ Р С›Р В±Р С•Р С‘ РЎвЂЎР В°РЎвЂљР В°</span>
                </div>
                <div class="premium-price" style="font-size: 16px;">
                    Р С›РЎРѓРЎвЂљР В°Р В»Р С•РЎРѓРЎРЉ ${daysLeft} Р Т‘Р Р…Р ВµР в„–
                </div>
                <button onclick="renewPremium()" style="background: rgba(255,255,255,0.2); color: white;">Р СџРЎР‚Р С•Р Т‘Р В»Р С‘РЎвЂљРЎРЉ</button>
            `;
        } else {
            banner.classList.remove('active-premium');
            banner.innerHTML = `
                <h4>РІВ­С’ Flick-Prem</h4>
                <p>Р СџР С•Р В»РЎС“РЎвЂЎР С‘ РЎРЊР С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№Р Вµ Р Р†Р С•Р В·Р СР С•Р В¶Р Р…Р С•РЎРѓРЎвЂљР С‘!</p>
                <div class="premium-features">
                    <span>СЂСџвЂ™Р‹ -25% Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ</span>
                    <span>СЂСџР‹В¬ Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚</span>
                    <span>РІВ­С’ Р вЂ”Р Р…Р В°РЎвЂЎР С•Р С” Premium</span>
                </div>
                <div class="premium-features" style="margin-top: 8px;">
                    <span>СЂСџР‹РЃ Р В­Р С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№Р Вµ РЎвЂљР ВµР СРЎвЂ№</span>
                    <span>СЂСџвЂ“СРїС‘РЏ Р В Р В°Р СР С”Р С‘ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В°</span>
                    <span>РІСљРЃ Р С›Р В±Р С•Р С‘ РЎвЂЎР В°РЎвЂљР В°</span>
                </div>
                <div class="premium-price">
                    <i class="fas fa-gem"></i> 50 / Р СР ВµРЎРѓРЎРЏРЎвЂ 
                </div>
                <button onclick="buyPremium()">Р СџР С•Р Т‘Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ Premium</button>
            `;
        }
    };
    
    // Premium Р С”Р В°РЎРѓРЎвЂљР С•Р СР С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ
    let premiumTheme = localStorage.getItem('flickers-premium-theme') || '';
    let premiumFrame = localStorage.getItem('flickers-premium-frame') || '';
    
    window.setPremiumTheme = (theme) => {
        if (!hasPremium()) {
            showToast('Р вЂќР С•РЎРѓРЎвЂљРЎС“Р С—Р Р…Р С• РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium!', 'РІВ­С’');
            return;
        }
        premiumTheme = theme;
        localStorage.setItem('flickers-premium-theme', theme);
        applyPremiumCustomization();
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Firebase
        if (me?.uid) {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                premiumTheme: theme
            }, { merge: true });
        }
        
        showToast(theme ? 'Р СћР ВµР СР В° Р С—РЎР‚Р С‘Р СР ВµР Р…Р ВµР Р…Р В°!' : 'Р РЋРЎвЂљР В°Р Р…Р Т‘Р В°РЎР‚РЎвЂљР Р…Р В°РЎРЏ РЎвЂљР ВµР СР В°', 'СЂСџР‹РЃ');
    };
    
    window.setPremiumFrame = (frame) => {
        if (!hasPremium()) {
            showToast('Р вЂќР С•РЎРѓРЎвЂљРЎС“Р С—Р Р…Р С• РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium!', 'РІВ­С’');
            return;
        }
        premiumFrame = frame;
        localStorage.setItem('flickers-premium-frame', frame);
        applyPremiumCustomization();
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Firebase
        if (me?.uid) {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                premiumFrame: frame
            }, { merge: true });
        }
        
        showToast(frame ? 'Р В Р В°Р СР С”Р В° Р С—РЎР‚Р С‘Р СР ВµР Р…Р ВµР Р…Р В°!' : 'Р В Р В°Р СР С”Р В° РЎС“Р В±РЎР‚Р В°Р Р…Р В°', 'РІСљРЃ');
    };
    
    function applyPremiumCustomization() {
        const messagesContainer = document.getElementById('messages-container');
        const myAvatar = document.getElementById('my-avatar');
        const settingsAvatar = document.getElementById('settings-avatar');
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎвЂљР ВµР СРЎС“ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
        if (messagesContainer) {
            // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С Р Р†РЎРѓР Вµ РЎвЂљР ВµР СРЎвЂ№
            messagesContainer.classList.remove('premium-theme-purple', 'premium-theme-pink', 'premium-theme-orange', 
                'premium-theme-green', 'premium-theme-cyan', 'premium-theme-red', 'premium-theme-gold');
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р†РЎвЂ№Р В±РЎР‚Р В°Р Р…Р Р…РЎС“РЎР‹
            if (premiumTheme) {
                messagesContainer.classList.add(`premium-theme-${premiumTheme}`);
            }
        }
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎР‚Р В°Р СР С”РЎС“ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В°
        [myAvatar, settingsAvatar].forEach(avatar => {
            if (avatar) {
                avatar.classList.remove('premium-avatar-frame', 'premium-frame-rainbow', 'premium-frame-gold', 
                    'premium-frame-purple', 'premium-frame-pink', 'premium-frame-cyan');
                if (premiumFrame) {
                    avatar.classList.add('premium-avatar-frame', `premium-frame-${premiumFrame}`);
                }
            }
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С UI Р С”Р Р…Р С•Р С—Р С•Р С”
        document.querySelectorAll('.premium-theme-btn').forEach(btn => {
            btn.classList.remove('border-indigo-500');
            btn.classList.add('border-transparent');
        });
        document.querySelectorAll('.premium-frame-btn').forEach(btn => {
            btn.classList.remove('border-indigo-500');
            btn.classList.add('border-transparent');
        });
    }
    
    function removePremiumCustomization() {
        const messagesContainer = document.getElementById('messages-container');
        const myAvatar = document.getElementById('my-avatar');
        const settingsAvatar = document.getElementById('settings-avatar');
        
        if (messagesContainer) {
            messagesContainer.classList.remove('premium-theme-purple', 'premium-theme-pink', 'premium-theme-orange', 
                'premium-theme-green', 'premium-theme-cyan', 'premium-theme-red', 'premium-theme-gold');
        }
        
        [myAvatar, settingsAvatar].forEach(avatar => {
            if (avatar) {
                avatar.classList.remove('premium-avatar-frame', 'premium-frame-rainbow', 'premium-frame-gold', 
                    'premium-frame-purple', 'premium-frame-pink', 'premium-frame-cyan');
            }
        });
    }
    
    function loadPremiumCustomization() {
        if (me?.premiumTheme) {
            premiumTheme = me.premiumTheme;
            localStorage.setItem('flickers-premium-theme', premiumTheme);
        }
        if (me?.premiumFrame) {
            premiumFrame = me.premiumFrame;
            localStorage.setItem('flickers-premium-frame', premiumFrame);
        }
        if (hasPremium()) {
            applyPremiumCustomization();
        }
    }
    
    // Р СџРЎР‚Р С•Р Т‘Р В»Р ВµР Р…Р С‘Р Вµ Premium
    window.renewPremium = async () => {
        if (!me) return;
        
        try {
            // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В°Р С”РЎвЂљРЎС“Р В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С‘Р В· Firebase
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
            
            if (!userDoc.exists()) {
                showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦', 'РІСњРЉ');
                return;
            }
            
            const data = userDoc.data();
            const currentRubies = data.rubies || 0;
            me.rubies = currentRubies; // Р РЋР С‘Р Р…РЎвЂ¦РЎР‚Р С•Р Р…Р С‘Р В·Р С‘РЎР‚РЎС“Р ВµР С
            
            if (currentRubies < PREMIUM_PRICE) {
                showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${PREMIUM_PRICE}СЂСџвЂ™Р‹, РЎС“ Р Р†Р В°РЎРѓ ${currentRubies.toFixed(2)}СЂСџвЂ™Р‹`, 'РІСњРЉ');
                return;
            }
            
            // Р вЂ™РЎвЂ№РЎвЂЎР С‘РЎРѓР В»РЎРЏР ВµР С Р Р…Р С•Р Р†РЎС“РЎР‹ Р Т‘Р В°РЎвЂљРЎС“ Р С•Р С”Р С•Р Р…РЎвЂЎР В°Р Р…Р С‘РЎРЏ
            let currentExpiresAt = new Date();
            if (data.premium && data.premium.expiresAt) {
                const exp = data.premium.expiresAt;
                const expDate = new Date(exp.seconds ? exp.seconds * 1000 : exp);
                // Р вЂўРЎРѓР В»Р С‘ Р С—Р С•Р Т‘Р С—Р С‘РЎРѓР С”Р В° Р ВµРЎвЂ°РЎвЂ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р В° - Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С” РЎвЂљР ВµР С”РЎС“РЎвЂ°Р ВµР в„– Р Т‘Р В°РЎвЂљР Вµ Р С•Р С”Р С•Р Р…РЎвЂЎР В°Р Р…Р С‘РЎРЏ
                if (expDate > new Date()) {
                    currentExpiresAt = expDate;
                }
            }
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С 30 Р Т‘Р Р…Р ВµР в„–
            currentExpiresAt.setDate(currentExpiresAt.getDate() + 30);
            
            const newBalance = currentRubies - PREMIUM_PRICE;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: newBalance,
                premium: {
                    active: true,
                    expiresAt: currentExpiresAt
                }
            }, { merge: true });
            
            me.rubies = newBalance;
            me.premium = { active: true, expiresAt: currentExpiresAt };
            
            updateRubiesDisplay();
            updatePremiumBanner();
            
            const daysLeft = Math.ceil((currentExpiresAt - new Date()) / (1000 * 60 * 60 * 24));
            showToast(`Premium Р С—РЎР‚Р С•Р Т‘Р В»РЎвЂР Р…! Р СћР ВµР С—Р ВµРЎР‚РЎРЉ Р Т‘Р С• ${daysLeft} Р Т‘Р Р…Р ВµР в„–`, 'РІВ­С’');
            
        } catch (e) {
            console.error('Premium renew error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—РЎР‚Р С•Р Т‘Р В»Р ВµР Р…Р С‘РЎРЏ: ' + e.message, 'РІСњРЉ');
        }
    };
    
    // Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р В°Р С”РЎвЂљР С‘Р Р†Р В°РЎвЂ Р С‘Р С‘ Premium
    function showPremiumActivationAnimation() {
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black/80';
        overlay.innerHTML = `
            <div class="text-center animate-bounce">
                <div class="text-8xl mb-4">РІВ­С’</div>
                <div class="text-3xl font-black text-white mb-2">Premium Р С’Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…!</div>
                <div class="text-lg text-yellow-400">Р вЂќР С•Р В±РЎР‚Р С• Р С—Р С•Р В¶Р В°Р В»Р С•Р Р†Р В°РЎвЂљРЎРЉ Р Р† Р С”Р В»РЎС“Р В±!</div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        setTimeout(() => {
            overlay.style.transition = 'opacity 0.5s';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 500);
        }, 2000);
    }
    
    // Р СџРЎР‚Р С‘Р СР ВµР Р…Р ВµР Р…Р С‘Р Вµ РЎРѓР С”Р С‘Р Т‘Р С”Р С‘ Premium
    window.applyPremiumDiscount = (price) => {
        if (hasPremium()) {
            return Math.floor(price * (1 - PREMIUM_DISCOUNT));
        }
        return price;
    };
    
    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Premium РЎС“ Р Т‘РЎР‚РЎС“Р С–Р С•Р С–Р С• Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
    window.checkUserPremium = (userData) => {
        if (!userData?.premium) return false;
        const expiresAt = userData.premium.expiresAt;
        if (!expiresAt) return false;
        return new Date(expiresAt.seconds ? expiresAt.seconds * 1000 : expiresAt) > new Date();
    };
    
    // HTML Р Т‘Р В»РЎРЏ Р В·Р Р…Р В°РЎвЂЎР С”Р В° Premium
    window.getPremiumBadgeHtml = (small = false) => {
        if (small) {
            return `<span class="premium-badge-small" title="Flick-Prem"><i class="fas fa-gem"></i></span>`;
        }
        return `<span class="premium-badge"><i class="fas fa-gem"></i><span class="premium-tooltip">РІВ­С’ Flick-Prem<br><span style="font-size:10px;opacity:0.8">Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎРѓ Р С—Р С•Р Т‘Р С—Р С‘РЎРѓР С”Р С•Р в„–</span></span></span>`;
    };
    
    // Р С’РЎРѓР С‘Р Р…РЎвЂ¦РЎР‚Р С•Р Р…Р Р…Р В°РЎРЏ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р С‘ Р С”РЎРЊРЎв‚¬Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Premium РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР В°
    window.loadUserPremiumStatus = async (uid, callback) => {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С”РЎРЊРЎв‚¬
        if (premiumCache[uid] !== undefined) {
            callback(premiumCache[uid]);
            return;
        }
        
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const hasPrem = checkUserPremium(userData);
                premiumCache[uid] = hasPrem;
                callback(hasPrem);
            } else {
                premiumCache[uid] = false;
                callback(false);
            }
        } catch (e) {
            premiumCache[uid] = false;
            callback(false);
        }
    };
    
    // ========== Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С” РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† ==========
    
    // SVG Р С‘Р С”Р С•Р Р…Р С”Р С‘ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р С•Р Р† Р Р† РЎРѓРЎвЂљР С‘Р В»Р Вµ Telegram (Р С–Р В»Р С•Р В±Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р Т‘Р В»РЎРЏ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р В° Р С—РЎР‚Р С‘ РЎР‚Р ВµР Р…Р Т‘Р ВµРЎР‚Р С‘Р Р…Р С–Р Вµ)
    window.giftSVGs = {
        'rose': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><ellipse cx="32" cy="20" rx="14" ry="16" fill="#e53935"/><ellipse cx="32" cy="16" rx="9" ry="11" fill="#ef5350"/><ellipse cx="28" cy="14" rx="4" ry="5" fill="#ff8a80"/><ellipse cx="36" cy="18" rx="3" ry="4" fill="#ff8a80"/><path d="M32 36v20" stroke="#2e7d32" stroke-width="5" stroke-linecap="round"/><path d="M32 46c-8-2-12 4-14 8" stroke="#2e7d32" stroke-width="3" fill="none" stroke-linecap="round"/><ellipse cx="18" cy="54" rx="5" ry="4" fill="#43a047"/><path d="M32 42c6-2 10 2 12 6" stroke="#2e7d32" stroke-width="3" fill="none" stroke-linecap="round"/><ellipse cx="44" cy="48" rx="4" ry="3" fill="#43a047"/></svg>`,
        'heart': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M32 56C32 56 8 40 8 22c0-10 8-16 16-16 5 0 8 3 8 3s3-3 8-3c8 0 16 6 16 16 0 18-24 34-24 34z" fill="#e53935"/><ellipse cx="20" cy="20" rx="6" ry="5" fill="#ff8a8a" opacity="0.6"/></svg>`,
        'teddy': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="16" cy="14" r="10" fill="#f59f00"/><circle cx="48" cy="14" r="10" fill="#f59f00"/><circle cx="16" cy="14" r="6" fill="#ffc078"/><circle cx="48" cy="14" r="6" fill="#ffc078"/><ellipse cx="32" cy="38" rx="22" ry="24" fill="#ffa726"/><ellipse cx="32" cy="42" rx="14" ry="12" fill="#ffe4b8"/><circle cx="22" cy="32" r="4" fill="#2d2d2d"/><circle cx="42" cy="32" r="4" fill="#2d2d2d"/><circle cx="23" cy="31" r="1.5" fill="#fff"/><circle cx="43" cy="31" r="1.5" fill="#fff"/><ellipse cx="32" cy="40" rx="5" ry="4" fill="#8b5a2b"/><path d="M28 46c4 3 8 3 8 0" stroke="#8b5a2b" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`,
        'gift': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect x="8" y="26" width="48" height="32" rx="4" fill="#8b5cf6"/><rect x="4" y="18" width="56" height="12" rx="4" fill="#c4b5fd"/><rect x="28" y="18" width="8" height="40" fill="#fbbf24"/><path d="M32 18c-10-12-20 0-20 0h20z" fill="#f472b6"/><path d="M32 18c10-12 20 0 20 0H32z" fill="#f472b6"/><circle cx="32" cy="18" r="4" fill="#fbbf24"/></svg>`,
        'cake': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect x="10" y="32" width="44" height="26" rx="6" fill="#ec4899"/><ellipse cx="32" cy="32" rx="22" ry="6" fill="#fbcfe8"/><path d="M10 40c8 4 16-2 22 0s14-4 22 0" stroke="#fff" stroke-width="3" fill="none" opacity="0.5"/><rect x="30" y="14" width="4" height="18" fill="#fbbf24"/><ellipse cx="32" cy="12" rx="5" ry="7" fill="#f97316"/><ellipse cx="32" cy="10" rx="3" ry="4" fill="#fbbf24"/><circle cx="32" cy="7" r="2" fill="#fff9db"/></svg>`,
        'ring': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><ellipse cx="32" cy="42" rx="20" ry="14" stroke="#fbbf24" stroke-width="8" fill="none"/><ellipse cx="32" cy="42" rx="12" ry="8" stroke="#fff5db" stroke-width="2" fill="none" opacity="0.5"/><polygon points="32,8 24,24 40,24" fill="#60a5fa"/><polygon points="32,8 28,20 36,20" fill="#93c5fd"/><circle cx="32" cy="18" r="3" fill="#dbeafe"/></svg>`,
        'star': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M32 4l7 22h23l-19 14 7 22-18-14-18 14 7-22L2 26h23z" fill="#fbbf24"/><path d="M32 12l4 13h14l-11 8 4 13-11-8-11 8 4-13-11-8h14z" fill="#fef3c7" opacity="0.5"/></svg>`,
        'crown': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M6 50h52v8H6z" fill="#fbbf24"/><path d="M6 26l14 24h24l14-24-14 14-12-18-12 18z" fill="#fbbf24"/><circle cx="6" cy="26" r="5" fill="#f59e0b"/><circle cx="32" cy="22" r="5" fill="#f59e0b"/><circle cx="58" cy="26" r="5" fill="#f59e0b"/><circle cx="18" cy="54" r="4" fill="#ef4444"/><circle cx="32" cy="54" r="4" fill="#3b82f6"/><circle cx="46" cy="54" r="4" fill="#22c55e"/></svg>`,
        'rocket': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M32 4c-14 10-18 32-18 40h36c0-8-4-30-18-40z" fill="#e5e7eb"/><path d="M32 8c-10 8-14 24-14 32h28c0-8-4-24-14-32z" fill="#f8f9fa"/><ellipse cx="32" cy="30" rx="8" ry="8" fill="#3b82f6"/><ellipse cx="32" cy="28" rx="4" ry="4" fill="#93c5fd"/><path d="M14 44c-10 6-10 16-10 16h10z" fill="#ef4444"/><path d="M50 44c10 6 10 16 10 16h-10z" fill="#ef4444"/><path d="M24 56h16l-8 8z" fill="#f97316"/><path d="M28 56h8l-4 6z" fill="#fbbf24"/></svg>`,
        'gem': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M32 58L4 26l10-18h36l10 18z" fill="#3b82f6"/><path d="M14 8L4 26h18L32 8z" fill="#93c5fd"/><path d="M50 8l10 18H42L32 8z" fill="#93c5fd"/><path d="M22 26L32 58l10-32z" fill="#60a5fa"/><path d="M4 26h18L32 58z" fill="#2563eb"/><path d="M60 26H42L32 58z" fill="#2563eb"/><path d="M22 26h20L32 8z" fill="#bfdbfe"/></svg>`,
        'unicorn': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><ellipse cx="30" cy="42" rx="22" ry="18" fill="#f9a8d4"/><circle cx="18" cy="36" r="14" fill="#fce7f3"/><path d="M10 26l6-22 6 18z" fill="#fbbf24"/><circle cx="14" cy="34" r="3" fill="#2d2d2d"/><circle cx="15" cy="33" r="1" fill="#fff"/><path d="M8 42c6 2 10 0 10 0" stroke="#f472b6" stroke-width="2" fill="none" stroke-linecap="round"/><path d="M22 22c10-4 18 2 24 8" stroke="#a855f7" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M26 18c8-2 14 2 20 6" stroke="#f472b6" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M30 14c6-2 10 2 14 4" stroke="#60a5fa" stroke-width="4" fill="none" stroke-linecap="round"/><ellipse cx="48" cy="50" rx="6" ry="10" fill="#fce7f3"/></svg>`,
        'trophy': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M14 8h36v26c0 10-8 18-18 18S14 44 14 34z" fill="#fbbf24"/><path d="M18 12h28v22c0 8-6 14-14 14s-14-6-14-14z" fill="#fef3c7" opacity="0.5"/><path d="M14 14H6c0 12 6 18 12 18v-4c-4 0-8-4-8-10h4z" fill="#fbbf24"/><path d="M50 14h8c0 12-6 18-12 18v-4c4 0 8-4 8-10h-4z" fill="#fbbf24"/><rect x="28" y="52" width="8" height="6" fill="#b8860b"/><rect x="20" y="56" width="24" height="6" rx="2" fill="#8b6914"/><path d="M28 24l2 4h5l-4 3 2 5-5-3-5 3 2-5-4-3h5z" fill="#f59e0b"/></svg>`,
        'shark': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><ellipse cx="32" cy="32" rx="28" ry="16" fill="#64748b"/><ellipse cx="32" cy="34" rx="24" ry="12" fill="#94a3b8"/><path d="M32 16l-6 16h12z" fill="#475569"/><path d="M56 28c6 1 8 4 8 4s-2 3-8 4z" fill="#64748b"/><path d="M8 32c-4 1-6 3-6 3s2 2 6 3z" fill="#64748b"/><ellipse cx="32" cy="38" rx="16" ry="6" fill="#cbd5e1"/><circle cx="20" cy="28" r="4" fill="#1e293b"/><circle cx="21" cy="27" r="1.5" fill="#fff"/><circle cx="44" cy="28" r="4" fill="#1e293b"/><circle cx="45" cy="27" r="1.5" fill="#fff"/><path d="M26 40c3 2 9 2 12 0" stroke="#475569" stroke-width="2" fill="none"/><path d="M24 44l2-2 2 2 2-2 2 2 2-2 2 2 2-2 2 2" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`,
        'spaceship': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><ellipse cx="32" cy="32" rx="28" ry="12" fill="#8b5cf6"/><ellipse cx="32" cy="28" rx="16" ry="16" fill="#a78bfa"/><ellipse cx="32" cy="26" rx="10" ry="10" fill="#60a5fa"/><ellipse cx="32" cy="24" rx="6" ry="6" fill="#93c5fd"/><ellipse cx="32" cy="32" rx="28" ry="4" fill="#7c3aed"/><circle cx="12" cy="32" r="4" fill="#fbbf24"/><circle cx="52" cy="32" r="4" fill="#fbbf24"/><circle cx="22" cy="32" r="3" fill="#22c55e"/><circle cx="42" cy="32" r="3" fill="#22c55e"/><path d="M32 44v8" stroke="#f97316" stroke-width="4"/><path d="M24 44v6" stroke="#fbbf24" stroke-width="3"/><path d="M40 44v6" stroke="#fbbf24" stroke-width="3"/></svg>`,
        'planet': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="24" fill="#ec4899"/><ellipse cx="32" cy="32" rx="32" ry="8" stroke="#fbbf24" stroke-width="4" fill="none" transform="rotate(-20 32 32)"/><circle cx="24" cy="26" r="6" fill="#f9a8d4" opacity="0.5"/><circle cx="38" cy="38" r="4" fill="#f9a8d4" opacity="0.4"/><circle cx="28" cy="42" r="3" fill="#f9a8d4" opacity="0.3"/></svg>`,
        'oscar': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><ellipse cx="32" cy="58" rx="12" ry="4" fill="#8b6914"/><rect x="28" y="52" width="8" height="8" fill="#fbbf24"/><ellipse cx="32" cy="52" rx="6" ry="2" fill="#fcd34d"/><rect x="29" y="38" width="6" height="16" fill="#fbbf24"/><ellipse cx="32" cy="32" rx="10" ry="12" fill="#fbbf24"/><ellipse cx="32" cy="30" rx="7" ry="8" fill="#fef3c7" opacity="0.4"/><circle cx="32" cy="18" r="8" fill="#fbbf24"/><circle cx="32" cy="17" r="5" fill="#fef3c7" opacity="0.3"/><ellipse cx="28" cy="16" rx="1.5" ry="2" fill="#d97706"/><ellipse cx="36" cy="16" rx="1.5" ry="2" fill="#d97706"/><path d="M22 30c-6 2-8 8-6 10" stroke="#fbbf24" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M42 30c6 2 8 8 6 10" stroke="#fbbf24" stroke-width="4" fill="none" stroke-linecap="round"/><circle cx="16" cy="40" r="3" fill="#fbbf24"/><circle cx="48" cy="40" r="3" fill="#fbbf24"/></svg>`
    };
    
    // Р РЋР С—Р С‘РЎРѓР С•Р С” Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р С•Р Р† (Р С•Р В±Р Р…Р С•Р Р†Р В»РЎвЂР Р…Р Р…РЎвЂ№Р в„– РЎРѓ Р Р…Р С•Р Р†РЎвЂ№Р СР С‘ РЎвЂ Р ВµР Р…Р В°Р СР С‘)
    const giftTypes = {
        'rose': { icon: window.giftSVGs.rose, name: 'Р В Р С•Р В·Р В°', price: 10 },
        'heart': { icon: window.giftSVGs.heart, name: 'Р РЋР ВµРЎР‚Р Т‘РЎвЂ Р Вµ', price: 25 },
        'teddy': { icon: window.giftSVGs.teddy, name: 'Р СљР С‘РЎв‚¬Р С”Р В°', price: 50 },
        'gift': { icon: window.giftSVGs.gift, name: 'Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С”', price: 100 },
        'cake': { icon: window.giftSVGs.cake, name: 'Р СћР С•РЎР‚РЎвЂљ', price: 150 },
        'ring': { icon: window.giftSVGs.ring, name: 'Р С™Р С•Р В»РЎРЉРЎвЂ Р С•', price: 500 },
        'star': { icon: window.giftSVGs.star, name: 'Р вЂ”Р Р†Р ВµР В·Р Т‘Р В°', price: 1000 },
        'crown': { icon: window.giftSVGs.crown, name: 'Р С™Р С•РЎР‚Р С•Р Р…Р В°', price: 5000 },
        'rocket': { icon: window.giftSVGs.rocket, name: 'Р В Р В°Р С”Р ВµРЎвЂљР В°', price: 10000 },
        'gem': { icon: window.giftSVGs.gem, name: 'Р С™РЎР‚Р С‘РЎРѓРЎвЂљР В°Р В»Р В»', price: 25000 },
        'unicorn': { icon: window.giftSVGs.unicorn, name: 'Р вЂўР Т‘Р С‘Р Р…Р С•РЎР‚Р С•Р С–', price: 50000 },
        'trophy': { icon: window.giftSVGs.trophy, name: 'Р С™РЎС“Р В±Р С•Р С”', price: 100000 },
        'shark': { icon: window.giftSVGs.shark, name: 'Р С’Р С”РЎС“Р В»Р В°', price: 500000 },
        'spaceship': { icon: window.giftSVGs.spaceship, name: 'Р СњР вЂєР С›', price: 1000000 },
        'planet': { icon: window.giftSVGs.planet, name: 'Р СџР В»Р В°Р Р…Р ВµРЎвЂљР В°', price: 10000000 },
        'oscar': { icon: window.giftSVGs.oscar, name: 'Р С›РЎРѓР С”Р В°РЎР‚', price: 100000000 }
    };
    
    let selectedGift = { id: 'gift', icon: window.giftSVGs.gift, name: 'Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С”', price: 100 };
    
    // Р С›РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С•Р С”Р Р…Р С• Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В°
    window.openGiftRubies = () => {
        if (!activeChatPartner) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ', 'РІСњРЉ');
            return;
        }
        
        document.getElementById('gift-recipient-name').textContent = '@' + activeChatPartner.username;
        document.getElementById('gift-my-balance').textContent = (me?.rubies || 0).toFixed(2);
        document.getElementById('gift-message').value = '';
        
        // Р вЂњР ВµР Р…Р ВµРЎР‚Р С‘РЎР‚РЎС“Р ВµР С РЎРѓР ВµРЎвЂљР С”РЎС“ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р С•Р Р†
        renderGiftsGrid();
        
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р Р†РЎвЂ№Р В±Р С•РЎР‚ Р Р…Р В° Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С” Р С—Р С• РЎС“Р СР С•Р В»РЎвЂЎР В°Р Р…Р С‘РЎР‹
        selectGift('gift');
        
        document.getElementById('gift-rubies-modal').classList.remove('hidden');
    };
    
    // Р В¤Р С•РЎР‚Р СР В°РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ РЎвЂ Р ВµР Р…РЎвЂ№ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В°
    function formatGiftPrice(price) {
        if (price >= 100000000) return (price / 1000000).toFixed(0) + 'M';
        if (price >= 1000000) return (price / 1000000).toFixed(0) + 'M';
        if (price >= 1000) return (price / 1000).toFixed(0) + 'K';
        return price;
    }
    
    // Р вЂњР ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРѓР ВµРЎвЂљР С”Р С‘ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р С•Р Р†
    function renderGiftsGrid() {
        const grid = document.getElementById('gifts-grid');
        grid.innerHTML = '';
        
        for (const [id, gift] of Object.entries(giftTypes)) {
            const priceText = formatGiftPrice(gift.price);
            const btn = document.createElement('button');
            btn.className = 'gift-option p-2 bg-slate-100 dark:bg-slate-700 rounded-xl hover:ring-2 hover:ring-pink-500 transition-all flex flex-col items-center';
            btn.dataset.gift = id;
            btn.onclick = () => selectGift(id);
            btn.innerHTML = `
                <span class="w-10 h-10 mb-1">${gift.icon}</span>
                <span class="text-[9px] font-bold">${priceText}СЂСџвЂ™Р‹</span>
            `;
            grid.appendChild(btn);
        }
    }
    
    // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С•Р С”Р Р…Р С• Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В°
    window.closeGiftRubies = () => {
        document.getElementById('gift-rubies-modal').classList.add('hidden');
    };
    
    // Р вЂ™РЎвЂ№Р В±РЎР‚Р В°РЎвЂљРЎРЉ Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С”
    window.selectGift = (id) => {
        const gift = giftTypes[id];
        if (!gift) return;
        
        selectedGift = { id, icon: gift.icon, name: gift.name, price: gift.price };
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С UI
        document.querySelectorAll('.gift-option').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.dataset.gift === id) {
                btn.classList.add('selected');
            }
        });
        
        document.getElementById('gift-preview-icon').innerHTML = gift.icon;
        document.getElementById('gift-selected-icon').innerHTML = gift.icon;
        document.getElementById('gift-selected-name').textContent = gift.name;
        const priceText = gift.price >= 1000 ? (gift.price >= 1000000 ? '1MСЂСџвЂ™Р‹' : (gift.price/1000) + 'KСЂСџвЂ™Р‹') : gift.price + 'СЂСџвЂ™Р‹';
        document.getElementById('gift-selected-price').textContent = priceText;
    };
    
    // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С”
    window.sendGiftRubies = async () => {
        if (!me || !activeChatPartner) return;
        
        const messageInput = document.getElementById('gift-message');
        const giftMessage = messageInput.value.trim() || 'Р С›РЎвЂљ Р Р†РЎРѓР ВµР С–Р С• РЎРѓР ВµРЎР‚Р Т‘РЎвЂ Р В°! СЂСџвЂ™вЂў';
        const price = selectedGift.price;
        
        if (price > (me.rubies || 0)) {
            showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${price}СЂСџвЂ™Р‹`, 'РІСњРЉ');
            return;
        }
        
        try {
            // Р РЋР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ РЎС“ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљР ВµР В»РЎРЏ
            me.rubies = (me.rubies || 0) - price;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: me.rubies
            }, { merge: true });
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С” Р С”Р В°Р С” pending (Р С•Р В¶Р С‘Р Т‘Р В°Р ВµРЎвЂљ РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘РЎРЏ Р С—Р С•Р В»РЎС“РЎвЂЎР В°РЎвЂљР ВµР В»РЎРЏ)
            const recipientRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', activeChatPartner.uid);
            const recipientSnap = await getDoc(recipientRef);
            const recipientData = recipientSnap.exists() ? recipientSnap.data() : {};
            const pendingGifts = recipientData.pendingGifts || [];
            
            pendingGifts.push({
                id: selectedGift.id,
                name: selectedGift.name,
                price: price,
                fromUid: me.uid,
                fromName: me.username,
                message: giftMessage,
                timestamp: Date.now()
            });
            
            await setDoc(recipientRef, {
                pendingGifts: pendingGifts
            }, { merge: true });
            
            // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ-Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С” Р Р† РЎвЂЎР В°РЎвЂљ
            const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), {
                type: 'gift',
                senderId: me.uid,
                senderName: me.username,
                recipientId: activeChatPartner.uid,
                recipientName: activeChatPartner.username,
                giftId: selectedGift.id,
                giftName: selectedGift.name,
                giftPrice: price,
                giftMessage: giftMessage,
                timestamp: serverTimestamp()
            });
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С•РЎвЂљР С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ
            updateRubiesDisplay();
            closeGiftRubies();
            showToast(`Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С” Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…!`, 'СЂСџР‹вЂ°');
            
        } catch (e) {
            console.error('Gift error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р С‘ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В°', 'РІСњРЉ');
        }
    };
    
    // Р СџР С•Р С”Р В°Р В·Р В°РЎвЂљРЎРЉ Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹ Р С—Р С•Р В»РЎС“РЎвЂЎР ВµР Р…Р С‘РЎРЏ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В° РЎРѓ Р Р†РЎвЂ№Р В±Р С•РЎР‚Р С•Р С
    window.showGiftReceivedAnimation = (giftId, giftName, senderName, message, giftPrice) => {
        const gift = giftTypes[giftId];
        if (!gift) return;
        
        // Р В РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р В·Р В° Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°Р Р…Р С‘Р Вµ = 100% Р С•РЎвЂљ РЎвЂ Р ВµР Р…РЎвЂ№ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В°
        const rubiesToReceive = giftPrice || gift.price;
        
        const overlay = document.createElement('div');
        overlay.className = 'gift-received-overlay';
        overlay.id = 'gift-choice-overlay';
        
        // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р С”Р С•Р Р…РЎвЂћР ВµРЎвЂљРЎвЂљР С‘
        let confettiHtml = '<div class="gift-sparkles">';
        const colors = ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#ec4899', '#8b5cf6'];
        for (let i = 0; i < 50; i++) {
            const color = colors[Math.floor(Math.random() * colors.length)];
            const left = Math.random() * 100;
            const delay = Math.random() * 0.5;
            confettiHtml += `<div class="gift-confetti" style="left: ${left}%; background: ${color}; animation-delay: ${delay}s;"></div>`;
        }
        confettiHtml += '</div>';
        
        overlay.innerHTML = `
            ${confettiHtml}
            <div class="gift-received-icon">${gift.icon}</div>
            <div class="gift-received-text">Р вЂ™РЎвЂ№ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘Р В»Р С‘ ${giftName}!</div>
            <div class="gift-received-from">Р С•РЎвЂљ @${senderName}</div>
            ${message ? `<div class="gift-received-message">"${message}"</div>` : ''}
            
            <div class="gift-choice-buttons">
                <button onclick="useGift('${giftId}', ${rubiesToReceive}, '${senderName}')" class="gift-choice-btn gift-use-btn">
                    <i class="fas fa-coins"></i>
                    <span>Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљРЎРЉ</span>
                    <span class="gift-choice-desc">+${rubiesToReceive}СЂСџвЂ™Р‹</span>
                </button>
                <button onclick="keepGift('${giftId}', '${senderName}')" class="gift-choice-btn gift-keep-btn">
                    <i class="fas fa-trophy"></i>
                    <span>Р С›РЎРѓРЎвЂљР В°Р Р†Р С‘РЎвЂљРЎРЉ</span>
                    <span class="gift-choice-desc">Р вЂ™ Р Р†Р С‘РЎвЂљРЎР‚Р С‘Р Р…РЎС“</span>
                </button>
            </div>
        `;
        
        document.body.appendChild(overlay);
    };
    
    // Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљРЎРЉ Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С” (Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№)
    window.useGift = async (giftId, rubies, senderName) => {
        if (!me) return;
        
        try {
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р С‘Р В· pending
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid);
            const userSnap = await getDoc(userRef);
            const userData = userSnap.exists() ? userSnap.data() : {};
            let pendingGifts = userData.pendingGifts || [];
            
            // Р СњР В°РЎвЂ¦Р С•Р Т‘Р С‘Р С Р С‘ РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С”
            const giftIndex = pendingGifts.findIndex(g => g.id === giftId && g.fromName === senderName);
            if (giftIndex > -1) {
                pendingGifts.splice(giftIndex, 1);
            }
            
            // Р СњР В°РЎвЂЎР С‘РЎРѓР В»РЎРЏР ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№
            me.rubies = (me.rubies || 0) + rubies;
            
            await setDoc(userRef, {
                rubies: me.rubies,
                pendingGifts: pendingGifts
            }, { merge: true });
            
            updateRubiesDisplay();
            
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р Р†Р ВµРЎР‚Р В»Р ВµР в„–
            const overlay = document.getElementById('gift-choice-overlay');
            if (overlay) {
                overlay.style.animation = 'gift-overlay-in 0.3s ease-out reverse';
                setTimeout(() => overlay.remove(), 300);
            }
            
            showToast(`+${rubies}СЂСџвЂ™Р‹ Р В·Р В° Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С”!`, 'СЂСџвЂ™В°');
            
        } catch (e) {
            console.error('Use gift error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В°', 'РІСњРЉ');
        }
    };
    
    // Р С›РЎРѓРЎвЂљР В°Р Р†Р С‘РЎвЂљРЎРЉ Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С” Р Р† Р Р†Р С‘РЎвЂљРЎР‚Р С‘Р Р…Р Вµ
    window.keepGift = async (giftId, senderName) => {
        if (!me) return;
        
        try {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid);
            const userSnap = await getDoc(userRef);
            const userData = userSnap.exists() ? userSnap.data() : {};
            let pendingGifts = userData.pendingGifts || [];
            const giftsShowcase = userData.giftsShowcase || {};
            
            // Р СњР В°РЎвЂ¦Р С•Р Т‘Р С‘Р С Р С‘ РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С Р С‘Р В· pending
            const giftIndex = pendingGifts.findIndex(g => g.id === giftId && g.fromName === senderName);
            if (giftIndex > -1) {
                pendingGifts.splice(giftIndex, 1);
            }
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р† Р Р†Р С‘РЎвЂљРЎР‚Р С‘Р Р…РЎС“
            giftsShowcase[giftId] = (giftsShowcase[giftId] || 0) + 1;
            
            await setDoc(userRef, {
                giftsShowcase: giftsShowcase,
                pendingGifts: pendingGifts
            }, { merge: true });
            
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р Р†Р ВµРЎР‚Р В»Р ВµР в„–
            const overlay = document.getElementById('gift-choice-overlay');
            if (overlay) {
                overlay.style.animation = 'gift-overlay-in 0.3s ease-out reverse';
                setTimeout(() => overlay.remove(), 300);
            }
            
            showToast('Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С” Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р… Р Р† Р Р†Р С‘РЎвЂљРЎР‚Р С‘Р Р…РЎС“!', 'СЂСџРЏвЂ ');
            
        } catch (e) {
            console.error('Keep gift error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В°', 'РІСњРЉ');
        }
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ РЎвЂљР С•Р Р†Р В°РЎР‚Р С•Р Р† Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ
    function updateShopItems() {
        const ownedItems = me?.ownedItems || [];
        const ownedFrames = me?.ownedFrames || ['none'];
        const ownedStyles = me?.ownedStyles || ['default'];
        
        document.querySelectorAll('.ruby-shop-item').forEach(item => {
            const itemId = item.dataset.item;
            const priceBtn = item.querySelector('.ruby-shop-item-price');
            if (!priceBtn || !itemId) return;
            
            // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ owned Р С‘ discounted
            item.classList.remove('owned');
            priceBtn.classList.remove('owned');
            delete priceBtn.dataset.discounted;
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С•Р В±РЎвЂ№РЎвЂЎР Р…РЎвЂ№Р Вµ РЎвЂљР С•Р Р†Р В°РЎР‚РЎвЂ№
            if (ownedItems.includes(itemId)) {
                item.classList.add('owned');
                priceBtn.classList.add('owned');
                priceBtn.innerHTML = '<i class="fas fa-check"></i> Р С™РЎС“Р С—Р В»Р ВµР Р…Р С•';
                return;
            }
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎР‚Р В°Р СР С”Р С‘
            if (itemId.startsWith('frame-')) {
                const frameName = itemId.replace('frame-', '');
                if (ownedFrames.includes(frameName)) {
                    item.classList.add('owned');
                    priceBtn.classList.add('owned');
                    if (me?.avatarFrame === frameName) {
                        priceBtn.innerHTML = '<i class="fas fa-check-circle"></i> Р С’Р С”РЎвЂљР С‘Р Р†Р Р…Р С•';
                    } else {
                        priceBtn.innerHTML = '<i class="fas fa-check"></i> Р вЂ™РЎвЂ№Р В±РЎР‚Р В°РЎвЂљРЎРЉ';
                    }
                    return;
                }
            }
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎРѓРЎвЂљР С‘Р В»Р С‘
            if (itemId.startsWith('style-')) {
                const styleName = itemId.replace('style-', '');
                if (ownedStyles.includes(styleName)) {
                    item.classList.add('owned');
                    priceBtn.classList.add('owned');
                    if (me?.chatStyle === styleName) {
                        priceBtn.innerHTML = '<i class="fas fa-check-circle"></i> Р С’Р С”РЎвЂљР С‘Р Р†Р Р…Р С•';
                    } else {
                        priceBtn.innerHTML = '<i class="fas fa-check"></i> Р вЂ™РЎвЂ№Р В±РЎР‚Р В°РЎвЂљРЎРЉ';
                    }
                    return;
                }
            }
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В±Р В°Р В»Р В°Р Р…РЎРѓ Р Р† Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р Вµ
        const shopRubies = document.getElementById('shop-rubies-count');
        if (shopRubies) shopRubies.textContent = (me?.rubies || 0).toFixed(2);
    }
    
    // Р СџР С•Р С”РЎС“Р С—Р С”Р В° РЎвЂљР С•Р Р†Р В°РЎР‚Р В°
    window.buyShopItem = async (itemId, price) => {
        if (!me) return;
        
        const ownedItems = me.ownedItems || [];
        if (ownedItems.includes(itemId)) {
            showToast('Р Р€ РЎвЂљР ВµР В±РЎРЏ РЎС“Р В¶Р Вµ Р ВµРЎРѓРЎвЂљРЎРЉ РЎРЊРЎвЂљР С•РЎвЂљ Р С—РЎР‚Р ВµР Т‘Р СР ВµРЎвЂљ!', 'РІСљвЂ¦');
            return;
        }
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎРѓР С”Р С‘Р Т‘Р С”РЎС“ Premium
        const finalPrice = applyPremiumDiscount(price);
        const discountText = hasPremium() ? ` (РЎРѓР С”Р С‘Р Т‘Р С”Р В° 25%: Р В±РЎвЂ№Р В»Р С• ${price}СЂСџвЂ™Р‹)` : '';
        
        if ((me.rubies || 0) < finalPrice) {
            showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${finalPrice}`, 'СЂСџвЂ™Р‹');
            return;
        }
        
        // Р РЋР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№
        me.rubies = (me.rubies || 0) - finalPrice;
        me.ownedItems = [...ownedItems, itemId];
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Firebase
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
            rubies: me.rubies,
            ownedItems: me.ownedItems
        }, { merge: true });
        
        updateRubiesDisplay();
        updateShopItems();
        
        // Р С›Р В±РЎР‚Р В°Р В±Р В°РЎвЂљРЎвЂ№Р Р†Р В°Р ВµР С Р С—Р С•Р С”РЎС“Р С—Р С”РЎС“
        if (itemId === 'admin-code') {
            showToast(`Р СџР В°РЎР‚Р С•Р В»РЎРЉ Р В°Р Т‘Р СР С‘Р Р…-Р С—Р В°Р Р…Р ВµР В»Р С‘: ${ADMIN_PASSWORD}. Р СћР ВµР С—Р ВµРЎР‚РЎРЉ Р С•Р Р… Р Р†Р С‘Р Т‘Р ВµР Р… Р Р† Р В°Р Т‘Р СР С‘Р Р…-Р С—Р В°Р Р…Р ВµР В»Р С‘!`, 'СЂСџвЂќС’');
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР В°Р С–Р В°Р В·Р С‘Р Р…
            closeRubyShop();
        } else if (itemId.startsWith('avatar-')) {
            me.activeAvatar = itemId;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                activeAvatar: itemId
            }, { merge: true });
            applyAvatarEffect();
            showToast('Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р В°РЎРЏ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р В° Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р В°!', 'СЂСџРЉв‚¬');
        } else if (itemId.startsWith('theme-')) {
            me.activeTheme = itemId;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                activeTheme: itemId
            }, { merge: true });
            applyPremiumTheme();
            showToast('Р Р€Р Р…Р С‘Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•РЎвЂћР С•РЎР‚Р СР В»Р ВµР Р…Р С‘Р Вµ Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С•!', 'РІСљРЃ');
        }
    };
    
    // Р СџР С•Р С”РЎС“Р С—Р С”Р В° РЎР‚Р В°Р СР С”Р С‘ Р С‘Р В· Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р В°
    window.buyFrameFromShop = async (frame, price) => {
        if (!me) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†Р С•Р в„–Р Т‘Р С‘РЎвЂљР Вµ Р Р† Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ', 'РІСњРЉ');
            return;
        }
        
        const ownedFrames = me.ownedFrames || ['none'];
        if (ownedFrames.includes(frame)) {
            // Р Р€Р В¶Р Вµ Р С”РЎС“Р С—Р В»Р ВµР Р…Р В° - Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚РЎС“Р ВµР С
            me.avatarFrame = frame;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                avatarFrame: frame
            }, { merge: true });
            if (window.updateFrameSelection) window.updateFrameSelection(frame);
            if (window.applyAvatarFrame) window.applyAvatarFrame();
            showToast(`Р В Р В°Р СР С”Р В° Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р В°!`, 'РІСљвЂ¦');
            updateShopItems();
            return;
        }
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎРѓР С”Р С‘Р Т‘Р С”РЎС“ Premium
        const finalPrice = applyPremiumDiscount(price);
        const discountText = hasPremium() ? ` (РЎРѓР С”Р С‘Р Т‘Р С”Р В° 25%: Р В±РЎвЂ№Р В»Р С• ${price}СЂСџвЂ™Р‹)` : '';
        
        if ((me.rubies || 0) < finalPrice) {
            showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${finalPrice}СЂСџвЂ™Р‹`, 'РІСњРЉ');
            return;
        }
        
        // Р СџР С•Р С”РЎС“Р С—Р В°Р ВµР С Р В±Р ВµР В· confirm Р Т‘Р В»РЎРЏ Р Р…Р В°Р Т‘РЎвЂР В¶Р Р…Р С•РЎРѓРЎвЂљР С‘
        try {
            // Р РЋР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р С‘ Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎР‚Р В°Р СР С”РЎС“
            ownedFrames.push(frame);
            me.rubies = (me.rubies || 0) - finalPrice;
            me.ownedFrames = ownedFrames;
            me.avatarFrame = frame;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: me.rubies,
                ownedFrames: ownedFrames,
                avatarFrame: frame
            }, { merge: true });
            
            updateRubiesDisplay();
            updateShopItems();
            if (window.updateFrameSelection) window.updateFrameSelection(frame);
            if (window.applyAvatarFrame) window.applyAvatarFrame();
            showToast(`Р В Р В°Р СР С”Р В° Р С”РЎС“Р С—Р В»Р ВµР Р…Р В° Р В·Р В° ${finalPrice}СЂСџвЂ™Р‹${discountText}!`, 'СЂСџР‹вЂ°');
        } catch (e) {
            console.error('Error buying frame:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—Р С•Р С”РЎС“Р С—Р С”Р С‘', 'РІСњРЉ');
        }
    };
    
    // Р СџР С•Р С”РЎС“Р С—Р С”Р В° РЎРѓРЎвЂљР С‘Р В»РЎРЏ Р С‘Р В· Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р В°
    window.buyStyleFromShop = async (style, price) => {
        if (!me) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†Р С•Р в„–Р Т‘Р С‘РЎвЂљР Вµ Р Р† Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ', 'РІСњРЉ');
            return;
        }
        
        const ownedStyles = me.ownedStyles || ['default'];
        if (ownedStyles.includes(style)) {
            // Р Р€Р В¶Р Вµ Р С”РЎС“Р С—Р В»Р ВµР Р… - Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚РЎС“Р ВµР С
            me.chatStyle = style;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                chatStyle: style
            }, { merge: true });
            if (window.updateStyleSelection) window.updateStyleSelection(style);
            if (window.applyChatStyle) window.applyChatStyle();
            showToast(`Р РЋРЎвЂљР С‘Р В»РЎРЉ Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…!`, 'РІСљвЂ¦');
            updateShopItems();
            return;
        }
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎРѓР С”Р С‘Р Т‘Р С”РЎС“ Premium
        const finalPrice = applyPremiumDiscount(price);
        const discountText = hasPremium() ? ` (РЎРѓР С”Р С‘Р Т‘Р С”Р В° 25%: Р В±РЎвЂ№Р В»Р С• ${price}СЂСџвЂ™Р‹)` : '';
        
        if ((me.rubies || 0) < finalPrice) {
            showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${finalPrice}СЂСџвЂ™Р‹`, 'РІСњРЉ');
            return;
        }
        
        try {
            // Р РЋР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р С‘ Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР С‘Р В»РЎРЉ
            ownedStyles.push(style);
            me.rubies = (me.rubies || 0) - finalPrice;
            me.ownedStyles = ownedStyles;
            me.chatStyle = style;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: me.rubies,
                ownedStyles: ownedStyles,
                chatStyle: style
            }, { merge: true });
            
            updateRubiesDisplay();
            updateShopItems();
            if (window.updateStyleSelection) window.updateStyleSelection(style);
            if (window.applyChatStyle) window.applyChatStyle();
            showToast(`Р РЋРЎвЂљР С‘Р В»РЎРЉ Р С”РЎС“Р С—Р В»Р ВµР Р… Р В·Р В° ${finalPrice}СЂСџвЂ™Р‹${discountText}!`, 'СЂСџР‹вЂ°');
        } catch (e) {
            console.error('Error buying style:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—Р С•Р С”РЎС“Р С—Р С”Р С‘', 'РІСњРЉ');
        }
    };
    
    // Р СџРЎР‚Р С‘Р СР ВµР Р…Р С‘РЎвЂљРЎРЉ РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘
    function applyAvatarEffect() {
        const avatars = document.querySelectorAll('#my-avatar, #settings-avatar');
        avatars.forEach(avatar => {
            avatar.classList.remove('animated-avatar');
            if (me?.activeAvatar) {
                avatar.classList.add('animated-avatar');
            }
        });
    }
    
    // Р СџРЎР‚Р С‘Р СР ВµР Р…Р С‘РЎвЂљРЎРЉ Р С—РЎР‚Р ВµР СР С‘РЎС“Р С РЎвЂљР ВµР СРЎС“
    function applyPremiumTheme() {
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer) return;
        
        messagesContainer.classList.remove('premium-chat-bg', 'premium-messages');
        
        if (me?.activeTheme === 'theme-premium') {
            messagesContainer.classList.add('premium-chat-bg', 'premium-messages');
        }
    }
    
    // Р С›РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С—Р В°Р Р…Р ВµР В»РЎРЉ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ (Р В±Р С•Р С”Р С•Р Р†РЎС“РЎР‹ Р Р† Р В°Р Т‘Р СР С‘Р Р…Р С”Р Вµ)
    let isCreatorMode = false;
    let selectedCreatorUser = null;
    
    window.openCreatorPanel = () => {
        isCreatorMode = true;
        const sidebar = document.getElementById('creator-sidebar');
        if (sidebar) {
            sidebar.classList.remove('hidden');
            sidebar.style.display = 'flex';
        }
    };
    
    // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С—Р В°Р Р…Р ВµР В»РЎРЉ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ
    window.closeCreatorPanel = () => {
        isCreatorMode = false;
        selectedCreatorUser = null;
        const sidebar = document.getElementById('creator-sidebar');
        if (sidebar) {
            sidebar.classList.add('hidden');
            sidebar.style.display = 'none';
        }
        document.getElementById('creator-selected-user-container')?.classList.add('hidden');
        document.getElementById('creator-user-rubies').textContent = '0.00';
        document.getElementById('creator-user-search').value = '';
        document.getElementById('creator-user-results').classList.add('hidden');
    };
    
    // Р вЂ™РЎвЂ№Р В±РЎР‚Р В°РЎвЂљРЎРЉ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ Р Т‘Р В»РЎРЏ Р Р…Р В°Р С”РЎР‚РЎС“РЎвЂљР С”Р С‘ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
    window.selectUserForRubies = (userId, username, rubies) => {
        selectedCreatorUser = { id: userId, username, rubies: rubies || 0 };
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р Р†РЎвЂ№Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С• Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
        document.getElementById('creator-selected-user-container').classList.remove('hidden');
        document.getElementById('creator-selected-user').innerHTML = `
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs font-bold">${username[0].toUpperCase()}</div>
                <span class="font-bold">@${username}</span>
            </div>
        `;
        document.getElementById('creator-user-rubies').textContent = (rubies || 0).toFixed(2);
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎР‚Р ВµР В·РЎС“Р В»РЎРЉРЎвЂљР В°РЎвЂљРЎвЂ№ Р С—Р С•Р С‘РЎРѓР С”Р В°
        document.getElementById('creator-user-results').classList.add('hidden');
        document.getElementById('creator-user-search').value = '';
    };
    
    // Р СџР С•Р С‘РЎРѓР С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„– Р Т‘Р В»РЎРЏ Р С—Р В°Р Р…Р ВµР В»Р С‘ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ
    window.searchCreatorUsers = (query) => {
        const results = document.getElementById('creator-user-results');
        
        if (!query.trim()) {
            results.classList.add('hidden');
            return;
        }
        
        const filtered = allUsers.filter(u => 
            !u.deleted && u.username?.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 5);
        
        if (filtered.length === 0) {
            results.innerHTML = '<p class="p-3 text-xs text-slate-400 text-center">Р СњР Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•</p>';
        } else {
            results.innerHTML = filtered.map(user => `
                <div class="flex items-center gap-2 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer rounded-lg m-1" onclick="selectUserForRubies('${user.id}', '${user.username}', ${user.rubies || 0})">
                    <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs font-bold">
                        ${user.avatar ? `<img src="${user.avatar}" class="w-full h-full object-cover rounded-full">` : user.username[0].toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm truncate">@${user.username}</p>
                        <p class="text-[10px] text-red-500"><i class="fas fa-gem"></i> ${(user.rubies || 0).toFixed(2)}</p>
                    </div>
                </div>
            `).join('');
        }
        
        results.classList.remove('hidden');
    };
    
    // Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р Р†РЎвЂ№Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р СРЎС“ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎР‹
    window.creatorAddRubiesToUser = async () => {
        if (!selectedCreatorUser) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ', 'РІСњРЉ');
            return;
        }
        
        const input = document.getElementById('creator-add-amount');
        const amount = parseFloat(input.value);
        
        if (isNaN(amount) || amount <= 0) {
            showToast('Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р С”Р С•РЎР‚РЎР‚Р ВµР С”РЎвЂљР Р…Р С•Р Вµ Р С”Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С•', 'РІСњРЉ');
            return;
        }
        
        const newBalance = (selectedCreatorUser.rubies || 0) + amount;
        
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', selectedCreatorUser.id), {
            rubies: newBalance
        }, { merge: true });
        
        selectedCreatorUser.rubies = newBalance;
        document.getElementById('creator-user-rubies').textContent = newBalance.toFixed(2);
        input.value = '';
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
        await loadAllUsers();
        
        showToast(`Р вЂќР С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С• ${amount} РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р Т‘Р В»РЎРЏ @${selectedCreatorUser.username}!`, 'СЂСџвЂ™Р‹');
    };
    
    // Р вЂРЎвЂ№РЎРѓРЎвЂљРЎР‚Р С•Р Вµ Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
    window.creatorQuickAdd = async (amount) => {
        if (!selectedCreatorUser) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ', 'РІСњРЉ');
            return;
        }
        
        const newBalance = (selectedCreatorUser.rubies || 0) + amount;
        
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', selectedCreatorUser.id), {
            rubies: newBalance
        }, { merge: true });
        
        selectedCreatorUser.rubies = newBalance;
        document.getElementById('creator-user-rubies').textContent = newBalance.toFixed(2);
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
        await loadAllUsers();
        
        showToast(`+${amount} СЂСџвЂ™Р‹ Р Т‘Р В»РЎРЏ @${selectedCreatorUser.username}!`, 'РІСљвЂ¦');
    };
    
    // Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
    window.creatorDeleteUserAccount = async () => {
        if (!selectedCreatorUser) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ', 'РІСњРЉ');
            return;
        }
        
        const username = selectedCreatorUser.username;
        const uid = selectedCreatorUser.id;
        
        // Р СџР С•Р Т‘РЎвЂљР Р†Р ВµРЎР‚Р В¶Р Т‘Р ВµР Р…Р С‘Р Вµ
        if (!confirm(`Р вЂ™РЎвЂ№ РЎС“Р Р†Р ВµРЎР‚Р ВµР Р…РЎвЂ№ РЎвЂЎРЎвЂљР С• РЎвЂ¦Р С•РЎвЂљР С‘РЎвЂљР Вµ Р Р€Р вЂќР С’Р вЂєР ВР СћР В¬ Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ @${username}?\n\nР В­РЎвЂљР С• Р Т‘Р ВµР в„–РЎРѓРЎвЂљР Р†Р С‘Р Вµ Р Р…Р ВµР С•Р В±РЎР‚Р В°РЎвЂљР С‘Р СР С•!`)) {
            return;
        }
        
        try {
            // Р СџР С•Р СР ВµРЎвЂЎР В°Р ВµР С Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ Р С”Р В°Р С” РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…Р С•Р С–Р С•
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                deleted: true,
                deletedAt: serverTimestamp()
            }, { merge: true });
            
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
            try {
                const storyRef = doc(db, 'artifacts', appId, 'public', 'data', 'stories', uid);
                await deleteDoc(storyRef);
            } catch (storyErr) {
                console.log('No story to delete or error:', storyErr);
            }
            
            // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С Р Р†РЎвЂ№Р В±Р С•РЎР‚
            selectedCreatorUser = null;
            document.getElementById('creator-selected-user-container').classList.add('hidden');
            document.getElementById('creator-user-rubies').textContent = '0.00';
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С”
            await loadAllUsers();
            
            showToast(`Р С’Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ @${username} РЎС“Р Т‘Р В°Р В»РЎвЂР Р…`, 'РІСљвЂ¦');
        } catch (e) {
            console.error('Failed to delete user:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ: ' + e.message, 'РІСњРЉ');
        }
    };
    
    // Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С”Р В° РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР С•Р Р† РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
    window.cleanDeletedUsersStories = async () => {
        try {
            // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р Р†РЎРѓР ВµРЎвЂ¦ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
            const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            const deletedUserIds = [];
            
            usersSnap.forEach(d => {
                const user = d.data();
                if (user.deleted === true) {
                    deletedUserIds.push(d.id);
                }
            });
            
            if (deletedUserIds.length === 0) {
                showToast('Р СњР ВµРЎвЂљ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–', 'СЂСџвЂњВ­');
                return;
            }
            
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓРЎвЂ№ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
            let deletedCount = 0;
            for (const uid of deletedUserIds) {
                try {
                    const storyRef = doc(db, 'artifacts', appId, 'public', 'data', 'stories', uid);
                    const storySnap = await getDoc(storyRef);
                    if (storySnap.exists()) {
                        await deleteDoc(storyRef);
                        deletedCount++;
                    }
                } catch (e) {
                    console.log('Error deleting story for', uid, e);
                }
            }
            
            showToast(`Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С• ${deletedCount} РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР С•Р Р†`, 'СЂСџвЂ”вЂРїС‘РЏ');
        } catch (e) {
            console.error('Error cleaning stories:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•РЎвЂЎР С‘РЎРѓРЎвЂљР С”Р С‘', 'РІСњРЉ');
        }
    };
    
    // Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ РЎРѓР ВµР В±Р Вµ (РЎРѓРЎвЂљР В°РЎР‚Р В°РЎРЏ РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ Р Т‘Р В»РЎРЏ РЎРѓР С•Р Р†Р СР ВµРЎРѓРЎвЂљР С‘Р СР С•РЎРѓРЎвЂљР С‘)
    window.creatorAddRubies = async () => {
        const input = document.getElementById('creator-add-rubies');
        if (!input) return;
        const amount = parseFloat(input.value);
        
        if (isNaN(amount) || amount <= 0) {
            showToast('Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р С”Р С•РЎР‚РЎР‚Р ВµР С”РЎвЂљР Р…Р С•Р Вµ Р С”Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С•', 'РІСњРЉ');
            return;
        }
        
        me.rubies = (me.rubies || 0) + amount;
        
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
            rubies: me.rubies
        }, { merge: true });
        
        updateRubiesDisplay();
        input.value = '';
        showToast(`Р вЂќР С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С• ${amount} РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†!`, 'СЂСџвЂ™Р‹');
    };
    
    // ========== Р Р€Р СћР ВР вЂєР ВР СћР В« Р С›Р СџР СћР ВР СљР ВР вЂ”Р С’Р В¦Р ВР В ==========
    // Debounce Р Т‘Р В»РЎРЏ Р С—РЎР‚Р ВµР Т‘Р С•РЎвЂљР Р†РЎР‚Р В°РЎвЂ°Р ВµР Р…Р С‘РЎРЏ РЎвЂЎР В°РЎРѓРЎвЂљРЎвЂ№РЎвЂ¦ Р Р†РЎвЂ№Р В·Р С•Р Р†Р С•Р Р†
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Throttle Р Т‘Р В»РЎРЏ Р С•Р С–РЎР‚Р В°Р Р…Р С‘РЎвЂЎР ВµР Р…Р С‘РЎРЏ РЎвЂЎР В°РЎРѓРЎвЂљР С•РЎвЂљРЎвЂ№ Р Р†РЎвЂ№Р В·Р С•Р Р†Р С•Р Р†
    function throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }
    
    // Р С›Р С—РЎвЂљР С‘Р СР С‘Р В·Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– requestAnimationFrame Р Т‘Р В»РЎРЏ РЎРѓР С”РЎР‚Р С•Р В»Р В»Р В°
    function smoothScrollTo(element, target) {
        if (isMobileView) {
            // Р СњР В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ - Р СР С–Р Р…Р С•Р Р†Р ВµР Р…Р Р…РЎвЂ№Р в„– РЎРѓР С”РЎР‚Р С•Р В»Р В»
            element.scrollTop = target;
        } else {
            element.scrollTo({ top: target, behavior: 'smooth' });
        }
    }
    
    // ========== Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…Р В°РЎРЏ Р Р…Р В°Р Р†Р С‘Р С–Р В°РЎвЂ Р С‘РЎРЏ (Telegram-style) ==========
    const checkMobileView = debounce(() => {
        isMobileView = window.innerWidth <= 768;
        
        if (!isMobileView) {
            // Р СњР В° Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—Р Вµ РЎС“Р В±Р С‘РЎР‚Р В°Р ВµР С Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р С”Р В»Р В°РЎРѓРЎРѓРЎвЂ№
            document.querySelector('#main-app > aside')?.classList.remove('mobile-hidden');
            document.querySelector('#main-app > main')?.classList.remove('mobile-visible');
        }
    }, 100);
    
    window.addEventListener('resize', checkMobileView, { passive: true });
    
    function mobileShowChat() {
        if (!isMobileView) return;
        
        const sidebar = document.querySelector('#main-app > aside');
        const chatArea = document.querySelector('#main-app > main');
        
        sidebar?.classList.add('mobile-hidden');
        chatArea?.classList.add('mobile-visible');
    }
    
    window.mobileGoBack = function() {
        const sidebar = document.querySelector('#main-app > aside');
        const chatArea = document.querySelector('#main-app > main');
        
        sidebar?.classList.remove('mobile-hidden');
        chatArea?.classList.remove('mobile-visible');
        
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ
        activeChatPartner = null;
        activeGroup = null;
    };
    
    // Р С›Р В±РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р В° Р С”Р Р…Р С•Р С—Р С”Р С‘ "Р СњР В°Р В·Р В°Р Т‘" Р Р…Р В° Android
    window.addEventListener('popstate', (e) => {
        if (isMobileView && document.querySelector('#main-app > main.mobile-visible')) {
            e.preventDefault();
            mobileGoBack();
        }
    });
    
    // ========== Р С›Р Р…Р В»Р В°Р в„–Р Р… РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ ==========
    async function updateOnlineStatus(isOnline = true) {
        if (!me) return;
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                isOnline: isOnline,
                lastSeen: serverTimestamp()
            }, { merge: true });
        } catch (err) {
            console.log('Error updating online status:', err);
        }
    }
    
    function startOnlineStatusUpdates() {
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ РЎРѓРЎР‚Р В°Р В·РЎС“
        updateOnlineStatus(true);
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С”Р В°Р В¶Р Т‘РЎвЂ№Р Вµ 30 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘
        onlineStatusInterval = setInterval(() => {
            updateOnlineStatus(true);
        }, 30000);
        
        // Р СџРЎР‚Р С‘ Р В·Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р С‘ РЎРѓРЎвЂљРЎР‚Р В°Р Р…Р С‘РЎвЂ РЎвЂ№ - РЎРѓРЎвЂљР В°Р Р†Р С‘Р С Р С•РЎвЂћР В»Р В°Р в„–Р Р…
        window.addEventListener('beforeunload', () => {
            updateOnlineStatus(false);
        });
        
        // Р СџРЎР‚Р С‘ Р С—Р С•РЎвЂљР ВµРЎР‚Р Вµ РЎвЂћР С•Р С”РЎС“РЎРѓР В° - Р Р…Р Вµ Р СР ВµР Р…РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ (Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р СР С•Р В¶Р ВµРЎвЂљ Р Р†Р ВµРЎР‚Р Р…РЎС“РЎвЂљРЎРЉРЎРѓРЎРЏ)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                updateOnlineStatus(true);
            }
        });
    }
    
    function formatLastSeen(timestamp) {
        if (!timestamp) return currentLang === 'ru' ? 'Р Т‘Р В°Р Р†Р Р…Р С•' : 'long ago';
        
        const now = Date.now();
        const lastSeen = timestamp.seconds ? timestamp.seconds * 1000 : timestamp;
        const diff = now - lastSeen;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return currentLang === 'ru' ? 'РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎвЂЎРЎвЂљР С•' : 'just now';
        if (minutes < 60) return currentLang === 'ru' ? `${minutes} Р СР С‘Р Р…. Р Р…Р В°Р В·Р В°Р Т‘` : `${minutes}m ago`;
        if (hours < 24) return currentLang === 'ru' ? `${hours} РЎвЂЎ. Р Р…Р В°Р В·Р В°Р Т‘` : `${hours}h ago`;
        if (days < 7) return currentLang === 'ru' ? `${days} Р Т‘Р Р…. Р Р…Р В°Р В·Р В°Р Т‘` : `${days}d ago`;
        
        return new Date(lastSeen).toLocaleDateString();
    }

    // ========== Р вЂєР С•Р С”Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ ==========
    let currentLang = localStorage.getItem('flickers-lang') || 'ru';

    const translations = {
        ru: {
            // Р С’Р Р†РЎвЂљР С•РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ
            welcome: 'Р вЂќР С•Р В±РЎР‚Р С• Р С—Р С•Р В¶Р В°Р В»Р С•Р Р†Р В°РЎвЂљРЎРЉ',
            aiTagline: 'Р вЂР В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р С”Р С‘ Р Р…Р В°Р С Р Р…Р Вµ РЎРѓРЎвЂљРЎР‚Р В°РЎв‚¬Р Р…РЎвЂ№! СЂСџС™Р‚',
            loginTab: 'Р вЂ™РЎвЂ¦Р С•Р Т‘',
            registerTab: 'Р В Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ',
            welcomeBack: 'Р РЋ Р Р†Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р ВµР Р…Р С‘Р ВµР С!',
            enterCredentials: 'Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р Т‘Р В»РЎРЏ Р Р†РЎвЂ¦Р С•Р Т‘Р В°',
            createAccount: 'Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљ',
            fillToRegister: 'Р вЂ”Р В°Р С—Р С•Р В»Р Р…Р С‘РЎвЂљР Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р Т‘Р В»РЎРЏ РЎР‚Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘',
            username: 'Р ВР СРЎРЏ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ',
            password: 'Р СџР В°РЎР‚Р С•Р В»РЎРЉ',
            confirmPassword: 'Р СџР С•Р Т‘РЎвЂљР Р†Р ВµРЎР‚Р Т‘Р С‘РЎвЂљР Вµ Р С—Р В°РЎР‚Р С•Р В»РЎРЉ',
            loginBtn: 'Р вЂ™Р С•Р в„–РЎвЂљР С‘',
            registerBtn: 'Р вЂ”Р В°РЎР‚Р ВµР С–Р С‘РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉРЎРѓРЎРЏ',
            userNotFound: 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…',
            wrongPassword: 'Р СњР ВµР Р†Р ВµРЎР‚Р Р…РЎвЂ№Р в„– Р С—Р В°РЎР‚Р С•Р В»РЎРЉ',
            userExists: 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎС“Р В¶Р Вµ РЎРѓРЎС“РЎвЂ°Р ВµРЎРѓРЎвЂљР Р†РЎС“Р ВµРЎвЂљ',
            passwordsDontMatch: 'Р СџР В°РЎР‚Р С•Р В»Р С‘ Р Р…Р Вµ РЎРѓР С•Р Р†Р С—Р В°Р Т‘Р В°РЎР‹РЎвЂљ',
            passwordTooShort: 'Р СџР В°РЎР‚Р С•Р В»РЎРЉ Р Т‘Р С•Р В»Р В¶Р ВµР Р… Р В±РЎвЂ№РЎвЂљРЎРЉ Р СР С‘Р Р…Р С‘Р СРЎС“Р С 6 РЎРѓР С‘Р СР Р†Р С•Р В»Р С•Р Р†',
            usernameTooShort: 'Р ВР СРЎРЏ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ Р СР С‘Р Р…Р С‘Р СРЎС“Р С 3 РЎРѓР С‘Р СР Р†Р С•Р В»Р В°',
            
            // Р вЂР С•Р С”Р С•Р Р†Р В°РЎРЏ Р С—Р В°Р Р…Р ВµР В»РЎРЉ
            searchNickname: 'Р СџР С•Р С‘РЎРѓР С” Р Р…Р С‘Р С”Р В°...',
            online: 'Р вЂ™ РЎРѓР ВµРЎвЂљР С‘',
            loading: 'Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В°...',
            selectContact: 'Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С”Р С•Р Р…РЎвЂљР В°Р С”РЎвЂљ',
            noOneFound: 'Р СњР С‘Р С”РЎвЂљР С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…',
            now: 'РЎРѓР ВµР в„–РЎвЂЎР В°РЎРѓ',
            
            // Р В§Р В°РЎвЂљ
            writeMessage: 'Р СњР В°Р С—Р С‘РЎв‚¬Р С‘РЎвЂљР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ...',
            audioCall: 'Р С’РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С•Р С”',
            videoCall: 'Р вЂ™Р С‘Р Т‘Р ВµР С• Р В·Р Р†Р С•Р Р…Р С•Р С”',
            
            // Р вЂ”Р Р†Р С•Р Р…Р С”Р С‘
            incomingCall: 'Р вЂ™РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”',
            calling: 'Р вЂ”Р Р†Р С•Р Р…Р С‘Р С...',
            waitingAnswer: 'Р С›Р В¶Р С‘Р Т‘Р В°Р Р…Р С‘Р Вµ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°',
            call: 'Р вЂ”Р Р†Р С•Р Р…Р С•Р С”',
            decline: 'Р С›РЎвЂљР С”Р В»Р С•Р Р…Р С‘РЎвЂљРЎРЉ',
            accept: 'Р СџРЎР‚Р С‘Р Р…РЎРЏРЎвЂљРЎРЉ',
            cancelCall: 'Р С›РЎвЂљР СР ВµР Р…Р В°',
            audioCallType: 'Р С’РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С•Р С”',
            videoCallType: 'Р вЂ™Р С‘Р Т‘Р ВµР С• Р В·Р Р†Р С•Р Р…Р С•Р С”',
            flickersCall: 'Flickers Р В·Р Р†Р С•Р Р…Р С•Р С”',
            
            // Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘
            settings: 'Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘',
            profile: 'Р СџРЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ',
            clickToChange: 'Р СњР В°Р В¶Р СР С‘РЎвЂљР Вµ Р Р…Р В° Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ Р Т‘Р В»РЎРЏ Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ',
            bio: 'Р С› РЎРѓР ВµР В±Р Вµ',
            bioPlaceholder: 'Р В Р В°РЎРѓРЎРѓР С”Р В°Р В¶Р С‘РЎвЂљР Вµ Р С• РЎРѓР ВµР В±Р Вµ...',
            gender: 'Р СџР С•Р В»',
            male: 'Р СљРЎС“Р В¶РЎРѓР С”Р С•Р в„–',
            female: 'Р вЂ“Р ВµР Р…РЎРѓР С”Р С‘Р в„–',
            other: 'Р вЂќРЎР‚РЎС“Р С–Р С•Р в„–',
            hideProfile: 'Р РЋР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ',
            hideProfileDesc: 'Р вЂќРЎР‚РЎС“Р С–Р С‘Р Вµ Р Р…Р Вµ РЎС“Р Р†Р С‘Р Т‘РЎРЏРЎвЂљ Р Р†Р В°РЎв‚¬ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ',
            interface: 'Р ВР Р…РЎвЂљР ВµРЎР‚РЎвЂћР ВµР в„–РЎРѓ',
            lightTheme: 'Р РЋР Р†Р ВµРЎвЂљР В»Р В°РЎРЏ РЎвЂљР ВµР СР В°',
            darkTheme: 'Р СћР ВµР СР Р…Р В°РЎРЏ РЎвЂљР ВµР СР В°',
            cosmicTheme: 'Р С™Р С•РЎРѓР СР С‘РЎвЂЎР ВµРЎРѓР С”Р В°РЎРЏ',
            chatWallpaper: 'Р С›Р В±Р С•Р С‘ РЎвЂЎР В°РЎвЂљР В°',
            newYearDecor: 'Р СњР С•Р Р†Р С•Р С–Р С•Р Т‘Р Р…Р ВµР Вµ Р С•РЎвЂћР С•РЎР‚Р СР В»Р ВµР Р…Р С‘Р Вµ',
            showNewYearDecor: 'Р вЂњР С‘РЎР‚Р В»РЎРЏР Р…Р Т‘Р В° Р С‘ РЎРѓР Р…Р ВµР В¶Р С‘Р Р…Р С”Р С‘',
            
            // Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…Р С•РЎРѓРЎвЂљРЎРЉ
            privacy: 'Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…Р С•РЎРѓРЎвЂљРЎРЉ',
            anonymousMode: 'Р С’Р Р…Р С•Р Р…Р С‘Р СР Р…РЎвЂ№Р в„– РЎР‚Р ВµР В¶Р С‘Р С',
            hideOnlineStatus: 'Р РЋР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ Р С•Р Р…Р В»Р В°Р в„–Р Р…',
            e2eEncryption: 'Р РЃР С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ E2E',
            blockScreenshots: 'Р вЂР В»Р С•Р С”. РЎРѓР С”РЎР‚Р С‘Р Р…РЎв‚¬Р С•РЎвЂљРЎвЂ№',
            privacyNote: 'Р вЂ™РЎРѓР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ РЎв‚¬Р С‘РЎвЂћРЎР‚РЎС“РЎР‹РЎвЂљРЎРѓРЎРЏ Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С• Р С—Р ВµРЎР‚Р ВµР Т‘ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р С•Р в„–. Р СњР С‘Р С”РЎвЂљР С•, Р Р†Р С”Р В»РЎР‹РЎвЂЎР В°РЎРЏ РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚, Р Р…Р Вµ Р СР С•Р В¶Р ВµРЎвЂљ Р С—РЎР‚Р С•РЎвЂЎР С‘РЎвЂљР В°РЎвЂљРЎРЉ Р Р†Р В°РЎв‚¬Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ.',
            
            // Р С’Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ
            autoDelete: 'Р С’Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ',
            off: 'Р вЂ™РЎвЂ№Р С”Р В»',
            autoDeleteNote: 'Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р В°Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ РЎС“Р Т‘Р В°Р В»РЎРЏРЎвЂљРЎРѓРЎРЏ Р С—Р С•РЎРѓР В»Р Вµ Р С—РЎР‚Р С•РЎвЂЎРЎвЂљР ВµР Р…Р С‘РЎРЏ',
            
            // Р Р‡Р В·РЎвЂ№Р С”
            language: 'Р Р‡Р В·РЎвЂ№Р С”',
            russian: 'Р В РЎС“РЎРѓРЎРѓР С”Р С‘Р в„–',
            english: 'English',
            
            // Р С™Р Р…Р С•Р С—Р С”Р С‘
            checkUpdates: 'Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С‘РЎвЂљРЎРЉ Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ',
            logout: 'Р вЂ™РЎвЂ№Р в„–РЎвЂљР С‘ Р С‘Р В· Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљР В°',
            
            // Р В¤Р В°Р в„–Р В»РЎвЂ№
            preparingFile: 'Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° РЎвЂћР В°Р в„–Р В»Р В° (100MB Р СР В°Р С”РЎРѓ)...',
            downloadFile: 'Р РЋР С”Р В°РЎвЂЎР В°РЎвЂљРЎРЉ РЎвЂћР В°Р в„–Р В»',
            fileTooLarge: 'Р В Р В°Р В·Р СР ВµРЎР‚ РЎвЂћР В°Р в„–Р В»Р В° Р С•Р С–РЎР‚Р В°Р Р…Р С‘РЎвЂЎР ВµР Р… 1 Р СљР вЂ Р С‘Р В·-Р В·Р В° Р В»Р С‘Р СР С‘РЎвЂљР В° Р В±Р В°Р В·РЎвЂ№ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦.',
            
            // Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†РЎвЂ№Р Вµ
            voiceTooLong: 'Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С Р Т‘Р В»Р С‘Р Р…Р Р…Р С•Р Вµ (Р СР В°Р С”РЎРѓ ~1 Р СР С‘Р Р…РЎС“РЎвЂљР В°)',
            micAccessError: 'Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…РЎС“',
            
            // Р РЃР С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ
            encrypted: 'Р вЂ”Р В°РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С•',
            anonymous: 'Р С’Р Р…Р С•Р Р…Р С‘Р С',
            screenshotsBlocked: 'Р РЋР С”РЎР‚Р С‘Р Р…РЎв‚¬Р С•РЎвЂљРЎвЂ№ Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…РЎвЂ№ Р Р† РЎРЊРЎвЂљР С•Р С РЎвЂЎР В°РЎвЂљР Вµ',
            
            // Р С’Р Р†Р В°РЎвЂљР В°РЎР‚
            avatarTooLarge: 'Р С’Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р В° РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С Р В±Р С•Р В»РЎРЉРЎв‚¬Р В°РЎРЏ. Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 1MB.',
            selectImage: 'Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С‘Р В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ',
            
            // Р В­Р СР С•Р Т‘Р В·Р С‘ Р С”Р В°РЎвЂљР ВµР С–Р С•РЎР‚Р С‘Р С‘
            emojiSmileys: 'Р РЋР СР В°Р в„–Р В»РЎвЂ№',
            emojiGestures: 'Р вЂ“Р ВµРЎРѓРЎвЂљРЎвЂ№',
            emojiPeople: 'Р вЂєРЎР‹Р Т‘Р С‘',
            emojiAnimals: 'Р вЂ“Р С‘Р Р†Р С•РЎвЂљР Р…РЎвЂ№Р Вµ',
            emojiFood: 'Р вЂўР Т‘Р В°',
            emojiActivities: 'Р С’Р С”РЎвЂљР С‘Р Р†Р Р…Р С•РЎРѓРЎвЂљР С‘',
            emojiTravel: 'Р СџРЎС“РЎвЂљР ВµРЎв‚¬Р ВµРЎРѓРЎвЂљР Р†Р С‘РЎРЏ',
            emojiObjects: 'Р С›Р В±РЎР‰Р ВµР С”РЎвЂљРЎвЂ№',
            emojiSymbols: 'Р РЋР С‘Р СР Р†Р С•Р В»РЎвЂ№',
            emojiFlags: 'Р В¤Р В»Р В°Р С–Р С‘',
            searchEmoji: 'Р СџР С•Р С‘РЎРѓР С” РЎРЊР СР С•Р Т‘Р В·Р С‘...',
            searchResults: 'Р В Р ВµР В·РЎС“Р В»РЎРЉРЎвЂљР В°РЎвЂљРЎвЂ№ Р С—Р С•Р С‘РЎРѓР С”Р В°',
            nothingFound: 'Р СњР С‘РЎвЂЎР ВµР С–Р С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•',
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ
            version: 'Р вЂ™Р ВµРЎР‚РЎРѓР С‘РЎРЏ',
            runUpdater: 'Р вЂ”Р В°Р С—РЎС“РЎРѓРЎвЂљР С‘РЎвЂљР Вµ Flickers-Updater.exe Р Т‘Р В»РЎРЏ Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р С‘ Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р в„–',
            forUpdate: 'Р вЂќР В»РЎРЏ Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ РЎРѓР С”Р В°РЎвЂЎР В°Р в„–РЎвЂљР Вµ Flickers-Updater.exe',
            
            // Р С’Р Т‘Р СР С‘Р Р…-Р С—Р В°Р Р…Р ВµР В»РЎРЉ
            adminPanel: 'Р С’Р Т‘Р СР С‘Р Р… Р С—Р В°Р Р…Р ВµР В»РЎРЉ',
            userManagement: 'Р Р€Р С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏР СР С‘',
            enterAdminPassword: 'Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р С—Р В°РЎР‚Р С•Р В»РЎРЉ Р В°Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚Р В°',
            wrongAdminPassword: 'Р СњР ВµР Р†Р ВµРЎР‚Р Р…РЎвЂ№Р в„– Р С—Р В°РЎР‚Р С•Р В»РЎРЉ',
            access: 'Р вЂ™Р С•Р в„–РЎвЂљР С‘',
            searchUsers: 'Р СџР С•Р С‘РЎРѓР С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–...',
            usersTotal: 'Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„– Р Р†РЎРѓР ВµР С–Р С•',
            noUsersFound: 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р С‘ Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…РЎвЂ№',
            restore: 'Р вЂ™Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ',
            delete: 'Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ',
            userDeleted: 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…',
            userRestored: 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р Р†Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»РЎвЂР Р…',
            
            // Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
            notifications: 'Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ',
            enableNotifications: 'Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ',
            newMessage: 'Р СњР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ',
            
            // Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
            editMessage: 'Р В Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ',
            deleteMessage: 'Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ',
            deleteForMe: 'Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ РЎС“ РЎРѓР ВµР В±РЎРЏ',
            deleteForAll: 'Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ РЎС“ Р Р†РЎРѓР ВµРЎвЂ¦',
            edited: 'Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С•',
            messageDeleted: 'Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С•',
            editMessageTitle: 'Р В Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ',
            save: 'Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р С‘РЎвЂљРЎРЉ',
            cancel: 'Р С›РЎвЂљР СР ВµР Р…Р В°',
            
            // AI
            aiGenerateReply: 'Р РЋР С–Р ВµР Р…Р ВµРЎР‚Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р С•РЎвЂљР Р†Р ВµРЎвЂљ',
            aiImproveText: 'Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р С‘РЎвЂљРЎРЉ РЎвЂљР ВµР С”РЎРѓРЎвЂљ',
            aiSummarize: 'Р РЋРЎС“Р СР СР С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ РЎР‚Р В°Р В·Р С–Р С•Р Р†Р С•РЎР‚',
            aiTranslate: 'Р СџР ВµРЎР‚Р ВµР Р†Р ВµРЎРѓРЎвЂљР С‘',
            aiThinking: 'AI Р Т‘РЎС“Р СР В°Р ВµРЎвЂљ...',
            aiUse: 'Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљРЎРЉ',
            aiCopy: 'Р С™Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ',
            aiError: 'Р С›РЎв‚¬Р С‘Р В±Р С”Р В° AI. Р СџР С•Р С—РЎР‚Р С•Р В±РЎС“Р в„–РЎвЂљР Вµ Р С—Р С•Р В·Р В¶Р Вµ.',
            aiNoMessages: 'Р СњР ВµРЎвЂљ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– Р Т‘Р В»РЎРЏ Р В°Р Р…Р В°Р В»Р С‘Р В·Р В°',
            aiEnterText: 'Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ РЎвЂљР ВµР С”РЎРѓРЎвЂљ Р Т‘Р В»РЎРЏ РЎС“Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р С‘РЎРЏ',
            aiCopied: 'Р РЋР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С•!',
            
            // Р СљР ВµР Р…РЎР‹ РЎвЂЎР В°РЎвЂљР В°
            searchInChat: 'Р СџР С•Р С‘РЎРѓР С” Р Р† РЎвЂЎР В°РЎвЂљР Вµ',
            mediaFiles: 'Р СљР ВµР Т‘Р С‘Р В°РЎвЂћР В°Р в„–Р В»РЎвЂ№',
            muteNotifications: 'Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ',
            unmuteNotifications: 'Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ',
            clearHistory: 'Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹',
            blockUser: 'Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ',
            unblockUser: 'Р В Р В°Р В·Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ',
            
            // Р вЂњРЎР‚РЎС“Р С—Р С—РЎвЂ№
            createGroup: 'Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С–РЎР‚РЎС“Р С—Р С—РЎС“',
            groupName: 'Р СњР В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№...',
            selectedMembers: 'Р вЂ™РЎвЂ№Р В±РЎР‚Р В°Р Р…Р С• РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†',
            searchUsers: 'Р СџР С•Р С‘РЎРѓР С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–...',
            createGroupBtn: 'Р РЋР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ Р С–РЎР‚РЎС“Р С—Р С—РЎС“',
            
            // Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓРЎвЂ№ Р Р…Р В° Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
            chatRequest: 'Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ Р Р…Р В° Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ',
            chatRequestDesc: 'Р В­РЎвЂљР С•РЎвЂљ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎвЂ¦Р С•РЎвЂЎР ВµРЎвЂљ Р Р…Р В°РЎвЂЎР В°РЎвЂљРЎРЉ РЎРѓ Р Р†Р В°Р СР С‘ РЎвЂЎР В°РЎвЂљ',
            acceptRequest: 'Р СџРЎР‚Р С‘Р Р…РЎРЏРЎвЂљРЎРЉ',
            declineRequest: 'Р С›РЎвЂљР С”Р В»Р С•Р Р…Р С‘РЎвЂљРЎРЉ',
            waitingAccept: 'Р С›Р В¶Р С‘Р Т‘Р В°Р Р…Р С‘Р Вµ Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљР С‘РЎРЏ Р В·Р В°Р С—РЎР‚Р С•РЎРѓР В°...',
            
            // Р ВРЎРѓРЎвЂљР С•РЎР‚Р С‘Р С‘
            myStory: 'Р СљР С•РЎРЏ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ',
            
            // Р вЂ”Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘
            bookmarks: 'Р вЂ”Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘',
            savedMessages: 'Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ',
            noBookmarks: 'Р СњР ВµРЎвЂљ Р В·Р В°Р С”Р В»Р В°Р Т‘Р С•Р С”'
        },
        en: {
            // Auth
            welcome: 'Welcome',
            aiTagline: 'Blocks don\'t scare us! СЂСџС™Р‚',
            loginTab: 'Login',
            registerTab: 'Register',
            welcomeBack: 'Welcome back!',
            enterCredentials: 'Enter your credentials',
            createAccount: 'Create account',
            fillToRegister: 'Fill in the details to register',
            username: 'Username',
            password: 'Password',
            confirmPassword: 'Confirm password',
            loginBtn: 'Login',
            registerBtn: 'Register',
            userNotFound: 'User not found',
            wrongPassword: 'Wrong password',
            userExists: 'User already exists',
            passwordsDontMatch: 'Passwords do not match',
            passwordTooShort: 'Password must be at least 6 characters',
            usernameTooShort: 'Username must be at least 3 characters',
            
            // Sidebar
            searchNickname: 'Search nickname...',
            online: 'Online',
            loading: 'Loading...',
            selectContact: 'Select a contact',
            noOneFound: 'No one found',
            now: 'now',
            
            // Chat
            writeMessage: 'Write a message...',
            audioCall: 'Audio call',
            videoCall: 'Video call',
            
            // Calls
            incomingCall: 'Incoming call',
            calling: 'Calling...',
            waitingAnswer: 'Waiting for answer',
            call: 'Call',
            decline: 'Decline',
            accept: 'Accept',
            cancelCall: 'Cancel',
            audioCallType: 'Audio call',
            videoCallType: 'Video call',
            flickersCall: 'Flickers call',
            
            // Settings
            settings: 'Settings',
            profile: 'Profile',
            clickToChange: 'Click on avatar to change',
            bio: 'About',
            bioPlaceholder: 'Tell about yourself...',
            gender: 'Gender',
            male: 'Male',
            female: 'Female',
            other: 'Other',
            hideProfile: 'Hide profile',
            hideProfileDesc: 'Others won\'t see your profile',
            interface: 'Interface',
            lightTheme: 'Light theme',
            darkTheme: 'Dark theme',
            cosmicTheme: 'Cosmic',
            chatWallpaper: 'Chat wallpaper',
            newYearDecor: 'New Year decoration',
            showNewYearDecor: 'Garland and snowflakes',
            
            // Privacy
            privacy: 'Privacy',
            anonymousMode: 'Anonymous mode',
            hideOnlineStatus: 'Hide online status',
            e2eEncryption: 'E2E Encryption',
            blockScreenshots: 'Block screenshots',
            privacyNote: 'All messages are encrypted locally before sending. No one, including the server, can read your messages.',
            
            // Auto-delete
            autoDelete: 'Auto-delete',
            off: 'Off',
            autoDeleteNote: 'Messages will be automatically deleted after reading',
            
            // Language
            language: 'Language',
            russian: 'Р В РЎС“РЎРѓРЎРѓР С”Р С‘Р в„–',
            english: 'English',
            
            // Buttons
            checkUpdates: 'Check for updates',
            logout: 'Log out',
            
            // Files
            preparingFile: 'Uploading file (100MB max)...',
            downloadFile: 'Download file',
            fileTooLarge: 'File size is limited to 1MB due to database limit.',
            
            // Voice
            voiceTooLong: 'Voice message is too long (max ~1 minute)',
            micAccessError: 'Could not access microphone',
            
            // Encryption
            encrypted: 'Encrypted',
            anonymous: 'Anonymous',
            screenshotsBlocked: 'Screenshots are blocked in this chat',
            
            // Avatar
            avatarTooLarge: 'Avatar is too large. Maximum 1MB.',
            selectImage: 'Select an image',
            
            // Emoji categories
            emojiSmileys: 'Smileys',
            emojiGestures: 'Gestures',
            emojiPeople: 'People',
            emojiAnimals: 'Animals',
            emojiFood: 'Food',
            emojiActivities: 'Activities',
            emojiTravel: 'Travel',
            emojiObjects: 'Objects',
            emojiSymbols: 'Symbols',
            emojiFlags: 'Flags',
            searchEmoji: 'Search emoji...',
            searchResults: 'Search results',
            nothingFound: 'Nothing found',
            
            // Updates
            version: 'Version',
            runUpdater: 'Run Flickers-Updater.exe to check for updates',
            forUpdate: 'Download Flickers-Updater.exe to update',
            
            // Admin panel
            adminPanel: 'Admin Panel',
            userManagement: 'User Management',
            enterAdminPassword: 'Enter admin password',
            wrongAdminPassword: 'Wrong password',
            access: 'Access',
            searchUsers: 'Search users...',
            usersTotal: 'users total',
            noUsersFound: 'No users found',
            restore: 'Restore',
            delete: 'Delete',
            userDeleted: 'User deleted',
            userRestored: 'User restored',
            
            // Notifications
            notifications: 'Notifications',
            enableNotifications: 'Enable notifications',
            newMessage: 'New message',
            
            // Messages
            editMessage: 'Edit',
            deleteMessage: 'Delete',
            deleteForMe: 'Delete for me',
            deleteForAll: 'Delete for everyone',
            edited: 'edited',
            messageDeleted: 'Message deleted',
            editMessageTitle: 'Edit message',
            save: 'Save',
            cancel: 'Cancel',
            
            // AI
            aiGenerateReply: 'Generate reply',
            aiImproveText: 'Improve text',
            aiSummarize: 'Summarize conversation',
            aiTranslate: 'Translate',
            aiThinking: 'AI is thinking...',
            aiUse: 'Use',
            aiCopy: 'Copy',
            aiError: 'AI error. Try again later.',
            aiNoMessages: 'No messages to analyze',
            aiEnterText: 'Enter text to improve',
            aiCopied: 'Copied!',
            
            // Chat menu
            searchInChat: 'Search in chat',
            mediaFiles: 'Media files',
            muteNotifications: 'Mute notifications',
            unmuteNotifications: 'Enable notifications',
            clearHistory: 'Clear history',
            blockUser: 'Block user',
            unblockUser: 'Unblock',
            
            // Groups
            createGroup: 'Create group',
            groupName: 'Group name...',
            selectedMembers: 'Selected members',
            searchUsers: 'Search users...',
            createGroupBtn: 'Create group',
            
            // Chat requests
            chatRequest: 'Chat request',
            chatRequestDesc: 'This user wants to start a chat with you',
            acceptRequest: 'Accept',
            declineRequest: 'Decline',
            waitingAccept: 'Waiting for acceptance...',
            
            // Stories
            myStory: 'My Story',
            
            // Bookmarks
            bookmarks: 'Bookmarks',
            savedMessages: 'Saved messages',
            noBookmarks: 'No bookmarks'
        }
    };

    function t(key) {
        return translations[currentLang]?.[key] || translations['en']?.[key] || key;
    }

    // Р СћР ВµР СРЎвЂ№ Р Т‘Р В»РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р В°Р Р†РЎвЂљР С•РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘Р С‘
    const authThemes = ['light', 'dark', 'cosmic'];
    let currentAuthTheme = localStorage.getItem('flickers-theme') || 'light';
    
    function applyAuthTheme(theme) {
        const screen = document.getElementById('auth-screen');
        const card = document.getElementById('auth-card');
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('auth-theme-btn');
        const inputs = card?.querySelectorAll('input') || [];
        const tabs = card?.querySelector('.flex.mb-6') || null;
        const subtitles = card?.querySelectorAll('h2, p.text-slate-500') || [];
        
        if (theme === 'light') {
            screen.style.background = '#4f46e5';
            card.className = 'bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center transform transition-all';
            title.className = 'text-3xl font-black text-slate-800 mb-1';
            btn.textContent = 'РІВР‚РїС‘РЏ';
            inputs.forEach(inp => {
                inp.className = 'w-full p-4 bg-slate-100 text-slate-800 rounded-2xl outline-none mb-3 focus:ring-2 focus:ring-indigo-500 transition-all placeholder-slate-400';
            });
            if (tabs) tabs.className = 'flex mb-6 bg-slate-100 rounded-2xl p-1';
            subtitles.forEach(el => {
                if (el.tagName === 'H2') el.className = 'text-2xl font-black text-slate-800 mb-2';
                else el.className = 'text-slate-500 mb-6 text-sm';
            });
        } else if (theme === 'dark') {
            screen.style.background = '#0f172a';
            card.className = 'bg-slate-800 p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center transform transition-all';
            title.className = 'text-3xl font-black text-white mb-1';
            btn.textContent = 'СЂСџРЉв„ў';
            inputs.forEach(inp => {
                inp.className = 'w-full p-4 bg-slate-700 text-white rounded-2xl outline-none mb-3 focus:ring-2 focus:ring-indigo-500 transition-all placeholder-slate-400';
            });
            if (tabs) tabs.className = 'flex mb-6 bg-slate-700 rounded-2xl p-1';
            subtitles.forEach(el => {
                if (el.tagName === 'H2') el.className = 'text-2xl font-black text-white mb-2';
                else el.className = 'text-slate-400 mb-6 text-sm';
            });
        } else if (theme === 'cosmic') {
            screen.style.background = 'linear-gradient(135deg, #0f172a 0%, #581c87 50%, #0f172a 100%)';
            card.className = 'bg-slate-800/80 backdrop-blur-xl p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center transform transition-all border border-purple-500/30';
            title.className = 'text-3xl font-black text-purple-300 mb-1';
            btn.textContent = 'СЂСџРЉРЉ';
            inputs.forEach(inp => {
                inp.className = 'w-full p-4 bg-slate-700/80 text-white rounded-2xl outline-none mb-3 focus:ring-2 focus:ring-purple-500 transition-all placeholder-slate-400 border border-purple-500/20';
            });
            if (tabs) tabs.className = 'flex mb-6 bg-slate-700/50 rounded-2xl p-1';
            subtitles.forEach(el => {
                if (el.tagName === 'H2') el.className = 'text-2xl font-black text-purple-200 mb-2';
                else el.className = 'text-slate-400 mb-6 text-sm';
            });
        }
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎвЂљР ВµР СРЎС“ Р С” body Р Т‘Р В»РЎРЏ Р С•РЎРѓР Р…Р С•Р Р†Р Р…Р С•Р С–Р С• Р С—РЎР‚Р С‘Р В»Р С•Р В¶Р ВµР Р…Р С‘РЎРЏ
        document.body.classList.remove('theme-light', 'theme-dark', 'theme-cosmic');
        document.body.classList.add('theme-' + theme);
        
        currentAuthTheme = theme;
        localStorage.setItem('flickers-theme', theme);
    }
    
    window.cycleAuthTheme = function() {
        const idx = authThemes.indexOf(currentAuthTheme);
        const nextTheme = authThemes[(idx + 1) % authThemes.length];
        applyAuthTheme(nextTheme);
    };
    
    // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎС“РЎР‹ РЎвЂљР ВµР СРЎС“ Р С—РЎР‚Р С‘ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р Вµ
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('flickers-theme') || 'light';
        applyAuthTheme(savedTheme);
        
        // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С РЎРѓР Р…Р ВµР В¶Р С‘Р Р…Р С”Р С‘ Р Т‘Р В»РЎРЏ Р Р…Р С•Р Р†Р С•Р С–Р С•Р Т‘Р Р…Р ВµР С–Р С• Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘РЎРЏ
        createLogoSnowflakes();
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”РЎС“ Р Р…Р С•Р Р†Р С•Р С–Р С•Р Т‘Р Р…Р ВµР С–Р С• Р С•РЎвЂћР С•РЎР‚Р СР В»Р ВµР Р…Р С‘РЎРЏ
        const newYearEnabled = localStorage.getItem('flickers-newyear') !== 'false';
        if (!newYearEnabled) {
            document.querySelectorAll('.new-year-logo').forEach(el => el.classList.add('new-year-hidden'));
        }
    });
    
    function createLogoSnowflakes() {
        const containers = ['auth-snowflakes', 'sidebar-snowflakes'];
        const snowflakeChars = ['РІСњвЂћ', 'РІСњвЂ¦', 'РІСњвЂ ', 'РІСљВ»', 'РІСљС'];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            for (let i = 0; i < 8; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'logo-snowflake';
                snowflake.innerHTML = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)];
                snowflake.style.left = (Math.random() * 100) + '%';
                snowflake.style.fontSize = (Math.random() * 6 + 8) + 'px';
                snowflake.style.animationDuration = (Math.random() * 2 + 2) + 's';
                snowflake.style.animationDelay = (Math.random() * 3) + 's';
                container.appendChild(snowflake);
            }
        });
    }
    
    window.toggleNewYearDecor = () => {
        const enabled = localStorage.getItem('flickers-newyear') !== 'false';
        const newState = !enabled;
        
        localStorage.setItem('flickers-newyear', newState);
        
        document.querySelectorAll('.new-year-logo').forEach(el => {
            el.classList.toggle('new-year-hidden', !newState);
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С toggle
        const toggle = document.getElementById('toggle-newyear');
        if (toggle) {
            toggle.classList.toggle('active', newState);
        }
    };

    window.setLanguage = function(lang) {
        currentLang = lang;
        localStorage.setItem('flickers-lang', lang);
        document.documentElement.lang = lang;
        updateAllTranslations();
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ
        if (me?.uid) {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                settings: { language: lang }
            }, { merge: true });
        }
    };

    function updateAllTranslations() {
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р Р†РЎРѓР Вµ РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљРЎвЂ№ РЎРѓ data-i18n
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            el.textContent = t(key);
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С placeholder'РЎвЂ№
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            el.placeholder = t(key);
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С title'РЎвЂ№
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            el.title = t(key);
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ РЎРЏР В·РЎвЂ№Р С”Р В°
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === currentLang);
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ РЎРЏР В·РЎвЂ№Р С”Р В° Р Р…Р В° РЎРЊР С”РЎР‚Р В°Р Р…Р Вµ Р В°Р Р†РЎвЂљР С•РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘Р С‘
        document.querySelectorAll('.auth-lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === currentLang);
        });
    }

    // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ РЎРЏР В·РЎвЂ№Р С”Р В° Р С—РЎР‚Р С‘ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р Вµ
    document.addEventListener('DOMContentLoaded', () => {
        updateAllTranslations();
        
        // Р СџРЎР‚Р С‘Р Р†РЎРЏР В·РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р В±РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С” Р С—Р С•Р С‘РЎРѓР С”Р В° Р С—Р С• Р Р…Р С‘Р С”РЎС“
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                handleNicknameSearch(e.target.value);
            });
        }
    });

    // ========== Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…Р С•РЎРѓРЎвЂљРЎРЉ Р С‘ РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ ==========
    const privacySettings = {
        anonymous: false,
        hideOnline: false,
        encryption: false,
        blockScreenshots: false,
        autoDestruct: 0, // РЎРѓР ВµР С”РЎС“Р Р…Р Т‘РЎвЂ№, 0 = Р Р†РЎвЂ№Р С”Р В»
        notifications: true // РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р С• Р Р…Р С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏРЎвЂ¦
    };

    // Р СџРЎР‚Р С•РЎРѓРЎвЂљР С•Р Вµ РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ AES-Р С—Р С•Р Т‘Р С•Р В±Р Р…Р С•Р Вµ (Р Т‘Р В»РЎРЏ Р Т‘Р ВµР СР С•, Р Р† Р С—РЎР‚Р С•Р Т‘Р Вµ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљРЎРЉ Web Crypto API)
    const encryptionKey = 'flickers-e2e-secret-key-2024';
    
    function encrypt(text) {
        if (!privacySettings.encryption || !text) return text;
        try {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                result += String.fromCharCode(charCode);
            }
            return btoa(unescape(encodeURIComponent(result)));
        } catch {
            return text;
        }
    }

    function decrypt(encoded) {
        if (!encoded) return encoded;
        try {
            const text = decodeURIComponent(escape(atob(encoded)));
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                result += String.fromCharCode(charCode);
            }
            return result;
        } catch {
            return encoded; // Р вЂ™Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµР С Р С”Р В°Р С” Р ВµРЎРѓРЎвЂљРЎРЉ Р ВµРЎРѓР В»Р С‘ Р Р…Р Вµ Р В·Р В°РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С•
        }
    }

    function isEncrypted(text) {
        if (!text) return false;
        try {
            atob(text);
            return text.length > 0 && /^[A-Za-z0-9+/=]+$/.test(text);
        } catch {
            return false;
        }
    }

    window.togglePrivacy = (setting) => {
        privacySettings[setting] = !privacySettings[setting];
        const toggle = document.getElementById(`toggle-${setting.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
        if (toggle) {
            toggle.classList.toggle('active', privacySettings[setting]);
        }
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘
        if (me?.uid) {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                privacy: privacySettings
            }, { merge: true });
        }

        // Р вЂР В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р С”Р В° РЎРѓР С”РЎР‚Р С‘Р Р…РЎв‚¬Р С•РЎвЂљР С•Р Р† (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Р†Р С‘Р В·РЎС“Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С—РЎР‚Р ВµР Т‘РЎС“Р С—РЎР‚Р ВµР В¶Р Т‘Р ВµР Р…Р С‘Р Вµ)
        if (setting === 'blockScreenshots' && privacySettings.blockScreenshots) {
            document.addEventListener('keyup', preventScreenshot);
        }
        
        // Р С’Р Р…Р С•Р Р…Р С‘Р СР Р…РЎвЂ№Р в„– РЎР‚Р ВµР В¶Р С‘Р С - Р С•Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С UI
        if (setting === 'anonymous') {
            updateAnonymousMode();
        }
    };

    function preventScreenshot(e) {
        if (e.key === 'PrintScreen' || (e.ctrlKey && e.key === 'p')) {
            e.preventDefault();
            alert('СЂСџвЂњВµ Р РЋР С”РЎР‚Р С‘Р Р…РЎв‚¬Р С•РЎвЂљРЎвЂ№ Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…РЎвЂ№ Р Р† РЎРЊРЎвЂљР С•Р С РЎвЂЎР В°РЎвЂљР Вµ');
        }
    }

    function updateAnonymousMode() {
        const myAvatar = document.getElementById('my-avatar');
        const myName = document.getElementById('my-name');
        
        if (privacySettings.anonymous) {
            myAvatar.innerHTML = '<i class="fas fa-user-secret"></i>';
            myAvatar.classList.add('anonymous-avatar');
            myName.innerText = '@' + t('anonymous');
        } else if (me) {
            myAvatar.classList.remove('anonymous-avatar');
            if (me.avatar) {
                myAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover rounded-2xl">`;
            } else {
                myAvatar.innerHTML = me.username[0].toUpperCase();
            }
            myName.innerText = '@' + me.username;
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С‘Р СРЎРЏ Р Р† РЎв‚¬Р В°Р С—Р С”Р Вµ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• РЎвЂЎР В°РЎвЂљР В° (Р Т‘Р В»РЎРЏ РЎРѓР С•Р В±Р ВµРЎРѓР ВµР Т‘Р Р…Р С‘Р С”Р В° Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎР‚Р ВµР В°Р В»РЎРЉР Р…Р С•Р Вµ Р С‘Р СРЎРЏ)
        if (activeChatPartner) {
            document.getElementById('target-name').innerText = '@' + activeChatPartner.username;
        }
    }

    window.setAutoDestruct = (seconds) => {
        privacySettings.autoDestruct = seconds;
        document.querySelectorAll('.destruct-btn').forEach(btn => btn.classList.remove('active', 'bg-red-500', 'text-white', 'border-red-500'));
        const activeBtn = document.getElementById(`destruct-${seconds === 0 ? 'off' : seconds}`);
        if (activeBtn) {
            activeBtn.classList.add('active', 'bg-red-500', 'text-white', 'border-red-500');
        }
    };

    // Р В Р ВµР В¶Р С‘Р С РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”Р В°
    let devModeEnabled = localStorage.getItem('flickers-dev-mode') === 'true';
    
    window.toggleDevMode = () => {
        devModeEnabled = !devModeEnabled;
        localStorage.setItem('flickers-dev-mode', devModeEnabled);
        
        const toggle = document.getElementById('dev-mode-toggle');
        const consoleBtn = document.getElementById('dev-console-btn');
        
        if (toggle) {
            toggle.classList.toggle('active', devModeEnabled);
        }
        if (consoleBtn) {
            consoleBtn.classList.toggle('hidden', !devModeEnabled);
        }
        
        showToast(devModeEnabled ? 'Р В Р ВµР В¶Р С‘Р С РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”Р В° Р Р†Р С”Р В»РЎР‹РЎвЂЎРЎвЂР Р…' : 'Р В Р ВµР В¶Р С‘Р С РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”Р В° Р Р†РЎвЂ№Р С”Р В»РЎР‹РЎвЂЎРЎвЂР Р…', 'СЂСџвЂќВ§');
    };
    
    // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ РЎР‚Р ВµР В¶Р С‘Р СР В° РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”Р В° Р С—РЎР‚Р С‘ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р Вµ
    function initDevMode() {
        const toggle = document.getElementById('dev-mode-toggle');
        const consoleBtn = document.getElementById('dev-console-btn');
        
        if (toggle) {
            toggle.classList.toggle('active', devModeEnabled);
        }
        if (consoleBtn) {
            consoleBtn.classList.toggle('hidden', !devModeEnabled);
        }
    }

    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р в„– (Р Т‘Р В»РЎРЏ Р Р†Р ВµР В±-Р Р†Р ВµРЎР‚РЎРѓР С‘Р С‘ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ)
    window.checkForUpdates = () => {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р В·Р В°Р С—РЎС“РЎвЂ°Р ВµР Р…Р С• Р В»Р С‘ Р Р† Electron
        if (typeof require !== 'undefined') {
            try {
                const { shell } = require('electron');
                // Р С›РЎвЂљР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С updater Р С‘Р В»Р С‘ РЎРѓРЎвЂљРЎР‚Р В°Р Р…Р С‘РЎвЂ РЎС“ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘
                shell.openExternal('https://github.com/YOUR_USERNAME/flickers-messenger/releases');
            } catch {
                alert(t('runUpdater'));
            }
        } else {
            alert('РІСљРЃ ' + t('version') + ' 1.0.0\n\n' + t('forUpdate'));
        }
    };

    // Р вЂ™РЎвЂ№РЎвЂ¦Р С•Р Т‘ Р С‘Р В· Р В°Р С”Р С”Р В°РЎС“Р Р…РЎвЂљР В°
    window.handleLogout = () => {
        localStorage.removeItem('flickers-user');
        me = null;
        location.reload();
    };

    // ========== Р С’Р Т‘Р СР С‘Р Р…-Р С—Р В°Р Р…Р ВµР В»РЎРЉ ==========
    let isAdminAuthenticated = false;
    let allUsers = [];

    window.openAdminPanel = () => {
        document.getElementById('admin-panel').classList.remove('hidden');
        document.getElementById('admin-login').classList.remove('hidden');
        document.getElementById('admin-content').classList.add('hidden');
        document.getElementById('admin-password').value = '';
        document.getElementById('admin-error').classList.add('hidden');
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р С•Р Т‘ Р ВµРЎРѓР В»Р С‘ Р С”РЎС“Р С—Р В»Р ВµР Р…
        const codeHint = document.getElementById('admin-code-hint');
        const codeValue = document.getElementById('admin-code-value');
        if (me?.ownedItems?.includes('admin-code')) {
            codeHint.classList.remove('hidden');
            codeValue.textContent = ADMIN_PASSWORD;
        } else {
            codeHint.classList.add('hidden');
        }
        
        if (isAdminAuthenticated) {
            showAdminContent();
        }
    };

    window.closeAdminPanel = () => {
        document.getElementById('admin-panel').classList.add('hidden');
        closeCreatorPanel();
    };

    window.adminLogin = async () => {
        const password = document.getElementById('admin-password').value;
        
        if (password === CREATOR_PASSWORD) {
            // Р СџР В°РЎР‚Р С•Р В»РЎРЉ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В°Р Т‘Р СР С‘Р Р…Р С”РЎС“ РЎРѓ Р В±Р С•Р С”Р С•Р Р†Р С•Р в„– Р С—Р В°Р Р…Р ВµР В»РЎРЉРЎР‹ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ
            isAdminAuthenticated = true;
            await showAdminContent();
            openCreatorPanel();
        } else if (password === ADMIN_PASSWORD) {
            isAdminAuthenticated = true;
            closeCreatorPanel();
            await showAdminContent();
        } else {
            document.getElementById('admin-error').classList.remove('hidden');
        }
    };

    async function showAdminContent() {
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        await loadAllUsers();
    }

    async function loadAllUsers() {
        try {
            console.log('Loading all users...');
            const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            allUsers = [];
            
            usersSnap.forEach(d => {
                const userData = { id: d.id, ...d.data() };
                console.log('User loaded:', d.id, userData.username, 'deleted:', userData.deleted);
                allUsers.push(userData);
            });
            
            console.log('Total users loaded:', allUsers.length);
            document.getElementById('admin-users-count').textContent = allUsers.length;
            renderAdminUsers(allUsers);
        } catch (e) {
            console.error('Failed to load users:', e);
        }
    }

    function renderAdminUsers(users) {
        const list = document.getElementById('admin-users-list');
        list.innerHTML = '';
        
        // Р РЋР С•РЎР‚РЎвЂљР С‘РЎР‚РЎС“Р ВµР С: РЎРѓР Р…Р В°РЎвЂЎР В°Р В»Р В° Р С•Р Р…Р В»Р В°Р в„–Р Р…, Р С—Р С•РЎвЂљР С•Р С Р С—Р С• Р С—Р С•РЎРѓР В»Р ВµР Т‘Р Р…Р ВµР СРЎС“ Р Р†Р С‘Р В·Р С‘РЎвЂљРЎС“
        const sortedUsers = [...users].sort((a, b) => {
            const aOnline = a.isOnline && (Date.now() - (a.lastSeen?.seconds * 1000 || 0) < 60000);
            const bOnline = b.isOnline && (Date.now() - (b.lastSeen?.seconds * 1000 || 0) < 60000);
            if (aOnline && !bOnline) return -1;
            if (!aOnline && bOnline) return 1;
            const aTime = a.lastSeen?.seconds || 0;
            const bTime = b.lastSeen?.seconds || 0;
            return bTime - aTime;
        });
        
        sortedUsers.forEach(user => {
            const div = document.createElement('div');
            const isDeleted = user.deleted === true;
            const isOnline = user.isOnline && (Date.now() - (user.lastSeen?.seconds * 1000 || 0) < 60000);
            
            div.className = `flex items-center justify-between p-4 rounded-xl ${isDeleted ? 'bg-red-50 dark:bg-red-900/20 opacity-60' : isOnline ? 'bg-green-50 dark:bg-green-900/20' : 'bg-slate-50 dark:bg-slate-700'} ${isCreatorMode && !isDeleted ? 'cursor-pointer hover:ring-2 hover:ring-yellow-400' : ''}`;
            
            const docId = user.id;
            const username = user.username || 'unknown';
            const rubies = user.rubies || 0;
            const lastSeen = user.lastSeen?.seconds ? new Date(user.lastSeen.seconds * 1000) : null;
            
            // Р вЂ™ РЎР‚Р ВµР В¶Р С‘Р СР Вµ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ - Р С”Р В»Р С‘Р С” Р Р†РЎвЂ№Р В±Р С‘РЎР‚Р В°Р ВµРЎвЂљ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
            if (isCreatorMode && !isDeleted) {
                div.onclick = () => selectUserForRubies(docId, username, rubies);
            }
            
            // Р В¤Р С•РЎР‚Р СР В°РЎвЂљР С‘РЎР‚РЎС“Р ВµР С Р Р†РЎР‚Р ВµР СРЎРЏ Р С—Р С•РЎРѓР В»Р ВµР Т‘Р Р…Р ВµР С–Р С• Р Р†Р С‘Р В·Р С‘РЎвЂљР В°
            let lastSeenText = 'Р СњР С‘Р С”Р С•Р С–Р Т‘Р В°';
            if (lastSeen) {
                const now = new Date();
                const diff = now - lastSeen;
                if (diff < 60000) lastSeenText = 'Р СћР С•Р В»РЎРЉР С”Р С• РЎвЂЎРЎвЂљР С•';
                else if (diff < 3600000) lastSeenText = `${Math.floor(diff / 60000)} Р СР С‘Р Р…. Р Р…Р В°Р В·Р В°Р Т‘`;
                else if (diff < 86400000) lastSeenText = `${Math.floor(diff / 3600000)} РЎвЂЎ. Р Р…Р В°Р В·Р В°Р Т‘`;
                else lastSeenText = lastSeen.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            }
            
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р В»Р ВµР Р†РЎС“РЎР‹ РЎвЂЎР В°РЎРѓРЎвЂљРЎРЉ РЎРѓ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С•Р С Р С‘ Р С‘Р СР ВµР Р…Р ВµР С
            const leftPart = document.createElement('div');
            leftPart.className = 'flex items-center gap-3';
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Premium РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ
            const hasPremium = user.premium && user.premium.expiresAt && 
                (new Date(user.premium.expiresAt.seconds ? user.premium.expiresAt.seconds * 1000 : user.premium.expiresAt) > new Date());
            const premiumBadge = hasPremium ? '<span class="ml-1 px-1.5 py-0.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-[8px] font-bold rounded-full">PREMIUM</span>' : '';
            
            leftPart.innerHTML = `
                <div class="relative">
                    <div class="w-10 h-10 rounded-full ${isDeleted ? 'bg-red-400' : hasPremium ? 'bg-gradient-to-r from-yellow-400 to-orange-500' : 'bg-indigo-500'} text-white flex items-center justify-center font-bold overflow-hidden">
                        ${user.avatar && !isDeleted ? `<img src="${user.avatar}" class="w-full h-full object-cover">` : (isDeleted ? '<i class="fas fa-ban"></i>' : (username[0]?.toUpperCase() || '?'))}
                    </div>
                    ${!isDeleted ? `<div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 ${isOnline ? 'bg-green-500' : 'bg-gray-400'} rounded-full border-2 border-white dark:border-slate-700"></div>` : ''}
                    ${hasPremium && !isDeleted ? '<div class="absolute -top-1 -right-1 text-yellow-500 text-xs"><i class="fas fa-crown"></i></div>' : ''}
                </div>
                <div>
                    <p class="font-bold text-sm ${isDeleted ? 'line-through text-red-500' : ''}">@${username}${premiumBadge}</p>
                    ${isDeleted ? '<span class="text-[9px] text-red-500 font-bold">Р Р€Р вЂќР С’Р вЂєР РѓР Сњ</span>' : 
                        `<p class="text-[10px] ${isOnline ? 'text-green-500 font-bold' : 'opacity-50'}">${isOnline ? 'РІвЂ”РЏ Р вЂ™ РЎРѓР ВµРЎвЂљР С‘' : lastSeenText}</p>`}
                </div>
            `;
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ РЎРѓР С—РЎР‚Р В°Р Р†Р В° Р С•РЎвЂљ Р С‘Р СР ВµР Р…Р С‘
            const rubiesDiv = document.createElement('div');
            rubiesDiv.className = 'flex items-center gap-1 text-sm font-bold text-red-500';
            rubiesDiv.innerHTML = `<i class="fas fa-gem text-xs"></i> ${rubies >= 1000 ? (rubies >= 1000000 ? (rubies/1000000).toFixed(1) + 'M' : (rubies/1000).toFixed(1) + 'K') : rubies.toFixed(2)}`;
            
            div.appendChild(leftPart);
            if (!isDeleted) {
                div.appendChild(rubiesDiv);
            }
            
            // Р вЂ™ РЎР‚Р ВµР В¶Р С‘Р СР Вµ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљР ВµР В»РЎРЏ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ РЎС“Р С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ
            if (isCreatorMode) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex items-center gap-2';
                
                if (isDeleted) {
                    // Р С™Р Р…Р С•Р С—Р С”Р В° Р Р†Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ
                    const restoreBtn = document.createElement('button');
                    restoreBtn.className = 'px-3 py-1.5 bg-green-500 text-white text-xs font-bold rounded-lg hover:bg-green-600 transition-all';
                    restoreBtn.innerHTML = '<i class="fas fa-undo"></i>';
                    restoreBtn.title = 'Р вЂ™Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ';
                    restoreBtn.onclick = (e) => {
                        e.stopPropagation();
                        window.restoreUser(docId);
                    };
                    actionsDiv.appendChild(restoreBtn);
                } else {
                    // Р В РЎС“Р В±Р С‘Р Р…РЎвЂ№
                    const rubiesDisplay = document.createElement('span');
                    rubiesDisplay.className = 'text-red-500 font-bold text-sm mr-2';
                    rubiesDisplay.innerHTML = `<i class="fas fa-gem"></i> ${rubies.toFixed(2)}`;
                    actionsDiv.appendChild(rubiesDisplay);
                    
                    // Р С™Р Р…Р С•Р С—Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'px-3 py-1.5 bg-red-500 text-white text-xs font-bold rounded-lg hover:bg-red-600 transition-all';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = 'Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ @${username}?`)) {
                            window.deleteUser(docId, username);
                        }
                    };
                    actionsDiv.appendChild(deleteBtn);
                }
                
                div.appendChild(actionsDiv);
            } else {
                // Р вЂ™ Р С•Р В±РЎвЂ№РЎвЂЎР Р…Р С•Р С РЎР‚Р ВµР В¶Р С‘Р СР Вµ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ
                const statusDiv = document.createElement('div');
                statusDiv.className = 'text-right';
                if (!isDeleted) {
                    statusDiv.innerHTML = `
                        <p class="text-xs font-bold ${isOnline ? 'text-green-500' : 'text-slate-400'}">${isOnline ? 'Online' : 'Offline'}</p>
                        <p class="text-[10px] opacity-50">${lastSeenText}</p>
                    `;
                }
                div.appendChild(statusDiv);
            }
            
            list.appendChild(div);
        });
        
        // Р РЋРЎвЂљР В°РЎвЂљР С‘РЎРѓРЎвЂљР С‘Р С”Р В°
        const onlineCount = users.filter(u => !u.deleted && u.isOnline && (Date.now() - (u.lastSeen?.seconds * 1000 || 0) < 60000)).length;
        const totalActive = users.filter(u => !u.deleted).length;
        document.getElementById('admin-users-count').innerHTML = `${onlineCount} Р С•Р Р…Р В»Р В°Р в„–Р Р… / ${totalActive}`;
        
        if (users.length === 0) {
            list.innerHTML = '<p class="text-center text-slate-400 py-8">Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р С‘ Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…РЎвЂ№</p>';
        }
    }

    window.filterAdminUsers = () => {
        const query = document.getElementById('admin-search').value.toLowerCase();
        const filtered = allUsers.filter(u => 
            u.username?.toLowerCase().includes(query) || 
            u.uid?.toLowerCase().includes(query)
        );
        renderAdminUsers(filtered);
    };

    window.deleteUser = async (userId, username) => {
        console.log('deleteUser called:', userId, username);
        
        try {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
            console.log('User ref path:', userRef.path);
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎРѓРЎС“РЎвЂ°Р ВµРЎРѓРЎвЂљР Р†РЎС“Р ВµРЎвЂљ Р В»Р С‘ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ
            const userSnap = await getDoc(userRef);
            console.log('User exists:', userSnap.exists());
            
            if (!userSnap.exists()) {
                alert(t('noUsersFound'));
                return;
            }
            
            // Р СџР С•Р СР ВµРЎвЂЎР В°Р ВµР С Р С”Р В°Р С” РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…Р С•Р С–Р С•
            await setDoc(userRef, { deleted: true }, { merge: true });
            console.log('User marked as deleted');
            
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ/Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
            try {
                const storyRef = doc(db, 'artifacts', appId, 'public', 'data', 'stories', userId);
                await deleteDoc(storyRef);
                console.log('User story deleted');
            } catch (storyErr) {
                console.log('No story to delete or error:', storyErr);
            }
            
            // Р вЂўРЎРѓР В»Р С‘ РЎРЊРЎвЂљР С• РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р в„– Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ - Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘Р С‘Р С
            if (me?.uid === userId) {
                handleLogout();
                return;
            }
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С”
            await loadAllUsers();
            
            alert(`${t('userDeleted')}: @${username}`);
        } catch (e) {
            console.error('Failed to delete user:', e);
            alert('Error: ' + e.message);
        }
    };

    window.restoreUser = async (userId) => {
        console.log('Restoring user:', userId);
        try {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
            await setDoc(userRef, { deleted: false }, { merge: true });
            console.log('User restored');
            await loadAllUsers();
            alert(t('userRestored'));
        } catch (e) {
            console.error('Failed to restore user:', e);
            alert('Error: ' + e.message);
        }
    };

    // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р В°Р Т‘Р СР С‘Р Р…-Р С—Р В°Р Р…Р ВµР В»Р С‘ Р С—Р С• Р С”Р В»Р С‘Р С”РЎС“ Р Р…Р В° РЎвЂћР С•Р Р…
    document.getElementById('admin-panel')?.addEventListener('click', (e) => {
        if (e.target.id === 'admin-panel') {
            closeAdminPanel();
        }
    });

    function loadPrivacySettings() {
        if (me?.privacy) {
            Object.assign(privacySettings, me.privacy);
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С UI Р С—Р ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР В°РЎвЂљР ВµР В»Р ВµР в„–
        Object.keys(privacySettings).forEach(key => {
            if (key === 'autoDestruct') return;
            const toggle = document.getElementById(`toggle-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
            if (toggle) {
                toggle.classList.toggle('active', privacySettings[key]);
            }
        });
        
        // Р С’Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ
        setAutoDestruct(privacySettings.autoDestruct || 0);
        
        // Р СњР С•Р Р†Р С•Р С–Р С•Р Т‘Р Р…Р ВµР Вµ Р С•РЎвЂћР С•РЎР‚Р СР В»Р ВµР Р…Р С‘Р Вµ
        const newYearEnabled = localStorage.getItem('flickers-newyear') !== 'false';
        const newYearToggle = document.getElementById('toggle-newyear');
        if (newYearToggle) {
            newYearToggle.classList.toggle('active', newYearEnabled);
        }
    }

    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) { console.error(e); }
    };

    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎС“РЎР‹ РЎРѓР ВµРЎРѓРЎРѓР С‘РЎР‹
    async function checkSavedSession() {
        const savedUser = localStorage.getItem('flickers-user');
        if (savedUser) {
            try {
                const { uid, username } = JSON.parse(savedUser);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    me = { uid, ...userSnap.data() };
                    showApp();
                    return true;
                }
            } catch (e) {
                console.error('Session restore failed:', e);
                localStorage.removeItem('flickers-user');
            }
        }
        return false;
    }

    // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ
    (async () => {
        // Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р С—РЎР‚Р С•Р В±РЎС“Р ВµР С Р Р†Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ РЎРѓР ВµРЎРѓРЎРѓР С‘РЎР‹
        const hasSession = await checkSavedSession();
        
        if (!hasSession) {
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРЊР С”РЎР‚Р В°Р Р… Р В°Р Р†РЎвЂљР С•РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘Р С‘
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('opacity-0');
            setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 500);
        }
    })();

    // Р СџРЎР‚Р С•РЎРѓРЎвЂљР В°РЎРЏ РЎвЂ¦Р ВµРЎв‚¬-РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ Р Т‘Р В»РЎРЏ Р С—Р В°РЎР‚Р С•Р В»РЎРЏ
    async function hashPassword(password) {
        const saltedPassword = password + 'flickers-salt-2024';
        
        // Р СџРЎР‚Р С•РЎРѓРЎвЂљР С•Р в„– Р Р…Р С• Р Р…Р В°Р Т‘РЎвЂР В¶Р Р…РЎвЂ№Р в„– РЎвЂ¦Р ВµРЎв‚¬ (РЎР‚Р В°Р В±Р С•РЎвЂљР В°Р ВµРЎвЂљ Р Р†Р ВµР В·Р Т‘Р Вµ)
        let hash1 = 0, hash2 = 0;
        for (let i = 0; i < saltedPassword.length; i++) {
            const char = saltedPassword.charCodeAt(i);
            hash1 = ((hash1 << 5) - hash1) + char;
            hash1 = hash1 & hash1;
            hash2 = ((hash2 << 7) - hash2) + char + i;
            hash2 = hash2 & hash2;
        }
        const part1 = Math.abs(hash1).toString(16).padStart(8, '0');
        const part2 = Math.abs(hash2).toString(16).padStart(8, '0');
        const part3 = Math.abs(hash1 ^ hash2).toString(16).padStart(8, '0');
        const part4 = Math.abs(hash1 + hash2).toString(16).padStart(8, '0');
        return (part1 + part2 + part3 + part4 + part1 + part2 + part3 + part4).substring(0, 64);
    }

    window.switchAuthTab = (tab) => {
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        
        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            tabLogin.classList.add('bg-white', 'shadow', 'text-indigo-600');
            tabLogin.classList.remove('text-slate-500');
            tabRegister.classList.remove('bg-white', 'shadow', 'text-indigo-600');
            tabRegister.classList.add('text-slate-500');
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            tabRegister.classList.add('bg-white', 'shadow', 'text-indigo-600');
            tabRegister.classList.remove('text-slate-500');
            tabLogin.classList.remove('bg-white', 'shadow', 'text-indigo-600');
            tabLogin.classList.add('text-slate-500');
        }
        
        // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С Р С•РЎв‚¬Р С‘Р В±Р С”Р С‘
        document.getElementById('login-error').classList.add('hidden');
        document.getElementById('register-error').classList.add('hidden');
    };

    window.handleLogin = async () => {
        const username = document.getElementById('login-username').value.trim().toLowerCase();
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');
        
        if (!username || !password) return;
        
        try {
            // Р ВРЎвЂ°Р ВµР С Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ Р С—Р С• Р С‘Р СР ВµР Р…Р С‘
            const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            let foundUser = null;
            
            usersSnap.forEach(d => {
                const u = d.data();
                if (u.username?.toLowerCase() === username && !u.deleted) {
                    foundUser = { ...u, odcId: d.id };
                }
            });
            
            if (!foundUser) {
                errorEl.textContent = t('userNotFound');
                errorEl.classList.remove('hidden');
                return;
            }
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С—Р В°РЎР‚Р С•Р В»РЎРЉ
            const hashedPassword = await hashPassword(password);
            if (foundUser.passwordHash !== hashedPassword) {
                errorEl.textContent = t('wrongPassword');
                errorEl.classList.remove('hidden');
                return;
            }
            
            // Р Р€РЎРѓР С—Р ВµРЎв‚¬Р Р…РЎвЂ№Р в„– Р Р†РЎвЂ¦Р С•Р Т‘ - РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† localStorage
            localStorage.setItem('flickers-user', JSON.stringify({
                uid: foundUser.uid,
                username: foundUser.username
            }));
            
            me = foundUser;
            showApp();
            
        } catch (e) {
            console.error(e);
            errorEl.textContent = 'Error: ' + e.message;
            errorEl.classList.remove('hidden');
        }
    };

    window.handleRegister = async () => {
        const username = document.getElementById('register-username').value.trim();
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;
        const errorEl = document.getElementById('register-error');
        
        // Р вЂ™Р В°Р В»Р С‘Р Т‘Р В°РЎвЂ Р С‘РЎРЏ
        if (username.length < 3) {
            errorEl.textContent = t('usernameTooShort');
            errorEl.classList.remove('hidden');
            return;
        }
        
        if (password.length < 6) {
            errorEl.textContent = t('passwordTooShort');
            errorEl.classList.remove('hidden');
            return;
        }
        
        if (password !== passwordConfirm) {
            errorEl.textContent = t('passwordsDontMatch');
            errorEl.classList.remove('hidden');
            return;
        }
        
        try {
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р Р…Р Вµ Р В·Р В°Р Р…РЎРЏРЎвЂљР С• Р В»Р С‘ Р С‘Р СРЎРЏ
            const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            let userExists = false;
            
            usersSnap.forEach(d => {
                const u = d.data();
                if (u.username?.toLowerCase() === username.toLowerCase() && !u.deleted) {
                    userExists = true;
                }
            });
            
            if (userExists) {
                errorEl.textContent = t('userExists');
                errorEl.classList.remove('hidden');
                return;
            }
            
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
            const hashedPassword = await hashPassword(password);
            const uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const userData = {
                uid,
                username,
                passwordHash: hashedPassword,
                settings: { theme: 'light', language: currentLang },
                createdAt: serverTimestamp()
            };
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), userData);
            
            // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† localStorage
            localStorage.setItem('flickers-user', JSON.stringify({
                uid,
                username
            }));
            
            me = userData;
            showApp();
            
        } catch (e) {
            console.error(e);
            errorEl.textContent = 'Error: ' + e.message;
            errorEl.classList.remove('hidden');
        }
    };

    function showApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('loading-overlay').classList.add('opacity-0');
        setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 500);
        document.getElementById('main-app').classList.remove('hidden');
        
        // Р ВР СРЎРЏ + Premium badge
        const myNameEl = document.getElementById('my-name');
        const premiumBadge = hasPremium() ? ` ${getPremiumBadgeHtml(true)}` : '';
        myNameEl.innerHTML = `@${me.username}${premiumBadge}`;
        
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”РЎС“
        const myAvatar = document.getElementById('my-avatar');
        if (me.avatar) {
            myAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover rounded-2xl">`;
        } else {
            myAvatar.innerText = me.username[0].toUpperCase();
        }
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№
        if (me.rubies === undefined) me.rubies = 0;
        if (me.ownedItems === undefined) me.ownedItems = [];
        updateRubiesDisplay();
        applyAvatarEffect();
        applyPremiumTheme();
        
        if(me.settings?.theme) setTheme(me.settings.theme);
        if(me.settings?.language) {
            currentLang = me.settings.language;
            localStorage.setItem('flickers-lang', currentLang);
        }
        loadPrivacySettings();
        initDevMode();
        loadPremiumCustomization();
        updateAllTranslations();
        initEmoji();
        listenToChats();
        updateArchivedChatsUI();
        updateFolderButtons(); // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С”Р В°РЎРѓРЎвЂљР С•Р СР Р…РЎвЂ№Р Вµ Р С—Р В°Р С—Р С”Р С‘
        listenForNewChats(); // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С•РЎвЂљ Р Р…Р С•Р Р†РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
        loadWallpaper();
        listenToGroups();
        listenToChannels();
        loadStories();
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С РЎР‚Р В°Р СР С”РЎС“ Р С‘ РЎРѓРЎвЂљР С‘Р В»РЎРЉ
        loadFrameAndStyleSettings();
        
        // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР В°
        startOnlineStatusUpdates();
        
        // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р Р…Р В°РЎвЂЎР С‘РЎРѓР В»Р ВµР Р…Р С‘Р Вµ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р В·Р В° Р Р†РЎР‚Р ВµР СРЎРЏ Р Р† Р С—РЎР‚Р С‘Р В»Р С•Р В¶Р ВµР Р…Р С‘Р С‘
        startChatRubyEarning();
        
        // Р вЂ”Р В°Р С—РЎР‚Р В°РЎв‚¬Р С‘Р Р†Р В°Р ВµР С РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘Р Вµ Р Р…Р В° РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
        requestNotificationPermission();
    }

    // Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘РЎРЏ Р Р…Р В° РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
    async function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            await Notification.requestPermission();
        }
    }

    // Р СџРЎР‚Р С•РЎРѓРЎвЂљР С•Р Вµ toast-РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
    function showToast(message, icon = 'РІСљвЂ¦') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = 'notification-toast';
        toast.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xl">${icon}</div>
            <div class="flex-1 overflow-hidden">
                <p class="text-sm font-medium">${message}</p>
            </div>
        `;
        
        toast.onclick = () => {
            toast.classList.add('toast-out');
            setTimeout(() => toast.remove(), 500);
        };
        
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('toast-out');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    function showNotification(partner, message) {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№ Р В»Р С‘ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
        if (!privacySettings.notifications) return;
        
        // Р СњР Вµ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ Р ВµРЎРѓР В»Р С‘ РЎвЂЎР В°РЎвЂљ РЎС“Р В¶Р Вµ Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљ Р С‘ Р С•Р С”Р Р…Р С• Р Р† РЎвЂћР С•Р С”РЎС“РЎРѓР Вµ
        if (activeChatPartner && activeChatPartner.uid === partner.uid && !document.hidden) return;
        
        // Р вЂ™Р ВР вЂР В Р С’Р В¦Р ВР Р‡ Р Т‘Р В»РЎРЏ Firefox Android (РЎР‚Р В°Р В±Р С•РЎвЂљР В°Р ВµРЎвЂљ Р Р†РЎРѓР ВµР С–Р Т‘Р В°!)
        if ('vibrate' in navigator) {
            navigator.vibrate([200, 100, 200]);
        }
        
        const truncatedMessage = message.length > 100 ? message.substring(0, 100) + '...' : message;
        
        // Push-РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· Service Worker (РЎР‚Р В°Р В±Р С•РЎвЂљР В°Р ВµРЎвЂљ Р Т‘Р В°Р В¶Р Вµ Р С”Р С•Р С–Р Т‘Р В° Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚ РЎРѓР Р†РЎвЂРЎР‚Р Р…РЎС“РЎвЂљ)
        if (document.hidden || !document.hasFocus()) {
            sendPushNotification(`@${partner.username}`, truncatedMessage, {
                chatPartnerId: partner.uid,
                chatPartnerName: partner.username,
                url: '/'
            });
        }
        
        // Р вЂ™Р Р…РЎС“РЎвЂљРЎР‚Р ВµР Р…Р Р…Р ВµР Вµ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ (toast) - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р Р†РЎРѓР ВµР С–Р Т‘Р В° Р ВµРЎРѓР В»Р С‘ Р С•Р С”Р Р…Р С• Р Р† РЎвЂћР С•Р С”РЎС“РЎРѓР Вµ
        if (!document.hidden) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold">${partner.username[0].toUpperCase()}</div>
                <div class="flex-1 overflow-hidden">
                    <p class="font-bold text-xs">@${partner.username}</p>
                    <p class="text-xs opacity-70 truncate">${message}</p>
                </div>
            `;
            
            toast.onclick = () => {
                selectChat(partner);
                toast.classList.add('toast-out');
                setTimeout(() => toast.remove(), 500);
            };

            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.add('toast-out');
                    setTimeout(() => toast.remove(), 500);
                }
            }, 5000);
        }
        
        // Р вЂ”Р Р†РЎС“Р С” РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
        notificationSound.play().catch(() => {});
    }

    let chatsSnapshotId = 0; // Р вЂќР В»РЎРЏ Р С•РЎвЂљРЎРѓР В»Р ВµР В¶Р С‘Р Р†Р В°Р Р…Р С‘РЎРЏ Р В°Р С”РЎвЂљРЎС“Р В°Р В»РЎРЉР Р…Р С•РЎРѓРЎвЂљР С‘ РЎРѓР Р…Р В°Р С—РЎв‚¬Р С•РЎвЂљР В°
    let chatListOnlineUnsubs = []; // Р РЋР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»Р С‘ Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР В° Р Т‘Р В»РЎРЏ РЎРѓР С—Р С‘РЎРѓР С”Р В° РЎвЂЎР В°РЎвЂљР С•Р Р†
    
    function listenToChats() {
        if (!me) return;
        const q = collection(db, 'artifacts', appId, 'users', me.uid, 'active_chats');
        onSnapshot(q, (snap) => {
            const currentSnapshotId = ++chatsSnapshotId;
            const list = document.getElementById('chats-list');
            list.innerHTML = '';
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ" Р Р† Р Р…Р В°РЎвЂЎР В°Р В»Р С• РЎРѓР С—Р С‘РЎРѓР С”Р В°
            const savedDiv = document.createElement('div');
            savedDiv.className = `chat-item saved-messages-item p-4 glass-panel rounded-2xl cursor-pointer flex items-center space-x-3 ${activeChatPartner?.uid === 'saved_' + me.uid ? 'border-indigo-500 bg-indigo-500/5' : ''}`;
            savedDiv.dataset.chatUid = 'saved_' + me.uid;
            savedDiv.onclick = () => openSavedMessages();
            savedDiv.innerHTML = `
                <div class="relative">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                        <i class="fas fa-bookmark text-white text-lg"></i>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <span class="font-bold truncate">Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ</span>
                    </div>
                    <p class="text-xs opacity-50 truncate">Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ</p>
                </div>
            `;
            list.appendChild(savedDiv);
            
            // Р С›РЎвЂљР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР СРЎРѓРЎРЏ Р С•РЎвЂљ Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р С‘РЎвЂ¦ РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»Р ВµР в„– Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР В°
            chatListOnlineUnsubs.forEach(unsub => unsub());
            chatListOnlineUnsubs = [];
            
            snap.docChanges().forEach(change => {
                const chat = change.doc.data();
                if (change.type === 'modified' && chat.lastSenderId !== me.uid) {
                    showNotification(chat, chat.last);
                }
            });

            // Р РЋР С•Р В±Р С‘РЎР‚Р В°Р ВµР С Р Р†РЎРѓР Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ Р Р† Р СР В°РЎРѓРЎРѓР С‘Р Р† Р Т‘Р В»РЎРЏ РЎРѓР С•РЎР‚РЎвЂљР С‘РЎР‚Р С•Р Р†Р С”Р С‘
            const chatsArray = [];
            snap.docs.forEach(d => {
                const chat = d.data();
                
                // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ" (Р С•Р Р…Р С• Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµРЎвЂљРЎРѓРЎРЏ Р С•РЎвЂљР Т‘Р ВµР В»РЎРЉР Р…Р С• Р Р† Р Р…Р В°РЎвЂЎР В°Р В»Р Вµ РЎРѓР С—Р С‘РЎРѓР С”Р В°)
                if (chat.uid && chat.uid.startsWith('saved_')) return;
                
                // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№
                if (deletedChats[chat.uid]) return;
                
                // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ (Р С•Р Р…Р С‘ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°РЎР‹РЎвЂљРЎРѓРЎРЏ Р С•РЎвЂљР Т‘Р ВµР В»РЎРЉР Р…Р С•)
                if (archivedChats[chat.uid]) return;
                
                // Р В¤Р С‘Р В»РЎРЉРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ Р С—Р С• Р С—Р В°Р С—Р С”Р В°Р С
                if (currentFolder !== 'all') {
                    if (currentFolder === 'personal') {
                        // Р вЂєР С‘РЎвЂЎР Р…РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ - Р Р…Р Вµ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№
                        if (chat.isGroup) return;
                    } else if (currentFolder === 'groups') {
                        // Р СћР С•Р В»РЎРЉР С”Р С• Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№
                        if (!chat.isGroup) return;
                    } else {
                        // Р С™Р В°РЎРѓРЎвЂљР С•Р СР Р…Р В°РЎРЏ Р С—Р В°Р С—Р С”Р В°
                        if (chatFolderAssignments[chat.uid] !== currentFolder) return;
                    }
                }
                
                chatsArray.push(chat);
            });
            
            // Р РЋР С•РЎР‚РЎвЂљР С‘РЎР‚РЎС“Р ВµР С: Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎРѓР Р†Р ВµРЎР‚РЎвЂ¦РЎС“, Р В·Р В°РЎвЂљР ВµР С Р С—Р С• Р Р†РЎР‚Р ВµР СР ВµР Р…Р С‘ Р С—Р С•РЎРѓР В»Р ВµР Т‘Р Р…Р ВµР С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
            chatsArray.sort((a, b) => {
                const aPinned = pinnedChats[a.uid];
                const bPinned = pinnedChats[b.uid];
                
                if (aPinned && !bPinned) return -1;
                if (!aPinned && bPinned) return 1;
                if (aPinned && bPinned) {
                    return bPinned.pinnedAt - aPinned.pinnedAt;
                }
                
                // Р вЂўРЎРѓР В»Р С‘ Р С•Р В±Р В° Р Р…Р Вµ Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»Р ВµР Р…РЎвЂ№, РЎРѓР С•РЎР‚РЎвЂљР С‘РЎР‚РЎС“Р ВµР С Р С—Р С• Р Р†РЎР‚Р ВµР СР ВµР Р…Р С‘
                return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
            });
            
            // Р С›РЎвЂљРЎР‚Р С‘РЎРѓР С•Р Р†РЎвЂ№Р Р†Р В°Р ВµР С Р С•РЎвЂљРЎРѓР С•РЎР‚РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№
            chatsArray.forEach(chat => {
                const isPinned = pinnedChats[chat.uid];
                const div = document.createElement('div');
                div.className = `chat-item p-4 glass-panel rounded-2xl cursor-pointer flex items-center space-x-3 ${activeChatPartner?.uid === chat.uid ? 'border-indigo-500 bg-indigo-500/5' : ''} ${isPinned ? 'pinned' : ''}`;
                div.dataset.chatUid = chat.uid;
                div.onclick = () => selectChat(chat);
                
                // Р С™Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ (Р СџР С™Р Сљ Р Р…Р В° Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—Р Вµ, Р Т‘Р С•Р В»Р С–Р С•Р Вµ Р Р…Р В°Р В¶Р В°РЎвЂљР С‘Р Вµ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦)
                div.oncontextmenu = (e) => {
                    e.preventDefault();
                    showChatContextMenu(e, chat);
                };
                
                // Р вЂќР С•Р В»Р С–Р С•Р Вµ Р Р…Р В°Р В¶Р В°РЎвЂљР С‘Р Вµ Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
                let pressTimer;
                div.ontouchstart = (e) => {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showChatContextMenu(e.touches[0], chat);
                    }, 500);
                };
                div.ontouchend = () => clearTimeout(pressTimer);
                div.ontouchmove = () => clearTimeout(pressTimer);
                
                // Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓ Р В±РЎС“Р С”Р Р†Р С•Р в„–, Р С—Р С•РЎвЂљР С•Р С Р В°РЎРѓР С‘Р Р…РЎвЂ¦РЎР‚Р С•Р Р…Р Р…Р С• Р С—Р С•Р Т‘Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”РЎС“
                div.innerHTML = `
                    <div class="relative">
                        <div class="chat-avatar w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center font-bold text-indigo-500 shadow-sm overflow-hidden">${chat.username[0].toUpperCase()}</div>
                        <div class="chat-online-dot absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-gray-400 rounded-full border-2 border-white dark:border-slate-900"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-1.5">
                                <p class="font-bold text-sm">@${chat.username}</p>
                                ${isPinned ? '<i class="fas fa-thumbtack text-yellow-500 text-[10px]"></i>' : ''}
                            </div>
                            <span class="text-[8px] opacity-30">${t('now')}</span>
                        </div>
                        <p class="text-xs opacity-40 truncate">${chat.last || '...'}</p>
                    </div>
                `;
                list.appendChild(div);
                
                // Real-time РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»РЎРЉ Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР В° Р Т‘Р В»РЎРЏ Р С”Р В°Р В¶Р Т‘Р С•Р С–Р С• Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ Р Р† РЎРѓР С—Р С‘РЎРѓР С”Р Вµ
                const userUnsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', chat.uid), (userDoc) => {
                    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• РЎРѓР Р…Р В°Р С—РЎв‚¬Р С•РЎвЂљ Р ВµРЎвЂ°РЎвЂ Р В°Р С”РЎвЂљРЎС“Р В°Р В»Р ВµР Р…
                    if (currentSnapshotId !== chatsSnapshotId) return;
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        // Р вЂўРЎРѓР В»Р С‘ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎС“Р Т‘Р В°Р В»РЎвЂР Р… - Р С—Р С•Р СР ВµРЎвЂЎР В°Р ВµР С РЎвЂЎР В°РЎвЂљ
                        if (userData.deleted) {
                            div.classList.add('opacity-50');
                            const nameEl = div.querySelector('.font-bold');
                            if (nameEl && !nameEl.innerHTML.includes('deleted')) {
                                nameEl.innerHTML = `@${chat.username} <span class="text-red-500 text-[9px]">(deleted)</span>`;
                            }
                        }
                        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”РЎС“
                        const avatarEl = div.querySelector('.chat-avatar');
                        if (avatarEl && userData.avatar && !userData.deleted) {
                            if (!avatarEl.querySelector('img')) {
                                avatarEl.innerHTML = `<img src="${userData.avatar}" class="w-full h-full object-cover">`;
                            }
                            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р В»Р В°РЎРѓРЎРѓ Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘
                            if (userData.animatedAvatar && checkUserPremium(userData)) {
                                avatarEl.classList.add('avatar-animated');
                            } else {
                                avatarEl.classList.remove('avatar-animated');
                            }
                        }
                        
                        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Premium Р В·Р Р…Р В°РЎвЂЎР С•Р С”
                        const nameEl = div.querySelector('.font-bold');
                        if (nameEl && checkUserPremium(userData)) {
                            if (!nameEl.querySelector('.premium-badge-small')) {
                                nameEl.innerHTML = `@${chat.username} ${getPremiumBadgeHtml(true)}`;
                            }
                        }
                        
                        // Р вЂ™Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р С‘Р С”Р С•Р Р…Р С”РЎС“ Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»Р ВµР Р…Р С‘РЎРЏ Р ВµРЎРѓР В»Р С‘ Р С•Р Р…Р В° Р В±РЎвЂ№Р В»Р В°
                        const nameContainer = div.querySelector('.flex.items-center.gap-1\\.5');
                        if (nameContainer && isPinned && !nameContainer.querySelector('.fa-thumbtack')) {
                            const pinIcon = document.createElement('i');
                            pinIcon.className = 'fas fa-thumbtack text-yellow-500 text-[10px]';
                            nameContainer.appendChild(pinIcon);
                        }
                        
                        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ (Р В°Р С–РЎР‚Р ВµРЎРѓРЎРѓР С‘Р Р†Р Р…Р В°РЎРЏ Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В°) - REAL-TIME!
                        const onlineDot = div.querySelector('.chat-online-dot');
                        if (onlineDot) {
                            const isOnline = userData.isOnline === true;
                            
                            if (isOnline) {
                                onlineDot.className = 'chat-online-dot absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-slate-900';
                            } else {
                                onlineDot.className = 'chat-online-dot absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-gray-400 rounded-full border-2 border-white dark:border-slate-900';
                            }
                        }
                    }
                });
                
                chatListOnlineUnsubs.push(userUnsub);
            });
        });
    }

    // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С•РЎвЂљ Р Р…Р С•Р Р†РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„– (Р В°Р Р…Р С•Р Р…Р С‘Р СР С•Р Р†)
    let incomingMessagesUnsub = null;
    let knownChatPartners = new Set();
    
    function listenForNewChats() {
        if (!me || incomingMessagesUnsub) return;
        
        // Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С‘Р В·Р Р†Р ВµРЎРѓРЎвЂљР Р…РЎвЂ№РЎвЂ¦ Р С—Р В°РЎР‚РЎвЂљР Р…РЎвЂРЎР‚Р С•Р Р†
        getDocs(collection(db, 'artifacts', appId, 'users', me.uid, 'active_chats')).then(snap => {
            snap.docs.forEach(d => knownChatPartners.add(d.id));
        });
        
        // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р Р†РЎРѓР Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№, Р С–Р Т‘Р Вµ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р†РЎС“Р ВµРЎвЂљ РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р в„– Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ
        const chatsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats');
        
        incomingMessagesUnsub = onSnapshot(chatsRef, async (snap) => {
            // Р С›Р В±РЎР‚Р В°Р В±Р В°РЎвЂљРЎвЂ№Р Р†Р В°Р ВµР С РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ (Р Р…Р С•Р Р†РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ Р С‘Р В»Р С‘ Р С‘Р В·Р СР ВµР Р…РЎвЂР Р…Р Р…РЎвЂ№Р Вµ)
            for (const change of snap.docChanges()) {
                if (change.type !== 'added' && change.type !== 'modified') continue;
                
                const chatId = change.doc.id;
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• РЎРЊРЎвЂљР С• РЎвЂЎР В°РЎвЂљ РЎРѓ РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р С Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР С
                if (!chatId.includes(me.uid)) continue;
                
                // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С ID РЎРѓР С•Р В±Р ВµРЎРѓР ВµР Т‘Р Р…Р С‘Р С”Р В°
                const parts = chatId.split('_');
                if (parts.length !== 2) continue;
                
                const [uid1, uid2] = parts;
                const partnerId = uid1 === me.uid ? uid2 : uid1;
                
                // Р вЂўРЎРѓР В»Р С‘ Р С—Р В°РЎР‚РЎвЂљР Р…РЎвЂРЎР‚ РЎС“Р В¶Р Вµ Р С‘Р В·Р Р†Р ВµРЎРѓРЎвЂљР ВµР Р… - Р С—РЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С
                if (knownChatPartners.has(partnerId)) continue;
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р ВµРЎРѓРЎвЂљРЎРЉ Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р Р† РЎРЊРЎвЂљР С•Р С РЎвЂЎР В°РЎвЂљР Вµ
                try {
                    const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
                    const messagesSnap = await getDocs(query(messagesRef, orderBy('timestamp', 'desc'), limit(1)));
                    
                    if (messagesSnap.empty) continue;
                    
                    const lastMessage = messagesSnap.docs[0].data();
                    
                    // Р вЂўРЎРѓР В»Р С‘ Р С—Р С•РЎРѓР В»Р ВµР Т‘Р Р…Р ВµР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С•РЎвЂљ Р Т‘РЎР‚РЎС“Р С–Р С•Р С–Р С• Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ - РЎРѓР С•Р В·Р Т‘Р В°РЎвЂР С РЎвЂЎР В°РЎвЂљ
                    if (lastMessage.senderId !== me.uid) {
                        // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљР ВµР В»РЎРЏ
                        const senderDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', partnerId));
                        
                        if (senderDoc.exists()) {
                            const senderData = senderDoc.data();
                            const senderName = senderData.username || 'Р С’Р Р…Р С•Р Р…Р С‘Р С';
                            
                            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р† Р С‘Р В·Р Р†Р ВµРЎРѓРЎвЂљР Р…РЎвЂ№РЎвЂ¦ Р С—Р В°РЎР‚РЎвЂљР Р…РЎвЂРЎР‚Р С•Р Р†
                            knownChatPartners.add(partnerId);
                            
                            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ
                            await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'active_chats', partnerId), {
                                uid: partnerId,
                                username: senderName,
                                last: lastMessage.text || (lastMessage.type === 'voice' ? 'СЂСџР‹В¤ Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ' : 'СЂСџвЂњР‹ Р вЂ™Р В»Р С•Р В¶Р ВµР Р…Р С‘Р Вµ'),
                                lastSenderId: lastMessage.senderId,
                                timestamp: lastMessage.timestamp
                            }, { merge: true });
                            
                            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
                            showNotification({
                                uid: partnerId,
                                username: senderName
                            }, lastMessage.text || 'Р СњР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ');
                            
                            console.log('Р РЋР С•Р В·Р Т‘Р В°Р Р… Р Р…Р С•Р Р†РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ РЎРѓ:', senderName);
                        }
                    }
                } catch (err) {
                    console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р С‘ Р Р…Р С•Р Р†Р С•Р С–Р С• РЎвЂЎР В°РЎвЂљР В°:', err);
                }
            }
        });
    }

    // ========== Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ (Saved Messages) ==========
    let savedMessagesUnsub = null;
    let isSavedMessagesOpen = false;
    
    window.openSavedMessages = async () => {
        isSavedMessagesOpen = true;
        activeChatPartner = { uid: 'saved_' + me.uid, username: 'Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ' };
        activeGroup = null;
        activeChannel = null;
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С UI РЎРѓ Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В°Р СР С‘ Р Р…Р В° null
        const placeholder = document.getElementById('chat-placeholder');
        const activeChat = document.getElementById('active-chat');
        const targetName = document.getElementById('target-name');
        const targetStatus = document.getElementById('target-status');
        const targetAvatar = document.getElementById('target-avatar');
        const onlineIndicator = document.getElementById('online-indicator');
        const onlineStatus = document.getElementById('online-status');
        
        if (placeholder) placeholder.classList.add('hidden');
        if (activeChat) activeChat.classList.remove('hidden');
        if (targetName) targetName.innerText = 'Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ';
        if (targetStatus) targetStatus.innerText = 'Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ';
        if (targetAvatar) targetAvatar.innerHTML = '<i class="fas fa-bookmark text-indigo-500"></i>';
        if (onlineIndicator) onlineIndicator.classList.add('hidden');
        if (onlineStatus) onlineStatus.style.display = 'none';
        
        // Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…Р В°РЎРЏ Р Р…Р В°Р Р†Р С‘Р С–Р В°РЎвЂ Р С‘РЎРЏ - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂЎР В°РЎвЂљ
        if (typeof mobileShowChat === 'function') mobileShowChat();
        if (typeof isMobileView !== 'undefined' && isMobileView) history.pushState({ chat: true }, '');
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р С•Р Р† Р Т‘Р В»РЎРЏ Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•
        const callBtns = document.querySelectorAll('[onclick^="startCall"]');
        callBtns.forEach(btn => btn.style.display = 'none');
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р В° РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
        const giftBtn = document.querySelector('[onclick="openGiftRubies()"]');
        if (giftBtn) giftBtn.style.display = 'none';
        
        // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С Р С”Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
        const cont = document.getElementById('messages-container');
        if (!cont) return;
        cont.innerHTML = '';
        
        // Р С›РЎвЂљР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР СРЎРѓРЎРЏ Р С•РЎвЂљ Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР С–Р С• РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»РЎРЏ
        if (savedMessagesUnsub) {
            savedMessagesUnsub();
            savedMessagesUnsub = null;
        }
        
        // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р Р† Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С
        const savedRef = collection(db, 'artifacts', appId, 'users', me.uid, 'saved_messages');
        const q = query(savedRef, orderBy('savedAt', 'asc'));
        
        savedMessagesUnsub = onSnapshot(q, (snap) => {
            cont.innerHTML = '';
            
            if (snap.empty) {
                cont.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-8 opacity-50">
                        <i class="fas fa-bookmark text-6xl mb-4 text-indigo-500"></i>
                        <p class="text-lg font-bold">Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ Р С—РЎС“РЎРѓРЎвЂљР С•</p>
                        <p class="text-sm mt-2">Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР в„–РЎвЂљР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ, РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ Р Р†Р ВµРЎР‚Р Р…РЎС“РЎвЂљРЎРЉРЎРѓРЎРЏ Р С” Р Р…Р С‘Р С Р С—Р С•Р В·Р В¶Р Вµ.<br>Р СњР В°Р В¶Р СР С‘РЎвЂљР Вµ Р С‘ РЎС“Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р в„–РЎвЂљР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РІвЂ вЂ™ "Р вЂ™ Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ"</p>
                    </div>
                `;
                return;
            }
            
            snap.docs.forEach(d => {
                const m = d.data();
                const msgId = d.id;
                
                const div = document.createElement('div');
                div.className = 'message-bubble p-4 shadow-sm sent';
                div.dataset.msgId = msgId;
                
                const savedTime = m.savedAt?.seconds ? new Date(m.savedAt.seconds * 1000).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                const fromChat = m.fromUsername ? `Р С›РЎвЂљ: @${m.fromUsername}` : '';
                
                let content = '';
                if (m.text) {
                    content = `<p class="break-words whitespace-pre-wrap">${linkifyText(m.text)}</p>`;
                } else if (m.imageUrl) {
                    content = `<img src="${m.imageUrl}" class="max-w-full rounded-lg cursor-pointer" onclick="openImageViewer('${m.imageUrl}')">`;
                } else if (m.fileUrl) {
                    content = `<a href="${m.fileUrl}" target="_blank" class="flex items-center gap-2 text-indigo-500"><i class="fas fa-file"></i> ${m.fileName || 'Р В¤Р В°Р в„–Р В»'}</a>`;
                } else if (m.voiceUrl) {
                    content = `<audio controls src="${m.voiceUrl}" class="w-full"></audio>`;
                }
                
                div.innerHTML = `
                    ${fromChat ? `<p class="text-[10px] opacity-50 mb-1">${fromChat}</p>` : ''}
                    ${content}
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-[9px] opacity-50">${savedTime}</span>
                        <button onclick="removeFromSaved('${msgId}')" class="text-red-500 text-xs opacity-50 hover:opacity-100">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                cont.appendChild(div);
            });
            
            cont.scrollTop = cont.scrollHeight;
        });
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р Р†РЎвЂ№Р Т‘Р ВµР В»Р ВµР Р…Р С‘Р Вµ Р Р† РЎРѓР С—Р С‘РЎРѓР С”Р Вµ РЎвЂЎР В°РЎвЂљР С•Р Р†
        document.querySelectorAll('.chat-item').forEach(el => {
            el.classList.remove('border-indigo-500', 'bg-indigo-500/5');
        });
        const savedItem = document.querySelector('[data-chat-uid="saved_' + me.uid + '"]');
        if (savedItem) {
            savedItem.classList.add('border-indigo-500', 'bg-indigo-500/5');
        }
    };
    
    // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р С‘РЎвЂљРЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р Р† Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ
    window.saveToFavorites = async (msgId, isGroup = false) => {
        closeContextMenu();
        
        if (!me) return;
        
        let msgData;
        let chatRef;
        
        if (isGroup && activeGroup) {
            chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages', msgId);
        } else if (activeChatPartner) {
            const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
            chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
        } else {
            return;
        }
        
        try {
            const msgDoc = await getDoc(chatRef);
            if (!msgDoc.exists()) {
                showToast('Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•', 'РІСњРЉ');
                return;
            }
            
            msgData = msgDoc.data();
            
            // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р С‘Р СРЎРЏ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљР ВµР В»РЎРЏ
            let fromUsername = '';
            if (msgData.senderId && msgData.senderId !== me.uid) {
                const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', msgData.senderId));
                if (userDoc.exists()) {
                    fromUsername = userDoc.data().username;
                }
            }
            
            // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ
            await addDoc(collection(db, 'artifacts', appId, 'users', me.uid, 'saved_messages'), {
                text: msgData.text || '',
                imageUrl: msgData.imageUrl || '',
                fileUrl: msgData.fileUrl || '',
                fileName: msgData.fileName || '',
                voiceUrl: msgData.voiceUrl || '',
                fromUsername: fromUsername,
                originalMsgId: msgId,
                savedAt: serverTimestamp()
            });
            
            showToast('Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С• Р Р† Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ', 'РІВ­С’');
        } catch (e) {
            console.error('Error saving to favorites:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С‘РЎРЏ', 'РІСњРЉ');
        }
    };
    
    // Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ Р С‘Р В· Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•
    window.removeFromSaved = async (msgId) => {
        if (!me) return;
        
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'saved_messages', msgId));
            showToast('Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С• Р С‘Р В· Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•', 'СЂСџвЂ”вЂРїС‘РЏ');
        } catch (e) {
            console.error('Error removing from saved:', e);
        }
    };

    // ========== Р РЋР С—Р С‘РЎРѓР С•Р С” Р В·Р В°Р Т‘Р В°РЎвЂЎ (To-Do) ==========
    let tasksUnsub = null;
    let currentTaskFilter = 'all';
    
    window.openTasksPanel = () => {
        const panel = document.getElementById('tasks-panel');
        if (panel) {
            panel.classList.remove('hidden');
            setTimeout(() => panel.classList.add('active'), 10);
        }
        loadTasks();
    };
    
    window.closeTasksPanel = () => {
        const panel = document.getElementById('tasks-panel');
        if (panel) {
            panel.classList.remove('active');
            setTimeout(() => panel.classList.add('hidden'), 400);
        }
        if (tasksUnsub) {
            tasksUnsub();
            tasksUnsub = null;
        }
    };
    
    function loadTasks() {
        if (!me) return;
        if (tasksUnsub) tasksUnsub();
        
        const tasksRef = collection(db, 'artifacts', appId, 'users', me.uid, 'tasks');
        const q = query(tasksRef, orderBy('createdAt', 'desc'));
        
        tasksUnsub = onSnapshot(q, (snap) => {
            renderTasks(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
    }
    
    function renderTasks(tasks) {
        const list = document.getElementById('tasks-list');
        if (!list) return;
        
        // Р В¤Р С‘Р В»РЎРЉРЎвЂљРЎР‚РЎС“Р ВµР С Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘
        let filtered = tasks;
        if (currentTaskFilter === 'active') {
            filtered = tasks.filter(t => !t.completed);
        } else if (currentTaskFilter === 'completed') {
            filtered = tasks.filter(t => t.completed);
        }
        
        if (filtered.length === 0) {
            list.innerHTML = `
                <div class="text-center opacity-50 py-8">
                    <i class="fas fa-clipboard-list text-4xl mb-2"></i>
                    <p class="text-sm">${currentTaskFilter === 'completed' ? 'Р СњР ВµРЎвЂљ Р Р†РЎвЂ№Р С—Р С•Р В»Р Р…Р ВµР Р…Р Р…РЎвЂ№РЎвЂ¦ Р В·Р В°Р Т‘Р В°РЎвЂЎ' : currentTaskFilter === 'active' ? 'Р вЂ™РЎРѓР Вµ Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘ Р Р†РЎвЂ№Р С—Р С•Р В»Р Р…Р ВµР Р…РЎвЂ№!' : 'Р СњР ВµРЎвЂљ Р В·Р В°Р Т‘Р В°РЎвЂЎ'}</p>
                </div>
            `;
        } else {
            list.innerHTML = filtered.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${task.id}', ${!task.completed})">
                        ${task.completed ? '<i class="fas fa-check text-xs"></i>' : ''}
                    </div>
                    <span class="task-text flex-1 text-sm">${escapeHtml(task.text)}</span>
                    <button onclick="deleteTask('${task.id}')" class="w-8 h-8 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљР С‘РЎРѓРЎвЂљР С‘Р С”РЎС“
        const stats = document.getElementById('tasks-stats');
        const completed = tasks.filter(t => t.completed).length;
        const total = tasks.length;
        if (stats) {
            stats.textContent = `${completed}/${total} Р Р†РЎвЂ№Р С—Р С•Р В»Р Р…Р ВµР Р…Р С•`;
        }
    }
    
    window.addTask = async () => {
        const input = document.getElementById('new-task-input');
        if (!input || !me) return;
        
        const text = input.value.trim();
        if (!text) return;
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', me.uid, 'tasks'), {
                text: text,
                completed: false,
                createdAt: serverTimestamp()
            });
            input.value = '';
            showToast('Р вЂ”Р В°Р Т‘Р В°РЎвЂЎР В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р В°', 'РІСљвЂ¦');
        } catch (e) {
            console.error('Error adding task:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В°', 'РІСњРЉ');
        }
    };
    
    window.toggleTask = async (taskId, completed) => {
        if (!me) return;
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'tasks', taskId), {
                completed: completed,
                completedAt: completed ? serverTimestamp() : null
            }, { merge: true });
        } catch (e) {
            console.error('Error toggling task:', e);
        }
    };
    
    window.deleteTask = async (taskId) => {
        if (!me) return;
        
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'tasks', taskId));
            showToast('Р вЂ”Р В°Р Т‘Р В°РЎвЂЎР В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р В°', 'СЂСџвЂ”вЂРїС‘РЏ');
        } catch (e) {
            console.error('Error deleting task:', e);
        }
    };
    
    window.filterTasks = (filter) => {
        currentTaskFilter = filter;
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ РЎвЂћР С‘Р В»РЎРЉРЎвЂљРЎР‚Р С•Р Р†
        document.querySelectorAll('.task-filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filter) {
                btn.classList.add('active');
            }
        });
        
        // Р СџР ВµРЎР‚Р ВµР В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘ РЎРѓ Р Р…Р С•Р Р†РЎвЂ№Р С РЎвЂћР С‘Р В»РЎРЉРЎвЂљРЎР‚Р С•Р С
        loadTasks();
    };
    
    window.clearCompletedTasks = async () => {
        if (!me) return;
        
        try {
            const tasksRef = collection(db, 'artifacts', appId, 'users', me.uid, 'tasks');
            const q = query(tasksRef, where('completed', '==', true));
            const snap = await getDocs(q);
            
            const batch = [];
            snap.docs.forEach(d => {
                batch.push(deleteDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'tasks', d.id)));
            });
            
            await Promise.all(batch);
            showToast('Р вЂ™РЎвЂ№Р С—Р С•Р В»Р Р…Р ВµР Р…Р Р…РЎвЂ№Р Вµ Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘ РЎС“Р Т‘Р В°Р В»Р ВµР Р…РЎвЂ№', 'СЂСџвЂ”вЂРїС‘РЏ');
        } catch (e) {
            console.error('Error clearing tasks:', e);
        }
    };

    window.selectChat = async (partner) => {
        isSavedMessagesOpen = false;
        if (savedMessagesUnsub) {
            savedMessagesUnsub();
            savedMessagesUnsub = null;
        }
        
        activeChatPartner = partner;
        activeGroup = null; // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎС“РЎР‹ Р С–РЎР‚РЎС“Р С—Р С—РЎС“
        
        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎРѓРЎвЂљР С‘Р В»РЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
        if (window.applyChatStyle) window.applyChatStyle();
        
        // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° (Р В°Р С–РЎР‚Р ВµРЎРѓРЎРѓР С‘Р Р†Р Р…Р С•)
        const removeBanner = () => {
            const groupCallBanner = document.getElementById('group-call-banner');
            if (groupCallBanner) groupCallBanner.remove();
        };
        removeBanner();
        setTimeout(removeBanner, 100);
        
        if (activeGroupCallUnsub) {
            activeGroupCallUnsub();
            activeGroupCallUnsub = null;
        }
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р С•Р Р†
        const callBtns = document.querySelectorAll('[onclick^="startCall"]');
        callBtns.forEach(btn => btn.style.display = '');
        
        document.getElementById('chat-placeholder').classList.add('hidden');
        document.getElementById('active-chat').classList.remove('hidden');
        document.getElementById('target-name').innerText = "@" + partner.username;
        
        // Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…Р В°РЎРЏ Р Р…Р В°Р Р†Р С‘Р С–Р В°РЎвЂ Р С‘РЎРЏ - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂЎР В°РЎвЂљ
        mobileShowChat();
        if (isMobileView) history.pushState({ chat: true }, '');
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ Р Т‘Р В»РЎРЏ Р В»Р С‘РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ РЎвЂЎР В°РЎвЂљР С•Р Р†
        document.getElementById('online-status').style.display = 'block';
        document.getElementById('online-indicator').classList.remove('hidden');
        
        // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С”Р С•Р С–Р Т‘Р В° РЎРѓР С•Р В±Р ВµРЎРѓР ВµР Т‘Р Р…Р С‘Р С” Р С—Р ВµРЎвЂЎР В°РЎвЂљР В°Р ВµРЎвЂљ
        if (typeof listenToPartnerTyping === 'function') {
            listenToPartnerTyping(partner.uid);
        }
        
        // Р С›РЎвЂљР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР СРЎРѓРЎРЏ Р С•РЎвЂљ Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР С–Р С• РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»РЎРЏ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ
        if (partnerUnsub) {
            partnerUnsub();
            partnerUnsub = null;
        }
        
        // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ РЎРѓР С•Р В±Р ВµРЎРѓР ВµР Т‘Р Р…Р С‘Р С”Р В° Р Р† РЎР‚Р ВµР В°Р В»РЎРЉР Р…Р С•Р С Р Р†РЎР‚Р ВµР СР ВµР Р…Р С‘
        const targetAvatar = document.getElementById('target-avatar');
        const targetName = document.getElementById('target-name');
        const onlineStatus = document.getElementById('online-status');
        const onlineIndicator = document.getElementById('online-indicator');
        
        partnerUnsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', partner.uid), (userDoc) => {
            if (userDoc.exists()) {
                const userData = userDoc.data();
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”РЎС“
                if (userData.avatar) {
                    targetAvatar.innerHTML = `<img src="${userData.avatar}" class="w-full h-full object-cover rounded-xl">`;
                    // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р В»Р В°РЎРѓРЎРѓ Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘ Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ Premium
                    if (userData.animatedAvatar && checkUserPremium(userData)) {
                        targetAvatar.classList.add('avatar-animated');
                    } else {
                        targetAvatar.classList.remove('avatar-animated');
                    }
                } else {
                    targetAvatar.innerText = (userData.username || partner.username)[0].toUpperCase();
                    targetAvatar.classList.remove('avatar-animated');
                }
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С‘Р СРЎРЏ (Р ВµРЎРѓР В»Р С‘ Р С‘Р В·Р СР ВµР Р…Р С‘Р В»Р С•РЎРѓРЎРЉ) + Premium badge
                if (userData.username) {
                    const premiumBadge = checkUserPremium(userData) ? ` ${getPremiumBadgeHtml(true)}` : '';
                    targetName.innerHTML = `@${userData.username}${premiumBadge}`;
                    activeChatPartner.username = userData.username;
                }
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ (Р В°Р С–РЎР‚Р ВµРЎРѓРЎРѓР С‘Р Р†Р Р…Р В°РЎРЏ Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° - РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎвЂћР В»Р В°Р С– isOnline)
                const isOnline = userData.isOnline === true;
                
                if (isOnline) {
                    onlineStatus.innerHTML = '<span class="text-green-500">' + (currentLang === 'ru' ? 'Р Р† РЎРѓР ВµРЎвЂљР С‘' : 'online') + '</span>';
                    onlineIndicator.className = 'absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-slate-900';
                } else {
                    onlineStatus.innerHTML = formatLastSeen(userData.lastSeen);
                    onlineIndicator.className = 'absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-gray-400 rounded-full border-2 border-white dark:border-slate-900';
                }
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”РЎС“ Р Р† РЎРѓР С—Р С‘РЎРѓР С”Р Вµ РЎвЂЎР В°РЎвЂљР С•Р Р†
                const chatItem = document.querySelector(`[data-chat-uid="${partner.uid}"] .chat-avatar`);
                if (chatItem) {
                    if (userData.avatar) {
                        chatItem.innerHTML = `<img src="${userData.avatar}" class="w-full h-full object-cover">`;
                    } else {
                        chatItem.innerText = (userData.username || partner.username)[0].toUpperCase();
                    }
                }
            }
        });

        if (msgUnsub) msgUnsub();
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘Р Вµ Р Р…Р В° Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        checkChatPermission();
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        loadPinnedMessage(false);
        
        const chatId = [me.uid, partner.uid].sort().join('_');
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), orderBy('timestamp', 'asc'));
        
        console.log('Subscribing to chat:', chatId);
        console.log('Using appId:', appId);
        console.log('Full path: artifacts/' + appId + '/public/data/chats/' + chatId + '/messages');
        
        let isFirstLoad = true;
        msgUnsub = onSnapshot(q, (snap) => {
            console.log('Messages snapshot received:', snap.size, 'messages');
            const cont = document.getElementById('messages-container');
            const shouldScroll = cont.scrollTop + cont.offsetHeight >= cont.scrollHeight - 100;
            
            // Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р С• Р Р…Р С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏРЎвЂ¦ (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С—Р С•РЎРѓР В»Р Вµ Р С—Р ВµРЎР‚Р Р†Р С•Р в„– Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘)
            if (!isFirstLoad) {
                snap.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const m = change.doc.data();
                        // Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»РЎРЏР ВµР С РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏРЎвЂ¦ Р С•РЎвЂљ Р Т‘РЎР‚РЎС“Р С–Р С‘РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
                        if (m.senderId !== me.uid && !m.deleted) {
                            // Р вЂўРЎРѓР В»Р С‘ Р С•Р С”Р Р…Р С• Р Р…Р Вµ Р Р† РЎвЂћР С•Р С”РЎС“РЎРѓР Вµ - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
                            if (document.hidden || !document.hasFocus()) {
                                let msgText = m.text || '';
                                if (m.encrypted && msgText) msgText = decrypt(msgText);
                                if (m.type === 'voice') msgText = 'СЂСџР‹В¤ Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ';
                                if (m.type === 'videoCircle') msgText = 'СЂСџР‹Тђ Р вЂ™Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С•Р С”';
                                if (m.type === 'file') msgText = 'СЂСџвЂњР‹ ' + (m.fileName || 'Р В¤Р В°Р в„–Р В»');
                                if (m.type === 'gift') msgText = 'СЂСџР‹Рѓ Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С”';
                                showNotification(partner, msgText || 'Р СњР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ');
                            }
                        }
                    }
                });
            }
            isFirstLoad = false;
            
            // Р С›Р С—РЎвЂљР С‘Р СР С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ: Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С DocumentFragment Р Т‘Р В»РЎРЏ batch-РЎР‚Р ВµР Р…Р Т‘Р ВµРЎР‚Р С‘Р Р…Р С–Р В°
            const fragment = document.createDocumentFragment();
            const isMobile = isMobileDevice();
            
            cont.innerHTML = '';
            snap.forEach(d => {
                const m = d.data();
                const msgId = d.id;
                const div = document.createElement('div');
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С• Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р Т‘Р В»РЎРЏ РЎвЂљР ВµР С”РЎС“РЎвЂ°Р ВµР С–Р С• Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ (Р С•РЎвЂЎР С‘РЎРѓРЎвЂљР С”Р В° Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘Р С‘)
                if (m.deletedFor && m.deletedFor[me.uid]) {
                    return; // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ, РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· "Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹"
                }
                
                // Р СњР В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ Р С•РЎвЂљР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘Р С‘ РЎвЂЎР ВµРЎР‚Р ВµР В· inline style
                const mobileStyle = isMobile ? 'animation:none;opacity:1;transform:none;' : '';
                div.className = `message-bubble p-4 shadow-sm ${m.senderId === me.uid ? 'sent' : 'received'}`;
                if (mobileStyle) div.style.cssText = mobileStyle;
                div.dataset.msgId = msgId;
                div.dataset.senderId = m.senderId;
                
                // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р В°Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ Р Т‘Р В»РЎРЏ РЎвЂљР В°Р в„–Р СР ВµРЎР‚Р В°
                if (m.autoDestruct && m.autoDestruct > 0) {
                    div.dataset.autoDestruct = m.autoDestruct;
                    div.dataset.destructStart = m.destructStartTime || '';
                }
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С• Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•
                const deletedMsgs = JSON.parse(localStorage.getItem('flickers-deleted-msgs') || '[]');
                if (deletedMsgs.includes(msgId)) {
                    return; // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№Р Вµ Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
                }
                
                // Р В Р В°РЎРѓРЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂљР ВµР С”РЎРѓРЎвЂљ
                let displayText = m.text || '';
                if (m.encrypted && displayText) {
                    displayText = decrypt(displayText);
                }
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С• Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С–Р В»Р С•Р В±Р В°Р В»РЎРЉР Р…Р С•
                if (m.deleted) {
                    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р В±РЎвЂ№Р В»Р С• Р В»Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С• Р Р…Р ВµР Т‘Р В°Р Р†Р Р…Р С• (Р Р† РЎвЂљР ВµРЎвЂЎР ВµР Р…Р С‘Р Вµ 3 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘)
                    const deletedAt = m.deletedAt || 0;
                    const isRecentlyDeleted = Date.now() - deletedAt < 3000;
                    
                    if (isRecentlyDeleted) {
                        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹ РЎС“Р В±Р ВµР С–Р В°Р Р…Р С‘РЎРЏ
                        div.innerHTML = `<p class="text-sm">СЂСџвЂвЂ№</p>`;
                        div.style.position = 'relative';
                        div.style.overflow = 'visible';
                        
                        const legs = document.createElement('div');
                        legs.className = 'message-legs';
                        legs.innerHTML = '<span class="leg">СЂСџВ¦Вµ</span><span class="leg">СЂСџВ¦Вµ</span>';
                        div.appendChild(legs);
                        
                        div.classList.add('message-running-away');
                        cont.appendChild(div);
                        
                        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљ Р С—Р С•РЎРѓР В»Р Вµ Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘Р С‘
                        setTimeout(() => div.remove(), 1500);
                    }
                    return;
                }
                
                // Р вЂР ВµР в„–Р Т‘Р В¶Р С‘ Р В±Р ВµР В·Р С•Р С—Р В°РЎРѓР Р…Р С•РЎРѓРЎвЂљР С‘ - РЎвЂљР В°Р в„–Р СР ВµРЎР‚ Р В°Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ
                let destructTimerHtml = '';
                if (m.autoDestruct && m.autoDestruct > 0) {
                    destructTimerHtml = `<span class="destruct-timer" id="timer-${msgId}"><i class="fas fa-fire"></i> <span class="timer-value">${m.autoDestruct}РЎРѓ</span></span>`;
                }
                
                // Р вЂР ВµР в„–Р Т‘Р В¶ РЎР‚Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘РЎРЏ
                const editedBadge = m.edited ? `<span class="edited-badge">(${t('edited')})</span>` : '';
                
                // Р В¦Р С‘РЎвЂљР В°РЎвЂљР В° Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°
                let replyQuoteHtml = '';
                if (m.replyTo) {
                    replyQuoteHtml = `
                        <div class="reply-quote" onclick="scrollToMessage('${m.replyTo.msgId}')">
                            <div class="reply-quote-author">${m.replyTo.author}</div>
                            <div class="reply-quote-text">${m.replyTo.text}</div>
                        </div>
                    `;
                }
                
                // Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°Р Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
                let forwardedHtml = '';
                if (m.forwarded) {
                    forwardedHtml = `<div class="forwarded-label"><i class="fas fa-share"></i> Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°Р Р…Р С• Р С•РЎвЂљ ${m.forwardedFrom}</div>`;
                }
                
                // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С linkify Р Т‘Р В»РЎРЏ РЎвЂљР ВµР С”РЎРѓРЎвЂљР С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
                const linkedText = (!m.type || m.type === 'text') ? linkifyText(displayText) : displayText;
                let content = `<p class="text-sm leading-relaxed">${linkedText}${editedBadge}</p>`;
                
                // Р ВР С–РЎР‚Р С•Р Р†РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ (Р С”РЎР‚Р ВµРЎРѓРЎвЂљР С‘Р С”Р С‘-Р Р…Р С•Р В»Р С‘Р С”Р С‘)
                if (m.type === 'ttt_invite') {
                    const gameHtml = renderGameMessage(m, msgId, m.senderId === me.uid);
                    if (gameHtml) {
                        div.className = `message-bubble p-0 shadow-sm ${m.senderId === me.uid ? 'sent' : 'received'}`;
                        div.innerHTML = gameHtml;
                        cont.appendChild(div);
                        
                        // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»РЎРЉ Р С‘Р С–РЎР‚РЎвЂ№
                        setTimeout(() => setupGameListener(m.gameId, div), 100);
                        return;
                    }
                }
                
                // Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С• Р В·Р Р†Р С•Р Р…Р С”Р Вµ
                if (m.type === 'call') {
                    const isMine = m.senderId === me.uid;
                    div.className = `message-bubble call-message p-3 shadow-sm ${isMine ? 'sent' : 'received'}`;
                    
                    const callIconClass = m.wasAnswered ? 'text-green-500' : 'text-red-500';
                    const phoneIcon = m.isVideo ? 'fa-video' : 'fa-phone-alt';
                    
                    div.innerHTML = `
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex-1">
                                <p class="font-bold text-sm">${m.callType}</p>
                                <p class="text-xs opacity-70">
                                    <span class="${callIconClass}">${m.callIcon}</span> 
                                    ${m.callTime}${m.callDuration ? ', ' + m.callDuration : ''}
                                </p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center ${callIconClass}">
                                <i class="fas ${phoneIcon}"></i>
                            </div>
                        </div>
                    `;
                    cont.appendChild(div);
                    return;
                }
                
                // Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ (polls)
                if (m.type === 'poll') {
                    const pollHtml = renderPollMessage(m, msgId, m.senderId === me.uid);
                    div.className = `message-bubble p-3 shadow-sm ${m.senderId === me.uid ? 'sent' : 'received'}`;
                    div.innerHTML = pollHtml + `<span class="text-[9px] block mt-2 opacity-50 text-right">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</span>`;
                    cont.appendChild(div);
                    return;
                }
                
                // Р вЂњР ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘РЎРЏ
                if (m.type === 'location') {
                    const locationHtml = renderLocationMessage(m);
                    div.className = `message-bubble p-2 shadow-sm ${m.senderId === me.uid ? 'sent' : 'received'}`;
                    div.innerHTML = locationHtml + `<span class="text-[9px] block mt-1 opacity-50 text-right">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</span>`;
                    cont.appendChild(div);
                    return;
                }
                
                // Р СљР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘Р Вµ
                if (m.type === 'event') {
                    const eventHtml = renderEventMessage(m, msgId);
                    div.className = `message-bubble p-0 shadow-sm overflow-hidden ${m.senderId === me.uid ? 'sent' : 'received'}`;
                    div.innerHTML = eventHtml;
                    cont.appendChild(div);
                    return;
                }
                
                // Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С” РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†
                if (m.type === 'gift') {
                    const isMine = m.senderId === me.uid;
                    div.className = `message-bubble gift-message shadow-lg ${isMine ? 'sent' : 'received'}`;
                    const priceText = m.giftPrice >= 100000000 ? (m.giftPrice/1000000)+'M' : m.giftPrice >= 1000000 ? (m.giftPrice/1000000)+'M' : m.giftPrice >= 1000 ? (m.giftPrice/1000)+'K' : m.giftPrice;
                    
                    // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С SVG Р С‘Р С”Р С•Р Р…Р С”РЎС“ РЎРѓ fallback
                    let giftIcon = 'СЂСџР‹Рѓ';
                    if (window.giftSVGs && m.giftId && window.giftSVGs[m.giftId]) {
                        giftIcon = window.giftSVGs[m.giftId];
                    } else if (window.giftSVGs && window.giftSVGs.gift) {
                        giftIcon = window.giftSVGs.gift;
                    }
                    
                    div.innerHTML = `
                        <div class="gift-message-content text-white">
                            <div class="gift-icon">${giftIcon}</div>
                            <div class="text-lg font-bold">${m.giftName || 'Р СџР С•Р Т‘Р В°РЎР‚Р С•Р С”'}</div>
                            <div class="text-xs opacity-80 mb-1">${priceText}СЂСџвЂ™Р‹</div>
                            <div class="gift-text text-xs">${isMine ? `Р вЂ™РЎвЂ№ Р С—Р С•Р Т‘Р В°РЎР‚Р С‘Р В»Р С‘ @${m.recipientName}` : `@${m.senderName} Р С—Р С•Р Т‘Р В°РЎР‚Р С‘Р В» Р Р†Р В°Р С`}</div>
                            ${m.giftMessage ? `<div class="text-sm mt-2 italic opacity-90">"${m.giftMessage}"</div>` : ''}
                            <div class="text-[9px] mt-2 opacity-60">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</div>
                        </div>
                    `;
                    cont.appendChild(div);
                    
                    // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹ Р ВµРЎРѓР В»Р С‘ РЎРЊРЎвЂљР С• Р Р…Р С•Р Р†РЎвЂ№Р в„– Р С—Р С•Р Т‘Р В°РЎР‚Р С•Р С” Р Т‘Р В»РЎРЏ Р Р…Р В°РЎРѓ
                    if (!isMine && !div.dataset.animShown) {
                        div.dataset.animShown = 'true';
                        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎвЂЎРЎвЂљР С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎРѓР Р†Р ВµР В¶Р ВµР Вµ (Р СР ВµР Р…Р ВµР Вµ 5 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘)
                        if (m.timestamp && (Date.now() - m.timestamp.seconds * 1000) < 5000) {
                            setTimeout(() => {
                                showGiftReceivedAnimation(m.giftId, m.giftName, m.senderName, m.giftMessage, m.giftPrice);
                            }, 300);
                        }
                    }
                    
                    if (shouldScroll) cont.scrollTop = cont.scrollHeight;
                    return;
                }
                
                // Р РЋРЎвЂљР С‘Р С”Р ВµРЎР‚РЎвЂ№
                if (m.type === 'sticker') {
                    content = `<span style="font-size: 64px;">${m.sticker}</span>`;
                }
                
                // GIF
                if (m.type === 'gif') {
                    content = `<img src="${m.gifUrl}" class="chat-image rounded-xl max-w-full cursor-pointer hover:brightness-90 transition-all" style="max-height: 200px;" onclick="openMediaViewer('${m.gifUrl.replace(/'/g, "\\'")}', 'image')">`;
                }
                
                if (m.type === 'voice') {
                    const dur = m.voiceDuration || 0;
                    const msgId = m.id || Date.now();
                    const transcriptText = m.transcript ? `<div class="voice-transcript">${m.transcript}</div>` : '';
                    content = `
                        <div class="voice-message" data-voice-id="${msgId}">
                            <button class="voice-play-btn" onclick="playVoice(this, '${m.voiceData}', ${dur})">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="flex-1">
                                <div class="voice-progress" onclick="seekVoice(event, this)">
                                    <div class="voice-progress-fill"></div>
                                </div>
                                <span class="voice-time text-[10px] opacity-60">0:${dur.toString().padStart(2, '0')}</span>
                            </div>
                            <button class="voice-transcribe-btn" onclick="transcribeVoice(this, '${m.voiceData}', '${msgId}')" title="Р В Р В°РЎРѓРЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        </div>
                        ${transcriptText}
                    `;
                } else if (m.type === 'video_circle') {
                    // Р вЂ™Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С•Р С” (Р С”Р В°Р С” Р Р† Telegram)
                    const dur = m.videoDuration || 0;
                    const mins = Math.floor(dur / 60);
                    const secs = dur % 60;
                    const durationText = `${mins}:${secs.toString().padStart(2, '0')}`;
                    content = `
                        <div class="video-circle-message" ondblclick="openMediaViewer('${m.videoData.replace(/'/g, "\\'")}', 'video')">
                            <video 
                                src="${m.videoData}" 
                                onclick="playVideoCircle(this)"
                                playsinline
                                loop
                                style="transform: scaleX(-1);"
                            ></video>
                            <span class="video-circle-duration"><i class="fas fa-play-circle"></i> ${durationText}</span>
                        </div>
                    `;
                } else if (m.type === 'file') {
                    if (m.fileType && m.fileType.startsWith('image/')) {
                        content = `<img src="${m.fileData}" loading="lazy" decoding="async" class="chat-image rounded-xl max-w-full mb-2 cursor-pointer hover:brightness-90 transition-all shadow-md" onclick="openMediaViewer('${m.fileData.replace(/'/g, "\\'")}', 'image')">` + content;
                    } else if (m.fileType && m.fileType.startsWith('video/')) {
                        // Р вЂ™Р С‘Р Т‘Р ВµР С• РЎвЂћР В°Р в„–Р В»РЎвЂ№
                        content = `
                            <div class="relative mb-2 cursor-pointer" onclick="openMediaViewer('${m.fileData.replace(/'/g, "\\'")}', 'video')">
                                <video src="${m.fileData}" class="chat-video rounded-xl max-w-full shadow-md" style="max-height: 300px;" preload="metadata"></video>
                                <div class="absolute inset-0 flex items-center justify-center bg-black/30 rounded-xl hover:bg-black/40 transition-all">
                                    <div class="w-14 h-14 rounded-full bg-white/90 flex items-center justify-center">
                                        <i class="fas fa-play text-indigo-500 text-xl ml-1"></i>
                                    </div>
                                </div>
                            </div>
                        ` + content;
                    } else {
                        const fileSize = m.fileSize ? formatFileSize(m.fileSize) : '';
                        const sizeText = fileSize ? ` (${fileSize})` : '';
                        content = `<a href="${m.fileData}" download="${m.fileName}" target="_blank" class="flex items-center space-x-3 bg-black/5 p-3 rounded-xl text-xs font-bold hover:bg-black/10 transition-colors mb-2"><i class="fas fa-file-download text-lg"></i> <div><p class="truncate w-40">${m.fileName}</p><p class="opacity-50 font-normal">Р РЋР С”Р В°РЎвЂЎР В°РЎвЂљРЎРЉ РЎвЂћР В°Р в„–Р В»${sizeText}</p></div></a>` + content;
                    }
                }
                
                // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С‘Р СРЎРЏ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљР ВµР В»РЎРЏ (Р В°Р Р…Р С•Р Р…Р С‘Р СР Р…Р С•Р Вµ Р С‘Р В»Р С‘ РЎР‚Р ВµР В°Р В»РЎРЉР Р…Р С•Р Вµ)
                const senderLabel = m.senderName === 'anonymous' ? 'СЂСџвЂВ¤ Р С’Р Р…Р С•Р Р…Р С‘Р С' : '';
                const senderHtml = senderLabel && m.senderId !== me.uid ? `<span class="text-[9px] opacity-50 block mb-1">${senderLabel}</span>` : '';
                
                // Р В Р ВµР В°Р С”РЎвЂ Р С‘Р С‘
                const reactionsHtml = renderReactions(m.reactions, msgId, false);
                
                // Р ВР С”Р С•Р Р…Р С”Р В° РЎРѓР Р†Р В°Р в„–Р С—Р В° Р Т‘Р В»РЎРЏ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°
                const swipeHint = '<div class="swipe-reply-hint"><i class="fas fa-reply"></i></div>';
                
                // Р вЂ™РЎР‚Р ВµР СРЎРЏ + РЎвЂљР В°Р в„–Р СР ВµРЎР‚ Р В°Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ + Р С—РЎР‚Р С•РЎвЂЎР С‘РЎвЂљР В°Р Р…Р С•
                const timeStr = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                const isMine = m.senderId === me.uid;
                
                // Р вЂњР В°Р В»Р С•РЎвЂЎР С”Р С‘ Р С—РЎР‚Р С•РЎвЂЎРЎвЂљР ВµР Р…Р С‘РЎРЏ Р Т‘Р В»РЎРЏ РЎРѓР Р†Р С•Р С‘РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
                let readReceiptHtml = '';
                if (isMine) {
                    if (m.readAt) {
                        const readTime = new Date(m.readAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        readReceiptHtml = `<span class="read-receipt read" title="Р СџРЎР‚Р С•РЎвЂЎР С‘РЎвЂљР В°Р Р…Р С• Р Р† ${readTime}"><i class="fas fa-check-double"></i></span>`;
                    } else {
                        readReceiptHtml = `<span class="read-receipt" title="Р вЂќР С•РЎРѓРЎвЂљР В°Р Р†Р В»Р ВµР Р…Р С•"><i class="fas fa-check"></i></span>`;
                    }
                }
                
                const timeHtml = `<span class="text-[9px] block mt-1 opacity-50 text-right">${timeStr}${readReceiptHtml}${destructTimerHtml}</span>`;
                
                div.innerHTML = swipeHint + forwardedHtml + replyQuoteHtml + senderHtml + content + reactionsHtml + timeHtml;
                
                // Р СџР С•Р СР ВµРЎвЂЎР В°Р ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С”Р В°Р С” Р С—РЎР‚Р С•РЎвЂЎР С‘РЎвЂљР В°Р Р…Р Р…Р С•Р Вµ (Р Т‘Р В»РЎРЏ РЎвЂЎРЎС“Р В¶Р С‘РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–)
                if (!isMine && !m.readAt && activeChatPartner) {
                    const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                    const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
                    updateDoc(msgRef, { readAt: Date.now(), readBy: me.uid }).catch(() => {});
                }
                
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ Р С—Р С• Р С—РЎР‚Р В°Р Р†Р С•Р СРЎС“ Р С”Р В»Р С‘Р С”РЎС“
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showMessageContextMenu(e, msgId, m.senderId === me.uid, m.text, m.encrypted, m.type);
                });
                
                // Р вЂќР С•Р В»Р С–Р С•Р Вµ Р Р…Р В°Р В¶Р В°РЎвЂљР С‘Р Вµ Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
                setupLongPress(div, (e) => {
                    const touch = e.touches ? e.touches[0] : e;
                    showMessageContextMenu({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => {} }, msgId, m.senderId === me.uid, m.text, m.encrypted, m.type);
                });
                
                // Р вЂќР Р†Р С•Р в„–Р Р…Р С•Р в„– Р С”Р В»Р С‘Р С” Р Т‘Р В»РЎРЏ Р В±РЎвЂ№РЎРѓРЎвЂљРЎР‚Р С•Р в„– РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘Р С‘ РІСњВ¤РїС‘РЏ
                div.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    addReaction(msgId, 'РІСњВ¤РїС‘РЏ', false);
                });
                
                // Р РЋР Р†Р В°Р в„–Р С— Р Р†Р С—РЎР‚Р В°Р Р†Р С• Р Т‘Р В»РЎРЏ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° (Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№Р Вµ)
                setupSwipeToReply(div, msgId, false);
                
                cont.appendChild(div);
                
                // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ РЎРѓРЎРѓРЎвЂ№Р В»Р С•Р С” Р Т‘Р В»РЎРЏ РЎвЂљР ВµР С”РЎРѓРЎвЂљР С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
                if ((!m.type || m.type === 'text') && displayText) {
                    loadLinkPreviewForMessage(div, displayText);
                }
                
                // Р С’Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С—Р С•РЎРѓР В»Р Вµ Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р В° (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Р С—Р С•Р В»РЎС“РЎвЂЎР В°РЎвЂљР ВµР В»РЎРЏ)
                if (m.autoDestruct && m.autoDestruct > 0 && m.senderId !== me.uid) {
                    const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                    const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
                    
                    let remaining;
                    
                    if (m.destructStartTime) {
                        // Р СћР В°Р в„–Р СР ВµРЎР‚ РЎС“Р В¶Р Вµ Р В±РЎвЂ№Р В» Р В·Р В°Р С—РЎС“РЎвЂ°Р ВµР Р… - Р Р†РЎвЂ№РЎвЂЎР С‘РЎРѓР В»РЎРЏР ВµР С Р С•РЎРѓРЎвЂљР В°Р Р†РЎв‚¬Р ВµР ВµРЎРѓРЎРЏ Р Р†РЎР‚Р ВµР СРЎРЏ
                        const elapsed = Math.floor((Date.now() - m.destructStartTime) / 1000);
                        remaining = m.autoDestruct - elapsed;
                        
                        // Р вЂўРЎРѓР В»Р С‘ Р Р†РЎР‚Р ВµР СРЎРЏ РЎС“Р В¶Р Вµ Р Р†РЎвЂ№РЎв‚¬Р В»Р С• - РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎР‚Р В°Р В·РЎС“
                        if (remaining <= 0) {
                            div.classList.add('message-destructing');
                            updateDoc(msgRef, { deleted: true, deletedAt: Date.now(), text: '' }).catch(() => {});
                            setTimeout(() => div.remove(), 600);
                            return;
                        }
                    } else {
                        // Р СџР ВµРЎР‚Р Р†РЎвЂ№Р в„– Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ - Р В·Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎвЂљР В°Р в„–Р СР ВµРЎР‚
                        remaining = m.autoDestruct;
                        updateDoc(msgRef, { destructStartTime: Date.now() }).catch(() => {});
                    }
                    
                    // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С•РЎвЂљР С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ РЎвЂљР В°Р в„–Р СР ВµРЎР‚Р В°
                    const timerEl = document.getElementById(`timer-${msgId}`);
                    if (timerEl) {
                        const timerValue = timerEl.querySelector('.timer-value');
                        if (timerValue) {
                            if (remaining >= 60) {
                                timerValue.textContent = Math.floor(remaining / 60) + 'Р С ' + (remaining % 60) + 'РЎРѓ';
                            } else {
                                timerValue.textContent = remaining + 'РЎРѓ';
                            }
                        }
                    }
                    
                    // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р С•Р В±РЎР‚Р В°РЎвЂљР Р…РЎвЂ№Р в„– Р С•РЎвЂљРЎРѓРЎвЂЎРЎвЂРЎвЂљ
                    const countdownTimer = setInterval(() => {
                        remaining--;
                        const timerElNow = document.getElementById(`timer-${msgId}`);
                        if (timerElNow) {
                            const timerValue = timerElNow.querySelector('.timer-value');
                            if (timerValue) {
                                if (remaining >= 60) {
                                    timerValue.textContent = Math.floor(remaining / 60) + 'Р С ' + (remaining % 60) + 'РЎРѓ';
                                } else {
                                    timerValue.textContent = remaining + 'РЎРѓ';
                                }
                            }
                        }
                        
                        if (remaining <= 0) {
                            clearInterval(countdownTimer);
                        }
                    }, 1000);
                    
                    // Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· Р С•РЎРѓРЎвЂљР В°Р Р†РЎв‚¬Р ВµР ВµРЎРѓРЎРЏ Р Р†РЎР‚Р ВµР СРЎРЏ
                    setTimeout(async () => {
                        clearInterval(countdownTimer);
                        
                        // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С РЎвЂЎР В°РЎРѓРЎвЂљР С‘РЎвЂ РЎвЂ№ Р Т‘Р В»РЎРЏ РЎРЊРЎвЂћРЎвЂћР ВµР С”РЎвЂљР В°
                        const particles = document.createElement('div');
                        particles.className = 'destruct-particles';
                        for (let i = 0; i < 8; i++) {
                            const p = document.createElement('div');
                            p.className = 'destruct-particle';
                            p.style.left = Math.random() * 100 + '%';
                            p.style.top = Math.random() * 100 + '%';
                            p.style.setProperty('--tx', (Math.random() - 0.5) * 100 + 'px');
                            p.style.setProperty('--ty', -Math.random() * 80 - 20 + 'px');
                            p.style.background = ['#6366f1', '#8b5cf6', '#ec4899'][Math.floor(Math.random() * 3)];
                            particles.appendChild(p);
                        }
                        div.style.position = 'relative';
                        div.appendChild(particles);
                        
                        // Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р С”Р В°Р С” Р Р† Telegram
                        div.classList.add('message-destructing');
                        
                        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р С‘Р В· Firebase
                        try {
                            await updateDoc(msgRef, { 
                                deleted: true, 
                                deletedAt: Date.now(),
                                text: ''
                            });
                        } catch(e) {
                            console.log('Auto-destruct error:', e);
                        }
                        
                        setTimeout(() => div.remove(), 600);
                    }, remaining * 1000);
                }
            });
            if(shouldScroll) cont.scrollTop = cont.scrollHeight;
        }, (error) => {
            console.error('Messages onSnapshot error:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
        });
    };

    // ========== Р С™Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– ==========
    let currentContextMenu = null;
    
    // Р В¤РЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ Р Т‘Р В»РЎРЏ Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р Т‘Р С•Р В»Р С–Р С•Р С–Р С• Р Р…Р В°Р В¶Р В°РЎвЂљР С‘РЎРЏ (Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦)
    function setupLongPress(element, callback, duration = 500) {
        let timer = null;
        let startX, startY;
        
        const start = (e) => {
            // Р вЂ”Р В°Р С—Р С•Р СР С‘Р Р…Р В°Р ВµР С Р Р…Р В°РЎвЂЎР В°Р В»РЎРЉР Р…РЎС“РЎР‹ Р С—Р С•Р В·Р С‘РЎвЂ Р С‘РЎР‹
            const touch = e.touches ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            
            timer = setTimeout(() => {
                // Р вЂ™Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘РЎРЏ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
                if (navigator.vibrate) navigator.vibrate(50);
                callback(e);
            }, duration);
        };
        
        const cancel = () => {
            if (timer) {
                clearTimeout(timer);
                timer = null;
            }
        };
        
        const move = (e) => {
            if (!timer) return;
            const touch = e.touches ? e.touches[0] : e;
            const dx = Math.abs(touch.clientX - startX);
            const dy = Math.abs(touch.clientY - startY);
            // Р С›РЎвЂљР СР ВµР Р…РЎРЏР ВµР С Р ВµРЎРѓР В»Р С‘ Р С—Р В°Р В»Р ВµРЎвЂ  РЎРѓР Т‘Р Р†Р С‘Р Р…РЎС“Р В»РЎРѓРЎРЏ Р В±Р С•Р В»РЎРЉРЎв‚¬Р Вµ РЎвЂЎР ВµР С Р Р…Р В° 10px
            if (dx > 10 || dy > 10) cancel();
        };
        
        element.addEventListener('touchstart', start, { passive: true });
        element.addEventListener('touchend', cancel);
        element.addEventListener('touchcancel', cancel);
        element.addEventListener('touchmove', move, { passive: true });
    }
    
    // Р СџР С•Р С”Р В°Р В·Р В°РЎвЂљРЎРЉ Р СР ВµР Р…РЎР‹ Р С—Р С• Р С”Р В»Р С‘Р С”РЎС“ Р Р…Р В° Р С”Р Р…Р С•Р С—Р С”РЎС“ (РЎвЂљРЎР‚Р С‘ РЎвЂљР С•РЎвЂЎР С”Р С‘)
    window.showMsgMenuFromBtn = (btn, msgId, isOwn, text, encrypted, type) => {
        const rect = btn.getBoundingClientRect();
        showMessageContextMenu({ 
            clientX: rect.left, 
            clientY: rect.bottom + 5,
            preventDefault: () => {} 
        }, msgId, isOwn, text, encrypted, type);
    };
    
    function showMessageContextMenu(e, msgId, isOwn, text, encrypted, type) {
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР Вµ Р СР ВµР Р…РЎР‹
        closeContextMenu();
        
        const menu = document.createElement('div');
        menu.className = 'msg-context-menu';
        menu.id = 'msg-context-menu';
        
        const isGroup = !!activeGroup;
        let menuItems = '';
        
        // Р С›РЎвЂљР Р†Р ВµРЎвЂљР С‘РЎвЂљРЎРЉ Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        menuItems += `
            <div class="msg-context-item" onclick="event.stopPropagation(); replyToMessage('${msgId}', ${isGroup})">
                <i class="fas fa-reply"></i> ${currentLang === 'ru' ? 'Р С›РЎвЂљР Р†Р ВµРЎвЂљР С‘РЎвЂљРЎРЉ' : 'Reply'}
            </div>
        `;
        
        // Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°РЎвЂљРЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        menuItems += `
            <div class="msg-context-item" onclick="event.stopPropagation(); forwardMessage('${msgId}', ${isGroup})">
                <i class="fas fa-share"></i> ${currentLang === 'ru' ? 'Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°РЎвЂљРЎРЉ' : 'Forward'}
            </div>
        `;
        
        // Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р С‘РЎвЂљРЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        menuItems += `
            <div class="msg-context-item" onclick="event.stopPropagation(); pinMessage('${msgId}', ${isGroup})">
                <i class="fas fa-thumbtack"></i> ${currentLang === 'ru' ? 'Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р С‘РЎвЂљРЎРЉ' : 'Pin'}
            </div>
        `;
        
        // Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р Р† Р В·Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘
        menuItems += `
            <div class="msg-context-item" onclick="event.stopPropagation(); bookmarkFromContext('${msgId}', ${isGroup})">
                <i class="fas fa-bookmark text-yellow-500"></i> ${currentLang === 'ru' ? 'Р вЂ™ Р В·Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘' : 'Bookmark'}
            </div>
        `;
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р С‘РЎвЂљРЎРЉ Р Р† Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ
        menuItems += `
            <div class="msg-context-item" onclick="event.stopPropagation(); saveToFavorites('${msgId}', ${isGroup})">
                <i class="fas fa-star text-indigo-500"></i> ${currentLang === 'ru' ? 'Р вЂ™ Р С‘Р В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р Вµ' : 'Save'}
            </div>
        `;
        
        menuItems += `<div class="msg-context-divider"></div>`;
        
        // Р С™Р Р…Р С•Р С—Р С”Р В° РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘Р С‘ Р Т‘Р В»РЎРЏ Р Р†РЎРѓР ВµРЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
        menuItems += `
            <div class="msg-context-item" onclick="event.stopPropagation(); openReactionPicker('${msgId}', ${isGroup})">
                <i class="fas fa-smile"></i> ${currentLang === 'ru' ? 'Р В Р ВµР В°Р С”РЎвЂ Р С‘РЎРЏ' : 'React'}
            </div>
        `;
        
        // Р вЂќР В»РЎРЏ РЎРѓР Р†Р С•Р С‘РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– - РЎР‚Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Р С‘ Р С–Р В»Р С•Р В±Р В°Р В»РЎРЉР Р…Р С•Р Вµ РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ
        if (isOwn) {
            // Р В Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ РЎвЂљР ВµР С”РЎРѓРЎвЂљР С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
            if (type !== 'voice' && type !== 'file') {
                menuItems += `
                    <div class="msg-context-item" onclick="event.stopPropagation(); editMessage('${msgId}', ${encrypted})">
                        <i class="fas fa-edit"></i> ${t('editMessage')}
                    </div>
                `;
            }
            menuItems += `
                <div class="msg-context-item danger" onclick="event.stopPropagation(); deleteMessageGlobal('${msgId}')">
                    <i class="fas fa-trash"></i> ${t('deleteForAll')}
                </div>
            `;
        }
        
        // Р вЂќР В»РЎРЏ Р Р†РЎРѓР ВµРЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– - Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ
        menuItems += `
            <div class="msg-context-item" onclick="event.stopPropagation(); deleteMessageLocal('${msgId}')">
                <i class="fas fa-eye-slash"></i> ${t('deleteForMe')}
            </div>
        `;
        
        // Р В Р В°Р В·Р Т‘Р ВµР В»Р С‘РЎвЂљР ВµР В»РЎРЉ Р С—Р ВµРЎР‚Р ВµР Т‘ Р С•Р С—Р В°РЎРѓР Р…РЎвЂ№Р СР С‘ Р Т‘Р ВµР в„–РЎРѓРЎвЂљР Р†Р С‘РЎРЏР СР С‘
        menuItems += `<div class="msg-context-divider"></div>`;
        
        // Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹ (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Р В»Р С‘РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ РЎвЂЎР В°РЎвЂљР С•Р Р†)
        if (!isGroup && activeChatPartner) {
            menuItems += `
                <div class="msg-context-item danger" onclick="event.stopPropagation(); closeContextMenu(); clearChatHistory()">
                    <i class="fas fa-broom"></i> ${currentLang === 'ru' ? 'Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹' : 'Clear history'}
                </div>
            `;
            
            // Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
            menuItems += `
                <div class="msg-context-item danger" onclick="event.stopPropagation(); closeContextMenu(); blockUserFromMenu()">
                    <i class="fas fa-ban"></i> ${currentLang === 'ru' ? 'Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ' : 'Block user'}
                </div>
            `;
        }
        
        menu.innerHTML = menuItems;
        
        // Р СџР С•Р В·Р С‘РЎвЂ Р С‘Р С•Р Р…Р С‘РЎР‚РЎС“Р ВµР С Р СР ВµР Р…РЎР‹
        document.body.appendChild(menu);
        
        let x = e.clientX;
        let y = e.clientY;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р Р…Р Вµ Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘Р С‘РЎвЂљ Р В»Р С‘ Р СР ВµР Р…РЎР‹ Р В·Р В° Р С–РЎР‚Р В°Р Р…Р С‘РЎвЂ РЎвЂ№ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
        const menuRect = menu.getBoundingClientRect();
        if (x + menuRect.width > window.innerWidth) {
            x = window.innerWidth - menuRect.width - 10;
        }
        if (y + menuRect.height > window.innerHeight) {
            y = window.innerHeight - menuRect.height - 10;
        }
        
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        
        currentContextMenu = menu;
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР ВµР Р…РЎР‹ Р С—РЎР‚Р С‘ Р С”Р В»Р С‘Р С”Р Вµ Р Р†Р Р…Р Вµ Р ВµР С–Р С•
        setTimeout(() => {
            document.addEventListener('click', closeContextMenu);
            document.addEventListener('contextmenu', closeContextMenu);
        }, 10);
    }
    
    // Р С›РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С—Р В°Р Р…Р ВµР В»РЎРЉ РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘Р в„– Р С‘Р В· Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р С–Р С• Р СР ВµР Р…РЎР‹
    window.openReactionPicker = (msgId, isGroup) => {
        closeContextMenu();
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (msgEl) {
            showReactionPicker(msgEl, msgId, isGroup);
        }
    };
    
    // Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р Р† Р В·Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘ Р С‘Р В· Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р С–Р С• Р СР ВµР Р…РЎР‹
    window.bookmarkFromContext = (msgId, isGroup) => {
        closeContextMenu();
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (!msgEl) return;
        
        const textEl = msgEl.querySelector('.msg-text');
        const text = textEl ? textEl.innerText : '';
        const authorEl = msgEl.querySelector('.msg-author');
        const author = authorEl ? authorEl.innerText.replace('@', '') : (msgEl.classList.contains('sent') ? me.username : (activeChatPartner?.username || 'Unknown'));
        
        const chatId = isGroup ? activeGroup?.id : (activeChatPartner ? [me.uid, activeChatPartner.uid].sort().join('_') : '');
        const chatName = isGroup ? activeGroup?.name : ('@' + (activeChatPartner?.username || 'Unknown'));
        
        addBookmark({
            msgId,
            text,
            author,
            chatId,
            chatName
        });
    };
    
    function closeContextMenu() {
        if (currentContextMenu) {
            currentContextMenu.remove();
            currentContextMenu = null;
        }
        document.removeEventListener('click', closeContextMenu);
        document.removeEventListener('contextmenu', closeContextMenu);
    }
    
    // Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ Р С‘Р В· Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р С–Р С• Р СР ВµР Р…РЎР‹ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
    window.blockUserFromMenu = async () => {
        if (!activeChatPartner || !me) return;
        
        const confirmed = confirm(currentLang === 'ru' 
            ? `Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ @${activeChatPartner.username}? Р вЂ™РЎвЂ№ Р Р…Р Вµ РЎРѓР СР С•Р В¶Р ВµРЎвЂљР Вµ Р С—Р С•Р В»РЎС“РЎвЂЎР В°РЎвЂљРЎРЉ Р С•РЎвЂљ Р Р…Р ВµР С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ.` 
            : `Block @${activeChatPartner.username}? You won't receive messages from them.`);
        
        if (!confirmed) return;
        
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
            const userData = userDoc.exists() ? userDoc.data() : {};
            const blockedUsers = userData.blockedUsers || {};
            
            blockedUsers[activeChatPartner.uid] = true;
            
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                blockedUsers: blockedUsers
            });
            
            showToast(currentLang === 'ru' ? 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…' : 'User blocked', 'СЂСџС™В«');
        } catch (err) {
            console.error('Error blocking user:', err);
            showToast(currentLang === 'ru' ? 'Р С›РЎв‚¬Р С‘Р В±Р С”Р В°' : 'Error', 'РІСњРЉ');
        }
    };
    
    // ========== Р С›РЎвЂљР Р†Р ВµРЎвЂљ Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ ==========
    let replyingTo = null; // { msgId, text, author, isGroup }
    
    window.replyToMessage = async (msgId, isGroup) => {
        closeContextMenu();
        
        // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
        let msgData = null;
        if (isGroup && activeGroup) {
            const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages', msgId));
            msgData = msgDoc.data();
        } else if (activeChatPartner) {
            const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
            const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId));
            msgData = msgDoc.data();
        }
        
        if (!msgData) return;
        
        let displayText = msgData.text || '';
        if (msgData.encrypted && displayText) {
            displayText = decrypt(displayText);
        }
        if (msgData.type === 'voice') displayText = 'СЂСџР‹В¤ Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ';
        if (msgData.type === 'file') displayText = 'СЂСџвЂњР‹ ' + (msgData.fileName || 'Р В¤Р В°Р в„–Р В»');
        
        const authorName = msgData.senderName === 'anonymous' ? 'Р С’Р Р…Р С•Р Р…Р С‘Р С' : 
                          (msgData.senderId === me.uid ? 'Р вЂ™РЎвЂ№' : (isGroup ? msgData.senderName : activeChatPartner?.username || 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ'));
        
        replyingTo = {
            msgId,
            text: displayText,
            author: authorName,
            senderId: msgData.senderId,
            isGroup
        };
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С—Р В°Р Р…Р ВµР В»РЎРЉ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°
        document.getElementById('reply-panel').classList.remove('hidden');
        document.getElementById('reply-panel-author').textContent = authorName;
        document.getElementById('reply-panel-text').textContent = displayText.substring(0, 100) + (displayText.length > 100 ? '...' : '');
        
        // Р В¤Р С•Р С”РЎС“РЎРѓ Р Р…Р В° Р С—Р С•Р В»Р Вµ Р Р†Р Р†Р С•Р Т‘Р В°
        document.getElementById('msg-input').focus();
    };
    
    window.cancelReply = () => {
        replyingTo = null;
        document.getElementById('reply-panel').classList.add('hidden');
    };
    
    // ========== Р СџР ВµРЎР‚Р ВµРЎРѓРЎвЂ№Р В»Р С”Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– ==========
    let forwardingMsgData = null; // Р вЂ™РЎР‚Р ВµР СР ВµР Р…Р Р…Р С•Р Вµ РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С‘Р Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦ Р Т‘Р В»РЎРЏ Р С—Р ВµРЎР‚Р ВµРЎРѓРЎвЂ№Р В»Р С”Р С‘
    
    window.forwardMessage = async (msgId, isGroup) => {
        closeContextMenu();
        
        // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
        let msgData = null;
        if (isGroup && activeGroup) {
            const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages', msgId));
            msgData = msgDoc.data();
        } else if (activeChatPartner) {
            const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
            const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId));
            msgData = msgDoc.data();
        }
        
        if (!msgData) return;
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р Т‘Р В»РЎРЏ Р С—Р ВµРЎР‚Р ВµРЎРѓРЎвЂ№Р В»Р С”Р С‘
        forwardingMsgData = msgData;
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р СР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• Р Р†РЎвЂ№Р В±Р С•РЎР‚Р В° РЎвЂЎР В°РЎвЂљР В°
        showForwardModal(msgData, isGroup);
    };
    
    function showForwardModal(msgData, fromGroup) {
        const modal = document.createElement('div');
        modal.className = 'edit-modal';
        modal.id = 'forward-modal';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        
        let displayText = msgData.text || '';
        if (msgData.encrypted && displayText) displayText = decrypt(displayText);
        if (msgData.type === 'voice') displayText = 'СЂСџР‹В¤ Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ';
        if (msgData.type === 'file') displayText = 'СЂСџвЂњР‹ ' + (msgData.fileName || 'Р В¤Р В°Р в„–Р В»');
        
        modal.innerHTML = `
            <div class="edit-modal-content" style="max-width: 450px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-share mr-2 text-indigo-500"></i>${currentLang === 'ru' ? 'Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°РЎвЂљРЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ' : 'Forward message'}</h3>
                
                <div class="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl mb-4">
                    <p class="text-sm opacity-70 truncate">${displayText.substring(0, 100)}${displayText.length > 100 ? '...' : ''}</p>
                </div>
                
                <p class="text-sm font-bold mb-2">${currentLang === 'ru' ? 'Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ:' : 'Select chat:'}</p>
                <div id="forward-chat-list" class="flex-1 overflow-y-auto space-y-2" style="max-height: 300px;"></div>
                
                <div class="flex gap-3 mt-4">
                    <button onclick="document.getElementById('forward-modal').remove()" class="flex-1 py-3 rounded-xl font-bold bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-all">
                        ${currentLang === 'ru' ? 'Р С›РЎвЂљР СР ВµР Р…Р В°' : 'Cancel'}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С” РЎвЂЎР В°РЎвЂљР С•Р Р†
        loadForwardChatList();
    }
    
    async function loadForwardChatList() {
        const listEl = document.getElementById('forward-chat-list');
        if (!listEl) return;
        
        listEl.innerHTML = '<div class="text-center py-4 opacity-50"><i class="fas fa-spinner fa-spin"></i></div>';
        
        const chats = [];
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№
        const chatsSnap = await getDocs(collection(db, 'artifacts', appId, 'users', me.uid, 'active_chats'));
        chatsSnap.forEach(d => {
            const data = d.data();
            chats.push({ type: 'personal', id: d.id, name: data.username, avatar: data.avatar });
        });
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№
        const groupsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'groups'));
        groupsSnap.forEach(d => {
            const data = d.data();
            if (data.members && data.members.includes(me.uid)) {
                chats.push({ type: 'group', id: d.id, name: data.name, avatar: data.avatar });
            }
        });
        
        if (chats.length === 0) {
            listEl.innerHTML = `<p class="text-center py-4 opacity-50">${currentLang === 'ru' ? 'Р СњР ВµРЎвЂљ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…РЎвЂ№РЎвЂ¦ РЎвЂЎР В°РЎвЂљР С•Р Р†' : 'No chats available'}</p>`;
            return;
        }
        
        listEl.innerHTML = chats.map(chat => `
            <div class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer transition-colors" onclick="executeForward('${chat.type}', '${chat.id}')">
                <div class="w-10 h-10 rounded-xl ${chat.type === 'group' ? 'bg-purple-100 text-purple-500' : 'bg-indigo-100 text-indigo-500'} flex items-center justify-center font-bold">
                    ${chat.avatar ? `<img src="${chat.avatar}" class="w-full h-full rounded-xl object-cover">` : (chat.type === 'group' ? '<i class="fas fa-users"></i>' : chat.name[0].toUpperCase())}
                </div>
                <div class="flex-1">
                    <p class="font-bold text-sm">${chat.name}</p>
                    <p class="text-xs opacity-50">${chat.type === 'group' ? 'Р вЂњРЎР‚РЎС“Р С—Р С—Р В°' : 'Р вЂєР С‘РЎвЂЎР Р…РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ'}</p>
                </div>
                <i class="fas fa-chevron-right opacity-30"></i>
            </div>
        `).join('');
    }
    
    window.executeForward = async (type, targetId) => {
        document.getElementById('forward-modal')?.remove();
        
        if (!forwardingMsgData) return;
        const msgData = forwardingMsgData;
        forwardingMsgData = null;
        
        const forwardedMsg = {
            text: msgData.text || '',
            senderId: me.uid,
            senderName: privacySettings.anonymous ? 'anonymous' : me.username,
            timestamp: serverTimestamp(),
            forwarded: true,
            forwardedFrom: msgData.senderName || 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ'
        };
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С encrypted РЎвЂљР С•Р В»РЎРЉР С”Р С• Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
        if (msgData.encrypted) {
            forwardedMsg.encrypted = msgData.encrypted;
        }
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С type РЎвЂљР С•Р В»РЎРЉР С”Р С• Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
        if (msgData.type) {
            forwardedMsg.type = msgData.type;
        }
        
        // Р С™Р С•Р С—Р С‘РЎР‚РЎС“Р ВµР С Р Т‘Р С•Р С—Р С•Р В»Р Р…Р С‘РЎвЂљР ВµР В»РЎРЉР Р…РЎвЂ№Р Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р Т‘Р В»РЎРЏ РЎвЂћР В°Р в„–Р В»Р С•Р Р†/Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†РЎвЂ№РЎвЂ¦
        if (msgData.type === 'file') {
            forwardedMsg.fileName = msgData.fileName;
            forwardedMsg.fileType = msgData.fileType;
            forwardedMsg.fileData = msgData.fileData;
        }
        if (msgData.type === 'voice') {
            forwardedMsg.voiceData = msgData.voiceData;
            forwardedMsg.voiceDuration = msgData.voiceDuration;
        }
        
        try {
            if (type === 'group') {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups', targetId, 'messages'), forwardedMsg);
            } else {
                const chatId = [me.uid, targetId].sort().join('_');
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), forwardedMsg);
            }
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
            showToast(currentLang === 'ru' ? 'Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С—Р ВµРЎР‚Р ВµРЎРѓР В»Р В°Р Р…Р С•' : 'Message forwarded', 'РІСљвЂ¦');
        } catch (e) {
            console.error('Forward error:', e);
            alert(currentLang === 'ru' ? 'Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—Р ВµРЎР‚Р ВµРЎРѓРЎвЂ№Р В»Р С”Р С‘' : 'Forward error');
        }
    };
    
    // ========== Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ ==========
    let currentPinnedMessage = null;
    
    window.pinMessage = async (msgId, isGroup) => {
        closeContextMenu();
        
        // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
        let msgData = null;
        let collectionPath = '';
        
        if (isGroup && activeGroup) {
            const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages', msgId));
            msgData = msgDoc.data();
            collectionPath = `artifacts/${appId}/public/data/groups/${activeGroup.id}`;
        } else if (activeChatPartner) {
            const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
            const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId));
            msgData = msgDoc.data();
            collectionPath = `artifacts/${appId}/public/data/chats/${chatId}`;
        }
        
        if (!msgData) return;
        
        let displayText = msgData.text || '';
        if (msgData.encrypted && displayText) displayText = decrypt(displayText);
        if (msgData.type === 'voice') displayText = 'СЂСџР‹В¤ Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ';
        if (msgData.type === 'file') displayText = 'СЂСџвЂњР‹ ' + (msgData.fileName || 'Р В¤Р В°Р в„–Р В»');
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        const pinnedData = {
            msgId,
            text: displayText,
            senderId: msgData.senderId || '',
            senderName: msgData.senderName || 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ',
            pinnedAt: serverTimestamp(),
            pinnedBy: me.uid
        };
        
        try {
            if (isGroup && activeGroup) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), { pinnedMessage: pinnedData }, { merge: true });
            } else if (activeChatPartner) {
                const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pinned_messages', chatId), { pinnedMessage: pinnedData }, { merge: true });
            }
            
            showPinnedMessageBar(pinnedData);
            showToast(currentLang === 'ru' ? 'Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»Р ВµР Р…Р С•' : 'Message pinned', 'СЂСџвЂњРЉ');
        } catch (e) {
            console.error('Pin error:', e);
        }
    };
    
    window.unpinMessage = async () => {
        const isGroup = !!activeGroup;
        
        try {
            if (isGroup && activeGroup) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), { pinnedMessage: null }, { merge: true });
            } else if (activeChatPartner) {
                const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pinned_messages', chatId), { pinnedMessage: null }, { merge: true });
            }
            
            hidePinnedMessageBar();
            showToast(currentLang === 'ru' ? 'Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С•РЎвЂљР С”РЎР‚Р ВµР С—Р В»Р ВµР Р…Р С•' : 'Message unpinned', 'СЂСџвЂњРЉ');
        } catch (e) {
            console.error('Unpin error:', e);
        }
    };
    
    function showPinnedMessageBar(pinnedData) {
        currentPinnedMessage = pinnedData;
        const bar = document.getElementById('pinned-message-bar');
        const textEl = document.getElementById('pinned-message-text');
        
        if (bar && textEl) {
            textEl.textContent = pinnedData.text.substring(0, 50) + (pinnedData.text.length > 50 ? '...' : '');
            bar.classList.remove('hidden');
        }
    }
    
    function hidePinnedMessageBar() {
        currentPinnedMessage = null;
        document.getElementById('pinned-message-bar')?.classList.add('hidden');
    }
    
    window.scrollToPinnedMessage = () => {
        if (!currentPinnedMessage) return;
        
        const msgEl = document.querySelector(`[data-msg-id="${currentPinnedMessage.msgId}"]`);
        if (msgEl) {
            msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            msgEl.style.animation = 'none';
            msgEl.offsetHeight; // Trigger reflow
            msgEl.style.animation = 'highlight-msg 1s ease';
        }
    };
    
    // Р СџРЎР‚Р С•Р С”РЎР‚РЎС“РЎвЂљР С”Р В° Р С” РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎР‹ (Р Т‘Р В»РЎРЏ РЎвЂ Р С‘РЎвЂљР В°РЎвЂљ)
    window.scrollToMessage = (msgId) => {
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (msgEl) {
            msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            msgEl.style.animation = 'none';
            msgEl.offsetHeight;
            msgEl.style.animation = 'highlight-msg 1s ease';
        }
    };
    
    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…Р С•Р С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С—РЎР‚Р С‘ Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљР С‘Р С‘ РЎвЂЎР В°РЎвЂљР В°
    async function loadPinnedMessage(isGroup) {
        hidePinnedMessageBar();
        
        try {
            let pinnedData = null;
            
            if (isGroup && activeGroup) {
                const groupDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id));
                pinnedData = groupDoc.data()?.pinnedMessage;
            } else if (activeChatPartner) {
                const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                const pinnedDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pinned_messages', chatId));
                pinnedData = pinnedDoc.data()?.pinnedMessage;
            }
            
            if (pinnedData && pinnedData.msgId) {
                showPinnedMessageBar(pinnedData);
            }
        } catch (e) {
            console.error('Load pinned error:', e);
        }
    }
    
    // ========== Р РЋР Р†Р В°Р в„–Р С— Р Т‘Р В»РЎРЏ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° ==========
    function setupSwipeToReply(element, msgId, isGroup) {
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        
        element.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
            element.classList.add('swiping');
        }, { passive: true });
        
        element.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const diff = currentX - startX;
            
            // Р СћР С•Р В»РЎРЉР С”Р С• РЎРѓР Р†Р В°Р в„–Р С— Р Р†Р С—РЎР‚Р В°Р Р†Р С•
            if (diff > 0 && diff < 100) {
                element.style.transform = `translateX(${diff}px)`;
            }
        }, { passive: true });
        
        element.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            element.classList.remove('swiping');
            
            const diff = currentX - startX;
            element.style.transform = '';
            
            // Р вЂўРЎРѓР В»Р С‘ РЎРѓР Р†Р В°Р в„–Р С— Р В±Р С•Р В»РЎРЉРЎв‚¬Р Вµ 60px - Р В°Р С”РЎвЂљР С‘Р Р†Р С‘РЎР‚РЎС“Р ВµР С Р С•РЎвЂљР Р†Р ВµРЎвЂљ
            if (diff > 60) {
                replyToMessage(msgId, isGroup);
            }
            
            startX = 0;
            currentX = 0;
        });
    }
    
    // ========== Р С™РЎР‚Р ВµРЎРѓРЎвЂљР С‘Р С”Р С‘-Р Р…Р С•Р В»Р С‘Р С”Р С‘ ==========
    let activeGameId = null;
    let gameUnsub = null;
    
    window.inviteToGame = async () => {
        if (!activeChatPartner || activeGroup) {
            showToast(currentLang === 'ru' ? 'Р ВР С–РЎР‚Р В° Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…Р В° РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Р† Р В»Р С‘РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ РЎвЂЎР В°РЎвЂљР В°РЎвЂ¦' : 'Game only in personal chats', 'СЂСџР‹В®');
            return;
        }
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р С—РЎР‚Р С‘Р С–Р В»Р В°РЎв‚¬Р ВµР Р…Р С‘Р Вµ Р С”Р В°Р С” РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        const gameId = 'game_' + Date.now();
        const gameData = {
            type: 'ttt_invite',
            gameId: gameId,
            senderId: me.uid,
            senderName: me.username,
            timestamp: serverTimestamp(),
            status: 'pending'
        };
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), gameData);
            
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р Т‘Р С•Р С”РЎС“Р СР ВµР Р…РЎвЂљ Р С‘Р С–РЎР‚РЎвЂ№
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                chatId: chatId,
                player1: me.uid,
                player2: activeChatPartner.uid,
                player1Name: me.username,
                player2Name: activeChatPartner.username,
                board: ['', '', '', '', '', '', '', '', ''],
                currentTurn: me.uid,
                status: 'pending',
                winner: null,
                createdAt: serverTimestamp()
            });
            
            showToast(currentLang === 'ru' ? 'Р СџРЎР‚Р С‘Р С–Р В»Р В°РЎв‚¬Р ВµР Р…Р С‘Р Вµ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С•!' : 'Invite sent!', 'СЂСџР‹В®');
        } catch (e) {
            console.error('Game invite error:', e);
        }
    };
    
    window.acceptGame = async (gameId) => {
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                status: 'active'
            }, { merge: true });
            
            showToast(currentLang === 'ru' ? 'Р ВР С–РЎР‚Р В° Р Р…Р В°РЎвЂЎР В°Р В»Р В°РЎРѓРЎРЉ!' : 'Game started!', 'СЂСџР‹В®');
        } catch (e) {
            console.error('Accept game error:', e);
        }
    };
    
    window.declineGame = async (gameId) => {
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                status: 'declined'
            }, { merge: true });
        } catch (e) {
            console.error('Decline game error:', e);
        }
    };
    
    window.makeMove = async (gameId, cellIndex) => {
        const gameDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId));
        if (!gameDoc.exists()) return;
        
        const game = gameDoc.data();
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• РЎРЊРЎвЂљР С• Р Р…Р В°РЎв‚¬ РЎвЂ¦Р С•Р Т‘
        if (game.currentTurn !== me.uid) {
            showToast(currentLang === 'ru' ? 'Р СњР Вµ Р Р†Р В°РЎв‚¬ РЎвЂ¦Р С•Р Т‘!' : 'Not your turn!', 'РІРЏС–');
            return;
        }
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• Р С”Р В»Р ВµРЎвЂљР С”Р В° РЎРѓР Р†Р С•Р В±Р С•Р Т‘Р Р…Р В°
        if (game.board[cellIndex] !== '') return;
        
        // Р С›Р С—РЎР‚Р ВµР Т‘Р ВµР В»РЎРЏР ВµР С РЎРѓР С‘Р СР Р†Р С•Р В» Р С‘Р С–РЎР‚Р С•Р С”Р В°
        const symbol = game.player1 === me.uid ? 'X' : 'O';
        const newBoard = [...game.board];
        newBoard[cellIndex] = symbol;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С—Р С•Р В±Р ВµР Т‘РЎС“
        const winner = checkWinner(newBoard);
        const isDraw = !winner && newBoard.every(cell => cell !== '');
        
        const nextTurn = game.currentTurn === game.player1 ? game.player2 : game.player1;
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                board: newBoard,
                currentTurn: nextTurn,
                status: winner ? 'finished' : (isDraw ? 'draw' : 'active'),
                winner: winner ? me.uid : null
            }, { merge: true });
        } catch (e) {
            console.error('Move error:', e);
        }
    };
    
    function checkWinner(board) {
        const lines = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // Р С–Р С•РЎР‚Р С‘Р В·Р С•Р Р…РЎвЂљР В°Р В»Р С‘
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Р Р†Р ВµРЎР‚РЎвЂљР С‘Р С”Р В°Р В»Р С‘
            [0, 4, 8], [2, 4, 6] // Р Т‘Р С‘Р В°Р С–Р С•Р Р…Р В°Р В»Р С‘
        ];
        
        for (const [a, b, c] of lines) {
            if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                return board[a];
            }
        }
        return null;
    }
    
    function getWinningLine(board) {
        const lines = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];
        
        for (const line of lines) {
            const [a, b, c] = line;
            if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                return line;
            }
        }
        return [];
    }
    
    function renderGameMessage(m, msgId, isMine) {
        if (m.type === 'ttt_invite') {
            return `
                <div class="ttt-game" data-game-id="${m.gameId}">
                    <div class="ttt-invite">
                        <div class="ttt-invite-icon">СЂСџР‹В®</div>
                        <div class="ttt-invite-text">
                            ${isMine 
                                ? (currentLang === 'ru' ? 'Р вЂ™РЎвЂ№ Р С—РЎР‚Р С‘Р С–Р В»Р В°РЎРѓР С‘Р В»Р С‘ Р Р† Р С‘Р С–РЎР‚РЎС“' : 'You invited to play')
                                : (currentLang === 'ru' ? `@${m.senderName} Р С—РЎР‚Р С‘Р С–Р В»Р В°РЎв‚¬Р В°Р ВµРЎвЂљ РЎРѓРЎвЂ№Р С–РЎР‚Р В°РЎвЂљРЎРЉ Р Р† Р С”РЎР‚Р ВµРЎРѓРЎвЂљР С‘Р С”Р С‘-Р Р…Р С•Р В»Р С‘Р С”Р С‘!` : `@${m.senderName} invites you to play Tic-Tac-Toe!`)
                            }
                        </div>
                        <div id="game-status-${m.gameId}" class="ttt-status">
                            ${currentLang === 'ru' ? 'Р С›Р В¶Р С‘Р Т‘Р В°Р Р…Р С‘Р Вµ...' : 'Waiting...'}
                        </div>
                        ${!isMine ? `
                            <div class="ttt-actions mt-3" id="game-actions-${m.gameId}">
                                <button class="ttt-btn ttt-btn-accept" onclick="acceptGame('${m.gameId}')">
                                    ${currentLang === 'ru' ? 'Р СџРЎР‚Р С‘Р Р…РЎРЏРЎвЂљРЎРЉ' : 'Accept'}
                                </button>
                                <button class="ttt-btn ttt-btn-decline" onclick="declineGame('${m.gameId}')">
                                    ${currentLang === 'ru' ? 'Р С›РЎвЂљР С”Р В»Р С•Р Р…Р С‘РЎвЂљРЎРЉ' : 'Decline'}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div id="game-board-${m.gameId}" class="hidden"></div>
                </div>
            `;
        }
        return null;
    }
    
    function setupGameListener(gameId, gameEl) {
        const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), (snap) => {
            if (!snap.exists()) return;
            const game = snap.data();
            
            const statusEl = document.getElementById(`game-status-${gameId}`);
            const actionsEl = document.getElementById(`game-actions-${gameId}`);
            const boardEl = document.getElementById(`game-board-${gameId}`);
            
            if (!statusEl || !boardEl) return;
            
            if (game.status === 'declined') {
                statusEl.textContent = currentLang === 'ru' ? 'Р С›РЎвЂљР С”Р В»Р С•Р Р…Р ВµР Р…Р С•' : 'Declined';
                statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
                statusEl.style.color = '#ef4444';
                if (actionsEl) actionsEl.classList.add('hidden');
                return;
            }
            
            if (game.status === 'active' || game.status === 'finished' || game.status === 'draw') {
                if (actionsEl) actionsEl.classList.add('hidden');
                boardEl.classList.remove('hidden');
                
                const isMyTurn = game.currentTurn === me.uid;
                const mySymbol = game.player1 === me.uid ? 'X' : 'O';
                const winLine = getWinningLine(game.board);
                
                if (game.status === 'finished') {
                    const winnerName = game.winner === me.uid 
                        ? (currentLang === 'ru' ? 'Р вЂ™РЎвЂ№ Р С—Р С•Р В±Р ВµР Т‘Р С‘Р В»Р С‘!' : 'You won!')
                        : (currentLang === 'ru' ? 'Р вЂ™РЎвЂ№ Р С—РЎР‚Р С•Р С‘Р С–РЎР‚Р В°Р В»Р С‘' : 'You lost');
                    statusEl.textContent = winnerName;
                    statusEl.style.background = game.winner === me.uid ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                    statusEl.style.color = game.winner === me.uid ? '#22c55e' : '#ef4444';
                } else if (game.status === 'draw') {
                    statusEl.textContent = currentLang === 'ru' ? 'Р СњР С‘РЎвЂЎРЎРЉРЎРЏ!' : 'Draw!';
                    statusEl.style.background = 'rgba(234, 179, 8, 0.1)';
                    statusEl.style.color = '#eab308';
                } else {
                    statusEl.textContent = isMyTurn 
                        ? (currentLang === 'ru' ? `Р вЂ™Р В°РЎв‚¬ РЎвЂ¦Р С•Р Т‘ (${mySymbol})` : `Your turn (${mySymbol})`)
                        : (currentLang === 'ru' ? 'Р ТђР С•Р Т‘ РЎРѓР С•Р С—Р ВµРЎР‚Р Р…Р С‘Р С”Р В°...' : 'Opponent\'s turn...');
                }
                
                boardEl.innerHTML = `
                    <div class="ttt-board">
                        ${game.board.map((cell, i) => `
                            <div class="ttt-cell ${cell ? 'taken' : ''} ${cell.toLowerCase()} ${winLine.includes(i) ? 'win' : ''}" 
                                 onclick="${!cell && game.status === 'active' && isMyTurn ? `makeMove('${gameId}', ${i})` : ''}">
                                ${cell}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        });
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С unsub Р Т‘Р В»РЎРЏ Р С•РЎвЂЎР С‘РЎРѓРЎвЂљР С”Р С‘
        if (!gameEl.dataset.listening) {
            gameEl.dataset.listening = 'true';
        }
    }
    
    // ========== Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓРЎвЂ№/Р ВРЎРѓРЎвЂљР С•РЎР‚Р С‘Р С‘ ==========
    let storiesUnsub = null;
    
    window.addMyStory = async () => {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р ВµРЎРѓРЎвЂљРЎРЉ Р В»Р С‘ РЎС“Р В¶Р Вµ Р СР С•РЎРЏ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ
        try {
            const myStoryDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stories', me.uid));
            if (myStoryDoc.exists()) {
                const story = myStoryDoc.data();
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р Р…Р Вµ Р С‘РЎРѓРЎвЂљР ВµР С”Р В»Р В° Р В»Р С‘
                if (story.expiresAt && story.expiresAt > Date.now()) {
                    // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓР Р†Р С•РЎР‹ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹
                    viewStory(story, me.uid, true);
                    return;
                }
            }
        } catch (e) {
            console.log('Check my story error:', e);
        }
        
        // Р вЂўРЎРѓР В»Р С‘ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘Р С‘ Р Р…Р ВµРЎвЂљ - Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р…Р С•Р Р†РЎС“РЎР‹
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 1024 * 1024) {
                showToast(currentLang === 'ru' ? 'Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 1MB' : 'Max 1MB', 'РІС™В РїС‘РЏ');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stories', me.uid), {
                        uid: me.uid,
                        username: me.username,
                        avatar: me.avatar || null,
                        imageData: ev.target.result,
                        createdAt: serverTimestamp(),
                        expiresAt: Date.now() + 24 * 60 * 60 * 1000, // 24 РЎвЂЎР В°РЎРѓР В°
                        viewedBy: []
                    });
                    showToast(currentLang === 'ru' ? 'Р ВРЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р В°!' : 'Story added!', 'СЂСџвЂњС‘');
                    loadStories();
                } catch (err) {
                    console.error('Story error:', err);
                }
            };
            reader.readAsDataURL(file);
        };
        input.click();
    };
    
    async function loadStories() {
        const container = document.getElementById('stories-container');
        if (!container || !me) return;
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ "Р СљР С•РЎРЏ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ"
        const myStoryBtn = container.querySelector('.story-item');
        container.innerHTML = '';
        if (myStoryBtn) container.appendChild(myStoryBtn);
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ Р Р† "Р СљР С•РЎРЏ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ"
        const myStoryAvatar = document.getElementById('my-story-avatar');
        if (myStoryAvatar && me.avatar) {
            myStoryAvatar.innerHTML = `<img src="${me.avatar}">`;
        }
        
        try {
            const storiesSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'stories'));
            const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            
            // Р РЋР С•Р В±Р С‘РЎР‚Р В°Р ВµР С ID РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
            const deletedUserIds = new Set();
            usersSnap.forEach(d => {
                if (d.data().deleted === true) {
                    deletedUserIds.add(d.id);
                }
            });
            
            const now = Date.now();
            
            storiesSnap.forEach(d => {
                const story = d.data();
                if (story.uid === me.uid) return; // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎРѓР Р†Р С•РЎР‹ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹
                if (story.expiresAt && story.expiresAt < now) return; // Р ВРЎРѓРЎвЂљРЎвЂР С”РЎв‚¬Р С‘Р Вµ
                if (deletedUserIds.has(story.uid)) return; // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
                
                const viewed = story.viewedBy && story.viewedBy.includes(me.uid);
                const storyEl = document.createElement('div');
                storyEl.className = 'story-item';
                storyEl.onclick = () => viewStory(story, d.id);
                storyEl.innerHTML = `
                    <div class="story-avatar ${viewed ? 'viewed' : ''}">
                        <div class="story-avatar-inner">
                            ${story.avatar ? `<img src="${story.avatar}">` : story.username[0].toUpperCase()}
                        </div>
                    </div>
                    <span class="story-name">@${story.username}</span>
                `;
                container.appendChild(storyEl);
            });
        } catch (e) {
            console.error('Load stories error:', e);
        }
    }
    
    window.viewStory = async (story, storyId, isOwnStory = false) => {
        // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎвЂ°Р С‘Р С”
        const viewer = document.createElement('div');
        viewer.className = 'story-viewer';
        viewer.id = 'story-viewer';
        
        // Р С™Р Р…Р С•Р С—Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ Р Т‘Р В»РЎРЏ РЎРѓР Р†Р С•Р ВµР С–Р С• РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР В°
        const deleteBtn = isOwnStory ? `
            <button onclick="deleteMyStory('${storyId}')" class="w-10 h-10 rounded-full hover:bg-white/20 flex items-center justify-center text-white" title="Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ">
                <i class="fas fa-trash text-lg"></i>
            </button>
        ` : '';
        
        viewer.innerHTML = `
            <div class="story-viewer-header">
                <div class="story-progress">
                    <div class="story-progress-bar"><div class="story-progress-fill" id="story-progress-fill"></div></div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center overflow-hidden">
                        ${story.avatar ? `<img src="${story.avatar}" class="w-full h-full object-cover">` : `<span class="font-bold">${story.username[0].toUpperCase()}</span>`}
                    </div>
                    <div class="text-white">
                        <p class="font-bold text-sm">@${story.username}</p>
                        <p class="text-xs opacity-70">${story.createdAt ? new Date(story.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : ''}</p>
                    </div>
                    ${deleteBtn}
                    <button onclick="closeStoryViewer()" class="ml-auto w-10 h-10 rounded-full hover:bg-white/20 flex items-center justify-center text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="story-content">
                <img src="${story.imageData}" alt="Story">
            </div>
        `;
        
        document.body.appendChild(viewer);
        
        // Р С’Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р С—РЎР‚Р С•Р С–РЎР‚Р ВµРЎРѓРЎРѓР В°
        const progressFill = document.getElementById('story-progress-fill');
        let progress = 0;
        const duration = 5000; // 5 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘
        const interval = setInterval(() => {
            progress += 100 / (duration / 50);
            progressFill.style.width = progress + '%';
            if (progress >= 100) {
                clearInterval(interval);
                closeStoryViewer();
            }
        }, 50);
        
        viewer.dataset.interval = interval;
        
        // Р С›РЎвЂљР СР ВµРЎвЂЎР В°Р ВµР С Р С”Р В°Р С” Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р ВµР Р…Р Р…РЎС“РЎР‹ (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ РЎвЂЎРЎС“Р В¶Р С‘РЎвЂ¦ РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР С•Р Р†)
        if (!isOwnStory && (!story.viewedBy || !story.viewedBy.includes(me.uid))) {
            try {
                const viewedBy = story.viewedBy || [];
                viewedBy.push(me.uid);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stories', storyId), { viewedBy }, { merge: true });
            } catch (e) {}
        }
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С—Р С• Р С”Р В»Р С‘Р С”РЎС“
        viewer.onclick = (e) => {
            if (e.target === viewer || e.target.closest('.story-content')) {
                closeStoryViewer();
            }
        };
    };
    
    // Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ РЎРѓР Р†Р С•Р ВµР С–Р С• РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР В°
    window.deleteMyStory = async (storyId) => {
        if (!confirm('Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ?')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stories', storyId));
            closeStoryViewer();
            showToast('Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…');
        } catch (e) {
            console.error('Error deleting story:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ');
        }
    };
    
    window.closeStoryViewer = () => {
        const viewer = document.getElementById('story-viewer');
        if (viewer) {
            if (viewer.dataset.interval) clearInterval(parseInt(viewer.dataset.interval));
            viewer.remove();
        }
    };
    
    // ========== Р РЋРЎвЂљР С‘Р С”Р ВµРЎР‚РЎвЂ№ Р С‘ GIF ==========
    let currentStickerTab = 'stickers';
    // Obfuscated Tenor key
    const TENOR_API_KEY = atob('QUl6YVN5QXlpbWt1WVFZRl9GWFZBTGV4UHVHUWN0VVdSVVJkQ1lR');
    
    const stickerPacks = [
        { name: 'Р РЋР СР В°Р в„–Р В»РЎвЂ№', stickers: ['СЂСџВР‚', 'СЂСџВвЂљ', 'СЂСџТђВ°', 'СЂСџВР‹', 'СЂСџВ¤вЂќ', 'СЂСџВТ‘', 'СЂСџТђС–', 'СЂСџВВ±', 'СЂСџВ¤Р‡', 'СЂСџВвЂЎ', 'СЂСџВ¤Р„', 'СЂСџВв‚¬'] },
        { name: 'Р вЂ“Р ВµРЎРѓРЎвЂљРЎвЂ№', stickers: ['СЂСџвЂРЊ', 'СЂСџвЂР‹', 'СЂСџвЂвЂ№', 'СЂСџВ¤Сњ', 'СЂСџвЂРЏ', 'СЂСџв„ўРЉ', 'СЂСџвЂ™Р„', 'СЂСџВ¤С›', 'РІСљРЉРїС‘РЏ', 'СЂСџВ¤Сџ', 'СЂСџвЂРЉ', 'СЂСџВ¤в„ў'] },
        { name: 'Р РЋР ВµРЎР‚Р Т‘РЎвЂ Р В°', stickers: ['РІСњВ¤РїС‘РЏ', 'СЂСџВ§РЋ', 'СЂСџвЂ™вЂє', 'СЂСџвЂ™С™', 'СЂСџвЂ™в„ў', 'СЂСџвЂ™Сљ', 'СЂСџвЂ“В¤', 'СЂСџВ¤РЊ', 'СЂСџвЂ™вЂў', 'СЂСџвЂ™вЂ“', 'СЂСџвЂ™вЂ”', 'СЂСџвЂ™В'] },
        { name: 'Р вЂ“Р С‘Р Р†Р С•РЎвЂљР Р…РЎвЂ№Р Вµ', stickers: ['СЂСџС’В¶', 'СЂСџС’В±', 'СЂСџС’В­', 'СЂСџС’в„–', 'СЂСџС’В°', 'СЂСџВ¦Р‰', 'СЂСџС’В»', 'СЂСџС’С', 'СЂСџС’РЃ', 'СЂСџС’Р‡', 'СЂСџВ¦Рѓ', 'СЂСџС’В®'] },
        { name: 'Р вЂўР Т‘Р В°', stickers: ['СЂСџРЊвЂў', 'СЂСџРЊвЂќ', 'СЂСџРЊСџ', 'СЂСџРЉВ­', 'СЂСџРЊС—', 'СЂСџВ§Рѓ', 'СЂСџРЊВ©', 'СЂСџРЊР„', 'СЂСџР‹вЂљ', 'СЂСџРЊВ«', 'СЂСџРЊВ¬', 'СЂСџРЊВ­'] }
    ];
    
    window.toggleStickers = () => {
        const panel = document.getElementById('sticker-panel');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
            // Р СњР В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ Р С—РЎР‚Р С‘Р Р…РЎС“Р Т‘Р С‘РЎвЂљР ВµР В»РЎРЉР Р…Р С• Р С—Р С•Р В·Р С‘РЎвЂ Р С‘Р С•Р Р…Р С‘РЎР‚РЎС“Р ВµР С РЎРѓР В»Р ВµР Р†Р В°
            if (window.innerWidth <= 768) {
                panel.style.left = '12px';
                panel.style.right = 'auto';
                panel.style.position = 'fixed';
                panel.style.bottom = '70px';
            }
            loadStickers();
        }
    };
    
    window.switchStickerTab = function(tab) {
        currentStickerTab = tab;
        document.querySelectorAll('.sticker-tab').forEach((t, i) => {
            t.classList.remove('active');
            if ((tab === 'stickers' && i === 0) || (tab === 'gif' && i === 1)) {
                t.classList.add('active');
            }
        });
        
        if (tab === 'stickers') {
            loadStickers();
        } else {
            loadTrendingGifs();
        }
    };
    
    function loadStickers() {
        const content = document.getElementById('sticker-content');
        content.innerHTML = stickerPacks.map(pack => `
            <p class="text-xs font-bold opacity-50 mb-2 mt-3">${pack.name}</p>
            <div class="sticker-grid">
                ${pack.stickers.map(s => `
                    <div class="sticker-item" onclick="sendSticker('${s}')">
                        <span style="font-size: 32px; display: flex; align-items: center; justify-content: center; height: 100%;">${s}</span>
                    </div>
                `).join('')}
            </div>
        `).join('');
    }
    
    async function loadTrendingGifs() {
        const content = document.getElementById('sticker-content');
        content.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl opacity-50"></i></div>';
        
        try {
            // Tenor API v2
            const res = await fetch(`https://tenor.googleapis.com/v2/featured?key=${TENOR_API_KEY}&limit=20`);
            const data = await res.json();
            
            if (data.results && data.results.length > 0) {
                content.innerHTML = `<div class="gif-grid">
                    ${data.results.map(gif => {
                        const preview = gif.media_formats.tinygif?.url || gif.media_formats.nanogif?.url || gif.media_formats.gif?.url;
                        const full = gif.media_formats.gif?.url || gif.media_formats.mediumgif?.url || preview;
                        return `
                            <div class="gif-item" onclick="sendGif('${full}')">
                                <img src="${preview}" loading="lazy">
                            </div>
                        `;
                    }).join('')}
                </div>`;
            } else {
                content.innerHTML = '<p class="text-center py-8 opacity-50">GIF Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…РЎвЂ№</p>';
            }
        } catch (e) {
            console.error('GIF load error:', e);
            content.innerHTML = '<p class="text-center py-8 opacity-50">Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ GIF</p>';
        }
    }
    
    window.searchStickersOrGif = async (query) => {
        if (!query.trim()) {
            if (currentStickerTab === 'stickers') loadStickers();
            else loadTrendingGifs();
            return;
        }
        
        if (currentStickerTab === 'gif') {
            const content = document.getElementById('sticker-content');
            content.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl opacity-50"></i></div>';
            
            try {
                // Tenor API v2 search
                const res = await fetch(`https://tenor.googleapis.com/v2/search?key=${TENOR_API_KEY}&q=${encodeURIComponent(query)}&limit=20`);
                const data = await res.json();
                
                if (data.results && data.results.length > 0) {
                    content.innerHTML = `<div class="gif-grid">
                        ${data.results.map(gif => {
                            const preview = gif.media_formats.tinygif?.url || gif.media_formats.nanogif?.url || gif.media_formats.gif?.url;
                            const full = gif.media_formats.gif?.url || gif.media_formats.mediumgif?.url || preview;
                            return `
                                <div class="gif-item" onclick="sendGif('${full}')">
                                    <img src="${preview}" loading="lazy">
                                </div>
                            `;
                        }).join('')}
                    </div>`;
                } else {
                    content.innerHTML = '<p class="text-center py-8 opacity-50">GIF Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…РЎвЂ№</p>';
                }
            } catch (e) {
                console.error('GIF search error:', e);
                content.innerHTML = '<p class="text-center py-8 opacity-50">Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—Р С•Р С‘РЎРѓР С”Р В° GIF</p>';
            }
        }
    };
    
    window.sendSticker = (sticker) => {
        document.getElementById('sticker-panel').classList.remove('active');
        sendMsg({ type: 'sticker', sticker: sticker });
    };
    
    window.sendGif = (gifUrl) => {
        document.getElementById('sticker-panel').classList.remove('active');
        sendMsg({ type: 'gif', gifUrl: gifUrl });
    };
    
    // ========== Р В Р ВµР В°Р С”РЎвЂ Р С‘Р С‘ Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ ==========
    const availableReactions = ['СЂСџвЂРЊ', 'РІСњВ¤РїС‘РЏ', 'СЂСџВвЂљ', 'СЂСџВВ®', 'СЂСџВСћ', 'СЂСџвЂќТђ', 'СЂСџвЂР‹'];
    let currentReactionPicker = null;
    
    function showReactionPicker(msgEl, msgId, isGroup = false) {
        closeReactionPicker();
        
        const picker = document.createElement('div');
        picker.className = 'reaction-picker';
        picker.id = 'reaction-picker';
        
        availableReactions.forEach(emoji => {
            const btn = document.createElement('button');
            btn.textContent = emoji;
            btn.onclick = (e) => {
                e.stopPropagation();
                addReaction(msgId, emoji, isGroup);
                closeReactionPicker();
            };
            picker.appendChild(btn);
        });
        
        msgEl.style.position = 'relative';
        msgEl.appendChild(picker);
        currentReactionPicker = picker;
        
        setTimeout(() => {
            document.addEventListener('click', closeReactionPicker);
        }, 10);
    }
    
    function closeReactionPicker() {
        if (currentReactionPicker) {
            currentReactionPicker.remove();
            currentReactionPicker = null;
        }
        document.removeEventListener('click', closeReactionPicker);
    }
    
    async function addReaction(msgId, emoji, isGroup = false) {
        if (!me) return;
        
        try {
            let msgRef;
            if (isGroup && activeGroup) {
                msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages', msgId);
            } else if (activeChatPartner) {
                const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
            } else {
                return;
            }
            
            const msgDoc = await getDoc(msgRef);
            if (!msgDoc.exists()) return;
            
            const data = msgDoc.data();
            let reactions = data.reactions || {};
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р ВµРЎРѓРЎвЂљРЎРЉ Р В»Р С‘ РЎС“Р В¶Р Вµ РЎвЂљР В°Р С”Р В°РЎРЏ РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘РЎРЏ Р С•РЎвЂљ РЎРЊРЎвЂљР С•Р С–Р С• Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
            if (!reactions[emoji]) {
                reactions[emoji] = [];
            }
            
            const userIndex = reactions[emoji].indexOf(me.uid);
            if (userIndex > -1) {
                // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘РЎР‹
                reactions[emoji].splice(userIndex, 1);
                if (reactions[emoji].length === 0) {
                    delete reactions[emoji];
                }
            } else {
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘РЎР‹
                reactions[emoji].push(me.uid);
            }
            
            await setDoc(msgRef, { reactions }, { merge: true });
        } catch (err) {
            console.error('Error adding reaction:', err);
        }
    }
    
    function renderReactions(reactions, msgId, isGroup = false) {
        if (!reactions || Object.keys(reactions).length === 0) return '';
        
        let html = '<div class="message-reactions">';
        
        for (const [emoji, users] of Object.entries(reactions)) {
            if (!users || users.length === 0) continue;
            const isMyReaction = users.includes(me?.uid);
            html += `
                <span class="reaction-badge ${isMyReaction ? 'my-reaction' : ''}" onclick="event.stopPropagation(); addReaction('${msgId}', '${emoji}', ${isGroup})">
                    ${emoji}<span class="reaction-count">${users.length}</span>
                </span>
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    // Р вЂќР ВµР В»Р В°Р ВµР С РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘РЎР‹ Р С–Р В»Р С•Р В±Р В°Р В»РЎРЉР Р…Р С•Р в„–
    window.addReaction = addReaction;
    
    // Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С–Р В»Р С•Р В±Р В°Р В»РЎРЉР Р…Р С• (Р Т‘Р В»РЎРЏ Р Р†РЎРѓР ВµРЎвЂ¦)
    window.deleteMessageGlobal = async (msgId) => {
        closeContextMenu();
        if (!activeChatPartner || !me) return;
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹ РЎС“Р В±Р ВµР С–Р В°РЎР‹РЎвЂ°Р ВµР С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (msgEl) {
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р…Р С•Р В¶Р С”Р С‘
            const legs = document.createElement('div');
            legs.className = 'message-legs';
            legs.innerHTML = '<span class="leg">СЂСџВ¦Вµ</span><span class="leg">СЂСџВ¦Вµ</span>';
            msgEl.style.position = 'relative';
            msgEl.style.overflow = 'visible';
            msgEl.appendChild(legs);
            
            // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎР‹
            msgEl.classList.add('message-running-away');
        }
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        try {
            // Р вЂ“Р Т‘РЎвЂР С Р Р…Р ВµР СР Р…Р С•Р С–Р С•, РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ Р В°Р Р…Р С‘Р СР В°РЎвЂ Р С‘РЎРЏ Р Р…Р В°РЎвЂЎР В°Р В»Р В°РЎРѓРЎРЉ
            await new Promise(r => setTimeout(r, 100));
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId), {
                deleted: true,
                deletedAt: Date.now(),
                text: '',
                fileData: null,
                voiceData: null
            }, { merge: true });
        } catch (e) {
            console.error('Failed to delete message:', e);
        }
    };
    
    // Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С• (РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎС“ РЎРѓР ВµР В±РЎРЏ)
    window.deleteMessageLocal = (msgId) => {
        closeContextMenu();
        
        const deletedMsgs = JSON.parse(localStorage.getItem('flickers-deleted-msgs') || '[]');
        if (!deletedMsgs.includes(msgId)) {
            deletedMsgs.push(msgId);
            localStorage.setItem('flickers-deleted-msgs', JSON.stringify(deletedMsgs));
        }
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљ Р С‘Р В· DOM
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (msgEl) {
            msgEl.style.animation = 'msg-fade-out 0.3s ease forwards';
            setTimeout(() => msgEl.remove(), 300);
        }
    };
    
    // Р В Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
    window.editMessage = async (msgId, encrypted) => {
        closeContextMenu();
        if (!activeChatPartner || !me) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р в„– РЎвЂљР ВµР С”РЎРѓРЎвЂљ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
        try {
            const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId));
            if (!msgDoc.exists()) return;
            
            let currentText = msgDoc.data().text || '';
            if (encrypted && currentText) {
                currentText = decrypt(currentText);
            }
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р СР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С• РЎР‚Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘РЎРЏ
            showEditModal(msgId, currentText, encrypted);
        } catch (e) {
            console.error('Failed to get message:', e);
        }
    };
    
    function showEditModal(msgId, currentText, wasEncrypted) {
        const modal = document.createElement('div');
        modal.className = 'edit-modal';
        modal.id = 'edit-modal';
        modal.innerHTML = `
            <div class="edit-modal-content">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-edit mr-2 text-indigo-500"></i>${t('editMessageTitle')}</h3>
                <textarea id="edit-msg-input" class="w-full p-4 bg-slate-100 dark:bg-slate-700 rounded-xl outline-none resize-none h-32 focus:ring-2 focus:ring-indigo-500 transition-all">${currentText}</textarea>
                <div class="flex gap-3 mt-4">
                    <button onclick="closeEditModal()" class="flex-1 py-3 rounded-xl font-bold bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-all">
                        ${t('cancel')}
                    </button>
                    <button onclick="saveEditedMessage('${msgId}', ${wasEncrypted})" class="flex-1 py-3 rounded-xl font-bold bg-indigo-500 text-white hover:bg-indigo-600 transition-all">
                        ${t('save')}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Р В¤Р С•Р С”РЎС“РЎРѓ Р Р…Р В° Р С—Р С•Р В»Р Вµ Р Р†Р Р†Р С•Р Т‘Р В°
        setTimeout(() => {
            const input = document.getElementById('edit-msg-input');
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
        }, 100);
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С—Р С• Р С”Р В»Р С‘Р С”РЎС“ Р Р…Р В° РЎвЂћР С•Р Р…
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeEditModal();
        });
    }
    
    window.closeEditModal = () => {
        const modal = document.getElementById('edit-modal');
        if (modal) modal.remove();
    };
    
    window.saveEditedMessage = async (msgId, wasEncrypted) => {
        const input = document.getElementById('edit-msg-input');
        const newText = input.value.trim();
        
        if (!newText || !activeChatPartner || !me) {
            closeEditModal();
            return;
        }
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        // Р РЃР С‘РЎвЂћРЎР‚РЎС“Р ВµР С Р ВµРЎРѓР В»Р С‘ Р В±РЎвЂ№Р В»Р С• Р В·Р В°РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С• Р С‘Р В»Р С‘ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С• РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ
        const shouldEncrypt = wasEncrypted || privacySettings.encryption;
        const finalText = shouldEncrypt ? encrypt(newText) : newText;
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId), {
                text: finalText,
                edited: true,
                editedAt: serverTimestamp()
            }, { merge: true });
            
            closeEditModal();
        } catch (e) {
            console.error('Failed to edit message:', e);
            alert('Error: ' + e.message);
        }
    };

    // Р СџР С•Р В»Р Р…РЎвЂ№Р в„– РЎРѓР В±РЎР‚Р С•РЎРѓ textarea Р С—Р С•РЎРѓР В»Р Вµ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
    window.resetTextarea = (textarea) => {
        if (!textarea) return;
        textarea.value = '';
        textarea.setAttribute('rows', '1');
        textarea.style.cssText = 'height: auto !important;';
        textarea.scrollTop = 0;
        // Р СћРЎР‚Р С‘Р С–Р С–Р ВµРЎР‚Р С‘Р С reflow
        void textarea.offsetHeight;
    };

    // Р С’Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р С•Р Вµ Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘Р Вµ Р Р†РЎвЂ№РЎРѓР С•РЎвЂљРЎвЂ№ textarea (Р С”Р В°Р С” Р Р† WhatsApp)
    window.autoResizeTextarea = (textarea) => {
        if (!textarea) return;
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р Р†РЎвЂ№РЎРѓР С•РЎвЂљРЎС“ Р Т‘Р В»РЎРЏ Р С—РЎР‚Р В°Р Р†Р С‘Р В»РЎРЉР Р…Р С•Р С–Р С• РЎР‚Р В°РЎРѓРЎвЂЎРЎвЂРЎвЂљР В°
        textarea.style.height = '24px';
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Р…Р С•Р Р†РЎС“РЎР‹ Р Р†РЎвЂ№РЎРѓР С•РЎвЂљРЎС“ (Р СР В°Р С”РЎРѓР С‘Р СРЎС“Р С 120px, Р СР С‘Р Р…Р С‘Р СРЎС“Р С 24px)
        const newHeight = Math.max(24, Math.min(textarea.scrollHeight, 120));
        textarea.style.height = newHeight + 'px';
    };

    // Telegram-style: Р С—Р ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘Р Вµ Р С”Р Р…Р С•Р С—Р С”Р С‘ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р С‘/Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…Р В°
    window.handleInputChange = () => {
        const input = document.getElementById('msg-input');
        const desktopInput = document.getElementById('msg-input-desktop');
        const sendBtn = document.getElementById('tg-send-btn');
        const voiceBtn = document.getElementById('tg-voice-btn');
        const sendBtnRight = document.getElementById('tg-send-btn-right');
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С•Р В±Р В° input
        const mobileHasText = input && input.value.trim().length > 0;
        const desktopHasText = desktopInput && desktopInput.value.trim().length > 0;
        const hasText = mobileHasText || desktopHasText;
        
        // Р вЂќР В»РЎРЏ Р Р…Р С•Р Р†Р С•Р С–Р С• Р СР С•Р В±Р С‘Р В»РЎРЉР Р…Р С•Р С–Р С• UI
        if (sendBtnRight && voiceBtn) {
            if (hasText) {
                sendBtnRight.classList.remove('hidden');
                voiceBtn.classList.add('hidden');
            } else {
                sendBtnRight.classList.add('hidden');
                voiceBtn.classList.remove('hidden');
            }
        }
        
        // Р вЂќР В»РЎРЏ РЎРѓРЎвЂљР В°РЎР‚Р С•Р С–Р С• UI (Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ)
        if (sendBtn && voiceBtn) {
            if (hasText) {
                sendBtn.classList.add('tg-send-active');
                voiceBtn.classList.add('tg-voice-hidden');
            } else {
                sendBtn.classList.remove('tg-send-active');
                voiceBtn.classList.remove('tg-voice-hidden');
            }
        }
    };
    
    // Р СљР ВµР Р…РЎР‹ Р Р†Р В»Р С•Р В¶Р ВµР Р…Р С‘Р в„– Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
    let mobileAttachMenuCreated = false;
    
    function createMobileAttachMenu() {
        if (mobileAttachMenuCreated) return;
        mobileAttachMenuCreated = true;
        
        const menu = document.createElement('div');
        menu.id = 'mobile-attach-menu';
        menu.className = 'mobile-attach-menu hidden';
        menu.innerHTML = `
            <div class="attach-actions-bar">
                <div class="attach-action-item" id="attach-btn-file">
                    <div class="attach-action-icon file-icon"><i class="fas fa-file"></i></div>
                    <span>Р В¤Р В°Р в„–Р В»</span>
                </div>
                <div class="attach-action-item" id="attach-btn-location">
                    <div class="attach-action-icon location-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <span>Р вЂњР ВµР С•Р С—Р С•Р В·Р С‘РЎвЂ Р С‘РЎРЏ</span>
                </div>
                <div class="attach-action-item" id="attach-btn-event">
                    <div class="attach-action-icon event-icon"><i class="fas fa-calendar-alt"></i></div>
                    <span>Р РЋР С•Р В±РЎвЂ№РЎвЂљР С‘Р Вµ</span>
                </div>
                <div class="attach-action-item" id="attach-btn-poll">
                    <div class="attach-action-icon poll-icon"><i class="fas fa-poll"></i></div>
                    <span>Р С›Р С—РЎР‚Р С•РЎРѓ</span>
                </div>
                <div class="attach-action-item" id="attach-btn-ai">
                    <div class="attach-action-icon ai-icon"><i class="fas fa-robot"></i></div>
                    <span>AI</span>
                </div>
            </div>
            <div class="attach-actions-bar" style="border-top: none; padding-top: 0;">
                <div class="attach-action-item" id="attach-btn-game">
                    <div class="attach-action-icon game-icon"><i class="fas fa-gamepad"></i></div>
                    <span>Р ВР С–РЎР‚Р В°</span>
                </div>
                <div class="attach-action-item" id="attach-btn-video">
                    <div class="attach-action-icon video-icon"><i class="fas fa-circle"></i></div>
                    <span>Р С™РЎР‚РЎС“Р В¶Р С•Р С”</span>
                </div>
                <div class="attach-action-item" id="attach-btn-schedule">
                    <div class="attach-action-icon schedule-icon"><i class="fas fa-clock"></i></div>
                    <span>Р СџР В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ</span>
                </div>
                <div class="attach-action-item" id="attach-btn-tasks">
                    <div class="attach-action-icon tasks-icon"><i class="fas fa-tasks"></i></div>
                    <span>Р вЂ”Р В°Р Т‘Р В°РЎвЂЎР С‘</span>
                </div>
            </div>
            <input type="file" id="gallery-input" class="hidden" accept="image/*,video/*" multiple>
        `;
        
        document.body.appendChild(menu);
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С•Р В±РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”Р С‘
        document.getElementById('attach-btn-file').addEventListener('click', () => { triggerFile(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-location').addEventListener('click', () => { sendLocation(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-event').addEventListener('click', () => { openEventModal(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-poll').addEventListener('click', () => { openPollModal(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-ai').addEventListener('click', () => { toggleAI(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-game').addEventListener('click', () => { inviteToGame(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-video').addEventListener('click', () => { openVideoCircle(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-schedule').addEventListener('click', () => { openScheduleModal(); closeMobileAttachMenu(); });
        document.getElementById('attach-btn-tasks').addEventListener('click', () => { openTasksPanel(); closeMobileAttachMenu(); });
    }
    
    window.openMobileAttachMenu = () => {
        createMobileAttachMenu();
        
        const menu = document.getElementById('mobile-attach-menu');
        if (menu) {
            menu.classList.remove('hidden');
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С overlay
            let overlay = document.getElementById('attach-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'attach-overlay';
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:998;';
                overlay.addEventListener('click', closeMobileAttachMenu);
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'block';
        }
    };
    
    window.closeMobileAttachMenu = () => {
        const menu = document.getElementById('mobile-attach-menu');
        const overlay = document.getElementById('attach-overlay');
        if (menu) menu.classList.add('hidden');
        if (overlay) overlay.style.display = 'none';
    };
    
    // Р СџРЎР‚Р С•РЎРѓРЎвЂљР В°РЎРЏ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В° РЎвЂћР В°Р в„–Р В»Р В° - Р В±Р ВµР В· Р С–Р В°Р В»Р ВµРЎР‚Р ВµР С‘, РЎРѓРЎР‚Р В°Р В·РЎС“ Р С—РЎР‚Р С‘ Р Р†РЎвЂ№Р В±Р С•РЎР‚Р Вµ
    window.openGalleryPicker = () => {
        const input = document.getElementById('gallery-input');
        if (input) input.click();
    };
    
    // Р С›Р В±РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р В° Р Р†РЎвЂ№Р В±Р С•РЎР‚Р В° РЎвЂћР В°Р в„–Р В»Р В° - Р РЋР В Р С’Р вЂ”Р Р€ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С
    window.handleGallerySelect = async (input) => {
        const files = Array.from(input.files);
        if (!files.length) return;
        
        if (!activeChatPartner && !activeGroup) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р С•РЎвЂљР С”РЎР‚Р С•Р в„–РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ', 'РІС™В РїС‘РЏ');
            input.value = '';
            return;
        }
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР ВµР Р…РЎР‹ РЎРѓРЎР‚Р В°Р В·РЎС“
        closeMobileAttachMenu();
        
        showToast(`Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В° ${files.length} РЎвЂћР В°Р в„–Р В»(Р С•Р Р†)...`, 'СЂСџвЂњВ¤');
        
        let successCount = 0;
        
        for (const file of files) {
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`${file.name} > 5MB`, 'РІС™В РїС‘РЏ');
                    continue;
                }
                
                // Р В§Р С‘РЎвЂљР В°Р ВµР С РЎвЂћР В°Р в„–Р В» Р Р† base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎвЂЎРЎвЂљР ВµР Р…Р С‘РЎРЏ'));
                    reader.readAsDataURL(file);
                });
                
                const isImage = file.type.startsWith('image/');
                const isVideo = file.type.startsWith('video/');
                
                const msgData = {
                    senderId: me.uid,
                    timestamp: serverTimestamp()
                };
                
                if (isImage) {
                    msgData.imageUrl = base64;
                    msgData.type = 'image';
                } else if (isVideo) {
                    msgData.videoUrl = base64;
                    msgData.type = 'video';
                } else {
                    msgData.fileUrl = base64;
                    msgData.fileName = file.name;
                    msgData.type = 'file';
                }
                
                if (activeGroup) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages'), msgData);
                } else {
                    const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), msgData);
                }
                
                successCount++;
            } catch (err) {
                console.error('Upload error:', err);
            }
        }
        
        // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С input
        input.value = '';
        
        if (successCount > 0) {
            showToast(`Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С•: ${successCount}`, 'РІСљвЂ¦');
        } else {
            showToast('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљРЎРЉ', 'РІСњРЉ');
        }
    };
    
    // Р РЋР С‘Р Р…РЎвЂ¦РЎР‚Р С•Р Р…Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…Р С•Р С–Р С• Р С‘ Р Т‘Р ВµРЎРѓР С”РЎвЂљР С•Р С—Р Р…Р С•Р С–Р С• input
    window.syncInputs = (source) => {
        const mobileInput = document.getElementById('msg-input');
        const desktopInput = document.getElementById('msg-input-desktop');
        
        if (source.id === 'msg-input' && desktopInput) {
            desktopInput.value = source.value;
        } else if (source.id === 'msg-input-desktop' && mobileInput) {
            mobileInput.value = source.value;
        }
    };

    window.sendMsg = async (extraData = {}) => {
        const mobileInput = document.getElementById('msg-input');
        const desktopInput = document.getElementById('msg-input-desktop');
        // Р вЂР ВµРЎР‚РЎвЂР С РЎвЂљР ВµР С”РЎРѓРЎвЂљ Р С‘Р В· РЎвЂљР С•Р С–Р С• input, Р С”Р С•РЎвЂљР С•РЎР‚РЎвЂ№Р в„– Р С‘Р СР ВµР ВµРЎвЂљ Р В·Р Р…Р В°РЎвЂЎР ВµР Р…Р С‘Р Вµ
        const text = (mobileInput?.value?.trim() || desktopInput?.value?.trim() || '');
        if ((!text && !extraData.type) || !activeChatPartner || !me) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ РЎвЂЎР В°РЎвЂљР В° - Р ВµРЎРѓР В»Р С‘ Р Р…Р С•Р Р†РЎвЂ№Р в„–, Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р В·Р В°Р С—РЎР‚Р С•РЎРѓ (Р С”РЎР‚Р С•Р СР Вµ Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•)
        const isSavedMessages = activeChatPartner.uid && activeChatPartner.uid.startsWith('saved_');
        if (!isSavedMessages && currentChatStatus === null) {
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р ВµРЎРѓРЎвЂљРЎРЉ Р В»Р С‘ РЎС“Р В¶Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
            const existingMsgs = await getDocs(query(
                collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'),
                limit(1)
            ));
            
            if (existingMsgs.empty) {
                // Р СџР ВµРЎР‚Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ - Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р В·Р В°Р С—РЎР‚Р С•РЎРѓ Р Р…Р В° Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
                await sendChatRequest();
            }
        }
        
        // Р РЃР С‘РЎвЂћРЎР‚РЎС“Р ВµР С РЎвЂљР ВµР С”РЎРѓРЎвЂљ Р ВµРЎРѓР В»Р С‘ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С• РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ
        const encryptedText = privacySettings.encryption ? encrypt(text) : text;
        
        const msg = {
            text: encryptedText,
            senderId: me.uid,
            senderName: privacySettings.anonymous ? 'anonymous' : me.username,
            timestamp: serverTimestamp(),
            encrypted: privacySettings.encryption,
            autoDestruct: privacySettings.autoDestruct,
            ...extraData
        };
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
        if (replyingTo && !replyingTo.isGroup) {
            msg.replyTo = {
                msgId: replyingTo.msgId,
                text: replyingTo.text,
                author: replyingTo.author,
                senderId: replyingTo.senderId
            };
            cancelReply();
        }

        // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С Р С•Р В±Р В° input
        resetTextarea(mobileInput);
        resetTextarea(desktopInput);
        handleInputChange(); // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ Р Р…Р В° Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…
        
        try {
            // Р вЂќР В»РЎРЏ "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•" РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Р С•РЎвЂљР Т‘Р ВµР В»РЎРЉР Р…РЎС“РЎР‹ Р С”Р С•Р В»Р В»Р ВµР С”РЎвЂ Р С‘РЎР‹
            if (isSavedMessages) {
                await addDoc(collection(db, 'artifacts', appId, 'users', me.uid, 'saved_messages'), {
                    text: text,
                    senderId: me.uid,
                    senderName: me.username,
                    savedAt: serverTimestamp(),
                    fromUsername: me.username,
                    ...extraData
                });
                console.log('Message saved to Favorites');
                return;
            }
            
            console.log('Sending message to chat:', chatId);
            console.log('Message data:', JSON.stringify(msg, null, 2));
            const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), msg);
            console.log('Message sent successfully, docId:', docRef.id);
            
            // Р СњР В°РЎвЂЎР С‘РЎРѓР В»РЎРЏР ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р В·Р В° Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”РЎС“ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
            earnRubies(RUBY_PER_MESSAGE);
            
            const lastMsgText = privacySettings.encryption ? 'СЂСџвЂќвЂ™ Р вЂ”Р В°РЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р В°Р Р…Р С•' : (text || (extraData.type === 'file' ? '[Р В¤Р В°Р в„–Р В»]' : 'Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ'));
            
            const updateChat = async (uid, otherId, otherName, isMe) => {
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'active_chats', otherId), {
                    uid: otherId, 
                    username: otherName, 
                    last: lastMsgText, 
                    lastSenderId: me.uid,
                    timestamp: serverTimestamp()
                }, { merge: true });
            };
            
            // Р вЂ™РЎРѓР ВµР С–Р Т‘Р В° Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С РЎР‚Р ВµР В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р С‘Р СР ВµР Р…Р В° Р Р† РЎРѓР С—Р С‘РЎРѓР С”Р Вµ РЎвЂЎР В°РЎвЂљР С•Р Р† (Р В°Р Р…Р С•Р Р…Р С‘Р СР Р…Р С•РЎРѓРЎвЂљРЎРЉ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Р† РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏРЎвЂ¦)
            // Р СњР Вµ Р С•Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С active_chats Р Т‘Р В»РЎРЏ "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•"
            if (!isSavedMessages) {
                await updateChat(me.uid, activeChatPartner.uid, activeChatPartner.username, true);
                await updateChat(activeChatPartner.uid, me.uid, me.username, false);
            }
        } catch (e) {
            console.error("Firebase Error", e);
        }
    };

    window.triggerFile = () => document.getElementById('file-input').click();
    window.handleFile = async (input) => {
        const file = input.files[0];
        if (!file) return;

        const MAX_SIZE = 100 * 1024 * 1024; // Р вЂєР С‘Р СР С‘РЎвЂљ 100MB
        const STORAGE_THRESHOLD = 2 * 1024 * 1024; // Р В¤Р В°Р в„–Р В»РЎвЂ№ > 2MB Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р Р…Р В° РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚ (РЎС“Р Р†Р ВµР В»Р С‘РЎвЂЎР С‘Р В»Р С‘ Р С—Р С•РЎР‚Р С•Р С–)
        const status = document.getElementById('upload-status');
        const pFill = document.getElementById('p-fill');
        const pPerc = document.getElementById('p-percent');
        
        if (file.size > MAX_SIZE) {
            alert("Р В Р В°Р В·Р СР ВµРЎР‚ РЎвЂћР В°Р в„–Р В»Р В° Р С•Р С–РЎР‚Р В°Р Р…Р С‘РЎвЂЎР ВµР Р… 100 Р СљР вЂ.");
            input.value = '';
            return;
        }

        status.classList.remove('hidden');
        pFill.style.width = '0%';
        pPerc.innerText = '0%';
        
        try {
            if (file.size > STORAGE_THRESHOLD) {
                // Р вЂР С•Р В»РЎРЉРЎв‚¬Р С‘Р Вµ РЎвЂћР В°Р в„–Р В»РЎвЂ№ Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р Р…Р В° Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…РЎвЂ№Р в„– РЎвЂ¦Р С•РЎРѓРЎвЂљР С‘Р Р…Р С–
                
                // Р СџРЎР‚Р ВµР Т‘РЎС“Р С—РЎР‚Р ВµР В¶Р Т‘Р ВµР Р…Р С‘Р Вµ Р Т‘Р В»РЎРЏ РЎвЂћР В°Р в„–Р В»Р С•Р Р† > 10MB
                if (file.size > 10 * 1024 * 1024) {
                    const confirmUpload = confirm(
                        'Р В¤Р В°Р в„–Р В» Р В±Р С•Р В»РЎРЉРЎв‚¬Р Вµ 10MB Р В±РЎС“Р Т‘Р ВµРЎвЂљ Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р ВµР Р… Р Р…Р В° Р Р†Р Р…Р ВµРЎв‚¬Р Р…Р С‘Р в„– РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚.\n' +
                        'Р В¤Р В°Р в„–Р В» Р СР С•Р В¶Р ВµРЎвЂљ Р В±РЎвЂ№РЎвЂљРЎРЉ РЎС“Р Т‘Р В°Р В»РЎвЂР Р… РЎвЂЎР ВµРЎР‚Р ВµР В· 30-90 Р Т‘Р Р…Р ВµР в„–.\n' +
                        'Р вЂќР В»РЎРЏ Р С—Р С•РЎРѓРЎвЂљР С•РЎРЏР Р…Р Р…Р С•Р С–Р С• РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С‘РЎРЏ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р в„–РЎвЂљР Вµ РЎвЂћР В°Р в„–Р В»РЎвЂ№ Р Т‘Р С• 2MB.\n\n' +
                        'Р СџРЎР‚Р С•Р Т‘Р С•Р В»Р В¶Р С‘РЎвЂљРЎРЉ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”РЎС“?'
                    );
                    if (!confirmUpload) {
                        status.classList.add('hidden');
                        input.value = '';
                        return;
                    }
                }
                
                pPerc.innerText = 'Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р Р…Р В° РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚...';
                
                // Р РЋР С—Р С‘РЎРѓР С•Р С” РЎРѓР ВµРЎР‚Р Р†Р С‘РЎРѓР С•Р Р† Р Т‘Р В»РЎРЏ Р С—Р С•Р С—РЎвЂ№РЎвЂљР С”Р С‘ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘
                const uploadServices = [
                    {
                        name: 'Uguu.se',
                        url: 'https://uguu.se/upload',
                        prepare: (formData, file) => {
                            formData.append('files[]', file);
                            formData.append('randomname', 'true');
                        },
                        parseResponse: (data) => {
                            if (data.success && data.files && data.files[0]) {
                                return data.files[0].url;
                            }
                            return null;
                        }
                    },
                    {
                        name: 'Pomf.lain.la',
                        url: 'https://pomf.lain.la/upload.php',
                        prepare: (formData, file) => {
                            formData.append('files[]', file);
                        },
                        parseResponse: (data) => {
                            if (data.success && data.files && data.files[0]) {
                                return data.files[0].url;
                            }
                            return null;
                        }
                    },
                    {
                        name: 'Catbox.moe',
                        url: 'https://catbox.moe/user/api.php',
                        prepare: (formData, file) => {
                            formData.append('reqtype', 'fileupload');
                            formData.append('fileToUpload', file);
                        },
                        parseResponse: (text) => {
                            if (typeof text === 'string' && text.startsWith('http')) {
                                return text.trim();
                            }
                            return null;
                        }
                    }
                ];
                
                let downloadURL = null;
                
                // Р СџРЎР‚Р С•Р В±РЎС“Р ВµР С Р С”Р В°Р В¶Р Т‘РЎвЂ№Р в„– РЎРѓР ВµРЎР‚Р Р†Р С‘РЎРѓ
                for (const service of uploadServices) {
                    try {
                        pPerc.innerText = `Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° (${service.name})...`;
                        pFill.style.width = '30%';
                        
                        const formData = new FormData();
                        service.prepare(formData, file);
                        
                        const response = await fetch(service.url, {
                            method: 'POST',
                            body: formData
                        });
                        
                        pFill.style.width = '70%';
                        
                        let data;
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            data = await response.json();
                        } else {
                            data = await response.text();
                        }
                        
                        downloadURL = service.parseResponse(data);
                        
                        if (downloadURL && downloadURL.startsWith('http')) {
                            pFill.style.width = '100%';
                            pPerc.innerText = '100%';
                            console.log(`РІСљвЂ¦ Р В¤Р В°Р в„–Р В» Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р ВµР Р… Р Р…Р В° ${service.name}:`, downloadURL);
                            break;
                        }
                    } catch (err) {
                        console.warn(`РІСњРЉ ${service.name} failed:`, err);
                        continue;
                    }
                }
                
                if (downloadURL) {
                    status.classList.add('hidden');
                    
                    // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎРѓ URL РЎвЂћР В°Р в„–Р В»Р В°
                    sendMsg({ 
                        type: 'file', 
                        fileName: file.name, 
                        fileType: file.type, 
                        fileData: downloadURL,
                        fileSize: file.size,
                        isStorageFile: true
                    });
                    
                    showToast('Р В¤Р В°Р в„–Р В» Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р ВµР Р…!', 'СЂСџвЂњРѓ');
                } else {
                    // Fallback: Р ВµРЎРѓР В»Р С‘ РЎвЂћР В°Р в„–Р В» < 10MB, Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С base64
                    if (file.size < 10 * 1024 * 1024) {
                        pPerc.innerText = 'Р РЋР В¶Р В°РЎвЂљР С‘Р Вµ РЎвЂћР В°Р в„–Р В»Р В°...';
                        const reader = new FileReader();
                        reader.onprogress = (e) => {
                            if (e.lengthComputable) {
                                const pct = Math.round((e.loaded / e.total) * 100);
                                pFill.style.width = pct + '%';
                                pPerc.innerText = pct + '%';
                            }
                        };
                        reader.onload = (e) => {
                            status.classList.add('hidden');
                            sendMsg({ 
                                type: 'file', 
                                fileName: file.name, 
                                fileType: file.type, 
                                fileData: e.target.result,
                                fileSize: file.size
                            });
                            showToast('Р В¤Р В°Р в„–Р В» Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р… (Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•)', 'СЂСџвЂњРѓ');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        throw new Error('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С‘РЎвЂљРЎРЉ РЎвЂћР В°Р в„–Р В». Р СџР С•Р С—РЎР‚Р С•Р В±РЎС“Р в„–РЎвЂљР Вµ РЎвЂћР В°Р в„–Р В» Р СР ВµР Р…РЎРЉРЎв‚¬Р Вµ 10MB.');
                    }
                }
                
            } else {
                // Р СљР В°Р В»Р ВµР Р…РЎРЉР С”Р С‘Р Вµ РЎвЂћР В°Р в„–Р В»РЎвЂ№ Р С”Р С•Р Р…Р Р†Р ВµРЎР‚РЎвЂљР С‘РЎР‚РЎС“Р ВµР С Р Р† base64
                const reader = new FileReader();
                reader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        pFill.style.width = pct + '%';
                        pPerc.innerText = pct + '%';
                    }
                };

                reader.onload = (e) => {
                    status.classList.add('hidden');
                    sendMsg({ type: 'file', fileName: file.name, fileType: file.type, fileData: e.target.result });
                };
                reader.readAsDataURL(file);
            }
        } catch (error) {
            console.error('Upload error:', error);
            status.classList.add('hidden');
            
            let errorMsg = 'Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ РЎвЂћР В°Р в„–Р В»Р В°: ' + (error.message || 'Р СњР ВµР С‘Р В·Р Р†Р ВµРЎРѓРЎвЂљР Р…Р В°РЎРЏ Р С•РЎв‚¬Р С‘Р В±Р С”Р В°');
            showToast(errorMsg, 'РІСњРЉ');
            console.error('Upload error details:', error);
        }
        
        input.value = '';
    };

    const emojiCategories = {
        'smileys': {
            icon: 'СЂСџВР‚',
            name: 'Р РЋР СР В°Р в„–Р В»РЎвЂ№',
            emojis: ['СЂСџВР‚','СЂСџВС“','СЂСџВвЂћ','СЂСџВРѓ','СЂСџВвЂ ','СЂСџВвЂ¦','СЂСџВ¤Р€','СЂСџВвЂљ','СЂСџв„ўвЂљ','СЂСџв„ўС“','СЂСџВвЂ°','СЂСџВР‰','СЂСџВвЂЎ','СЂСџТђВ°','СЂСџВРЊ','СЂСџВ¤В©','СЂСџВВ','СЂСџВвЂ”','РІВС”РїС‘РЏ','СЂСџВС™','СЂСџВв„ў','СЂСџТђР†','СЂСџВвЂ№','СЂСџВвЂє','СЂСџВСљ','СЂСџВ¤Р„','СЂСџВСњ','СЂСџВ¤вЂ','СЂСџВ¤вЂ”','СЂСџВ¤В­','СЂСџВ¤В«','СЂСџВ¤вЂќ','СЂСџВ¤С’','СЂСџВ¤РЃ','СЂСџВС’','СЂСџВвЂ','СЂСџВВ¶','СЂСџВРЏ','СЂСџВвЂ™','СЂСџв„ўвЂћ','СЂСџВВ¬','СЂСџВ¤Тђ','СЂСџВРЉ','СЂСџВвЂќ','СЂСџВР„','СЂСџВ¤В¤','СЂСџВТ‘','СЂСџВВ·','СЂСџВ¤вЂ™','СЂСџВ¤вЂў','СЂСџВ¤Сћ','СЂСџВ¤В®','СЂСџВ¤В§','СЂСџТђВµ','СЂСџТђВ¶','СЂСџТђТ‘','СЂСџВВµ','СЂСџВ¤Р‡','СЂСџВ¤В ','СЂСџТђС–','СЂСџТђС‘','СЂСџВР‹','СЂСџВ¤вЂњ','СЂСџВ§С’','СЂСџВвЂў','СЂСџВСџ','СЂСџв„ўРѓ','РІВв„–РїС‘РЏ','СЂСџВВ®','СЂСџВР‡','СЂСџВР†','СЂСџВС–','СЂСџТђС”','СЂСџВВ¦','СЂСџВВ§','СЂСџВРЃ','СЂСџВВ°','СЂСџВТђ','СЂСџВСћ','СЂСџВВ­','СЂСџВВ±','СЂСџВвЂ“','СЂСџВР€','СЂСџВС›','СЂСџВвЂњ','СЂСџВВ©','СЂСџВВ«','СЂСџТђВ±','СЂСџВВ¤','СЂСџВРЋ','СЂСџВВ ','СЂСџВ¤В¬','СЂСџВв‚¬','СЂСџвЂС—','СЂСџвЂ™Р‚','РІВВ РїС‘РЏ','СЂСџвЂ™В©','СЂСџВ¤РЋ','СЂСџвЂв„–','СЂСџвЂС”','СЂСџвЂВ»','СЂСџвЂР…','СЂСџвЂС•','СЂСџВ¤вЂ“']
        },
        'gestures': {
            icon: 'СЂСџвЂвЂ№',
            name: 'Р вЂ“Р ВµРЎРѓРЎвЂљРЎвЂ№',
            emojis: ['СЂСџвЂвЂ№','СЂСџВ¤С™','СЂСџвЂ“С’РїС‘РЏ','РІСљвЂ№','СЂСџвЂ“вЂ“','СЂСџвЂРЉ','СЂСџВ¤РЉ','СЂСџВ¤РЏ','РІСљРЉРїС‘РЏ','СЂСџВ¤С›','СЂСџВ¤Сџ','СЂСџВ¤В','СЂСџВ¤в„ў','СЂСџвЂв‚¬','СЂСџвЂвЂ°','СЂСџвЂвЂ ','СЂСџвЂ“вЂў','СЂСџвЂвЂЎ','РІВСњРїС‘РЏ','СЂСџвЂРЊ','СЂСџвЂР‹','РІСљР‰','СЂСџвЂР‰','СЂСџВ¤вЂє','СЂСџВ¤Сљ','СЂСџвЂРЏ','СЂСџв„ўРЉ','СЂСџвЂС’','СЂСџВ¤Р†','СЂСџВ¤Сњ','СЂСџв„ўРЏ','РІСљРЊРїС‘РЏ','СЂСџвЂ™вЂ¦','СЂСџВ¤С–','СЂСџвЂ™Р„','СЂСџВ¦С•','СЂСџВ¦С—','СЂСџВ¦Вµ','СЂСџВ¦В¶','СЂСџвЂвЂљ','СЂСџВ¦В»','СЂСџвЂС“','СЂСџВ§В ','СЂСџВ«Р‚','СЂСџВ«Рѓ','СЂСџВ¦В·','СЂСџВ¦Т‘','СЂСџвЂР‚','СЂСџвЂРѓРїС‘РЏ','СЂСџвЂвЂ¦','СЂСџвЂвЂћ']
        },
        'people': {
            icon: 'СЂСџвЂВ¶',
            name: 'Р вЂєРЎР‹Р Т‘Р С‘',
            emojis: ['СЂСџвЂВ¶','СЂСџВ§вЂ™','СЂСџвЂВ¦','СЂСџвЂВ§','СЂСџВ§вЂ','СЂСџвЂВ±','СЂСџвЂРЃ','СЂСџВ§вЂќ','СЂСџвЂВ©','СЂСџВ§вЂњ','СЂСџвЂТ‘','СЂСџвЂВµ','СЂСџв„ўРЊ','СЂСџв„ўР‹','СЂСџв„ўвЂ¦','СЂСџв„ўвЂ ','СЂСџвЂ™Рѓ','СЂСџв„ўвЂ№','СЂСџВ§РЏ','СЂСџв„ўвЂЎ','СЂСџВ¤В¦','СЂСџВ¤В·','СЂСџвЂВ®','СЂСџвЂўВµРїС‘РЏ','СЂСџвЂ™вЂљ','СЂСџТђВ·','СЂСџвЂВ·','СЂСџВ¤Т‘','СЂСџвЂС‘','СЂСџвЂС–','СЂСџвЂР†','СЂСџВ§вЂў','СЂСџВ¤Вµ','СЂСџвЂВ°','СЂСџВ¤В°','СЂСџВ¤В±','СЂСџвЂС','СЂСџР‹вЂ¦','СЂСџВ¤В¶','СЂСџВ¦С‘','СЂСџВ¦в„–','СЂСџВ§в„ў','СЂСџВ§С™','СЂСџВ§вЂє','СЂСџВ§Сљ','СЂСџВ§Сњ','СЂСџВ§С›','СЂСџВ§Сџ','СЂСџвЂ™вЂ ','СЂСџвЂ™вЂЎ','СЂСџС™В¶','СЂСџВ§РЊ','СЂСџВ§Р‹','СЂСџРЏС“','СЂСџвЂ™С“','СЂСџвЂўС”','СЂСџвЂўТ‘РїС‘РЏ','СЂСџвЂР‡','СЂСџВ§вЂ“','СЂСџВ§вЂ”','СЂСџВ¤С‘','СЂСџРЏРЉРїС‘РЏ','СЂСџРЏвЂЎ','РІвЂєВ·РїС‘РЏ','СЂСџРЏвЂљ','СЂСџРЏвЂ№РїС‘РЏ','СЂСџВ¤С','СЂСџВ¤Р…','СЂСџВ¤С•','СЂСџВ¤С”','РІвЂєв„–РїС‘РЏ','СЂСџРЏР‰','СЂСџС™Р€','СЂСџВ§В','СЂСџвЂєР‚','СЂСџвЂєРЉ']
        },
        'animals': {
            icon: 'СЂСџС’В¶',
            name: 'Р вЂ“Р С‘Р Р†Р С•РЎвЂљР Р…РЎвЂ№Р Вµ',
            emojis: ['СЂСџС’В¶','СЂСџС’вЂў','СЂСџВ¦В®','СЂСџС’вЂўРІР‚РЊСЂСџВ¦С”','СЂСџС’В©','СЂСџС’С”','СЂСџВ¦Р‰','СЂСџВ¦Сњ','СЂСџС’В±','СЂСџС’в‚¬','СЂСџС’в‚¬РІР‚РЊРІВ¬вЂє','СЂСџВ¦Рѓ','СЂСџС’Р‡','СЂСџС’вЂ¦','СЂСџС’вЂ ','СЂСџС’Т‘','СЂСџС’Р‹','СЂСџВ¦вЂћ','СЂСџВ¦вЂњ','СЂСџВ¦РЉ','СЂСџВ¦В¬','СЂСџС’В®','СЂСџС’вЂљ','СЂСџС’С“','СЂСџС’вЂћ','СЂСџС’В·','СЂСџС’вЂ“','СЂСџС’вЂ”','СЂСџС’Р…','СЂСџС’РЏ','СЂСџС’вЂ','СЂСџС’С’','СЂСџС’Р„','СЂСџС’В«','СЂСџВ¦в„ў','СЂСџВ¦вЂ™','СЂСџС’В','СЂСџВ¦Р€','СЂСџВ¦РЏ','СЂСџВ¦вЂє','СЂСџС’В­','СЂСџС’Рѓ','СЂСџС’Р‚','СЂСџС’в„–','СЂСџС’В°','СЂСџС’вЂЎ','СЂСџС’С—РїС‘РЏ','СЂСџВ¦В«','СЂСџВ¦вЂќ','СЂСџВ¦вЂЎ','СЂСџС’В»','СЂСџС’В»РІР‚РЊРІСњвЂћРїС‘РЏ','СЂСџС’РЃ','СЂСџС’С','СЂСџВ¦Тђ','СЂСџВ¦В¦','СЂСџВ¦РЃ','СЂСџВ¦В','СЂСџВ¦РЋ','СЂСџС’С•','СЂСџВ¦С“','СЂСџС’вЂќ','СЂСџС’вЂњ','СЂСџС’Р€','СЂСџС’В¤','СЂСџС’Тђ','СЂСџС’В¦','СЂСџС’В§','СЂСџвЂўР‰РїС‘РЏ','СЂСџВ¦вЂ¦','СЂСџВ¦вЂ ','СЂСџВ¦Сћ','СЂСџВ¦вЂ°','СЂСџВ¦В¤','СЂСџР„В¶','СЂСџВ¦В©','СЂСџВ¦С™','СЂСџВ¦Сљ','СЂСџС’С‘','СЂСџС’Р‰','СЂСџС’Сћ','СЂСџВ¦Р‹','СЂСџС’РЊ','СЂСџС’Р†','СЂСџС’вЂ°','СЂСџВ¦вЂў','СЂСџВ¦вЂ“','СЂСџС’С–','СЂСџС’вЂ№','СЂСџС’В¬','СЂСџВ¦В­','СЂСџС’Сџ','СЂСџС’В ','СЂСџС’РЋ','СЂСџВ¦в‚¬','СЂСџС’в„ў','СЂСџС’С™','СЂСџС’РЉ','СЂСџВ¦вЂ№','СЂСџС’вЂє','СЂСџС’Сљ','СЂСџС’Сњ','СЂСџР„Р†','СЂСџС’С›','СЂСџВ¦вЂ”','СЂСџР„С–','СЂСџвЂўВ·РїС‘РЏ','СЂСџвЂўС‘РїС‘РЏ','СЂСџВ¦вЂљ','СЂСџВ¦Сџ','СЂСџР„В°','СЂСџР„В±','СЂСџВ¦В ']
        },
        'food': {
            icon: 'СЂСџРЊвЂќ',
            name: 'Р вЂўР Т‘Р В°',
            emojis: ['СЂСџРЊвЂЎ','СЂСџРЊв‚¬','СЂСџРЊвЂ°','СЂСџРЊР‰','СЂСџРЊвЂ№','СЂСџРЊРЉ','СЂСџРЊРЊ','СЂСџТђВ­','СЂСџРЊР‹','СЂСџРЊРЏ','СЂСџРЊС’','СЂСџРЊвЂ','СЂСџРЊвЂ™','СЂСџРЊвЂњ','СЂСџВ«С’','СЂСџТђСњ','СЂСџРЊвЂ¦','СЂСџВ«вЂ™','СЂСџТђТђ','СЂСџТђвЂ','СЂСџРЊвЂ ','СЂСџТђвЂќ','СЂСџТђвЂў','СЂСџРЉР…','СЂСџРЉВ¶РїС‘РЏ','СЂСџВ«вЂ','СЂСџТђвЂ™','СЂСџТђВ¬','СЂСџТђВ¦','СЂСџВ§вЂћ','СЂСџВ§вЂ¦','СЂСџРЊвЂћ','СЂСџТђСљ','СЂСџРЉВ°','СЂСџРЊС›','СЂСџТђС’','СЂСџТђвЂ“','СЂСџВ«вЂњ','СЂСџТђРЃ','СЂСџТђР‡','СЂСџТђС›','СЂСџВ§вЂЎ','СЂСџВ§Р‚','СЂСџРЊвЂ“','СЂСџРЊвЂ”','СЂСџТђВ©','СЂСџТђвЂњ','СЂСџРЊвЂќ','СЂСџРЊСџ','СЂСџРЊвЂў','СЂСџРЉВ­','СЂСџТђР„','СЂСџРЉВ®','СЂСџРЉР‡','СЂСџВ«вЂќ','СЂСџТђв„ў','СЂСџВ§вЂ ','СЂСџТђС™','СЂСџРЊС–','СЂСџТђВ','СЂСџРЊР†','СЂСџВ«вЂў','СЂСџТђР€','СЂСџТђвЂ”','СЂСџРЊС—','СЂСџВ§в‚¬','СЂСџВ§вЂљ','СЂСџТђВ«','СЂСџРЊВ±','СЂСџРЊВ','СЂСџРЊв„ў','СЂСџРЊС™','СЂСџРЊвЂє','СЂСџРЊСљ','СЂСџРЊСњ','СЂСџРЊВ ','СЂСџРЊСћ','СЂСџРЊР€','СЂСџРЊВ¤','СЂСџРЊТђ','СЂСџТђВ®','СЂСџРЊРЋ','СЂСџТђСџ','СЂСџТђВ ','СЂСџТђРЋ','СЂСџВ¦Р‚','СЂСџВ¦С›','СЂСџВ¦С’','СЂСџВ¦вЂ','СЂСџВ¦Р„','СЂСџРЊВ¦','СЂСџРЊВ§','СЂСџРЊРЃ','СЂСџРЊВ©','СЂСџРЊР„','СЂСџР‹вЂљ','СЂСџРЊВ°','СЂСџВ§Рѓ','СЂСџТђВ§','СЂСџРЊВ«','СЂСџРЊВ¬','СЂСџРЊВ­','СЂСџРЊВ®','СЂСџРЊР‡','СЂСџРЊС','СЂСџТђвЂє','РІВвЂў','СЂСџВ«вЂ“','СЂСџРЊВµ','СЂСџРЊВ¶','СЂСџРЊС•','СЂСџРЊВ·','СЂСџРЊС‘','СЂСџРЊв„–','СЂСџРЊС”','СЂСџРЊВ»','СЂСџТђвЂљ','СЂСџТђС“','СЂСџТђВ¤','СЂСџВ§вЂ№','СЂСџВ§С“','СЂСџВ§вЂ°','СЂСџВ§Р‰']
        },
        'activities': {
            icon: 'РІС™Р…',
            name: 'Р С’Р С”РЎвЂљР С‘Р Р†Р Р…Р С•РЎРѓРЎвЂљР С‘',
            emojis: ['РІС™Р…','СЂСџРЏР‚','СЂСџРЏв‚¬','РІС™С•','СЂСџТђР‹','СЂСџР‹С•','СЂСџРЏС’','СЂСџРЏвЂ°','СЂСџТђРЏ','СЂСџР‹В±','СЂСџР„Р‚','СЂСџРЏвЂњ','СЂСџРЏС‘','СЂСџРЏвЂ™','СЂСџРЏвЂ','СЂСџТђРЊ','СЂСџРЏРЏ','СЂСџР„С“','СЂСџТђвЂ¦','РІвЂєС–','СЂСџР„Рѓ','СЂСџРЏв„–','СЂСџР‹Р€','СЂСџВ¤С—','СЂСџТђР‰','СЂСџТђвЂ№','СЂСџР‹Р…','СЂСџвЂєв„–','СЂСџвЂєС','СЂСџвЂєВ·','РІвЂєС‘РїС‘РЏ','СЂСџТђРЉ','СЂСџР‹С—','РІвЂєВ·РїС‘РЏ','СЂСџРЏвЂљ','СЂСџР„вЂљ','СЂСџРЏвЂ№РїС‘РЏ','СЂСџВ¤С','СЂСџВ¤С‘','СЂСџВ¤С”','РІвЂєв„–РїС‘РЏ','СЂСџВ¤С•','СЂСџРЏРЉРїС‘РЏ','СЂСџРЏвЂЎ','СЂСџВ§В','СЂСџРЏвЂћ','СЂСџРЏР‰','СЂСџВ¤Р…','СЂСџС™Р€','СЂСџВ§вЂ”','СЂСџС™Т‘','СЂСџС™Вµ','СЂСџР‹вЂ“РїС‘РЏ','СЂСџРЏвЂ ','СЂСџРЏвЂ¦','СЂСџТђвЂЎ','СЂСџТђв‚¬','СЂСџТђвЂ°','СЂСџР‹Р„','СЂСџВ¤в„–','СЂСџР‹В­','СЂСџВ©В°','СЂСџР‹РЃ','СЂСџР‹В¬','СЂСџР‹В¤','СЂСџР‹В§','СЂСџР‹С','СЂСџР‹в„–','СЂСџТђРѓ','СЂСџР„В','СЂСџР‹В·','СЂСџР‹С”','СЂСџР„вЂ”','СЂСџР‹С‘','СЂСџР„вЂў','СЂСџР‹В»','СЂСџР‹Р†','РІв„ўСџРїС‘РЏ','СЂСџР‹Р‡','СЂСџР‹С–','СЂСџР‹В®','СЂСџвЂўв„–РїС‘РЏ','СЂСџР‹В°']
        },
        'travel': {
            icon: 'СЂСџС™вЂ”',
            name: 'Р СџРЎС“РЎвЂљР ВµРЎв‚¬Р ВµРЎРѓРЎвЂљР Р†Р С‘РЎРЏ',
            emojis: ['СЂСџС™вЂ”','СЂСџС™вЂў','СЂСџС™в„ў','СЂСџС™РЉ','СЂСџС™Р‹','СЂСџРЏР‹РїС‘РЏ','СЂСџС™вЂњ','СЂСџС™вЂ','СЂСџС™вЂ™','СЂСџС™С’','СЂСџвЂєВ»','СЂСџС™С™','СЂСџС™вЂє','СЂСџС™Сљ','СЂСџВ¦Р‡','СЂСџВ¦Р…','СЂСџВ¦С','СЂСџвЂєТ‘','СЂСџС™Р†','СЂСџвЂєВµ','СЂСџРЏРЊРїС‘РЏ','СЂСџвЂєС”','СЂСџС™РЃ','СЂСџС™вЂќ','СЂСџС™РЊ','СЂСџС™В','СЂСџС™вЂ“','СЂСџС™РЋ','СЂСџС™В ','СЂСџС™Сџ','СЂСџС™С“','СЂСџС™вЂ№','СЂСџС™С›','СЂСџС™Сњ','СЂСџС™вЂћ','СЂСџС™вЂ¦','СЂСџС™в‚¬','СЂСџС™вЂљ','СЂСџС™вЂ ','СЂСџС™вЂЎ','СЂСџС™Р‰','СЂСџС™вЂ°','РІСљв‚¬РїС‘РЏ','СЂСџвЂєВ«','СЂСџвЂєВ¬','СЂСџвЂєВ©РїС‘РЏ','СЂСџвЂ™С”','СЂСџвЂєВ°РїС‘РЏ','СЂСџС™Р‚','СЂСџвЂєС‘','СЂСџС™Рѓ','СЂСџвЂєВ¶','РІвЂєВµ','СЂСџС™В¤','СЂСџвЂєТђРїС‘РЏ','СЂСџвЂєС–РїС‘РЏ','РІвЂєТ‘РїС‘РЏ','СЂСџС™Сћ','РІС™вЂњ','СЂСџР„Сњ','РІвЂєР…','СЂСџС™В§','СЂСџС™В¦','СЂСџС™Тђ','СЂСџС™РЏ','СЂСџвЂ”С”РїС‘РЏ','СЂСџвЂ”С—','СЂСџвЂ”Р…','СЂСџвЂ”С','СЂСџРЏВ°','СЂСџРЏР‡','СЂСџРЏСџРїС‘РЏ','СЂСџР‹РЋ','СЂСџР‹Сћ','СЂСџР‹В ','РІвЂєР†','РІвЂєВ±РїС‘РЏ','СЂСџРЏвЂ“РїС‘РЏ','СЂСџРЏСњРїС‘РЏ','СЂСџРЏСљРїС‘РЏ','СЂСџРЉвЂ№','РІвЂєВ°РїС‘РЏ','СЂСџРЏвЂќРїС‘РЏ','СЂСџвЂ”В»','СЂСџРЏвЂўРїС‘РЏ','РІвЂєС”','СЂСџвЂєвЂ“','СЂСџРЏВ ','СЂСџРЏРЋ','СЂСџРЏВРїС‘РЏ','СЂСџРЏС™РїС‘РЏ','СЂСџРЏвЂ”РїС‘РЏ','СЂСџРЏВ­','СЂСџРЏСћ','СЂСџРЏВ¬','СЂСџРЏР€','СЂСџРЏВ¤','СЂСџРЏТђ','СЂСџРЏВ¦','СЂСџРЏРЃ','СЂСџРЏР„','СЂСџРЏВ«','СЂСџРЏВ©','СЂСџвЂ™вЂ™','СЂСџРЏвЂєРїС‘РЏ','РІвЂєР„','СЂСџвЂўРЉ','СЂСџвЂўРЊ','СЂСџвЂєвЂў','СЂСџвЂўвЂ№','РІвЂєВ©РїС‘РЏ','СЂСџвЂєВ¤РїС‘РЏ','СЂСџвЂєР€РїС‘РЏ','СЂСџвЂ”С•','СЂСџР‹вЂ','СЂСџРЏС›РїС‘РЏ','СЂСџРЉвЂ¦','СЂСџРЉвЂћ','СЂСџРЉВ ','СЂСџР‹вЂЎ','СЂСџР‹вЂ ','СЂСџРЉвЂЎ','СЂСџРЉвЂ ','СЂСџРЏв„ўРїС‘РЏ','СЂСџРЉС“','СЂСџРЉРЉ','СЂСџРЉвЂ°','СЂСџРЉРѓ']
        },
        'objects': {
            icon: 'СЂСџвЂ™РЋ',
            name: 'Р С›Р В±РЎР‰Р ВµР С”РЎвЂљРЎвЂ№',
            emojis: ['РІРЉС™','СЂСџвЂњВ±','СЂСџвЂњР†','СЂСџвЂ™В»','РІРЉРЃРїС‘РЏ','СЂСџвЂ“ТђРїС‘РЏ','СЂСџвЂ“РЃРїС‘РЏ','СЂСџвЂ“В±РїС‘РЏ','СЂСџвЂ“Р†РїС‘РЏ','СЂСџвЂўв„–РїС‘РЏ','СЂСџвЂ”СљРїС‘РЏ','СЂСџвЂ™Р…','СЂСџвЂ™С•','СЂСџвЂ™С—','СЂСџвЂњР‚','СЂСџвЂњС','СЂСџвЂњВ·','СЂСџвЂњС‘','СЂСџвЂњв„–','СЂСџР‹Тђ','СЂСџвЂњР…РїС‘РЏ','СЂСџР‹С›РїС‘РЏ','СЂСџвЂњС›','РІВР‹РїС‘РЏ','СЂСџвЂњСџ','СЂСџвЂњВ ','СЂСџвЂњС”','СЂСџвЂњВ»','СЂСџР‹в„ўРїС‘РЏ','СЂСџР‹С™РїС‘РЏ','СЂСџР‹вЂєРїС‘РЏ','СЂСџВ§В­','РІРЏВ±РїС‘РЏ','РІРЏР†РїС‘РЏ','РІРЏВ°','СЂСџвЂўВ°РїС‘РЏ','РІРЉвЂє','РІРЏС–','СЂСџвЂњРЋ','СЂСџвЂќвЂ№','СЂСџвЂќРЉ','СЂСџвЂ™РЋ','СЂСџвЂќВ¦','СЂСџвЂўР‡РїС‘РЏ','СЂСџР„вЂќ','СЂСџВ§Р‡','СЂСџвЂєСћРїС‘РЏ','СЂСџвЂ™С‘','СЂСџвЂ™Вµ','СЂСџвЂ™Т‘','СЂСџвЂ™В¶','СЂСџвЂ™В·','СЂСџР„в„ў','СЂСџвЂ™В°','СЂСџвЂ™С–','СЂСџвЂ™Р‹','РІС™вЂ“РїС‘РЏ','СЂСџР„Сљ','СЂСџВ§В°','СЂСџР„вЂє','СЂСџвЂќВ§','СЂСџвЂќРЃ','РІС™вЂ™РїС‘РЏ','СЂСџвЂєВ РїС‘РЏ','РІвЂєРЏРїС‘РЏ','СЂСџР„С™','СЂСџвЂќВ©','РІС™в„ўРїС‘РЏ','СЂСџР„В¤','СЂСџВ§В±','РІвЂєвЂњРїС‘РЏ','СЂСџВ§Р†','СЂСџвЂќВ«','СЂСџвЂ™Р€','СЂСџВ§РЃ','СЂСџР„вЂњ','СЂСџвЂќР„','СЂСџвЂ”РЋРїС‘РЏ','РІС™вЂќРїС‘РЏ','СЂСџвЂєРЋРїС‘РЏ','СЂСџС™В¬','РІС™В°РїС‘РЏ','СЂСџР„В¦','РІС™В±РїС‘РЏ','СЂСџРЏС”','СЂСџвЂќВ®','СЂСџвЂњС—','СЂСџВ§С—','СЂСџвЂ™в‚¬','РІС™вЂ”РїС‘РЏ','СЂСџвЂќВ­','СЂСџвЂќВ¬','СЂСџвЂўС–РїС‘РЏ','СЂСџВ©в„–','СЂСџВ©С”','СЂСџвЂ™Р‰','СЂСџвЂ™вЂ°','СЂСџВ©С‘','СЂСџВ§В¬','СЂСџВ¦В ','СЂСџВ§В«','СЂСџВ§Р„','СЂСџРЉРЋРїС‘РЏ','СЂСџВ§в„–','СЂСџР„В ','СЂСџВ§С”','СЂСџВ§В»','СЂСџС™Р…','СЂСџС™В°','СЂСџС™С—','СЂСџвЂєРѓ','СЂСџвЂєР‚','СЂСџВ§С','СЂСџР„Тђ','СЂСџР„вЂ™','СЂСџВ§Р…','СЂСџР„Р€','СЂСџВ§Т‘','СЂСџвЂєР‹РїС‘РЏ','СЂСџвЂќвЂ','СЂСџвЂ”СњРїС‘РЏ','СЂСџС™Р„','СЂСџР„вЂ','СЂСџвЂєвЂ№РїС‘РЏ','СЂСџвЂєРЏРїС‘РЏ','СЂСџвЂєРЉ','СЂСџВ§С‘','СЂСџР„вЂ ','СЂСџвЂ“СРїС‘РЏ','СЂСџР„С›','СЂСџР„Сџ','СЂСџвЂєРЊРїС‘РЏ','СЂСџвЂєвЂ™','СЂСџР‹Рѓ','СЂСџР‹в‚¬','СЂСџР‹РЏ','СЂСџР‹Р‚','СЂСџР„вЂћ','СЂСџР„вЂ¦','СЂСџР‹Р‰','СЂСџР‹вЂ°','СЂСџР‹Р‹','СЂСџРЏВ®','СЂСџР‹С’','СЂСџВ§В§','РІСљвЂ°РїС‘РЏ','СЂСџвЂњВ©','СЂСџвЂњРЃ','СЂСџвЂњВ§','СЂСџвЂ™РЉ','СЂСџвЂњТђ','СЂСџвЂњВ¤','СЂСџвЂњВ¦','СЂСџРЏВ·РїС‘РЏ','СЂСџР„В§','СЂСџвЂњР„','СЂСџвЂњВ«','СЂСџвЂњВ¬','СЂСџвЂњВ­','СЂСџвЂњВ®','СЂСџвЂњР‡','СЂСџвЂњСљ','СЂСџвЂњС“','СЂСџвЂњвЂћ','СЂСџвЂњвЂ','СЂСџВ§С•','СЂСџвЂњР‰','СЂСџвЂњв‚¬','СЂСџвЂњвЂ°','СЂСџвЂ”вЂ™РїС‘РЏ','СЂСџвЂ”вЂњРїС‘РЏ','СЂСџвЂњвЂ ','СЂСџвЂњвЂ¦','СЂСџвЂ”вЂРїС‘РЏ','СЂСџвЂњвЂЎ','СЂСџвЂ”С“РїС‘РЏ','СЂСџвЂ”С–РїС‘РЏ','СЂСџвЂ”вЂћРїС‘РЏ','СЂСџвЂњвЂ№','СЂСџвЂњРѓ','СЂСџвЂњвЂљ','СЂСџвЂ”вЂљРїС‘РЏ','СЂСџвЂ”С›РїС‘РЏ','СЂСџвЂњВ°','СЂСџвЂњвЂњ','СЂСџвЂњвЂќ','СЂСџвЂњвЂ™','СЂСџвЂњвЂў','СЂСџвЂњвЂ”','СЂСџвЂњВ','СЂСџвЂњв„ў','СЂСџвЂњС™','СЂСџвЂњвЂ“','СЂСџвЂќвЂ“','СЂСџВ§В·','СЂСџвЂќвЂ”','СЂСџвЂњР‹','СЂСџвЂ“вЂЎРїС‘РЏ','СЂСџвЂњС’','СЂСџвЂњРЏ','СЂСџВ§В®','СЂСџвЂњРЉ','СЂСџвЂњРЊ','РІСљвЂљРїС‘РЏ','СЂСџвЂ“Р‰РїС‘РЏ','СЂСџвЂ“вЂ№РїС‘РЏ','РІСљвЂ™РїС‘РЏ','СЂСџвЂ“РЉРїС‘РЏ','СЂСџвЂ“РЊРїС‘РЏ','СЂСџвЂњСњ','РІСљРЏРїС‘РЏ','СЂСџвЂќРЊ','СЂСџвЂќР‹','СЂСџвЂќРЏ','СЂСџвЂќС’','СЂСџвЂќвЂ™','СЂСџвЂќвЂњ']
        },
        'symbols': {
            icon: 'РІСњВ¤РїС‘РЏ',
            name: 'Р РЋР С‘Р СР Р†Р С•Р В»РЎвЂ№',
            emojis: ['РІСњВ¤РїС‘РЏ','СЂСџВ§РЋ','СЂСџвЂ™вЂє','СЂСџвЂ™С™','СЂСџвЂ™в„ў','СЂСџвЂ™Сљ','СЂСџвЂ“В¤','СЂСџВ¤РЊ','СЂСџВ¤Р‹','СЂСџвЂ™вЂќ','РІСњР€РїС‘РЏ','СЂСџвЂ™вЂў','СЂСџвЂ™С›','СЂСџвЂ™вЂњ','СЂСџвЂ™вЂ”','СЂСџвЂ™вЂ“','СЂСџвЂ™В','СЂСџвЂ™Сњ','СЂСџвЂ™Сџ','РІВВ®РїС‘РЏ','РІСљСњРїС‘РЏ','РІВР„РїС‘РЏ','СЂСџвЂўвЂ°РїС‘РЏ','РІВС‘РїС‘РЏ','РІСљРЋРїС‘РЏ','СЂСџвЂќР‡','СЂСџвЂўР‹','РІВР‡РїС‘РЏ','РІВВ¦РїС‘РЏ','СЂСџвЂєС’','РІвЂєР‹','РІв„ўв‚¬','РІв„ўвЂ°','РІв„ўР‰','РІв„ўвЂ№','РІв„ўРЉ','РІв„ўРЊ','РІв„ўР‹','РІв„ўРЏ','РІв„ўС’','РІв„ўвЂ','РІв„ўвЂ™','РІв„ўвЂњ','СЂСџвЂ вЂќ','РІС™вЂєРїС‘РЏ','СЂСџвЂ°вЂ','РІВСћРїС‘РЏ','РІВР€РїС‘РЏ','СЂСџвЂњТ‘','СЂСџвЂњС–','СЂСџв‚¬В¶','СЂСџв‚¬С™','СЂСџв‚¬С‘','СЂСџв‚¬С”','СЂСџв‚¬В·РїС‘РЏ','РІСљТ‘РїС‘РЏ','СЂСџвЂ С™','СЂСџвЂ™В®','СЂСџвЂ°С’','РіР‰в„ўРїС‘РЏ','РіР‰вЂ”РїС‘РЏ','СЂСџв‚¬Т‘','СЂСџв‚¬Вµ','СЂСџв‚¬в„–','СЂСџв‚¬Р†','СЂСџвЂ¦В°РїС‘РЏ','СЂСџвЂ¦В±РїС‘РЏ','СЂСџвЂ Р‹','СЂСџвЂ вЂ','СЂСџвЂ¦С•РїС‘РЏ','СЂСџвЂ В','РІСњРЉ','РІВ­вЂў','СЂСџвЂєвЂ','РІвЂєвЂќ','СЂСџвЂњвЂє','СЂСџС™В«','СЂСџвЂ™Р‡','СЂСџвЂ™Сћ','РІв„ўРЃРїС‘РЏ','СЂСџС™В·','СЂСџС™Р‡','СЂСџС™С–','СЂСџС™В±','СЂСџвЂќС›','СЂСџвЂњВµ','СЂСџС™В­','РІСњвЂ”','РІСњвЂў','РІСњвЂњ','РІСњвЂќ','РІР‚СРїС‘РЏ','РІРѓвЂ°РїС‘РЏ','СЂСџвЂќвЂ¦','СЂСџвЂќвЂ ','РіР‚Р…РїС‘РЏ','РІС™В РїС‘РЏ','СЂСџС™С‘','СЂСџвЂќВ±','РІС™СљРїС‘РЏ','СЂСџвЂќВ°','РІв„ўВ»РїС‘РЏ','РІСљвЂ¦','СЂСџв‚¬Р‡','СЂСџвЂ™в„–','РІСњвЂЎРїС‘РЏ','РІСљС–РїС‘РЏ','РІСњР‹','СЂСџРЉС’','СЂСџвЂ™В ','РІвЂњвЂљРїС‘РЏ','СЂСџРЉР‚','СЂСџвЂ™В¤','СЂСџРЏВ§','СЂСџС™С•','РІв„ўС—','СЂСџвЂ¦С—РїС‘РЏ','СЂСџвЂєвЂ”','СЂСџв‚¬С–','СЂСџв‚¬вЂљРїС‘РЏ','СЂСџвЂєвЂљ','СЂСџвЂєС“','СЂСџвЂєвЂћ','СЂСџвЂєвЂ¦','СЂСџС™в„–','СЂСџС™С”','СЂСџС™С','РІС™В§РїС‘РЏ','СЂСџС™В»','СЂСџС™В®','СЂСџР‹В¦','СЂСџвЂњВ¶','СЂСџв‚¬Рѓ','СЂСџвЂќР€','РІвЂћв„–РїС‘РЏ','СЂСџвЂќВ¤','СЂСџвЂќРЋ','СЂСџвЂќВ ','СЂСџвЂ вЂ“','СЂСџвЂ вЂ”','СЂСџвЂ в„ў','СЂСџвЂ вЂ™','СЂСџвЂ вЂў','СЂСџвЂ вЂњ','0РїС‘РЏРІС“Р€','1РїС‘РЏРІС“Р€','2РїС‘РЏРІС“Р€','3РїС‘РЏРІС“Р€','4РїС‘РЏРІС“Р€','5РїС‘РЏРІС“Р€','6РїС‘РЏРІС“Р€','7РїС‘РЏРІС“Р€','8РїС‘РЏРІС“Р€','9РїС‘РЏРІС“Р€','СЂСџвЂќСџ','СЂСџвЂќСћ','#РїС‘РЏРІС“Р€','*РїС‘РЏРІС“Р€','РІРЏРЏРїС‘РЏ','РІвЂ“В¶РїС‘РЏ','РІРЏС‘РїС‘РЏ','РІРЏР‡РїС‘РЏ','РІРЏв„–РїС‘РЏ','РІРЏС”РїС‘РЏ','РІРЏВ­РїС‘РЏ','РІРЏВ®РїС‘РЏ','РІРЏВ©','РІРЏР„','РІРЏВ«','РІРЏВ¬','РІвЂ”Р‚РїС‘РЏ','СЂСџвЂќС','СЂСџвЂќР…','РІС›РЋРїС‘РЏ','РІВ¬вЂ¦РїС‘РЏ','РІВ¬вЂ РїС‘РЏ','РІВ¬вЂЎРїС‘РЏ','РІвЂ вЂ”РїС‘РЏ','РІвЂ ВРїС‘РЏ','РІвЂ в„ўРїС‘РЏ','РІвЂ вЂ“РїС‘РЏ','РІвЂ вЂўРїС‘РЏ','РІвЂ вЂќРїС‘РЏ','РІвЂ Р„РїС‘РЏ','РІвЂ В©РїС‘РЏ','РІВ¤Т‘РїС‘РЏ','РІВ¤ВµРїС‘РЏ','СЂСџвЂќР‚','СЂСџвЂќРѓ','СЂСџвЂќвЂљ','СЂСџвЂќвЂћ','СЂСџвЂќС“','СЂСџР‹Вµ','СЂСџР‹В¶','РІС›вЂў','РІС›вЂ“','РІС›вЂ”','РІСљвЂ“РїС‘РЏ','СЂСџСџВ°','РІв„ўС•РїС‘РЏ','СЂСџвЂ™Р†','СЂСџвЂ™В±','РІвЂћСћРїС‘РЏ','Р’В©РїС‘РЏ','Р’В®РїС‘РЏ','СЂСџвЂРѓРїС‘РЏРІР‚РЊСЂСџвЂ”РЃРїС‘РЏ','СЂСџвЂќС™','СЂСџвЂќв„ў','СЂСџвЂќвЂє','СЂСџвЂќСњ','СЂСџвЂќСљ','РіР‚В°РїС‘РЏ','РІС›В°','РІС›С—','РІСљвЂќРїС‘РЏ','РІВвЂРїС‘РЏ','СЂСџвЂќВ','СЂСџвЂќТ‘','СЂСџСџВ ','СЂСџСџРЋ','СЂСџСџСћ','СЂСџвЂќВµ','СЂСџСџР€','РІС™В«','РІС™Р„','СЂСџСџВ¤','СЂСџвЂќС”','СЂСџвЂќВ»','СЂСџвЂќС‘','СЂСџвЂќв„–','СЂСџвЂќВ¶','СЂСџвЂќВ·','СЂСџвЂќС–','СЂСџвЂќР†','РІвЂ“Р„РїС‘РЏ','РІвЂ“В«РїС‘РЏ','РІвЂ”С•','РІвЂ”Р…','РІвЂ”СРїС‘РЏ','РІвЂ”В»РїС‘РЏ','СЂСџСџТђ','СЂСџСџВ§','СЂСџСџРЃ','СЂСџСџВ©','СЂСџСџВ¦','СЂСџСџР„','РІВ¬вЂє','РІВ¬Сљ','СЂСџСџВ«','СЂСџвЂќв‚¬','СЂСџвЂќвЂЎ','СЂСџвЂќвЂ°','СЂСџвЂќР‰','СЂСџвЂќвЂќ','СЂСџвЂќвЂў','СЂСџвЂњР€','СЂСџвЂњСћ','СЂСџвЂ™В¬','СЂСџвЂ™В­','СЂСџвЂ”Р‡РїС‘РЏ','РІв„ўВ РїС‘РЏ','РІв„ўР€РїС‘РЏ','РІв„ўТђРїС‘РЏ','РІв„ўВ¦РїС‘РЏ','СЂСџС“РЏ','СЂСџР‹Т‘','СЂСџР‚вЂћ','СЂСџвЂўС’','СЂСџвЂўвЂ','СЂСџвЂўвЂ™','СЂСџвЂўвЂњ','СЂСџвЂўвЂќ','СЂСџвЂўвЂў','СЂСџвЂўвЂ“','СЂСџвЂўвЂ”','СЂСџвЂўВ','СЂСџвЂўв„ў','СЂСџвЂўС™','СЂСџвЂўвЂє','СЂСџвЂўСљ','СЂСџвЂўСњ','СЂСџвЂўС›','СЂСџвЂўСџ','СЂСџвЂўВ ','СЂСџвЂўРЋ','СЂСџвЂўСћ','СЂСџвЂўР€','СЂСџвЂўВ¤','СЂСџвЂўТђ','СЂСџвЂўВ¦','СЂСџвЂўВ§']
        },
        'flags': {
            icon: 'СЂСџРЏС–РїС‘РЏ',
            name: 'Р В¤Р В»Р В°Р С–Р С‘',
            emojis: ['СЂСџРЏС–РїС‘РЏ','СЂСџРЏТ‘','СЂСџРЏТ‘РІР‚РЊРІВВ РїС‘РЏ','СЂСџРЏРѓ','СЂСџС™В©','СЂСџР‹РЉ','СЂСџРЏС–РїС‘РЏРІР‚РЊСЂСџРЉв‚¬','СЂСџРЏС–РїС‘РЏРІР‚РЊРІС™В§РїС‘РЏ','СЂСџвЂЎС”СЂСџвЂЎС–','СЂСџвЂЎВ¦СЂСџвЂЎВ«','СЂСџвЂЎВ¦СЂСџвЂЎР…','СЂСџвЂЎВ¦СЂСџвЂЎВ±','СЂСџвЂЎВ©СЂСџвЂЎС—','СЂСџвЂЎВ¦СЂСџвЂЎС‘','СЂСџвЂЎВ¦СЂСџвЂЎВ©','СЂСџвЂЎВ¦СЂСџвЂЎТ‘','СЂСџвЂЎВ¦СЂСџвЂЎВ®','СЂСџвЂЎВ¦СЂСџвЂЎВ¶','СЂСџвЂЎВ¦СЂСџвЂЎВ¬','СЂСџвЂЎВ¦СЂСџвЂЎВ·','СЂСџвЂЎВ¦СЂСџвЂЎР†','СЂСџвЂЎВ¦СЂСџвЂЎС','СЂСџвЂЎВ¦СЂСџвЂЎС”','СЂСџвЂЎВ¦СЂСџвЂЎв„–','СЂСџвЂЎВ¦СЂСџвЂЎС—','СЂСџвЂЎВ§СЂСџвЂЎС‘','СЂСџвЂЎВ§СЂСџвЂЎВ­','СЂСџвЂЎВ§СЂСџвЂЎВ©','СЂСџвЂЎВ§СЂСџвЂЎВ§','СЂСџвЂЎВ§СЂСџвЂЎС•','СЂСџвЂЎВ§СЂСџвЂЎР„','СЂСџвЂЎВ§СЂСџвЂЎС—','СЂСџвЂЎВ§СЂСџвЂЎР‡','СЂСџвЂЎВ§СЂСџвЂЎР†','СЂСџвЂЎВ§СЂСџвЂЎв„–','СЂСџвЂЎВ§СЂСџвЂЎТ‘','СЂСџвЂЎВ§СЂСџвЂЎВ¦','СЂСџвЂЎВ§СЂСџвЂЎС','СЂСџвЂЎВ§СЂСџвЂЎВ·','СЂСџвЂЎВ®СЂСџвЂЎТ‘','СЂСџвЂЎВ»СЂСџвЂЎВ¬','СЂСџвЂЎВ§СЂСџвЂЎС–','СЂСџвЂЎВ§СЂСџвЂЎВ¬','СЂСџвЂЎВ§СЂСџвЂЎВ«','СЂСџвЂЎВ§СЂСџвЂЎВ®','СЂСџвЂЎВ°СЂСџвЂЎВ­','СЂСџвЂЎРЃСЂСџвЂЎР†','СЂСџвЂЎРЃСЂСџвЂЎВ¦','СЂСџвЂЎВ®СЂСџвЂЎРЃ','СЂСџвЂЎРЃСЂСџвЂЎВ»','СЂСџвЂЎВ§СЂСџвЂЎВ¶','СЂСџвЂЎВ°СЂСџвЂЎС•','СЂСџвЂЎРЃСЂСџвЂЎВ«','СЂСџвЂЎв„–СЂСџвЂЎВ©','СЂСџвЂЎРЃСЂСџвЂЎВ±','СЂСџвЂЎРЃСЂСџвЂЎС–','СЂСџвЂЎРЃСЂСџвЂЎР…','СЂСџвЂЎРЃСЂСџвЂЎРЃ','СЂСџвЂЎРЃСЂСџвЂЎТ‘','СЂСџвЂЎВ°СЂСџвЂЎР†','СЂСџвЂЎРЃСЂСџвЂЎВ¬','СЂСџвЂЎРЃСЂСџвЂЎВ©','СЂСџвЂЎРЃСЂСџвЂЎВ°','СЂСџвЂЎРЃСЂСџвЂЎВ·','СЂСџвЂЎРЃСЂСџвЂЎВ®','СЂСџвЂЎВ­СЂСџвЂЎВ·','СЂСџвЂЎРЃСЂСџвЂЎС”','СЂСџвЂЎРЃСЂСџвЂЎС','СЂСџвЂЎРЃСЂСџвЂЎС•','СЂСџвЂЎРЃСЂСџвЂЎС—','СЂСџвЂЎВ©СЂСџвЂЎВ°','СЂСџвЂЎВ©СЂСџвЂЎР‡','СЂСџвЂЎВ©СЂСџвЂЎР†','СЂСџвЂЎВ©СЂСџвЂЎТ‘','СЂСџвЂЎР„СЂСџвЂЎРЃ','СЂСџвЂЎР„СЂСџвЂЎВ¬','СЂСџвЂЎС‘СЂСџвЂЎВ»','СЂСџвЂЎВ¬СЂСџвЂЎВ¶','СЂСџвЂЎР„СЂСџвЂЎВ·','СЂСџвЂЎР„СЂСџвЂЎР„','СЂСџвЂЎС‘СЂСџвЂЎС—','СЂСџвЂЎР„СЂСџвЂЎв„–','СЂСџвЂЎР„СЂСџвЂЎС”','СЂСџвЂЎВ«СЂСџвЂЎВ°','СЂСџвЂЎВ«СЂСџвЂЎТ‘','СЂСџвЂЎВ«СЂСџвЂЎР‡','СЂСџвЂЎВ«СЂСџвЂЎВ®','СЂСџвЂЎВ«СЂСџвЂЎВ·','СЂСџвЂЎВ¬СЂСџвЂЎВ«','СЂСџвЂЎВµСЂСџвЂЎВ«','СЂСџвЂЎв„–СЂСџвЂЎВ«','СЂСџвЂЎВ¬СЂСџвЂЎВ¦','СЂСџвЂЎВ¬СЂСџвЂЎР†','СЂСџвЂЎВ¬СЂСџвЂЎР„','СЂСџвЂЎВ©СЂСџвЂЎР„','СЂСџвЂЎВ¬СЂСџвЂЎВ­','СЂСџвЂЎВ¬СЂСџвЂЎВ®','СЂСџвЂЎВ¬СЂСџвЂЎВ·','СЂСџвЂЎВ¬СЂСџвЂЎВ±','СЂСџвЂЎВ¬СЂСџвЂЎВ©','СЂСџвЂЎВ¬СЂСџвЂЎВµ','СЂСџвЂЎВ¬СЂСџвЂЎС”','СЂСџвЂЎВ¬СЂСџвЂЎв„–','СЂСџвЂЎВ¬СЂСџвЂЎВ¬','СЂСџвЂЎВ¬СЂСџвЂЎС–','СЂСџвЂЎВ¬СЂСџвЂЎС','СЂСџвЂЎВ¬СЂСџвЂЎС•','СЂСџвЂЎВ­СЂСџвЂЎв„–','СЂСџвЂЎВ­СЂСџвЂЎС–','СЂСџвЂЎВ­СЂСџвЂЎВ°','СЂСџвЂЎВ­СЂСџвЂЎС”','СЂСџвЂЎВ®СЂСџвЂЎС‘','СЂСџвЂЎВ®СЂСџвЂЎС–','СЂСџвЂЎВ®СЂСџвЂЎВ©','СЂСџвЂЎВ®СЂСџвЂЎВ·','СЂСџвЂЎВ®СЂСџвЂЎВ¶','СЂСџвЂЎВ®СЂСџвЂЎР„','СЂСџвЂЎВ®СЂСџвЂЎР†','СЂСџвЂЎВ®СЂСџвЂЎВ±','СЂСџвЂЎВ®СЂСџвЂЎв„–','СЂСџвЂЎР‡СЂСџвЂЎР†','СЂСџвЂЎР‡СЂСџвЂЎВµ','СЂСџР‹РЉ','СЂСџвЂЎР‡СЂСџвЂЎР„','СЂСџвЂЎР‡СЂСџвЂЎТ‘','СЂСџвЂЎВ°СЂСџвЂЎС—','СЂСџвЂЎВ°СЂСџвЂЎР„','СЂСџвЂЎВ°СЂСџвЂЎВ®','СЂСџвЂЎР…СЂСџвЂЎВ°','СЂСџвЂЎВ°СЂСџвЂЎС','СЂСџвЂЎВ°СЂСџвЂЎВ¬','СЂСџвЂЎВ±СЂСџвЂЎВ¦','СЂСџвЂЎВ±СЂСџвЂЎВ»','СЂСџвЂЎВ±СЂСџвЂЎВ§','СЂСџвЂЎВ±СЂСџвЂЎС‘','СЂСџвЂЎВ±СЂСџвЂЎВ·','СЂСџвЂЎВ±СЂСџвЂЎС•','СЂСџвЂЎВ±СЂСџвЂЎВ®','СЂСџвЂЎВ±СЂСџвЂЎв„–','СЂСџвЂЎВ±СЂСџвЂЎС”','СЂСџвЂЎР†СЂСџвЂЎТ‘','СЂСџвЂЎР†СЂСџвЂЎВ¬','СЂСџвЂЎР†СЂСџвЂЎС','СЂСџвЂЎР†СЂСџвЂЎС•','СЂСџвЂЎР†СЂСџвЂЎВ»','СЂСџвЂЎР†СЂСџвЂЎВ±','СЂСџвЂЎР†СЂСџвЂЎв„–','СЂСџвЂЎР†СЂСџвЂЎВ­','СЂСџвЂЎР†СЂСџвЂЎВ¶','СЂСџвЂЎР†СЂСџвЂЎВ·','СЂСџвЂЎР†СЂСџвЂЎС”','СЂСџвЂЎС•СЂСџвЂЎв„–','СЂСџвЂЎР†СЂСџвЂЎР…','СЂСџвЂЎВ«СЂСџвЂЎР†','СЂСџвЂЎР†СЂСџвЂЎВ©','СЂСџвЂЎР†СЂСџвЂЎРЃ','СЂСџвЂЎР†СЂСџвЂЎС–','СЂСџвЂЎР†СЂСџвЂЎР„','СЂСџвЂЎР†СЂСџвЂЎС‘','СЂСџвЂЎР†СЂСџвЂЎВ¦','СЂСџвЂЎР†СЂСџвЂЎС—','СЂСџвЂЎР†СЂСџвЂЎР†','СЂСџвЂЎС–СЂСџвЂЎВ¦','СЂСџвЂЎС–СЂСџвЂЎВ·','СЂСџвЂЎС–СЂСџвЂЎВµ','СЂСџвЂЎС–СЂСџвЂЎВ±','СЂСџвЂЎС–СЂСџвЂЎРЃ','СЂСџвЂЎС–СЂСџвЂЎС—','СЂСџвЂЎС–СЂСџвЂЎВ®','СЂСџвЂЎС–СЂСџвЂЎР„','СЂСџвЂЎС–СЂСџвЂЎВ¬','СЂСџвЂЎС–СЂСџвЂЎС”','СЂСџвЂЎС–СЂСџвЂЎВ«','СЂСџвЂЎВ°СЂСџвЂЎВµ','СЂСџвЂЎР†СЂСџвЂЎВ°','СЂСџвЂЎР†СЂСџвЂЎВµ','СЂСџвЂЎС–СЂСџвЂЎТ‘','СЂСџвЂЎТ‘СЂСџвЂЎР†','СЂСџвЂЎВµСЂСџвЂЎВ°','СЂСџвЂЎВµСЂСџвЂЎС','СЂСџвЂЎВµСЂСџвЂЎС‘','СЂСџвЂЎВµСЂСџвЂЎВ¦','СЂСџвЂЎВµСЂСџвЂЎВ¬','СЂСџвЂЎВµСЂСџвЂЎС•','СЂСџвЂЎВµСЂСџвЂЎР„','СЂСџвЂЎВµСЂСџвЂЎВ­','СЂСџвЂЎВµСЂСџвЂЎС–','СЂСџвЂЎВµСЂСџвЂЎВ±','СЂСџвЂЎВµСЂСџвЂЎв„–','СЂСџвЂЎВµСЂСџвЂЎВ·','СЂСџвЂЎВ¶СЂСџвЂЎВ¦','СЂСџвЂЎВ·СЂСџвЂЎР„','СЂСџвЂЎВ·СЂСџвЂЎТ‘','СЂСџвЂЎВ·СЂСџвЂЎС”','СЂСџвЂЎВ·СЂСџвЂЎС','СЂСџвЂЎССЂСџвЂЎС‘','СЂСџвЂЎС‘СЂСџвЂЎР†','СЂСџвЂЎС‘СЂСџвЂЎв„–','СЂСџвЂЎС‘СЂСџвЂЎВ¦','СЂСџвЂЎС‘СЂСџвЂЎС–','СЂСџвЂЎВ·СЂСџвЂЎС‘','СЂСџвЂЎС‘СЂСџвЂЎРЃ','СЂСџвЂЎС‘СЂСџвЂЎВ±','СЂСџвЂЎС‘СЂСџвЂЎВ¬','СЂСџвЂЎС‘СЂСџвЂЎР…','СЂСџвЂЎС‘СЂСџвЂЎВ°','СЂСџвЂЎС‘СЂСџвЂЎВ®','СЂСџвЂЎВ¬СЂСџвЂЎС‘','СЂСџвЂЎС‘СЂСџвЂЎВ§','СЂСџвЂЎС‘СЂСџвЂЎТ‘','СЂСџвЂЎС—СЂСџвЂЎВ¦','СЂСџвЂЎВ°СЂСџвЂЎВ·','СЂСџвЂЎС‘СЂСџвЂЎС‘','СЂСџвЂЎР„СЂСџвЂЎС‘','СЂСџвЂЎВ±СЂСџвЂЎВ°','СЂСџвЂЎВ§СЂСџвЂЎВ±','СЂСџвЂЎС‘СЂСџвЂЎВ­','СЂСџвЂЎВ°СЂСџвЂЎС–','СЂСџвЂЎВ±СЂСџвЂЎРЃ','СЂСџвЂЎВµСЂСџвЂЎР†','СЂСџвЂЎВ»СЂСџвЂЎРЃ','СЂСџвЂЎС‘СЂСџвЂЎВ©','СЂСџвЂЎС‘СЂСџвЂЎВ·','СЂСџвЂЎС‘СЂСџвЂЎР„','СЂСџвЂЎРЃСЂСџвЂЎВ­','СЂСџвЂЎС‘СЂСџвЂЎС•','СЂСџвЂЎв„–СЂСџвЂЎС','СЂСџвЂЎв„–СЂСџвЂЎР‡','СЂСџвЂЎв„–СЂСџвЂЎС—','СЂСџвЂЎв„–СЂСџвЂЎВ­','СЂСџвЂЎв„–СЂСџвЂЎВ±','СЂСџвЂЎв„–СЂСџвЂЎВ¬','СЂСџвЂЎв„–СЂСџвЂЎВ°','СЂСџвЂЎв„–СЂСџвЂЎТ‘','СЂСџвЂЎв„–СЂСџвЂЎв„–','СЂСџвЂЎв„–СЂСџвЂЎС–','СЂСџвЂЎв„–СЂСџвЂЎВ·','СЂСџвЂЎв„–СЂСџвЂЎР†','СЂСџвЂЎв„–СЂСџвЂЎРЃ','СЂСџвЂЎв„–СЂСџвЂЎВ»','СЂСџвЂЎВ»СЂСџвЂЎВ®','СЂСџвЂЎС”СЂСџвЂЎВ¬','СЂСџвЂЎС”СЂСџвЂЎВ¦','СЂСџвЂЎВ¦СЂСџвЂЎР„','СЂСџвЂЎВ¬СЂСџвЂЎВ§','СЂСџРЏТ‘СѓВ РѓВ§СѓВ РѓСћСѓВ РѓТђСѓВ РѓВ®СѓВ РѓВ§СѓВ РѓС—','СЂСџРЏТ‘СѓВ РѓВ§СѓВ РѓСћСѓВ РѓС–СѓВ РѓР€СѓВ РѓТ‘СѓВ РѓС—','СЂСџРЏТ‘СѓВ РѓВ§СѓВ РѓСћСѓВ РѓВ·СѓВ РѓВ¬СѓВ РѓС–СѓВ РѓС—','СЂСџвЂЎС”СЂСџвЂЎС‘','СЂСџвЂЎС”СЂСџвЂЎС•','СЂСџвЂЎС”СЂСџвЂЎС—','СЂСџвЂЎВ»СЂСџвЂЎС”','СЂСџвЂЎВ»СЂСџвЂЎВ¦','СЂСџвЂЎВ»СЂСџвЂЎР„','СЂСџвЂЎВ»СЂСџвЂЎС–','СЂСџвЂЎССЂСџвЂЎВ«','СЂСџвЂЎР„СЂСџвЂЎВ­','СЂСџвЂЎС•СЂСџвЂЎР„','СЂСџвЂЎС—СЂСџвЂЎР†','СЂСџвЂЎС—СЂСџвЂЎС']
        }
    };

    let currentEmojiCategory = 'smileys';

    function initEmoji() {
        const tabsContainer = document.getElementById('emoji-tabs');
        const contentContainer = document.getElementById('emoji-content');
        
        // Р РЋР С•Р В·Р Т‘Р В°Р ВµР С РЎвЂљР В°Р В±РЎвЂ№
        tabsContainer.innerHTML = '';
        Object.keys(emojiCategories).forEach(key => {
            const cat = emojiCategories[key];
            const tab = document.createElement('div');
            tab.className = `emoji-tab ${key === currentEmojiCategory ? 'active' : ''}`;
            tab.innerText = cat.icon;
            tab.title = cat.name;
            tab.onclick = () => selectEmojiCategory(key);
            tabsContainer.appendChild(tab);
        });
        
        renderEmojiCategory(currentEmojiCategory);
        
        // Р СџР С•Р С‘РЎРѓР С”
        document.getElementById('emoji-search-input').oninput = (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (query) {
                searchEmojis(query);
            } else {
                renderEmojiCategory(currentEmojiCategory);
            }
        };
    }

    function selectEmojiCategory(key) {
        currentEmojiCategory = key;
        document.querySelectorAll('.emoji-tab').forEach((tab, i) => {
            tab.classList.toggle('active', Object.keys(emojiCategories)[i] === key);
        });
        document.getElementById('emoji-search-input').value = '';
        renderEmojiCategory(key);
    }

    function renderEmojiCategory(key) {
        const contentContainer = document.getElementById('emoji-content');
        const cat = emojiCategories[key];
        
        contentContainer.innerHTML = `
            <div class="emoji-category-title">${cat.name}</div>
            <div class="emoji-grid"></div>
        `;
        
        const grid = contentContainer.querySelector('.emoji-grid');
        cat.emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.innerText = emoji;
            span.onclick = () => insertEmoji(emoji);
            grid.appendChild(span);
        });
    }

    function searchEmojis(query) {
        const contentContainer = document.getElementById('emoji-content');
        contentContainer.innerHTML = '<div class="emoji-category-title">Р В Р ВµР В·РЎС“Р В»РЎРЉРЎвЂљР В°РЎвЂљРЎвЂ№ Р С—Р С•Р С‘РЎРѓР С”Р В°</div><div class="emoji-grid"></div>';
        const grid = contentContainer.querySelector('.emoji-grid');
        
        let found = false;
        Object.values(emojiCategories).forEach(cat => {
            cat.emojis.forEach(emoji => {
                if (emoji.includes(query) || cat.name.toLowerCase().includes(query)) {
                    found = true;
                    const span = document.createElement('span');
                    span.className = 'emoji-item';
                    span.innerText = emoji;
                    span.onclick = () => insertEmoji(emoji);
                    grid.appendChild(span);
                }
            });
        });
        
        if (!found) {
            contentContainer.innerHTML = '<div class="p-4 text-center text-sm opacity-50">Р СњР С‘РЎвЂЎР ВµР С–Р С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•</div>';
        }
    }

    function insertEmoji(emoji) {
        const mobileInput = document.getElementById('msg-input');
        const desktopInput = document.getElementById('msg-input-desktop');
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile && mobileInput) {
            mobileInput.value += emoji;
            mobileInput.focus();
            if (desktopInput) desktopInput.value = mobileInput.value;
        } else if (desktopInput) {
            desktopInput.value += emoji;
            desktopInput.focus();
            if (mobileInput) mobileInput.value = desktopInput.value;
        }
        handleInputChange();
    }
    
    window.toggleEmoji = () => document.getElementById('emoji-panel').classList.toggle('active');
    
    // Р СџР В»РЎР‹РЎРѓ-Р СР ВµР Р…РЎР‹
    window.togglePlusMenu = () => {
        const btn = document.getElementById('plus-menu-btn');
        const menu = document.getElementById('plus-menu');
        btn.classList.toggle('active');
        menu.classList.toggle('active');
    };
    
    // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С—Р В»РЎР‹РЎРѓ-Р СР ВµР Р…РЎР‹ Р С—РЎР‚Р С‘ Р С”Р В»Р С‘Р С”Р Вµ Р Р†Р Р…Р Вµ
    document.addEventListener('click', (e) => {
        const container = document.querySelector('.plus-menu-container');
        if (container && !container.contains(e.target)) {
            document.getElementById('plus-menu-btn')?.classList.remove('active');
            document.getElementById('plus-menu')?.classList.remove('active');
        }
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р С–Р С• Р СР ВµР Р…РЎР‹ РЎвЂЎР В°РЎвЂљР В°
        const chatContextMenu = document.getElementById('chat-context-menu');
        if (chatContextMenu && !chatContextMenu.contains(e.target)) {
            chatContextMenu.remove();
        }
    });

    // ========== AI Assistant (Groq - FREE) ==========
    let aiResult = '';
    // Groq API Key (Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…Р С•: https://console.groq.com/keys)
    const GROQ_API_KEY = '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';
    const GROQ_MODEL = 'llama-3.1-8b-instant';
    
    window.toggleAI = () => {
        const panel = document.getElementById('ai-panel');
        panel.classList.toggle('hidden');
        
        if (!panel.classList.contains('hidden')) {
            document.getElementById('ai-options').classList.remove('hidden');
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-result').classList.add('hidden');
            document.getElementById('ai-result-actions').classList.add('hidden');
        }
    };
    
    // Р вЂ™РЎвЂ№Р В·Р С•Р Р† Groq API (Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…РЎвЂ№Р в„–!)
    async function callGroqAI(messages, systemPrompt = '') {
        if (!GROQ_API_KEY) {
            throw new Error('API Р С”Р В»РЎР‹РЎвЂЎ Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…');
        }
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С—Р В»Р В°РЎвЂљРЎвЂћР С•РЎР‚Р СРЎС“ - Р Р† Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р Вµ Groq Р Р…Р Вµ РЎР‚Р В°Р В±Р С•РЎвЂљР В°Р ВµРЎвЂљ Р С‘Р В·-Р В·Р В° CORS
        const isElectron = navigator.userAgent.includes('Electron');
        const isCapacitor = !!(window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform());
        
        // Р вЂ™ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р Вµ РЎРѓРЎР‚Р В°Р В·РЎС“ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…РЎС“РЎР‹ Р С–Р ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎР‹ (Р В±Р ВµР В· CORS Р С•РЎв‚¬Р С‘Р В±Р С”Р С‘)
        if (!isElectron && !isCapacitor) {
            return generateLocalResponse(messages);
        }
        
        const apiMessages = [];
        
        if (systemPrompt) {
            apiMessages.push({ role: 'system', content: systemPrompt });
        }
        
        apiMessages.push(...messages);
        
        try {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: GROQ_MODEL,
                    messages: apiMessages,
                    max_tokens: 512,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || 'API Error');
            }
            
            const data = await response.json();
            return data.choices[0]?.message?.content || '';
        } catch (err) {
            // Р вЂўРЎРѓР В»Р С‘ Р С•РЎв‚¬Р С‘Р В±Р С”Р В° - Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…РЎС“РЎР‹ Р С–Р ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎР‹
            console.log('Groq API error, using local generation:', err.message);
            return generateLocalResponse(messages);
        }
    }
    
    // Р вЂєР С•Р С”Р В°Р В»РЎРЉР Р…Р В°РЎРЏ Р С–Р ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎРЏ Р С•РЎвЂљР Р†Р ВµРЎвЂљР С•Р Р† Р Т‘Р В»РЎРЏ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р В° (Р В±Р ВµР В· CORS Р С—РЎР‚Р С•Р В±Р В»Р ВµР С)
    function generateLocalResponse(messages) {
        const lastMessage = messages[messages.length - 1]?.content || '';
        const lowerMsg = lastMessage.toLowerCase();
        const isRu = /[Р В°-РЎРЏРЎвЂ]/i.test(lastMessage);
        
        const templates = {
            greeting: {
                patterns: ['Р С—РЎР‚Р С‘Р Р†Р ВµРЎвЂљ', 'Р В·Р Т‘РЎР‚Р В°Р Р†РЎРѓРЎвЂљР Р†РЎС“Р в„–', 'РЎвЂ¦Р В°Р в„–', 'hello', 'hi', 'hey', 'Р Т‘Р С•Р В±РЎР‚'],
                ru: ['Р СџРЎР‚Р С‘Р Р†Р ВµРЎвЂљ! СЂСџвЂвЂ№', 'Р вЂ”Р Т‘РЎР‚Р В°Р Р†РЎРѓРЎвЂљР Р†РЎС“Р в„–! СЂСџВР‰', 'Р СџРЎР‚Р С‘Р Р†Р ВµРЎвЂљ! Р С™Р В°Р С” Р Т‘Р ВµР В»Р В°?', 'Р ТђР ВµР в„–! СЂСџвЂвЂ№'],
                en: ['Hello! СЂСџвЂвЂ№', 'Hi there! СЂСџВР‰', 'Hey! How are you?', 'Hi! СЂСџвЂвЂ№']
            },
            howAreYou: {
                patterns: ['Р С”Р В°Р С” Р Т‘Р ВµР В»Р В°', 'Р С”Р В°Р С” РЎвЂљРЎвЂ№', 'Р С”Р В°Р С” Р В¶Р С‘Р В·Р Р…РЎРЉ', 'how are you', 'what\'s up'],
                ru: ['Р С›РЎвЂљР В»Р С‘РЎвЂЎР Р…Р С•! Р С’ РЎС“ РЎвЂљР ВµР В±РЎРЏ? СЂСџВР‰', 'Р вЂ™РЎРѓРЎвЂ РЎвЂ¦Р С•РЎР‚Р С•РЎв‚¬Р С•! СЂСџвЂРЊ', 'Р СџРЎР‚Р ВµР С”РЎР‚Р В°РЎРѓР Р…Р С•!'],
                en: ['Great, thanks! СЂСџВР‰', 'Doing well! СЂСџвЂРЊ', 'Pretty good!']
            },
            thanks: {
                patterns: ['РЎРѓР С—Р В°РЎРѓР С‘Р В±Р С•', 'Р В±Р В»Р В°Р С–Р С•Р Т‘Р В°РЎР‚РЎР‹', 'thank', 'thanks'],
                ru: ['Р СџР С•Р В¶Р В°Р В»РЎС“Р в„–РЎРѓРЎвЂљР В°! СЂСџВР‰', 'Р СњР Вµ Р В·Р В° РЎвЂЎРЎвЂљР С•! СЂСџвЂРЊ', 'Р В Р В°Р Т‘ Р С—Р С•Р СР С•РЎвЂЎРЎРЉ!'],
                en: ['You\'re welcome! СЂСџВР‰', 'No problem! СЂСџвЂРЊ', 'Happy to help!']
            },
            bye: {
                patterns: ['Р С—Р С•Р С”Р В°', 'Р Т‘Р С• РЎРѓР Р†Р С‘Р Т‘Р В°Р Р…Р С‘РЎРЏ', 'bye', 'goodbye', 'see you'],
                ru: ['Р СџР С•Р С”Р В°! СЂСџвЂвЂ№', 'Р вЂќР С• Р Р†РЎРѓРЎвЂљРЎР‚Р ВµРЎвЂЎР С‘! СЂСџВР‰', 'Р Р€Р Т‘Р В°РЎвЂЎР С‘! СЂСџвЂвЂ№'],
                en: ['Bye! СЂСџвЂвЂ№', 'See you! СЂСџВР‰', 'Take care! СЂСџвЂвЂ№']
            },
            agree: {
                patterns: ['Р Т‘Р В°', 'Р С”Р С•Р Р…Р ВµРЎвЂЎР Р…Р С•', 'РЎвЂ¦Р С•РЎР‚Р С•РЎв‚¬Р С•', 'yes', 'sure', 'okay', 'ok', 'Р С•Р С”'],
                ru: ['Р С›РЎвЂљР В»Р С‘РЎвЂЎР Р…Р С•! СЂСџвЂРЊ', 'Р РЋРЎС“Р С—Р ВµРЎР‚! СЂСџВР‰', 'Р вЂќР С•Р С–Р С•Р Р†Р С•РЎР‚Р С‘Р В»Р С‘РЎРѓРЎРЉ!'],
                en: ['Great! СЂСџвЂРЊ', 'Awesome! СЂСџВР‰', 'Perfect!']
            },
            love: {
                patterns: ['Р В»РЎР‹Р В±Р В»РЎР‹', 'love', 'РІСњВ¤', 'СЂСџВРЊ', 'Р Р…РЎР‚Р В°Р Р†'],
                ru: ['Р В РЎРЏ РЎвЂљР ВµР В±РЎРЏ! РІСњВ¤РїС‘РЏ', 'Р вЂ™Р В·Р В°Р С‘Р СР Р…Р С•! СЂСџВР‰', 'РІСњВ¤РїС‘РЏ'],
                en: ['Love you too! РІСњВ¤РїС‘РЏ', 'Same here! СЂСџВР‰', 'РІСњВ¤РїС‘РЏ']
            },
            laugh: {
                patterns: ['РЎвЂ¦Р В°РЎвЂ¦Р В°', 'Р В»Р С•Р В»', 'Р В°РЎвЂ¦Р В°РЎвЂ¦', 'haha', 'lol', 'СЂСџВвЂљ', 'СЂСџВ¤Р€'],
                ru: ['СЂСџВвЂљСЂСџВвЂљ', 'Р С’РЎвЂ¦Р В°РЎвЂ¦Р В° СЂСџВвЂћ', 'СЂСџВ¤Р€'],
                en: ['СЂСџВвЂљСЂСџВвЂљ', 'Haha СЂСџВвЂћ', 'СЂСџВ¤Р€']
            },
            question: {
                patterns: ['?', 'Р С—Р С•РЎвЂЎР ВµР СРЎС“', 'Р В·Р В°РЎвЂЎР ВµР С', 'Р С”Р В°Р С”', 'РЎвЂЎРЎвЂљР С•', 'why', 'how', 'what'],
                ru: ['Р ТђР С•РЎР‚Р С•РЎв‚¬Р С‘Р в„– Р Р†Р С•Р С—РЎР‚Р С•РЎРѓ! СЂСџВ¤вЂќ', 'Р ВР Р…РЎвЂљР ВµРЎР‚Р ВµРЎРѓР Р…Р С•... СЂСџВ¤вЂќ', 'Р СњР В°Р Т‘Р С• Р С—Р С•Р Т‘РЎС“Р СР В°РЎвЂљРЎРЉ СЂСџВ¤вЂќ'],
                en: ['Good question! СЂСџВ¤вЂќ', 'Interesting... СЂСџВ¤вЂќ', 'Let me think СЂСџВ¤вЂќ']
            }
        };
        
        for (const template of Object.values(templates)) {
            for (const pattern of template.patterns) {
                if (lowerMsg.includes(pattern)) {
                    const responses = isRu ? template.ru : template.en;
                    return responses[Math.floor(Math.random() * responses.length)];
                }
            }
        }
        
        const defaults = isRu 
            ? ['Р СџР С•Р Р…РЎРЏР В»! СЂСџвЂРЊ', 'Р ВР Р…РЎвЂљР ВµРЎР‚Р ВµРЎРѓР Р…Р С•! СЂСџВР‰', 'Р С’Р С–Р В°! СЂСџвЂРЉ', 'Р С›Р С”Р ВµР в„–! СЂСџВР‰', 'СЂСџвЂРЊ']
            : ['Got it! СЂСџвЂРЊ', 'Nice! СЂСџВР‰', 'Alright! СЂСџвЂРЉ', 'Okay! СЂСџВР‰', 'СЂСџвЂРЊ'];
        
        return defaults[Math.floor(Math.random() * defaults.length)];
    }
    
    // Р вЂњР ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎС“Р СР Р…Р С•Р С–Р С• Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° РЎвЂЎР ВµРЎР‚Р ВµР В· AI
    async function generateSmartReply(messages) {
        const isRu = currentLang === 'ru';
        
        const systemPrompt = isRu 
            ? `Р СћРЎвЂ№ Р Т‘РЎР‚РЎС“Р В¶Р ВµР В»РЎР‹Р В±Р Р…РЎвЂ№Р в„– Р С—Р С•Р СР С•РЎвЂ°Р Р…Р С‘Р С” Р Р† Р СР ВµРЎРѓРЎРѓР ВµР Р…Р Т‘Р В¶Р ВµРЎР‚Р Вµ. Р вЂњР ВµР Р…Р ВµРЎР‚Р С‘РЎР‚РЎС“Р в„– Р С”Р С•РЎР‚Р С•РЎвЂљР С”Р С‘Р Вµ, Р ВµРЎРѓРЎвЂљР ВµРЎРѓРЎвЂљР Р†Р ВµР Р…Р Р…РЎвЂ№Р Вµ Р С•РЎвЂљР Р†Р ВµРЎвЂљРЎвЂ№ Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ. Р С›РЎвЂљР Р†Р ВµРЎвЂЎР В°Р в„– Р Р…Р В° РЎвЂљР С•Р С Р В¶Р Вµ РЎРЏР В·РЎвЂ№Р С”Р Вµ, Р Р…Р В° Р С”Р С•РЎвЂљР С•РЎР‚Р С•Р С Р Р…Р В°Р С—Р С‘РЎРѓР В°Р Р…Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ. Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р в„– РЎРЊР СР С•Р Т‘Р В·Р С‘ РЎС“Р СР ВµРЎРѓРЎвЂљР Р…Р С•. Р вЂРЎС“Р Т‘РЎРЉ Р С”РЎР‚Р В°РЎвЂљР С”Р С‘Р С - Р СР В°Р С”РЎРѓР С‘Р СРЎС“Р С 1-2 Р С—РЎР‚Р ВµР Т‘Р В»Р С•Р В¶Р ВµР Р…Р С‘РЎРЏ.`
            : `You are a friendly messenger assistant. Generate short, natural replies to messages. Reply in the same language as the message. Use emojis appropriately. Be brief - max 1-2 sentences.`;
        
        const chatContext = messages.map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            content: m.content
        }));
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р В·Р В°Р С—РЎР‚Р С•РЎРѓ Р Р…Р В° Р С–Р ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎР‹ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°
        chatContext.push({
            role: 'user',
            content: isRu ? 'Р РЋР С–Р ВµР Р…Р ВµРЎР‚Р С‘РЎР‚РЎС“Р в„– Р С—Р С•Р Т‘РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р в„– Р С•РЎвЂљР Р†Р ВµРЎвЂљ Р Р…Р В° Р С—Р С•РЎРѓР В»Р ВµР Т‘Р Р…Р ВµР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ:' : 'Generate an appropriate reply to the last message:'
        });
        
        try {
            return await callGroqAI(chatContext, systemPrompt);
        } catch (err) {
            return generateLocalSmartReply(messages, isRu);
        }
    }
    
    // Р вЂєР С•Р С”Р В°Р В»РЎРЉР Р…Р В°РЎРЏ Р С–Р ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎС“Р СР Р…Р С•Р С–Р С• Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° Р Т‘Р В»РЎРЏ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р В°
    function generateLocalSmartReply(messages, isRu) {
        const lastMsg = messages[messages.length - 1]?.content || '';
        const lower = lastMsg.toLowerCase();
        
        // Р С’Р Р…Р В°Р В»Р С‘Р В·Р С‘РЎР‚РЎС“Р ВµР С Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
        const hasQuestion = lastMsg.includes('?');
        const hasEmoji = /[\u{1F300}-\u{1F9FF}]/u.test(lastMsg);
        const isShort = lastMsg.length < 20;
        const mentionsTime = /Р В·Р В°Р Р†РЎвЂљРЎР‚Р В°|РЎРѓР ВµР С–Р С•Р Т‘Р Р…РЎРЏ|Р Р†Р ВµРЎвЂЎР ВµРЎР‚|РЎС“РЎвЂљРЎР‚|tomorrow|today|evening|morning/i.test(lower);
        const mentionsPlace = /Р С–Р Т‘Р Вµ|Р С”РЎС“Р Т‘Р В°|Р СР ВµРЎРѓРЎвЂљР С•|Р Р†РЎРѓРЎвЂљРЎР‚Р ВµРЎвЂЎ|where|place|meet/i.test(lower);
        const mentionsFood = /Р ВµРЎРѓРЎвЂљРЎРЉ|Р ВµР Т‘Р В°|Р С”РЎС“РЎв‚¬Р В°РЎвЂљРЎРЉ|РЎР‚Р ВµРЎРѓРЎвЂљР С•РЎР‚Р В°Р Р…|Р С”Р В°РЎвЂћР Вµ|eat|food|restaurant|cafe/i.test(lower);
        const isPositive = /Р С”РЎР‚РЎС“РЎвЂљР С•|Р С”Р В»Р В°РЎРѓРЎРѓ|РЎРѓРЎС“Р С—Р ВµРЎР‚|Р С•РЎвЂљР В»Р С‘РЎвЂЎР Р…Р С•|РЎвЂ¦Р С•РЎР‚Р С•РЎв‚¬Р С•|cool|great|awesome|nice|good/i.test(lower);
        const isNegative = /Р С—Р В»Р С•РЎвЂ¦Р С•|Р С–РЎР‚РЎС“РЎРѓРЎвЂљР Р…Р С•|РЎС“РЎРѓРЎвЂљР В°Р В»|Р Р…Р В°Р Т‘Р С•Р ВµР В»Р С•|bad|sad|tired|bored/i.test(lower);
        
        if (hasQuestion) {
            if (mentionsTime) {
                return isRu 
                    ? ['Р вЂќР В°Р Р†Р В°Р в„– Р Р† 18:00? СЂСџвЂўвЂў', 'Р СљР С•Р В¶Р ВµРЎвЂљ Р Р† 19:00? РІРЏВ°', 'Р С™Р В°Р С” РЎвЂљР ВµР В±Р Вµ 17:30? СЂСџвЂўВ '][Math.floor(Math.random() * 3)]
                    : ['How about 6 PM? СЂСџвЂўвЂў', 'Maybe 7 PM? РІРЏВ°', 'What about 5:30? СЂСџвЂўВ '][Math.floor(Math.random() * 3)];
            }
            if (mentionsPlace) {
                return isRu 
                    ? ['Р вЂќР В°Р Р†Р В°Р в„– Р Р† РЎвЂ Р ВµР Р…РЎвЂљРЎР‚Р Вµ? СЂСџвЂњРЊ', 'Р СљР С•Р В¶Р ВµРЎвЂљ Р Р† Р С—Р В°РЎР‚Р С”Р Вµ? СЂСџРЉС–', 'Р С™Р В°Р С” Р Р…Р В°РЎРѓРЎвЂЎРЎвЂРЎвЂљ Р С”Р В°РЎвЂћР Вµ? РІВвЂў'][Math.floor(Math.random() * 3)]
                    : ['How about downtown? СЂСџвЂњРЊ', 'Maybe the park? СЂСџРЉС–', 'What about a cafe? РІВвЂў'][Math.floor(Math.random() * 3)];
            }
            if (mentionsFood) {
                return isRu 
                    ? ['Р вЂќР В°Р Р†Р В°Р в„– Р С—Р С‘РЎвЂ РЎвЂ РЎС“? СЂСџРЊвЂў', 'Р СљР С•Р В¶Р ВµРЎвЂљ РЎРѓРЎС“РЎв‚¬Р С‘? СЂСџРЊР€', 'Р С™Р В°Р С” Р Р…Р В°РЎРѓРЎвЂЎРЎвЂРЎвЂљ Р В±РЎС“РЎР‚Р С–Р ВµРЎР‚Р С•Р Р†? СЂСџРЊвЂќ'][Math.floor(Math.random() * 3)]
                    : ['How about pizza? СЂСџРЊвЂў', 'Maybe sushi? СЂСџРЊР€', 'What about burgers? СЂСџРЊвЂќ'][Math.floor(Math.random() * 3)];
            }
            return isRu 
                ? ['Р вЂќР В°, Р С”Р С•Р Р…Р ВµРЎвЂЎР Р…Р С•! СЂСџвЂРЊ', 'Р вЂќРЎС“Р СР В°РЎР‹ Р Т‘Р В° СЂСџВР‰', 'Р СџР С•РЎвЂЎР ВµР СРЎС“ Р В±РЎвЂ№ Р С‘ Р Р…Р ВµРЎвЂљ? СЂСџВ¤вЂќ', 'Р ТђР С•РЎР‚Р С•РЎв‚¬Р В°РЎРЏ Р С‘Р Т‘Р ВµРЎРЏ! СЂСџвЂ™РЋ'][Math.floor(Math.random() * 4)]
                : ['Yes, sure! СЂСџвЂРЊ', 'I think so СЂСџВР‰', 'Why not? СЂСџВ¤вЂќ', 'Good idea! СЂСџвЂ™РЋ'][Math.floor(Math.random() * 4)];
        }
        
        if (isPositive) {
            return isRu 
                ? ['Р В Р В°Р Т‘ РЎРЊРЎвЂљР С• РЎРѓР В»РЎвЂ№РЎв‚¬Р В°РЎвЂљРЎРЉ! СЂСџВР‰', 'Р РЋРЎС“Р С—Р ВµРЎР‚! СЂСџР‹вЂ°', 'Р С›РЎвЂљР В»Р С‘РЎвЂЎР Р…Р С•! СЂСџвЂРЊ', 'Р С™Р В»Р В°РЎРѓРЎРѓ! СЂСџвЂќТђ'][Math.floor(Math.random() * 4)]
                : ['Glad to hear! СЂСџВР‰', 'Awesome! СЂСџР‹вЂ°', 'Great! СЂСџвЂРЊ', 'Cool! СЂСџвЂќТђ'][Math.floor(Math.random() * 4)];
        }
        
        if (isNegative) {
            return isRu 
                ? ['Р вЂ™РЎРѓРЎвЂ Р В±РЎС“Р Т‘Р ВµРЎвЂљ РЎвЂ¦Р С•РЎР‚Р С•РЎв‚¬Р С•! СЂСџвЂ™Р„', 'Р вЂќР ВµРЎР‚Р В¶Р С‘РЎРѓРЎРЉ! СЂСџВ¤вЂ”', 'Р Р‡ РЎР‚РЎРЏР Т‘Р С•Р С СЂСџвЂ™в„ў', 'Р СљР С•Р С–РЎС“ РЎвЂЎР ВµР С-РЎвЂљР С• Р С—Р С•Р СР С•РЎвЂЎРЎРЉ? СЂСџВ¤вЂќ'][Math.floor(Math.random() * 4)]
                : ['It will be okay! СЂСџвЂ™Р„', 'Hang in there! СЂСџВ¤вЂ”', 'I\'m here for you СЂСџвЂ™в„ў', 'Can I help? СЂСџВ¤вЂќ'][Math.floor(Math.random() * 4)];
        }
        
        if (isShort && hasEmoji) {
            return isRu ? ['СЂСџВР‰', 'СЂСџвЂРЊ', 'РІСњВ¤РїС‘РЏ', 'СЂСџвЂќТђ'][Math.floor(Math.random() * 4)] : ['СЂСџВР‰', 'СЂСџвЂРЊ', 'РІСњВ¤РїС‘РЏ', 'СЂСџвЂќТђ'][Math.floor(Math.random() * 4)];
        }
        
        return isRu 
            ? ['Р СџР С•Р Р…РЎРЏР В» РЎвЂљР ВµР В±РЎРЏ! СЂСџвЂРЊ', 'Р ВР Р…РЎвЂљР ВµРЎР‚Р ВµРЎРѓР Р…Р С• РЎР‚Р В°РЎРѓРЎРѓР С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµРЎв‚¬РЎРЉ! СЂСџВР‰', 'Р РЋР С•Р С–Р В»Р В°РЎРѓР ВµР Р…! СЂСџвЂРЉ', 'Р вЂ”Р Р†РЎС“РЎвЂЎР С‘РЎвЂљ РЎвЂ¦Р С•РЎР‚Р С•РЎв‚¬Р С•! СЂСџв„ўРЉ'][Math.floor(Math.random() * 4)]
            : ['Got it! СЂСџвЂРЊ', 'Interesting! СЂСџВР‰', 'I agree! СЂСџвЂРЉ', 'Sounds good! СЂСџв„ўРЉ'][Math.floor(Math.random() * 4)];
    }
    
    // Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р С‘Р Вµ РЎвЂљР ВµР С”РЎРѓРЎвЂљР В° РЎвЂЎР ВµРЎР‚Р ВµР В· AI
    async function improveText(text) {
        const isRu = currentLang === 'ru';
        
        const systemPrompt = isRu 
            ? `Р Р€Р В»РЎС“РЎвЂЎРЎв‚¬Р С‘ РЎвЂљР ВµР С”РЎРѓРЎвЂљ: Р С‘РЎРѓР С—РЎР‚Р В°Р Р†РЎРЉ Р С–РЎР‚Р В°Р СР СР В°РЎвЂљР С‘Р С”РЎС“, Р С—РЎС“Р Р…Р С”РЎвЂљРЎС“Р В°РЎвЂ Р С‘РЎР‹, РЎРѓР Т‘Р ВµР В»Р В°Р в„– Р ВµР С–Р С• Р В±Р С•Р В»Р ВµР Вµ Р С–РЎР‚Р В°Р СР С•РЎвЂљР Р…РЎвЂ№Р С Р С‘ РЎвЂЎР С‘РЎвЂљР В°Р ВµР СРЎвЂ№Р С. Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р С‘ РЎРѓР СРЎвЂ№РЎРѓР В» Р С‘ РЎРѓРЎвЂљР С‘Р В»РЎРЉ. Р вЂ™Р ВµРЎР‚Р Р…Р С‘ РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎС“Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р в„– РЎвЂљР ВµР С”РЎРѓРЎвЂљ Р В±Р ВµР В· Р С—Р С•РЎРЏРЎРѓР Р…Р ВµР Р…Р С‘Р в„–.`
            : `Improve the text: fix grammar, punctuation, make it more literate and readable. Keep the meaning and style. Return only the improved text without explanations.`;
        
        return await callGroqAI([{ role: 'user', content: text }], systemPrompt);
    }
    
    // Р РЋРЎС“Р СР СР В°РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ РЎвЂЎР В°РЎвЂљР В° РЎвЂЎР ВµРЎР‚Р ВµР В· AI
    async function summarizeChat(messages) {
        const isRu = currentLang === 'ru';
        
        const systemPrompt = isRu 
            ? `Р С™РЎР‚Р В°РЎвЂљР С”Р С• Р С—Р С•Р Т‘Р Р†Р ВµР Т‘Р С‘ Р С‘РЎвЂљР С•Р С– РЎР‚Р В°Р В·Р С–Р С•Р Р†Р С•РЎР‚Р В°. Р Р€Р С”Р В°Р В¶Р С‘ Р С•РЎРѓР Р…Р С•Р Р†Р Р…РЎвЂ№Р Вµ РЎвЂљР ВµР СРЎвЂ№, Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ Р С‘ Р С”Р В»РЎР‹РЎвЂЎР ВµР Р†РЎвЂ№Р Вµ Р СР С•Р СР ВµР Р…РЎвЂљРЎвЂ№. Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р в„– РЎРЊР СР С•Р Т‘Р В·Р С‘. Р В¤Р С•РЎР‚Р СР В°РЎвЂљ: Р С”РЎР‚Р В°РЎвЂљР С”Р С‘Р в„– РЎРѓР С—Р С‘РЎРѓР С•Р С” РЎРѓ Р В±РЎС“Р В»Р В»Р ВµРЎвЂљР В°Р СР С‘.`
            : `Briefly summarize the conversation. Mention main topics, mood and key points. Use emojis. Format: short bullet list.`;
        
        const chatText = messages.map(m => `${m.role === 'user' ? 'Р Р‡' : 'Р РЋР С•Р В±Р ВµРЎРѓР ВµР Т‘Р Р…Р С‘Р С”'}: ${m.content}`).join('\n');
        
        try {
            return await callGroqAI([{ role: 'user', content: chatText }], systemPrompt);
        } catch (err) {
            return generateLocalSummary(messages, isRu);
        }
    }
    
    // Р вЂєР С•Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ РЎРѓРЎС“Р СР СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Р Т‘Р В»РЎРЏ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р В°
    function generateLocalSummary(messages, isRu) {
        const allText = messages.map(m => m.content).join(' ').toLowerCase();
        const msgCount = messages.length;
        
        // Р С’Р Р…Р В°Р В»Р С‘Р В·Р С‘РЎР‚РЎС“Р ВµР С РЎвЂљР ВµР СРЎвЂ№
        const topics = [];
        if (/Р Р†РЎРѓРЎвЂљРЎР‚Р ВµРЎвЂЎ|Р С—Р В»Р В°Р Р…|Р В·Р В°Р Р†РЎвЂљРЎР‚Р В°|РЎРѓР ВµР С–Р С•Р Т‘Р Р…РЎРЏ|meet|plan|tomorrow|today/i.test(allText)) {
            topics.push(isRu ? 'СЂСџвЂњвЂ¦ Р СџР В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Р Р†РЎРѓРЎвЂљРЎР‚Р ВµРЎвЂЎР С‘' : 'СЂСџвЂњвЂ¦ Meeting planning');
        }
        if (/РЎР‚Р В°Р В±Р С•РЎвЂљ|Р С—РЎР‚Р С•Р ВµР С”РЎвЂљ|Р В·Р В°Р Т‘Р В°РЎвЂЎ|work|project|task/i.test(allText)) {
            topics.push(isRu ? 'СЂСџвЂ™С Р В Р В°Р В±Р С•РЎвЂЎР С‘Р Вµ Р Р†Р С•Р С—РЎР‚Р С•РЎРѓРЎвЂ№' : 'СЂСџвЂ™С Work matters');
        }
        if (/Р ВµР Т‘Р В°|Р ВµРЎРѓРЎвЂљРЎРЉ|РЎР‚Р ВµРЎРѓРЎвЂљР С•РЎР‚Р В°Р Р…|Р С”Р В°РЎвЂћР Вµ|food|eat|restaurant|cafe/i.test(allText)) {
            topics.push(isRu ? 'СЂСџРЊР…РїС‘РЏ Р вЂўР Т‘Р В°' : 'СЂСџРЊР…РїС‘РЏ Food');
        }
        if (/РЎвЂћР С‘Р В»РЎРЉР С|Р С”Р С‘Р Р…Р С•|РЎРѓР ВµРЎР‚Р С‘Р В°Р В»|movie|film|series/i.test(allText)) {
            topics.push(isRu ? 'СЂСџР‹В¬ Р С™Р С‘Р Р…Р С•/РЎРѓР ВµРЎР‚Р С‘Р В°Р В»РЎвЂ№' : 'СЂСџР‹В¬ Movies/series');
        }
        if (/Р С‘Р С–РЎР‚|game|play/i.test(allText)) {
            topics.push(isRu ? 'СЂСџР‹В® Р ВР С–РЎР‚РЎвЂ№' : 'СЂСџР‹В® Games');
        }
        if (/Р В»РЎР‹Р В±|love|РІСњВ¤|СЂСџВРЊ/i.test(allText)) {
            topics.push(isRu ? 'РІСњВ¤РїС‘РЏ Р вЂєР С‘РЎвЂЎР Р…Р С•Р Вµ' : 'РІСњВ¤РїС‘РЏ Personal');
        }
        
        if (topics.length === 0) {
            topics.push(isRu ? 'СЂСџвЂ™В¬ Р С›Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ' : 'СЂСџвЂ™В¬ Chatting');
        }
        
        // Р С’Р Р…Р В°Р В»Р С‘Р В·Р С‘РЎР‚РЎС“Р ВµР С Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ
        const positiveWords = (allText.match(/РЎвЂ¦Р С•РЎР‚Р С•РЎв‚¬|Р С•РЎвЂљР В»Р С‘РЎвЂЎР Р…Р С•|Р С”РЎР‚РЎС“РЎвЂљР С•|РЎРѓРЎС“Р С—Р ВµРЎР‚|Р С”Р В»Р В°РЎРѓРЎРѓ|РЎР‚Р В°Р Т‘|good|great|awesome|cool|happy|nice/gi) || []).length;
        const negativeWords = (allText.match(/Р С—Р В»Р С•РЎвЂ¦|Р С–РЎР‚РЎС“РЎРѓРЎвЂљР Р…|РЎС“РЎРѓРЎвЂљР В°Р В»|Р Р…Р В°Р Т‘Р С•Р ВµР В»|Р В·Р В»Р С•Р в„–|bad|sad|tired|angry|bored/gi) || []).length;
        
        let mood;
        if (positiveWords > negativeWords + 2) {
            mood = isRu ? 'СЂСџВР‰ Р СџР С•Р В·Р С‘РЎвЂљР С‘Р Р†Р Р…Р С•Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ' : 'СЂСџВР‰ Positive mood';
        } else if (negativeWords > positiveWords + 2) {
            mood = isRu ? 'СЂСџВвЂќ Р вЂњРЎР‚РЎС“РЎРѓРЎвЂљР Р…Р С•Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ' : 'СЂСџВвЂќ Sad mood';
        } else {
            mood = isRu ? 'СЂСџВС’ Р СњР ВµР в„–РЎвЂљРЎР‚Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ' : 'СЂСџВС’ Neutral mood';
        }
        
        // Р В¤Р С•РЎР‚Р СР С‘РЎР‚РЎС“Р ВµР С Р С‘РЎвЂљР С•Р С–
        let summary = isRu ? 'СЂСџвЂњСњ **Р ВРЎвЂљР С•Р С– РЎР‚Р В°Р В·Р С–Р С•Р Р†Р С•РЎР‚Р В°:**\n\n' : 'СЂСџвЂњСњ **Conversation summary:**\n\n';
        summary += isRu ? `СЂСџвЂњР‰ Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–: ${msgCount}\n\n` : `СЂСџвЂњР‰ Messages: ${msgCount}\n\n`;
        summary += isRu ? '**Р СћР ВµР СРЎвЂ№:**\n' : '**Topics:**\n';
        summary += topics.map(t => `РІР‚Сћ ${t}`).join('\n');
        summary += '\n\n';
        summary += isRu ? '**Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ:**\n' : '**Mood:**\n';
        summary += `РІР‚Сћ ${mood}`;
        
        return summary;
    }
    
    // Р СџР ВµРЎР‚Р ВµР Р†Р С•Р Т‘ РЎвЂљР ВµР С”РЎРѓРЎвЂљР В° РЎвЂЎР ВµРЎР‚Р ВµР В· AI
    async function translateText(text) {
        const ruChars = (text.match(/[Р В°-РЎРЏРЎвЂ]/gi) || []).length;
        const enChars = (text.match(/[a-z]/gi) || []).length;
        const isRussian = ruChars > enChars;
        
        const targetLang = isRussian ? 'Р В°Р Р…Р С–Р В»Р С‘Р в„–РЎРѓР С”Р С‘Р в„–' : 'РЎР‚РЎС“РЎРѓРЎРѓР С”Р С‘Р в„–';
        const systemPrompt = `Р СџР ВµРЎР‚Р ВµР Р†Р ВµР Т‘Р С‘ РЎвЂљР ВµР С”РЎРѓРЎвЂљ Р Р…Р В° ${targetLang}. Р вЂ™Р ВµРЎР‚Р Р…Р С‘ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С—Р ВµРЎР‚Р ВµР Р†Р С•Р Т‘ Р В±Р ВµР В· Р С—Р С•РЎРЏРЎРѓР Р…Р ВµР Р…Р С‘Р в„–.`;
        
        return await callGroqAI([{ role: 'user', content: text }], systemPrompt);
    }
    
    function showAILoading() {
        document.getElementById('ai-options').classList.add('hidden');
        document.getElementById('ai-loading').classList.remove('hidden');
        document.getElementById('ai-result').classList.add('hidden');
        document.getElementById('ai-result-actions').classList.add('hidden');
    }
    
    function showAIResult(text) {
        aiResult = text;
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.remove('hidden');
        document.getElementById('ai-result').innerText = text;
        document.getElementById('ai-result-actions').classList.remove('hidden');
    }
    
    function showAIError(error) {
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.remove('hidden');
        document.getElementById('ai-result').innerText = `РІСњРЉ Р С›РЎв‚¬Р С‘Р В±Р С”Р В°: ${error}`;
        document.getElementById('ai-options').classList.remove('hidden');
    }
    
    function getLastMessages(count = 10) {
        const container = document.getElementById('messages-container');
        const messages = [];
        const bubbles = container.querySelectorAll('.message-bubble');
        
        Array.from(bubbles).slice(-count).forEach(bubble => {
            const text = bubble.querySelector('p')?.innerText || '';
            const isSent = bubble.classList.contains('sent');
            if (text && !text.includes('Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С•')) {
                messages.push({ role: isSent ? 'user' : 'assistant', content: text });
            }
        });
        return messages;
    }
    
    window.aiGenerateReply = async () => {
        const msgs = getLastMessages(5);
        if (msgs.length === 0) { alert(t('aiNoMessages')); return; }
        
        showAILoading();
        try {
            const result = await generateSmartReply(msgs);
            showAIResult(result);
        } catch (err) {
            showAIError(err.message);
        }
    };
    
    window.aiImproveText = async () => {
        const text = document.getElementById('msg-input').value.trim();
        if (!text) { alert(t('aiEnterText')); return; }
        
        showAILoading();
        try {
            const result = await improveText(text);
            showAIResult(result);
        } catch (err) {
            showAIError(err.message);
        }
    };
    
    window.aiSummarize = async () => {
        const msgs = getLastMessages(20);
        if (msgs.length < 2) { alert(t('aiNoMessages')); return; }
        
        showAILoading();
        try {
            const result = await summarizeChat(msgs);
            showAIResult(result);
        } catch (err) {
            showAIError(err.message);
        }
    };
    
    window.aiTranslate = async () => {
        let text = document.getElementById('msg-input').value.trim();
        if (!text) {
            const last = getLastMessages(5).filter(m => m.role === 'assistant').pop();
            if (last) text = last.content;
        }
        if (!text) { alert(t('aiEnterText')); return; }
        
        showAILoading();
        try {
            const result = await translateText(text);
            showAIResult(result);
        } catch (err) {
            showAIError(err.message);
        }
    };
    
    window.aiUseResult = () => {
        const mobileInput = document.getElementById('msg-input');
        const desktopInput = document.getElementById('msg-input-desktop');
        const isMobile = window.innerWidth <= 768;
        
        if (mobileInput) mobileInput.value = aiResult;
        if (desktopInput) desktopInput.value = aiResult;
        
        if (isMobile && mobileInput) {
            mobileInput.focus();
        } else if (desktopInput) {
            desktopInput.focus();
        }
        handleInputChange();
        toggleAI();
    };
    
    window.aiCopyResult = () => {
        navigator.clipboard.writeText(aiResult).then(() => alert(t('aiCopied')));
    };


    // ========== Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ ==========
    let mediaRecorder = null;
    let audioChunks = [];
    let voiceTimerInterval = null;
    let voiceStartTime = null;
    let isRecording = false;

    window.startVoice = async () => {
        if (isRecording || !activeChatPartner) return;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };
            
            mediaRecorder.onstop = async () => {
                stream.getTracks().forEach(track => track.stop());
                
                if (audioChunks.length > 0 && isRecording) {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎР‚Р В°Р В·Р СР ВµРЎР‚ (Р В»Р С‘Р СР С‘РЎвЂљ 1MB)
                    if (audioBlob.size > 1 * 1024 * 1024) {
                        alert('Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С Р Т‘Р В»Р С‘Р Р…Р Р…Р С•Р Вµ (Р СР В°Р С”РЎРѓ ~1 Р СР С‘Р Р…РЎС“РЎвЂљР В°)');
                        resetVoiceUI();
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = () => {
                        const duration = Math.floor((Date.now() - voiceStartTime) / 1000);
                        sendMsg({ 
                            type: 'voice', 
                            voiceData: reader.result,
                            voiceDuration: duration
                        });
                    };
                    reader.readAsDataURL(audioBlob);
                }
                
                resetVoiceUI();
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile - Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С overlay
                const mobileVoiceUI = document.getElementById('mobile-voice-ui');
                if (mobileVoiceUI) {
                    mobileVoiceUI.style.display = 'flex';
                }
            } else {
                // Desktop UI
                const voiceBtn = document.getElementById('voice-btn');
                if (voiceBtn) voiceBtn.classList.add('recording');
                document.getElementById('msg-input').classList.add('hidden');
                document.getElementById('voice-recording-ui').classList.remove('hidden');
            }
            
            voiceStartTime = Date.now();
            voiceTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - voiceStartTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                const desktopTimer = document.getElementById('voice-timer');
                const mobileTimer = document.getElementById('mobile-voice-timer');
                if (desktopTimer) desktopTimer.innerText = timeStr;
                if (mobileTimer) mobileTimer.innerText = timeStr;
            }, 1000);
            
        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С—Р С‘РЎРѓР С‘:', err);
            alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…РЎС“');
        }
    };

    window.stopVoice = () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    };

    window.cancelVoice = () => {
        isRecording = false;
        audioChunks = [];
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        resetVoiceUI();
    };

    function resetVoiceUI() {
        isRecording = false;
        
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // Mobile - Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С overlay
            const mobileVoiceUI = document.getElementById('mobile-voice-ui');
            if (mobileVoiceUI) {
                mobileVoiceUI.style.display = 'none';
            }
            const mobileTimer = document.getElementById('mobile-voice-timer');
            if (mobileTimer) mobileTimer.innerText = '0:00';
        } else {
            // Desktop UI
            const voiceBtn = document.getElementById('voice-btn');
            if (voiceBtn) voiceBtn.classList.remove('recording');
            const msgInput = document.getElementById('msg-input');
            if (msgInput) msgInput.classList.remove('hidden');
            const voiceUI = document.getElementById('voice-recording-ui');
            if (voiceUI) voiceUI.classList.add('hidden');
            const voiceTimer = document.getElementById('voice-timer');
            if (voiceTimer) voiceTimer.innerText = '0:00';
        }
        
        if (voiceTimerInterval) {
            clearInterval(voiceTimerInterval);
            voiceTimerInterval = null;
        }
    }

    // ========== Р В Р В°РЎРѓРЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р С”Р В° Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– ==========
    window.transcribeVoice = async (btn, voiceData, msgId) => {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С”РЎС“ Web Speech API
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            showToast('Р вЂРЎР‚Р В°РЎС“Р В·Р ВµРЎР‚ Р Р…Р Вµ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р ВµРЎвЂљ РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р†Р В°Р Р…Р С‘Р Вµ РЎР‚Р ВµРЎвЂЎР С‘', 'РІСњРЉ');
            return;
        }
        
        btn.classList.add('loading');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р В°РЎС“Р Т‘Р С‘Р С• РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљ Р Т‘Р В»РЎРЏ Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘РЎРЏ
            const audio = new Audio(voiceData);
            
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎР‚Р ВµРЎвЂЎР С‘
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = true;
            recognition.interimResults = false;
            
            let transcript = '';
            
            recognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript + ' ';
                    }
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    showTranscript(btn, msgId, '(Р В Р ВµРЎвЂЎРЎРЉ Р Р…Р Вµ РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р…Р В°)');
                } else {
                    showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р†Р В°Р Р…Р С‘РЎРЏ', 'РІСњРЉ');
                    btn.classList.remove('loading');
                    btn.innerHTML = '<i class="fas fa-file-alt"></i>';
                }
            };
            
            recognition.onend = () => {
                audio.pause();
                if (transcript.trim()) {
                    showTranscript(btn, msgId, transcript.trim());
                } else {
                    showTranscript(btn, msgId, '(Р В Р ВµРЎвЂЎРЎРЉ Р Р…Р Вµ РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р…Р В°)');
                }
            };
            
            // Р вЂ™Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р С•Р Т‘Р С‘Р С Р В°РЎС“Р Т‘Р С‘Р С• Р С‘ Р В·Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р†Р В°Р Р…Р С‘Р Вµ
            // Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С AudioContext Р Т‘Р В»РЎРЏ Р В·Р В°РЎвЂ¦Р Р†Р В°РЎвЂљР В° Р В·Р Р†РЎС“Р С”Р В°
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Р СњР В°РЎвЂЎР С‘Р Р…Р В°Р ВµР С РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р†Р В°Р Р…Р С‘Р Вµ
            recognition.start();
            
            // Р вЂ™Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р С•Р Т‘Р С‘Р С Р В°РЎС“Р Т‘Р С‘Р С• РЎвЂЎР ВµРЎР‚Р ВµР В· Р Т‘Р С‘Р Р…Р В°Р СР С‘Р С” (РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р†Р В°Р Р…Р С‘Р Вµ РЎРѓР В»РЎС“РЎв‚¬Р В°Р ВµРЎвЂљ Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…)
            // Р вЂќР В»РЎРЏ Р В»РЎС“РЎвЂЎРЎв‚¬Р ВµР С–Р С• РЎР‚Р ВµР В·РЎС“Р В»РЎРЉРЎвЂљР В°РЎвЂљР В° - Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂЎРЎвЂљР С• Р С‘Р Т‘РЎвЂРЎвЂљ Р С•Р В±РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р В°
            // Р С‘ РЎвЂЎР ВµРЎР‚Р ВµР В· 3 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘РЎвЂ№ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎР‚Р ВµР В·РЎС“Р В»РЎРЉРЎвЂљР В°РЎвЂљ
            
            audio.play();
            
            // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С РЎР‚Р В°РЎРѓР С—Р С•Р В·Р Р…Р В°Р Р†Р В°Р Р…Р С‘Р Вµ Р С”Р С•Р С–Р Т‘Р В° Р В°РЎС“Р Т‘Р С‘Р С• Р В·Р В°Р С”Р С•Р Р…РЎвЂЎР С‘РЎвЂљРЎРѓРЎРЏ
            audio.onended = () => {
                setTimeout(() => {
                    recognition.stop();
                }, 500);
            };
            
            // Р СћР В°Р в„–Р СР В°РЎС“РЎвЂљ Р Р…Р В° РЎРѓР В»РЎС“РЎвЂЎР В°Р в„– Р ВµРЎРѓР В»Р С‘ Р В°РЎС“Р Т‘Р С‘Р С• Р Р…Р Вµ Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р С•Р Т‘Р С‘РЎвЂљРЎРѓРЎРЏ
            setTimeout(() => {
                if (btn.classList.contains('loading')) {
                    recognition.stop();
                    audio.pause();
                }
            }, 30000);
            
        } catch (e) {
            console.error('Transcribe error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎР‚Р В°РЎРѓРЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р С”Р С‘', 'РІСњРЉ');
            btn.classList.remove('loading');
            btn.innerHTML = '<i class="fas fa-file-alt"></i>';
        }
    };
    
    function showTranscript(btn, msgId, text) {
        btn.classList.remove('loading');
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = 'rgba(34, 197, 94, 0.2)';
        btn.style.color = '#22c55e';
        btn.onclick = null;
        
        // Р СњР В°РЎвЂ¦Р С•Р Т‘Р С‘Р С Р С”Р С•Р Р…РЎвЂљР ВµР в„–Р Р…Р ВµРЎР‚ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р С•Р С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С‘ Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎР‚Р В°РЎРѓРЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р С”РЎС“
        const voiceMsg = btn.closest('.voice-message');
        if (voiceMsg) {
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎР‚РЎС“РЎР‹ РЎР‚Р В°РЎРѓРЎв‚¬Р С‘РЎвЂћРЎР‚Р С•Р Р†Р С”РЎС“ Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
            const oldTranscript = voiceMsg.parentElement.querySelector('.voice-transcript');
            if (oldTranscript) oldTranscript.remove();
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р…Р С•Р Р†РЎС“РЎР‹
            const transcriptDiv = document.createElement('div');
            transcriptDiv.className = 'voice-transcript';
            transcriptDiv.textContent = text;
            voiceMsg.parentElement.appendChild(transcriptDiv);
        }
    }

    // ========== Р вЂ™Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С”Р С‘ (Р С”Р В°Р С” Р Р† Telegram) ==========
    let videoCircleStream = null;
    let videoCircleRecorder = null;
    let videoCircleChunks = [];
    let videoCircleTimer = null;
    let videoCircleSeconds = 0;
    const MAX_VIDEO_CIRCLE_DURATION = 60; // Р СР В°Р С”РЎРѓР С‘Р СРЎС“Р С 60 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘

    window.openVideoCircle = async () => {
        if (!activeChatPartner) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ', 'РІСњРЉ');
            return;
        }

        try {
            // Р вЂ”Р В°Р С—РЎР‚Р В°РЎв‚¬Р С‘Р Р†Р В°Р ВµР С Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р С”Р В°Р СР ВµРЎР‚Р Вµ Р С‘ Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…РЎС“
            videoCircleStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: 480, height: 480 },
                audio: true
            });

            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р С•Р Р†Р ВµРЎР‚Р В»Р ВµР в„– Р Т‘Р В»РЎРЏ Р В·Р В°Р С—Р С‘РЎРѓР С‘
            const overlay = document.createElement('div');
            overlay.className = 'video-circle-overlay';
            overlay.id = 'video-circle-overlay';
            overlay.innerHTML = `
                <div class="video-circle-preview">
                    <video id="video-circle-preview" autoplay muted playsinline></video>
                    <div class="video-circle-timer">
                        <span id="video-circle-time">0:00</span> / 1:00
                    </div>
                </div>
                <p class="text-white mt-4 text-sm opacity-70">Р вЂ”Р В°Р С—Р С‘РЎРѓРЎРЉ Р Р…Р В°РЎвЂЎР Р…РЎвЂРЎвЂљРЎРѓРЎРЏ Р В°Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘</p>
                <div class="video-circle-controls">
                    <button class="video-circle-cancel" onclick="cancelVideoCircle()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="video-circle-send" onclick="sendVideoCircle()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);

            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С—РЎР‚Р ВµР Р†РЎРЉРЎР‹
            const preview = document.getElementById('video-circle-preview');
            preview.srcObject = videoCircleStream;

            // Р СњР В°РЎвЂЎР С‘Р Р…Р В°Р ВµР С Р В·Р В°Р С—Р С‘РЎРѓРЎРЉ
            videoCircleChunks = [];
            videoCircleRecorder = new MediaRecorder(videoCircleStream, {
                mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9') 
                    ? 'video/webm;codecs=vp9' 
                    : 'video/webm'
            });

            videoCircleRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    videoCircleChunks.push(e.data);
                }
            };

            videoCircleRecorder.start(100);

            // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎвЂљР В°Р в„–Р СР ВµРЎР‚
            videoCircleSeconds = 0;
            videoCircleTimer = setInterval(() => {
                videoCircleSeconds++;
                const mins = Math.floor(videoCircleSeconds / 60);
                const secs = videoCircleSeconds % 60;
                document.getElementById('video-circle-time').textContent = 
                    `${mins}:${secs.toString().padStart(2, '0')}`;

                // Р С’Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р С—Р С•РЎРѓР В»Р Вµ 60 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘
                if (videoCircleSeconds >= MAX_VIDEO_CIRCLE_DURATION) {
                    sendVideoCircle();
                }
            }, 1000);

        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р В° Р С” Р С”Р В°Р СР ВµРЎР‚Р Вµ:', err);
            showToast('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р С”Р В°Р СР ВµРЎР‚Р Вµ', 'РІСњРЉ');
        }
    };

    window.cancelVideoCircle = () => {
        cleanupVideoCircle();
        const overlay = document.getElementById('video-circle-overlay');
        if (overlay) overlay.remove();
    };

    let isSendingVideoCircle = false;

    window.sendVideoCircle = async () => {
        if (isSendingVideoCircle) return;
        isSendingVideoCircle = true;
        
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С РЎвЂљР В°Р в„–Р СР ВµРЎР‚
        if (videoCircleTimer) {
            clearInterval(videoCircleTimer);
            videoCircleTimer = null;
        }

        const duration = videoCircleSeconds;

        if (!videoCircleRecorder) {
            isSendingVideoCircle = false;
            cancelVideoCircle();
            return;
        }

        try {
            // Р РЋР СњР С’Р В§Р С’Р вЂєР С’ Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р В·Р В°Р С—Р С‘РЎРѓРЎРЉ Р С‘ Р В¶Р Т‘РЎвЂР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ (Р С—Р С•Р С”Р В° РЎРѓРЎвЂљРЎР‚Р С‘Р С Р ВµРЎвЂ°РЎвЂ Р В°Р С”РЎвЂљР С‘Р Р†Р ВµР Р…!)
            if (videoCircleRecorder.state === 'recording') {
                await new Promise((resolve) => {
                    videoCircleRecorder.onstop = resolve;
                    videoCircleRecorder.stop();
                });
            }

            // Р СћР ВµР С—Р ВµРЎР‚РЎРЉ Р В·Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С UI Р С‘ Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р С”Р В°Р СР ВµРЎР‚РЎС“
            const overlay = document.getElementById('video-circle-overlay');
            if (overlay) overlay.remove();
            
            if (videoCircleStream) {
                videoCircleStream.getTracks().forEach(track => track.stop());
                videoCircleStream = null;
            }

            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С blob
            const blob = new Blob(videoCircleChunks, { type: 'video/webm' });
            
            if (blob.size === 0) {
                showToast('Р вЂ™Р С‘Р Т‘Р ВµР С• Р С—РЎС“РЎРѓРЎвЂљР С•Р Вµ', 'РІСњРЉ');
                return;
            }
            
            if (blob.size > 4 * 1024 * 1024) {
                showToast('Р вЂ™Р С‘Р Т‘Р ВµР С• РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С Р В±Р С•Р В»РЎРЉРЎв‚¬Р С•Р Вµ', 'РІСњРЉ');
                return;
            }

            // Р С™Р С•Р Р…Р Р†Р ВµРЎР‚РЎвЂљР С‘РЎР‚РЎС“Р ВµР С Р Р† base64
            const base64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });

            // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
            const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), {
                type: 'video_circle',
                senderId: me.uid,
                senderName: me.username,
                videoData: base64,
                videoDuration: duration,
                timestamp: serverTimestamp()
            });

            // Р СњР В°РЎвЂЎР С‘РЎРѓР В»РЎРЏР ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№
            me.rubies = (me.rubies || 0) + RUBY_PER_MESSAGE;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: me.rubies
            }, { merge: true });
            updateRubiesDisplay();

            showToast('Р С™РЎР‚РЎС“Р В¶Р С•Р С” Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…!', 'СЂСџР‹Тђ');
        } catch (e) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р С‘ Р С”РЎР‚РЎС“Р В¶Р С”Р В°:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р С‘', 'РІСњРЉ');
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С UI Р С—РЎР‚Р С‘ Р С•РЎв‚¬Р С‘Р В±Р С”Р Вµ
            const overlay = document.getElementById('video-circle-overlay');
            if (overlay) overlay.remove();
        }
        
        isSendingVideoCircle = false;
        videoCircleRecorder = null;
        videoCircleChunks = [];
        videoCircleSeconds = 0;
    };

    function cleanupVideoCircle() {
        if (videoCircleTimer) {
            clearInterval(videoCircleTimer);
            videoCircleTimer = null;
        }
        if (videoCircleStream) {
            videoCircleStream.getTracks().forEach(track => track.stop());
            videoCircleStream = null;
        }
        if (videoCircleRecorder && videoCircleRecorder.state === 'recording') {
            videoCircleRecorder.stop();
        }
        videoCircleRecorder = null;
        videoCircleChunks = [];
        videoCircleSeconds = 0;
    }

    // Р вЂ™Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘Р Вµ Р Р†Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С”Р В°
    window.playVideoCircle = (videoEl) => {
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Р†РЎРѓР Вµ Р Т‘РЎР‚РЎС“Р С–Р С‘Р Вµ Р Р†Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С”Р С‘
        document.querySelectorAll('.video-circle-message video').forEach(v => {
            if (v !== videoEl) {
                v.pause();
                v.currentTime = 0;
            }
        });

        if (videoEl.paused) {
            videoEl.play();
            videoEl.style.border = '3px solid #22c55e';
        } else {
            videoEl.pause();
            videoEl.style.border = '3px solid var(--accent)';
        }
    };

    // ========== Р СџРЎР‚Р ВµР Т‘Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ РЎРѓРЎРѓРЎвЂ№Р В»Р С•Р С” ==========
    const linkPreviewCache = new Map();
    
    // Р ВР В·Р Р†Р В»Р ВµРЎвЂЎР ВµР Р…Р С‘Р Вµ URL Р С‘Р В· РЎвЂљР ВµР С”РЎРѓРЎвЂљР В°
    function extractUrls(text) {
        const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/gi;
        return text.match(urlRegex) || [];
    }
    
    // Р В­Р С”РЎР‚Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Р СџРЎР‚Р ВµР С•Р В±РЎР‚Р В°Р В·Р С•Р Р†Р В°Р Р…Р С‘Р Вµ URL Р Р† Р С”Р В»Р С‘Р С”Р В°Р В±Р ВµР В»РЎРЉР Р…РЎвЂ№Р Вµ РЎРѓРЎРѓРЎвЂ№Р В»Р С”Р С‘
    function linkifyText(text) {
        const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/gi;
        return text.replace(urlRegex, (url) => {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline" onclick="event.stopPropagation()">${url}</a>`;
        });
    }
    
    // Р СџР С•Р В»РЎС“РЎвЂЎР ВµР Р…Р С‘Р Вµ Р СР ВµРЎвЂљР В°Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦ РЎРѓРЎРѓРЎвЂ№Р В»Р С”Р С‘ РЎвЂЎР ВµРЎР‚Р ВµР В· Р С—РЎР‚Р С•Р С”РЎРѓР С‘
    async function fetchLinkPreview(url) {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С”РЎРЊРЎв‚¬
        if (linkPreviewCache.has(url)) {
            return linkPreviewCache.get(url);
        }
        
        // Р РЋР С—Р С‘РЎРѓР С•Р С” Р С—РЎР‚Р С•Р С”РЎРѓР С‘-РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚Р С•Р Р† Р Т‘Р В»РЎРЏ Р С•Р В±РЎвЂ¦Р С•Р Т‘Р В° CORS
        const proxyServers = [
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
            (u) => `https://proxy.cors.sh/${u}`,
        ];
        
        // Р вЂќР В»РЎРЏ YouTube Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С Р Р†РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р Р…РЎвЂ№Р в„– embed Р В±Р ВµР В· Р С—РЎР‚Р С•Р С”РЎРѓР С‘
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            const videoId = extractYouTubeId(url);
            if (videoId) {
                const preview = {
                    url: url,
                    title: 'YouTube Video',
                    description: '',
                    image: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
                    siteName: 'YouTube',
                    isYouTube: true,
                    videoId: videoId
                };
                linkPreviewCache.set(url, preview);
                return preview;
            }
        }
        
        // Р СџРЎР‚Р С•Р В±РЎС“Р ВµР С Р С”Р В°Р В¶Р Т‘РЎвЂ№Р в„– Р С—РЎР‚Р С•Р С”РЎРѓР С‘ Р С—Р С• Р С•РЎвЂЎР ВµРЎР‚Р ВµР Т‘Р С‘
        for (const getProxyUrl of proxyServers) {
            try {
                const proxyUrl = getProxyUrl(url);
                const response = await fetch(proxyUrl, { 
                    signal: AbortSignal.timeout(5000),
                    headers: {
                        'x-requested-with': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) continue;
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Р ВР В·Р Р†Р В»Р ВµР С”Р В°Р ВµР С Р СР ВµРЎвЂљР В°Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ
                const getMetaContent = (name) => {
                    const meta = doc.querySelector(`meta[property="${name}"], meta[name="${name}"]`);
                    return meta ? meta.getAttribute('content') : null;
                };
                
                const preview = {
                    url: url,
                    title: getMetaContent('og:title') || doc.querySelector('title')?.textContent || '',
                    description: getMetaContent('og:description') || getMetaContent('description') || '',
                    image: getMetaContent('og:image') || '',
                    siteName: getMetaContent('og:site_name') || new URL(url).hostname.replace('www.', '')
                };
                
                // Р ВРЎРѓР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р С•РЎвЂљР Р…Р С•РЎРѓР С‘РЎвЂљР ВµР В»РЎРЉР Р…РЎвЂ№Р Вµ URL Р С‘Р В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р в„–
                if (preview.image && !preview.image.startsWith('http')) {
                    const baseUrl = new URL(url);
                    preview.image = preview.image.startsWith('/') 
                        ? `${baseUrl.origin}${preview.image}`
                        : `${baseUrl.origin}/${preview.image}`;
                }
                
                // Р С™РЎРЊРЎв‚¬Р С‘РЎР‚РЎС“Р ВµР С РЎР‚Р ВµР В·РЎС“Р В»РЎРЉРЎвЂљР В°РЎвЂљ
                if (preview.title || preview.description) {
                    linkPreviewCache.set(url, preview);
                    return preview;
                }
            } catch (e) {
                console.log('Proxy failed, trying next...', e.message);
                continue;
            }
        }
        
        // Р вЂўРЎРѓР В»Р С‘ Р Р†РЎРѓР Вµ Р С—РЎР‚Р С•Р С”РЎРѓР С‘ Р Р…Р Вµ РЎРѓРЎР‚Р В°Р В±Р С•РЎвЂљР В°Р В»Р С‘ - Р Р†Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµР С Р В±Р В°Р В·Р С•Р Р†Р С•Р Вµ Р С—РЎР‚Р ВµР Р†РЎРЉРЎР‹
        const fallbackPreview = {
            url: url,
            title: '',
            description: '',
            image: '',
            siteName: new URL(url).hostname.replace('www.', '')
        };
        linkPreviewCache.set(url, fallbackPreview);
        return fallbackPreview;
    }
    
    // Р ВР В·Р Р†Р В»Р ВµРЎвЂЎР ВµР Р…Р С‘Р Вµ ID YouTube Р Р†Р С‘Р Т‘Р ВµР С•
    function extractYouTubeId(url) {
        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,
            /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/
        ];
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) return match[1];
        }
        return null;
    }
    
    // Р В Р ВµР Р…Р Т‘Р ВµРЎР‚Р С‘Р Р…Р С– Р С—РЎР‚Р ВµР Р†РЎРЉРЎР‹ РЎРѓРЎРѓРЎвЂ№Р В»Р С”Р С‘
    function renderLinkPreview(preview) {
        if (!preview) return '';
        
        // Р РЋР С—Р ВµРЎвЂ Р С‘Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– РЎР‚Р ВµР Р…Р Т‘Р ВµРЎР‚ Р Т‘Р В»РЎРЏ YouTube
        if (preview.isYouTube && preview.videoId) {
            return `
                <div class="link-preview youtube-preview" onclick="event.stopPropagation()">
                    <div class="youtube-embed-container">
                        <iframe 
                            src="https://www.youtube.com/embed/${preview.videoId}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            loading="lazy">
                        </iframe>
                    </div>
                    <div class="link-preview-site">
                        <i class="fab fa-youtube text-red-500"></i> YouTube
                    </div>
                </div>
            `;
        }
        
        if (!preview.title && !preview.description && !preview.image) return '';
        
        const imageHtml = preview.image 
            ? `<img src="${preview.image}" class="link-preview-image" onerror="this.style.display='none'" loading="lazy">` 
            : '';
        
        return `
            <div class="link-preview" onclick="window.open('${preview.url}', '_blank')">
                ${imageHtml}
                <div class="link-preview-site">${preview.siteName}</div>
                ${preview.title ? `<div class="link-preview-title">${preview.title}</div>` : ''}
                ${preview.description ? `<div class="link-preview-description">${preview.description}</div>` : ''}
            </div>
        `;
    }
    
    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р С—РЎР‚Р ВµР Р†РЎРЉРЎР‹ Р Т‘Р В»РЎРЏ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
    async function loadLinkPreviewForMessage(msgElement, text) {
        const urls = extractUrls(text);
        if (urls.length === 0) return;
        
        // Р вЂР ВµРЎР‚РЎвЂР С РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С—Р ВµРЎР‚Р Р†РЎС“РЎР‹ РЎРѓРЎРѓРЎвЂ№Р В»Р С”РЎС“
        const url = urls[0];
        const preview = await fetchLinkPreview(url);
        
        if (preview && msgElement) {
            const previewHtml = renderLinkPreview(preview);
            if (previewHtml) {
                const previewContainer = document.createElement('div');
                previewContainer.innerHTML = previewHtml;
                const textEl = msgElement.querySelector('p');
                if (textEl) {
                    textEl.insertAdjacentElement('afterend', previewContainer.firstElementChild);
                }
            }
        }
    }

    // Р вЂњР В»Р С•Р В±Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р С•Р В±РЎР‰Р ВµР С”РЎвЂљ Р Т‘Р В»РЎРЏ РЎС“Р С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘Р ВµР С
    let currentPlayingAudio = null;

    window.playVoice = (btn, audioData, duration) => {
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР Вµ Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘Р Вµ
        if (currentPlayingAudio) {
            currentPlayingAudio.pause();
            currentPlayingAudio.currentTime = 0;
            document.querySelectorAll('.voice-play-btn').forEach(b => {
                b.innerHTML = '<i class="fas fa-play"></i>';
            });
        }
        
        const audio = new Audio(audioData);
        const progressFill = btn.parentElement.querySelector('.voice-progress-fill');
        const timeDisplay = btn.parentElement.querySelector('.voice-time');
        
        if (currentPlayingAudio === audio) {
            currentPlayingAudio = null;
            return;
        }
        
        currentPlayingAudio = audio;
        btn.innerHTML = '<i class="fas fa-pause"></i>';
        
        audio.ontimeupdate = () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = progress + '%';
            const remaining = Math.ceil(audio.duration - audio.currentTime);
            timeDisplay.innerText = `0:${remaining.toString().padStart(2, '0')}`;
        };
        
        audio.onended = () => {
            btn.innerHTML = '<i class="fas fa-play"></i>';
            progressFill.style.width = '0%';
            timeDisplay.innerText = `0:${duration.toString().padStart(2, '0')}`;
            currentPlayingAudio = null;
        };
        
        audio.play();
    };

    window.handleNicknameSearch = async (val) => {
        console.log('Search called with:', val);
        val = val.trim().toLowerCase();
        const res = document.getElementById('nickname-search-results');
        if (val.length < 1) { res.classList.add('hidden'); return; }
        
        console.log('Searching for:', val);
        const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
        console.log('Found users:', snap.size);
        res.innerHTML = '';
        res.classList.remove('hidden');
        
        let found = false;
        snap.forEach(d => {
            const u = { uid: d.id, ...d.data() };
            // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…РЎвЂ№РЎвЂ¦ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„– Р С‘ РЎРѓР ВµР В±РЎРЏ
            if (u.deleted) return;
            if (u.username && u.username.toLowerCase().includes(val) && u.uid !== me?.uid) {
                found = true;
                const div = document.createElement('div');
                div.className = "p-4 hover:bg-indigo-500/10 cursor-pointer text-sm font-bold flex items-center justify-between group";
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg bg-indigo-500 text-white flex items-center justify-center">${u.username[0]}</div>
                        <span>@${u.username}</span>
                    </div>
                `;
                div.onclick = () => { 
                    selectChat(u); 
                    res.classList.add('hidden'); 
                    document.getElementById('search-input').value = ''; 
                };
                res.appendChild(div);
            }
        });
        
        // Р СџР С•Р С‘РЎРѓР С” Р С—РЎС“Р В±Р В»Р С‘РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ Р С”Р В°Р Р…Р В°Р В»Р С•Р Р†
        try {
            const channelsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'channels'));
            channelsSnap.forEach(d => {
                const channel = { id: d.id, ...d.data() };
                if (channel.type !== 'public') return;
                if (channel.name && channel.name.toLowerCase().includes(val)) {
                    found = true;
                    const div = document.createElement('div');
                    div.className = "p-4 hover:bg-purple-500/10 cursor-pointer text-sm font-bold flex items-center justify-between group";
                    div.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 text-white flex items-center justify-center">
                                <i class="fas fa-bullhorn text-xs"></i>
                            </div>
                            <div>
                                <span>${channel.name}</span>
                                <p class="text-[10px] text-slate-400 font-normal">${channel.subscriberCount || 1} Р С—Р С•Р Т‘Р С—Р С‘РЎРѓРЎвЂЎР С‘Р С”Р С•Р Р† РІР‚Сћ Р С™Р В°Р Р…Р В°Р В»</p>
                            </div>
                        </div>
                    `;
                    div.onclick = () => { 
                        selectChannel(channel); 
                        res.classList.add('hidden'); 
                        document.getElementById('search-input').value = ''; 
                    };
                    res.appendChild(div);
                }
            });
        } catch (e) {
            console.error('Error searching channels:', e);
        }
        
        if(!found) res.innerHTML = '<div class="p-4 text-center text-xs opacity-50 italic">Р СњР С‘Р С”РЎвЂљР С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…</div>';
    };

    // ==================== RESIZE SIDEBAR ====================
    (function initSidebarResize() {
        const sidebar = document.getElementById('sidebar');
        const handle = document.getElementById('sidebar-resize');
        if (!sidebar || !handle) return;
        
        let isResizing = false;
        let startX, startWidth;
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎС“РЎР‹ РЎв‚¬Р С‘РЎР‚Р С‘Р Р…РЎС“
        const savedWidth = localStorage.getItem('flickers-sidebar-width');
        if (savedWidth && window.innerWidth > 768) {
            sidebar.style.width = savedWidth + 'px';
        }
        
        handle.addEventListener('mousedown', (e) => {
            if (window.innerWidth <= 768) return; // Р СњР Вµ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
            isResizing = true;
            startX = e.clientX;
            startWidth = sidebar.offsetWidth;
            sidebar.classList.add('resizing');
            handle.classList.add('active');
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const diff = e.clientX - startX;
            let newWidth = startWidth + diff;
            
            // Р С›Р С–РЎР‚Р В°Р Р…Р С‘РЎвЂЎР ВµР Р…Р С‘РЎРЏ
            newWidth = Math.max(280, Math.min(500, newWidth));
            sidebar.style.width = newWidth + 'px';
        });
        
        document.addEventListener('mouseup', () => {
            if (!isResizing) return;
            isResizing = false;
            sidebar.classList.remove('resizing');
            handle.classList.remove('active');
            document.body.style.cursor = '';
            
            // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С РЎв‚¬Р С‘РЎР‚Р С‘Р Р…РЎС“
            localStorage.setItem('flickers-sidebar-width', sidebar.offsetWidth);
        });
    })();
    // ==================== END RESIZE SIDEBAR ====================

    // ========== Р СњР С›Р вЂ™Р С’Р Р‡ Р РЋР ВР РЋР СћР вЂўР СљР С’ Р СњР С’Р РЋР СћР В Р С›Р вЂўР С™ ==========
    
    let currentSettingsCategory = 'profile';
    
    window.toggleSettings = () => {
        const panel = document.getElementById('settings-panel');
        panel.classList.toggle('active');
        
        if (panel.classList.contains('active')) {
            loadSettingsCategory('profile');
            initSettingsCategoryButtons();
        }
    };
    
    // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ Р С”Р Р…Р С•Р С—Р С•Р С” Р С”Р В°РЎвЂљР ВµР С–Р С•РЎР‚Р С‘Р в„–
    function initSettingsCategoryButtons() {
        const buttons = document.querySelectorAll('.settings-category-btn');
        buttons.forEach(btn => {
            btn.onclick = () => {
                const category = btn.dataset.category;
                loadSettingsCategory(category);
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎС“РЎР‹ Р С”Р Р…Р С•Р С—Р С”РЎС“
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
        });
    }
    
    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р С”Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљР В° Р С”Р В°РЎвЂљР ВµР С–Р С•РЎР‚Р С‘Р С‘
    function loadSettingsCategory(category) {
        currentSettingsCategory = category;
        const container = document.getElementById('settings-content-container');
        
        switch(category) {
            case 'profile':
                container.innerHTML = getProfileSettings();
                break;
            case 'account':
                container.innerHTML = getAccountSettings();
                break;
            case 'privacy':
                container.innerHTML = getPrivacySettings();
                break;
            case 'appearance':
                container.innerHTML = getAppearanceSettings();
                break;
            case 'chat':
                container.innerHTML = getChatSettings();
                break;
            case 'notifications':
                container.innerHTML = getNotificationsSettings();
                break;
            case 'language':
                container.innerHTML = getLanguageSettings();
                break;
            case 'premium':
                container.innerHTML = getPremiumSettings();
                break;
            case 'shop':
                container.innerHTML = getShopSettings();
                break;
            case 'advanced':
                container.innerHTML = getAdvancedSettings();
                break;
        }
        
        // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р С‘РЎР‚РЎС“Р ВµР С РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘Р С‘ Р С—Р С•РЎРѓР В»Р Вµ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ Р С”Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљР В°
        initSettingsContent();
    }
    
    // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ Р С”Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљР В° Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С”
    function initSettingsContent() {
        if (me) {
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
            const usernameEl = document.getElementById('settings-username');
            if (usernameEl) usernameEl.innerText = '@' + me.username;
            
            updateSettingsAvatar();
            loadBio();
            loadProfileSettings();
            loadFrameAndStyleSettings();
        }
    }
    
    window.toggleSettings = () => {
        document.getElementById('settings-panel').classList.toggle('active');
        if (me) {
            document.getElementById('settings-username').innerText = '@' + me.username;
            updateSettingsAvatar();
            loadBio();
            loadProfileSettings();
            loadFrameAndStyleSettings();
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓР ВµР С”РЎвЂ Р С‘РЎР‹ Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘ Р Т‘Р В»РЎРЏ Premium Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
            const animatedSection = document.getElementById('animated-avatar-section');
            if (animatedSection) {
                animatedSection.classList.toggle('hidden', !hasPremium());
            }
        }
    };
    
    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р В±Р С‘Р С•
    async function loadBio() {
        if (!me) return;
        const bioInput = document.getElementById('settings-bio');
        const bioCounter = document.getElementById('bio-counter');
        if (!bioInput) return;
        
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
            if (userDoc.exists() && userDoc.data().bio) {
                bioInput.value = userDoc.data().bio;
                if (bioCounter) bioCounter.textContent = bioInput.value.length;
            }
        } catch (e) {}
        
        // Р РЋРЎвЂЎРЎвЂРЎвЂљРЎвЂЎР С‘Р С” РЎРѓР С‘Р СР Р†Р С•Р В»Р С•Р Р†
        bioInput.oninput = () => {
            if (bioCounter) bioCounter.textContent = bioInput.value.length;
        };
    }
    
    // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С‘Р Вµ Р В±Р С‘Р С•
    window.saveBio = async () => {
        if (!me) return;
        const bioInput = document.getElementById('settings-bio');
        if (!bioInput) return;
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                bio: bioInput.value.trim()
            }, { merge: true });
            showToast(currentLang === 'ru' ? 'Р С›Р С—Р С‘РЎРѓР В°Р Р…Р С‘Р Вµ РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С•' : 'Bio saved', 'РІСљвЂ¦');
        } catch (e) {
            console.error('Error saving bio:', e);
        }
    };
    
    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С” Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ (Р С—Р С•Р В», РЎРѓР С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ)
    async function loadProfileSettings() {
        if (!me) return;
        
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                
                // Р СџР С•Р В»
                document.querySelectorAll('[id^="gender-"]').forEach(btn => {
                    btn.classList.remove('bg-indigo-500', 'text-white', 'border-indigo-500');
                });
                if (data.gender) {
                    const genderBtn = document.getElementById('gender-' + data.gender);
                    if (genderBtn) {
                        genderBtn.classList.add('bg-indigo-500', 'text-white', 'border-indigo-500');
                    }
                }
                
                // Р РЋР С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ
                const hideToggle = document.getElementById('hide-profile-toggle');
                if (hideToggle) {
                    hideToggle.checked = data.profileHidden === true;
                }
            }
        } catch (e) {}
    }
    
    // Р Р€РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С”Р В° Р С—Р С•Р В»Р В°
    window.setGender = async (gender) => {
        if (!me) return;
        
        document.querySelectorAll('[id^="gender-"]').forEach(btn => {
            btn.classList.remove('bg-indigo-500', 'text-white', 'border-indigo-500');
        });
        document.getElementById('gender-' + gender)?.classList.add('bg-indigo-500', 'text-white', 'border-indigo-500');
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                gender: gender
            }, { merge: true });
            showToast(currentLang === 'ru' ? 'Р СџР С•Р В» РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…' : 'Gender saved', 'РІСљвЂ¦');
        } catch (e) {}
    };
    
    // Р РЋР С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ
    window.toggleHideProfile = async () => {
        if (!me) return;
        const hideToggle = document.getElementById('hide-profile-toggle');
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                profileHidden: hideToggle.checked
            }, { merge: true });
            showToast(hideToggle.checked ? 
                (currentLang === 'ru' ? 'Р СџРЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ РЎРѓР С”РЎР‚РЎвЂ№РЎвЂљ' : 'Profile hidden') : 
                (currentLang === 'ru' ? 'Р СџРЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ Р Р†Р С‘Р Т‘Р ВµР Р…' : 'Profile visible'), 'РІСљвЂ¦');
        } catch (e) {}
    };
    
    // Р В¦Р ВµР Р…РЎвЂ№ Р Р…Р В° РЎР‚Р В°Р СР С”Р С‘ Р С‘ РЎРѓРЎвЂљР С‘Р В»Р С‘
    const framePrices = {
        'none': 0,
        'rainbow': 50,
        'gold': 75,
        'neon': 100,
        'fire': 100,
        'purple': 75,
        'emerald': 75,
        'diamond': 150,
        'aurora': 0,
        'plasma': 0
    };
    
    const frameNames = {
        'none': 'Р вЂР ВµР В· РЎР‚Р В°Р СР С”Р С‘',
        'rainbow': 'Р В Р В°Р Т‘РЎС“Р В¶Р Р…Р В°РЎРЏ',
        'gold': 'Р вЂ”Р С•Р В»Р С•РЎвЂљР В°РЎРЏ',
        'neon': 'Р СњР ВµР С•Р Р…Р С•Р Р†Р В°РЎРЏ',
        'fire': 'Р С›Р С–Р Р…Р ВµР Р…Р Р…Р В°РЎРЏ',
        'purple': 'Р В¤Р С‘Р С•Р В»Р ВµРЎвЂљР С•Р Р†Р В°РЎРЏ',
        'emerald': 'Р ВР В·РЎС“Р СРЎР‚РЎС“Р Т‘Р Р…Р В°РЎРЏ',
        'diamond': 'Р вЂРЎР‚Р С‘Р В»Р В»Р С‘Р В°Р Р…РЎвЂљР С•Р Р†Р В°РЎРЏ',
        'aurora': 'Р С’Р Р†РЎР‚Р С•РЎР‚Р В°',
        'plasma': 'Р СџР В»Р В°Р В·Р СР В°'
    };
    
    // Premium-only РЎР‚Р В°Р СР С”Р С‘ (Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…РЎвЂ№, Р Р…Р С• РЎвЂљРЎР‚Р ВµР В±РЎС“РЎР‹РЎвЂљ Premium)
    const premiumOnlyFrames = ['aurora', 'plasma'];
    
    const stylePrices = {
        'default': 0,
        'gradient': 100,
        'neon': 150,
        'glass': 200,
        'aurora': 0,
        'fire': 0,
        'galaxy': 0,
        'gold': 0
    };
    
    const styleNames = {
        'default': 'Р РЋРЎвЂљР В°Р Р…Р Т‘Р В°РЎР‚РЎвЂљР Р…Р С•Р Вµ',
        'gradient': 'Р вЂњРЎР‚Р В°Р Т‘Р С‘Р ВµР Р…РЎвЂљ',
        'neon': 'Р СњР ВµР С•Р Р…',
        'glass': 'Р РЋРЎвЂљР ВµР С”Р В»Р С•',
        'aurora': 'Р С’Р Р†РЎР‚Р С•РЎР‚Р В°',
        'fire': 'Р С›Р С–Р С•Р Р…РЎРЉ',
        'galaxy': 'Р вЂњР В°Р В»Р В°Р С”РЎвЂљР С‘Р С”Р В°',
        'gold': 'Р вЂ”Р С•Р В»Р С•РЎвЂљР С•'
    };
    
    // Premium-only РЎРѓРЎвЂљР С‘Р В»Р С‘ (Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…РЎвЂ№, Р Р…Р С• РЎвЂљРЎР‚Р ВµР В±РЎС“РЎР‹РЎвЂљ Premium)
    const premiumOnlyStyles = ['aurora', 'fire', 'galaxy', 'gold'];
    
    // Р вЂ™РЎвЂ№Р В±Р С•РЎР‚ РЎР‚Р В°Р СР С”Р С‘ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р В°
    window.selectAvatarFrame = async (frame) => {
        if (!me) return;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Premium Р Т‘Р В»РЎРЏ РЎРЊР С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№РЎвЂ¦ РЎР‚Р В°Р СР С•Р С”
        if (premiumOnlyFrames.includes(frame)) {
            if (!hasPremium()) {
                showToast('Р В­РЎвЂљР В° РЎР‚Р В°Р СР С”Р В° Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…Р В° РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium! РІВ­С’', 'СЂСџвЂќвЂ™');
                return;
            }
            // Premium РЎР‚Р В°Р СР С”Р С‘ Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…РЎвЂ№ Р Т‘Р В»РЎРЏ Premium Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
            me.avatarFrame = frame;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                avatarFrame: frame
            }, { merge: true });
            
            window.updateFrameSelection(frame);
            window.applyAvatarFrame();
            showToast(`Р В Р В°Р СР С”Р В°: ${frameNames[frame]}`, 'РІСљвЂ¦');
            return;
        }
        
        const price = framePrices[frame] || 0;
        const currentRubies = me.rubies || 0;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р С”РЎС“Р С—Р В»Р ВµР Р…Р В° Р В»Р С‘ РЎС“Р В¶Р Вµ РЎР‚Р В°Р СР С”Р В°
        const ownedFrames = me.ownedFrames || ['none'];
        
        if (!ownedFrames.includes(frame)) {
            // Р СњРЎС“Р В¶Р Р…Р С• Р С”РЎС“Р С—Р С‘РЎвЂљРЎРЉ
            if (currentRubies < price) {
                showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${price}СЂСџвЂ™Р‹`, 'РІСњРЉ');
                return;
            }
            
            // Р РЋР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р С‘ Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎР‚Р В°Р СР С”РЎС“
            ownedFrames.push(frame);
            me.rubies = currentRubies - price;
            me.ownedFrames = ownedFrames;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: me.rubies,
                ownedFrames: ownedFrames,
                avatarFrame: frame
            }, { merge: true });
            
            updateRubiesDisplay();
            showToast(`Р В Р В°Р СР С”Р В° "${frameNames[frame]}" Р С”РЎС“Р С—Р В»Р ВµР Р…Р В° Р В·Р В° ${price}СЂСџвЂ™Р‹!`, 'СЂСџР‹вЂ°');
        } else {
            // Р Р€Р В¶Р Вµ Р С”РЎС“Р С—Р В»Р ВµР Р…Р В° - Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р Р†РЎвЂ№Р В±Р С‘РЎР‚Р В°Р ВµР С
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                avatarFrame: frame
            }, { merge: true });
        }
        
        me.avatarFrame = frame;
        window.updateFrameSelection(frame);
        window.applyAvatarFrame();
        showToast(`Р В Р В°Р СР С”Р В°: ${frameNames[frame]}`, 'РІСљвЂ¦');
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р Вµ UI Р Р†РЎвЂ№Р В±Р С•РЎР‚Р В° РЎР‚Р В°Р СР С”Р С‘
    window.updateFrameSelection = function(frame) {
        document.querySelectorAll('.frame-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.frame === frame) {
                btn.classList.add('active');
            }
        });
        const nameEl = document.getElementById('current-frame-name');
        if (nameEl) nameEl.textContent = frameNames[frame] || 'Р вЂР ВµР В· РЎР‚Р В°Р СР С”Р С‘';
    }
    
    // Р СџРЎР‚Р С‘Р СР ВµР Р…Р ВµР Р…Р С‘Р Вµ РЎР‚Р В°Р СР С”Р С‘ Р С” Р В°Р Р†Р В°РЎвЂљР В°РЎР‚РЎС“
    window.applyAvatarFrame = function() {
        const frame = me?.avatarFrame || 'none';
        const settingsAvatar = document.getElementById('settings-avatar');
        const myAvatar = document.getElementById('my-avatar');
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р Р†РЎРѓР Вµ Р С”Р В»Р В°РЎРѓРЎРѓРЎвЂ№ РЎР‚Р В°Р СР С•Р С”
        const frameClasses = ['avatar-frame-rainbow', 'avatar-frame-gold', 'avatar-frame-neon', 'avatar-frame-fire', 'avatar-frame-purple', 'avatar-frame-emerald', 'avatar-frame-diamond', 'avatar-frame-aurora', 'avatar-frame-plasma'];
        
        [settingsAvatar, myAvatar].forEach(el => {
            if (el) {
                frameClasses.forEach(cls => el.classList.remove(cls));
                if (frame !== 'none') {
                    el.classList.add('avatar-frame-' + frame);
                }
            }
        });
    }
    
    // Р вЂ™РЎвЂ№Р В±Р С•РЎР‚ РЎРѓРЎвЂљР С‘Р В»РЎРЏ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
    window.selectChatStyle = async (style) => {
        if (!me) return;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Premium Р Т‘Р В»РЎРЏ РЎРЊР С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№РЎвЂ¦ РЎРѓРЎвЂљР С‘Р В»Р ВµР в„–
        if (premiumOnlyStyles.includes(style)) {
            if (!hasPremium()) {
                showToast('Р В­РЎвЂљР С•РЎвЂљ РЎРѓРЎвЂљР С‘Р В»РЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р ВµР Р… РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium! РІВ­С’', 'СЂСџвЂќвЂ™');
                return;
            }
            // Premium РЎРѓРЎвЂљР С‘Р В»Р С‘ Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…РЎвЂ№ Р Т‘Р В»РЎРЏ Premium Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
            me.chatStyle = style;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                chatStyle: style
            }, { merge: true });
            
            window.updateStyleSelection(style);
            window.applyChatStyle();
            showToast(`Р РЋРЎвЂљР С‘Р В»РЎРЉ: ${styleNames[style]}`, 'РІСљвЂ¦');
            return;
        }
        
        const price = stylePrices[style] || 0;
        const currentRubies = me.rubies || 0;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р С”РЎС“Р С—Р В»Р ВµР Р… Р В»Р С‘ РЎС“Р В¶Р Вµ РЎРѓРЎвЂљР С‘Р В»РЎРЉ
        const ownedStyles = me.ownedStyles || ['default'];
        
        if (!ownedStyles.includes(style)) {
            // Р СњРЎС“Р В¶Р Р…Р С• Р С”РЎС“Р С—Р С‘РЎвЂљРЎРЉ
            if (currentRubies < price) {
                showToast(`Р СњР ВµР Т‘Р С•РЎРѓРЎвЂљР В°РЎвЂљР С•РЎвЂЎР Р…Р С• РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р†! Р СњРЎС“Р В¶Р Р…Р С• ${price}СЂСџвЂ™Р‹`, 'РІСњРЉ');
                return;
            }
            
            // Р РЋР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р С‘ Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР С‘Р В»РЎРЉ
            ownedStyles.push(style);
            me.rubies = currentRubies - price;
            me.ownedStyles = ownedStyles;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                rubies: me.rubies,
                ownedStyles: ownedStyles,
                chatStyle: style
            }, { merge: true });
            
            updateRubiesDisplay();
            showToast(`Р РЋРЎвЂљР С‘Р В»РЎРЉ "${styleNames[style]}" Р С”РЎС“Р С—Р В»Р ВµР Р… Р В·Р В° ${price}СЂСџвЂ™Р‹!`, 'СЂСџР‹вЂ°');
        } else {
            // Р Р€Р В¶Р Вµ Р С”РЎС“Р С—Р В»Р ВµР Р… - Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р Р†РЎвЂ№Р В±Р С‘РЎР‚Р В°Р ВµР С
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                chatStyle: style
            }, { merge: true });
        }
        
        me.chatStyle = style;
        window.updateStyleSelection(style);
        window.applyChatStyle();
        showToast(`Р РЋРЎвЂљР С‘Р В»РЎРЉ: ${styleNames[style]}`, 'РІСљвЂ¦');
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р Вµ UI Р Р†РЎвЂ№Р В±Р С•РЎР‚Р В° РЎРѓРЎвЂљР С‘Р В»РЎРЏ
    window.updateStyleSelection = function(style) {
        document.querySelectorAll('.chat-style-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.style === style) {
                btn.classList.add('active');
            }
        });
        const nameEl = document.getElementById('current-style-name');
        if (nameEl) nameEl.textContent = styleNames[style] || 'Р РЋРЎвЂљР В°Р Р…Р Т‘Р В°РЎР‚РЎвЂљР Р…Р С•Р Вµ';
    }
    
    // Р СџРЎР‚Р С‘Р СР ВµР Р…Р ВµР Р…Р С‘Р Вµ РЎРѓРЎвЂљР С‘Р В»РЎРЏ Р С” РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏР С
    window.applyChatStyle = function() {
        const style = me?.chatStyle || 'default';
        const messagesContainer = document.getElementById('messages-container');
        
        if (messagesContainer) {
            messagesContainer.classList.remove('msg-style-gradient', 'msg-style-neon', 'msg-style-glass', 'msg-style-aurora', 'msg-style-fire', 'msg-style-galaxy', 'msg-style-gold');
            if (style !== 'default') {
                messagesContainer.classList.add('msg-style-' + style);
            }
        }
    }
    
    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С” РЎР‚Р В°Р СР С•Р С” Р С‘ РЎРѓРЎвЂљР С‘Р В»Р ВµР в„–
    window.loadFrameAndStyleSettings = async function() {
        if (!me) return;
        
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                me.avatarFrame = data.avatarFrame || 'none';
                me.chatStyle = data.chatStyle || 'default';
                me.ownedFrames = data.ownedFrames || ['none'];
                me.ownedStyles = data.ownedStyles || ['default'];
                
                window.updateFrameSelection(me.avatarFrame);
                window.updateStyleSelection(me.chatStyle);
                window.applyAvatarFrame();
                window.applyChatStyle();
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р Р† Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В°РЎвЂ¦
                const settingsRubies = document.getElementById('settings-rubies');
                if (settingsRubies) settingsRubies.textContent = (me.rubies || 0).toFixed(2);
                
                // Р СџР С•Р СР ВµРЎвЂЎР В°Р ВµР С Р С”РЎС“Р С—Р В»Р ВµР Р…Р Р…РЎвЂ№Р Вµ РЎР‚Р В°Р СР С”Р С‘
                document.querySelectorAll('.frame-btn').forEach(btn => {
                    const frame = btn.dataset.frame;
                    if (me.ownedFrames.includes(frame)) {
                        const priceSpan = btn.querySelector('span');
                        if (priceSpan && frame !== 'none') {
                            priceSpan.textContent = 'РІСљвЂњ';
                            priceSpan.className = 'absolute -bottom-1 text-[8px] bg-green-500 text-white px-1 rounded';
                        }
                    }
                });
                
                // Р СџР С•Р СР ВµРЎвЂЎР В°Р ВµР С Р С”РЎС“Р С—Р В»Р ВµР Р…Р Р…РЎвЂ№Р Вµ РЎРѓРЎвЂљР С‘Р В»Р С‘
                document.querySelectorAll('.chat-style-btn').forEach(btn => {
                    const style = btn.dataset.style;
                    if (me.ownedStyles.includes(style)) {
                        const priceSpan = btn.querySelector('span:last-child');
                        if (priceSpan && style !== 'default') {
                            priceSpan.textContent = 'РІСљвЂњ Р С™РЎС“Р С—Р В»Р ВµР Р…Р С•';
                            priceSpan.className = 'text-[10px] bg-green-500 text-white px-2 py-1 rounded';
                        }
                    }
                });
            }
        } catch (e) {
            console.error('Error loading frame/style settings:', e);
        }
    };
    
    // Р СџР С•Р С”Р В°Р В·Р В°РЎвЂљРЎРЉ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ
    window.showUserProfile = async (uid) => {
        if (!uid) return;
        
        const modal = document.getElementById('profile-modal');
        const avatar = document.getElementById('profile-modal-avatar');
        const name = document.getElementById('profile-modal-name');
        const status = document.getElementById('profile-modal-status');
        const body = document.getElementById('profile-modal-body');
        
        modal.style.display = 'flex';
        body.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl opacity-50"></i></div>';
        
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
            
            if (!userDoc.exists()) {
                body.innerHTML = '<div class="profile-hidden"><i class="fas fa-user-slash text-4xl mb-3"></i><p>Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…</p></div>';
                return;
            }
            
            const data = userDoc.data();
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎРѓР С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С—РЎР‚Р С•РЎвЂћР С‘Р В»РЎРЏ
            if (data.profileHidden && uid !== me?.uid) {
                avatar.innerHTML = '<i class="fas fa-user-secret text-3xl"></i>';
                name.textContent = '@' + data.username;
                status.textContent = '';
                body.innerHTML = '<div class="profile-hidden"><i class="fas fa-lock text-4xl mb-3"></i><p>' + 
                    (currentLang === 'ru' ? 'Р СџРЎР‚Р С•РЎвЂћР С‘Р В»РЎРЉ РЎРѓР С”РЎР‚РЎвЂ№РЎвЂљ' : 'Profile is hidden') + '</p></div>';
                return;
            }
            
            // Р С’Р Р†Р В°РЎвЂљР В°РЎР‚
            if (data.avatar) {
                avatar.innerHTML = '<img src="' + data.avatar + '">';
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р В»Р В°РЎРѓРЎРѓ Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘
                if (data.animatedAvatar && checkUserPremium(data)) {
                    avatar.classList.add('avatar-animated');
                } else {
                    avatar.classList.remove('avatar-animated');
                }
            } else {
                avatar.innerHTML = data.username[0].toUpperCase();
                avatar.classList.remove('avatar-animated');
            }
            
            // Р ВР СРЎРЏ + Premium badge
            const premiumBadge = checkUserPremium(data) ? ' ' + getPremiumBadgeHtml(false) : '';
            name.innerHTML = '@' + data.username + premiumBadge;
            
            // Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓ Р С•Р Р…Р В»Р В°Р в„–Р Р…
            const isOnline = data.isOnline === true;
            status.innerHTML = isOnline ? 
                '<span class="text-green-400">' + (currentLang === 'ru' ? 'Р Р† РЎРѓР ВµРЎвЂљР С‘' : 'online') + '</span>' : 
                formatLastSeen(data.lastSeen);
            
            // Р ВР Р…РЎвЂћР С•РЎР‚Р СР В°РЎвЂ Р С‘РЎРЏ
            let infoHtml = '';
            
            // Р СџР С•Р В»
            if (data.gender) {
                const genderText = {
                    male: currentLang === 'ru' ? 'Р СљРЎС“Р В¶РЎРѓР С”Р С•Р в„–' : 'Male',
                    female: currentLang === 'ru' ? 'Р вЂ“Р ВµР Р…РЎРѓР С”Р С‘Р в„–' : 'Female',
                    other: currentLang === 'ru' ? 'Р вЂќРЎР‚РЎС“Р С–Р С•Р в„–' : 'Other'
                };
                const genderIcon = { male: 'СЂСџвЂРЃ', female: 'СЂСџвЂВ©', other: 'СЂСџВ¤В·' };
                infoHtml += '<div class="profile-info-item">' +
                    '<div class="profile-info-icon">' + genderIcon[data.gender] + '</div>' +
                    '<div><div class="profile-info-label">' + (currentLang === 'ru' ? 'Р СџР С•Р В»' : 'Gender') + '</div>' +
                    '<div class="profile-info-value">' + genderText[data.gender] + '</div></div></div>';
            }
            
            // Р вЂР С‘Р С•
            if (data.bio) {
                infoHtml += '<div class="profile-info-item">' +
                    '<div class="profile-info-icon"><i class="fas fa-quote-left"></i></div>' +
                    '<div><div class="profile-info-label">' + (currentLang === 'ru' ? 'Р С› РЎРѓР ВµР В±Р Вµ' : 'About') + '</div>' +
                    '<div class="profile-info-value">' + data.bio + '</div></div></div>';
            }
            
            // Р вЂ™Р С‘РЎвЂљРЎР‚Р С‘Р Р…Р В° Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р С•Р Р†
            if (data.giftsShowcase && Object.keys(data.giftsShowcase).length > 0) {
                let giftsHtml = '<div class="profile-info-item" style="flex-direction: column; align-items: flex-start;">' +
                    '<div class="profile-info-label mb-2"><i class="fas fa-gift mr-1"></i> ' + 
                    (currentLang === 'ru' ? 'Р вЂ™Р С‘РЎвЂљРЎР‚Р С‘Р Р…Р В° Р С—Р С•Р Т‘Р В°РЎР‚Р С”Р С•Р Р†' : 'Gift Showcase') + '</div>' +
                    '<div class="gifts-showcase">';
                
                // Р РЋР С•РЎР‚РЎвЂљР С‘РЎР‚РЎС“Р ВµР С Р С—Р С• Р С”Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†РЎС“
                const sortedGifts = Object.entries(data.giftsShowcase)
                    .sort((a, b) => b[1] - a[1]);
                
                for (const [giftId, count] of sortedGifts) {
                    if (count > 0) {
                        const giftSvg = (window.giftSVGs && window.giftSVGs[giftId]) ? window.giftSVGs[giftId] : (window.giftSVGs ? window.giftSVGs.gift : 'СЂСџР‹Рѓ');
                        giftsHtml += '<div class="showcase-gift">' +
                            '<span class="showcase-gift-icon">' + giftSvg + '</span>' +
                            '<span class="showcase-gift-count">Р“вЂ”' + count + '</span>' +
                        '</div>';
                    }
                }
                
                giftsHtml += '</div></div>';
                infoHtml += giftsHtml;
            }
            
            if (!infoHtml) {
                infoHtml = '<div class="text-center py-4 opacity-50 text-sm">' + 
                    (currentLang === 'ru' ? 'Р СњР ВµРЎвЂљ Р С‘Р Р…РЎвЂћР С•РЎР‚Р СР В°РЎвЂ Р С‘Р С‘' : 'No information') + '</div>';
            }
            
            body.innerHTML = infoHtml;
            
        } catch (e) {
            console.error('Error loading profile:', e);
            body.innerHTML = '<div class="profile-hidden"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘</p></div>';
        }
    };
    
    window.closeProfileModal = () => {
        document.getElementById('profile-modal').style.display = 'none';
    };
    
    // ========== Р вЂњР С›Р вЂєР С›Р РЋР С›Р вЂ™Р С’Р СњР ВР Р‡ (POLLS) ==========
    
    window.openPollModal = () => {
        if (!activeChatPartner && !activeGroup) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р С•РЎвЂљР С”РЎР‚Р С•Р в„–РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ', 'РІС™В РїС‘РЏ');
            return;
        }
        document.getElementById('poll-modal').style.display = 'flex';
        document.getElementById('poll-question').value = '';
        document.getElementById('poll-anonymous').checked = false;
        document.getElementById('poll-multiple').checked = false;
        
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљРЎвЂ№
        const container = document.getElementById('poll-options-container');
        container.innerHTML = `
            <div class="poll-option-input">
                <input type="text" placeholder="Р вЂ™Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ 1" maxlength="100">
                <button class="poll-remove-option" onclick="removePollOption(this)" style="visibility: hidden;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="poll-option-input">
                <input type="text" placeholder="Р вЂ™Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ 2" maxlength="100">
                <button class="poll-remove-option" onclick="removePollOption(this)" style="visibility: hidden;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    };
    
    window.closePollModal = () => {
        document.getElementById('poll-modal').style.display = 'none';
    };
    
    window.addPollOption = () => {
        const container = document.getElementById('poll-options-container');
        const count = container.children.length;
        if (count >= 10) {
            showToast('Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 10 Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљР С•Р Р†', 'РІС™В РїС‘РЏ');
            return;
        }
        
        const div = document.createElement('div');
        div.className = 'poll-option-input';
        div.innerHTML = `
            <input type="text" placeholder="Р вЂ™Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ ${count + 1}" maxlength="100">
            <button class="poll-remove-option" onclick="removePollOption(this)">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(div);
        div.querySelector('input').focus();
        updatePollRemoveButtons();
    };
    
    window.removePollOption = (btn) => {
        const container = document.getElementById('poll-options-container');
        if (container.children.length <= 2) return;
        btn.closest('.poll-option-input').remove();
        updatePollRemoveButtons();
    };
    
    function updatePollRemoveButtons() {
        const container = document.getElementById('poll-options-container');
        const buttons = container.querySelectorAll('.poll-remove-option');
        buttons.forEach(btn => {
            btn.style.visibility = container.children.length > 2 ? 'visible' : 'hidden';
        });
    }
    
    window.createPoll = async () => {
        const question = document.getElementById('poll-question').value.trim();
        const isAnonymous = document.getElementById('poll-anonymous').checked;
        const isMultiple = document.getElementById('poll-multiple').checked;
        
        const optionInputs = document.querySelectorAll('#poll-options-container input');
        const options = [];
        optionInputs.forEach(input => {
            const val = input.value.trim();
            if (val) options.push(val);
        });
        
        if (!question) {
            showToast('Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р Р†Р С•Р С—РЎР‚Р С•РЎРѓ', 'РІС™В РїС‘РЏ');
            return;
        }
        if (options.length < 2) {
            showToast('Р СњРЎС“Р В¶Р Р…Р С• Р СР С‘Р Р…Р С‘Р СРЎС“Р С 2 Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљР В°', 'РІС™В РїС‘РЏ');
            return;
        }
        
        const pollId = 'poll_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const pollData = {
            type: 'poll',
            pollId: pollId,
            question: question,
            options: options.map((text, idx) => ({ id: idx, text: text, votes: [] })),
            isAnonymous: isAnonymous,
            isMultiple: isMultiple,
            creatorId: me.uid,
            creatorName: me.username,
            totalVotes: 0,
            timestamp: serverTimestamp(),
            senderId: me.uid,
            senderName: me.username
        };
        
        // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р В°Р С” РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        if (activeGroup) {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages'), pollData);
        } else if (activeChatPartner) {
            const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
            const isSavedMessages = activeChatPartner.uid && activeChatPartner.uid.startsWith('saved_');
            
            if (isSavedMessages) {
                // Р вЂќР В»РЎРЏ "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•" РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Р С•РЎвЂљР Т‘Р ВµР В»РЎРЉР Р…РЎС“РЎР‹ Р С”Р С•Р В»Р В»Р ВµР С”РЎвЂ Р С‘РЎР‹
                await addDoc(collection(db, 'artifacts', appId, 'users', me.uid, 'saved_messages'), pollData);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), pollData);
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С last message
                await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'active_chats', activeChatPartner.uid), {
                    uid: activeChatPartner.uid,
                    username: activeChatPartner.username,
                    last: 'СЂСџвЂњР‰ Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘Р Вµ: ' + question.substring(0, 30) + (question.length > 30 ? '...' : ''),
                    lastSenderId: me.uid,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                await setDoc(doc(db, 'artifacts', appId, 'users', activeChatPartner.uid, 'active_chats', me.uid), {
                    uid: me.uid,
                    username: me.username,
                    last: 'СЂСџвЂњР‰ Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘Р Вµ: ' + question.substring(0, 30) + (question.length > 30 ? '...' : ''),
                    lastSenderId: me.uid,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            }
        }
        
        closePollModal();
        showToast('Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘Р Вµ РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С•!', 'СЂСџвЂњР‰');
    };
    
    window.votePoll = async (msgId, optionId, pollData) => {
        if (!me) return;
        
        const chatId = activeGroup ? null : [me.uid, activeChatPartner.uid].sort().join('_');
        const msgRef = activeGroup 
            ? doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages', msgId)
            : doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
        
        // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ
        const msgDoc = await getDoc(msgRef);
        if (!msgDoc.exists()) return;
        
        const data = msgDoc.data();
        const options = data.options || [];
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р В» Р В»Р С‘ РЎС“Р В¶Р Вµ
        let hasVoted = false;
        let votedOptionId = -1;
        options.forEach((opt, idx) => {
            if (opt.votes && opt.votes.includes(me.uid)) {
                hasVoted = true;
                votedOptionId = idx;
            }
        });
        
        // Р вЂўРЎРѓР В»Р С‘ Р Р…Р Вµ Р СР Р…Р С•Р В¶Р ВµРЎРѓРЎвЂљР Р†Р ВµР Р…Р Р…РЎвЂ№Р в„– Р Р†РЎвЂ№Р В±Р С•РЎР‚ Р С‘ РЎС“Р В¶Р Вµ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р В» Р В·Р В° Р Т‘РЎР‚РЎС“Р С–Р С•Р в„– Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ - РЎС“Р В±Р С‘РЎР‚Р В°Р ВµР С РЎРѓРЎвЂљР В°РЎР‚РЎвЂ№Р в„– Р С–Р С•Р В»Р С•РЎРѓ
        if (!data.isMultiple && hasVoted && votedOptionId !== optionId) {
            options[votedOptionId].votes = options[votedOptionId].votes.filter(uid => uid !== me.uid);
        }
        
        // Р вЂўРЎРѓР В»Р С‘ РЎС“Р В¶Р Вµ Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р В» Р В·Р В° РЎРЊРЎвЂљР С•РЎвЂљ Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ - РЎС“Р В±Р С‘РЎР‚Р В°Р ВµР С Р С–Р С•Р В»Р С•РЎРѓ (toggle)
        if (options[optionId].votes && options[optionId].votes.includes(me.uid)) {
            options[optionId].votes = options[optionId].votes.filter(uid => uid !== me.uid);
        } else {
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С–Р С•Р В»Р С•РЎРѓ
            if (!options[optionId].votes) options[optionId].votes = [];
            options[optionId].votes.push(me.uid);
        }
        
        // Р РЋРЎвЂЎР С‘РЎвЂљР В°Р ВµР С Р С•Р В±РЎвЂ°Р ВµР Вµ Р С”Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С• Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†
        let totalVotes = 0;
        options.forEach(opt => {
            totalVotes += (opt.votes || []).length;
        });
        
        await updateDoc(msgRef, {
            options: options,
            totalVotes: totalVotes
        });
    };
    
    function renderPollMessage(m, msgId, isMine) {
        const options = m.options || [];
        const totalVotes = m.totalVotes || 0;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р В» Р В»Р С‘ РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р в„– Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ
        let userVoted = false;
        options.forEach(opt => {
            if (opt.votes && opt.votes.includes(me.uid)) {
                userVoted = true;
            }
        });
        
        let optionsHtml = '';
        options.forEach((opt, idx) => {
            const votes = (opt.votes || []).length;
            const percent = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
            const isSelected = opt.votes && opt.votes.includes(me.uid);
            const votedClass = userVoted ? 'voted' : '';
            const selectedClass = isSelected ? 'selected' : '';
            
            optionsHtml += `
                <div class="poll-option ${votedClass} ${selectedClass}" onclick="votePoll('${msgId}', ${idx}, ${JSON.stringify(m).replace(/"/g, '&quot;')})">
                    <div class="poll-progress" style="width: ${userVoted ? percent : 0}%"></div>
                    <div class="poll-option-content">
                        <span class="poll-option-text">${isSelected ? 'РІСљвЂњ ' : ''}${opt.text}</span>
                        <span class="poll-option-percent">${percent}%</span>
                    </div>
                </div>
            `;
        });
        
        const anonymousLabel = m.isAnonymous ? '<i class="fas fa-user-secret" title="Р С’Р Р…Р С•Р Р…Р С‘Р СР Р…Р С•Р Вµ"></i>' : '';
        const multipleLabel = m.isMultiple ? '<i class="fas fa-check-double" title="Р СљР Р…Р С•Р В¶Р ВµРЎРѓРЎвЂљР Р†Р ВµР Р…Р Р…РЎвЂ№Р в„– Р Р†РЎвЂ№Р В±Р С•РЎР‚"></i>' : '';
        
        return `
            <div class="poll-container">
                <div class="poll-question">
                    <i class="fas fa-poll"></i>
                    ${m.question}
                </div>
                ${optionsHtml}
                <div class="poll-footer">
                    <div class="poll-votes-count">
                        <i class="fas fa-users"></i>
                        ${totalVotes} ${totalVotes === 1 ? 'Р С–Р С•Р В»Р С•РЎРѓ' : totalVotes < 5 ? 'Р С–Р С•Р В»Р С•РЎРѓР В°' : 'Р С–Р С•Р В»Р С•РЎРѓР С•Р Р†'}
                    </div>
                    <div class="flex gap-2">
                        ${anonymousLabel}
                        ${multipleLabel}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ==================== Р вЂњР вЂўР С›Р вЂєР С›Р С™Р С’Р В¦Р ВР Р‡ ====================
    window.sendLocation = async () => {
        if (!activeChatPartner && !activeGroup) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ', 'РІСњРЉ');
            return;
        }
        
        if (!navigator.geolocation) {
            showToast('Р вЂњР ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘РЎРЏ Р Р…Р Вµ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р ВµРЎвЂљРЎРѓРЎРЏ', 'РІСњРЉ');
            return;
        }
        
        showToast('Р С›Р С—РЎР‚Р ВµР Т‘Р ВµР В»РЎРЏР ВµР С Р СР ВµРЎРѓРЎвЂљР С•Р С—Р С•Р В»Р С•Р В¶Р ВµР Р…Р С‘Р Вµ...', 'СЂСџвЂњРЊ');
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                await sendLocationData(position.coords.latitude, position.coords.longitude, Math.round(position.coords.accuracy));
            },
            (error) => {
                console.error('Geolocation error:', error);
                let msg = 'Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С•Р С—РЎР‚Р ВµР Т‘Р ВµР В»Р С‘РЎвЂљРЎРЉ Р СР ВµРЎРѓРЎвЂљР С•Р С—Р С•Р В»Р С•Р В¶Р ВµР Р…Р С‘Р Вµ';
                if (error.code === 1) msg = 'Р вЂќР С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р С–Р ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘Р С‘ Р В·Р В°Р С—РЎР‚Р ВµРЎвЂ°РЎвЂР Р…. Р В Р В°Р В·РЎР‚Р ВµРЎв‚¬Р С‘РЎвЂљР Вµ Р Р† Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В°РЎвЂ¦ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р В°';
                if (error.code === 2) msg = 'GPS Р Р…Р ВµР Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р ВµР Р…. Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљР Вµ Р С–Р ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘РЎР‹ Р Р…Р В° РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р Вµ';
                if (error.code === 3) msg = 'Р СџРЎР‚Р ВµР Р†РЎвЂ№РЎв‚¬Р ВµР Р…Р С• Р Р†РЎР‚Р ВµР СРЎРЏ Р С•Р В¶Р С‘Р Т‘Р В°Р Р…Р С‘РЎРЏ';
                showToast(msg, 'РІСњРЉ');
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 60000
            }
        );
    };
    
    async function sendLocationData(lat, lng, accuracy = 0) {
        const locationData = {
            type: 'location',
            senderId: me.uid,
            senderName: me.username,
            latitude: lat,
            longitude: lng,
            accuracy: accuracy,
            timestamp: serverTimestamp()
        };
        
        try {
            if (activeGroup) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages'), locationData);
            } else {
                const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                const isSavedMessages = activeChatPartner.uid && activeChatPartner.uid.startsWith('saved_');
                
                if (isSavedMessages) {
                    // Р вЂќР В»РЎРЏ "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•" РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Р С•РЎвЂљР Т‘Р ВµР В»РЎРЉР Р…РЎС“РЎР‹ Р С”Р С•Р В»Р В»Р ВµР С”РЎвЂ Р С‘РЎР‹
                    await addDoc(collection(db, 'artifacts', appId, 'users', me.uid, 'saved_messages'), locationData);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), locationData);
                    
                    // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С last message
                    const lastMsg = 'СЂСџвЂњРЊ Р вЂњР ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘РЎРЏ';
                    await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'active_chats', activeChatPartner.uid), {
                        uid: activeChatPartner.uid,
                        username: activeChatPartner.username,
                        last: lastMsg,
                        lastSenderId: me.uid,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    
                    await setDoc(doc(db, 'artifacts', appId, 'users', activeChatPartner.uid, 'active_chats', me.uid), {
                        uid: me.uid,
                        username: me.username,
                        last: lastMsg,
                        lastSenderId: me.uid,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                }
            }
            
            showToast('Р вЂњР ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘РЎРЏ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р В°', 'СЂСџвЂњРЊ');
        } catch (e) {
            console.error('Location send error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р С‘', 'РІСњРЉ');
        }
    }
    
    function renderLocationMessage(m) {
        const lat = m.latitude;
        const lng = m.longitude;
        const mapUrl = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}`;
        const staticMapUrl = `https://static-maps.yandex.ru/1.x/?ll=${lng},${lat}&z=15&size=300,150&l=map&pt=${lng},${lat},pm2rdm`;
        
        return `
            <div class="location-message" onclick="window.open('${mapUrl}', '_blank')">
                <div class="location-map">
                    <img src="${staticMapUrl}" alt="Map" onerror="this.parentElement.innerHTML='<div class=\\'location-map-placeholder\\'><i class=\\'fas fa-map-marker-alt\\'></i><span>Р С™Р В°РЎР‚РЎвЂљР В°</span></div>'">
                </div>
                <div class="location-info">
                    <div class="location-info-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Р СљР ВµРЎРѓРЎвЂљР С•Р С—Р С•Р В»Р С•Р В¶Р ВµР Р…Р С‘Р Вµ
                    </div>
                    <div class="location-info-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                </div>
            </div>
        `;
    }
    // ==================== Р С™Р С›Р СњР вЂўР В¦ Р вЂњР вЂўР С›Р вЂєР С›Р С™Р С’Р В¦Р ВР В ====================
    
    // ==================== Р СљР вЂўР В Р С›Р СџР В Р ВР Р‡Р СћР ВР Р‡ ====================
    window.openEventModal = () => {
        if (!activeChatPartner && !activeGroup) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ', 'РІСњРЉ');
            return;
        }
        
        const modal = document.getElementById('event-modal');
        modal.classList.remove('hidden');
        
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р СР С‘Р Р…Р С‘Р СР В°Р В»РЎРЉР Р…РЎС“РЎР‹ Р Т‘Р В°РЎвЂљРЎС“ - РЎРѓР ВµР С–Р С•Р Т‘Р Р…РЎРЏ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('event-date').min = today;
        document.getElementById('event-date').value = today;
        
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Р†РЎР‚Р ВµР СРЎРЏ РЎвЂЎР ВµРЎР‚Р ВµР В· 1 РЎвЂЎР В°РЎРѓ
        const now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById('event-time').value = now.toTimeString().slice(0, 5);
    };
    
    window.closeEventModal = () => {
        document.getElementById('event-modal').classList.add('hidden');
        document.getElementById('event-title').value = '';
        document.getElementById('event-location').value = '';
        document.getElementById('event-description').value = '';
    };
    
    window.createEvent = async () => {
        const title = document.getElementById('event-title').value.trim();
        const date = document.getElementById('event-date').value;
        const time = document.getElementById('event-time').value;
        const location = document.getElementById('event-location').value.trim();
        const description = document.getElementById('event-description').value.trim();
        
        if (!title) {
            showToast('Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р Р…Р В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р СР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘РЎРЏ', 'РІСњРЉ');
            return;
        }
        
        if (!date || !time) {
            showToast('Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р Т‘Р В°РЎвЂљРЎС“ Р С‘ Р Р†РЎР‚Р ВµР СРЎРЏ', 'РІСњРЉ');
            return;
        }
        
        const eventTime = new Date(`${date}T${time}`).getTime();
        
        if (eventTime <= Date.now()) {
            showToast('Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р Р†РЎР‚Р ВµР СРЎРЏ Р Р† Р В±РЎС“Р Т‘РЎС“РЎвЂ°Р ВµР С', 'РІСњРЉ');
            return;
        }
        
        const eventData = {
            type: 'event',
            senderId: me.uid,
            senderName: me.username,
            title: title,
            eventDate: date,
            eventTime: time,
            eventTimestamp: eventTime,
            location: location || null,
            description: description || null,
            responses: {
                going: [],
                notGoing: []
            },
            timestamp: serverTimestamp()
        };
        
        try {
            if (activeGroup) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages'), eventData);
            } else {
                const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
                const isSavedMessages = activeChatPartner.uid && activeChatPartner.uid.startsWith('saved_');
                
                if (isSavedMessages) {
                    // Р вЂќР В»РЎРЏ "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•" РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Р С•РЎвЂљР Т‘Р ВµР В»РЎРЉР Р…РЎС“РЎР‹ Р С”Р С•Р В»Р В»Р ВµР С”РЎвЂ Р С‘РЎР‹
                    await addDoc(collection(db, 'artifacts', appId, 'users', me.uid, 'saved_messages'), eventData);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), eventData);
                    
                    // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С last message
                    const lastMsg = 'СЂСџвЂњвЂ¦ ' + title;
                    await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'active_chats', activeChatPartner.uid), {
                        uid: activeChatPartner.uid,
                        username: activeChatPartner.username,
                        last: lastMsg,
                        lastSenderId: me.uid,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    
                    await setDoc(doc(db, 'artifacts', appId, 'users', activeChatPartner.uid, 'active_chats', me.uid), {
                        uid: me.uid,
                        username: me.username,
                        last: lastMsg,
                        lastSenderId: me.uid,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                }
            }
            
            closeEventModal();
            showToast('Р СљР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘Р Вµ РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С•!', 'СЂСџвЂњвЂ¦');
        } catch (e) {
            console.error('Event create error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ', 'РІСњРЉ');
        }
    };
    
    window.respondToEvent = async (msgId, response) => {
        if (!me) return;
        
        const chatId = activeGroup ? null : [me.uid, activeChatPartner.uid].sort().join('_');
        const msgRef = activeGroup 
            ? doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages', msgId)
            : doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
        
        const msgDoc = await getDoc(msgRef);
        if (!msgDoc.exists()) return;
        
        const data = msgDoc.data();
        let responses = data.responses || { going: [], notGoing: [] };
        
        // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С Р С‘Р В· Р С•Р В±Р С•Р С‘РЎвЂ¦ РЎРѓР С—Р С‘РЎРѓР С”Р С•Р Р†
        responses.going = responses.going.filter(uid => uid !== me.uid);
        responses.notGoing = responses.notGoing.filter(uid => uid !== me.uid);
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р† Р Р…РЎС“Р В¶Р Р…РЎвЂ№Р в„– РЎРѓР С—Р С‘РЎРѓР С•Р С”
        if (response === 'going') {
            responses.going.push(me.uid);
            showToast('Р вЂ™РЎвЂ№ Р С‘Р Т‘РЎвЂРЎвЂљР Вµ Р Р…Р В° Р СР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘Р Вµ!', 'РІСљвЂ¦');
        } else {
            responses.notGoing.push(me.uid);
            showToast('Р вЂ™РЎвЂ№ Р С•РЎвЂљР С”Р В°Р В·Р В°Р В»Р С‘РЎРѓРЎРЉ', 'РІСњРЉ');
        }
        
        await updateDoc(msgRef, { responses });
    };
    
    function renderEventMessage(m, msgId) {
        const eventDate = new Date(`${m.eventDate}T${m.eventTime}`);
        const dateStr = eventDate.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
        const timeStr = eventDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        
        const responses = m.responses || { going: [], notGoing: [] };
        const goingCount = responses.going.length;
        const notGoingCount = responses.notGoing.length;
        const userGoing = responses.going.includes(me.uid);
        const userNotGoing = responses.notGoing.includes(me.uid);
        
        const isPast = m.eventTimestamp < Date.now();
        
        return `
            <div class="event-card ${isPast ? 'opacity-60' : ''}">
                <div class="event-header">
                    <div class="event-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="event-title">${m.title}</div>
                </div>
                <div class="event-body">
                    <div class="event-info-row">
                        <i class="fas fa-clock"></i>
                        <span>${dateStr}, ${timeStr}</span>
                    </div>
                    ${m.location ? `
                        <div class="event-info-row">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${m.location}</span>
                        </div>
                    ` : ''}
                    ${m.description ? `<div class="event-description">${m.description}</div>` : ''}
                </div>
                ${!isPast ? `
                    <div class="event-footer">
                        <div class="event-btn event-btn-accept ${userGoing ? 'ring-2 ring-white' : ''}" onclick="respondToEvent('${msgId}', 'going')">
                            <i class="fas fa-check mr-1"></i> Р ВР Т‘РЎС“
                        </div>
                        <div class="event-btn event-btn-decline ${userNotGoing ? 'ring-2 ring-white/50' : ''}" onclick="respondToEvent('${msgId}', 'notGoing')">
                            <i class="fas fa-times mr-1"></i> Р СњР Вµ Р С‘Р Т‘РЎС“
                        </div>
                    </div>
                ` : ''}
                <div class="event-responses">
                    <span><i class="fas fa-check text-green-300"></i> ${goingCount} Р С‘Р Т‘РЎС“РЎвЂљ</span>
                    <span><i class="fas fa-times text-red-300"></i> ${notGoingCount} Р Р…Р Вµ Р С‘Р Т‘РЎС“РЎвЂљ</span>
                </div>
            </div>
        `;
    }
    // ==================== Р С™Р С›Р СњР вЂўР В¦ Р СљР вЂўР В Р С›Р СџР В Р ВР Р‡Р СћР ВР в„ў ====================
    
    window.openPartnerProfile = () => {
        if (typeof activeChatPartner !== 'undefined' && activeChatPartner && activeChatPartner.uid) {
            showUserProfile(activeChatPartner.uid);
        }
    };

    window.triggerAvatarUpload = () => document.getElementById('avatar-input').click();
    
    window.triggerAnimatedAvatarUpload = () => {
        if (!hasPremium()) {
            showToast('Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…РЎвЂ№ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium!', 'РІВ­С’');
            openRubyShop();
            return;
        }
        document.getElementById('animated-avatar-input').click();
    };
    
    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘ (GIF) Р Т‘Р В»РЎРЏ Premium
    window.handleAnimatedAvatarUpload = async (input) => {
        const file = input.files[0];
        if (!file || !me) return;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Premium
        if (!hasPremium()) {
            showToast('Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…РЎвЂ№ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium!', 'РІВ­С’');
            input.value = '';
            return;
        }
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎвЂЎРЎвЂљР С• РЎРЊРЎвЂљР С• GIF
        if (file.type !== 'image/gif') {
            showToast('Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ GIF-Р С‘Р В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ', 'РІСњРЉ');
            input.value = '';
            return;
        }
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎР‚Р В°Р В·Р СР ВµРЎР‚ (Р СР В°Р С”РЎРѓ 800KB Р Т‘Р В»РЎРЏ GIF)
        if (file.size > 800 * 1024) {
            showToast('GIF РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С Р В±Р С•Р В»РЎРЉРЎв‚¬Р С•Р в„–. Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 800KB.', 'РІСњРЉ');
            input.value = '';
            return;
        }
        
        showToast('Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° GIF...', 'РІРЏС–');
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const avatarData = e.target.result;
            
            try {
                // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Firestore Р С”Р В°Р С” base64
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                    avatar: avatarData,
                    animatedAvatar: true
                }, { merge: true });
                
                me.avatar = avatarData;
                me.animatedAvatar = true;
                updateAllAvatars();
                showToast('Р С’Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р В°РЎРЏ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р В° РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р В°!', 'СЂСџР‹В¬');
            } catch (err) {
                console.error('GIF upload error:', err);
                showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘. Р СџР С•Р С—РЎР‚Р С•Р В±РЎС“Р в„–РЎвЂљР Вµ GIF Р С—Р С•Р СР ВµР Р…РЎРЉРЎв‚¬Р Вµ (Р Т‘Р С• 500KB).', 'РІСњРЉ');
            }
        };
        reader.onerror = () => {
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎвЂЎРЎвЂљР ВµР Р…Р С‘РЎРЏ РЎвЂћР В°Р в„–Р В»Р В°', 'РІСњРЉ');
        };
        reader.readAsDataURL(file);
        input.value = '';
    };

    window.handleAvatarUpload = async (input) => {
        const file = input.files[0];
        if (!file || !me) return;

        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎР‚Р В°Р В·Р СР ВµРЎР‚ (Р СР В°Р С”РЎРѓ 1MB Р Т‘Р В»РЎРЏ Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘)
        if (file.size > 1024 * 1024) {
            alert(currentLang === 'ru' ? 'Р С’Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р В° РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С Р В±Р С•Р В»РЎРЉРЎв‚¬Р В°РЎРЏ. Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 1MB.' : 'Avatar is too large. Maximum 1MB.');
            input.value = '';
            return;
        }

        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎвЂљР С‘Р С—
        if (!file.type.startsWith('image/')) {
            alert('Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С‘Р В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            const avatarData = e.target.result;
            
            // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Firebase (РЎРѓР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎвЂћР В»Р В°Р С– Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘)
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                avatar: avatarData,
                animatedAvatar: false
            }, { merge: true });

            me.avatar = avatarData;
            me.animatedAvatar = false;
            updateAllAvatars();
        };
        reader.readAsDataURL(file);
        input.value = '';
    };

    function updateSettingsAvatar() {
        const settingsAvatar = document.getElementById('settings-avatar');
        if (me?.avatar) {
            settingsAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover">`;
        } else {
            settingsAvatar.innerText = me?.username?.[0]?.toUpperCase() || '?';
        }
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р В»Р В°РЎРѓРЎРѓ Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘
        if (me?.animatedAvatar && hasPremium()) {
            settingsAvatar.classList.add('avatar-animated');
        } else {
            settingsAvatar.classList.remove('avatar-animated');
        }
    }

    function updateAllAvatars() {
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ Р Р† Р В±Р С•Р С”Р С•Р Р†Р С•Р в„– Р С—Р В°Р Р…Р ВµР В»Р С‘
        const myAvatar = document.getElementById('my-avatar');
        if (me?.avatar) {
            myAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover rounded-2xl">`;
        } else {
            myAvatar.innerHTML = me?.username?.[0]?.toUpperCase() || '?';
        }
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р В»Р В°РЎРѓРЎРѓ Р В°Р Р…Р С‘Р СР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚Р С”Р С‘
        if (me?.animatedAvatar && hasPremium()) {
            myAvatar.classList.add('avatar-animated');
        } else {
            myAvatar.classList.remove('avatar-animated');
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р Р† Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В°РЎвЂ¦
        updateSettingsAvatar();
    }
    
    window.setTheme = (t) => {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Premium Р Т‘Р В»РЎРЏ РЎРЊР С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№РЎвЂ¦ РЎвЂљР ВµР С
        if (t === 'amethyst' && !hasPremium()) {
            showToast('Р СћР ВµР СР В° "Р С’Р СР ВµРЎвЂљР С‘РЎРѓРЎвЂљ" Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…Р В° РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium! РІВ­С’', 'СЂСџвЂќвЂ™');
            return;
        }
        document.body.className = `theme-${t} h-screen flex flex-col overflow-hidden`;
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С РЎвЂљР ВµР СРЎС“ Р Р† localStorage Р Т‘Р В»РЎРЏ Р В±РЎвЂ№РЎРѓРЎвЂљРЎР‚Р С•Р С–Р С• Р С—РЎР‚Р С‘Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ Р С—РЎР‚Р С‘ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р Вµ
        localStorage.setItem('flickers-theme', t);
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎС“РЎР‹ Р С”Р Р…Р С•Р С—Р С”РЎС“ РЎвЂљР ВµР СРЎвЂ№
        document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`theme-btn-${t}`);
        if (activeBtn) activeBtn.classList.add('active');
        
        if(me?.uid) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), { settings: { theme: t } }, { merge: true });
    };

    // ========== Р С›Р В±Р С•Р С‘ РЎвЂЎР В°РЎвЂљР В° ==========
    const wallpaperPatterns = {
        none: 'none',
        dots: 'radial-gradient(circle, rgba(99,102,241,0.15) 1px, transparent 1px)',
        grid: 'linear-gradient(rgba(99,102,241,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(99,102,241,0.1) 1px, transparent 1px)',
        diagonal: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(99,102,241,0.08) 10px, rgba(99,102,241,0.08) 20px)',
        waves: 'repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(99,102,241,0.05) 20px, rgba(99,102,241,0.1) 40px)',
        circles: 'radial-gradient(circle at 50% 50%, transparent 20px, rgba(99,102,241,0.05) 21px, rgba(99,102,241,0.05) 22px, transparent 23px)',
        triangles: 'linear-gradient(135deg, rgba(99,102,241,0.1) 25%, transparent 25%), linear-gradient(225deg, rgba(99,102,241,0.1) 25%, transparent 25%)',
        stars: 'radial-gradient(circle at 20% 30%, rgba(255,255,255,0.8) 1px, transparent 1px), radial-gradient(circle at 70% 60%, rgba(255,255,255,0.6) 1px, transparent 1px), radial-gradient(circle at 40% 80%, rgba(255,255,255,0.7) 1px, transparent 1px), radial-gradient(circle at 90% 20%, rgba(255,255,255,0.5) 1px, transparent 1px), radial-gradient(circle at 10% 70%, rgba(255,255,255,0.6) 1px, transparent 1px), radial-gradient(circle at 50% 10%, rgba(255,255,255,0.7) 1px, transparent 1px), radial-gradient(circle at 80% 90%, rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(135deg, #1e1b4b, #312e81, #1e1b4b)'
    };
    
    const wallpaperSizes = {
        dots: '10px 10px',
        grid: '15px 15px',
        diagonal: 'auto',
        waves: 'auto',
        circles: '50px 50px',
        triangles: '20px 20px',
        stars: '100% 100%'
    };
    
    // Premium-only Р С•Р В±Р С•Р С‘
    const premiumOnlyWallpapers = ['stars'];

    window.setWallpaper = (type) => {
        if (type === 'custom') {
            document.getElementById('custom-wallpaper-input').click();
            return;
        }
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Premium Р Т‘Р В»РЎРЏ РЎРЊР С”РЎРѓР С”Р В»РЎР‹Р В·Р С‘Р Р†Р Р…РЎвЂ№РЎвЂ¦ Р С•Р В±Р С•Р ВµР Р†
        if (premiumOnlyWallpapers.includes(type) && !hasPremium()) {
            showToast('Р В­РЎвЂљР С‘ Р С•Р В±Р С•Р С‘ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…РЎвЂ№ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Premium! РІВ­С’', 'СЂСџвЂќвЂ™');
            return;
        }
        
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer) return;
        
        // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С Р Р†РЎвЂ№Р Т‘Р ВµР В»Р ВµР Р…Р С‘Р Вµ РЎРѓР С• Р Р†РЎРѓР ВµРЎвЂ¦ Р С”Р Р…Р С•Р С—Р С•Р С”
        document.querySelectorAll('.wallpaper-btn').forEach(btn => {
            btn.classList.remove('border-indigo-500', 'ring-2', 'ring-indigo-500');
        });
        
        // Р вЂ™РЎвЂ№Р Т‘Р ВµР В»РЎРЏР ВµР С Р Р†РЎвЂ№Р В±РЎР‚Р В°Р Р…Р Р…РЎС“РЎР‹
        const selectedBtn = document.querySelector(`.wallpaper-btn[data-wallpaper="${type}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('border-indigo-500', 'ring-2', 'ring-indigo-500');
        }
        
        if (type === 'none') {
            messagesContainer.classList.remove('wallpaper-stars');
            messagesContainer.removeAttribute('style');
        } else if (type === 'stars') {
            // Premium Р С•Р В±Р С•Р С‘ "Р вЂ”Р Р†РЎвЂР В·Р Т‘РЎвЂ№" - Р С•РЎРѓР С•Р В±Р В°РЎРЏ Р С•Р В±РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р В°
            messagesContainer.removeAttribute('style');
            messagesContainer.style.background = 'linear-gradient(135deg, #1e1b4b, #312e81, #1e1b4b)';
            messagesContainer.classList.add('wallpaper-stars');
        } else {
            messagesContainer.classList.remove('wallpaper-stars');
            messagesContainer.removeAttribute('style');
            messagesContainer.style.backgroundImage = wallpaperPatterns[type];
            messagesContainer.style.backgroundSize = wallpaperSizes[type] || 'auto';
        }
        
        // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† localStorage Р С‘ Firebase
        localStorage.setItem('flickers-wallpaper', type);
        if(me?.uid) {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), { settings: { wallpaper: type } }, { merge: true });
        }
    };

    window.handleCustomWallpaper = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.size > 500 * 1024) {
            alert(currentLang === 'ru' ? 'Р ВР В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С Р В±Р С•Р В»РЎРЉРЎв‚¬Р С•Р Вµ. Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 500KB.' : 'Image too large. Max 500KB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            const messagesContainer = document.getElementById('messages-container');
            
            messagesContainer.style.backgroundImage = `url(${dataUrl})`;
            messagesContainer.style.backgroundSize = 'cover';
            messagesContainer.style.backgroundPosition = 'center';
            
            // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С Р Р†РЎвЂ№Р Т‘Р ВµР В»Р ВµР Р…Р С‘Р Вµ РЎРѓР С• Р Р†РЎРѓР ВµРЎвЂ¦ Р С”Р Р…Р С•Р С—Р С•Р С”
            document.querySelectorAll('.wallpaper-btn').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'ring-2', 'ring-indigo-500');
            });
            
            // Р вЂ™РЎвЂ№Р Т‘Р ВµР В»РЎРЏР ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ custom
            const customBtn = document.querySelector('.wallpaper-btn[data-wallpaper="custom"]');
            if (customBtn) {
                customBtn.classList.add('border-indigo-500', 'ring-2', 'ring-indigo-500');
            }
            
            // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† localStorage
            localStorage.setItem('flickers-wallpaper', 'custom');
            localStorage.setItem('flickers-wallpaper-custom', dataUrl);
        };
        reader.readAsDataURL(file);
    };

    function loadWallpaper() {
        const savedWallpaper = localStorage.getItem('flickers-wallpaper') || 'none';
        
        if (savedWallpaper === 'custom') {
            const customData = localStorage.getItem('flickers-wallpaper-custom');
            if (customData) {
                const messagesContainer = document.getElementById('messages-container');
                if (messagesContainer) {
                    messagesContainer.style.backgroundImage = `url(${customData})`;
                    messagesContainer.style.backgroundSize = 'cover';
                    messagesContainer.style.backgroundPosition = 'center';
                }
            }
        } else if (savedWallpaper !== 'none') {
            setWallpaper(savedWallpaper);
        }
        
        // Р вЂ™РЎвЂ№Р Т‘Р ВµР В»РЎРЏР ВµР С РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎвЂР Р…Р Р…РЎС“РЎР‹ Р С”Р Р…Р С•Р С—Р С”РЎС“
        const selectedBtn = document.querySelector(`.wallpaper-btn[data-wallpaper="${savedWallpaper}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('border-indigo-500', 'ring-2', 'ring-indigo-500');
        }
    }

    // ========== Р СџРЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ Р С‘Р В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р в„– (РЎРѓР С•Р Р†Р СР ВµРЎРѓРЎвЂљР С‘Р СР С•РЎРѓРЎвЂљРЎРЉ) ==========
    let currentImageIndex = 0;
    let chatImages = [];

    window.openImageViewer = (src) => {
        // Р СџР ВµРЎР‚Р ВµР Р…Р В°Р С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р Р…Р В° Р Р…Р С•Р Р†РЎвЂ№Р в„– Р СР ВµР Т‘Р С‘Р В°-Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎвЂ°Р С‘Р С”
        openMediaViewer(src, 'image');
    };

    // Р РЋРЎвЂљР В°РЎР‚РЎвЂ№Р Вµ РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘Р С‘ Р Т‘Р В»РЎРЏ РЎРѓР С•Р Р†Р СР ВµРЎРѓРЎвЂљР С‘Р СР С•РЎРѓРЎвЂљР С‘
    window.closeImageViewer = (event) => {
        if (event && event.target !== event.currentTarget) return;
        const viewer = document.getElementById('image-viewer');
        viewer.classList.add('hidden');
        document.body.style.overflow = '';
    };

    window.navigateImage = (direction) => {
        navigateMedia(direction);
    };

    function updateImageNavigation() {}

    function handleImageViewerKeys(e) {
        handleMediaViewerKeys(e);
    }

    // ========== Р СљР ВµР Т‘Р С‘Р В°-Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎвЂ°Р С‘Р С” (РЎвЂћР С•РЎвЂљР С• + Р Р†Р С‘Р Т‘Р ВµР С•) ==========
    let currentMediaIndex = 0;
    let chatMedia = []; // { src: string, type: 'image' | 'video' }

    window.openMediaViewer = (src, type = 'image') => {
        // Р РЋР С•Р В±Р С‘РЎР‚Р В°Р ВµР С Р Р†РЎРѓР Вµ Р СР ВµР Т‘Р С‘Р В° Р С‘Р В· РЎвЂЎР В°РЎвЂљР В°
        chatMedia = [];
        
        // Р ВР В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘РЎРЏ
        document.querySelectorAll('.chat-image').forEach(img => {
            chatMedia.push({ src: img.src, type: 'image' });
        });
        
        // Р вЂ™Р С‘Р Т‘Р ВµР С• (Р Р…Р Вµ Р С”РЎР‚РЎС“Р В¶Р С”Р С‘)
        document.querySelectorAll('.chat-video').forEach(video => {
            chatMedia.push({ src: video.src, type: 'video' });
        });
        
        // Р вЂ™Р С‘Р Т‘Р ВµР С•-Р С”РЎР‚РЎС“Р В¶Р С”Р С‘ РЎвЂљР С•Р В¶Р Вµ Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С
        document.querySelectorAll('.video-circle-message video').forEach(video => {
            chatMedia.push({ src: video.src, type: 'video' });
        });
        
        // Р СњР В°РЎвЂ¦Р С•Р Т‘Р С‘Р С Р С‘Р Р…Р Т‘Р ВµР С”РЎРѓ РЎвЂљР ВµР С”РЎС“РЎвЂ°Р ВµР С–Р С• Р СР ВµР Т‘Р С‘Р В°
        currentMediaIndex = chatMedia.findIndex(m => m.src === src);
        if (currentMediaIndex === -1) {
            chatMedia.push({ src, type });
            currentMediaIndex = chatMedia.length - 1;
        }
        
        showMediaAtIndex(currentMediaIndex);
        
        const viewer = document.getElementById('media-viewer');
        viewer.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Р С›Р В±РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С” Р С”Р В»Р В°Р Р†Р С‘РЎв‚¬
        document.addEventListener('keydown', handleMediaViewerKeys);
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р СР С‘Р Р…Р С‘Р В°РЎвЂљРЎР‹РЎР‚РЎвЂ№ Р ВµРЎРѓР В»Р С‘ Р В±Р С•Р В»РЎРЉРЎв‚¬Р Вµ 1 Р СР ВµР Т‘Р С‘Р В°
        renderMediaThumbnails();
    };

    function showMediaAtIndex(index) {
        const media = chatMedia[index];
        if (!media) return;
        
        const imgEl = document.getElementById('media-viewer-img');
        const videoEl = document.getElementById('media-viewer-video');
        const downloadBtn = document.getElementById('media-viewer-download');
        const counter = document.getElementById('media-viewer-counter');
        
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР Вµ Р Р†Р С‘Р Т‘Р ВµР С•
        videoEl.pause();
        
        if (media.type === 'video') {
            imgEl.classList.add('hidden');
            videoEl.classList.remove('hidden');
            videoEl.src = media.src;
            videoEl.play().catch(() => {});
        } else {
            videoEl.classList.add('hidden');
            imgEl.classList.remove('hidden');
            imgEl.src = media.src;
        }
        
        downloadBtn.href = media.src;
        
        // Р РЋРЎвЂЎРЎвЂРЎвЂљРЎвЂЎР С‘Р С”
        if (chatMedia.length > 1) {
            counter.textContent = `${index + 1} / ${chatMedia.length}`;
        } else {
            counter.textContent = '';
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р Р…Р В°Р Р†Р С‘Р С–Р В°РЎвЂ Р С‘РЎР‹
        updateMediaNavigation();
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎС“РЎР‹ Р СР С‘Р Р…Р С‘Р В°РЎвЂљРЎР‹РЎР‚РЎС“
        document.querySelectorAll('.media-thumbnail').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });
    }

    function renderMediaThumbnails() {
        const container = document.getElementById('media-viewer-thumbnails');
        
        if (chatMedia.length <= 1) {
            container.classList.add('hidden');
            return;
        }
        
        container.classList.remove('hidden');
        container.innerHTML = '';
        
        chatMedia.forEach((media, index) => {
            if (media.type === 'video') {
                const wrapper = document.createElement('div');
                wrapper.className = `media-thumbnail media-thumbnail-video ${index === currentMediaIndex ? 'active' : ''}`;
                wrapper.style.cssText = 'position:relative;width:60px;height:60px;background:#333;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;';
                wrapper.innerHTML = '<i class="fas fa-play text-white"></i>';
                wrapper.onclick = (e) => {
                    e.stopPropagation();
                    currentMediaIndex = index;
                    showMediaAtIndex(index);
                };
                container.appendChild(wrapper);
            } else {
                const thumb = document.createElement('img');
                thumb.className = `media-thumbnail ${index === currentMediaIndex ? 'active' : ''}`;
                thumb.src = media.src;
                thumb.onclick = (e) => {
                    e.stopPropagation();
                    currentMediaIndex = index;
                    showMediaAtIndex(index);
                };
                container.appendChild(thumb);
            }
        });
    }

    window.closeMediaViewer = (event) => {
        if (event && event.target !== event.currentTarget) return;
        
        const viewer = document.getElementById('media-viewer');
        const videoEl = document.getElementById('media-viewer-video');
        
        videoEl.pause();
        viewer.classList.add('hidden');
        document.body.style.overflow = '';
        document.removeEventListener('keydown', handleMediaViewerKeys);
    };

    window.navigateMedia = (direction) => {
        currentMediaIndex += direction;
        
        if (currentMediaIndex < 0) currentMediaIndex = chatMedia.length - 1;
        if (currentMediaIndex >= chatMedia.length) currentMediaIndex = 0;
        
        showMediaAtIndex(currentMediaIndex);
    };

    function updateMediaNavigation() {
        const prevBtn = document.getElementById('media-viewer-prev');
        const nextBtn = document.getElementById('media-viewer-next');
        
        if (chatMedia.length <= 1) {
            prevBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
        } else {
            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
        }
    }

    function handleMediaViewerKeys(e) {
        if (e.key === 'Escape') {
            closeMediaViewer();
        } else if (e.key === 'ArrowLeft') {
            navigateMedia(-1);
        } else if (e.key === 'ArrowRight') {
            navigateMedia(1);
        } else if (e.key === ' ') {
            // Р СџРЎР‚Р С•Р В±Р ВµР В» Р Т‘Р В»РЎРЏ Р С—Р В°РЎС“Р В·РЎвЂ№/Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘РЎРЏ Р Р†Р С‘Р Т‘Р ВµР С•
            const videoEl = document.getElementById('media-viewer-video');
            if (!videoEl.classList.contains('hidden')) {
                e.preventDefault();
                if (videoEl.paused) {
                    videoEl.play();
                } else {
                    videoEl.pause();
                }
            }
        }
    }

    // ========== Р СљР ВµР Р…РЎР‹ РЎвЂЎР В°РЎвЂљР В° ==========
    let mutedChats = JSON.parse(localStorage.getItem('flickers-muted-chats') || '{}');
    let archivedChats = JSON.parse(localStorage.getItem('flickers-archived-chats') || '{}');
    let deletedChats = JSON.parse(localStorage.getItem('flickers-deleted-chats') || '{}');
    let pinnedChats = JSON.parse(localStorage.getItem('flickers-pinned-chats') || '{}');
    let archivedExpanded = false;

    window.toggleChatMenu = async () => {
        const menu = document.getElementById('chat-menu');
        menu.classList.toggle('hidden');
        
        if (activeChatPartner && !menu.classList.contains('hidden')) {
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С•РЎРѓРЎвЂљР С•РЎРЏР Р…Р С‘Р Вµ Р С”Р Р…Р С•Р С—Р С”Р С‘ mute
            const isMuted = mutedChats[activeChatPartner.uid];
            const muteIcon = document.getElementById('mute-chat-icon');
            const muteText = document.getElementById('mute-chat-text');
            
            if (muteIcon && muteText) {
                if (isMuted) {
                    muteIcon.className = 'fas fa-bell text-indigo-500 w-5';
                    muteText.setAttribute('data-i18n', 'unmuteNotifications');
                    muteText.innerText = currentLang === 'ru' ? 'Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ' : 'Enable notifications';
                } else {
                    muteIcon.className = 'fas fa-bell-slash text-indigo-500 w-5';
                    muteText.setAttribute('data-i18n', 'muteNotifications');
                    muteText.innerText = currentLang === 'ru' ? 'Р С›РЎвЂљР С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ' : 'Mute notifications';
                }
            }
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С•РЎРѓРЎвЂљР С•РЎРЏР Р…Р С‘Р Вµ Р С”Р Р…Р С•Р С—Р С”Р С‘ Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р С”Р С‘
            const blockIcon = document.getElementById('block-user-icon');
            const blockText = document.getElementById('block-user-text');
            const blockBtn = document.getElementById('block-user-btn');
            
            if (blockIcon && blockText && blockBtn) {
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р… Р В»Р С‘ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ
                let isBlocked = false;
                if (me.blockedUsers && me.blockedUsers[activeChatPartner.uid]) {
                    isBlocked = true;
                } else {
                    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р Р† Firebase
                    try {
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            isBlocked = userData.blockedUsers && userData.blockedUsers[activeChatPartner.uid] === true;
                            me.blockedUsers = userData.blockedUsers || {};
                        }
                    } catch (e) {}
                }
                
                if (isBlocked) {
                    blockIcon.className = 'fas fa-user-check w-5';
                    blockText.setAttribute('data-i18n', 'unblockUser');
                    blockText.innerText = currentLang === 'ru' ? 'Р В Р В°Р В·Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ' : 'Unblock';
                    blockBtn.className = 'w-full px-4 py-3 flex items-center gap-3 hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors text-left text-green-500';
                } else {
                    blockIcon.className = 'fas fa-ban w-5';
                    blockText.setAttribute('data-i18n', 'blockUser');
                    blockText.innerText = currentLang === 'ru' ? 'Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ' : 'Block';
                    blockBtn.className = 'w-full px-4 py-3 flex items-center gap-3 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left text-red-500';
                }
            }
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р В°РЎвЂ Р С‘Р С‘
            updateArchiveButton();
        }
    };

    window.searchInChat = () => {
        document.getElementById('chat-menu').classList.add('hidden');
        const query = prompt(currentLang === 'ru' ? 'Р СџР С•Р С‘РЎРѓР С” Р Р† РЎвЂЎР В°РЎвЂљР Вµ:' : 'Search in chat:');
        if (!query) return;
        
        const messages = document.querySelectorAll('#messages-container .message-bubble');
        let found = false;
        
        messages.forEach(msg => {
            msg.style.backgroundColor = '';
        });
        
        messages.forEach(msg => {
            const text = msg.innerText.toLowerCase();
            if (text.includes(query.toLowerCase())) {
                msg.style.backgroundColor = 'rgba(99, 102, 241, 0.3)';
                if (!found) {
                    msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    found = true;
                }
            }
        });
        
        if (!found) {
            alert(currentLang === 'ru' ? 'Р СњР С‘РЎвЂЎР ВµР С–Р С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•' : 'Nothing found');
        }
    };

    window.showChatMedia = () => {
        document.getElementById('chat-menu').classList.add('hidden');
        
        const images = document.querySelectorAll('#messages-container .chat-image');
        if (images.length === 0) {
            alert(currentLang === 'ru' ? 'Р СњР ВµРЎвЂљ Р СР ВµР Т‘Р С‘Р В°РЎвЂћР В°Р в„–Р В»Р С•Р Р† Р Р† РЎРЊРЎвЂљР С•Р С РЎвЂЎР В°РЎвЂљР Вµ' : 'No media files in this chat');
            return;
        }
        
        // Р С›РЎвЂљР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—Р ВµРЎР‚Р Р†Р С•Р Вµ Р С‘Р В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ Р Р† Р С–Р В°Р В»Р ВµРЎР‚Р ВµР Вµ
        openImageViewer(images[0].src);
    };

    window.muteChat = () => {
        document.getElementById('chat-menu').classList.add('hidden');
        if (!activeChatPartner) return;
        
        const isMuted = mutedChats[activeChatPartner.uid];
        
        if (isMuted) {
            delete mutedChats[activeChatPartner.uid];
        } else {
            mutedChats[activeChatPartner.uid] = true;
        }
        
        localStorage.setItem('flickers-muted-chats', JSON.stringify(mutedChats));
        
        const message = isMuted 
            ? (currentLang === 'ru' ? 'Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№' : 'Notifications enabled')
            : (currentLang === 'ru' ? 'Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р С•РЎвЂљР С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№' : 'Notifications muted');
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С toast
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'notification-toast';
        toast.innerHTML = `<i class="fas ${isMuted ? 'fa-bell' : 'fa-bell-slash'} text-indigo-500"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    };

    // Р С’РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ РЎвЂЎР В°РЎвЂљ
    window.archiveChat = () => {
        document.getElementById('chat-menu').classList.add('hidden');
        if (!activeChatPartner) return;
        
        const chatId = activeChatPartner.uid;
        const isArchived = archivedChats[chatId];
        
        if (isArchived) {
            delete archivedChats[chatId];
            showToast('Р В§Р В°РЎвЂљ РЎР‚Р В°Р В·Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…', 'СЂСџвЂњвЂљ');
        } else {
            archivedChats[chatId] = {
                username: activeChatPartner.username,
                avatar: activeChatPartner.avatar || null,
                archivedAt: Date.now()
            };
            showToast('Р В§Р В°РЎвЂљ Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…', 'СЂСџвЂњВ¦');
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂЎР В°РЎвЂљ Р С‘ Р Р†Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµР СРЎРѓРЎРЏ Р С” РЎРѓР С—Р С‘РЎРѓР С”РЎС“
            document.getElementById('active-chat').classList.add('hidden');
            document.getElementById('chat-placeholder').classList.remove('hidden');
            activeChatPartner = null;
        }
        
        localStorage.setItem('flickers-archived-chats', JSON.stringify(archivedChats));
        updateArchivedChatsUI();
    };
    
    // Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ РЎвЂЎР В°РЎвЂљ (РЎРѓР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С‘Р В· РЎРѓР С—Р С‘РЎРѓР С”Р В°)
    window.deleteChat = () => {
        document.getElementById('chat-menu').classList.add('hidden');
        if (!activeChatPartner) return;
        
        const chatId = activeChatPartner.uid;
        deletedChats[chatId] = true;
        localStorage.setItem('flickers-deleted-chats', JSON.stringify(deletedChats));
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂЎР В°РЎвЂљ
        document.getElementById('active-chat').classList.add('hidden');
        document.getElementById('chat-placeholder').classList.remove('hidden');
        activeChatPartner = null;
        
        showToast('Р В§Р В°РЎвЂљ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…', 'СЂСџвЂ”вЂРїС‘РЏ');
    };
    
    // Р СџР ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ Р С•РЎвЂљР С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р В°
    window.toggleArchivedChats = () => {
        archivedExpanded = !archivedExpanded;
        const list = document.getElementById('archived-chats-list');
        const chevron = document.getElementById('archived-chevron');
        
        if (archivedExpanded) {
            list.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            list.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ UI Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦ РЎвЂЎР В°РЎвЂљР С•Р Р†
    function updateArchivedChatsUI() {
        const header = document.getElementById('archived-chats-header');
        const list = document.getElementById('archived-chats-list');
        const count = document.getElementById('archived-count');
        
        const archivedIds = Object.keys(archivedChats);
        
        if (archivedIds.length === 0) {
            header.classList.add('hidden');
            list.classList.add('hidden');
            return;
        }
        
        header.classList.remove('hidden');
        count.textContent = archivedIds.length;
        
        list.innerHTML = archivedIds.map(uid => {
            const chat = archivedChats[uid];
            return `
                <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-all" onclick="openArchivedChat('${uid}')">
                    <div class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 text-purple-500 flex items-center justify-center font-bold overflow-hidden">
                        ${chat.avatar ? `<img src="${chat.avatar}" class="w-full h-full object-cover">` : chat.username[0].toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm truncate">@${chat.username}</p>
                        <p class="text-xs opacity-50">Р С’РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…</p>
                    </div>
                    <button onclick="event.stopPropagation(); unarchiveChat('${uid}')" class="w-8 h-8 rounded-full hover:bg-purple-100 dark:hover:bg-purple-900/30 flex items-center justify-center text-purple-500" title="Р В Р В°Р В·Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ">
                        <i class="fas fa-box-open text-sm"></i>
                    </button>
                </div>
            `;
        }).join('');
    }
    
    // Р С›РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ
    window.openArchivedChat = async (uid) => {
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
            if (userDoc.exists()) {
                selectChat({ uid, ...userDoc.data() });
            }
        } catch (e) {
            console.error('Error opening archived chat:', e);
        }
    };
    
    // Р В Р В°Р В·Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ РЎвЂЎР В°РЎвЂљ
    window.unarchiveChat = (uid) => {
        delete archivedChats[uid];
        localStorage.setItem('flickers-archived-chats', JSON.stringify(archivedChats));
        updateArchivedChatsUI();
        // Р СџР ВµРЎР‚Р ВµР В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С” РЎвЂЎР В°РЎвЂљР С•Р Р† РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ РЎвЂЎР В°РЎвЂљ Р С—Р С•РЎРЏР Р†Р С‘Р В»РЎРѓРЎРЏ
        listenToChats();
        showToast('Р В§Р В°РЎвЂљ РЎР‚Р В°Р В·Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…', 'СЂСџвЂњвЂљ');
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ Р С”Р Р…Р С•Р С—Р С”РЎС“ Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р В°РЎвЂ Р С‘Р С‘ Р Р† Р СР ВµР Р…РЎР‹
    function updateArchiveButton() {
        if (!activeChatPartner) return;
        const icon = document.getElementById('archive-chat-icon');
        const text = document.getElementById('archive-chat-text');
        const isArchived = archivedChats[activeChatPartner.uid];
        
        if (icon && text) {
            if (isArchived) {
                icon.className = 'fas fa-box-open text-purple-500 w-5';
                text.textContent = 'Р В Р В°Р В·Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ';
            } else {
                icon.className = 'fas fa-archive text-purple-500 w-5';
                text.textContent = 'Р С’РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ';
            }
        }
    }
    
    // Р С™Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ Р Т‘Р В»РЎРЏ РЎвЂЎР В°РЎвЂљР В° Р Р† РЎРѓР С—Р С‘РЎРѓР С”Р Вµ
    let chatContextTarget = null;
    
    function showChatContextMenu(e, chat) {
        chatContextTarget = chat;
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎР‚Р С•Р Вµ Р СР ВµР Р…РЎР‹ Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
        const oldMenu = document.getElementById('chat-context-menu');
        if (oldMenu) oldMenu.remove();
        
        const isMuted = mutedChats[chat.uid];
        const isArchived = archivedChats[chat.uid];
        const isPinned = pinnedChats[chat.uid];
        
        const menu = document.createElement('div');
        menu.className = 'msg-context-menu';
        menu.id = 'chat-context-menu';
        
        // Р вЂњР ВµР Р…Р ВµРЎР‚Р С‘РЎР‚РЎС“Р ВµР С Р С—Р С•Р Т‘Р СР ВµР Р…РЎР‹ Р С—Р В°Р С—Р С•Р С”
        const currentChatFolder = chatFolderAssignments[chat.uid];
        let folderSubmenu = `
            <div class="msg-context-submenu-item" onclick="moveChatToFolder('${chat.uid}', 'none')">
                <i class="fas ${!currentChatFolder ? 'fa-check' : ''} w-4 text-xs"></i>
                <span>Р вЂР ВµР В· Р С—Р В°Р С—Р С”Р С‘</span>
            </div>
        `;
        customFolders.forEach(f => {
            folderSubmenu += `
                <div class="msg-context-submenu-item" onclick="moveChatToFolder('${chat.uid}', '${f.id}')">
                    <i class="fas ${currentChatFolder === f.id ? 'fa-check' : ''} w-4 text-xs"></i>
                    <span>${f.name}</span>
                </div>
            `;
        });
        
        menu.innerHTML = `
            <div class="msg-context-item" onclick="openChatFromContext()">
                <i class="fas fa-comment text-indigo-500 w-5"></i>
                <span>Р С›РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ РЎвЂЎР В°РЎвЂљ</span>
            </div>
            <div class="msg-context-item" onclick="togglePinChatFromContext()">
                <i class="fas ${isPinned ? 'fa-thumbtack' : 'fa-thumbtack'} text-yellow-500 w-5 ${isPinned ? 'rotate-45' : ''}"></i>
                <span>${isPinned ? 'Р С›РЎвЂљР С”РЎР‚Р ВµР С—Р С‘РЎвЂљРЎРЉ' : 'Р вЂ”Р В°Р С”РЎР‚Р ВµР С—Р С‘РЎвЂљРЎРЉ'}</span>
            </div>
            <div class="msg-context-divider"></div>
            <div class="msg-context-item" onclick="muteChatFromContext()">
                <i class="fas ${isMuted ? 'fa-bell' : 'fa-bell-slash'} text-indigo-500 w-5"></i>
                <span>${isMuted ? 'Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ Р В·Р Р†РЎС“Р С”' : 'Р вЂР ВµР В· Р В·Р Р†РЎС“Р С”Р В°'}</span>
            </div>
            <div class="msg-context-item" onclick="archiveChatFromContext()">
                <i class="fas ${isArchived ? 'fa-box-open' : 'fa-archive'} text-purple-500 w-5"></i>
                <span>${isArchived ? 'Р В Р В°Р В·Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ' : 'Р С’РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ'}</span>
            </div>
            <div class="msg-context-item has-submenu" onclick="toggleFolderSubmenu(event)">
                <i class="fas fa-folder text-yellow-500 w-5"></i>
                <span>Р СџР ВµРЎР‚Р ВµР СР ВµРЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р Р† Р С—Р В°Р С—Р С”РЎС“</span>
                <i class="fas fa-chevron-right ml-auto text-xs opacity-50"></i>
            </div>
            <div class="msg-context-submenu hidden" id="folder-submenu">
                ${folderSubmenu}
            </div>
            <div class="msg-context-divider"></div>
            <div class="msg-context-item" onclick="clearChatFromContext()">
                <i class="fas fa-broom text-orange-500 w-5"></i>
                <span>Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹</span>
            </div>
            <div class="msg-context-item danger" onclick="deleteChatFromContext()">
                <i class="fas fa-trash w-5"></i>
                <span>Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ РЎвЂЎР В°РЎвЂљ</span>
            </div>
            <div class="msg-context-divider"></div>
            <div class="msg-context-item danger" onclick="blockUserFromContext()">
                <i class="fas fa-ban w-5"></i>
                <span>Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ</span>
            </div>
        `;
        
        document.body.appendChild(menu);
        
        // Р СџР С•Р В·Р С‘РЎвЂ Р С‘Р С•Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ
        const x = e.clientX || e.pageX;
        const y = e.clientY || e.pageY;
        
        menu.style.left = Math.min(x, window.innerWidth - menu.offsetWidth - 10) + 'px';
        menu.style.top = Math.min(y, window.innerHeight - menu.offsetHeight - 10) + 'px';
        
        // Р вЂ™Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘РЎРЏ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
        if (navigator.vibrate) navigator.vibrate(50);
    }
    
    // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљРЎРЉ Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹ РЎвЂЎР В°РЎвЂљР В°
    function closeChatContextMenu() {
        const menu = document.getElementById('chat-context-menu');
        if (menu) menu.remove();
        chatContextTarget = null;
    }
    
    // Р СџР ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ Р С—Р С•Р Т‘Р СР ВµР Р…РЎР‹ Р С—Р В°Р С—Р С•Р С”
    window.toggleFolderSubmenu = (e) => {
        e.stopPropagation();
        const submenu = document.getElementById('folder-submenu');
        if (submenu) {
            submenu.classList.toggle('hidden');
        }
    };
    
    // Р вЂќР ВµР в„–РЎРѓРЎвЂљР Р†Р С‘РЎРЏ Р С‘Р В· Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р С–Р С• Р СР ВµР Р…РЎР‹
    window.openChatFromContext = () => {
        if (chatContextTarget) selectChat(chatContextTarget);
        closeChatContextMenu();
    };
    
    window.muteChatFromContext = () => {
        if (!chatContextTarget) return;
        const isMuted = mutedChats[chatContextTarget.uid];
        if (isMuted) {
            delete mutedChats[chatContextTarget.uid];
            showToast('Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№', 'СЂСџвЂќвЂќ');
        } else {
            mutedChats[chatContextTarget.uid] = true;
            showToast('Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р С•РЎвЂљР С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№', 'СЂСџвЂќвЂў');
        }
        localStorage.setItem('flickers-muted-chats', JSON.stringify(mutedChats));
        closeChatContextMenu();
    };
    
    window.togglePinChatFromContext = () => {
        if (!chatContextTarget) return;
        const isPinned = pinnedChats[chatContextTarget.uid];
        if (isPinned) {
            delete pinnedChats[chatContextTarget.uid];
            showToast('Р В§Р В°РЎвЂљ Р С•РЎвЂљР С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…', 'СЂСџвЂњРЉ');
        } else {
            pinnedChats[chatContextTarget.uid] = {
                username: chatContextTarget.username,
                avatar: chatContextTarget.avatar || null,
                isGroup: chatContextTarget.isGroup || false,
                pinnedAt: Date.now()
            };
            showToast('Р В§Р В°РЎвЂљ Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…', 'СЂСџвЂњРЉ');
        }
        localStorage.setItem('flickers-pinned-chats', JSON.stringify(pinnedChats));
        listenToChats();
        closeChatContextMenu();
    };
    
    window.archiveChatFromContext = () => {
        if (!chatContextTarget) return;
        const isArchived = archivedChats[chatContextTarget.uid];
        if (isArchived) {
            delete archivedChats[chatContextTarget.uid];
            showToast('Р В§Р В°РЎвЂљ РЎР‚Р В°Р В·Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…', 'СЂСџвЂњвЂљ');
        } else {
            archivedChats[chatContextTarget.uid] = {
                username: chatContextTarget.username,
                avatar: chatContextTarget.avatar || null,
                archivedAt: Date.now()
            };
            showToast('Р В§Р В°РЎвЂљ Р В°РЎР‚РЎвЂ¦Р С‘Р Р†Р С‘РЎР‚Р С•Р Р†Р В°Р Р…', 'СЂСџвЂњВ¦');
        }
        localStorage.setItem('flickers-archived-chats', JSON.stringify(archivedChats));
        updateArchivedChatsUI();
        listenToChats();
        closeChatContextMenu();
    };
    
    window.clearChatFromContext = async () => {
        if (!chatContextTarget || !me) return;
        closeChatContextMenu();
        
        const chatId = [me.uid, chatContextTarget.uid].sort().join('_');
        const deletedMsgs = JSON.parse(localStorage.getItem('flickers-deleted-msgs') || '[]');
        
        try {
            const msgsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'));
            msgsSnap.docs.forEach(d => {
                if (!deletedMsgs.includes(d.id)) deletedMsgs.push(d.id);
            });
            localStorage.setItem('flickers-deleted-msgs', JSON.stringify(deletedMsgs));
            showToast('Р ВРЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ Р С•РЎвЂЎР С‘РЎвЂ°Р ВµР Р…Р В°', 'СЂСџВ§в„–');
        } catch (e) {
            console.error('Clear chat error:', e);
        }
    };
    
    window.deleteChatFromContext = () => {
        if (!chatContextTarget) return;
        deletedChats[chatContextTarget.uid] = true;
        localStorage.setItem('flickers-deleted-chats', JSON.stringify(deletedChats));
        listenToChats();
        showToast('Р В§Р В°РЎвЂљ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…', 'СЂСџвЂ”вЂРїС‘РЏ');
        closeChatContextMenu();
    };
    
    window.blockUserFromContext = async () => {
        if (!chatContextTarget || !me) return;
        closeChatContextMenu();
        
        try {
            const blockedUsers = me.blockedUsers || {};
            blockedUsers[chatContextTarget.uid] = true;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                blockedUsers: blockedUsers
            }, { merge: true });
            
            me.blockedUsers = blockedUsers;
            showToast(`@${chatContextTarget.username} Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…`, 'СЂСџС™В«');
        } catch (e) {
            console.error('Block error:', e);
        }
    };

    // ==================== Р СџР С’Р СџР С™Р В Р В§Р С’Р СћР С›Р вЂ™ ====================
    let currentFolder = 'all';
    let customFolders = JSON.parse(localStorage.getItem('flickers-custom-folders') || '[]');
    let chatFolderAssignments = JSON.parse(localStorage.getItem('flickers-chat-folders') || '{}');
    
    window.selectChatFolder = (folder) => {
        currentFolder = folder;
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎС“РЎР‹ Р С”Р Р…Р С•Р С—Р С”РЎС“
        document.querySelectorAll('.chat-folder-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.folder === folder) {
                btn.classList.add('active');
            }
        });
        
        // Р СџР ВµРЎР‚Р ВµР В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С” РЎвЂЎР В°РЎвЂљР С•Р Р† РЎРѓ РЎвЂћР С‘Р В»РЎРЉРЎвЂљРЎР‚Р С•Р С
        listenToChats();
    };
    
    window.openFolderSettings = () => {
        document.getElementById('folders-modal').classList.remove('hidden');
        renderCustomFolders();
    };
    
    window.closeFolderSettings = () => {
        document.getElementById('folders-modal').classList.add('hidden');
    };
    
    function renderCustomFolders() {
        const list = document.getElementById('custom-folders-list');
        list.innerHTML = customFolders.map((folder, index) => `
            <div class="custom-folder-item">
                <i class="fas fa-folder text-indigo-500"></i>
                <span class="flex-1 font-bold text-sm">${folder.name}</span>
                <span class="text-xs opacity-50">${Object.values(chatFolderAssignments).filter(f => f === folder.id).length} РЎвЂЎР В°РЎвЂљР С•Р Р†</span>
                <button onclick="deleteCustomFolder(${index})" class="w-8 h-8 rounded-full hover:bg-red-100 text-red-500 flex items-center justify-center">
                    <i class="fas fa-trash text-xs"></i>
                </button>
            </div>
        `).join('') || '<p class="text-center opacity-50 text-sm py-4">Р СњР ВµРЎвЂљ Р С”Р В°РЎРѓРЎвЂљР С•Р СР Р…РЎвЂ№РЎвЂ¦ Р С—Р В°Р С—Р С•Р С”</p>';
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ Р С—Р В°Р С—Р С•Р С”
        updateFolderButtons();
    }
    
    function updateFolderButtons() {
        const bar = document.getElementById('chat-folders-bar');
        const settingsBtn = bar.querySelector('[onclick="openFolderSettings()"]');
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎР‚РЎвЂ№Р Вµ Р С”Р В°РЎРѓРЎвЂљР С•Р СР Р…РЎвЂ№Р Вµ Р С”Р Р…Р С•Р С—Р С”Р С‘
        bar.querySelectorAll('.custom-folder-btn').forEach(btn => btn.remove());
        
        // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р С”Р В°РЎРѓРЎвЂљР С•Р СР Р…РЎвЂ№Р Вµ Р С—Р В°Р С—Р С”Р С‘
        customFolders.forEach(folder => {
            const btn = document.createElement('button');
            btn.className = `chat-folder-btn custom-folder-btn px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all ${currentFolder === folder.id ? 'active' : ''}`;
            btn.dataset.folder = folder.id;
            btn.onclick = () => selectChatFolder(folder.id);
            btn.innerHTML = `<i class="fas fa-folder mr-1"></i> ${folder.name}`;
            bar.insertBefore(btn, settingsBtn);
        });
    }
    
    window.createCustomFolder = () => {
        const input = document.getElementById('new-folder-name');
        const name = input.value.trim();
        if (!name) return;
        
        const folder = {
            id: 'folder_' + Date.now(),
            name: name
        };
        
        customFolders.push(folder);
        localStorage.setItem('flickers-custom-folders', JSON.stringify(customFolders));
        input.value = '';
        renderCustomFolders();
        showToast(`Р СџР В°Р С—Р С”Р В° "${name}" РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р В°`, 'СЂСџвЂњРѓ');
    };
    
    window.deleteCustomFolder = (index) => {
        const folder = customFolders[index];
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р Р…Р В°Р В·Р Р…Р В°РЎвЂЎР ВµР Р…Р С‘РЎРЏ РЎвЂЎР В°РЎвЂљР С•Р Р† РЎРЊРЎвЂљР С•Р в„– Р С—Р В°Р С—Р С”Р Вµ
        Object.keys(chatFolderAssignments).forEach(uid => {
            if (chatFolderAssignments[uid] === folder.id) {
                delete chatFolderAssignments[uid];
            }
        });
        localStorage.setItem('flickers-chat-folders', JSON.stringify(chatFolderAssignments));
        
        customFolders.splice(index, 1);
        localStorage.setItem('flickers-custom-folders', JSON.stringify(customFolders));
        renderCustomFolders();
        showToast('Р СџР В°Р С—Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р В°', 'СЂСџвЂ”вЂРїС‘РЏ');
    };
    
    window.moveChatToFolder = (chatUid, folderId) => {
        if (folderId === 'none') {
            delete chatFolderAssignments[chatUid];
        } else {
            chatFolderAssignments[chatUid] = folderId;
        }
        localStorage.setItem('flickers-chat-folders', JSON.stringify(chatFolderAssignments));
        listenToChats();
        closeChatContextMenu();
        showToast('Р В§Р В°РЎвЂљ Р С—Р ВµРЎР‚Р ВµР СР ВµРЎвЂ°РЎвЂР Р…', 'СЂСџвЂњРѓ');
    };
    
    // ==================== Р вЂ”Р С’Р СџР вЂєР С’Р СњР ВР В Р С›Р вЂ™Р С’Р СњР СњР В«Р вЂў Р РЋР С›Р С›Р вЂР В©Р вЂўР СњР ВР Р‡ ====================
    let scheduledMessages = JSON.parse(localStorage.getItem('flickers-scheduled-msgs') || '[]');
    let scheduleCheckInterval = null;
    
    window.openScheduleModal = () => {
        if (!activeChatPartner && !activeGroup) {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ РЎвЂЎР В°РЎвЂљ', 'РІСњРЉ');
            return;
        }
        
        const modal = document.getElementById('schedule-modal');
        modal.classList.remove('hidden');
        
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р СР С‘Р Р…Р С‘Р СР В°Р В»РЎРЉР Р…РЎС“РЎР‹ Р Т‘Р В°РЎвЂљРЎС“ - РЎРѓР ВµР С–Р С•Р Т‘Р Р…РЎРЏ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('schedule-date').min = today;
        document.getElementById('schedule-date').value = today;
        
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Р†РЎР‚Р ВµР СРЎРЏ РЎвЂЎР ВµРЎР‚Р ВµР В· 1 РЎвЂЎР В°РЎРѓ
        const now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById('schedule-time').value = now.toTimeString().slice(0, 5);
        
        renderScheduledMessages();
    };
    
    window.closeScheduleModal = () => {
        document.getElementById('schedule-modal').classList.add('hidden');
        document.getElementById('scheduled-message-text').value = '';
    };
    
    window.confirmScheduleMessage = () => {
        const text = document.getElementById('scheduled-message-text').value.trim();
        const date = document.getElementById('schedule-date').value;
        const time = document.getElementById('schedule-time').value;
        
        if (!text) {
            showToast('Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ РЎвЂљР ВµР С”РЎРѓРЎвЂљ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ', 'РІСњРЉ');
            return;
        }
        
        if (!date || !time) {
            showToast('Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р Т‘Р В°РЎвЂљРЎС“ Р С‘ Р Р†РЎР‚Р ВµР СРЎРЏ', 'РІСњРЉ');
            return;
        }
        
        const scheduledTime = new Date(`${date}T${time}`).getTime();
        
        if (scheduledTime <= Date.now()) {
            showToast('Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р Р†РЎР‚Р ВµР СРЎРЏ Р Р† Р В±РЎС“Р Т‘РЎС“РЎвЂ°Р ВµР С', 'РІСњРЉ');
            return;
        }
        
        const scheduled = {
            id: Date.now(),
            text: text,
            chatUid: activeChatPartner?.uid || activeGroup?.id,
            chatName: activeChatPartner?.username || activeGroup?.name,
            isGroup: !!activeGroup,
            scheduledTime: scheduledTime,
            createdAt: Date.now()
        };
        
        scheduledMessages.push(scheduled);
        localStorage.setItem('flickers-scheduled-msgs', JSON.stringify(scheduledMessages));
        
        closeScheduleModal();
        showToast('Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р В·Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С•', 'РІРЏВ°');
    };
    
    function renderScheduledMessages() {
        const list = document.getElementById('scheduled-messages-list');
        const chatScheduled = scheduledMessages.filter(m => 
            m.chatUid === (activeChatPartner?.uid || activeGroup?.id)
        );
        
        if (chatScheduled.length === 0) {
            list.classList.add('hidden');
            return;
        }
        
        list.classList.remove('hidden');
        list.innerHTML = `
            <div class="p-3 text-xs font-bold opacity-50 border-b border-[var(--border)]">
                Р вЂ”Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ (${chatScheduled.length})
            </div>
            ${chatScheduled.map(m => `
                <div class="scheduled-msg-item">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm truncate">${m.text}</p>
                        <p class="text-xs opacity-50">
                            <i class="fas fa-clock mr-1"></i>
                            ${new Date(m.scheduledTime).toLocaleString()}
                        </p>
                    </div>
                    <button onclick="cancelScheduledMessage(${m.id})" class="w-8 h-8 rounded-full hover:bg-red-100 text-red-500 flex items-center justify-center">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('')}
        `;
    }
    
    window.cancelScheduledMessage = (id) => {
        scheduledMessages = scheduledMessages.filter(m => m.id !== id);
        localStorage.setItem('flickers-scheduled-msgs', JSON.stringify(scheduledMessages));
        renderScheduledMessages();
        showToast('Р вЂ”Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С•РЎвЂљР СР ВµР Р…Р ВµР Р…Р С•', 'РІСњРЉ');
    };
    
    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Р С‘ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В° Р В·Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
    function checkScheduledMessages() {
        const now = Date.now();
        const toSend = scheduledMessages.filter(m => m.scheduledTime <= now);
        
        toSend.forEach(async (m) => {
            try {
                if (m.isGroup) {
                    // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В° Р Р† Р С–РЎР‚РЎС“Р С—Р С—РЎС“
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups', m.chatUid, 'messages'), {
                        text: m.text,
                        senderId: me.uid,
                        senderName: me.username,
                        timestamp: serverTimestamp(),
                        scheduled: true
                    });
                } else {
                    // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В° Р Р† Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ
                    const chatId = [me.uid, m.chatUid].sort().join('_');
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), {
                        text: m.text,
                        senderId: me.uid,
                        timestamp: serverTimestamp(),
                        scheduled: true
                    });
                }
                
                showToast(`Р вЂ”Р В°Р С—Р В»Р В°Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С• Р Р† @${m.chatName}`, 'РІСљвЂ¦');
            } catch (e) {
                console.error('Scheduled message error:', e);
            }
        });
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р Р…РЎвЂ№Р Вµ
        if (toSend.length > 0) {
            scheduledMessages = scheduledMessages.filter(m => m.scheduledTime > now);
            localStorage.setItem('flickers-scheduled-msgs', JSON.stringify(scheduledMessages));
        }
    }
    
    // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”РЎС“ Р С”Р В°Р В¶Р Т‘РЎС“РЎР‹ Р СР С‘Р Р…РЎС“РЎвЂљРЎС“
    scheduleCheckInterval = setInterval(checkScheduledMessages, 60000);
    // Р В РЎРѓРЎР‚Р В°Р В·РЎС“ Р С—РЎР‚Р С‘ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р Вµ
    setTimeout(checkScheduledMessages, 5000);
    // ==================== Р С™Р С›Р СњР вЂўР В¦ Р СџР С’Р СџР С›Р С™ Р В Р В Р С’Р РЋР СџР ВР РЋР С’Р СњР ВР Р‡ ====================

    window.clearChatHistory = async () => {
        document.getElementById('chat-menu').classList.add('hidden');
        if (!activeChatPartner || !me) return;
        
        const confirmed = confirm(currentLang === 'ru' 
            ? 'Р С›РЎвЂЎР С‘РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р С‘РЎРѓРЎвЂљР С•РЎР‚Р С‘РЎР‹ РЎвЂЎР В°РЎвЂљР В°? Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р В±РЎС“Р Т‘РЎС“РЎвЂљ РЎС“Р Т‘Р В°Р В»Р ВµР Р…РЎвЂ№ РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎС“ Р Р†Р В°РЎРѓ.' 
            : 'Clear chat history? Messages will be deleted only for you.');
        
        if (!confirmed) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        try {
            const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
            const snapshot = await getDocs(messagesRef);
            
            const batch = [];
            snapshot.forEach(doc => {
                batch.push(updateDoc(doc.ref, { 
                    [`deletedFor.${me.uid}`]: true 
                }));
            });
            
            await Promise.all(batch);
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С toast
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `<i class="fas fa-check text-green-500"></i><span>${currentLang === 'ru' ? 'Р ВРЎРѓРЎвЂљР С•РЎР‚Р С‘РЎРЏ Р С•РЎвЂЎР С‘РЎвЂ°Р ВµР Р…Р В°' : 'History cleared'}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        } catch (err) {
            console.error('Error clearing history:', err);
        }
    };

    window.blockUser = async () => {
        document.getElementById('chat-menu').classList.add('hidden');
        if (!activeChatPartner || !me) return;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р… Р В»Р С‘ РЎС“Р В¶Р Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ
        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};
        const blockedUsers = userData.blockedUsers || {};
        const isBlocked = blockedUsers[activeChatPartner.uid] === true;
        
        if (isBlocked) {
            // Р В Р В°Р В·Р В±Р В»Р С•Р С”Р С‘РЎР‚РЎС“Р ВµР С
            const confirmed = confirm(currentLang === 'ru' 
                ? `Р В Р В°Р В·Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ @${activeChatPartner.username}?` 
                : `Unblock @${activeChatPartner.username}?`);
            
            if (!confirmed) return;
            
            try {
                delete blockedUsers[activeChatPartner.uid];
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                    blockedUsers: blockedUsers
                });
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р С”РЎРЊРЎв‚¬
                if (me.blockedUsers) delete me.blockedUsers[activeChatPartner.uid];
                
                // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С toast
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'notification-toast';
                toast.innerHTML = `<i class="fas fa-check text-green-500"></i><span>${currentLang === 'ru' ? 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ РЎР‚Р В°Р В·Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…' : 'User unblocked'}</span>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            } catch (err) {
                console.error('Error unblocking user:', err);
            }
        } else {
            // Р вЂР В»Р С•Р С”Р С‘РЎР‚РЎС“Р ВµР С
            const confirmed = confirm(currentLang === 'ru' 
                ? `Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ @${activeChatPartner.username}? Р вЂ™РЎвЂ№ Р Р…Р Вµ РЎРѓР СР С•Р В¶Р ВµРЎвЂљР Вµ Р С—Р С•Р В»РЎС“РЎвЂЎР В°РЎвЂљРЎРЉ Р С•РЎвЂљ Р Р…Р ВµР С–Р С• РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ.` 
                : `Block @${activeChatPartner.username}? You won't receive messages from them.`);
            
            if (!confirmed) return;
            
            try {
                blockedUsers[activeChatPartner.uid] = true;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                    blockedUsers: blockedUsers
                });
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р С”РЎРЊРЎв‚¬
                if (!me.blockedUsers) me.blockedUsers = {};
                me.blockedUsers[activeChatPartner.uid] = true;
                
                // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С toast
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'notification-toast';
                toast.innerHTML = `<i class="fas fa-ban text-red-500"></i><span>${currentLang === 'ru' ? 'Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…' : 'User blocked'}</span>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            } catch (err) {
                console.error('Error blocking user:', err);
            }
        }
    };

    // Р С›Р В±РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С” Enter Р Т‘Р В»РЎРЏ Р С•Р В±Р С•Р С‘РЎвЂ¦ input
    const msgInput = document.getElementById('msg-input');
    const msgInputDesktop = document.getElementById('msg-input-desktop');
    if (msgInput) msgInput.onkeydown = e => { if(e.key === 'Enter') sendMsg(); };
    if (msgInputDesktop) msgInputDesktop.onkeydown = e => { if(e.key === 'Enter') sendMsg(); };

    // ========== Р вЂњРЎР‚РЎС“Р С—Р С—Р С•Р Р†РЎвЂ№Р Вµ РЎвЂЎР В°РЎвЂљРЎвЂ№ ==========
    let selectedGroupMembers = [];
    let groupChatsUnsub = null;
    let activeGroup = null;

    window.openCreateGroup = () => {
        selectedGroupMembers = [];
        document.getElementById('create-group-modal').classList.remove('hidden');
        document.getElementById('group-name-input').value = '';
        document.getElementById('selected-members').innerHTML = '';
        document.getElementById('group-search-results').innerHTML = '';
        document.getElementById('selected-count').innerText = '0';
        document.getElementById('create-group-btn').disabled = true;
        document.getElementById('group-search-input').value = '';
    };

    window.closeCreateGroup = (event) => {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('create-group-modal').classList.add('hidden');
    };

    window.addGroupMember = (user) => {
        if (selectedGroupMembers.length >= 12) {
            alert(currentLang === 'ru' ? 'Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 12 РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†' : 'Maximum 12 members');
            return;
        }
        if (selectedGroupMembers.find(m => m.uid === user.uid)) return;
        selectedGroupMembers.push(user);
        updateSelectedMembers();
        document.getElementById('group-search-input').value = '';
        document.getElementById('group-search-results').innerHTML = '';
    };

    window.removeGroupMember = (uid) => {
        selectedGroupMembers = selectedGroupMembers.filter(m => m.uid !== uid);
        updateSelectedMembers();
    };

    function updateSelectedMembers() {
        const container = document.getElementById('selected-members');
        const countEl = document.getElementById('selected-count');
        const createBtn = document.getElementById('create-group-btn');
        
        container.innerHTML = selectedGroupMembers.map(m => `
            <div class="flex items-center gap-1 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 px-2 py-1 rounded-full text-xs">
                <span>@${m.username}</span>
                <button onclick="removeGroupMember('${m.uid}')" class="w-4 h-4 rounded-full hover:bg-indigo-200 dark:hover:bg-indigo-800 flex items-center justify-center">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </div>
        `).join('');
        
        countEl.innerText = selectedGroupMembers.length;
        createBtn.disabled = selectedGroupMembers.length < 1 || !document.getElementById('group-name-input').value.trim();
    }

    // Р СџР С•Р С‘РЎРѓР С” Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„– Р Т‘Р В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№
    document.getElementById('group-search-input')?.addEventListener('input', async (e) => {
        const searchQuery = e.target.value.trim().toLowerCase();
        const resultsDiv = document.getElementById('group-search-results');
        
        if (searchQuery.length < 2) {
            resultsDiv.innerHTML = '';
            return;
        }
        
        try {
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const snapshot = await getDocs(usersRef);
            
            resultsDiv.innerHTML = '';
            
            snapshot.forEach(docSnap => {
                const user = docSnap.data();
                if (user.deleted || docSnap.id === me.uid) return;
                if (!user.username.toLowerCase().includes(searchQuery)) return;
                if (selectedGroupMembers.find(m => m.uid === docSnap.id)) return;
                
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-colors';
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center font-bold overflow-hidden">
                        ${user.avatar ? `<img src="${user.avatar}" class="w-full h-full object-cover">` : user.username[0].toUpperCase()}
                    </div>
                    <span class="font-medium">@${user.username}</span>
                `;
                div.onclick = () => addGroupMember({ uid: docSnap.id, username: user.username, avatar: user.avatar });
                resultsDiv.appendChild(div);
            });
            
            if (resultsDiv.children.length === 0) {
                resultsDiv.innerHTML = `<p class="text-center text-slate-400 text-sm py-4">${currentLang === 'ru' ? 'Р СњР С‘Р С”РЎвЂљР С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…' : 'No one found'}</p>`;
            }
        } catch (err) {
            console.error('Error searching users:', err);
        }
    });

    document.getElementById('group-name-input')?.addEventListener('input', updateSelectedMembers);

    window.createGroup = async () => {
        const groupName = document.getElementById('group-name-input').value.trim();
        if (!groupName || selectedGroupMembers.length < 1) return;
        
        const memberIds = [me.uid, ...selectedGroupMembers.map(m => m.uid)];
        const memberNames = { [me.uid]: me.username };
        selectedGroupMembers.forEach(m => memberNames[m.uid] = m.username);
        
        try {
            const groupRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), {
                name: groupName,
                members: memberIds,
                memberNames: memberNames,
                createdBy: me.uid,
                createdAt: serverTimestamp(),
                lastMessage: null,
                lastMessageTime: serverTimestamp()
            });
            
            closeCreateGroup();
            
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `<i class="fas fa-check text-green-500"></i><span>${currentLang === 'ru' ? 'Р вЂњРЎР‚РЎС“Р С—Р С—Р В° РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р В°!' : 'Group created!'}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2000);
            
            selectGroup({ id: groupRef.id, name: groupName, members: memberIds, memberNames });
        } catch (err) {
            console.error('Error creating group:', err);
        }
    };

    window.selectGroup = async (group) => {
        // Р С›РЎвЂљР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР СРЎРѓРЎРЏ Р С•РЎвЂљ Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР С–Р С• РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
        if (activeGroupCallUnsub) {
            activeGroupCallUnsub();
            activeGroupCallUnsub = null;
        }
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎР‚РЎвЂ№Р в„– Р В±Р В°Р Р…Р Р…Р ВµРЎР‚
        const oldBanner = document.getElementById('group-call-banner');
        if (oldBanner) oldBanner.remove();
        
        activeGroup = group;
        activeChatPartner = null;
        
        document.getElementById('chat-placeholder').classList.add('hidden');
        document.getElementById('active-chat').classList.remove('hidden');
        document.getElementById('target-avatar').innerHTML = `<i class="fas fa-users text-indigo-500"></i>`;
        document.getElementById('target-name').innerText = group.name;
        
        // Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…Р В°РЎРЏ Р Р…Р В°Р Р†Р С‘Р С–Р В°РЎвЂ Р С‘РЎРЏ - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂЎР В°РЎвЂљ
        mobileShowChat();
        if (isMobileView) history.pushState({ chat: true }, '');
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ Р Т‘Р В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—
        document.getElementById('online-status').style.display = 'none';
        document.getElementById('online-indicator').classList.add('hidden');
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р С•Р Р† Р Т‘Р В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—
        const callBtns = document.querySelectorAll('[onclick^="startCall"]');
        callBtns.forEach(btn => btn.style.display = '');
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚РЎвЂ№ Р В·Р В°Р С—РЎР‚Р С•РЎРѓР С•Р Р† (Р Р…Р Вµ Р Р…РЎС“Р В¶Р Р…РЎвЂ№ Р Т‘Р В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—)
        document.getElementById('chat-request-banner')?.classList.add('hidden');
        document.getElementById('chat-pending-banner')?.classList.add('hidden');
        document.querySelector('#active-chat footer')?.classList.remove('hidden');
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С” Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р Вµ
        checkAndShowActiveGroupCall(group.id);
        
        // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В·Р В°Р С”РЎР‚Р ВµР С—Р В»РЎвЂР Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
        loadPinnedMessage(true);
        
        if (msgUnsub) msgUnsub();
        
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'groups', group.id, 'messages'), orderBy('timestamp', 'asc'));
        
        msgUnsub = onSnapshot(q, (snap) => {
            const cont = document.getElementById('messages-container');
            const shouldScroll = cont.scrollTop + cont.offsetHeight >= cont.scrollHeight - 100;
            cont.innerHTML = '';
            
            snap.forEach(d => {
                const m = d.data();
                const msgId = d.id;
                if (m.deleted) return;
                
                const div = document.createElement('div');
                const isMine = m.senderId === me.uid;
                div.className = `message-bubble p-4 shadow-sm ${isMine ? 'sent' : 'received'}`;
                div.dataset.msgId = msgId;
                div.dataset.senderId = m.senderId;
                
                const senderName = group.memberNames[m.senderId] || m.senderName || 'Unknown';
                
                // Р вЂњР С•Р В»Р С•РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р В°РЎвЂ¦
                if (m.type === 'poll') {
                    const pollHtml = renderPollMessage(m, msgId, isMine);
                    div.className = `message-bubble p-3 shadow-sm ${isMine ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        ${!isMine ? `<p class="text-xs text-indigo-500 font-bold mb-2">@${senderName}</p>` : ''}
                        ${pollHtml}
                        <span class="text-[9px] block mt-2 opacity-50 text-right">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</span>
                    `;
                    cont.appendChild(div);
                    return;
                }
                
                // Р вЂњР ВµР С•Р В»Р С•Р С”Р В°РЎвЂ Р С‘РЎРЏ Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р В°РЎвЂ¦
                if (m.type === 'location') {
                    const locationHtml = renderLocationMessage(m);
                    div.className = `message-bubble p-2 shadow-sm ${isMine ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        ${!isMine ? `<p class="text-xs text-indigo-500 font-bold mb-2">@${senderName}</p>` : ''}
                        ${locationHtml}
                        <span class="text-[9px] block mt-1 opacity-50 text-right">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</span>
                    `;
                    cont.appendChild(div);
                    return;
                }
                
                // Р СљР ВµРЎР‚Р С•Р С—РЎР‚Р С‘РЎРЏРЎвЂљР С‘Р Вµ Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р В°РЎвЂ¦
                if (m.type === 'event') {
                    const eventHtml = renderEventMessage(m, msgId);
                    div.className = `message-bubble p-0 shadow-sm overflow-hidden ${isMine ? 'sent' : 'received'}`;
                    div.innerHTML = eventHtml;
                    cont.appendChild(div);
                    return;
                }
                
                let displayText = m.text || '';
                if (m.encrypted && displayText) displayText = decrypt(displayText);
                
                // Р В¦Р С‘РЎвЂљР В°РЎвЂљР В° Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°
                let replyQuoteHtml = '';
                if (m.replyTo) {
                    replyQuoteHtml = `
                        <div class="reply-quote" onclick="scrollToMessage('${m.replyTo.msgId}')">
                            <div class="reply-quote-author">${m.replyTo.author}</div>
                            <div class="reply-quote-text">${m.replyTo.text}</div>
                        </div>
                    `;
                }
                
                // Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°Р Р…Р Р…Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
                let forwardedHtml = '';
                if (m.forwarded) {
                    forwardedHtml = `<div class="forwarded-label"><i class="fas fa-share"></i> Р СџР ВµРЎР‚Р ВµРЎРѓР В»Р В°Р Р…Р С• Р С•РЎвЂљ ${m.forwardedFrom}</div>`;
                }
                
                // Р В Р ВµР В°Р С”РЎвЂ Р С‘Р С‘
                const reactionsHtml = renderReactions(m.reactions, msgId, true);
                
                // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С linkify Р Т‘Р В»РЎРЏ РЎвЂљР ВµР С”РЎРѓРЎвЂљР С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
                const linkedText = (!m.type || m.type === 'text') ? linkifyText(displayText) : displayText;
                
                div.innerHTML = `
                    <div class="swipe-reply-hint"><i class="fas fa-reply"></i></div>
                    ${forwardedHtml}
                    ${replyQuoteHtml}
                    ${!isMine ? `<p class="text-xs text-indigo-500 font-bold mb-1 sender-name-${m.senderId}">@${senderName}</p>` : ''}
                    <p class="text-sm leading-relaxed">${linkedText}</p>
                    ${reactionsHtml}
                    <span class="text-[9px] block mt-1 opacity-50 text-right">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</span>
                `;
                
                // Р С’РЎРѓР С‘Р Р…РЎвЂ¦РЎР‚Р С•Р Р…Р Р…Р С• Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Premium badge Р Т‘Р В»РЎРЏ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљР ВµР В»РЎРЏ
                if (!isMine) {
                    loadUserPremiumStatus(m.senderId, (hasPrem) => {
                        if (hasPrem) {
                            const nameEl = div.querySelector(`.sender-name-${m.senderId}`);
                            if (nameEl && !nameEl.querySelector('.premium-badge-small')) {
                                nameEl.innerHTML = `@${senderName} ${getPremiumBadgeHtml(true)}`;
                            }
                        }
                    });
                }
                
                // Р С™Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР Р…Р С•Р Вµ Р СР ВµР Р…РЎР‹
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showMessageContextMenu(e, msgId, isMine, m.text, m.encrypted, m.type);
                });
                
                // Р вЂќР С•Р В»Р С–Р С•Р Вµ Р Р…Р В°Р В¶Р В°РЎвЂљР С‘Р Вµ Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
                setupLongPress(div, (e) => {
                    const touch = e.touches ? e.touches[0] : e;
                    showMessageContextMenu({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => {} }, msgId, isMine, m.text, m.encrypted, m.type);
                });
                
                // Р вЂќР Р†Р С•Р в„–Р Р…Р С•Р в„– Р С”Р В»Р С‘Р С” Р Т‘Р В»РЎРЏ Р В±РЎвЂ№РЎРѓРЎвЂљРЎР‚Р С•Р в„– РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘Р С‘ РІСњВ¤РїС‘РЏ
                div.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    addReaction(msgId, 'РІСњВ¤РїС‘РЏ', true);
                });
                
                // Р РЋР Р†Р В°Р в„–Р С— Р Р†Р С—РЎР‚Р В°Р Р†Р С• Р Т‘Р В»РЎРЏ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° (Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№Р Вµ)
                setupSwipeToReply(div, msgId, true);
                
                cont.appendChild(div);
                
                // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ РЎРѓРЎРѓРЎвЂ№Р В»Р С•Р С” Р Т‘Р В»РЎРЏ РЎвЂљР ВµР С”РЎРѓРЎвЂљР С•Р Р†РЎвЂ№РЎвЂ¦ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
                if ((!m.type || m.type === 'text') && displayText) {
                    loadLinkPreviewForMessage(div, displayText);
                }
            });
            
            if (shouldScroll) cont.scrollTop = cont.scrollHeight;
        });
    };
    
    // Р СџР С•Р С”Р В°Р В·Р В°РЎвЂљРЎРЉ Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р Вµ
    async function checkAndShowActiveGroupCall(groupId) {
        if (activeGroupCallUnsub) activeGroupCallUnsub();
        
        const groupCallsRef = collection(db, 'artifacts', appId, 'public', 'data', 'group_calls');
        const q = query(groupCallsRef, where('groupId', '==', groupId), where('status', '==', 'active'));
        
        activeGroupCallUnsub = onSnapshot(q, (snap) => {
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎР‚РЎвЂ№Р в„– Р В±Р В°Р Р…Р Р…Р ВµРЎР‚
            const oldBanner = document.getElementById('group-call-banner');
            if (oldBanner) oldBanner.remove();
            
            // Р вЂўРЎРѓР В»Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р В° Р Р…Р ВµРЎвЂљ - Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘Р С‘Р С (Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ РЎС“Р В¶Р Вµ РЎС“Р Т‘Р В°Р В»Р ВµР Р… Р Р†РЎвЂ№РЎв‚¬Р Вµ)
            if (snap.empty) return;
            
            // Р вЂ™Р С’Р вЂ“Р СњР С›: Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎвЂЎРЎвЂљР С• Р СРЎвЂ№ Р Р†РЎРѓР Вµ Р ВµРЎвЂ°Р Вµ Р Р† РЎРЊРЎвЂљР С•Р в„– Р С–РЎР‚РЎС“Р С—Р С—Р Вµ
            if (!activeGroup || activeGroup.id !== groupId) {
                // Р СљРЎвЂ№ РЎС“Р В¶Р Вµ Р Р…Р Вµ Р Р† РЎРЊРЎвЂљР С•Р в„– Р С–РЎР‚РЎС“Р С—Р С—Р Вµ - Р Р…Р Вµ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚
                return;
            }
            
            const callData = snap.docs[0].data();
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р Р†РЎР‚Р ВµР СРЎРЏ РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ Р В·Р Р†Р С•Р Р…Р С”Р В° - Р ВµРЎРѓР В»Р С‘ Р С—РЎР‚Р С•РЎв‚¬Р В»Р С• Р В±Р С•Р В»РЎРЉРЎв‚¬Р Вµ 2 РЎвЂЎР В°РЎРѓР С•Р Р†, РЎРѓРЎвЂЎР С‘РЎвЂљР В°Р ВµР С Р ВµР С–Р С• Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р Р…РЎвЂ№Р С
            if (callData.startedAt) {
                const startTime = callData.startedAt.seconds ? callData.startedAt.seconds * 1000 : callData.startedAt;
                const now = Date.now();
                const twoHours = 2 * 60 * 60 * 1000;
                
                if (now - startTime > twoHours) {
                    // Р вЂ”Р Р†Р С•Р Р…Р С•Р С” РЎРѓР В»Р С‘РЎв‚¬Р С”Р С•Р С РЎРѓРЎвЂљР В°РЎР‚РЎвЂ№Р в„– - Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р В°Р ВµР С Р ВµР С–Р С•
                    const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', snap.docs[0].id);
                    setDoc(callDocRef, { status: 'ended' }, { merge: true }).catch(e => console.error('Error ending old call:', e));
                    return;
                }
            }
            
            // Р СњР Вµ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ Р ВµРЎРѓР В»Р С‘ Р В·Р Р†Р С•Р Р…Р С•Р С” РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎвЂЎРЎвЂљР С• Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р С‘Р В»РЎРѓРЎРЏ Р С‘Р В»Р С‘ Р СРЎвЂ№ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р†РЎС“Р ВµР С Р Р† Р В·Р Р†Р С•Р Р…Р С”Р Вµ
            if (!isGroupCall && !groupCallJustEnded) {
                const callId = snap.docs[0].id;
                const participantCount = callData.participants?.length || 1;
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р Р…Р Вµ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р†РЎС“Р ВµР С Р В»Р С‘ Р СРЎвЂ№ РЎС“Р В¶Р Вµ Р Р† РЎРЊРЎвЂљР С•Р С Р В·Р Р†Р С•Р Р…Р С”Р Вµ
                if (callData.participants?.includes(me.uid)) return;
                
                // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚
                const banner = document.createElement('div');
                banner.id = 'group-call-banner';
                banner.className = 'p-3 bg-gradient-to-r from-green-500/20 to-emerald-500/20 border-b border-green-500/30 flex items-center justify-between animate-pulse';
                banner.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center">
                            <i class="fas fa-phone-alt text-white animate-bounce"></i>
                        </div>
                        <div>
                            <p class="font-bold text-green-600 dark:text-green-400">${currentLang === 'ru' ? 'Р С’Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”' : 'Active call'}</p>
                            <p class="text-xs text-green-500">${participantCount} ${currentLang === 'ru' ? 'РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”(Р С•Р Р†)' : 'participant(s)'} РІР‚Сћ ${callData.isVideo ? (currentLang === 'ru' ? 'Р вЂ™Р С‘Р Т‘Р ВµР С•' : 'Video') : (currentLang === 'ru' ? 'Р С’РЎС“Р Т‘Р С‘Р С•' : 'Audio')}</p>
                        </div>
                    </div>
                    <button onclick="joinGroupCall('${groupId}')" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold transition-all hover:scale-105">
                        <i class="fas fa-phone-alt mr-2"></i>${currentLang === 'ru' ? 'Р СџРЎР‚Р С‘РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р С‘РЎвЂљРЎРЉРЎРѓРЎРЏ' : 'Join'}
                    </button>
                `;
                
                // Р вЂ™РЎРѓРЎвЂљР В°Р Р†Р В»РЎРЏР ВµР С Р С—Р С•РЎРѓР В»Р Вµ header
                const header = document.querySelector('#active-chat header');
                if (header) header.after(banner);
            }
        });
    }

    // Р СџР ВµРЎР‚Р ВµР С•Р С—РЎР‚Р ВµР Т‘Р ВµР В»РЎРЏР ВµР С sendMsg Р Т‘Р В»РЎРЏ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С”Р С‘ Р С–РЎР‚РЎС“Р С—Р С—
    const originalSendMsgFunc = window.sendMsg;
    window.sendMsg = async (fileData) => {
        if (activeGroup) {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text && !fileData) return;
            
            resetTextarea(input);
            handleInputChange(); // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ Р Р…Р В° Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…
            const encryptedText = text ? encrypt(text) : '';
            
            // Р СџР С•Р Т‘Р С–Р С•РЎвЂљР В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
            const msgData = {
                senderId: me.uid,
                senderName: me.username,
                text: encryptedText,
                encrypted: true,
                timestamp: serverTimestamp(),
                ...fileData
            };
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В° Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
            if (replyingTo && replyingTo.isGroup) {
                msgData.replyTo = {
                    msgId: replyingTo.msgId,
                    text: replyingTo.text,
                    author: replyingTo.author,
                    senderId: replyingTo.senderId
                };
                cancelReply();
            }
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id, 'messages'), msgData);
                
                // Р СњР В°РЎвЂЎР С‘РЎРѓР В»РЎРЏР ВµР С РЎР‚РЎС“Р В±Р С‘Р Р…РЎвЂ№ Р В·Р В° Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”РЎС“ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р Р† Р С–РЎР‚РЎС“Р С—Р С—РЎС“
                earnRubies(RUBY_PER_MESSAGE);
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), {
                    lastMessage: text.substring(0, 50),
                    lastMessageTime: serverTimestamp()
                }, { merge: true });
            } catch (err) {
                console.error('Error sending group message:', err);
            }
        } else if (originalSendMsgFunc) {
            originalSendMsgFunc(fileData);
        }
    };

    function listenToGroups() {
        if (groupChatsUnsub) groupChatsUnsub();
        
        const groupsRef = collection(db, 'artifacts', appId, 'public', 'data', 'groups');
        
        groupChatsUnsub = onSnapshot(groupsRef, (snap) => {
            snap.forEach(d => {
                const group = d.data();
                if (!group.members || !group.members.includes(me.uid)) return;
                
                const chatsList = document.getElementById('chats-list');
                let existingEl = document.querySelector(`[data-group-id="${d.id}"]`);
                
                if (!existingEl) {
                    existingEl = document.createElement('div');
                    existingEl.dataset.groupId = d.id;
                    existingEl.className = 'flex items-center space-x-3 p-3 rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-all';
                    existingEl.onclick = () => selectGroup({ id: d.id, ...group });
                    chatsList.insertBefore(existingEl, chatsList.firstChild);
                }
                
                const memberCount = group.members.length;
                existingEl.innerHTML = `
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 text-white flex items-center justify-center font-bold shadow-lg relative">
                        <i class="fas fa-users"></i>
                        <div class="group-call-indicator hidden absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center animate-pulse" data-group-call="${d.id}">
                            <i class="fas fa-phone-alt text-white text-[8px]"></i>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <p class="font-bold truncate">${group.name}</p>
                            <span class="text-[10px] text-slate-400">${memberCount} СЂСџвЂТђ</span>
                        </div>
                        <p class="text-xs text-slate-400 truncate group-last-msg">${group.lastMessage || (currentLang === 'ru' ? 'Р СњР ВµРЎвЂљ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–' : 'No messages')}</p>
                    </div>
                `;
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С” Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р Вµ
                checkGroupActiveCall(d.id);
            });
        });
    }
    
    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° Р Р† Р С–РЎР‚РЎС“Р С—Р С—Р Вµ
    async function checkGroupActiveCall(groupId) {
        const groupCallsRef = collection(db, 'artifacts', appId, 'public', 'data', 'group_calls');
        const q = query(groupCallsRef, where('groupId', '==', groupId), where('status', '==', 'active'));
        
        onSnapshot(q, (snap) => {
            const indicator = document.querySelector(`[data-group-call="${groupId}"]`);
            const lastMsgEl = document.querySelector(`[data-group-id="${groupId}"] .group-last-msg`);
            
            if (!snap.empty) {
                // Р вЂўРЎРѓРЎвЂљРЎРЉ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
                if (indicator) indicator.classList.remove('hidden');
                if (lastMsgEl) {
                    const callData = snap.docs[0].data();
                    const participantCount = callData.participants?.length || 1;
                    lastMsgEl.innerHTML = `<span class="text-green-500"><i class="fas fa-phone-alt mr-1"></i>${currentLang === 'ru' ? 'Р вЂ”Р Р†Р С•Р Р…Р С•Р С”' : 'Call'} (${participantCount})</span>`;
                }
            } else {
                // Р вЂ”Р Р†Р С•Р Р…Р С•Р С” Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬РЎвЂР Р… - РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С‘Р Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚ Р С‘ Р С•РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С РЎвЂљР ВµР С”РЎРѓРЎвЂљ
                if (indicator) indicator.classList.add('hidden');
                if (lastMsgEl && lastMsgEl.innerHTML.includes('fa-phone-alt')) {
                    lastMsgEl.innerHTML = '';
                }
            }
        });
    }
    
    // Р СџРЎР‚Р С‘РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р С‘РЎвЂљРЎРЉРЎРѓРЎРЏ Р С” Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р СРЎС“ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р СРЎС“ Р В·Р Р†Р С•Р Р…Р С”РЎС“
    window.joinGroupCall = async (groupId) => {
        // Р СњР В°РЎвЂ¦Р С•Р Т‘Р С‘Р С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
        const groupCallsRef = collection(db, 'artifacts', appId, 'public', 'data', 'group_calls');
        const q = query(groupCallsRef, where('groupId', '==', groupId), where('status', '==', 'active'));
        const snap = await getDocs(q);
        
        if (snap.empty) {
            alert(currentLang === 'ru' ? 'Р вЂ”Р Р†Р С•Р Р…Р С•Р С” РЎС“Р В¶Р Вµ Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬РЎвЂР Р…' : 'Call has ended');
            return;
        }
        
        const callDoc = snap.docs[0];
        const callData = callDoc.data();
        
        // Р СџРЎР‚Р С‘РЎРѓР С•Р ВµР Т‘Р С‘Р Р…РЎРЏР ВµР СРЎРѓРЎРЏ Р С”Р В°Р С” Р В±РЎС“Р Т‘РЎвЂљР С• Р С—РЎР‚Р С‘Р Р…РЎРЏР В»Р С‘ Р В·Р Р†Р С•Р Р…Р С•Р С”
        await acceptGroupCall({
            callId: callDoc.id,
            isVideo: callData.isVideo,
            groupName: callData.groupName,
            groupId: callData.groupId,
            isGroupCall: true
        });
    };

    // ========== Р РЋР С‘РЎРѓРЎвЂљР ВµР СР В° Р В·Р В°Р С—РЎР‚Р С•РЎРѓР С•Р Р† Р Р…Р В° Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ ==========
    let currentChatStatus = null; // 'pending', 'accepted', 'declined', null

    async function checkChatPermission() {
        if (!activeChatPartner || !me) return;
        
        // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”РЎС“ Р Т‘Р В»РЎРЏ "Р ВР В·Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С•" - РЎРЊРЎвЂљР С• РЎвЂЎР В°РЎвЂљ РЎРѓ РЎРѓР В°Р СР С‘Р С РЎРѓР С•Р В±Р С•Р в„–
        if (activeChatPartner.uid && activeChatPartner.uid.startsWith('saved_')) {
            currentChatStatus = 'accepted';
            document.getElementById('chat-request-banner')?.classList.add('hidden');
            document.getElementById('chat-pending-banner')?.classList.add('hidden');
            document.querySelector('#active-chat footer')?.classList.remove('hidden');
            return;
        }
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        try {
            const chatDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'meta', 'permission'));
            
            const requestBanner = document.getElementById('chat-request-banner');
            const pendingBanner = document.getElementById('chat-pending-banner');
            const footer = document.querySelector('#active-chat footer');
            
            if (!chatDoc.exists()) {
                // Р СњР С•Р Р†РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ - Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р ВµРЎРѓРЎвЂљРЎРЉ Р В»Р С‘ РЎС“Р В¶Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ
                const messagesSnap = await getDocs(query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'),
                    limit(1)
                ));
                
                if (messagesSnap.empty) {
                    // Р РЋР С•Р Р†РЎРѓР ВµР С Р Р…Р С•Р Р†РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ - РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р В°Р ВµР С Р С—Р С‘РЎРѓР В°РЎвЂљРЎРЉ Р С—Р ВµРЎР‚Р Р†Р С•Р Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
                    currentChatStatus = null;
                    requestBanner.classList.add('hidden');
                    pendingBanner.classList.add('hidden');
                    footer.classList.remove('hidden');
                } else {
                    // Р вЂўРЎРѓРЎвЂљРЎРЉ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р Р…Р С• Р Р…Р ВµРЎвЂљ РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘РЎРЏ - РЎРѓРЎвЂљР В°РЎР‚РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ, РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р В°Р ВµР С
                    currentChatStatus = 'accepted';
                    requestBanner.classList.add('hidden');
                    pendingBanner.classList.add('hidden');
                    footer.classList.remove('hidden');
                }
                return;
            }
            
            const data = chatDoc.data();
            currentChatStatus = data.status;
            
            if (data.status === 'pending') {
                if (data.requestedBy === me.uid) {
                    // Р Р‡ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘Р В» Р В·Р В°Р С—РЎР‚Р С•РЎРѓ - Р В¶Р Т‘РЎС“ Р С•РЎвЂљР Р†Р ВµРЎвЂљР В°
                    requestBanner.classList.add('hidden');
                    pendingBanner.classList.remove('hidden');
                    footer.classList.add('hidden');
                } else {
                    // Р СљР Р…Р Вµ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘Р В»Р С‘ Р В·Р В°Р С—РЎР‚Р С•РЎРѓ - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°РЎР‹ Р С”Р Р…Р С•Р С—Р С”Р С‘
                    requestBanner.classList.remove('hidden');
                    pendingBanner.classList.add('hidden');
                    footer.classList.add('hidden');
                }
            } else if (data.status === 'accepted') {
                // Р В§Р В°РЎвЂљ Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљ - Р Р†РЎРѓРЎвЂ Р С•Р С”
                requestBanner.classList.add('hidden');
                pendingBanner.classList.add('hidden');
                footer.classList.remove('hidden');
            } else if (data.status === 'declined') {
                // Р В§Р В°РЎвЂљ Р С•РЎвЂљР С”Р В»Р С•Р Р…РЎвЂР Р…
                if (data.requestedBy === me.uid) {
                    requestBanner.classList.add('hidden');
                    pendingBanner.classList.add('hidden');
                    footer.classList.add('hidden');
                    // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ
                    document.getElementById('messages-container').innerHTML = `
                        <div class="flex-1 flex items-center justify-center">
                            <div class="text-center opacity-50">
                                <i class="fas fa-ban text-4xl mb-2"></i>
                                <p class="text-sm">${currentLang === 'ru' ? 'Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ Р С•РЎвЂљР С”Р В»Р С•Р Р…РЎвЂР Р…' : 'Request declined'}</p>
                            </div>
                        </div>
                    `;
                } else {
                    footer.classList.remove('hidden');
                }
            }
        } catch (err) {
            console.error('Error checking chat permission:', err);
        }
    }

    window.acceptChatRequest = async () => {
        if (!activeChatPartner || !me) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'meta', 'permission'), {
                status: 'accepted',
                acceptedAt: serverTimestamp()
            }, { merge: true });
            
            document.getElementById('chat-request-banner').classList.add('hidden');
            document.querySelector('#active-chat footer').classList.remove('hidden');
            currentChatStatus = 'accepted';
            
            // Toast
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `<i class="fas fa-check text-green-500"></i><span>${currentLang === 'ru' ? 'Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљ' : 'Request accepted'}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2000);
        } catch (err) {
            console.error('Error accepting request:', err);
        }
    };

    window.declineChatRequest = async () => {
        if (!activeChatPartner || !me) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'meta', 'permission'), {
                status: 'declined',
                declinedAt: serverTimestamp()
            }, { merge: true });
            
            document.getElementById('chat-request-banner').classList.add('hidden');
            currentChatStatus = 'declined';
            
            // Toast
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `<i class="fas fa-ban text-red-500"></i><span>${currentLang === 'ru' ? 'Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ Р С•РЎвЂљР С”Р В»Р С•Р Р…РЎвЂР Р…' : 'Request declined'}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2000);
        } catch (err) {
            console.error('Error declining request:', err);
        }
    };

    async function sendChatRequest() {
        if (!activeChatPartner || !me) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'meta', 'permission'), {
                status: 'pending',
                requestedBy: me.uid,
                requestedAt: serverTimestamp()
            });
            
            currentChatStatus = 'pending';
            document.getElementById('chat-pending-banner').classList.remove('hidden');
            document.querySelector('#active-chat footer').classList.add('hidden');
        } catch (err) {
            console.error('Error sending chat request:', err);
        }
    }

    document.addEventListener('mousedown', (e) => {
        const emojiPanel = document.getElementById('emoji-panel');
        if (!emojiPanel.contains(e.target) && !e.target.closest('button')) {
            emojiPanel.classList.remove('active');
        }
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С AI Р С—Р В°Р Р…Р ВµР В»РЎРЉ Р С—РЎР‚Р С‘ Р С”Р В»Р С‘Р С”Р Вµ Р Р†Р Р…Р Вµ Р ВµРЎвЂ
        const aiPanel = document.getElementById('ai-panel');
        if (aiPanel && !aiPanel.contains(e.target) && !e.target.closest('button[onclick="toggleAI()"]')) {
            aiPanel.classList.add('hidden');
        }
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР ВµР Р…РЎР‹ РЎвЂЎР В°РЎвЂљР В° Р С—РЎР‚Р С‘ Р С”Р В»Р С‘Р С”Р Вµ Р Р†Р Р…Р Вµ Р ВµР С–Р С•
        const chatMenu = document.getElementById('chat-menu');
        if (chatMenu && !chatMenu.contains(e.target) && !e.target.closest('button[onclick="toggleChatMenu()"]')) {
            chatMenu.classList.add('hidden');
        }
    });

    // ========== WebRTC Р вЂ”Р Р†Р С•Р Р…Р С”Р С‘ ==========
    const iceServers = {
        iceServers: [
            // STUN РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚ (Google - РЎРѓР В°Р СРЎвЂ№Р в„– Р Р…Р В°Р Т‘РЎвЂР В¶Р Р…РЎвЂ№Р в„–)
            { urls: 'stun:stun.l.google.com:19302' },
            // TURN РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚РЎвЂ№ (Metered - Р В±Р ВµРЎРѓР С—Р В»Р В°РЎвЂљР Р…РЎвЂ№Р Вµ, Р Т‘Р В»РЎРЏ NAT traversal)
            {
                urls: 'turn:a.relay.metered.ca:80',
                username: 'e8dd65c92ae1c41e43b88a94',
                credential: 'uWdWNmkhvyqTmFnQ'
            },
            {
                urls: 'turn:a.relay.metered.ca:443',
                username: 'e8dd65c92ae1c41e43b88a94',
                credential: 'uWdWNmkhvyqTmFnQ'
            },
            {
                urls: 'turn:a.relay.metered.ca:443?transport=tcp',
                username: 'e8dd65c92ae1c41e43b88a94',
                credential: 'uWdWNmkhvyqTmFnQ'
            }
        ],
        iceCandidatePoolSize: 10
    };

    // Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р С”Р В°РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р В° Р Р†Р С‘Р Т‘Р ВµР С• Р Т‘Р В»РЎРЏ SDP
    function setVideoBitrate(sdp, bitrate = 2500) {
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р В±Р С‘РЎвЂљРЎР‚Р ВµР в„–РЎвЂљ Р Т‘Р В»РЎРЏ Р Р†Р С‘Р Т‘Р ВµР С• (2.5 Mbps Р Т‘Р В»РЎРЏ 1080p)
        let lines = sdp.split('\n');
        let newLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            newLines.push(lines[i]);
            if (lines[i].indexOf('m=video') === 0) {
                newLines.push(`b=AS:${bitrate}`);
            }
        }
        
        return newLines.join('\n');
    }

    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    let currentCallId = null;
    let callTimerInterval = null;
    let callStartTime = null;
    let isVideoCall = false;
    let callUnsub = null;
    let callWasAnswered = false; // Р вЂРЎвЂ№Р В» Р В»Р С‘ Р В·Р Р†Р С•Р Р…Р С•Р С” Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљ
    let isOutgoingCall = false; // Р ВРЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р в„– Р В»Р С‘ Р В·Р Р†Р С•Р Р…Р С•Р С”
    let isMuted = false;
    let isVideoOff = false;
    let isScreenSharing = false;
    let originalVideoTrack = null;
    let callRubyInterval = null; // Р ВР Р…РЎвЂљР ВµРЎР‚Р Р†Р В°Р В» Р Р…Р В°РЎвЂЎР С‘РЎРѓР В»Р ВµР Р…Р С‘РЎРЏ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р В·Р В° Р В·Р Р†Р С•Р Р…Р С•Р С”

    // Р С™Р В°РЎРѓРЎвЂљР С•Р СР Р…РЎвЂ№Р в„– РЎР‚Р С‘Р Р…Р С–РЎвЂљР С•Р Р… (РЎРѓР СР ВµРЎРѓРЎРЉ Discord + Telegram РЎРѓРЎвЂљР С‘Р В»РЎРЏ)
    let ringtoneCtx = null;
    let ringtoneInterval = null;
    let ringtoneGain = null;
    
    const ringtone = {
        _playing: false,
        loop: true,
        volume: 0.7,
        
        play: function() {
            if (this._playing) return Promise.resolve();
            this._playing = true;
            
            try {
                ringtoneCtx = new (window.AudioContext || window.webkitAudioContext)();
                ringtoneGain = ringtoneCtx.createGain();
                ringtoneGain.connect(ringtoneCtx.destination);
                ringtoneGain.gain.value = this.volume;
                
                const playTone = () => {
                    if (!this._playing) return;
                    
                    // Р СџР ВµРЎР‚Р Р†РЎвЂ№Р в„– РЎвЂљР С•Р Р… (Р Р†РЎвЂ№РЎРѓР С•Р С”Р С‘Р в„–, Р С”Р В°Р С” Discord)
                    const osc1 = ringtoneCtx.createOscillator();
                    const gain1 = ringtoneCtx.createGain();
                    osc1.connect(gain1);
                    gain1.connect(ringtoneGain);
                    osc1.frequency.value = 880;
                    osc1.type = 'sine';
                    gain1.gain.setValueAtTime(0.3, ringtoneCtx.currentTime);
                    gain1.gain.exponentialRampToValueAtTime(0.01, ringtoneCtx.currentTime + 0.15);
                    osc1.start(ringtoneCtx.currentTime);
                    osc1.stop(ringtoneCtx.currentTime + 0.15);
                    
                    // Р вЂ™РЎвЂљР С•РЎР‚Р С•Р в„– РЎвЂљР С•Р Р… (Р Р…Р С‘Р В¶Р Вµ, Р СРЎРЏР С–РЎвЂЎР Вµ - Р С”Р В°Р С” Telegram)
                    setTimeout(() => {
                        if (!this._playing) return;
                        const osc2 = ringtoneCtx.createOscillator();
                        const gain2 = ringtoneCtx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(ringtoneGain);
                        osc2.frequency.value = 659;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.25, ringtoneCtx.currentTime);
                        gain2.gain.exponentialRampToValueAtTime(0.01, ringtoneCtx.currentTime + 0.2);
                        osc2.start(ringtoneCtx.currentTime);
                        osc2.stop(ringtoneCtx.currentTime + 0.2);
                    }, 180);
                    
                    // Р СћРЎР‚Р ВµРЎвЂљР С‘Р в„– РЎвЂљР С•Р Р… (Р ВµРЎвЂ°РЎвЂ Р Р…Р С‘Р В¶Р Вµ, Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р В°РЎР‹РЎвЂ°Р С‘Р в„–)
                    setTimeout(() => {
                        if (!this._playing) return;
                        const osc3 = ringtoneCtx.createOscillator();
                        const gain3 = ringtoneCtx.createGain();
                        osc3.connect(gain3);
                        gain3.connect(ringtoneGain);
                        osc3.frequency.value = 523;
                        osc3.type = 'sine';
                        gain3.gain.setValueAtTime(0.2, ringtoneCtx.currentTime);
                        gain3.gain.exponentialRampToValueAtTime(0.01, ringtoneCtx.currentTime + 0.25);
                        osc3.start(ringtoneCtx.currentTime);
                        osc3.stop(ringtoneCtx.currentTime + 0.25);
                    }, 380);
                };
                
                playTone();
                if (this.loop) {
                    ringtoneInterval = setInterval(playTone, 2000);
                }
            } catch(e) {
                console.log('Audio error:', e);
            }
            
            return Promise.resolve();
        },
        
        pause: function() {
            this._playing = false;
            if (ringtoneInterval) {
                clearInterval(ringtoneInterval);
                ringtoneInterval = null;
            }
            if (ringtoneCtx) {
                ringtoneCtx.close().catch(() => {});
                ringtoneCtx = null;
            }
        },
        
        get currentTime() { return 0; },
        set currentTime(v) {}
    };

    // Р вЂ”Р Р†РЎС“Р С” Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° (Р С–РЎС“Р Т‘Р С”Р С‘ Р С”Р В°Р С” Р Р† РЎвЂљР ВµР В»Р ВµРЎвЂћР С•Р Р…Р Вµ)
    let dialToneCtx = null;
    let dialToneInterval = null;
    
    const dialTone = {
        _playing: false,
        loop: true,
        volume: 0.4,
        
        play: function() {
            if (this._playing) return Promise.resolve();
            this._playing = true;
            
            try {
                dialToneCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                const playBeep = () => {
                    if (!this._playing || !dialToneCtx) return;
                    
                    // Р С™Р В»Р В°РЎРѓРЎРѓР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘Р в„– РЎвЂљР ВµР В»Р ВµРЎвЂћР С•Р Р…Р Р…РЎвЂ№Р в„– Р С–РЎС“Р Т‘Р С•Р С” (Р Т‘Р Р†Р В° РЎвЂљР С•Р Р…Р В°)
                    const osc1 = dialToneCtx.createOscillator();
                    const osc2 = dialToneCtx.createOscillator();
                    const gain = dialToneCtx.createGain();
                    
                    osc1.connect(gain);
                    osc2.connect(gain);
                    gain.connect(dialToneCtx.destination);
                    
                    // Р В§Р В°РЎРѓРЎвЂљР С•РЎвЂљРЎвЂ№ РЎвЂљР ВµР В»Р ВµРЎвЂћР С•Р Р…Р Р…Р С•Р С–Р С• Р С–РЎС“Р Т‘Р С”Р В° (425 Hz Р Р† Р вЂўР Р†РЎР‚Р С•Р С—Р Вµ, 440+480 Hz Р Р† Р РЋР РЃР С’)
                    osc1.frequency.value = 440;
                    osc2.frequency.value = 480;
                    osc1.type = 'sine';
                    osc2.type = 'sine';
                    
                    gain.gain.setValueAtTime(this.volume, dialToneCtx.currentTime);
                    gain.gain.setValueAtTime(this.volume, dialToneCtx.currentTime + 0.8);
                    gain.gain.exponentialRampToValueAtTime(0.01, dialToneCtx.currentTime + 0.85);
                    
                    osc1.start(dialToneCtx.currentTime);
                    osc2.start(dialToneCtx.currentTime);
                    osc1.stop(dialToneCtx.currentTime + 0.85);
                    osc2.stop(dialToneCtx.currentTime + 0.85);
                };
                
                playBeep();
                if (this.loop) {
                    dialToneInterval = setInterval(playBeep, 3000); // Р вЂњРЎС“Р Т‘Р С•Р С” Р С”Р В°Р В¶Р Т‘РЎвЂ№Р Вµ 3 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘РЎвЂ№
                }
            } catch(e) {
                console.log('Dial tone error:', e);
            }
            
            return Promise.resolve();
        },
        
        pause: function() {
            this._playing = false;
            if (dialToneInterval) {
                clearInterval(dialToneInterval);
                dialToneInterval = null;
            }
            if (dialToneCtx) {
                dialToneCtx.close().catch(() => {});
                dialToneCtx = null;
            }
        },
        
        get currentTime() { return 0; },
        set currentTime(v) {}
    };

    // Р вЂ”Р Р†РЎС“Р С” Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘РЎРЏ Р В·Р Р†Р С•Р Р…Р С”Р В°
    const endCallSound = {
        play: function() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Р СћРЎР‚Р С‘ Р Р…Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘РЎвЂ¦ РЎвЂљР С•Р Р…Р В° (Р С”Р В°Р С” Р С—РЎР‚Р С‘ Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р В°)
                const playEndTone = (freq, delay, duration) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    
                    gain.gain.setValueAtTime(0, ctx.currentTime + delay);
                    gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + delay + 0.02);
                    gain.gain.setValueAtTime(0.3, ctx.currentTime + delay + duration - 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + delay + duration);
                    
                    osc.start(ctx.currentTime + delay);
                    osc.stop(ctx.currentTime + delay + duration);
                };
                
                // Р СћРЎР‚Р С‘ Р С”Р С•РЎР‚Р С•РЎвЂљР С”Р С‘РЎвЂ¦ Р Р…Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘РЎвЂ¦ РЎвЂљР С•Р Р…Р В°
                playEndTone(880, 0, 0.15);      // Р вЂ™РЎвЂ№РЎРѓР С•Р С”Р С‘Р в„–
                playEndTone(698, 0.12, 0.15);   // Р РЋРЎР‚Р ВµР Т‘Р Р…Р С‘Р в„–
                playEndTone(523, 0.24, 0.2);    // Р СњР С‘Р В·Р С”Р С‘Р в„–
                
                // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљ Р С—Р С•РЎРѓР В»Р Вµ Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘РЎРЏ
                setTimeout(() => ctx.close().catch(() => {}), 500);
            } catch(e) {
                console.log('End call sound error:', e);
            }
            return Promise.resolve();
        }
    };

    // Р С›Р С—РЎР‚Р ВµР Т‘Р ВµР В»Р ВµР Р…Р С‘Р Вµ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…Р С•Р С–Р С• РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р В°
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
    }

    // Р СџР С•Р В»РЎС“РЎвЂЎР ВµР Р…Р С‘Р Вµ Р С•Р С—РЎвЂљР С‘Р СР В°Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С” Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р В°
    function getOptimalAudioConstraints() {
        const isMobile = isMobileDevice();
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (isMobile) {
            return {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                // Р РЋР С—Р ВµРЎвЂ Р С‘Р В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
                sampleRate: isIOS ? 48000 : 44100,
                channelCount: 1, // Р СљР С•Р Р…Р С• Р Т‘Р В»РЎРЏ РЎРѓРЎвЂљР В°Р В±Р С‘Р В»РЎРЉР Р…Р С•РЎРѓРЎвЂљР С‘ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦
                volume: 1.0,
                // Р вЂќР С•Р С—Р С•Р В»Р Р…Р С‘РЎвЂљР ВµР В»РЎРЉР Р…РЎвЂ№Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р Т‘Р В»РЎРЏ iOS
                ...(isIOS && {
                    latency: 0.01,
                    sampleSize: 16
                })
            };
        }
        
        return {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000,
            channelCount: 2
        };
    }

    // Р ВРЎРѓР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р В°РЎС“Р Т‘Р С‘Р С• Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР В° Р Т‘Р В»РЎРЏ iOS
    async function fixIOSAudioContext() {
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            try {
                // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р Р†РЎР‚Р ВµР СР ВµР Р…Р Р…РЎвЂ№Р в„– Р В°РЎС“Р Т‘Р С‘Р С• Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В·Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р С”Р С‘
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.value = 0; // Р вЂР ВµР В·Р В·Р Р†РЎС“РЎвЂЎР Р…Р С•
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
                
                await audioContext.close();
            } catch (e) {
                console.log('iOS audio context fix failed:', e);
            }
        }
    }

    // Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В° Р В°РЎС“Р Т‘Р С‘Р С• РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљР В° Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
    function setupMobileAudio(audioElement) {
        if (!audioElement) return;
        
        const isMobile = isMobileDevice();
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (isMobile) {
            audioElement.setAttribute('playsinline', 'true');
            audioElement.setAttribute('webkit-playsinline', 'true');
            audioElement.muted = false;
            
            if (isIOS) {
                // Р РЋР С—Р ВµРЎвЂ Р С‘Р В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р Т‘Р В»РЎРЏ iOS
                audioElement.volume = 1.0;
                audioElement.preload = 'auto';
                
                // Р СџРЎР‚Р С‘Р Р…РЎС“Р Т‘Р С‘РЎвЂљР ВµР В»РЎРЉР Р…Р С•Р Вµ Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘Р Вµ Р Т‘Р В»РЎРЏ iOS
                audioElement.addEventListener('loadedmetadata', () => {
                    audioElement.play().catch(e => console.log('iOS audio play failed:', e));
                });
            }
            
            // Р С›Р В±РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р В° Р С•РЎв‚¬Р С‘Р В±Р С•Р С” Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘РЎРЏ
            audioElement.addEventListener('error', (e) => {
                console.log('Mobile audio error:', e);
                // Р СџР С•Р С—РЎвЂ№РЎвЂљР С”Р В° Р С—Р ВµРЎР‚Р ВµР В·Р В°Р С—РЎС“РЎРѓР С”Р В°
                setTimeout(() => {
                    audioElement.load();
                    audioElement.play().catch(err => console.log('Audio restart failed:', err));
                }, 1000);
            });
        }
    }

    // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р Вµ Р В·Р Р†Р С•Р Р…Р С”Р С‘
    function listenForCalls() {
        if (!me) return;
        const callRef = doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current');
        
        callUnsub = onSnapshot(callRef, async (snap) => {
            if (snap.exists()) {
                const callData = snap.data();
                if (callData.status === 'ringing' && !currentCallId && !document.getElementById('active-call-screen').classList.contains('active')) {
                    showIncomingCall(callData);
                } else if (callData.status === 'cleared' || callData.status === 'answered') {
                    // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎРЊР С”РЎР‚Р В°Р Р… Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° Р ВµРЎРѓР В»Р С‘ Р С•Р Р… Р С—Р С•Р С”Р В°Р В·Р В°Р Р…
                    const incomingScreen = document.getElementById('incoming-call-screen');
                    if (!incomingScreen.classList.contains('hidden')) {
                        incomingScreen.classList.add('hidden');
                        ringtone.pause();
                        ringtone.currentTime = 0;
                    }
                }
            } else {
                // Р вЂўРЎРѓР В»Р С‘ Р Т‘Р С•Р С”РЎС“Р СР ВµР Р…РЎвЂљ Р Р…Р Вµ РЎРѓРЎС“РЎвЂ°Р ВµРЎРѓРЎвЂљР Р†РЎС“Р ВµРЎвЂљ, РЎвЂљР С•Р В¶Р Вµ РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎРЊР С”РЎР‚Р В°Р Р… Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
                const incomingScreen = document.getElementById('incoming-call-screen');
                if (!incomingScreen.classList.contains('hidden')) {
                    incomingScreen.classList.add('hidden');
                    ringtone.pause();
                    ringtone.currentTime = 0;
                }
            }
        });
    }

    function showIncomingCall(callData) {
        currentCallId = callData.callId;
        isVideoCall = callData.isVideo;
        
        const callerAvatarEl = document.getElementById('caller-avatar');
        const callerNameEl = document.getElementById('caller-name');
        const callTypeEl = document.getElementById('call-type-label');
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎРЊРЎвЂљР С• Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
        if (callData.isGroupCall) {
            isGroupCall = true;
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С‘Р С”Р С•Р Р…Р С”РЎС“ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№
            callerAvatarEl.innerHTML = `<i class="fas fa-users text-3xl"></i>`;
            callerNameEl.innerText = callData.groupName;
            callTypeEl.innerText = isVideoCall ? 
                (currentLang === 'ru' ? 'Р вЂњРЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р Р†Р С‘Р Т‘Р ВµР С• Р В·Р Р†Р С•Р Р…Р С•Р С”' : 'Group video call') : 
                (currentLang === 'ru' ? 'Р вЂњРЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р В°РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С•Р С”' : 'Group audio call');
        } else {
            isGroupCall = false;
            // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ (РЎРѓР Р…Р В°РЎвЂЎР В°Р В»Р В° Р В±РЎС“Р С”Р Р†Р В°, Р С—Р С•РЎвЂљР С•Р С Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С‘Р В· Firebase)
            callerAvatarEl.innerHTML = callData.callerName[0].toUpperCase();
            
            getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', callData.callerId)).then(userDoc => {
                if (userDoc.exists() && userDoc.data().avatar) {
                    callerAvatarEl.innerHTML = `<img src="${userDoc.data().avatar}" class="w-full h-full object-cover rounded-full">`;
                }
            }).catch(() => {});
            
            callerNameEl.innerText = '@' + callData.callerName;
            callTypeEl.innerText = isVideoCall ? 
                (currentLang === 'ru' ? 'Р вЂ™Р С‘Р Т‘Р ВµР С• Р В·Р Р†Р С•Р Р…Р С•Р С”' : 'Video call') : 
                (currentLang === 'ru' ? 'Р С’РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С•Р С”' : 'Audio call');
        }
        
        document.getElementById('incoming-call-screen').classList.remove('hidden');
        ringtone.play().catch(() => {});
    }

    // Р вЂњРЎР‚РЎС“Р С—Р С—Р С•Р Р†РЎвЂ№Р Вµ Р В·Р Р†Р С•Р Р…Р С”Р С‘
    let groupCallConnections = {}; // uid -> RTCPeerConnection
    let groupCallStreams = {}; // uid -> MediaStream
    let isGroupCall = false;
    let groupCallJustEnded = false; // Р В¤Р В»Р В°Р С– Р Т‘Р В»РЎРЏ Р С—РЎР‚Р ВµР Т‘Р С•РЎвЂљР Р†РЎР‚Р В°РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С—Р С•Р С”Р В°Р В·Р В° Р В±Р В°Р Р…Р Р…Р ВµРЎР‚Р В° РЎРѓРЎР‚Р В°Р В·РЎС“ Р С—Р С•РЎРѓР В»Р Вµ Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘РЎРЏ

    window.startCall = async (withVideo) => {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎРЊРЎвЂљР С• Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р С‘Р В»Р С‘ Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
        if (activeGroup) {
            await startGroupCall(withVideo);
            return;
        }
        
        if (!activeChatPartner || !me) return;
        
        isVideoCall = withVideo;
        isOutgoingCall = true;
        callWasAnswered = false;
        currentCallId = `${me.uid}_${activeChatPartner.uid}_${Date.now()}`;
        
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ (РЎРѓР Р…Р В°РЎвЂЎР В°Р В»Р В° Р В±РЎС“Р С”Р Р†Р В°, Р С—Р С•РЎвЂљР С•Р С Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С‘Р В· Firebase)
        const calleeAvatarEl = document.getElementById('callee-avatar');
        calleeAvatarEl.innerHTML = activeChatPartner.username[0].toUpperCase();
        
        getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', activeChatPartner.uid)).then(userDoc => {
            if (userDoc.exists() && userDoc.data().avatar) {
                calleeAvatarEl.innerHTML = `<img src="${userDoc.data().avatar}" class="w-full h-full object-cover rounded-full">`;
            }
        }).catch(() => {});
        
        document.getElementById('callee-name').innerText = '@' + activeChatPartner.username;
        document.getElementById('outgoing-call-screen').classList.remove('hidden');
        
        // Р вЂ™Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р С•Р Т‘Р С‘Р С Р В·Р Р†РЎС“Р С” Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° (Р С–РЎС“Р Т‘Р С”Р С‘)
        dialTone.play().catch(() => {});
        
        try {
            // Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р Р†Р С‘Р Т‘Р ВµР С• 1080p Р Т‘Р В»РЎРЏ Р Р†РЎвЂ№РЎРѓР С•Р С”Р С•Р С–Р С• Р С”Р В°РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р В°
            const videoConstraints = withVideo ? {
                width: { ideal: 1920, min: 1280 },
                height: { ideal: 1080, min: 720 },
                frameRate: { ideal: 30, min: 24 },
                facingMode: 'user'
            } : false;
            
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: getOptimalAudioConstraints(),
                video: videoConstraints
            });
            
            // Р ВРЎРѓР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
            await fixIOSAudioContext();
            
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР Вµ РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р ВµР Р…Р С‘Р Вµ Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Р РЋР С•Р В·Р Т‘Р В°Р ВµР С offer
            peerConnection = new RTCPeerConnection(iceServers);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.onicecandidate = async (e) => {
                if (e.candidate) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_caller'), {
                        candidate: e.candidate.toJSON(),
                        timestamp: serverTimestamp()
                    });
                }
            };
            
            peerConnection.ontrack = (e) => {
                remoteStream = e.streams[0];
                const remoteVideo = document.getElementById('remote-video');
                remoteVideo.srcObject = remoteStream;
                
                // Р СњР В°РЎРѓРЎвЂљРЎР‚Р В°Р С‘Р Р†Р В°Р ВµР С Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
                setupMobileAudio(remoteVideo);
            };
            
            const offer = await peerConnection.createOffer();
            // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С Р Р†РЎвЂ№РЎРѓР С•Р С”Р С‘Р в„– Р В±Р С‘РЎвЂљРЎР‚Р ВµР в„–РЎвЂљ Р Т‘Р В»РЎРЏ 1080p
            const modifiedOffer = {
                type: offer.type,
                sdp: withVideo ? setVideoBitrate(offer.sdp, 2500) : offer.sdp
            };
            await peerConnection.setLocalDescription(modifiedOffer);
            
            // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р В·Р Р†Р С•Р Р…Р С•Р С” Р Р† Firebase
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                callerId: me.uid,
                callerName: me.username,
                calleeId: activeChatPartner.uid,
                calleeName: activeChatPartner.username,
                isVideo: withVideo,
                offer: { type: modifiedOffer.type, sdp: modifiedOffer.sdp },
                status: 'ringing',
                timestamp: serverTimestamp()
            });
            
            // Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»РЎРЏР ВµР С Р С—Р С•Р В»РЎС“РЎвЂЎР В°РЎвЂљР ВµР В»РЎРЏ
            await setDoc(doc(db, 'artifacts', appId, 'users', activeChatPartner.uid, 'incoming_call', 'current'), {
                callId: currentCallId,
                callerId: me.uid,
                callerName: me.username,
                isVideo: withVideo,
                status: 'ringing'
            });
            
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С•РЎвЂљР Р†Р ВµРЎвЂљ
            const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId);
            onSnapshot(callDocRef, async (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                
                if (data.status === 'answered' && data.answer && peerConnection.signalingState !== 'stable') {
                    try {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                        showActiveCall(activeChatPartner.username);
                    } catch (err) {
                        console.log('Set remote description error:', err);
                    }
                }
                
                if (data.status === 'declined' || data.status === 'ended') {
                    endCallCleanup();
                }
                
                // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                if (data.screenSharing && data.screenSharing.userId !== me.uid) {
                    const { userName, isSharing } = data.screenSharing;
                    if (isSharing) {
                        showScreenShareNotification(`${userName} Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚РЎС“Р ВµРЎвЂљ РЎРЊР С”РЎР‚Р В°Р Р…`);
                    } else {
                        showScreenShareNotification(`${userName} Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘Р В» Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°`);
                    }
                }
            });
            
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљРЎвЂ№ Р С•РЎвЂљ Р С—Р С•Р В»РЎС“РЎвЂЎР В°РЎвЂљР ВµР В»РЎРЏ
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_callee'), (snap) => {
                snap.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && peerConnection) {
                        const data = change.doc.data();
                        try {
                            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• remoteDescription РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…
                            if (peerConnection.remoteDescription) {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                            } else {
                                console.warn('Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљ - remoteDescription Р Р…Р Вµ РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…');
                            }
                        } catch (err) {
                            // Р ВР С–Р Р…Р С•РЎР‚Р С‘РЎР‚РЎС“Р ВµР С Р С•РЎв‚¬Р С‘Р В±Р С”РЎС“ "No such transceiver" - РЎРЊРЎвЂљР С• Р Р…Р С•РЎР‚Р СР В°Р В»РЎРЉР Р…Р С• Р Р†Р С• Р Р†РЎР‚Р ВµР СРЎРЏ Р С—Р ВµРЎР‚Р ВµРЎРѓР С•Р С–Р В»Р В°РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ
                            if (err.message && err.message.includes('No such transceiver')) {
                                console.log('ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљ Р С—РЎР‚Р С•Р С—РЎС“РЎвЂ°Р ВµР Р… (transceiver Р ВµРЎвЂ°РЎвЂ Р Р…Р Вµ РЎРѓР С•Р В·Р Т‘Р В°Р Р…) - РЎРЊРЎвЂљР С• Р Р…Р С•РЎР‚Р СР В°Р В»РЎРЉР Р…Р С•');
                            } else {
                                console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљР В°:', err);
                            }
                        }
                    }
                });
            });
            
        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р Р†Р С•Р Р…Р С”Р В°:', err);
            alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р С”Р В°Р СР ВµРЎР‚Р Вµ/Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…РЎС“');
            endCallCleanup();
        }
    };

    // Р вЂњРЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
    async function startGroupCall(withVideo) {
        if (!activeGroup || !me) return;
        
        isVideoCall = withVideo;
        isGroupCall = true;
        currentCallId = `group_${activeGroup.id}_${Date.now()}`;
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРЊР С”РЎР‚Р В°Р Р… Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
        const calleeAvatarEl = document.getElementById('callee-avatar');
        calleeAvatarEl.innerHTML = `<i class="fas fa-users text-2xl"></i>`;
        document.getElementById('callee-name').innerText = activeGroup.name;
        document.getElementById('outgoing-call-screen').classList.remove('hidden');
        
        try {
            const videoConstraints = withVideo ? {
                width: { ideal: 1280, min: 640 },
                height: { ideal: 720, min: 480 },
                frameRate: { ideal: 24, min: 15 },
                facingMode: 'user'
            } : false;
            
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: getOptimalAudioConstraints(),
                video: videoConstraints
            });
            
            // Р ВРЎРѓР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
            await fixIOSAudioContext();
            
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р В·Р В°Р С—Р С‘РЎРѓРЎРЉ Р С• Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С Р В·Р Р†Р С•Р Р…Р С”Р Вµ
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId), {
                groupId: activeGroup.id,
                groupName: activeGroup.name,
                callerId: me.uid,
                callerName: me.username,
                isVideo: withVideo,
                participants: [me.uid],
                status: 'active',
                timestamp: serverTimestamp()
            });
            
            // Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»РЎРЏР ВµР С Р Р†РЎРѓР ВµРЎвЂ¦ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р† Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№
            for (const memberId of activeGroup.members) {
                if (memberId === me.uid) continue;
                
                await setDoc(doc(db, 'artifacts', appId, 'users', memberId, 'incoming_call', 'current'), {
                    callId: currentCallId,
                    callerId: me.uid,
                    callerName: me.username,
                    isVideo: withVideo,
                    isGroupCall: true,
                    groupName: activeGroup.name,
                    groupId: activeGroup.id,
                    status: 'ringing'
                });
            }
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В°Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
            showActiveCall(activeGroup.name);
            
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р Р…Р С•Р Р†РЎвЂ№РЎвЂ¦ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId), async (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                
                if (data.status === 'ended') {
                    endGroupCallCleanup();
                    return;
                }
                
                // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                if (data.screenSharing && data.screenSharing.userId !== me.uid) {
                    const { userName, isSharing } = data.screenSharing;
                    if (isSharing) {
                        showScreenShareNotification(`${userName} Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚РЎС“Р ВµРЎвЂљ РЎРЊР С”РЎР‚Р В°Р Р…`);
                    } else {
                        showScreenShareNotification(`${userName} Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘Р В» Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°`);
                    }
                }
                
                // Р СџР С•Р Т‘Р С”Р В»РЎР‹РЎвЂЎР В°Р ВµР СРЎРѓРЎРЏ Р С” Р Р…Р С•Р Р†РЎвЂ№Р С РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р В°Р С
                for (const participantId of data.participants || []) {
                    if (participantId === me.uid) continue;
                    if (groupCallConnections[participantId]) continue;
                    
                    await connectToGroupParticipant(participantId, true);
                }
            });
            
        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°:', err);
            alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р С”Р В°Р СР ВµРЎР‚Р Вµ/Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…РЎС“');
            endGroupCallCleanup();
        }
    }

    async function connectToGroupParticipant(participantId, isInitiator) {
        const pc = new RTCPeerConnection(iceServers);
        groupCallConnections[participantId] = pc;
        
        localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream);
        });
        
        pc.ontrack = (e) => {
            groupCallStreams[participantId] = e.streams[0];
            
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р В°РЎС“Р Т‘Р С‘Р С• РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљ Р Т‘Р В»РЎРЏ Р Р†Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р ВµР Т‘Р ВµР Р…Р С‘РЎРЏ Р В·Р Р†РЎС“Р С”Р В° Р С•РЎвЂљ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р В°
            let audioEl = document.getElementById(`group-audio-${participantId}`);
            if (!audioEl) {
                audioEl = document.createElement('audio');
                audioEl.id = `group-audio-${participantId}`;
                audioEl.autoplay = true;
                audioEl.playsInline = true;
                document.body.appendChild(audioEl);
            }
            audioEl.srcObject = e.streams[0];
            
            // Р СњР В°РЎРѓРЎвЂљРЎР‚Р В°Р С‘Р Р†Р В°Р ВµР С Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
            setupMobileAudio(audioEl);
            
            audioEl.play().catch(err => console.log('Audio play error:', err));
            
            updateGroupCallUI();
        };
        
        const pairId = [me.uid, participantId].sort().join('_');
        
        pc.onicecandidate = async (e) => {
            if (e.candidate) {
                // Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С Р С—Р С•Р Т‘Р С”Р С•Р В»Р В»Р ВµР С”РЎвЂ Р С‘РЎР‹ ice_candidates РЎРѓ pairId Р Р† Р С‘Р СР ВµР Р…Р С‘ Р Т‘Р С•Р С”РЎС“Р СР ВµР Р…РЎвЂљР В°
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId, 'ice_candidates'), {
                    pairId: pairId,
                    from: me.uid,
                    candidate: e.candidate.toJSON(),
                    timestamp: serverTimestamp()
                });
            }
        };
        
        // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљРЎвЂ№
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId, 'ice_candidates'), (snap) => {
            snap.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    if (data.pairId === pairId && data.from !== me.uid && pc.remoteDescription) {
                        try {
                            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        } catch (err) {
                            // Р ВР С–Р Р…Р С•РЎР‚Р С‘РЎР‚РЎС“Р ВµР С Р С•РЎв‚¬Р С‘Р В±Р С”РЎС“ "No such transceiver"
                            if (err.message && err.message.includes('No such transceiver')) {
                                console.log('ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљ Р С—РЎР‚Р С•Р С—РЎС“РЎвЂ°Р ВµР Р… (transceiver Р ВµРЎвЂ°РЎвЂ Р Р…Р Вµ РЎРѓР С•Р В·Р Т‘Р В°Р Р…)');
                            } else {
                                console.error('ICE candidate error:', err);
                            }
                        }
                    }
                }
            });
        });
        
        if (isInitiator) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId, 'signals', pairId), {
                offer: { type: offer.type, sdp: offer.sdp },
                from: me.uid,
                to: participantId
            });
            
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С•РЎвЂљР Р†Р ВµРЎвЂљ
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId, 'signals', pairId), async (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                if (data.answer && data.from === participantId && pc.signalingState !== 'stable') {
                    try {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    } catch (err) {
                        console.log('Set remote description error:', err);
                    }
                }
            });
        } else {
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С offer
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId, 'signals', pairId), async (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                
                if (data.offer && data.from === participantId && !pc.remoteDescription) {
                    try {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId, 'signals', pairId), {
                            ...data,
                            answer: { type: answer.type, sdp: answer.sdp },
                            from: me.uid
                        }, { merge: true });
                    } catch (err) {
                        console.log('Offer handling error:', err);
                    }
                }
            });
        }
    }

    function updateGroupCallUI() {
        if (!isGroupCall) return;
        
        const participantCount = Object.keys(groupCallStreams).length + 1;
        const hasVideo = isVideoCall && localStream && localStream.getVideoTracks().length > 0;
        
        if (hasVideo) {
            // Р вЂ™Р С‘Р Т‘Р ВµР С• Р В·Р Р†Р С•Р Р…Р С•Р С” - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓР ВµРЎвЂљР С”РЎС“ Р Р†Р С‘Р Т‘Р ВµР С•
            const groupContainer = document.getElementById('group-call-participants');
            const videosGrid = document.getElementById('group-videos-grid');
            const audioOverlay = document.getElementById('audio-call-overlay');
            
            if (groupContainer && videosGrid) {
                groupContainer.classList.remove('hidden');
                if (audioOverlay) audioOverlay.classList.add('hidden');
                
                // Р С›Р С—РЎР‚Р ВµР Т‘Р ВµР В»РЎРЏР ВµР С РЎРѓР ВµРЎвЂљР С”РЎС“ Р Р† Р В·Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘ Р С•РЎвЂљ Р С”Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р В° РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
                let gridCols = 'grid-cols-1';
                if (participantCount === 2) gridCols = 'grid-cols-2';
                else if (participantCount <= 4) gridCols = 'grid-cols-2';
                else if (participantCount <= 6) gridCols = 'grid-cols-3';
                else gridCols = 'grid-cols-4';
                
                videosGrid.className = `w-full h-full grid gap-2 p-2 ${gridCols}`;
                
                // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С Р С‘ Р С—Р ВµРЎР‚Р ВµРЎРѓРЎвЂљРЎР‚Р В°Р С‘Р Р†Р В°Р ВµР С
                videosGrid.innerHTML = '';
                
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р Р†Р С‘Р Т‘Р ВµР С•
                const localDiv = document.createElement('div');
                localDiv.className = 'relative rounded-xl overflow-hidden bg-slate-800';
                localDiv.innerHTML = `
                    <video autoplay playsinline muted class="w-full h-full object-cover"></video>
                    <div class="absolute bottom-2 left-2 bg-black/50 px-2 py-1 rounded text-white text-xs">
                        ${currentLang === 'ru' ? 'Р вЂ™РЎвЂ№' : 'You'}
                    </div>
                `;
                localDiv.querySelector('video').srcObject = localStream;
                videosGrid.appendChild(localDiv);
                
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р Р†Р С‘Р Т‘Р ВµР С• РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
                for (const [participantId, stream] of Object.entries(groupCallStreams)) {
                    const participantDiv = document.createElement('div');
                    participantDiv.className = 'relative rounded-xl overflow-hidden bg-slate-800';
                    participantDiv.innerHTML = `
                        <video autoplay playsinline class="w-full h-full object-cover"></video>
                        <div class="absolute bottom-2 left-2 bg-black/50 px-2 py-1 rounded text-white text-xs" id="participant-name-${participantId}">
                            <i class="fas fa-user mr-1"></i>
                        </div>
                    `;
                    participantDiv.querySelector('video').srcObject = stream;
                    videosGrid.appendChild(participantDiv);
                    
                    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С‘Р СРЎРЏ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р В°
                    getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', participantId)).then(userDoc => {
                        if (userDoc.exists()) {
                            const nameEl = document.getElementById(`participant-name-${participantId}`);
                            if (nameEl) nameEl.innerHTML = `<i class="fas fa-user mr-1"></i>${userDoc.data().username}`;
                        }
                    }).catch(() => {});
                }
            }
        } else {
            // Р С’РЎС“Р Т‘Р С‘Р С• Р В·Р Р†Р С•Р Р…Р С•Р С” - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚РЎвЂ№ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
            const groupAudioContainer = document.getElementById('group-audio-participants');
            const singleAvatarContainer = document.getElementById('single-call-avatar-container');
            
            if (groupAudioContainer && participantCount > 1) {
                groupAudioContainer.classList.remove('hidden');
                groupAudioContainer.classList.add('flex');
                if (singleAvatarContainer) singleAvatarContainer.classList.add('hidden');
                
                groupAudioContainer.innerHTML = '';
                
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓР Р†Р С•Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚
                const myDiv = document.createElement('div');
                myDiv.className = 'flex flex-col items-center';
                myDiv.innerHTML = `
                    <div class="w-20 h-20 rounded-full bg-indigo-500/30 flex items-center justify-center text-2xl font-bold text-white border-2 border-green-400 overflow-hidden">
                        ${me.avatar ? `<img src="${me.avatar}" class="w-full h-full object-cover">` : me.username[0].toUpperCase()}
                    </div>
                    <p class="text-white text-xs mt-2">${currentLang === 'ru' ? 'Р вЂ™РЎвЂ№' : 'You'}</p>
                `;
                groupAudioContainer.appendChild(myDiv);
                
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚РЎвЂ№ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
                for (const participantId of Object.keys(groupCallStreams)) {
                    const participantDiv = document.createElement('div');
                    participantDiv.className = 'flex flex-col items-center';
                    participantDiv.id = `audio-participant-${participantId}`;
                    participantDiv.innerHTML = `
                        <div class="w-20 h-20 rounded-full bg-indigo-500/30 flex items-center justify-center text-2xl font-bold text-white border-2 border-indigo-400/50 overflow-hidden animate-pulse">
                            <i class="fas fa-user"></i>
                        </div>
                        <p class="text-white text-xs mt-2">...</p>
                    `;
                    groupAudioContainer.appendChild(participantDiv);
                    
                    // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р В°
                    getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', participantId)).then(userDoc => {
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            const el = document.getElementById(`audio-participant-${participantId}`);
                            if (el) {
                                el.innerHTML = `
                                    <div class="w-20 h-20 rounded-full bg-indigo-500/30 flex items-center justify-center text-2xl font-bold text-white border-2 border-green-400 overflow-hidden">
                                        ${userData.avatar ? `<img src="${userData.avatar}" class="w-full h-full object-cover">` : userData.username[0].toUpperCase()}
                                    </div>
                                    <p class="text-white text-xs mt-2">@${userData.username}</p>
                                `;
                            }
                        }
                    }).catch(() => {});
                }
            } else {
                // Р С›Р Т‘Р С‘Р Р… РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С” - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р В±РЎвЂ№РЎвЂЎР Р…РЎвЂ№Р в„– UI
                if (groupAudioContainer) {
                    groupAudioContainer.classList.add('hidden');
                    groupAudioContainer.classList.remove('flex');
                }
                if (singleAvatarContainer) singleAvatarContainer.classList.remove('hidden');
                
                const avatarEl = document.getElementById('active-call-avatar');
                if (avatarEl) {
                    avatarEl.innerHTML = `<i class="fas fa-users"></i><span class="absolute -bottom-1 -right-1 bg-green-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">${participantCount}</span>`;
                }
            }
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓРЎвЂЎРЎвЂРЎвЂљРЎвЂЎР С‘Р С” РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р† Р Р† Р В·Р В°Р С–Р С•Р В»Р С•Р Р†Р С”Р Вµ
        const callNameEl = document.getElementById('active-call-name');
        if (callNameEl && isGroupCall) {
            const currentName = callNameEl.innerText.split(' (')[0];
            callNameEl.innerText = `${currentName} (${participantCount})`;
        }
    }

    function endGroupCallCleanup() {
        // Р Р€РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С РЎвЂћР В»Р В°Р С– РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ Р Р…Р Вµ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р В»РЎРѓРЎРЏ РЎРѓРЎР‚Р В°Р В·РЎС“ Р С—Р С•РЎРѓР В»Р Вµ Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘РЎРЏ
        groupCallJustEnded = true;
        setTimeout(() => { groupCallJustEnded = false; }, 2000);
        
        // Р С›РЎвЂљР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р ВµР СРЎРѓРЎРЏ Р С•РЎвЂљ РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»РЎРЏ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
        if (activeGroupCallUnsub) {
            activeGroupCallUnsub();
            activeGroupCallUnsub = null;
        }
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° (Р В°Р С–РЎР‚Р ВµРЎРѓРЎРѓР С‘Р Р†Р Р…Р С•)
        const removeBanner = () => {
            const groupCallBanner = document.getElementById('group-call-banner');
            if (groupCallBanner) groupCallBanner.remove();
        };
        removeBanner();
        // Р СџР С•Р Р†РЎвЂљР С•РЎР‚РЎРЏР ВµР С РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· Р Р…Р ВµР В±Р С•Р В»РЎРЉРЎв‚¬Р С‘Р Вµ Р С‘Р Р…РЎвЂљР ВµРЎР‚Р Р†Р В°Р В»РЎвЂ№ Р Р…Р В° РЎРѓР В»РЎС“РЎвЂЎР В°Р в„– Р ВµРЎРѓР В»Р С‘ Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ РЎРѓР С•Р В·Р Т‘Р В°Р ВµРЎвЂљРЎРѓРЎРЏ Р В·Р В°Р Р…Р С•Р Р†Р С•
        setTimeout(removeBanner, 100);
        setTimeout(removeBanner, 500);
        setTimeout(removeBanner, 1000);
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р В°РЎС“Р Т‘Р С‘Р С• РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљРЎвЂ№ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
        Object.keys(groupCallConnections).forEach(participantId => {
            const audioEl = document.getElementById(`group-audio-${participantId}`);
            if (audioEl) {
                audioEl.srcObject = null;
                audioEl.remove();
            }
        });
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р Р†РЎРѓР Вµ РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р ВµР Р…Р С‘РЎРЏ
        Object.values(groupCallConnections).forEach(pc => pc.close());
        groupCallConnections = {};
        groupCallStreams = {};
        isGroupCall = false;
        
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С UI Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
        const groupContainer = document.getElementById('group-call-participants');
        const groupAudioContainer = document.getElementById('group-audio-participants');
        const singleAvatarContainer = document.getElementById('single-call-avatar-container');
        
        if (groupContainer) groupContainer.classList.add('hidden');
        if (groupAudioContainer) {
            groupAudioContainer.classList.add('hidden');
            groupAudioContainer.classList.remove('flex');
            groupAudioContainer.innerHTML = '';
        }
        if (singleAvatarContainer) singleAvatarContainer.classList.remove('hidden');
        
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р С‘Р Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚РЎвЂ№ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° Р Р† РЎРѓР С—Р С‘РЎРѓР С”Р Вµ Р С–РЎР‚РЎС“Р С—Р С—
        document.querySelectorAll('[data-group-call]').forEach(el => el.remove());
        document.querySelectorAll('.group-last-msg').forEach(el => {
            if (el.innerHTML.includes('Р С’Р С”РЎвЂљР С‘Р Р†Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”')) {
                el.innerHTML = '';
            }
        });
        
        endCallCleanup();
    }

    window.acceptCall = async () => {
        ringtone.pause();
        ringtone.currentTime = 0;
        document.getElementById('incoming-call-screen').classList.add('hidden');
        
        callWasAnswered = true;
        isOutgoingCall = false;
        
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎРЊРЎвЂљР С• Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
        const incomingCallDoc = await getDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'));
        const incomingData = incomingCallDoc.exists() ? incomingCallDoc.data() : {};
        
        if (incomingData.isGroupCall) {
            await acceptGroupCall(incomingData);
            return;
        }
        
        try {
            // Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ Р Р†Р С‘Р Т‘Р ВµР С• 1080p Р Т‘Р В»РЎРЏ Р Р†РЎвЂ№РЎРѓР С•Р С”Р С•Р С–Р С• Р С”Р В°РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р В°
            const videoConstraints = isVideoCall ? {
                width: { ideal: 1920, min: 1280 },
                height: { ideal: 1080, min: 720 },
                frameRate: { ideal: 30, min: 24 },
                facingMode: 'user'
            } : false;
            
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: getOptimalAudioConstraints(),
                video: videoConstraints
            });
            
            // Р ВРЎРѓР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
            await fixIOSAudioContext();
            
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘РЎвЂ№Р Т‘РЎС“РЎвЂ°Р ВµР Вµ РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р ВµР Р…Р С‘Р Вµ Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            peerConnection = new RTCPeerConnection(iceServers);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.onicecandidate = async (e) => {
                if (e.candidate) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_callee'), {
                        candidate: e.candidate.toJSON(),
                        timestamp: serverTimestamp()
                    });
                }
            };
            
            peerConnection.ontrack = (e) => {
                remoteStream = e.streams[0];
                const remoteVideo = document.getElementById('remote-video');
                remoteVideo.srcObject = remoteStream;
                
                // Р СњР В°РЎРѓРЎвЂљРЎР‚Р В°Р С‘Р Р†Р В°Р ВµР С Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
                setupMobileAudio(remoteVideo);
            };
            
            // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С offer
            const callDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId));
            const callData = callDoc.data();
            
            if (callData && callData.offer && peerConnection.signalingState === 'stable') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
            }
            
            const answer = await peerConnection.createAnswer();
            // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С Р Р†РЎвЂ№РЎРѓР С•Р С”Р С‘Р в„– Р В±Р С‘РЎвЂљРЎР‚Р ВµР в„–РЎвЂљ Р Т‘Р В»РЎРЏ 1080p
            const modifiedAnswer = {
                type: answer.type,
                sdp: isVideoCall ? setVideoBitrate(answer.sdp, 2500) : answer.sdp
            };
            await peerConnection.setLocalDescription(modifiedAnswer);
            
            // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С answer
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                answer: { type: modifiedAnswer.type, sdp: modifiedAnswer.sdp },
                status: 'answered'
            }, { merge: true });
            
            // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
            await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'), { status: 'answered' });
            
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљРЎвЂ№ Р С•РЎвЂљ Р В·Р Р†Р С•Р Р…РЎРЏРЎвЂ°Р ВµР С–Р С•
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_caller'), (snap) => {
                snap.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && peerConnection) {
                        const data = change.doc.data();
                        try {
                            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• remoteDescription РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…
                            if (peerConnection.remoteDescription) {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                            } else {
                                console.warn('Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљ - remoteDescription Р Р…Р Вµ РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…');
                            }
                        } catch (err) {
                            // Р ВР С–Р Р…Р С•РЎР‚Р С‘РЎР‚РЎС“Р ВµР С Р С•РЎв‚¬Р С‘Р В±Р С”РЎС“ "No such transceiver" - РЎРЊРЎвЂљР С• Р Р…Р С•РЎР‚Р СР В°Р В»РЎРЉР Р…Р С• Р Р†Р С• Р Р†РЎР‚Р ВµР СРЎРЏ Р С—Р ВµРЎР‚Р ВµРЎРѓР С•Р С–Р В»Р В°РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ
                            if (err.message && err.message.includes('No such transceiver')) {
                                console.log('ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљ Р С—РЎР‚Р С•Р С—РЎС“РЎвЂ°Р ВµР Р… (transceiver Р ВµРЎвЂ°РЎвЂ Р Р…Р Вµ РЎРѓР С•Р В·Р Т‘Р В°Р Р…) - РЎРЊРЎвЂљР С• Р Р…Р С•РЎР‚Р СР В°Р В»РЎРЉР Р…Р С•');
                            } else {
                                console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ ICE Р С”Р В°Р Р…Р Т‘Р С‘Р Т‘Р В°РЎвЂљР В°:', err);
                            }
                        }
                    }
                });
            });
            
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘Р Вµ Р В·Р Р†Р С•Р Р…Р С”Р В°
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), async (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.status === 'ended') {
                        endCallCleanup();
                    }
                    
                    // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                    if (data.screenSharing && data.screenSharing.userId !== me.uid) {
                        const { userName, isSharing } = data.screenSharing;
                        if (isSharing) {
                            showScreenShareNotification(`${userName} Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚РЎС“Р ВµРЎвЂљ РЎРЊР С”РЎР‚Р В°Р Р…`);
                        } else {
                            showScreenShareNotification(`${userName} Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘Р В» Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°`);
                        }
                    }
                }
            });
            
            showActiveCall(callData.callerName);
            
        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљР С‘РЎРЏ Р В·Р Р†Р С•Р Р…Р С”Р В°:', err);
            alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р С”Р В°Р СР ВµРЎР‚Р Вµ/Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…РЎС“');
            declineCall();
        }
    };

    window.declineCall = async () => {
        ringtone.pause();
        ringtone.currentTime = 0;
        document.getElementById('incoming-call-screen').classList.add('hidden');
        
        // Р СџР С•Р В»Р Р…Р С•РЎРѓРЎвЂљРЎРЉРЎР‹ РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ Р С• Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С Р В·Р Р†Р С•Р Р…Р С”Р Вµ
        await deleteDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'));
        
        if (isGroupCall) {
            // Р вЂќР В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р С•РЎвЂљР С”Р В»Р С•Р Р…РЎРЏР ВµР С - Р Р…Р Вµ Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р В°Р ВµР С Р Р†Р ВµРЎРѓРЎРЉ Р В·Р Р†Р С•Р Р…Р С•Р С”
            endGroupCallCleanup();
        } else if (currentCallId) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                status: 'declined'
            }, { merge: true });
            endCallCleanup();
        } else {
            endCallCleanup();
        }
    };

    async function acceptGroupCall(callData) {
        isGroupCall = true;
        isVideoCall = callData.isVideo;
        currentCallId = callData.callId;
        
        try {
            const videoConstraints = isVideoCall ? {
                width: { ideal: 1280, min: 640 },
                height: { ideal: 720, min: 480 },
                frameRate: { ideal: 24, min: 15 },
                facingMode: 'user'
            } : false;
            
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: getOptimalAudioConstraints(),
                video: videoConstraints
            });
            
            // Р ВРЎРѓР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С Р В°РЎС“Р Т‘Р С‘Р С• Р Т‘Р В»РЎРЏ Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†
            await fixIOSAudioContext();
            
            // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓР ВµР В±РЎРЏ Р Р† РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С‘
            const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId);
            const callDoc = await getDoc(callDocRef);
            
            if (callDoc.exists()) {
                const participants = callDoc.data().participants || [];
                if (!participants.includes(me.uid)) {
                    participants.push(me.uid);
                    await setDoc(callDocRef, { participants }, { merge: true });
                }
                
                // Р СџР С•Р Т‘Р С”Р В»РЎР‹РЎвЂЎР В°Р ВµР СРЎРѓРЎРЏ Р С” РЎРѓРЎС“РЎвЂ°Р ВµРЎРѓРЎвЂљР Р†РЎС“РЎР‹РЎвЂ°Р С‘Р С РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р В°Р С
                for (const participantId of participants) {
                    if (participantId === me.uid) continue;
                    await connectToGroupParticipant(participantId, false);
                }
            }
            
            // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
            await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'), { status: 'answered' });
            
            showActiveCall(callData.groupName);
            
            // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
            onSnapshot(callDocRef, async (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                
                if (data.status === 'ended') {
                    endGroupCallCleanup();
                    return;
                }
                
                // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                if (data.screenSharing && data.screenSharing.userId !== me.uid) {
                    const { userName, isSharing } = data.screenSharing;
                    if (isSharing) {
                        showScreenShareNotification(`${userName} Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚РЎС“Р ВµРЎвЂљ РЎРЊР С”РЎР‚Р В°Р Р…`);
                    } else {
                        showScreenShareNotification(`${userName} Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘Р В» Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°`);
                    }
                }
                
                for (const participantId of data.participants || []) {
                    if (participantId === me.uid) continue;
                    if (groupCallConnections[participantId]) continue;
                    await connectToGroupParticipant(participantId, false);
                }
            });
            
        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљР С‘РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°:', err);
            alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљРЎРЉ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р С”Р В°Р СР ВµРЎР‚Р Вµ/Р СР С‘Р С”РЎР‚Р С•РЎвЂћР С•Р Р…РЎС“');
            endGroupCallCleanup();
        }
    }

    window.cancelCall = async () => {
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р В·Р Р†РЎС“Р С” Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
        dialTone.pause();
        dialTone.currentTime = 0;
        
        document.getElementById('outgoing-call-screen').classList.add('hidden');
        
        if (isGroupCall && currentCallId && activeGroup) {
            // Р С›РЎвЂљР СР ВµР Р…РЎРЏР ВµР С Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId), {
                status: 'ended'
            }, { merge: true });
            
            // Р С›РЎвЂЎР С‘РЎвЂ°Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ РЎС“ Р Р†РЎРѓР ВµРЎвЂ¦ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
            for (const memberId of activeGroup.members) {
                if (memberId === me.uid) continue;
                await setDoc(doc(db, 'artifacts', appId, 'users', memberId, 'incoming_call', 'current'), { status: 'cleared' });
            }
            
            endGroupCallCleanup();
        } else if (currentCallId && activeChatPartner) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                status: 'ended'
            }, { merge: true });
            await setDoc(doc(db, 'artifacts', appId, 'users', activeChatPartner.uid, 'incoming_call', 'current'), { status: 'cleared' });
            endCallCleanup();
        } else {
            endCallCleanup();
        }
    };

    window.endCall = async () => {
        if (isGroupCall && currentCallId) {
            // Р вЂќР В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° - РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓР ВµР В±РЎРЏ Р С‘Р В· РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р†
            const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId);
            const callDoc = await getDoc(callDocRef);
            
            if (callDoc.exists()) {
                const participants = (callDoc.data().participants || []).filter(id => id !== me.uid);
                
                if (participants.length === 0) {
                    // Р СџР С•РЎРѓР В»Р ВµР Т‘Р Р…Р С‘Р в„– РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С” - Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р В°Р ВµР С Р В·Р Р†Р С•Р Р…Р С•Р С”
                    await setDoc(callDocRef, { status: 'ended' }, { merge: true });
                } else {
                    await setDoc(callDocRef, { participants }, { merge: true });
                }
            }
            
            // Р СџР С•Р В»Р Р…Р С•РЎРѓРЎвЂљРЎРЉРЎР‹ РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С Р Т‘Р С•Р С”РЎС“Р СР ВµР Р…РЎвЂљ Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
            await deleteDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'));
            
            endGroupCallCleanup();
        } else if (currentCallId) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                status: 'ended'
            }, { merge: true });
            
            // Р СџР С•Р В»Р Р…Р С•РЎРѓРЎвЂљРЎРЉРЎР‹ РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С Р Т‘Р С•Р С”РЎС“Р СР ВµР Р…РЎвЂљ Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
            await deleteDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'));
            
            endCallCleanup();
        } else {
            // Р СџР С•Р В»Р Р…Р С•РЎРѓРЎвЂљРЎРЉРЎР‹ РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С Р Т‘Р С•Р С”РЎС“Р СР ВµР Р…РЎвЂљ Р Р†РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° Р Р…Р В° Р Р†РЎРѓРЎРЏР С”Р С‘Р в„– РЎРѓР В»РЎС“РЎвЂЎР В°Р в„–
            await deleteDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'));
            endCallCleanup();
        }
    };

    function showActiveCall(partnerName) {
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р В·Р Р†РЎС“Р С” Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р ВµР С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
        dialTone.pause();
        dialTone.currentTime = 0;
        
        callWasAnswered = true; // Р вЂ”Р Р†Р С•Р Р…Р С•Р С” Р В±РЎвЂ№Р В» Р С—РЎР‚Р С‘Р Р…РЎРЏРЎвЂљ
        
        document.getElementById('outgoing-call-screen').classList.add('hidden');
        document.getElementById('incoming-call-screen').classList.add('hidden');
        document.getElementById('active-call-screen').classList.remove('hidden');
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С‘Р СРЎРЏ Р Р† Р С•Р В±Р С•Р С‘РЎвЂ¦ Р СР ВµРЎРѓРЎвЂљР В°РЎвЂ¦
        const nameEl = document.getElementById('active-call-name');
        const nameAudioEl = document.getElementById('active-call-name-audio');
        
        if (isGroupCall) {
            // Р вЂњРЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С” - Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р Р…Р В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№ Р В±Р ВµР В· @
            if (nameEl) nameEl.innerText = partnerName;
            if (nameAudioEl) nameAudioEl.innerText = partnerName;
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С‘Р С”Р С•Р Р…Р С”РЎС“ Р С–РЎР‚РЎС“Р С—Р С—РЎвЂ№
            const avatarEl = document.getElementById('active-call-avatar');
            if (avatarEl) {
                avatarEl.innerHTML = `<i class="fas fa-users text-3xl"></i>`;
            }
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С UI Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°
            updateGroupCallUI();
        } else {
            // Р вЂєР С‘РЎвЂЎР Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”
            if (nameEl) nameEl.innerText = '@' + partnerName;
            if (nameAudioEl) nameAudioEl.innerText = '@' + partnerName;
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ Р Р† Р В°РЎС“Р Т‘Р С‘Р С•-Р С•Р Р†Р ВµРЎР‚Р В»Р ВµР Вµ (РЎРѓР Р…Р В°РЎвЂЎР В°Р В»Р В° Р В±РЎС“Р С”Р Р†Р В°, Р С—Р С•РЎвЂљР С•Р С Р В·Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р С‘Р В· Firebase)
            const avatarEl = document.getElementById('active-call-avatar');
            if (avatarEl) {
                avatarEl.innerHTML = partnerName.charAt(0).toUpperCase();
                
                // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С РЎР‚Р ВµР В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р В°Р Р†Р В°РЎвЂљР В°РЎР‚ Р С‘Р В· Firebase
                if (activeChatPartner && activeChatPartner.uid) {
                    getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', activeChatPartner.uid)).then(userDoc => {
                        if (userDoc.exists() && userDoc.data().avatar) {
                            avatarEl.innerHTML = `<img src="${userDoc.data().avatar}" class="w-full h-full object-cover">`;
                        }
                    }).catch(() => {});
                }
            }
        }
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С/РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р В°РЎС“Р Т‘Р С‘Р С•-Р С•Р Р†Р ВµРЎР‚Р В»Р ВµР в„– Р Р† Р В·Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘ Р С•РЎвЂљ РЎвЂљР С‘Р С—Р В° Р В·Р Р†Р С•Р Р…Р С”Р В°
        const audioOverlay = document.getElementById('audio-call-overlay');
        const localVideoEl = document.getElementById('local-video');
        const remoteVideoEl = document.getElementById('remote-video');
        const hasVideo = localStream && localStream.getVideoTracks().length > 0 && localStream.getVideoTracks()[0].enabled;
        
        if (isGroupCall) {
            // Р вЂќР В»РЎРЏ Р С–РЎР‚РЎС“Р С—Р С—Р С•Р Р†Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В° РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓРЎвЂљР В°Р Р…Р Т‘Р В°РЎР‚РЎвЂљР Р…РЎвЂ№Р Вµ Р Р†Р С‘Р Т‘Р ВµР С• РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљРЎвЂ№
            if (localVideoEl) localVideoEl.classList.add('hidden');
            if (remoteVideoEl) remoteVideoEl.classList.add('hidden');
            // Р С’РЎС“Р Т‘Р С‘Р С• Р С•Р Р†Р ВµРЎР‚Р В»Р ВµР в„– РЎС“Р С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµРЎвЂљРЎРѓРЎРЏ Р Р† updateGroupCallUI
        } else {
            if (localVideoEl) localVideoEl.classList.remove('hidden');
            if (remoteVideoEl) remoteVideoEl.classList.remove('hidden');
            if (audioOverlay) {
                audioOverlay.classList.toggle('hidden', hasVideo);
            }
        }
        
        if (localStream && localVideoEl) {
            localVideoEl.srcObject = localStream;
        }
        
        // Р СћР В°Р в„–Р СР ВµРЎР‚ Р В·Р Р†Р С•Р Р…Р С”Р В°
        callStartTime = Date.now();
        callTimerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            
            const timerEl = document.getElementById('call-timer');
            if (timerEl) timerEl.innerText = `${mins}:${secs}`;
            
            const timerAudioEl = document.getElementById('call-timer-audio');
            if (timerAudioEl) timerAudioEl.innerText = `${mins}:${secs}`;
        }, 1000);
        
        // Р СњР В°РЎвЂЎР С‘РЎРѓР В»Р ВµР Р…Р С‘Р Вµ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р В·Р В° Р В·Р Р†Р С•Р Р…Р С•Р С” (1 РЎР‚РЎС“Р В±Р С‘Р Р… Р Р† Р СР С‘Р Р…РЎС“РЎвЂљРЎС“)
        callRubyInterval = setInterval(async () => {
            if (me && me.uid) {
                me.rubies = (me.rubies || 0) + 1;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                    rubies: me.rubies
                }, { merge: true });
                updateRubiesDisplay();
                showToast('+1СЂСџвЂ™Р‹ Р В·Р В° Р В·Р Р†Р С•Р Р…Р С•Р С”', 'СЂСџвЂњС›');
            }
        }, 60000); // Р С™Р В°Р В¶Р Т‘РЎС“РЎР‹ Р СР С‘Р Р…РЎС“РЎвЂљРЎС“
    }
    
    // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р С• Р В·Р Р†Р С•Р Р…Р С”Р Вµ Р Р† РЎвЂЎР В°РЎвЂљ
    async function sendCallMessage() {
        if (!activeChatPartner || !me || isGroupCall) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        const callDuration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
        const callTime = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        
        let callType, callIcon;
        if (callWasAnswered) {
            // Р вЂ”Р Р†Р С•Р Р…Р С•Р С” РЎРѓР С•РЎРѓРЎвЂљР С•РЎРЏР В»РЎРѓРЎРЏ
            if (isOutgoingCall) {
                callType = 'Р ВРЎРѓРЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”';
                callIcon = 'РІвЂ вЂ”';
            } else {
                callType = 'Р вЂ™РЎвЂ¦Р С•Р Т‘РЎРЏРЎвЂ°Р С‘Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”';
                callIcon = 'РІвЂ в„ў';
            }
        } else {
            // Р вЂ”Р Р†Р С•Р Р…Р С•Р С” Р Р…Р Вµ РЎРѓР С•РЎРѓРЎвЂљР С•РЎРЏР В»РЎРѓРЎРЏ
            if (isOutgoingCall) {
                callType = 'Р С›РЎвЂљР СР ВµР Р…РЎвЂР Р…Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”';
                callIcon = 'РІвЂ вЂ”';
            } else {
                callType = 'Р СџРЎР‚Р С•Р С—РЎС“РЎвЂ°Р ВµР Р…Р Р…РЎвЂ№Р в„– Р В·Р Р†Р С•Р Р…Р С•Р С”';
                callIcon = 'РІвЂ в„ў';
            }
        }
        
        // Р В¤Р С•РЎР‚Р СР В°РЎвЂљР С‘РЎР‚РЎС“Р ВµР С Р Т‘Р В»Р С‘РЎвЂљР ВµР В»РЎРЉР Р…Р С•РЎРѓРЎвЂљРЎРЉ
        let durationText = '';
        if (callWasAnswered && callDuration > 0) {
            if (callDuration < 60) {
                durationText = `${callDuration} РЎРѓР ВµР С”`;
            } else {
                const mins = Math.floor(callDuration / 60);
                const secs = callDuration % 60;
                durationText = secs > 0 ? `${mins} Р СР С‘Р Р… ${secs} РЎРѓР ВµР С”` : `${mins} Р СР С‘Р Р…`;
            }
        }
        
        const callMessage = {
            type: 'call',
            callType: callType,
            callIcon: callIcon,
            callTime: callTime,
            callDuration: durationText,
            isVideo: isVideoCall,
            wasAnswered: callWasAnswered,
            senderId: me.uid,
            timestamp: serverTimestamp()
        };
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), callMessage);
        } catch (e) {
            console.error('Error sending call message:', e);
        }
    }

    let isCleaningUp = false;
    
    function endCallCleanup() {
        // Р СџРЎР‚Р ВµР Т‘Р С•РЎвЂљР Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµР С Р С—Р С•Р Р†РЎвЂљР С•РЎР‚Р Р…РЎвЂ№Р в„– Р Р†РЎвЂ№Р В·Р С•Р Р†
        if (isCleaningUp) return;
        isCleaningUp = true;
        
        // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С• Р В·Р Р†Р С•Р Р…Р С”Р Вµ Р Р† РЎвЂЎР В°РЎвЂљ (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С‘Р Р…Р С‘РЎвЂ Р С‘Р В°РЎвЂљР С•РЎР‚ Р В·Р Р†Р С•Р Р…Р С”Р В°)
        if (isOutgoingCall) {
            sendCallMessage();
        }
        
        // Р вЂ™Р С•РЎРѓР С—РЎР‚Р С•Р С‘Р В·Р Р†Р С•Р Т‘Р С‘Р С Р В·Р Р†РЎС“Р С” Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘РЎРЏ Р В·Р Р†Р С•Р Р…Р С”Р В°
        endCallSound.play().catch(() => {});
        
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Р†РЎРѓР Вµ Р В·Р Р†РЎС“Р С”Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р В°
        dialTone.pause();
        dialTone.currentTime = 0;
        ringtone.pause();
        ringtone.currentTime = 0;
        
        document.getElementById('outgoing-call-screen').classList.add('hidden');
        document.getElementById('incoming-call-screen').classList.add('hidden');
        document.getElementById('active-call-screen').classList.add('hidden');
        
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎвЂћР В»Р В°Р С– РЎвЂЎР ВµРЎР‚Р ВµР В· Р Р…Р ВµР В±Р С•Р В»РЎРЉРЎв‚¬РЎС“РЎР‹ Р В·Р В°Р Т‘Р ВµРЎР‚Р В¶Р С”РЎС“
        setTimeout(() => { isCleaningUp = false; }, 500);
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р Р†Р С‘Р Т‘Р С‘Р СР С•РЎРѓРЎвЂљРЎРЉ РЎРЊР В»Р ВµР СР ВµР Р…РЎвЂљР С•Р Р†
        const localVideoEl = document.getElementById('local-video');
        const remoteVideoEl = document.getElementById('remote-video');
        const groupContainer = document.getElementById('group-call-participants');
        
        if (localVideoEl) localVideoEl.classList.remove('hidden');
        if (remoteVideoEl) remoteVideoEl.classList.remove('hidden');
        if (groupContainer) groupContainer.classList.add('hidden');
        
        if (callTimerInterval) {
            clearInterval(callTimerInterval);
            callTimerInterval = null;
        }
        
        // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Р…Р В°РЎвЂЎР С‘РЎРѓР В»Р ВµР Р…Р С‘Р Вµ РЎР‚РЎС“Р В±Р С‘Р Р…Р С•Р Р† Р В·Р В° Р В·Р Р†Р С•Р Р…Р С•Р С”
        if (callRubyInterval) {
            clearInterval(callRubyInterval);
            callRubyInterval = null;
        }
        
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        remoteStream = null;
        currentCallId = null;
        isMuted = false;
        isVideoOff = false;
        isSpeakerOff = false;
        callWasAnswered = false;
        isOutgoingCall = false;
        callStartTime = null;
        
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
        if (isScreenSharing) {
            isScreenSharing = false;
            originalVideoTrack = null;
            const screenBtn = document.getElementById('screen-share-btn');
            if (screenBtn) {
                screenBtn.classList.remove('screen-sharing');
                screenBtn.innerHTML = '<i class="fas fa-desktop"></i>';
                screenBtn.title = 'Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В°';
            }
        }
        
        // Р РЋР В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµР С РЎР‚Р ВµР В¶Р С‘Р С Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р В° Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
        if (isWatchingScreen) {
            isWatchingScreen = false;
            const watchBtn = document.getElementById('watch-screen-btn');
            if (watchBtn) {
                watchBtn.textContent = 'Р РЋР СР С•РЎвЂљРЎР‚Р ВµРЎвЂљРЎРЉ';
                watchBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                watchBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }
        }
        
        document.getElementById('mute-btn').classList.remove('active');
        document.getElementById('video-btn').classList.remove('active');
        const speakerBtn = document.getElementById('speaker-btn');
        if (speakerBtn) {
            speakerBtn.classList.remove('active');
            speakerBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        }
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР С‘Р Р…Р С‘-Р С—Р В»Р ВµР ВµРЎР‚ Р С—РЎР‚Р С‘ Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р В°
        document.getElementById('minimized-call').style.display = 'none';
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С‘Р Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
        const screenIndicator = document.getElementById('screen-share-indicator');
        if (screenIndicator) {
            screenIndicator.classList.add('hidden');
        }
    }
    
    // Р РЋР Р†Р С•РЎР‚Р В°РЎвЂЎР С‘Р Р†Р В°Р Р…Р С‘Р Вµ Р В·Р Р†Р С•Р Р…Р С”Р В°
    let isCallMinimized = false;
    
    window.minimizeCall = () => {
        if (!currentCallId) return;
        
        isCallMinimized = true;
        document.getElementById('active-call-screen').classList.add('hidden');
        
        const miniCall = document.getElementById('minimized-call');
        miniCall.style.display = 'block';
        
        // Р С™Р С•Р С—Р С‘РЎР‚РЎС“Р ВµР С Р С‘Р Р…РЎвЂћР С•РЎР‚Р СР В°РЎвЂ Р С‘РЎР‹ Р С• Р В·Р Р†Р С•Р Р…Р С”Р Вµ
        const callName = document.getElementById('active-call-name').innerText;
        document.getElementById('mini-call-name').innerText = callName;
        
        // Р С™Р С•Р С—Р С‘РЎР‚РЎС“Р ВµР С Р В°Р Р†Р В°РЎвЂљР В°РЎР‚
        const avatarEl = document.getElementById('active-call-avatar');
        const miniAvatarEl = document.getElementById('mini-call-avatar');
        if (avatarEl && miniAvatarEl) {
            if (avatarEl.querySelector('img')) {
                miniAvatarEl.innerHTML = avatarEl.innerHTML;
            } else if (avatarEl.querySelector('i')) {
                miniAvatarEl.innerHTML = avatarEl.innerHTML;
            } else {
                miniAvatarEl.innerText = avatarEl.innerText;
            }
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎвЂљР В°Р в„–Р СР ВµРЎР‚ Р Р† Р СР С‘Р Р…Р С‘-Р С—Р В»Р ВµР ВµРЎР‚Р Вµ
        updateMiniCallTimer();
    };
    
    function updateMiniCallTimer() {
        if (!isCallMinimized || !callStartTime) return;
        
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const secs = (elapsed % 60).toString().padStart(2, '0');
        
        const miniTimer = document.getElementById('mini-call-timer');
        if (miniTimer) miniTimer.innerText = `${mins}:${secs}`;
    }
    
    // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎвЂљР В°Р в„–Р СР ВµРЎР‚ Р СР С‘Р Р…Р С‘-Р С—Р В»Р ВµР ВµРЎР‚Р В° Р С”Р В°Р В¶Р Т‘РЎС“РЎР‹ РЎРѓР ВµР С”РЎС“Р Р…Р Т‘РЎС“
    setInterval(updateMiniCallTimer, 1000);
    
    window.expandCall = () => {
        isCallMinimized = false;
        document.getElementById('minimized-call').style.display = 'none';
        document.getElementById('active-call-screen').classList.remove('hidden');
    };

    window.toggleMute = () => {
        if (!localStream) return;
        isMuted = !isMuted;
        localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
        
        const btn = document.getElementById('mute-btn');
        btn.classList.toggle('active', isMuted);
        btn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
    };

    window.toggleVideo = () => {
        if (!localStream) return;
        isVideoOff = !isVideoOff;
        localStream.getVideoTracks().forEach(track => track.enabled = !isVideoOff);
        
        const btn = document.getElementById('video-btn');
        btn.classList.toggle('active', isVideoOff);
        btn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
    };

    window.toggleScreenShare = async () => {
        console.log('toggleScreenShare Р Р†РЎвЂ№Р В·Р Р†Р В°Р Р…Р В°');
        console.log('peerConnection:', peerConnection);
        console.log('localStream:', localStream);
        
        if (!peerConnection || !localStream) {
            console.error('Р СњР ВµРЎвЂљ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°! peerConnection:', !!peerConnection, 'localStream:', !!localStream);
            alert('Р СњР ВµРЎвЂљ Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р С•Р С–Р С• Р В·Р Р†Р С•Р Р…Р С”Р В°! Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р…Р В°РЎвЂЎР Р…Р С‘РЎвЂљР Вµ Р Р†Р С‘Р Т‘Р ВµР С•Р В·Р Р†Р С•Р Р…Р С•Р С”.');
            return;
        }
        
        const btn = document.getElementById('screen-share-btn');
        
        try {
            if (!isScreenSharing) {
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎРЊРЎвЂљР С• Electron Р С‘Р В»Р С‘ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚
                const isElectron = window.electronAPI && window.electronAPI.isElectron;
                
                let screenStream;
                
                if (isElectron) {
                    // Electron: Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С desktopCapturer
                    console.log('Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С Electron desktopCapturer');
                    
                    try {
                        const sources = await window.electronAPI.getSources();
                        
                        if (!sources || sources.length === 0) {
                            alert('Р СњР Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С• Р С‘РЎРѓРЎвЂљР С•РЎвЂЎР Р…Р С‘Р С”Р С•Р Р† Р Т‘Р В»РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°');
                            return;
                        }
                        
                        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р Т‘Р С‘Р В°Р В»Р С•Р С– Р Р†РЎвЂ№Р В±Р С•РЎР‚Р В° Р С‘РЎРѓРЎвЂљР С•РЎвЂЎР Р…Р С‘Р С”Р В°
                        const selectedSource = await showSourcePicker(sources);
                        
                        if (!selectedSource) {
                            console.log('Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р С•РЎвЂљР СР ВµР Р…Р С‘Р В» Р Р†РЎвЂ№Р В±Р С•РЎР‚ Р С‘РЎРѓРЎвЂљР С•РЎвЂЎР Р…Р С‘Р С”Р В°');
                            return;
                        }
                        
                        // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р С—Р С•РЎвЂљР С•Р С” РЎРѓ Р Р†РЎвЂ№Р В±РЎР‚Р В°Р Р…Р Р…Р С•Р С–Р С• Р С‘РЎРѓРЎвЂљР С•РЎвЂЎР Р…Р С‘Р С”Р В°
                        screenStream = await navigator.mediaDevices.getUserMedia({
                            audio: false,
                            video: {
                                mandatory: {
                                    chromeMediaSource: 'desktop',
                                    chromeMediaSourceId: selectedSource.id,
                                    maxWidth: 1920,
                                    maxHeight: 1080,
                                    maxFrameRate: 30
                                }
                            }
                        });
                    } catch (err) {
                        console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Electron screen capture:', err);
                        alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р Р…Р В°РЎвЂЎР В°РЎвЂљРЎРЉ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°: ' + err.message);
                        return;
                    }
                } else {
                    // Р вЂРЎР‚Р В°РЎС“Р В·Р ВµРЎР‚: Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С getDisplayMedia
                    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С HTTPS
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                        alert('Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° РЎвЂљРЎР‚Р ВµР В±РЎС“Р ВµРЎвЂљ HTTPS РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р ВµР Р…Р С‘РЎРЏ. Р С›РЎвЂљР С”РЎР‚Р С•Р в„–РЎвЂљР Вµ РЎРѓР В°Р в„–РЎвЂљ РЎвЂЎР ВµРЎР‚Р ВµР В· https://');
                        return;
                    }
                    
                    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С”РЎС“ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                        if (isMobileDevice()) {
                            alert('Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р Р…Р Вµ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р ВµРЎвЂљРЎРѓРЎРЏ Р Р…Р В° Р СР С•Р В±Р С‘Р В»РЎРЉР Р…РЎвЂ№РЎвЂ¦ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р В°РЎвЂ¦.');
                            return;
                        } else {
                            alert('Р вЂ™Р В°РЎв‚¬ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚ Р Р…Р Вµ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р ВµРЎвЂљ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°.');
                            return;
                        }
                    }
                    
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            width: { ideal: 1920, max: 1920 },
                            height: { ideal: 1080, max: 1080 },
                            frameRate: { ideal: 30, max: 30 }
                        },
                        audio: false
                    });
                }
                
                // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р С•РЎР‚Р С‘Р С–Р С‘Р Р…Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р Р†Р С‘Р Т‘Р ВµР С• РЎвЂљРЎР‚Р ВµР С”
                const videoTrack = localStream.getVideoTracks()[0];
                console.log('Р СћР ВµР С”РЎС“РЎвЂ°Р С‘Р в„– Р Р†Р С‘Р Т‘Р ВµР С• РЎвЂљРЎР‚Р ВµР С” Р Р† localStream:', videoTrack);
                console.log('Р вЂ™РЎРѓР Вµ РЎвЂљРЎР‚Р ВµР С”Р С‘ Р Р† localStream:', localStream.getTracks());
                
                // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• РЎРЊРЎвЂљР С• Р Р†Р С‘Р Т‘Р ВµР С•Р В·Р Р†Р С•Р Р…Р С•Р С”
                if (!videoTrack) {
                    alert('Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…Р В° РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Р† Р Р†Р С‘Р Т‘Р ВµР С•Р В·Р Р†Р С•Р Р…Р С”Р В°РЎвЂ¦. Р СњР В°РЎвЂЎР Р…Р С‘РЎвЂљР Вµ Р Р†Р С‘Р Т‘Р ВµР С•Р В·Р Р†Р С•Р Р…Р С•Р С”, РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљРЎРЉ РЎРЊРЎвЂљРЎС“ РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘РЎР‹.');
                    screenStream.getTracks().forEach(track => track.stop());
                    return;
                }
                
                originalVideoTrack = videoTrack;
                
                // Р вЂ”Р В°Р СР ВµР Р…РЎРЏР ВµР С Р Р†Р С‘Р Т‘Р ВµР С• РЎвЂљРЎР‚Р ВµР С” Р Р…Р В° Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                const screenVideoTrack = screenStream.getVideoTracks()[0];
                console.log('Р вЂ™Р С‘Р Т‘Р ВµР С• РЎвЂљРЎР‚Р ВµР С” Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°:', screenVideoTrack);
                
                // Р ВРЎвЂ°Р ВµР С sender Р Т‘Р В»РЎРЏ Р Р†Р С‘Р Т‘Р ВµР С•
                const sender = peerConnection.getSenders().find(s => 
                    s.track && s.track.kind === 'video'
                );
                
                if (!sender) {
                    console.error('Sender Р Т‘Р В»РЎРЏ Р Р†Р С‘Р Т‘Р ВµР С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…');
                    alert('Р С›РЎв‚¬Р С‘Р В±Р С”Р В°: Р Р…Р Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р Р…Р В°Р в„–РЎвЂљР С‘ Р Р†Р С‘Р Т‘Р ВµР С• Р С—Р С•РЎвЂљР С•Р С”. Р СџР С•Р С—РЎР‚Р С•Р В±РЎС“Р в„–РЎвЂљР Вµ Р С—Р ВµРЎР‚Р ВµР В·Р В°Р С—РЎС“РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ Р В·Р Р†Р С•Р Р…Р С•Р С”.');
                    screenStream.getTracks().forEach(track => track.stop());
                    return;
                }
                
                // Р вЂ”Р В°Р СР ВµР Р…РЎРЏР ВµР С РЎРѓРЎС“РЎвЂ°Р ВµРЎРѓРЎвЂљР Р†РЎС“РЎР‹РЎвЂ°Р С‘Р в„– РЎвЂљРЎР‚Р ВµР С” (Р В±Р ВµР В· Р С—Р ВµРЎР‚Р ВµРЎРѓР С•Р С–Р В»Р В°РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ!)
                console.log('Р вЂ”Р В°Р СР ВµР Р…РЎРЏР ВµР С Р Р†Р С‘Р Т‘Р ВµР С• РЎвЂљРЎР‚Р ВµР С” Р Р…Р В° Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°');
                await sender.replaceTrack(screenVideoTrack);
                console.log('Р вЂ™Р С‘Р Т‘Р ВµР С• РЎвЂљРЎР‚Р ВµР С” Р В·Р В°Р СР ВµР Р…РЎвЂР Р… РЎС“РЎРѓР С—Р ВµРЎв‚¬Р Р…Р С•');
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р С—Р С•РЎвЂљР С•Р С” (Р СњР вЂў Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р С•РЎР‚Р С‘Р С–Р С‘Р Р…Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– РЎвЂљРЎР‚Р ВµР С”!)
                localStream.removeTrack(videoTrack);
                localStream.addTrack(screenVideoTrack);
                // videoTrack Р СњР вЂў Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С - Р С•Р Р… Р Р…РЎС“Р В¶Р ВµР Р… Р Т‘Р В»РЎРЏ Р Р†Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р Р†Р С‘Р Т‘Р ВµР С•
                document.getElementById('local-video').srcObject = localStream;
                console.log('Р вЂєР С•Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р Р†Р С‘Р Т‘Р ВµР С• Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С•');
                
                // replaceTrack() Р СњР вЂў РЎвЂљРЎР‚Р ВµР В±РЎС“Р ВµРЎвЂљ Р С—Р ВµРЎР‚Р ВµРЎРѓР С•Р С–Р В»Р В°РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ!
                // Р вЂ™Р С‘Р Т‘Р ВµР С• Р В°Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ Р С—Р ВµРЎР‚Р ВµР Т‘Р В°РЎвЂРЎвЂљРЎРѓРЎРЏ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…Р Р…Р С•Р в„– РЎРѓРЎвЂљР С•РЎР‚Р С•Р Р…Р Вµ
                
                // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р В·Р В°Р Р†Р ВµРЎР‚РЎв‚¬Р ВµР Р…Р С‘Р Вµ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                screenVideoTrack.addEventListener('ended', () => {
                    stopScreenShare();
                });
                
                isScreenSharing = true;
                btn.classList.add('screen-sharing');
                btn.innerHTML = '<i class="fas fa-desktop"></i>';
                btn.title = 'Р С›РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°';
                
                // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
                showScreenShareNotification('Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р Р…Р В°РЎвЂЎР В°РЎвЂљР В°');
                
                // Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»РЎРЏР ВµР С Р Т‘РЎР‚РЎС“Р С–Р С‘РЎвЂ¦ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р† РЎвЂЎР ВµРЎР‚Р ВµР В· Firebase (Р Т‘Р В»РЎРЏ Р С—Р С•Р С”Р В°Р В·Р В° Р С‘Р Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚Р В°)
                if (currentCallId) {
                    if (isGroupCall) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId), {
                            screenSharing: {
                                userId: me.uid,
                                userName: me.username,
                                isSharing: true,
                                timestamp: serverTimestamp()
                            }
                        }, { merge: true });
                    } else {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                            screenSharing: {
                                userId: me.uid,
                                userName: me.username,
                                isSharing: true,
                                timestamp: serverTimestamp()
                            }
                        }, { merge: true });
                    }
                }
                
            } else {
                // Р С›РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
                await stopScreenShare();
            }
        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°:', err);
            const isElectronApp = window.electronAPI && window.electronAPI.isElectron;
            
            if (err.name === 'NotAllowedError') {
                alert('Р вЂќР С•РЎРѓРЎвЂљРЎС“Р С— Р С” Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р С•РЎвЂљР С”Р В»Р С•Р Р…РЎвЂР Р…. Р В Р В°Р В·РЎР‚Р ВµРЎв‚¬Р С‘РЎвЂљР Вµ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С— Р Р† Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р Вµ.');
            } else if (err.name === 'NotSupportedError') {
                alert('Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р Р…Р Вµ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р ВµРЎвЂљРЎРѓРЎРЏ Р Р…Р В° РЎРЊРЎвЂљР С•Р С РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р Вµ');
            } else if (err.name === 'NotFoundError') {
                alert('Р СњР Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С• РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р С• Р Т‘Р В»РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°');
            } else if (err.name === 'AbortError') {
                // Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р С•РЎвЂљР СР ВµР Р…Р С‘Р В» Р Р†РЎвЂ№Р В±Р С•РЎР‚ РЎРЊР С”РЎР‚Р В°Р Р…Р В° - РЎРЊРЎвЂљР С• Р Р…Р С•РЎР‚Р СР В°Р В»РЎРЉР Р…Р С•, Р Р…Р Вµ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С•РЎв‚¬Р С‘Р В±Р С”РЎС“
                console.log('Р СџР С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р С•РЎвЂљР СР ВµР Р…Р С‘Р В» Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°');
            } else if (!isElectronApp && location.protocol !== 'https:' && location.hostname !== 'localhost') {
                alert('Р вЂќР В»РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В° РЎвЂљРЎР‚Р ВµР В±РЎС“Р ВµРЎвЂљРЎРѓРЎРЏ HTTPS РЎРѓР С•Р ВµР Т‘Р С‘Р Р…Р ВµР Р…Р С‘Р Вµ');
            } else {
                alert('Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р Р…Р В°РЎвЂЎР В°РЎвЂљРЎРЉ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹ РЎРЊР С”РЎР‚Р В°Р Р…Р В°: ' + err.message);
            }
        }
    };

    async function stopScreenShare() {
        if (!isScreenSharing || !peerConnection) return;
        
        try {
            // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р в„– Р Р†Р С‘Р Т‘Р ВµР С• РЎвЂљРЎР‚Р ВµР С” (Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В°)
            const screenTrack = localStream.getVideoTracks()[0];
            
            // Р ВРЎвЂ°Р ВµР С sender Р Т‘Р В»РЎРЏ Р Р†Р С‘Р Т‘Р ВµР С•
            const sender = peerConnection.getSenders().find(s => 
                s.track && s.track.kind === 'video'
            );
            
            // Р вЂ™Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµР С Р С•РЎР‚Р С‘Р С–Р С‘Р Р…Р В°Р В»РЎРЉР Р…РЎС“РЎР‹ Р С”Р В°Р СР ВµРЎР‚РЎС“ Р ВµРЎРѓР В»Р С‘ Р В±РЎвЂ№Р В»Р В° РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р В°
            if (originalVideoTrack && sender) {
                try {
                    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, РЎвЂЎРЎвЂљР С• Р С•РЎР‚Р С‘Р С–Р С‘Р Р…Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– РЎвЂљРЎР‚Р ВµР С” Р ВµРЎвЂ°РЎвЂ Р В¶Р С‘Р Р†
                    if (originalVideoTrack.readyState === 'live') {
                        // Р вЂ”Р В°Р СР ВµР Р…РЎРЏР ВµР С РЎвЂљРЎР‚Р ВµР С” Р С•Р В±РЎР‚Р В°РЎвЂљР Р…Р С• Р Р…Р В° Р С”Р В°Р СР ВµРЎР‚РЎС“
                        await sender.replaceTrack(originalVideoTrack);
                        
                        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– Р С—Р С•РЎвЂљР С•Р С”
                        if (screenTrack) {
                            localStream.removeTrack(screenTrack);
                            screenTrack.stop();
                        }
                        localStream.addTrack(originalVideoTrack);
                        
                        // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С РЎвЂљР ВµР С”РЎС“РЎвЂ°Р ВµР Вµ РЎРѓР С•РЎРѓРЎвЂљР С•РЎРЏР Р…Р С‘Р Вµ Р Р†Р С‘Р Т‘Р ВµР С•
                        originalVideoTrack.enabled = !isVideoOff;
                        
                        console.log('Р С™Р В°Р СР ВµРЎР‚Р В° Р Р†Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р В°');
                    } else {
                        // Р С›РЎР‚Р С‘Р С–Р С‘Р Р…Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– РЎвЂљРЎР‚Р ВµР С” Р СРЎвЂРЎР‚РЎвЂљР Р†, Р Р…РЎС“Р В¶Р Р…Р С• Р В·Р В°Р С—РЎР‚Р С•РЎРѓР С‘РЎвЂљРЎРЉ Р Р…Р С•Р Р†РЎвЂ№Р в„–
                        console.log('Р С›РЎР‚Р С‘Р С–Р С‘Р Р…Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– РЎвЂљРЎР‚Р ВµР С” Р Р…Р ВµР Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р ВµР Р…, Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂЎРЎвЂРЎР‚Р Р…РЎвЂ№Р в„– РЎРЊР С”РЎР‚Р В°Р Р…');
                        // Р СџРЎР‚Р С•РЎРѓРЎвЂљР С• Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹, Р С”Р В°Р СР ВµРЎР‚Р В° Р В±РЎС“Р Т‘Р ВµРЎвЂљ РЎвЂЎРЎвЂРЎР‚Р Р…Р С•Р в„–
                        if (screenTrack) {
                            localStream.removeTrack(screenTrack);
                            screenTrack.stop();
                        }
                    }
                } catch (err) {
                    console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Р†Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р С”Р В°Р СР ВµРЎР‚РЎвЂ№:', err);
                    // Р СџРЎР‚Р С•РЎРѓРЎвЂљР С• Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹
                    if (screenTrack) {
                        localStream.removeTrack(screenTrack);
                        screenTrack.stop();
                    }
                }
            } else {
                // Р СњР ВµРЎвЂљ Р С•РЎР‚Р С‘Р С–Р С‘Р Р…Р В°Р В»РЎРЉР Р…Р С•Р С–Р С• РЎвЂљРЎР‚Р ВµР С”Р В°, Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р С•РЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹
                if (screenTrack) {
                    localStream.removeTrack(screenTrack);
                    screenTrack.stop();
                }
            }
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р Р†Р С‘Р Т‘Р ВµР С•
            document.getElementById('local-video').srcObject = localStream;
            
            isScreenSharing = false;
            originalVideoTrack = null;
            
            const btn = document.getElementById('screen-share-btn');
            btn.classList.remove('screen-sharing');
            btn.innerHTML = '<i class="fas fa-desktop"></i>';
            btn.title = 'Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В°';
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
            showScreenShareNotification('Р вЂќР ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р В°');
            
            // Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»РЎРЏР ВµР С Р Т‘РЎР‚РЎС“Р С–Р С‘РЎвЂ¦ РЎС“РЎвЂЎР В°РЎРѓРЎвЂљР Р…Р С‘Р С”Р С•Р Р† РЎвЂЎР ВµРЎР‚Р ВµР В· Firebase
            if (currentCallId) {
                if (isGroupCall) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'group_calls', currentCallId), {
                        screenSharing: {
                            userId: me.uid,
                            userName: me.username,
                            isSharing: false,
                            timestamp: serverTimestamp()
                        }
                    }, { merge: true });
                } else {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                        screenSharing: {
                            userId: me.uid,
                            userName: me.username,
                            isSharing: false,
                            timestamp: serverTimestamp()
                        }
                    }, { merge: true });
                }
            }
            
        } catch (err) {
            console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С”Р С‘ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°:', err);
        }
    }

    // Р вЂќР С‘Р В°Р В»Р С•Р С– Р Р†РЎвЂ№Р В±Р С•РЎР‚Р В° Р С‘РЎРѓРЎвЂљР С•РЎвЂЎР Р…Р С‘Р С”Р В° Р Т‘Р В»РЎРЏ Electron
    function showSourcePicker(sources) {
        return new Promise((resolve) => {
            // Р РЋР С•Р В·Р Т‘Р В°РЎвЂР С Р СР С•Р Т‘Р В°Р В»РЎРЉР Р…Р С•Р Вµ Р С•Р С”Р Р…Р С•
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[300] flex items-center justify-center bg-black/70';
            modal.innerHTML = `
                <div class="glass-panel rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Р вЂ™РЎвЂ№Р В±Р ВµРЎР‚Р С‘РЎвЂљР Вµ Р С‘РЎРѓРЎвЂљР С•РЎвЂЎР Р…Р С‘Р С” Р Т‘Р В»РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘</h3>
                        <button class="close-picker text-2xl opacity-60 hover:opacity-100">&times;</button>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 overflow-y-auto flex-1 source-grid">
                        ${sources.map(source => `
                            <div class="source-item cursor-pointer rounded-xl border-2 border-transparent hover:border-indigo-500 p-2 transition-all" data-id="${source.id}">
                                <img src="${source.thumbnail}" class="w-full h-24 object-cover rounded-lg bg-gray-800" alt="${source.name}">
                                <p class="text-sm mt-2 truncate text-center">${source.name}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Р С›Р В±РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”Р С‘
            modal.querySelector('.close-picker').onclick = () => {
                modal.remove();
                resolve(null);
            };
            
            modal.querySelectorAll('.source-item').forEach(item => {
                item.onclick = () => {
                    const id = item.dataset.id;
                    const source = sources.find(s => s.id === id);
                    modal.remove();
                    resolve(source);
                };
            });
            
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ Р С—Р С• Р С”Р В»Р С‘Р С”РЎС“ Р Р…Р В° РЎвЂћР С•Р Р…
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    resolve(null);
                }
            };
        });
    }

    function showScreenShareNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'screen-share-notification';
        notification.innerHTML = `<i class="fas fa-desktop"></i> ${message}`;
        
        const callScreen = document.getElementById('active-call-screen');
        if (callScreen) {
            callScreen.appendChild(notification);
            
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· 3 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘РЎвЂ№
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С‘Р Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°
        const indicator = document.getElementById('screen-share-indicator');
        const userSpan = document.getElementById('screen-share-user');
        
        if (message.includes('Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚РЎС“Р ВµРЎвЂљ РЎРЊР С”РЎР‚Р В°Р Р…')) {
            const userName = message.split(' Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р С‘РЎР‚РЎС“Р ВµРЎвЂљ РЎРЊР С”РЎР‚Р В°Р Р…')[0];
            userSpan.textContent = userName;
            indicator.classList.remove('hidden');
        } else if (message.includes('Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘Р В» Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘РЎР‹') || message.includes('Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р В°')) {
            indicator.classList.add('hidden');
        }
    }

    let isWatchingScreen = false;
    window.toggleScreenWatch = () => {
        console.log('toggleScreenWatch Р Р†РЎвЂ№Р В·Р Р†Р В°Р Р…Р В°');
        
        const remoteVideo = document.getElementById('remote-video');
        const localVideo = document.getElementById('local-video');
        const watchBtn = document.getElementById('watch-screen-btn');
        const videoContainer = document.getElementById('active-call-screen');
        
        console.log('Р В­Р В»Р ВµР СР ВµР Р…РЎвЂљРЎвЂ№:', { remoteVideo, localVideo, watchBtn, videoContainer });
        
        if (!remoteVideo) {
            console.error('remote-video Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…');
            return;
        }
        if (!localVideo) {
            console.error('local-video Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…');
            return;
        }
        if (!watchBtn) {
            console.error('watch-screen-btn Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…');
            return;
        }
        
        isWatchingScreen = !isWatchingScreen;
        console.log('isWatchingScreen:', isWatchingScreen);
        
        if (isWatchingScreen) {
            console.log('Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С РЎР‚Р ВµР В¶Р С‘Р С Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р В°');
            // Р СџР ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР СРЎРѓРЎРЏ Р Р…Р В° Р С—Р С•Р В»Р Р…Р С•РЎРЊР С”РЎР‚Р В°Р Р…Р Р…РЎвЂ№Р в„– Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘
            remoteVideo.style.objectFit = 'contain';
            remoteVideo.style.backgroundColor = '#000';
            localVideo.style.width = '120px';
            localVideo.style.height = '160px';
            localVideo.style.bottom = '20px';
            localVideo.style.right = '20px';
            watchBtn.textContent = 'Р РЋР Р†Р ВµРЎР‚Р Р…РЎС“РЎвЂљРЎРЉ';
            watchBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            watchBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
            showScreenShareNotification('Р СџРЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°');
            console.log('Р В Р ВµР В¶Р С‘Р С Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р В° Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…');
        } else {
            console.log('Р вЂ™РЎвЂ№Р С”Р В»РЎР‹РЎвЂЎР В°Р ВµР С РЎР‚Р ВµР В¶Р С‘Р С Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р В°');
            // Р вЂ™Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµР СРЎРѓРЎРЏ Р С” Р С•Р В±РЎвЂ№РЎвЂЎР Р…Р С•Р СРЎС“ Р Р†Р С‘Р Т‘РЎС“
            remoteVideo.style.objectFit = 'cover';
            remoteVideo.style.backgroundColor = '';
            localVideo.style.width = '150px';
            localVideo.style.height = '200px';
            localVideo.style.bottom = '120px';
            localVideo.style.right = '20px';
            watchBtn.textContent = 'Р РЋР СР С•РЎвЂљРЎР‚Р ВµРЎвЂљРЎРЉ';
            watchBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            watchBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            console.log('Р В Р ВµР В¶Р С‘Р С Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р В° Р Р†РЎвЂ№Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…');
        }
    };
    
    // Р СћР вЂўР РЋР СћР С›Р вЂ™Р С’Р Р‡ Р В¤Р Р€Р СњР С™Р В¦Р ВР Р‡ - Р Т‘Р В»РЎРЏ Р С•РЎвЂљР В»Р В°Р Т‘Р С”Р С‘ (РЎС“Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ Р С—Р С•РЎРѓР В»Р Вµ РЎвЂљР ВµРЎРѓРЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘РЎРЏ)
    window.testScreenShareIndicator = () => {
        const indicator = document.getElementById('screen-share-indicator');
        if (indicator) {
            indicator.classList.toggle('hidden');
            console.log('Р ВР Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В°:', indicator.classList.contains('hidden') ? 'РЎРѓР С”РЎР‚РЎвЂ№РЎвЂљ' : 'Р С—Р С•Р С”Р В°Р В·Р В°Р Р…');
        }
    };

    let isSpeakerOff = false;
    let isSpeakerphone = false; // Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ
    
    window.toggleSpeaker = () => {
        isSpeakerOff = !isSpeakerOff;
        const remoteVideo = document.getElementById('remote-video');
        if (remoteVideo) {
            remoteVideo.muted = isSpeakerOff;
        }
        
        const btn = document.getElementById('speaker-btn');
        btn.classList.toggle('active', isSpeakerOff);
        btn.innerHTML = isSpeakerOff ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    };
    
    // Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ (speakerphone)
    window.toggleSpeakerphone = async () => {
        isSpeakerphone = !isSpeakerphone;
        const remoteVideo = document.getElementById('remote-video');
        const btn = document.getElementById('speakerphone-btn');
        
        if (remoteVideo) {
            // Р СџРЎР‚Р С•Р В±РЎС“Р ВµР С Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљРЎРЉ setSinkId Р Т‘Р В»РЎРЏ Р С—Р ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘РЎРЏ Р В°РЎС“Р Т‘Р С‘Р С•Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘Р В°
            if (typeof remoteVideo.setSinkId === 'function') {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioOutputs = devices.filter(d => d.kind === 'audiooutput');
                    
                    if (audioOutputs.length > 1) {
                        // Р СџР ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР В°Р ВµР СРЎРѓРЎРЏ Р СР ВµР В¶Р Т‘РЎС“ РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р В°Р СР С‘
                        const currentIndex = audioOutputs.findIndex(d => d.deviceId === (remoteVideo.sinkId || 'default'));
                        const nextIndex = (currentIndex + 1) % audioOutputs.length;
                        await remoteVideo.setSinkId(audioOutputs[nextIndex].deviceId);
                        showToast(isSpeakerphone ? 'Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р В°' : 'Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ Р Р†РЎвЂ№Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р В°', 'СЂСџвЂќР‰');
                    } else {
                        // Р вЂўРЎРѓР В»Р С‘ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С•Р Т‘Р Р…Р С• РЎС“РЎРѓРЎвЂљРЎР‚Р С•Р в„–РЎРѓРЎвЂљР Р†Р С• - Р СР ВµР Р…РЎРЏР ВµР С Р С–РЎР‚Р С•Р СР С”Р С•РЎРѓРЎвЂљРЎРЉ
                        remoteVideo.volume = isSpeakerphone ? 1.0 : 0.5;
                        showToast(isSpeakerphone ? 'Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р В°' : 'Р С›Р В±РЎвЂ№РЎвЂЎР Р…РЎвЂ№Р в„– РЎР‚Р ВµР В¶Р С‘Р С', 'СЂСџвЂќР‰');
                    }
                } catch (err) {
                    console.log('setSinkId not supported, using volume fallback');
                    remoteVideo.volume = isSpeakerphone ? 1.0 : 0.5;
                    showToast(isSpeakerphone ? 'Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р В°' : 'Р С›Р В±РЎвЂ№РЎвЂЎР Р…РЎвЂ№Р в„– РЎР‚Р ВµР В¶Р С‘Р С', 'СЂСџвЂќР‰');
                }
            } else {
                // Fallback - Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• Р СР ВµР Р…РЎРЏР ВµР С Р С–РЎР‚Р С•Р СР С”Р С•РЎРѓРЎвЂљРЎРЉ
                remoteVideo.volume = isSpeakerphone ? 1.0 : 0.5;
                showToast(isSpeakerphone ? 'Р вЂњРЎР‚Р С•Р СР С”Р В°РЎРЏ РЎРѓР Р†РЎРЏР В·РЎРЉ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р В°' : 'Р С›Р В±РЎвЂ№РЎвЂЎР Р…РЎвЂ№Р в„– РЎР‚Р ВµР В¶Р С‘Р С', 'СЂСџвЂќР‰');
            }
        }
        
        if (btn) {
            btn.classList.toggle('speakerphone-active', isSpeakerphone);
            btn.innerHTML = isSpeakerphone 
                ? '<i class="fas fa-volume-up"></i>' 
                : '<i class="fas fa-phone-volume"></i>';
        }
    };

    // Р вЂ”Р В°Р С—РЎС“РЎРѓР С”Р В°Р ВµР С РЎРѓР В»РЎС“РЎв‚¬Р В°РЎвЂљР ВµР В»РЎРЉ Р В·Р Р†Р С•Р Р…Р С”Р С•Р Р† Р С—Р С•РЎРѓР В»Р Вµ Р В°Р Р†РЎвЂљР С•РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘Р С‘
    const originalShowApp = showApp;
    window.showApp = showApp = function() {
        originalShowApp.call ? originalShowApp.call(this) : originalShowApp();
        listenForCalls();
        // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р С‘РЎР‚РЎС“Р ВµР С push-РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
        if (typeof initNotifications === 'function') {
            initNotifications();
        }
    };
    
    // ========== Р Р€Р вЂ™Р вЂўР вЂќР С›Р СљР вЂєР вЂўР СњР ВР Р‡ (РЎРѓ Р Р†Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘Р ВµР в„– Р Т‘Р В»РЎРЏ Firefox Android) ==========
    let notificationsEnabled = false;
    const vibrationSupported = 'vibrate' in navigator;
    const notificationSupported = 'Notification' in window;
    
    console.log('Vibration:', vibrationSupported, 'Notification:', notificationSupported);
    
    if (notificationSupported) {
        notificationsEnabled = Notification.permission === 'granted';
    }
    
    // Р вЂ”Р В°Р С—РЎР‚Р С•РЎРѓ РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘РЎРЏ Р Р…Р В° РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
    window.requestNotificationPermission = async () => {
        // Р вЂ™Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљР В°Р ВµРЎвЂљ Р Р† Firefox Android
        if (vibrationSupported) navigator.vibrate([200, 100, 200]);
        
        if (!notificationSupported) {
            showToast('Р РЋР С‘РЎРѓРЎвЂљР ВµР СР Р…РЎвЂ№Р Вµ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р Р…Р ВµР Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р Р…РЎвЂ№. Р вЂРЎС“Р Т‘Р ВµРЎвЂљ Р Р†Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘РЎРЏ!', 'СЂСџвЂњС–');
            notificationsEnabled = vibrationSupported;
            updatePushButton();
            return vibrationSupported;
        }
        
        console.log('Current permission:', Notification.permission);
        
        if (Notification.permission === 'granted') {
            notificationsEnabled = true;
            updatePushButton();
            showToast('Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ РЎС“Р В¶Р Вµ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№!', 'РІСљвЂ¦');
            return true;
        }
        
        if (Notification.permission === 'denied') {
            showToast('Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С•. Р вЂРЎС“Р Т‘Р ВµРЎвЂљ Р Р†Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘РЎРЏ.', 'РїС—Р…');
            notificationsEnabled = vibrationSupported;
            updatePushButton();
            return vibrationSupported;
        }
        
        try {
            const permission = await Notification.requestPermission();
            notificationsEnabled = permission === 'granted' || vibrationSupported;
            
            if (permission === 'granted') {
                showToast('Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№!', 'СЂСџвЂќвЂќ');
                setTimeout(() => sendTestNotification(), 500);
            } else {
                showToast('Р вЂРЎС“Р Т‘Р ВµРЎвЂљ Р Р†Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘РЎРЏ + Р В·Р Р†РЎС“Р С”', 'РїС—Р…');
            }
            
            updatePushButton();
            return notificationsEnabled;
        } catch (e) {
            showToast('Р вЂРЎС“Р Т‘Р ВµРЎвЂљ Р Р†Р С‘Р В±РЎР‚Р В°РЎвЂ Р С‘РЎРЏ', 'СЂСџвЂњС–');
            notificationsEnabled = vibrationSupported;
            updatePushButton();
            return vibrationSupported;
        }
    };
    
    // Р СћР ВµРЎРѓРЎвЂљР С•Р Р†Р С•Р Вµ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ
    window.sendTestNotification = () => {
        console.log('РїС—Р… Sending test notification...');
        
        if (!('Notification' in window)) {
            showToast('Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р Р…Р Вµ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°РЎР‹РЎвЂљРЎРѓРЎРЏ', 'РІСњРЉ');
            return;
        }
        
        if (Notification.permission !== 'granted') {
            showToast('Р РЋР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р†Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљР Вµ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ', 'РІС™В РїС‘РЏ');
            return;
        }
        
        try {
            const notification = new Notification('Flickers - Р СћР ВµРЎРѓРЎвЂљ', {
                body: 'Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљР В°РЎР‹РЎвЂљ! СЂСџР‹вЂ°',
                icon: 'icon-128.png',
                tag: 'test-' + Date.now(),
                requireInteraction: false
            });
            
            notification.onclick = () => {
                window.focus();
                notification.close();
            };
            
            // Р С’Р Р†РЎвЂљР С•Р В·Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· 5 РЎРѓР ВµР С”
            setTimeout(() => notification.close(), 5000);
            
            console.log('РІСљвЂ¦ Test notification sent');
            showToast('Р Р€Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р Вµ Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С•!', 'РІСљвЂ¦');
        } catch (e) {
            console.error('РІСњРЉ Notification error:', e);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В°: ' + e.message, 'РІСњРЉ');
        }
    };
    
    // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В° РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р С• Р Р…Р С•Р Р†Р С•Р С РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р С‘
    window.sendPushNotification = (title, body, data = {}) => {
        console.log('СЂСџвЂњВ¤ sendPushNotification:', { title, body });
        
        // Р СњР Вµ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р ВµРЎРѓР В»Р С‘ Р Р†Р С”Р В»Р В°Р Т‘Р С”Р В° Р В°Р С”РЎвЂљР С‘Р Р†Р Р…Р В° (Р С”РЎР‚Р С•Р СР Вµ РЎвЂљР ВµРЎРѓРЎвЂљР С•Р Р†РЎвЂ№РЎвЂ¦)
        if (!data.test && document.visibilityState === 'visible' && document.hasFocus()) {
            console.log('РІРЏВ­РїС‘РЏ Tab is active, skipping notification');
            return;
        }
        
        if (!('Notification' in window)) {
            console.log('РІСњРЉ Notifications not supported');
            return;
        }
        
        if (Notification.permission !== 'granted') {
            console.log('РІС™В РїС‘РЏ Notifications not granted');
            return;
        }
        
        try {
            const notification = new Notification(title, {
                body: body,
                icon: 'icon-128.png',
                tag: 'msg-' + (data.chatPartnerId || Date.now()),
                requireInteraction: false
            });
            
            notification.onclick = () => {
                window.focus();
                if (data.chatPartnerId && data.chatPartnerName) {
                    selectChat({ uid: data.chatPartnerId, username: data.chatPartnerName });
                }
                notification.close();
            };
            
            // Р С’Р Р†РЎвЂљР С•Р В·Р В°Р С”РЎР‚РЎвЂ№РЎвЂљР С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· 8 РЎРѓР ВµР С”
            setTimeout(() => notification.close(), 8000);
            
            console.log('РІСљвЂ¦ Notification sent');
        } catch (e) {
            console.error('РІСњРЉ Notification error:', e);
        }
    };
    
    // Р С’Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘Р в„– Р В·Р В°Р С—РЎР‚Р С•РЎРѓ РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘РЎРЏ Р С—РЎР‚Р С‘ Р С—Р ВµРЎР‚Р Р†Р С•Р С Р Р†РЎвЂ¦Р С•Р Т‘Р Вµ
    window.initNotifications = async () => {
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С UI Р С”Р Р…Р С•Р С—Р С”Р С‘
        updatePushButton();
        
        if ('Notification' in window && Notification.permission === 'default') {
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”РЎС“ Р Т‘Р В»РЎРЏ Р В·Р В°Р С—РЎР‚Р С•РЎРѓР В° РЎР‚Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘РЎРЏ
            setTimeout(() => {
                if (Notification.permission === 'default') {
                    showNotificationPrompt();
                }
            }, 5000);
        } else if (Notification.permission === 'granted') {
            notificationsEnabled = true;
        }
    };
    
    // Р С›Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р Вµ UI Р С”Р Р…Р С•Р С—Р С”Р С‘ push-РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р в„–
    window.updatePushButton = () => {
        const btn = document.getElementById('push-permission-btn');
        if (!btn) return;
        
        if (!('Notification' in window)) {
            btn.textContent = 'Р СњР Вµ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р ВµРЎвЂљРЎРѓРЎРЏ';
            btn.disabled = true;
            btn.className = 'px-3 py-1 rounded-lg bg-slate-300 text-slate-500 text-xs font-bold cursor-not-allowed';
        } else if (Notification.permission === 'granted') {
            btn.textContent = 'РІСљвЂњ Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№';
            btn.className = 'px-3 py-1 rounded-lg bg-green-500 text-white text-xs font-bold';
            btn.onclick = null;
        } else if (Notification.permission === 'denied') {
            btn.textContent = 'Р вЂ”Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…РЎвЂ№';
            btn.className = 'px-3 py-1 rounded-lg bg-red-500/20 text-red-500 text-xs font-bold';
            btn.onclick = () => showToast('Р В Р В°Р В·Р В±Р В»Р С•Р С”Р С‘РЎР‚РЎС“Р в„–РЎвЂљР Вµ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ Р Р† Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В°РЎвЂ¦ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р В°', 'СЂСџвЂќвЂ™');
        } else {
            btn.textContent = 'Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ';
            btn.className = 'px-3 py-1 rounded-lg bg-indigo-500 text-white text-xs font-bold';
        }
    };
    
    // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С—РЎР‚Р С•Р СР С—РЎвЂљ Р Т‘Р В»РЎРЏ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘РЎРЏ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘Р в„–
    window.showNotificationPrompt = () => {
        const prompt = document.createElement('div');
        prompt.className = 'notification-prompt';
        prompt.innerHTML = `
            <div class="notification-prompt-content">
                <i class="fas fa-bell text-2xl text-indigo-500"></i>
                <div>
                    <p class="font-bold">Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ?</p>
                    <p class="text-xs opacity-60">Р СџР С•Р В»РЎС“РЎвЂЎР В°Р в„–РЎвЂљР Вµ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎРЏ Р Т‘Р В°Р В¶Р Вµ Р С”Р С•Р С–Р Т‘Р В° Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚ РЎРѓР Р†РЎвЂРЎР‚Р Р…РЎС“РЎвЂљ</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="this.closest('.notification-prompt').remove()" class="px-3 py-1 rounded-lg bg-slate-200 dark:bg-slate-700 text-sm">Р СџР С•Р В·Р В¶Р Вµ</button>
                    <button onclick="requestNotificationPermission(); this.closest('.notification-prompt').remove()" class="px-3 py-1 rounded-lg bg-indigo-500 text-white text-sm">Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљРЎРЉ</button>
                </div>
            </div>
        `;
        document.body.appendChild(prompt);
        
        // Р С’Р Р†РЎвЂљР С•РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· 10 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘
        setTimeout(() => prompt.remove(), 10000);
    };
    
    // ========== Р ВР Р…Р Т‘Р С‘Р С”Р В°РЎвЂљР С•РЎР‚ "Р С—Р ВµРЎвЂЎР В°РЎвЂљР В°Р ВµРЎвЂљ..." ==========
    let typingTimeout = null;
    let amITyping = false;
    let partnerTypingUnsub = null;
    
    // Р С›РЎвЂљР С—РЎР‚Р В°Р Р†Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ Р С”Р С•Р С–Р Т‘Р В° Р С—Р ВµРЎвЂЎР В°РЎвЂљР В°Р ВµР С
    window.onTyping = async () => {
        if (!activeChatPartner || !me) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        if (!amITyping) {
            amITyping = true;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'typing', me.uid), {
                    isTyping: true,
                    timestamp: serverTimestamp()
                });
            } catch (e) {}
        }
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(async () => {
            amITyping = false;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'typing', me.uid), {
                    isTyping: false,
                    timestamp: serverTimestamp()
                });
            } catch (e) {}
        }, 2000);
    };
    
    // Р РЋР В»РЎС“РЎв‚¬Р В°Р ВµР С Р С”Р С•Р С–Р Т‘Р В° РЎРѓР С•Р В±Р ВµРЎРѓР ВµР Т‘Р Р…Р С‘Р С” Р С—Р ВµРЎвЂЎР В°РЎвЂљР В°Р ВµРЎвЂљ
    function listenToPartnerTyping(partnerId) {
        if (partnerTypingUnsub) {
            partnerTypingUnsub();
            partnerTypingUnsub = null;
        }
        if (!me || !partnerId) return;
        
        const chatId = [me.uid, partnerId].sort().join('_');
        const onlineStatus = document.getElementById('online-status');
        
        partnerTypingUnsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'typing', partnerId), (snap) => {
            if (!onlineStatus) return;
            
            let showTyping = false;
            if (snap.exists()) {
                const data = snap.data();
                if (data.isTyping && data.timestamp) {
                    const typingTime = data.timestamp.seconds ? data.timestamp.seconds * 1000 : data.timestamp;
                    // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂљР С•Р В»РЎРЉР С”Р С• Р ВµРЎРѓР В»Р С‘ timestamp РЎРѓР Р†Р ВµР В¶Р С‘Р в„– (Р СР ВµР Р…Р ВµР Вµ 3 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘)
                    showTyping = (Date.now() - typingTime) < 3000;
                }
            }
            
            if (showTyping) {
                onlineStatus.innerHTML = '<span class="text-indigo-500 animate-pulse">' + (currentLang === 'ru' ? 'Р С—Р ВµРЎвЂЎР В°РЎвЂљР В°Р ВµРЎвЂљ...' : 'typing...') + '</span>';
            } else {
                // Р вЂ™Р С•РЎРѓРЎРѓРЎвЂљР В°Р Р…Р В°Р Р†Р В»Р С‘Р Р†Р В°Р ВµР С Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ
                if (activeChatPartner) {
                    getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', activeChatPartner.uid)).then(userDoc => {
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            const isOnline = userData.isOnline === true;
                            if (isOnline) {
                                onlineStatus.innerHTML = '<span class="text-green-500">' + (currentLang === 'ru' ? 'Р Р† РЎРѓР ВµРЎвЂљР С‘' : 'online') + '</span>';
                            } else {
                                onlineStatus.innerHTML = formatLastSeen(userData.lastSeen);
                            }
                        }
                    }).catch(() => {});
                }
            }
        });
    }
    
    // ========== Р В¤Р ВР В§Р С’ 2: Р вЂРЎвЂ№РЎРѓРЎвЂљРЎР‚РЎвЂ№Р Вµ Р С•РЎвЂљР Р†Р ВµРЎвЂљРЎвЂ№ ==========
    window.toggleQuickReplies = () => {
        const panel = document.getElementById('quick-replies-panel');
        panel.classList.toggle('active');
        
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р Т‘РЎР‚РЎС“Р С–Р С‘Р Вµ Р С—Р В°Р Р…Р ВµР В»Р С‘
        document.getElementById('sticker-panel').classList.remove('active');
        document.getElementById('ai-panel').classList.add('hidden');
    };
    
    window.useQuickReply = (text) => {
        const mobileInput = document.getElementById('msg-input');
        const desktopInput = document.getElementById('msg-input-desktop');
        const isMobile = window.innerWidth <= 768;
        
        if (mobileInput) mobileInput.value = text;
        if (desktopInput) desktopInput.value = text;
        
        document.getElementById('quick-replies-panel').classList.remove('active');
        
        if (isMobile && mobileInput) {
            mobileInput.focus();
        } else if (desktopInput) {
            desktopInput.focus();
        }
        handleInputChange();
    };
    
    // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—Р В°Р Р…Р ВµР В»РЎРЉ Р С—РЎР‚Р С‘ Р С”Р В»Р С‘Р С”Р Вµ Р Р†Р Р…Р Вµ
    document.addEventListener('click', (e) => {
        const panel = document.getElementById('quick-replies-panel');
        const btn = e.target.closest('[onclick*="toggleQuickReplies"]');
        if (panel && !panel.contains(e.target) && !btn) {
            panel.classList.remove('active');
        }
    });
    
    // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ Р В°РЎС“Р Т‘Р С‘Р С• Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљР В° Р С—РЎР‚Р С‘ Р С—Р ВµРЎР‚Р Р†Р С•Р С Р Р†Р В·Р В°Р С‘Р СР С•Р Т‘Р ВµР в„–РЎРѓРЎвЂљР Р†Р С‘Р С‘ (Р Р†Р В°Р В¶Р Р…Р С• Р Т‘Р В»РЎРЏ iOS)
    let audioContextInitialized = false;
    document.addEventListener('click', async () => {
        if (!audioContextInitialized && isMobileDevice()) {
            await fixIOSAudioContext();
            audioContextInitialized = true;
        }
    }, { once: true });
    
    // Р СџРЎР‚Р ВµР Т‘РЎС“Р С—РЎР‚Р ВµР В¶Р Т‘Р ВµР Р…Р С‘Р Вµ Р С• HTTP Р Т‘Р В»РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В° (РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Т‘Р В»РЎРЏ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р В°, Р Р…Р Вµ Р Т‘Р В»РЎРЏ Electron)
    const isElectronApp = window.electronAPI && window.electronAPI.isElectron;
    if (!isElectronApp && location.protocol !== 'https:' && location.hostname !== 'localhost' && location.protocol !== 'file:') {
        const warning = document.createElement('div');
        warning.className = 'http-warning';
        warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Р вЂќР В»РЎРЏ Р Т‘Р ВµР СР С•Р Р…РЎРѓРЎвЂљРЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРЊР С”РЎР‚Р В°Р Р…Р В° Р Р…РЎС“Р В¶Р ВµР Р… HTTPS';
        document.body.appendChild(warning);
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—РЎР‚Р ВµР Т‘РЎС“Р С—РЎР‚Р ВµР В¶Р Т‘Р ВµР Р…Р С‘Р Вµ РЎвЂЎР ВµРЎР‚Р ВµР В· 10 РЎРѓР ВµР С”РЎС“Р Р…Р Т‘
        setTimeout(() => {
            if (warning.parentNode) {
                warning.parentNode.removeChild(warning);
            }
        }, 10000);
    }
    
    // ========== Р В¤Р ВР В§Р С’ 3: Р вЂ”Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„– ==========
    let bookmarks = JSON.parse(localStorage.getItem('flickers-bookmarks') || '[]');
    
    window.toggleBookmarks = () => {
        const panel = document.getElementById('bookmarks-panel');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
            renderBookmarks();
        }
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР ВµР Р…РЎР‹ РЎвЂЎР В°РЎвЂљР В°
        document.getElementById('chat-menu')?.classList.add('hidden');
    };
    
    window.addBookmark = (msgData) => {
        // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С, Р Р…Р Вµ Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С• Р В»Р С‘ РЎС“Р В¶Р Вµ
        if (bookmarks.find(b => b.msgId === msgData.msgId)) {
            showToast(currentLang === 'ru' ? 'Р Р€Р В¶Р Вµ Р Р† Р В·Р В°Р С”Р В»Р В°Р Т‘Р С”Р В°РЎвЂ¦' : 'Already bookmarked', 'СЂСџвЂњРЉ');
            return;
        }
        
        bookmarks.unshift({
            msgId: msgData.msgId,
            text: msgData.text,
            author: msgData.author,
            chatId: msgData.chatId,
            chatName: msgData.chatName,
            timestamp: Date.now()
        });
        
        localStorage.setItem('flickers-bookmarks', JSON.stringify(bookmarks));
        showToast(currentLang === 'ru' ? 'Р вЂќР С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С• Р Р† Р В·Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘' : 'Bookmarked', 'СЂСџвЂќвЂ“');
    };
    
    window.removeBookmark = (msgId, e) => {
        if (e) e.stopPropagation();
        bookmarks = bookmarks.filter(b => b.msgId !== msgId);
        localStorage.setItem('flickers-bookmarks', JSON.stringify(bookmarks));
        renderBookmarks();
        showToast(currentLang === 'ru' ? 'Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С• Р С‘Р В· Р В·Р В°Р С”Р В»Р В°Р Т‘Р С•Р С”' : 'Removed from bookmarks', 'СЂСџвЂ”вЂРїС‘РЏ');
    };
    
    function renderBookmarks() {
        const list = document.getElementById('bookmarks-list');
        
        if (bookmarks.length === 0) {
            list.innerHTML = `
                <div class="p-8 text-center opacity-50">
                    <i class="fas fa-bookmark text-4xl mb-3"></i>
                    <p class="text-sm">${currentLang === 'ru' ? 'Р СњР ВµРЎвЂљ Р В·Р В°Р С”Р В»Р В°Р Т‘Р С•Р С”' : 'No bookmarks'}</p>
                    <p class="text-xs mt-2">${currentLang === 'ru' ? 'Р СњР В°Р В¶Р СР С‘РЎвЂљР Вµ Р СџР С™Р Сљ Р Р…Р В° РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р С‘ РІвЂ вЂ™ Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р Р† Р В·Р В°Р С”Р В»Р В°Р Т‘Р С”Р С‘' : 'Right-click message РІвЂ вЂ™ Add to bookmarks'}</p>
                </div>
            `;
            return;
        }
        
        list.innerHTML = bookmarks.map(b => `
            <div class="bookmark-item" onclick="goToBookmark('${b.chatId}', '${b.msgId}')">
                <div class="bookmark-item-header">
                    <span class="bookmark-item-author">@${b.author}</span>
                    <div class="flex items-center gap-2">
                        <span class="bookmark-item-time">${formatBookmarkTime(b.timestamp)}</span>
                        <button onclick="removeBookmark('${b.msgId}', event)" class="bookmark-remove w-6 h-6 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 flex items-center justify-center text-red-500">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
                <div class="bookmark-item-text">${b.text || '[Р СљР ВµР Т‘Р С‘Р В°]'}</div>
                <div class="text-[10px] opacity-40 mt-1">${b.chatName}</div>
            </div>
        `).join('');
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Р вЂ';
        const k = 1024;
        const sizes = ['Р вЂ', 'Р С™Р вЂ', 'Р СљР вЂ', 'Р вЂњР вЂ'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    function formatBookmarkTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 86400000) { // Р СљР ВµР Р…РЎРЉРЎв‚¬Р Вµ РЎРѓРЎС“РЎвЂљР С•Р С”
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (diff < 604800000) { // Р СљР ВµР Р…РЎРЉРЎв‚¬Р Вµ Р Р…Р ВµР Т‘Р ВµР В»Р С‘
            return date.toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { weekday: 'short' });
        } else {
            return date.toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { day: 'numeric', month: 'short' });
        }
    }
    
    window.goToBookmark = async (chatId, msgId) => {
        // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С—Р В°Р Р…Р ВµР В»РЎРЉ Р В·Р В°Р С”Р В»Р В°Р Т‘Р С•Р С”
        document.getElementById('bookmarks-panel').classList.remove('active');
        
        // Р СџРЎР‚Р С•Р С”РЎР‚РЎС“РЎвЂЎР С‘Р Р†Р В°Р ВµР С Р С” РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘РЎР‹ Р ВµРЎРѓР В»Р С‘ РЎвЂЎР В°РЎвЂљ Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљ
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (msgEl) {
            msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            msgEl.classList.add('highlight-msg');
            setTimeout(() => msgEl.classList.remove('highlight-msg'), 2000);
        } else {
            showToast(currentLang === 'ru' ? 'Р С›РЎвЂљР С”РЎР‚Р С•Р в„–РЎвЂљР Вµ Р Р…РЎС“Р В¶Р Р…РЎвЂ№Р в„– РЎвЂЎР В°РЎвЂљ' : 'Open the chat first', 'СЂСџвЂ™В¬');
        }
    };
    
    // ========== Р вЂ”Р С’Р СљР вЂўР СћР С™Р В (Notes) ==========
    let notes = JSON.parse(localStorage.getItem('flickers-notes') || '[]');
    let currentNoteId = null;
    let currentNoteColor = '#f1f5f9';
    
    window.toggleNotes = () => {
        const panel = document.getElementById('notes-panel');
        const editorPanel = document.getElementById('note-editor-panel');
        editorPanel.classList.remove('active');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
            renderNotes();
        }
        document.getElementById('chat-menu')?.classList.add('hidden');
    };
    
    window.createNewNote = () => {
        currentNoteId = null;
        currentNoteColor = '#f1f5f9';
        document.getElementById('note-title-input').value = '';
        document.getElementById('note-content-input').value = '';
        document.querySelectorAll('.note-color').forEach(c => c.classList.remove('active'));
        document.querySelector('.note-color[data-color="#f1f5f9"]').classList.add('active');
        
        document.getElementById('notes-panel').classList.remove('active');
        document.getElementById('note-editor-panel').classList.add('active');
    };
    
    window.openNote = (noteId) => {
        const note = notes.find(n => n.id === noteId);
        if (!note) return;
        
        currentNoteId = noteId;
        currentNoteColor = note.color || '#f1f5f9';
        document.getElementById('note-title-input').value = note.title || '';
        document.getElementById('note-content-input').value = note.content || '';
        
        document.querySelectorAll('.note-color').forEach(c => {
            c.classList.toggle('active', c.dataset.color === currentNoteColor);
        });
        
        document.getElementById('notes-panel').classList.remove('active');
        document.getElementById('note-editor-panel').classList.add('active');
    };
    
    window.closeNoteEditor = () => {
        document.getElementById('note-editor-panel').classList.remove('active');
        document.getElementById('notes-panel').classList.add('active');
        renderNotes();
    };
    
    window.setNoteColor = (el) => {
        currentNoteColor = el.dataset.color;
        document.querySelectorAll('.note-color').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    };
    
    window.saveCurrentNote = () => {
        const title = document.getElementById('note-title-input').value.trim() || 'Р вЂР ВµР В· Р Р…Р В°Р В·Р Р†Р В°Р Р…Р С‘РЎРЏ';
        const content = document.getElementById('note-content-input').value.trim();
        
        if (!content && !title) {
            showToast('Р вЂ”Р В°Р СР ВµРЎвЂљР С”Р В° Р С—РЎС“РЎРѓРЎвЂљР В°', 'РІС™В РїС‘РЏ');
            return;
        }
        
        if (currentNoteId) {
            // Р В Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ
            const idx = notes.findIndex(n => n.id === currentNoteId);
            if (idx !== -1) {
                notes[idx] = { ...notes[idx], title, content, color: currentNoteColor, updatedAt: Date.now() };
            }
        } else {
            // Р СњР С•Р Р†Р В°РЎРЏ Р В·Р В°Р СР ВµРЎвЂљР С”Р В°
            notes.unshift({
                id: 'note_' + Date.now(),
                title,
                content,
                color: currentNoteColor,
                createdAt: Date.now(),
                updatedAt: Date.now()
            });
        }
        
        localStorage.setItem('flickers-notes', JSON.stringify(notes));
        showToast('Р вЂ”Р В°Р СР ВµРЎвЂљР С”Р В° РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р В°', 'РІСљвЂ¦');
        closeNoteEditor();
    };
    
    window.deleteCurrentNote = () => {
        if (!currentNoteId) {
            closeNoteEditor();
            return;
        }
        
        if (!confirm('Р Р€Р Т‘Р В°Р В»Р С‘РЎвЂљРЎРЉ Р В·Р В°Р СР ВµРЎвЂљР С”РЎС“?')) return;
        
        notes = notes.filter(n => n.id !== currentNoteId);
        localStorage.setItem('flickers-notes', JSON.stringify(notes));
        showToast('Р вЂ”Р В°Р СР ВµРЎвЂљР С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р В°', 'СЂСџвЂ”вЂРїС‘РЏ');
        closeNoteEditor();
    };
    
    function renderNotes() {
        const list = document.getElementById('notes-list');
        
        if (notes.length === 0) {
            list.innerHTML = `
                <div class="p-8 text-center opacity-50">
                    <i class="fas fa-sticky-note text-4xl mb-3"></i>
                    <p class="text-sm">Р СњР ВµРЎвЂљ Р В·Р В°Р СР ВµРЎвЂљР С•Р С”</p>
                    <p class="text-xs mt-2">Р СњР В°Р В¶Р СР С‘РЎвЂљР Вµ + РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ РЎРѓР С•Р В·Р Т‘Р В°РЎвЂљРЎРЉ</p>
                </div>
            `;
            return;
        }
        
        list.innerHTML = notes.map(n => `
            <div class="note-item" style="border-left: 4px solid ${n.color};" onclick="openNote('${n.id}')">
                <div class="note-item-header">
                    <span class="note-item-title">${n.title || 'Р вЂР ВµР В· Р Р…Р В°Р В·Р Р†Р В°Р Р…Р С‘РЎРЏ'}</span>
                    <span class="note-item-date">${formatBookmarkTime(n.updatedAt)}</span>
                </div>
                <div class="note-item-preview">${n.content || ''}</div>
            </div>
        `).join('');
    }
    
    // ========== Р СџР В Р С›Р В§Р ВР СћР С’Р СњР С› (Read receipts) ==========
    // Р С›РЎвЂљРЎРѓР В»Р ВµР В¶Р С‘Р Р†Р В°Р Р…Р С‘Р Вµ Р С—РЎР‚Р С•РЎвЂЎРЎвЂљР ВµР Р…Р С‘РЎРЏ РЎРѓР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р в„–
    async function markMessageAsRead(msgId, chatId) {
        if (!me || !chatId) return;
        
        try {
            const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
            await updateDoc(msgRef, {
                readAt: Date.now(),
                readBy: me.uid
            });
        } catch(e) {
            // Р ВР С–Р Р…Р С•РЎР‚Р С‘РЎР‚РЎС“Р ВµР С Р С•РЎв‚¬Р С‘Р В±Р С”Р С‘
        }
    }
    
    function getReadReceiptHtml(m, isMine) {
        if (!isMine) return '';
        
        if (m.readAt) {
            const readTime = new Date(m.readAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `<span class="read-receipt read" title="Р СџРЎР‚Р С•РЎвЂЎР С‘РЎвЂљР В°Р Р…Р С• Р Р† ${readTime}"><i class="fas fa-check-double"></i></span>`;
        } else {
            return `<span class="read-receipt" title="Р вЂќР С•РЎРѓРЎвЂљР В°Р Р†Р В»Р ВµР Р…Р С•"><i class="fas fa-check"></i></span>`;
        }
    }
    
    // ========== Р В Р С’Р РЋР РЃР ВР В Р вЂўР СњР СњР В«Р в„ў Р СџР С›Р ВР РЋР С™ ==========
    let searchFilter = 'all';
    let searchMessages = [];
    
    window.toggleSearchPanel = () => {
        const panel = document.getElementById('search-panel');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
            document.getElementById('advanced-search-input').focus();
            loadSearchMessages();
        }
        document.getElementById('chat-menu')?.classList.add('hidden');
    };
    
    window.setSearchFilter = (filter) => {
        searchFilter = filter;
        document.querySelectorAll('.search-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        performAdvancedSearch();
    };
    
    async function loadSearchMessages() {
        if (!activeChatPartner && !activeGroup) return;
        
        searchMessages = [];
        const container = document.getElementById('messages-container');
        const bubbles = container.querySelectorAll('.message-bubble');
        
        bubbles.forEach(bubble => {
            const msgId = bubble.dataset.msgId;
            const senderId = bubble.dataset.senderId;
            const text = bubble.querySelector('p')?.textContent || '';
            const hasImage = bubble.querySelector('img.chat-image');
            const hasFile = bubble.querySelector('a[download]');
            const hasLink = text.match(/https?:\/\/[^\s]+/);
            const timeEl = bubble.querySelector('.text-\\[9px\\]');
            const time = timeEl?.textContent || '';
            
            searchMessages.push({
                msgId,
                senderId,
                text,
                hasImage: !!hasImage,
                hasFile: !!hasFile,
                hasLink: !!hasLink,
                time,
                element: bubble
            });
        });
    }
    
    window.performAdvancedSearch = () => {
        const query = document.getElementById('advanced-search-input').value.toLowerCase().trim();
        const dateFrom = document.getElementById('search-date-from').value;
        const dateTo = document.getElementById('search-date-to').value;
        const resultsContainer = document.getElementById('search-results');
        
        if (!query && !dateFrom && !dateTo && searchFilter === 'all') {
            resultsContainer.innerHTML = `
                <div class="p-8 text-center opacity-50">
                    <i class="fas fa-search text-4xl mb-3"></i>
                    <p class="text-sm">Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р В·Р В°Р С—РЎР‚Р С•РЎРѓ Р Т‘Р В»РЎРЏ Р С—Р С•Р С‘РЎРѓР С”Р В°</p>
                </div>
            `;
            return;
        }
        
        let results = searchMessages.filter(m => {
            // Р В¤Р С‘Р В»РЎРЉРЎвЂљРЎР‚ Р С—Р С• РЎвЂљР С‘Р С—РЎС“
            if (searchFilter === 'text' && (m.hasImage || m.hasFile)) return false;
            if (searchFilter === 'images' && !m.hasImage) return false;
            if (searchFilter === 'files' && !m.hasFile) return false;
            if (searchFilter === 'links' && !m.hasLink) return false;
            
            // Р В¤Р С‘Р В»РЎРЉРЎвЂљРЎР‚ Р С—Р С• РЎвЂљР ВµР С”РЎРѓРЎвЂљРЎС“
            if (query && !m.text.toLowerCase().includes(query)) return false;
            
            return true;
        });
        
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="p-8 text-center opacity-50">
                    <i class="fas fa-search text-4xl mb-3"></i>
                    <p class="text-sm">Р СњР С‘РЎвЂЎР ВµР С–Р С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•</p>
                </div>
            `;
            return;
        }
        
        resultsContainer.innerHTML = results.map(r => {
            let typeIcon = '<i class="fas fa-comment"></i> Р РЋР С•Р С•Р В±РЎвЂ°Р ВµР Р…Р С‘Р Вµ';
            if (r.hasImage) typeIcon = '<i class="fas fa-image"></i> Р В¤Р С•РЎвЂљР С•';
            if (r.hasFile) typeIcon = '<i class="fas fa-file"></i> Р В¤Р В°Р в„–Р В»';
            if (r.hasLink) typeIcon = '<i class="fas fa-link"></i> Р РЋРЎРѓРЎвЂ№Р В»Р С”Р В°';
            
            let highlightedText = r.text;
            if (query) {
                const regex = new RegExp(`(${query})`, 'gi');
                highlightedText = r.text.replace(regex, '<mark>$1</mark>');
            }
            
            return `
                <div class="search-result-item" onclick="goToSearchResult('${r.msgId}')">
                    <div class="search-result-type">${typeIcon}</div>
                    <div class="search-result-text">${highlightedText || '[Р СљР ВµР Т‘Р С‘Р В°]'}</div>
                    <div class="search-result-meta">${r.time}</div>
                </div>
            `;
        }).join('');
    };
    
    window.goToSearchResult = (msgId) => {
        document.getElementById('search-panel').classList.remove('active');
        
        const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
        if (msgEl) {
            msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            msgEl.classList.add('highlight-msg');
            setTimeout(() => msgEl.classList.remove('highlight-msg'), 2000);
        }
    };

    // ========== Р С™Р С’Р СњР С’Р вЂєР В« (Telegram-style) ==========
    let activeChannel = null;
    let channelType = 'public';
    let channelsUnsub = null;
    let channelMsgUnsub = null;

    window.openCreateChannel = () => {
        channelType = 'public';
        document.getElementById('create-channel-modal').classList.remove('hidden');
        document.getElementById('channel-name-input').value = '';
        document.getElementById('channel-description-input').value = '';
        setChannelType('public');
        updateCreateChannelBtn();
    };

    window.closeCreateChannel = (event) => {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('create-channel-modal').classList.add('hidden');
    };

    window.setChannelType = (type) => {
        channelType = type;
        const publicBtn = document.getElementById('channel-type-public');
        const privateBtn = document.getElementById('channel-type-private');
        const hint = document.getElementById('channel-type-hint');
        
        if (type === 'public') {
            publicBtn.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/30');
            publicBtn.classList.remove('border-[var(--border)]');
            privateBtn.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/30');
            privateBtn.classList.add('border-[var(--border)]');
            hint.textContent = 'Р СџРЎС“Р В±Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р в„– Р С”Р В°Р Р…Р В°Р В» Р Р†Р С‘Р Т‘Р ВµР Р… Р Р†РЎРѓР ВµР С Р Р† Р С—Р С•Р С‘РЎРѓР С”Р Вµ';
        } else {
            privateBtn.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/30');
            privateBtn.classList.remove('border-[var(--border)]');
            publicBtn.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/30');
            publicBtn.classList.add('border-[var(--border)]');
            hint.textContent = 'Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…РЎвЂ№Р в„– Р С”Р В°Р Р…Р В°Р В» Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р ВµР Р… РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С—Р С• Р С—РЎР‚Р С‘Р С–Р В»Р В°РЎв‚¬Р ВµР Р…Р С‘РЎР‹';
        }
    };

    function updateCreateChannelBtn() {
        const name = document.getElementById('channel-name-input').value.trim();
        document.getElementById('create-channel-btn').disabled = !name;
    }

    document.getElementById('channel-name-input')?.addEventListener('input', updateCreateChannelBtn);

    window.createChannel = async () => {
        const name = document.getElementById('channel-name-input').value.trim();
        const description = document.getElementById('channel-description-input').value.trim();
        
        if (!name) return;
        
        try {
            const channelRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'channels'), {
                name: name,
                description: description,
                type: channelType,
                ownerId: me.uid,
                ownerName: me.username,
                subscribers: [me.uid],
                subscriberCount: 1,
                createdAt: serverTimestamp(),
                lastPostTime: serverTimestamp(),
                lastPost: null
            });
            
            closeCreateChannel();
            showToast(currentLang === 'ru' ? 'Р С™Р В°Р Р…Р В°Р В» РЎРѓР С•Р В·Р Т‘Р В°Р Р…!' : 'Channel created!', 'СЂСџвЂњСћ');
            
            // Р С›РЎвЂљР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р в„– Р С”Р В°Р Р…Р В°Р В»
            selectChannel({ 
                id: channelRef.id, 
                name, 
                description, 
                type: channelType, 
                ownerId: me.uid,
                ownerName: me.username,
                subscribers: [me.uid],
                subscriberCount: 1
            });
        } catch (err) {
            console.error('Error creating channel:', err);
            showToast(currentLang === 'ru' ? 'Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘РЎРЏ Р С”Р В°Р Р…Р В°Р В»Р В°' : 'Error creating channel', 'РІСњРЉ');
        }
    };

    window.selectChannel = async (channel) => {
        activeChannel = channel;
        activeGroup = null;
        activeChatPartner = null;
        
        document.getElementById('chat-placeholder').classList.add('hidden');
        document.getElementById('active-chat').classList.remove('hidden');
        
        // Р С’Р Р†Р В°РЎвЂљР В°РЎР‚ Р С”Р В°Р Р…Р В°Р В»Р В°
        const avatarHtml = channel.avatar 
            ? `<img src="${channel.avatar}" class="w-full h-full object-cover rounded-xl">`
            : `<i class="fas fa-bullhorn text-purple-500"></i>`;
        document.getElementById('target-avatar').innerHTML = avatarHtml;
        document.getElementById('target-name').innerHTML = `${channel.name} <span class="text-xs text-purple-500 ml-1"><i class="fas fa-bullhorn"></i></span>`;
        
        // Р СљР С•Р В±Р С‘Р В»РЎРЉР Р…Р В°РЎРЏ Р Р…Р В°Р Р†Р С‘Р С–Р В°РЎвЂ Р С‘РЎРЏ
        mobileShowChat();
        if (isMobileView) history.pushState({ chat: true }, '');
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С•Р Р…Р В»Р В°Р в„–Р Р…-РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ
        document.getElementById('online-status').style.display = 'none';
        document.getElementById('online-indicator').classList.add('hidden');
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р Р…Р С•Р С—Р С”Р С‘ Р В·Р Р†Р С•Р Р…Р С”Р С•Р Р† Р Т‘Р В»РЎРЏ Р С”Р В°Р Р…Р В°Р В»Р С•Р Р†
        const callBtns = document.querySelectorAll('[onclick^="startCall"]');
        callBtns.forEach(btn => btn.style.display = 'none');
        
        // Р РЋР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚РЎвЂ№ Р В·Р В°Р С—РЎР‚Р С•РЎРѓР С•Р Р†
        document.getElementById('chat-request-banner')?.classList.add('hidden');
        document.getElementById('chat-pending-banner')?.classList.add('hidden');
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С/РЎРѓР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С footer Р Р† Р В·Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘ Р С•РЎвЂљ РЎвЂљР С•Р С–Р С•, Р Р†Р В»Р В°Р Т‘Р ВµР В»Р ВµРЎвЂ  Р С‘Р В»Р С‘ Р В°Р Т‘Р СР С‘Р Р… Р В»Р С‘ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ
        const footer = document.querySelector('#active-chat footer');
        const isOwner = channel.ownerId === me.uid;
        const isAdmin = channel.admins?.includes(me.uid);
        const canPost = isOwner || isAdmin;
        
        if (canPost) {
            footer?.classList.remove('hidden');
            // Р СљР ВµР Р…РЎРЏР ВµР С placeholder
            const input = document.getElementById('msg-input');
            if (input) input.placeholder = currentLang === 'ru' ? 'Р СњР В°Р С—Р С‘РЎРѓР В°РЎвЂљРЎРЉ Р Р† Р С”Р В°Р Р…Р В°Р В»...' : 'Post to channel...';
        } else {
            footer?.classList.add('hidden');
        }
        
        // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С‘Р Р…РЎвЂћР С•РЎР‚Р СР В°РЎвЂ Р С‘РЎР‹ Р С• Р С”Р В°Р Р…Р В°Р В»Р Вµ
        showChannelInfo(channel, isOwner);
        
        if (channelMsgUnsub) channelMsgUnsub();
        
        const q = query(
            collection(db, 'artifacts', appId, 'public', 'data', 'channels', channel.id, 'posts'), 
            orderBy('timestamp', 'asc')
        );
        
        channelMsgUnsub = onSnapshot(q, (snap) => {
            const cont = document.getElementById('messages-container');
            const shouldScroll = cont.scrollTop + cont.offsetHeight >= cont.scrollHeight - 100;
            cont.innerHTML = '';
            
            snap.forEach(d => {
                const post = d.data();
                const postId = d.id;
                if (post.deleted) return;
                
                const div = document.createElement('div');
                div.className = 'channel-post p-4 mb-3 bg-[var(--bg-secondary)] rounded-2xl shadow-sm';
                div.dataset.postId = postId;
                
                let displayText = post.text || '';
                if (post.encrypted && displayText) displayText = decrypt(displayText);
                
                // Р СџРЎР‚Р С‘Р СР ВµР Р…РЎРЏР ВµР С linkify
                const linkedText = linkifyText(displayText);
                
                // Р В Р ВµР В°Р С”РЎвЂ Р С‘Р С‘
                const reactionsHtml = renderChannelReactions(post.reactions, postId);
                
                // Р СљР ВµР Т‘Р С‘Р В°-Р С”Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљ (Р С‘Р В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘РЎРЏ, РЎвЂћР В°Р в„–Р В»РЎвЂ№)
                let mediaHtml = '';
                if (post.type === 'file' && post.fileData) {
                    if (post.fileType?.startsWith('image/')) {
                        // Р ВР В·Р С•Р В±РЎР‚Р В°Р В¶Р ВµР Р…Р С‘Р Вµ
                        mediaHtml = `
                            <div class="mb-3">
                                <img src="${post.fileData}" class="max-w-full rounded-xl cursor-pointer hover:opacity-90 transition-opacity" 
                                     onclick="openImageViewer('${post.fileData}')" 
                                     style="max-height: 400px; object-fit: contain;">
                            </div>
                        `;
                    } else if (post.fileType?.startsWith('video/')) {
                        // Р вЂ™Р С‘Р Т‘Р ВµР С•
                        mediaHtml = `
                            <div class="mb-3">
                                <video src="${post.fileData}" controls class="max-w-full rounded-xl" style="max-height: 400px;"></video>
                            </div>
                        `;
                    } else if (post.fileType?.startsWith('audio/')) {
                        // Р С’РЎС“Р Т‘Р С‘Р С•
                        mediaHtml = `
                            <div class="mb-3">
                                <audio src="${post.fileData}" controls class="w-full"></audio>
                                <p class="text-xs text-slate-400 mt-1"><i class="fas fa-music mr-1"></i>${post.fileName || 'Р С’РЎС“Р Т‘Р С‘Р С•'}</p>
                            </div>
                        `;
                    } else {
                        // Р вЂќРЎР‚РЎС“Р С–Р С•Р в„– РЎвЂћР В°Р в„–Р В»
                        const fileSize = post.fileSize ? formatFileSize(post.fileSize) : '';
                        mediaHtml = `
                            <div class="mb-3 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl">
                                <a href="${post.fileData}" download="${post.fileName || 'file'}" 
                                   class="flex items-center gap-3 text-indigo-500 hover:text-indigo-600 transition-colors">
                                    <div class="w-10 h-10 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                                        <i class="fas fa-file-download text-lg"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium truncate">${post.fileName || 'Р В¤Р В°Р в„–Р В»'}</p>
                                        ${fileSize ? `<p class="text-xs text-slate-400">${fileSize}</p>` : ''}
                                    </div>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        `;
                    }
                }
                
                // Р С’Р Р†Р В°РЎвЂљР В°РЎР‚ Р С”Р В°Р Р…Р В°Р В»Р В°
                const channelAvatarHtml = channel.avatar 
                    ? `<img src="${channel.avatar}" class="w-full h-full object-cover rounded-full">`
                    : `<i class="fas fa-bullhorn text-white text-xs"></i>`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden">
                            ${channelAvatarHtml}
                        </div>
                        <span class="font-bold text-sm">${channel.name}</span>
                        <span class="text-[10px] text-slate-400">${post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString([], {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'}) : '...'}</span>
                    </div>
                    ${mediaHtml}
                    ${linkedText ? `<p class="text-sm leading-relaxed mb-2">${linkedText}</p>` : ''}
                    ${reactionsHtml}
                    <div class="flex items-center gap-4 mt-3 pt-3 border-t border-[var(--border)]">
                        <button onclick="reactToPost('${postId}', 'СЂСџвЂРЊ')" class="text-xs text-slate-400 hover:text-indigo-500 transition-colors">
                            <i class="far fa-thumbs-up mr-1"></i>${post.reactions?.['СЂСџвЂРЊ']?.length || 0}
                        </button>
                        <button onclick="reactToPost('${postId}', 'РІСњВ¤РїС‘РЏ')" class="text-xs text-slate-400 hover:text-red-500 transition-colors">
                            <i class="far fa-heart mr-1"></i>${post.reactions?.['РІСњВ¤РїС‘РЏ']?.length || 0}
                        </button>
                        <span class="text-xs text-slate-400 ml-auto">
                            <i class="far fa-eye mr-1"></i>${post.views || 0}
                        </span>
                    </div>
                `;
                
                cont.appendChild(div);
                
                // Р Р€Р Р†Р ВµР В»Р С‘РЎвЂЎР С‘Р Р†Р В°Р ВµР С Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚РЎвЂ№
                incrementPostViews(channel.id, postId);
            });
            
            if (shouldScroll) cont.scrollTop = cont.scrollHeight;
        });
    };

    function showChannelInfo(channel, isOwner) {
        // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С РЎРѓРЎвЂљР В°РЎР‚РЎвЂ№Р в„– Р В±Р В°Р Р…Р Р…Р ВµРЎР‚ Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
        const oldBanner = document.getElementById('channel-info-banner');
        if (oldBanner) oldBanner.remove();
        
        const isSubscribed = channel.subscribers?.includes(me.uid);
        const isAdmin = channel.admins?.includes(me.uid);
        const canManage = isOwner || isAdmin;
        
        // Р С’Р Р†Р В°РЎвЂљР В°РЎР‚ Р С”Р В°Р Р…Р В°Р В»Р В°
        const avatarHtml = channel.avatar 
            ? `<img src="${channel.avatar}" class="w-full h-full object-cover rounded-full">`
            : `<i class="fas fa-bullhorn text-white"></i>`;
        
        const banner = document.createElement('div');
        banner.id = 'channel-info-banner';
        banner.className = 'p-3 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border-b border-purple-500/20';
        banner.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden">
                        ${avatarHtml}
                    </div>
                    <div>
                        <p class="font-bold">${channel.name}</p>
                        <p class="text-xs text-slate-400">${channel.subscriberCount || 1} ${currentLang === 'ru' ? 'Р С—Р С•Р Т‘Р С—Р С‘РЎРѓРЎвЂЎР С‘Р С”(Р С•Р Р†)' : 'subscriber(s)'} РІР‚Сћ ${channel.type === 'public' ? (currentLang === 'ru' ? 'Р СџРЎС“Р В±Р В»Р С‘РЎвЂЎР Р…РЎвЂ№Р в„–' : 'Public') : (currentLang === 'ru' ? 'Р СџРЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…РЎвЂ№Р в„–' : 'Private')}</p>
                        ${channel.description ? `<p class="text-xs text-slate-500 mt-1">${channel.description}</p>` : ''}
                    </div>
                </div>
                <div class="flex gap-2">
                    ${canManage ? `
                        <button onclick="openChannelSettings('${channel.id}')" class="px-3 py-2 bg-slate-200 dark:bg-slate-700 rounded-xl text-xs font-medium hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                            <i class="fas fa-cog mr-1"></i>${currentLang === 'ru' ? 'Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘' : 'Settings'}
                        </button>
                    ` : (isSubscribed ? `
                        <button onclick="unsubscribeFromChannel('${channel.id}')" class="px-3 py-2 bg-slate-200 dark:bg-slate-700 rounded-xl text-xs font-medium hover:bg-red-500 hover:text-white transition-colors">
                            <i class="fas fa-bell-slash mr-1"></i>${currentLang === 'ru' ? 'Р С›РЎвЂљР С—Р С‘РЎРѓР В°РЎвЂљРЎРЉРЎРѓРЎРЏ' : 'Unsubscribe'}
                        </button>
                    ` : `
                        <button onclick="subscribeToChannel('${channel.id}')" class="px-3 py-2 bg-purple-500 text-white rounded-xl text-xs font-medium hover:bg-purple-600 transition-colors">
                            <i class="fas fa-bell mr-1"></i>${currentLang === 'ru' ? 'Р СџР С•Р Т‘Р С—Р С‘РЎРѓР В°РЎвЂљРЎРЉРЎРѓРЎРЏ' : 'Subscribe'}
                        </button>
                    `)}
                </div>
            </div>
        `;
        
        const header = document.querySelector('#active-chat header');
        if (header) header.after(banner);
    }

    function renderChannelReactions(reactions, postId) {
        if (!reactions) return '';
        
        const reactionEmojis = Object.keys(reactions);
        if (reactionEmojis.length === 0) return '';
        
        return `<div class="flex flex-wrap gap-1 mt-2">
            ${reactionEmojis.map(emoji => {
                const users = reactions[emoji] || [];
                const hasReacted = users.includes(me.uid);
                return `<span class="reaction-badge ${hasReacted ? 'reacted' : ''}" onclick="reactToPost('${postId}', '${emoji}')">${emoji} ${users.length}</span>`;
            }).join('')}
        </div>`;
    }

    window.reactToPost = async (postId, emoji) => {
        if (!activeChannel) return;
        
        try {
            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', activeChannel.id, 'posts', postId);
            const postDoc = await getDoc(postRef);
            
            if (!postDoc.exists()) return;
            
            const reactions = postDoc.data().reactions || {};
            const users = reactions[emoji] || [];
            
            if (users.includes(me.uid)) {
                // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘РЎР‹
                reactions[emoji] = users.filter(u => u !== me.uid);
                if (reactions[emoji].length === 0) delete reactions[emoji];
            } else {
                // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С РЎР‚Р ВµР В°Р С”РЎвЂ Р С‘РЎР‹
                reactions[emoji] = [...users, me.uid];
            }
            
            await updateDoc(postRef, { reactions });
        } catch (err) {
            console.error('Error reacting to post:', err);
        }
    };

    async function incrementPostViews(channelId, postId) {
        try {
            const viewKey = `channel_view_${channelId}_${postId}`;
            if (sessionStorage.getItem(viewKey)) return;
            
            sessionStorage.setItem(viewKey, '1');
            
            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', channelId, 'posts', postId);
            await updateDoc(postRef, {
                views: increment(1)
            });
        } catch (err) {
            // Р ВР С–Р Р…Р С•РЎР‚Р С‘РЎР‚РЎС“Р ВµР С Р С•РЎв‚¬Р С‘Р В±Р С”Р С‘ Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р С•Р Р†
        }
    }

    window.subscribeToChannel = async (channelId) => {
        try {
            const channelRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', channelId);
            await updateDoc(channelRef, {
                subscribers: arrayUnion(me.uid),
                subscriberCount: increment(1)
            });
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•
            if (activeChannel && activeChannel.id === channelId) {
                activeChannel.subscribers = [...(activeChannel.subscribers || []), me.uid];
                activeChannel.subscriberCount = (activeChannel.subscriberCount || 0) + 1;
                showChannelInfo(activeChannel, false);
            }
            
            showToast(currentLang === 'ru' ? 'Р вЂ™РЎвЂ№ Р С—Р С•Р Т‘Р С—Р С‘РЎРѓР В°Р В»Р С‘РЎРѓРЎРЉ Р Р…Р В° Р С”Р В°Р Р…Р В°Р В»!' : 'Subscribed!', 'СЂСџвЂќвЂќ');
        } catch (err) {
            console.error('Error subscribing:', err);
        }
    };

    window.unsubscribeFromChannel = async (channelId) => {
        try {
            const channelRef = doc(db, 'artifacts', appId, 'public', 'data', 'channels', channelId);
            await updateDoc(channelRef, {
                subscribers: arrayRemove(me.uid),
                subscriberCount: increment(-1)
            });
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С•
            if (activeChannel && activeChannel.id === channelId) {
                activeChannel.subscribers = (activeChannel.subscribers || []).filter(u => u !== me.uid);
                activeChannel.subscriberCount = Math.max(0, (activeChannel.subscriberCount || 1) - 1);
                showChannelInfo(activeChannel, false);
            }
            
            showToast(currentLang === 'ru' ? 'Р вЂ™РЎвЂ№ Р С•РЎвЂљР С—Р С‘РЎРѓР В°Р В»Р С‘РЎРѓРЎРЉ Р С•РЎвЂљ Р С”Р В°Р Р…Р В°Р В»Р В°' : 'Unsubscribed', 'СЂСџвЂќвЂў');
        } catch (err) {
            console.error('Error unsubscribing:', err);
        }
    };

    // Р СџР ВµРЎР‚Р ВµР С•Р С—РЎР‚Р ВµР Т‘Р ВµР В»РЎРЏР ВµР С sendMsg Р Т‘Р В»РЎРЏ Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С”Р С‘ Р С”Р В°Р Р…Р В°Р В»Р С•Р Р†
    const originalSendMsgWithGroups = window.sendMsg;
    window.sendMsg = async (fileData) => {
        if (activeChannel) {
            // Р СћР С•Р В»РЎРЉР С”Р С• Р Р†Р В»Р В°Р Т‘Р ВµР В»Р ВµРЎвЂ  Р С‘Р В»Р С‘ Р В°Р Т‘Р СР С‘Р Р… Р СР С•Р В¶Р ВµРЎвЂљ Р С—Р С•РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ
            const canPost = activeChannel.ownerId === me.uid || activeChannel.admins?.includes(me.uid);
            if (!canPost) {
                showToast(currentLang === 'ru' ? 'Р СћР С•Р В»РЎРЉР С”Р С• Р Р†Р В»Р В°Р Т‘Р ВµР В»Р ВµРЎвЂ  Р С‘Р В»Р С‘ Р В°Р Т‘Р СР С‘Р Р… Р СР С•Р В¶Р ВµРЎвЂљ Р С—РЎС“Р В±Р В»Р С‘Р С”Р С•Р Р†Р В°РЎвЂљРЎРЉ' : 'Only owner or admin can post', 'РІС™В РїС‘РЏ');
                return;
            }
            
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text && !fileData) return;
            
            resetTextarea(input);
            handleInputChange();
            const encryptedText = text ? encrypt(text) : '';
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'channels', activeChannel.id, 'posts'), {
                    text: encryptedText,
                    encrypted: true,
                    timestamp: serverTimestamp(),
                    views: 0,
                    reactions: {},
                    ...fileData
                });
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С lastPost РЎРѓ РЎС“РЎвЂЎРЎвЂРЎвЂљР С•Р С РЎвЂљР С‘Р С—Р В° Р С”Р С•Р Р…РЎвЂљР ВµР Р…РЎвЂљР В°
                let lastPostText = text.substring(0, 50);
                if (!lastPostText && fileData) {
                    if (fileData.fileType?.startsWith('image/')) {
                        lastPostText = 'СЂСџвЂњВ· Р В¤Р С•РЎвЂљР С•';
                    } else if (fileData.fileType?.startsWith('video/')) {
                        lastPostText = 'СЂСџР‹В¬ Р вЂ™Р С‘Р Т‘Р ВµР С•';
                    } else if (fileData.fileType?.startsWith('audio/')) {
                        lastPostText = 'СЂСџР‹Вµ Р С’РЎС“Р Т‘Р С‘Р С•';
                    } else {
                        lastPostText = 'СЂСџвЂњР‹ Р В¤Р В°Р в„–Р В»';
                    }
                }
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', activeChannel.id), {
                    lastPost: lastPostText,
                    lastPostTime: serverTimestamp()
                });
                
                earnRubies(RUBY_PER_MESSAGE);
            } catch (err) {
                console.error('Error posting to channel:', err);
            }
        } else if (originalSendMsgWithGroups) {
            originalSendMsgWithGroups(fileData);
        }
    };

    function listenToChannels() {
        if (channelsUnsub) channelsUnsub();
        
        const channelsRef = collection(db, 'artifacts', appId, 'public', 'data', 'channels');
        
        channelsUnsub = onSnapshot(channelsRef, (snap) => {
            // Р С›Р В±РЎР‚Р В°Р В±Р В°РЎвЂљРЎвЂ№Р Р†Р В°Р ВµР С Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘РЎРЏ
            snap.docChanges().forEach(change => {
                const d = change.doc;
                const channel = d.data();
                
                // Р вЂўРЎРѓР В»Р С‘ Р С”Р В°Р Р…Р В°Р В» РЎС“Р Т‘Р В°Р В»РЎвЂР Р… - РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С Р С‘Р В· РЎРѓР С—Р С‘РЎРѓР С”Р В°
                if (change.type === 'removed') {
                    const existingEl = document.querySelector(`[data-channel-id="${d.id}"]`);
                    if (existingEl) existingEl.remove();
                    return;
                }
                
                // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С”Р В°Р Р…Р В°Р В»РЎвЂ№ Р С–Р Т‘Р Вµ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЉ Р С—Р С•Р Т‘Р С—Р С‘РЎРѓР В°Р Р…, Р Р†Р В»Р В°Р Т‘Р ВµР В»Р ВµРЎвЂ  Р С‘Р В»Р С‘ Р В°Р Т‘Р СР С‘Р Р…
                const isAdmin = channel.admins?.includes(me.uid);
                const shouldShow = channel.subscribers?.includes(me.uid) || channel.ownerId === me.uid || isAdmin;
                
                const chatsList = document.getElementById('chats-list');
                let existingEl = document.querySelector(`[data-channel-id="${d.id}"]`);
                
                // Р вЂўРЎРѓР В»Р С‘ Р Р…Р Вµ Р Т‘Р С•Р В»Р В¶Р Р…РЎвЂ№ Р С—Р С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°РЎвЂљРЎРЉ - РЎС“Р Т‘Р В°Р В»РЎРЏР ВµР С Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ
                if (!shouldShow) {
                    if (existingEl) existingEl.remove();
                    return;
                }
                
                if (!existingEl) {
                    existingEl = document.createElement('div');
                    existingEl.dataset.channelId = d.id;
                    existingEl.className = 'flex items-center space-x-3 p-3 rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-all';
                    chatsList.insertBefore(existingEl, chatsList.firstChild);
                }
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С onclick РЎРѓ Р В°Р С”РЎвЂљРЎС“Р В°Р В»РЎРЉР Р…РЎвЂ№Р СР С‘ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р СР С‘
                existingEl.onclick = () => selectChannel({ id: d.id, ...channel });
                
                const isOwner = channel.ownerId === me.uid;
                
                // Р С’Р Р†Р В°РЎвЂљР В°РЎР‚ Р С”Р В°Р Р…Р В°Р В»Р В°
                const avatarHtml = channel.avatar 
                    ? `<img src="${channel.avatar}" class="w-full h-full object-cover rounded-xl">`
                    : `<i class="fas fa-bullhorn"></i>`;
                
                existingEl.innerHTML = `
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 text-white flex items-center justify-center font-bold shadow-lg relative overflow-hidden">
                        ${avatarHtml}
                        ${isOwner ? '<div class="absolute -top-1 -right-1 w-4 h-4 bg-yellow-400 rounded-full flex items-center justify-center"><i class="fas fa-crown text-[8px] text-yellow-800"></i></div>' : ''}
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <p class="font-bold truncate">${channel.name}</p>
                            <span class="text-[10px] text-slate-400">${channel.subscriberCount || 1} СЂСџвЂТђ</span>
                        </div>
                        <p class="text-xs text-slate-400 truncate">${channel.lastPost || (currentLang === 'ru' ? 'Р СњР ВµРЎвЂљ Р С—РЎС“Р В±Р В»Р С‘Р С”Р В°РЎвЂ Р С‘Р в„–' : 'No posts')}</p>
                    </div>
                `;
            });
        });
    }

    // Р СџР С•Р С‘РЎРѓР С” Р С—РЎС“Р В±Р В»Р С‘РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ Р С”Р В°Р Р…Р В°Р В»Р С•Р Р†
    window.searchPublicChannels = async (query) => {
        if (!query || query.length < 2) return [];
        
        try {
            const channelsRef = collection(db, 'artifacts', appId, 'public', 'data', 'channels');
            const snap = await getDocs(channelsRef);
            
            const results = [];
            snap.forEach(d => {
                const channel = d.data();
                if (channel.type !== 'public') return;
                if (!channel.name.toLowerCase().includes(query.toLowerCase())) return;
                results.push({ id: d.id, ...channel });
            });
            
            return results;
        } catch (err) {
            console.error('Error searching channels:', err);
            return [];
        }
    };

    // ========== Р СњР С’Р РЋР СћР В Р С›Р в„ўР С™Р В Р С™Р С’Р СњР С’Р вЂєР С’ ==========
    let editingChannelId = null;
    let editingChannelType = 'public';
    let channelAdmins = [];

    window.openChannelSettings = async (channelId) => {
        editingChannelId = channelId;
        
        try {
            // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С”Р В°Р Р…Р В°Р В»Р В°
            const channelDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', channelId));
            if (!channelDoc.exists()) {
                showToast('Р С™Р В°Р Р…Р В°Р В» Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…', 'РІСњРЉ');
                return;
            }
            
            const channel = channelDoc.data();
            
            // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Р С—РЎР‚Р В°Р Р†Р В°
            if (channel.ownerId !== me.uid && !channel.admins?.includes(me.uid)) {
                showToast('Р СњР ВµРЎвЂљ Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—Р В° Р С” Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В°Р С', 'РІС™В РїС‘РЏ');
                return;
            }
            
            // Р вЂ”Р В°Р С—Р С•Р В»Р Р…РЎРЏР ВµР С РЎвЂћР С•РЎР‚Р СРЎС“
            document.getElementById('channel-settings-name').value = channel.name || '';
            document.getElementById('channel-settings-description').value = channel.description || '';
            
            // Р СћР С‘Р С— Р С”Р В°Р Р…Р В°Р В»Р В°
            editingChannelType = channel.type || 'public';
            setChannelSettingsType(editingChannelType);
            
            // Р С’Р Р†Р В°РЎвЂљР В°РЎР‚
            const avatarEl = document.getElementById('channel-settings-avatar');
            if (channel.avatar) {
                avatarEl.innerHTML = `<img src="${channel.avatar}" class="w-full h-full object-cover rounded-2xl">`;
            } else {
                avatarEl.innerHTML = `<i class="fas fa-bullhorn text-white text-2xl"></i>`;
            }
            
            // Р РЋРЎвЂљР В°РЎвЂљР С‘РЎРѓРЎвЂљР С‘Р С”Р В°
            document.getElementById('channel-stats-subscribers').textContent = channel.subscriberCount || 0;
            
            // Р РЋРЎвЂЎР С‘РЎвЂљР В°Р ВµР С Р С—Р С•РЎРѓРЎвЂљРЎвЂ№
            const postsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'channels', channelId, 'posts'));
            document.getElementById('channel-stats-posts').textContent = postsSnap.size;
            
            // Р РЋРЎРѓРЎвЂ№Р В»Р С”Р В°-Р С—РЎР‚Р С‘Р С–Р В»Р В°РЎв‚¬Р ВµР Р…Р С‘Р Вµ
            const inviteLink = `${window.location.origin}${window.location.pathname}?channel=${channelId}`;
            document.getElementById('channel-invite-link').value = inviteLink;
            
            // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В¶Р В°Р ВµР С Р В°Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚Р С•Р Р†
            channelAdmins = channel.admins || [];
            renderChannelAdmins(channel.ownerId);
            
            // Р СџР С•Р С”Р В°Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р СР С•Р Т‘Р В°Р В»
            document.getElementById('channel-settings-modal').classList.remove('hidden');
        } catch (err) {
            console.error('Error loading channel settings:', err);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С”', 'РІСњРЉ');
        }
    };

    window.closeChannelSettings = (event) => {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('channel-settings-modal').classList.add('hidden');
        editingChannelId = null;
    };

    window.setChannelSettingsType = (type) => {
        editingChannelType = type;
        const publicBtn = document.getElementById('channel-settings-type-public');
        const privateBtn = document.getElementById('channel-settings-type-private');
        
        if (type === 'public') {
            publicBtn.classList.add('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900/30');
            publicBtn.classList.remove('border-[var(--border)]');
            privateBtn.classList.remove('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900/30');
            privateBtn.classList.add('border-[var(--border)]');
        } else {
            privateBtn.classList.add('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900/30');
            privateBtn.classList.remove('border-[var(--border)]');
            publicBtn.classList.remove('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900/30');
            publicBtn.classList.add('border-[var(--border)]');
        }
    };

    window.uploadChannelAvatar = () => {
        document.getElementById('channel-avatar-input').click();
    };

    window.handleChannelAvatarUpload = async (event) => {
        const file = event.target.files[0];
        if (!file || !editingChannelId) return;
        
        if (file.size > 500 * 1024) {
            showToast('Р СљР В°Р С”РЎРѓР С‘Р СРЎС“Р С 500 Р С™Р вЂ', 'РІС™В РїС‘РЏ');
            return;
        }
        
        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р С—РЎР‚Р ВµР Р†РЎРЉРЎР‹
                document.getElementById('channel-settings-avatar').innerHTML = 
                    `<img src="${base64}" class="w-full h-full object-cover rounded-2xl">`;
                
                // Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…РЎРЏР ВµР С Р Р† Firebase
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', editingChannelId), {
                    avatar: base64
                });
                
                showToast('Р С’Р Р†Р В°РЎвЂљР В°РЎР‚ Р С•Р В±Р Р…Р С•Р Р†Р В»РЎвЂР Р…', 'РІСљвЂ¦');
            };
            reader.readAsDataURL(file);
        } catch (err) {
            console.error('Error uploading avatar:', err);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘', 'РІСњРЉ');
        }
    };

    window.saveChannelSettings = async () => {
        if (!editingChannelId) return;
        
        const name = document.getElementById('channel-settings-name').value.trim();
        const description = document.getElementById('channel-settings-description').value.trim();
        
        if (!name) {
            showToast('Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р Р…Р В°Р В·Р Р†Р В°Р Р…Р С‘Р Вµ Р С”Р В°Р Р…Р В°Р В»Р В°', 'РІС™В РїС‘РЏ');
            return;
        }
        
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', editingChannelId), {
                name: name,
                description: description,
                type: editingChannelType,
                admins: channelAdmins
            });
            
            // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С• Р ВµРЎРѓР В»Р С‘ Р С”Р В°Р Р…Р В°Р В» Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљ
            if (activeChannel && activeChannel.id === editingChannelId) {
                activeChannel.name = name;
                activeChannel.description = description;
                activeChannel.type = editingChannelType;
                activeChannel.admins = channelAdmins;
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В·Р В°Р С–Р С•Р В»Р С•Р Р†Р С•Р С”
                document.getElementById('target-name').innerHTML = `${name} <span class="text-xs text-purple-500 ml-1"><i class="fas fa-bullhorn"></i></span>`;
                
                // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С Р В±Р В°Р Р…Р Р…Р ВµРЎР‚
                showChannelInfo(activeChannel, true);
            }
            
            showToast('Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…РЎвЂ№', 'РІСљвЂ¦');
            closeChannelSettings();
        } catch (err) {
            console.error('Error saving channel settings:', err);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎРѓР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С‘РЎРЏ', 'РІСњРЉ');
        }
    };

    window.copyChannelLink = () => {
        const link = document.getElementById('channel-invite-link').value;
        navigator.clipboard.writeText(link).then(() => {
            showToast('Р РЋРЎРѓРЎвЂ№Р В»Р С”Р В° РЎРѓР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р В°', 'СЂСџвЂњвЂ№');
        }).catch(() => {
            // Fallback
            const input = document.getElementById('channel-invite-link');
            input.select();
            document.execCommand('copy');
            showToast('Р РЋРЎРѓРЎвЂ№Р В»Р С”Р В° РЎРѓР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р В°', 'СЂСџвЂњвЂ№');
        });
    };

    window.deleteChannel = async () => {
        if (!editingChannelId) return;
        
        // Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С Р С”Р В°РЎРѓРЎвЂљР С•Р СР Р…РЎвЂ№Р в„– confirm РЎвЂЎР ВµРЎР‚Р ВµР В· Р СР С•Р Т‘Р В°Р В»
        const confirmed = confirm('Р вЂ™РЎвЂ№ РЎС“Р Р†Р ВµРЎР‚Р ВµР Р…РЎвЂ№? Р С™Р В°Р Р…Р В°Р В» Р С‘ Р Р†РЎРѓР Вµ Р С—РЎС“Р В±Р В»Р С‘Р С”Р В°РЎвЂ Р С‘Р С‘ Р В±РЎС“Р Т‘РЎС“РЎвЂљ РЎС“Р Т‘Р В°Р В»Р ВµР Р…РЎвЂ№ Р Р…Р В°Р Р†РЎРѓР ВµР С–Р Т‘Р В°!');
        if (!confirmed) return;
        
        try {
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р Р†РЎРѓР Вµ Р С—Р С•РЎРѓРЎвЂљРЎвЂ№
            const postsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'channels', editingChannelId, 'posts'));
            const deletePromises = postsSnap.docs.map(d => deleteDoc(d.ref));
            await Promise.all(deletePromises);
            
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р С”Р В°Р Р…Р В°Р В»
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', editingChannelId));
            
            // Р вЂ”Р В°Р С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р СР С•Р Т‘Р В°Р В» Р С‘ РЎвЂЎР В°РЎвЂљ
            closeChannelSettings();
            activeChannel = null;
            document.getElementById('active-chat').classList.add('hidden');
            document.getElementById('chat-placeholder').classList.remove('hidden');
            
            // Р Р€Р Т‘Р В°Р В»РЎРЏР ВµР С Р С‘Р В· РЎРѓР С—Р С‘РЎРѓР С”Р В°
            const channelEl = document.querySelector(`[data-channel-id="${editingChannelId}"]`);
            if (channelEl) channelEl.remove();
            
            showToast('Р С™Р В°Р Р…Р В°Р В» РЎС“Р Т‘Р В°Р В»РЎвЂР Р…', 'СЂСџвЂ”вЂРїС‘РЏ');
        } catch (err) {
            console.error('Error deleting channel:', err);
            showToast('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ', 'РІСњРЉ');
        }
    };

    // Р С’Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚РЎвЂ№
    async function renderChannelAdmins(ownerId) {
        const list = document.getElementById('channel-admins-list');
        list.innerHTML = '';
        
        // Р вЂ™Р В»Р В°Р Т‘Р ВµР В»Р ВµРЎвЂ 
        try {
            const ownerDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', ownerId));
            if (ownerDoc.exists()) {
                const owner = ownerDoc.data();
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-2 bg-purple-50 dark:bg-purple-900/20 rounded-xl';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center text-xs font-bold">
                        ${owner.avatar ? `<img src="${owner.avatar}" class="w-full h-full object-cover rounded-full">` : owner.username?.[0]?.toUpperCase() || '?'}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-bold">@${owner.username || 'Unknown'}</p>
                        <p class="text-[10px] text-purple-500">Р вЂ™Р В»Р В°Р Т‘Р ВµР В»Р ВµРЎвЂ </p>
                    </div>
                    <i class="fas fa-crown text-yellow-500"></i>
                `;
                list.appendChild(div);
            }
        } catch (e) {}
        
        // Р С’Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚РЎвЂ№
        for (const adminId of channelAdmins) {
            try {
                const adminDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', adminId));
                if (adminDoc.exists()) {
                    const admin = adminDoc.data();
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-2 bg-slate-50 dark:bg-slate-800/50 rounded-xl';
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs font-bold">
                            ${admin.avatar ? `<img src="${admin.avatar}" class="w-full h-full object-cover rounded-full">` : admin.username?.[0]?.toUpperCase() || '?'}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold">@${admin.username || 'Unknown'}</p>
                            <p class="text-[10px] text-slate-400">Р С’Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚</p>
                        </div>
                        <button onclick="removeChannelAdmin('${adminId}')" class="w-6 h-6 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 flex items-center justify-center text-red-500">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    `;
                    list.appendChild(div);
                }
            } catch (e) {}
        }
        
        if (channelAdmins.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'text-center text-xs text-slate-400 py-2';
            emptyDiv.textContent = 'Р СњР ВµРЎвЂљ Р В°Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚Р С•Р Р†';
            list.appendChild(emptyDiv);
        }
    }

    window.openAddAdminModal = () => {
        document.getElementById('add-admin-modal').classList.remove('hidden');
        document.getElementById('admin-search-input').value = '';
        document.getElementById('admin-search-results').innerHTML = '';
    };

    window.closeAddAdminModal = (event) => {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('add-admin-modal').classList.add('hidden');
    };

    window.searchChannelSubscribers = async (query) => {
        const results = document.getElementById('admin-search-results');
        
        if (!query || query.length < 2 || !editingChannelId) {
            results.innerHTML = '';
            return;
        }
        
        try {
            const channelDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', editingChannelId));
            if (!channelDoc.exists()) return;
            
            const channel = channelDoc.data();
            const subscribers = channel.subscribers || [];
            
            results.innerHTML = '';
            
            for (const subId of subscribers) {
                // Р СџРЎР‚Р С•Р С—РЎС“РЎРѓР С”Р В°Р ВµР С Р Р†Р В»Р В°Р Т‘Р ВµР В»РЎРЉРЎвЂ Р В° Р С‘ РЎС“Р В¶Р Вµ Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р Р…РЎвЂ№РЎвЂ¦ Р В°Р Т‘Р СР С‘Р Р…Р С•Р Р†
                if (subId === channel.ownerId || channelAdmins.includes(subId)) continue;
                
                const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', subId));
                if (!userDoc.exists()) continue;
                
                const user = userDoc.data();
                if (!user.username?.toLowerCase().includes(query.toLowerCase())) continue;
                
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-colors';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs font-bold">
                        ${user.avatar ? `<img src="${user.avatar}" class="w-full h-full object-cover rounded-full">` : user.username?.[0]?.toUpperCase() || '?'}
                    </div>
                    <span class="text-sm font-medium">@${user.username}</span>
                `;
                div.onclick = () => addChannelAdmin(subId, user.username);
                results.appendChild(div);
            }
            
            if (results.children.length === 0) {
                results.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Р СњР С‘Р С”РЎвЂљР С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…</p>';
            }
        } catch (err) {
            console.error('Error searching subscribers:', err);
        }
    };

    window.addChannelAdmin = async (userId, username) => {
        if (channelAdmins.includes(userId)) return;
        
        channelAdmins.push(userId);
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С”
        const channelDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', editingChannelId));
        if (channelDoc.exists()) {
            renderChannelAdmins(channelDoc.data().ownerId);
        }
        
        closeAddAdminModal();
        showToast(`@${username} Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р… Р С”Р В°Р С” Р В°Р Т‘Р СР С‘Р Р…`, 'РІСљвЂ¦');
    };

    window.removeChannelAdmin = (userId) => {
        channelAdmins = channelAdmins.filter(id => id !== userId);
        
        // Р С›Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С РЎРѓР С—Р С‘РЎРѓР С•Р С”
        getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', editingChannelId)).then(channelDoc => {
            if (channelDoc.exists()) {
                renderChannelAdmins(channelDoc.data().ownerId);
            }
        });
        
        showToast('Р С’Р Т‘Р СР С‘Р Р…Р С‘РЎРѓРЎвЂљРЎР‚Р В°РЎвЂљР С•РЎР‚ РЎС“Р Т‘Р В°Р В»РЎвЂР Р…', 'СЂСџвЂ”вЂРїС‘РЏ');
    };

    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° РЎРѓРЎРѓРЎвЂ№Р В»Р С”Р С‘ Р Р…Р В° Р С”Р В°Р Р…Р В°Р В» Р С—РЎР‚Р С‘ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р Вµ
    function checkChannelInviteLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const channelId = urlParams.get('channel');
        
        if (channelId) {
            // Р Р€Р В±Р С‘РЎР‚Р В°Р ВµР С Р С—Р В°РЎР‚Р В°Р СР ВµРЎвЂљРЎР‚ Р С‘Р В· URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Р С›РЎвЂљР С”РЎР‚РЎвЂ№Р Р†Р В°Р ВµР С Р С”Р В°Р Р…Р В°Р В»
            getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', channelId)).then(channelDoc => {
                if (channelDoc.exists()) {
                    selectChannel({ id: channelId, ...channelDoc.data() });
                } else {
                    showToast('Р С™Р В°Р Р…Р В°Р В» Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…', 'РІСњРЉ');
                }
            });
        }
    }

    // Р вЂ™РЎвЂ№Р В·РЎвЂ№Р Р†Р В°Р ВµР С Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚Р С”РЎС“ Р С—Р С•РЎРѓР В»Р Вµ Р В°Р Р†РЎвЂљР С•РЎР‚Р С‘Р В·Р В°РЎвЂ Р С‘Р С‘
    setTimeout(checkChannelInviteLink, 2000);

    // Р вЂќР С•Р В±Р В°Р Р†Р В»РЎРЏР ВµР С listenToChannels Р Р† Р С‘Р Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎР‹
    const originalListenToGroups = listenToGroups;
    window.listenToGroupsAndChannels = () => {
        originalListenToGroups();
        listenToChannels();
    };

    // Р СџР В°РЎвЂљРЎвЂЎР С‘Р С Р Р†РЎвЂ№Р В·Р С•Р Р† listenToGroups
    if (typeof listenToGroups === 'function') {
        const oldInit = window.onload;
        // listenToChannels Р В±РЎС“Р Т‘Р ВµРЎвЂљ Р Р†РЎвЂ№Р В·Р Р†Р В°Р Р… Р С—Р С•РЎРѓР В»Р Вµ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘
    }
</script>
<script src="settings-content.js"></script>
</body>
</html>
