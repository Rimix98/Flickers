<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flickers Messenger ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --transition-speed: 0.3s;
        }

        body { font-family: 'Inter', sans-serif; transition: background 0.5s ease, color 0.5s ease; }
        
        /* –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã */
        body.theme-light { --bg-app: #f1f5f9; --bg-card: #ffffff; --text: #1e293b; --border: #e2e8f0; --accent: #4f46e5; }
        body.theme-dark { --bg-app: #0f172a; --bg-card: #1e293b; --text: #f1f5f9; --border: #334155; --accent: #6366f1; }
        body.theme-cosmic { --bg-app: #020617; --bg-card: rgba(30, 41, 59, 0.7); --text: #e2e8f0; --border: #334155; --accent: #818cf8; }

        body { background-color: var(--bg-app); color: var(--text); }
        .glass-panel { background-color: var(--bg-card); border: 1px solid var(--border); backdrop-filter: blur(16px); }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message-bubble { 
            max-width: 80%; 
            border-radius: 1.25rem; 
            animation: msg-slide-up 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            transform-origin: bottom;
        }

        @keyframes msg-slide-up {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .sent { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .received { background: var(--bg-card); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            background: var(--bg-card);
            border: 1px solid var(--accent);
            border-left: 5px solid var(--accent);
            padding: 16px;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toast-in 0.5s ease forwards;
            cursor: pointer;
            max-width: 320px;
        }

        @keyframes toast-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-out {
            animation: toast-out 0.5s ease forwards;
        }

        @keyframes toast-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* –≠–º–æ–¥–∑–∏-–ø–∞–Ω–µ–ª—å */
        .emoji-panel {
            display: none;
            position: absolute;
            bottom: 90px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            padding: 0;
            z-index: 100;
            animation: panel-pop 0.2s ease-out;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            overflow: hidden;
            flex-direction: column;
        }
        .emoji-panel.active { display: flex; }
        
        .emoji-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 8px;
            gap: 4px;
            overflow-x: auto;
            flex-shrink: 0;
        }
        .emoji-tab {
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .emoji-tab:hover { background: rgba(79, 70, 229, 0.1); }
        .emoji-tab.active { background: var(--accent); filter: grayscale(0); }
        
        .emoji-search {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .emoji-search input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-app);
            outline: none;
            font-size: 0.85rem;
        }
        .emoji-search input:focus { border-color: var(--accent); }
        
        .emoji-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
        }
        .emoji-category-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.5;
            margin: 10px 0 8px;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }
        
        @keyframes panel-pop {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .emoji-item { cursor: pointer; transition: transform 0.2s; font-size: 1.4rem; display: flex; justify-content: center; align-items: center; padding: 6px; border-radius: 8px; }
        .emoji-item:hover { transform: scale(1.2); background: rgba(79, 70, 229, 0.1); }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        #settings-panel { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            transform: translateX(100%); 
        }
        #settings-panel.active { transform: translateX(0); }
        
        /* –°–ø–∏–Ω–Ω–µ—Ä—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å */
        .progress-bar {
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ */
        .chat-item {
            transition: all 0.2s ease;
        }
        .chat-item:hover {
            transform: translateX(5px);
            background-color: rgba(79, 70, 229, 0.05);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        body.theme-dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* –≠–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞ */
        .call-screen {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: call-fade-in 0.3s ease;
        }
        @keyframes call-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: bold;
            animation: call-pulse 2s infinite;
            border: 4px solid rgba(255,255,255,0.3);
        }
        @keyframes call-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255,255,255,0); }
        }
        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .call-btn:hover { transform: scale(1.1); }
        .call-btn:active { transform: scale(0.95); }
        .call-btn-accept { background: #22c55e; color: white; }
        .call-btn-decline { background: #ef4444; color: white; }
        .call-btn-mute { background: rgba(255,255,255,0.2); color: white; }
        .call-btn-mute.active { background: #ef4444; }
        
        /* –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .video-container {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: #000;
        }
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .local-video {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 150px;
            height: 200px;
            border-radius: 1rem;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .video-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            padding: 15px 30px;
            background: rgba(0,0,0,0.5);
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        /* –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .voice-btn {
            transition: all 0.2s;
        }
        .voice-btn.recording {
            background: #ef4444 !important;
            color: white !important;
            animation: recording-pulse 1s infinite;
        }
        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }
        .voice-recording-ui {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 2rem;
            animation: slide-up 0.2s ease;
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .recording-indicator {
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .voice-waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 30px;
        }
        .voice-waveform span {
            width: 3px;
            background: var(--accent);
            border-radius: 3px;
            animation: wave 0.5s ease infinite;
        }
        .voice-waveform span:nth-child(1) { animation-delay: 0s; }
        .voice-waveform span:nth-child(2) { animation-delay: 0.1s; }
        .voice-waveform span:nth-child(3) { animation-delay: 0.2s; }
        .voice-waveform span:nth-child(4) { animation-delay: 0.3s; }
        .voice-waveform span:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave {
            0%, 100% { height: 8px; }
            50% { height: 25px; }
        }
        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }
        .voice-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .voice-play-btn:hover { transform: scale(1.1); }
        .voice-progress {
            flex: 1;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        .voice-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        /* –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å */
        .encrypted-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .self-destruct-msg {
            position: relative;
            overflow: hidden;
        }
        .self-destruct-msg::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #ef4444;
            animation: destruct-timer linear forwards;
        }
        .destruct-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            color: #ef4444;
            margin-left: 6px;
        }
        .anonymous-avatar {
            background: linear-gradient(135deg, #374151, #1f2937) !important;
        }
        .privacy-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-app);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        .privacy-toggle label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: var(--accent);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        .secret-chat-indicator {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        @keyframes msg-fade-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
    </style>
</head>
<body class="theme-light h-screen flex flex-col overflow-hidden">

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ—Å—Ç–æ–≤ -->
<div id="toast-container"></div>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
<div id="incoming-call-screen" class="call-screen hidden">
    <div class="call-avatar" id="caller-avatar">?</div>
    <p class="text-white text-2xl font-bold mt-6" id="caller-name">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</p>
    <p class="text-white/60 text-sm mt-2" id="call-type-label">–ê—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫</p>
    <div class="flex gap-8 mt-12">
        <button class="call-btn call-btn-decline" onclick="declineCall()">
            <i class="fas fa-phone-slash"></i>
        </button>
        <button class="call-btn call-btn-accept" onclick="acceptCall()">
            <i class="fas fa-phone-alt"></i>
        </button>
    </div>
</div>

<!-- –≠–∫—Ä–∞–Ω –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
<div id="outgoing-call-screen" class="call-screen hidden">
    <div class="call-avatar" id="callee-avatar">?</div>
    <p class="text-white text-2xl font-bold mt-6" id="callee-name">–ó–≤–æ–Ω–∏–º...</p>
    <p class="text-white/60 text-sm mt-2">–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞</p>
    <div class="flex gap-8 mt-12">
        <button class="call-btn call-btn-decline" onclick="cancelCall()">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>
</div>

<!-- –≠–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
<div id="active-call-screen" class="video-container hidden">
    <video id="remote-video" class="remote-video" autoplay playsinline></video>
    <video id="local-video" class="local-video" autoplay playsinline muted></video>
    <div class="video-controls">
        <button class="call-btn call-btn-mute" id="mute-btn" onclick="toggleMute()">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="call-btn call-btn-mute" id="video-btn" onclick="toggleVideo()">
            <i class="fas fa-video"></i>
        </button>
        <button class="call-btn call-btn-decline" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>
    <div class="absolute top-6 left-1/2 -translate-x-1/2 text-white text-center">
        <p class="font-bold" id="active-call-name">–ó–≤–æ–Ω–æ–∫</p>
        <p class="text-sm opacity-60" id="call-timer">00:00</p>
    </div>
</div>

<!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="loading-overlay" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center transition-opacity duration-500">
    <div class="relative">
        <div class="w-20 h-20 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <i class="fas fa-bolt text-indigo-500 animate-pulse"></i>
        </div>
    </div>
    <div class="mt-6 text-2xl font-black text-white tracking-[0.3em] animate-pulse">FLICKERS</div>
</div>

<!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-indigo-600 hidden p-4">
    <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center transform transition-all">
        <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-[2rem] flex items-center justify-center mx-auto text-4xl mb-4 animate-bounce">
            <i class="fas fa-bolt"></i>
        </div>
        <h1 class="text-3xl font-black text-slate-800 mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p class="text-slate-500 mb-8 text-sm">–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
        <input type="text" id="username-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" class="w-full p-4 bg-slate-100 rounded-2xl outline-none mb-4 focus:ring-2 focus:ring-indigo-500 transition-all">
        <button onclick="handleAuth()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg active:scale-95">–í–æ–π—Ç–∏ –≤ Flickers</button>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
<div id="main-app" class="hidden h-full flex flex-col md:flex-row overflow-hidden">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="w-full md:w-80 glass-panel flex flex-col h-full z-20 border-r border-[var(--border)]">
        <div class="p-6 flex justify-between items-center border-b border-[var(--border)]">
            <span class="text-2xl font-black text-indigo-500 italic tracking-tighter">FLICKERS</span>
            <button onclick="toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                <i class="fas fa-cog text-xl"></i>
            </button>
        </div>
        <div class="p-4 relative">
            <div class="relative group">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –Ω–∏–∫–∞..." class="w-full p-3 pl-10 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm border border-transparent focus:border-indigo-500 transition-all">
            </div>
            <div id="search-results" class="absolute left-4 right-4 mt-2 glass-panel rounded-xl shadow-2xl z-50 hidden max-h-60 overflow-y-auto animate-panel-pop"></div>
        </div>
        <div id="chats-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        <div class="p-4 border-t border-[var(--border)] flex items-center space-x-3 bg-slate-50/50 dark:bg-slate-900/50">
            <div id="my-avatar" class="w-12 h-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center font-bold text-xl shadow-lg shadow-indigo-500/20">?</div>
            <div class="flex-1 min-w-0">
                <p class="font-bold text-sm truncate" id="my-name">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                <p class="text-[10px] text-green-500 font-bold uppercase tracking-wider">–í —Å–µ—Ç–∏</p>
            </div>
        </div>
    </aside>

    <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <div id="chat-placeholder" class="flex-1 flex flex-col items-center justify-center text-slate-400 opacity-20 animate-pulse">
            <i class="fas fa-bolt text-9xl mb-4"></i>
            <p class="font-black uppercase tracking-[0.4em]">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç</p>
        </div>

        <div id="active-chat" class="hidden flex-1 flex flex-col h-full">
            <header class="p-4 border-b border-[var(--border)] glass-panel flex items-center justify-between z-10">
                <div class="flex items-center space-x-3">
                    <div id="target-avatar" class="w-10 h-10 rounded-xl bg-indigo-100 text-indigo-500 flex items-center justify-center font-bold">?</div>
                    <div>
                        <p id="target-name" class="font-bold">–ß–∞—Ç</p>
                        <p id="typing-indicator" class="text-[10px] opacity-0 transition-opacity">–ü–µ—á–∞—Ç–∞–µ—Ç...</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="startCall(false)" class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="–ê—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫"><i class="fas fa-phone-alt"></i></button>
                    <button onclick="startCall(true)" class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="–í–∏–¥–µ–æ –∑–≤–æ–Ω–æ–∫"><i class="fas fa-video"></i></button>
                    <button class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><i class="fas fa-ellipsis-v"></i></button>
                </div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>

            <footer class="p-4 border-t border-[var(--border)] glass-panel relative z-10">
                <div id="emoji-panel" class="emoji-panel glass-panel">
                    <div class="emoji-tabs" id="emoji-tabs"></div>
                    <div class="emoji-search">
                        <input type="text" id="emoji-search-input" placeholder="–ü–æ–∏—Å–∫ —ç–º–æ–¥–∑–∏...">
                    </div>
                    <div class="emoji-content" id="emoji-content"></div>
                </div>

                <div id="upload-status" class="hidden px-4 py-3 bg-indigo-500/10 rounded-xl mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-indigo-500 italic">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ (250MB –º–∞–∫—Å)...</span>
                        <span id="p-percent" class="text-[10px] font-bold text-indigo-500">0%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div>
                </div>

                <div class="max-w-5xl mx-auto flex items-center space-x-2">
                    <button onclick="triggerFile()" class="w-12 h-12 flex items-center justify-center text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-xl transition-all">
                        <i class="fas fa-paperclip text-xl"></i>
                    </button>
                    <input type="file" id="file-input" class="hidden" onchange="handleFile(this)">
                    
                    <button onclick="toggleEmoji()" class="w-12 h-12 flex items-center justify-center text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-xl transition-all">
                        <i class="far fa-smile text-xl"></i>
                    </button>

                    <div class="flex-1 relative" id="input-container">
                        <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all border border-transparent">
                        
                        <!-- UI –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ -->
                        <div id="voice-recording-ui" class="voice-recording-ui hidden absolute inset-0">
                            <div class="recording-indicator"></div>
                            <div class="voice-waveform">
                                <span></span><span></span><span></span><span></span><span></span>
                            </div>
                            <span id="voice-timer" class="text-sm font-mono font-bold">0:00</span>
                            <button onclick="cancelVoice()" class="ml-auto text-red-500 hover:bg-red-50 w-8 h-8 rounded-full flex items-center justify-center">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <button id="voice-btn" onmousedown="startVoice()" onmouseup="stopVoice()" ontouchstart="startVoice()" ontouchend="stopVoice()" class="voice-btn w-12 h-12 flex items-center justify-center text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-xl transition-all">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>

                    <button onclick="sendMsg()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center hover:bg-indigo-700 shadow-xl active:scale-90 transition-all">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </button>
                </div>
            </footer>
        </div>
    </main>

    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settings-panel" class="fixed inset-y-0 right-0 w-85 max-w-full glass-panel shadow-[-20px_0_50px_rgba(0,0,0,0.1)] z-50 p-8 overflow-y-auto">
        <div class="flex justify-between items-center mb-10">
            <h3 class="text-2xl font-black italic">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <button onclick="toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-50 hover:text-red-500 transition-all"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="space-y-6">
            <!-- –ü—Ä–æ—Ñ–∏–ª—å –∏ –∞–≤–∞—Ç–∞—Ä–∫–∞ -->
            <div>
                <p class="text-[10px] font-bold uppercase text-indigo-500 mb-3 tracking-widest">–ü—Ä–æ—Ñ–∏–ª—å</p>
                <div class="flex flex-col items-center p-6 bg-slate-100 dark:bg-slate-800 rounded-2xl">
                    <div class="relative group cursor-pointer" onclick="triggerAvatarUpload()">
                        <div id="settings-avatar" class="w-24 h-24 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-3xl shadow-lg overflow-hidden">
                            ?
                        </div>
                        <div class="absolute inset-0 rounded-full bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-camera text-white text-xl"></i>
                        </div>
                    </div>
                    <p id="settings-username" class="mt-3 font-bold">@username</p>
                    <p class="text-xs opacity-50 mt-1">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>
                    <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="handleAvatarUpload(this)">
                </div>
            </div>

            <div>
                <p class="text-[10px] font-bold uppercase text-indigo-500 mb-3 tracking-widest">–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö</p>
                <div class="p-4 bg-slate-100 dark:bg-slate-800 rounded-2xl text-xs space-y-2">
                    <div class="flex justify-between"><span>–õ–∏–º–∏—Ç —Ñ–∞–π–ª–∞:</span> <span class="font-bold text-indigo-500">250 –ú–ë</span></div>
                    <div class="opacity-50 leading-relaxed pt-2 border-t border-[var(--border)]">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ 1–ú–ë.</div>
                </div>
            </div>
            
            <div>
                <p class="text-[10px] font-bold uppercase text-indigo-500 mb-3 tracking-widest">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</p>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="setTheme('light')" class="flex items-center space-x-3 p-4 rounded-2xl border border-[var(--border)] hover:bg-white transition-all">
                        <span class="w-6 h-6 flex items-center justify-center bg-yellow-400 text-white rounded-lg text-xs">‚òÄÔ∏è</span>
                        <span class="font-medium">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
                    </button>
                    <button onclick="setTheme('dark')" class="flex items-center space-x-3 p-4 rounded-2xl border border-[var(--border)] hover:bg-slate-800 transition-all">
                        <span class="w-6 h-6 flex items-center justify-center bg-slate-700 text-white rounded-lg text-xs">üåô</span>
                        <span class="font-medium">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                    </button>
                    <button onclick="setTheme('cosmic')" class="flex items-center space-x-3 p-4 rounded-2xl border border-indigo-500 bg-indigo-500/10 hover:bg-indigo-500/20 transition-all">
                        <span class="w-6 h-6 flex items-center justify-center bg-indigo-900 text-white rounded-lg text-xs">üöÄ</span>
                        <span class="font-medium">–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è</span>
                    </button>
                </div>
            </div>

            <!-- –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
            <div>
                <p class="text-[10px] font-bold uppercase text-indigo-500 mb-3 tracking-widest">üîí –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</p>
                <div class="space-y-2">
                    <div class="privacy-toggle">
                        <label>
                            <i class="fas fa-user-secret text-indigo-500"></i>
                            <span>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ä–µ–∂–∏–º</span>
                        </label>
                        <div id="toggle-anonymous" class="toggle-switch" onclick="togglePrivacy('anonymous')"></div>
                    </div>
                    <div class="privacy-toggle">
                        <label>
                            <i class="fas fa-eye-slash text-indigo-500"></i>
                            <span>–°–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω</span>
                        </label>
                        <div id="toggle-hide-online" class="toggle-switch" onclick="togglePrivacy('hideOnline')"></div>
                    </div>
                    <div class="privacy-toggle">
                        <label>
                            <i class="fas fa-lock text-indigo-500"></i>
                            <span>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ E2E</span>
                        </label>
                        <div id="toggle-encryption" class="toggle-switch active" onclick="togglePrivacy('encryption')"></div>
                    </div>
                    <div class="privacy-toggle">
                        <label>
                            <i class="fas fa-ban text-indigo-500"></i>
                            <span>–ë–ª–æ–∫. —Å–∫—Ä–∏–Ω—à–æ—Ç—ã</span>
                        </label>
                        <div id="toggle-block-screenshots" class="toggle-switch" onclick="togglePrivacy('blockScreenshots')"></div>
                    </div>
                </div>
                <p class="text-[10px] opacity-50 mt-3 leading-relaxed">
                    <i class="fas fa-shield-alt mr-1"></i>
                    –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π. –ù–∏–∫—Ç–æ, –≤–∫–ª—é—á–∞—è —Å–µ—Ä–≤–µ—Ä, –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
                </p>
            </div>

            <!-- –°–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div>
                <p class="text-[10px] font-bold uppercase text-indigo-500 mb-3 tracking-widest">‚è±Ô∏è –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ</p>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setAutoDestruct(0)" id="destruct-off" class="destruct-btn p-3 rounded-xl border border-[var(--border)] text-xs font-bold hover:bg-indigo-50 transition-all active">–í—ã–∫–ª</button>
                    <button onclick="setAutoDestruct(30)" id="destruct-30" class="destruct-btn p-3 rounded-xl border border-[var(--border)] text-xs font-bold hover:bg-indigo-50 transition-all">30—Å</button>
                    <button onclick="setAutoDestruct(300)" id="destruct-300" class="destruct-btn p-3 rounded-xl border border-[var(--border)] text-xs font-bold hover:bg-indigo-50 transition-all">5–º</button>
                    <button onclick="setAutoDestruct(3600)" id="destruct-3600" class="destruct-btn p-3 rounded-xl border border-[var(--border)] text-xs font-bold hover:bg-indigo-50 transition-all">1—á</button>
                </div>
                <p class="text-[10px] opacity-50 mt-2">–°–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è</p>
            </div>

            <div class="pt-6 space-y-2">
                <button onclick="checkForUpdates()" class="w-full p-4 text-center text-indigo-500 font-bold bg-indigo-50 dark:bg-indigo-500/10 rounded-2xl active:scale-95 transition-all">
                    <i class="fas fa-download mr-2"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                </button>
                <button onclick="location.reload()" class="w-full p-4 text-center text-red-500 font-bold bg-red-50 dark:bg-red-500/10 rounded-2xl active:scale-95 transition-all">
                    <i class="fas fa-sign-out-alt mr-2"></i> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, onSnapshot, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDkFjU_6XIp7P4DuaYNfvYPcrXimmvtmgg",
        authDomain: "govno-kakoeto-messanger.firebaseapp.com",
        projectId: "govno-kakoeto-messanger",
        storageBucket: "govno-kakoeto-messanger.firebasestorage.app",
        messagingSenderId: "216784452110",
        appId: "1:216784452110:web:c32cee25d38e49bc449a5f"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'flickers-pro-v2';

    let me = null, activeChatPartner = null, msgUnsub = null, chatListeners = {};

    const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

    // ========== –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ==========
    const privacySettings = {
        anonymous: false,
        hideOnline: false,
        encryption: true,
        blockScreenshots: false,
        autoDestruct: 0 // —Å–µ–∫—É–Ω–¥—ã, 0 = –≤—ã–∫–ª
    };

    // –ü—Ä–æ—Å—Ç–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ AES-–ø–æ–¥–æ–±–Ω–æ–µ (–¥–ª—è –¥–µ–º–æ, –≤ –ø—Ä–æ–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Web Crypto API)
    const encryptionKey = 'flickers-e2e-secret-key-2024';
    
    function encrypt(text) {
        if (!privacySettings.encryption || !text) return text;
        try {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                result += String.fromCharCode(charCode);
            }
            return btoa(unescape(encodeURIComponent(result)));
        } catch {
            return text;
        }
    }

    function decrypt(encoded) {
        if (!encoded) return encoded;
        try {
            const text = decodeURIComponent(escape(atob(encoded)));
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                result += String.fromCharCode(charCode);
            }
            return result;
        } catch {
            return encoded; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å –µ—Å–ª–∏ –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ
        }
    }

    function isEncrypted(text) {
        if (!text) return false;
        try {
            atob(text);
            return text.length > 0 && /^[A-Za-z0-9+/=]+$/.test(text);
        } catch {
            return false;
        }
    }

    window.togglePrivacy = (setting) => {
        privacySettings[setting] = !privacySettings[setting];
        const toggle = document.getElementById(`toggle-${setting.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
        if (toggle) {
            toggle.classList.toggle('active', privacySettings[setting]);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        if (me?.uid) {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                privacy: privacySettings
            }, { merge: true });
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
        if (setting === 'blockScreenshots' && privacySettings.blockScreenshots) {
            document.addEventListener('keyup', preventScreenshot);
        }
        
        // –ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ä–µ–∂–∏–º - –æ–±–Ω–æ–≤–ª—è–µ–º UI
        if (setting === 'anonymous') {
            updateAnonymousMode();
        }
    };

    function preventScreenshot(e) {
        if (e.key === 'PrintScreen' || (e.ctrlKey && e.key === 'p')) {
            e.preventDefault();
            alert('üìµ –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ');
        }
    }

    function updateAnonymousMode() {
        const myAvatar = document.getElementById('my-avatar');
        const myName = document.getElementById('my-name');
        
        if (privacySettings.anonymous) {
            myAvatar.innerHTML = '<i class="fas fa-user-secret"></i>';
            myAvatar.classList.add('anonymous-avatar');
            myName.innerText = '@anonymous';
        } else if (me) {
            myAvatar.classList.remove('anonymous-avatar');
            if (me.avatar) {
                myAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover rounded-2xl">`;
            } else {
                myAvatar.innerHTML = me.username[0].toUpperCase();
            }
            myName.innerText = '@' + me.username;
        }
    }

    window.setAutoDestruct = (seconds) => {
        privacySettings.autoDestruct = seconds;
        document.querySelectorAll('.destruct-btn').forEach(btn => btn.classList.remove('active', 'bg-red-500', 'text-white', 'border-red-500'));
        const activeBtn = document.getElementById(`destruct-${seconds === 0 ? 'off' : seconds}`);
        if (activeBtn) {
            activeBtn.classList.add('active', 'bg-red-500', 'text-white', 'border-red-500');
        }
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ)
    window.checkForUpdates = () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –≤ Electron
        if (typeof require !== 'undefined') {
            try {
                const { shell } = require('electron');
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º updater –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–≥—Ä—É–∑–∫–∏
                shell.openExternal('https://github.com/YOUR_USERNAME/flickers-messenger/releases');
            } catch {
                alert('–ó–∞–ø—É—Å—Ç–∏—Ç–µ Flickers-Updater.exe –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
            }
        } else {
            alert('‚ú® –í–µ—Ä—Å–∏—è 1.0.0\n\n–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫–∞—á–∞–π—Ç–µ Flickers-Updater.exe');
        }
    };

    function loadPrivacySettings() {
        if (me?.privacy) {
            Object.assign(privacySettings, me.privacy);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
        Object.keys(privacySettings).forEach(key => {
            if (key === 'autoDestruct') return;
            const toggle = document.getElementById(`toggle-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
            if (toggle) {
                toggle.classList.toggle('active', privacySettings[key]);
            }
        });
        
        // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ
        setAutoDestruct(privacySettings.autoDestruct || 0);
    }

    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) { console.error(e); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                me = { uid: user.uid, ...userSnap.data() };
                showApp();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('opacity-0');
                setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 500);
            }
        } else {
            initAuth();
        }
    });

    window.handleAuth = async () => {
        const username = document.getElementById('username-input').value.trim();
        if (!username || !auth.currentUser) return;
        const userData = { username, uid: auth.currentUser.uid, settings: { theme: 'light' } };
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', auth.currentUser.uid), userData);
        me = userData;
        showApp();
    };

    function showApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('loading-overlay').classList.add('opacity-0');
        setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 500);
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('my-name').innerText = "@" + me.username;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
        const myAvatar = document.getElementById('my-avatar');
        if (me.avatar) {
            myAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover rounded-2xl">`;
        } else {
            myAvatar.innerText = me.username[0].toUpperCase();
        }
        
        if(me.settings?.theme) setTheme(me.settings.theme);
        loadPrivacySettings();
        initEmoji();
        listenToChats();
    }

    function showNotification(partner, message) {
        if (activeChatPartner && activeChatPartner.uid === partner.uid) return;
        
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'notification-toast';
        toast.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold">${partner.username[0].toUpperCase()}</div>
            <div class="flex-1 overflow-hidden">
                <p class="font-bold text-xs">@${partner.username}</p>
                <p class="text-xs opacity-70 truncate">${message}</p>
            </div>
        `;
        
        toast.onclick = () => {
            selectChat(partner);
            toast.classList.add('toast-out');
            setTimeout(() => toast.remove(), 500);
        };

        container.appendChild(toast);
        notificationSound.play().catch(() => {});

        setTimeout(() => {
            if (toast.parentNode) {
                toast.classList.add('toast-out');
                setTimeout(() => toast.remove(), 500);
            }
        }, 5000);
    }

    function listenToChats() {
        if (!me) return;
        const q = collection(db, 'artifacts', appId, 'users', me.uid, 'active_chats');
        onSnapshot(q, async (snap) => {
            const list = document.getElementById('chats-list');
            list.innerHTML = '';
            snap.docChanges().forEach(change => {
                const chat = change.doc.data();
                if (change.type === 'modified' && chat.lastSenderId !== me.uid) {
                    showNotification(chat, chat.last);
                }
            });

            for (const d of snap.docs) {
                const chat = d.data();
                
                // –ü–æ–ª—É—á–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let avatarHtml = `<div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center font-bold text-indigo-500 shadow-sm overflow-hidden">`;
                try {
                    const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', chat.uid));
                    if (userDoc.exists() && userDoc.data().avatar) {
                        avatarHtml += `<img src="${userDoc.data().avatar}" class="w-full h-full object-cover">`;
                    } else {
                        avatarHtml += chat.username[0].toUpperCase();
                    }
                } catch {
                    avatarHtml += chat.username[0].toUpperCase();
                }
                avatarHtml += `</div>`;
                
                const div = document.createElement('div');
                div.className = `chat-item p-4 glass-panel rounded-2xl cursor-pointer flex items-center space-x-3 ${activeChatPartner?.uid === chat.uid ? 'border-indigo-500 bg-indigo-500/5' : ''}`;
                div.onclick = () => selectChat(chat);
                div.innerHTML = `
                    ${avatarHtml}
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-sm">@${chat.username}</p>
                            <span class="text-[8px] opacity-30">—Å–µ–π—á–∞—Å</span>
                        </div>
                        <p class="text-xs opacity-40 truncate">${chat.last || '...'}</p>
                    </div>
                `;
                list.appendChild(div);
            }
        });
    }

    window.selectChat = async (partner) => {
        activeChatPartner = partner;
        document.getElementById('chat-placeholder').classList.add('hidden');
        document.getElementById('active-chat').classList.remove('hidden');
        document.getElementById('target-name').innerText = "@" + partner.username;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        const targetAvatar = document.getElementById('target-avatar');
        try {
            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', partner.uid));
            if (userDoc.exists() && userDoc.data().avatar) {
                targetAvatar.innerHTML = `<img src="${userDoc.data().avatar}" class="w-full h-full object-cover rounded-xl">`;
            } else {
                targetAvatar.innerText = partner.username[0].toUpperCase();
            }
        } catch {
            targetAvatar.innerText = partner.username[0].toUpperCase();
        }

        if (msgUnsub) msgUnsub();
        const chatId = [me.uid, partner.uid].sort().join('_');
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), orderBy('timestamp', 'asc'));
        
        msgUnsub = onSnapshot(q, (snap) => {
            const cont = document.getElementById('messages-container');
            const shouldScroll = cont.scrollTop + cont.offsetHeight >= cont.scrollHeight - 100;
            
            cont.innerHTML = '';
            snap.forEach(d => {
                const m = d.data();
                const msgId = d.id;
                const div = document.createElement('div');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π
                let extraClass = '';
                if (m.autoDestruct && m.autoDestruct > 0) {
                    extraClass = ' self-destruct-msg';
                    div.style.setProperty('--destruct-time', m.autoDestruct + 's');
                }
                
                div.className = `message-bubble p-4 shadow-sm ${m.senderId === me.uid ? 'sent' : 'received'}${extraClass}`;
                
                // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                let displayText = m.text || '';
                if (m.encrypted && displayText) {
                    displayText = decrypt(displayText);
                }
                
                // –ë–µ–π–¥–∂–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                let securityBadges = '';
                if (m.encrypted) {
                    securityBadges += '<span class="encrypted-badge"><i class="fas fa-lock"></i> E2E</span>';
                }
                if (m.autoDestruct && m.autoDestruct > 0) {
                    const timeLabel = m.autoDestruct >= 3600 ? Math.floor(m.autoDestruct/3600) + '—á' : 
                                     m.autoDestruct >= 60 ? Math.floor(m.autoDestruct/60) + '–º' : m.autoDestruct + '—Å';
                    securityBadges += `<span class="destruct-badge"><i class="fas fa-fire"></i> ${timeLabel}</span>`;
                }
                
                let content = `<p class="text-sm leading-relaxed">${displayText}${securityBadges}</p>`;
                
                if (m.type === 'voice') {
                    const dur = m.voiceDuration || 0;
                    content = `
                        <div class="voice-message">
                            <button class="voice-play-btn" onclick="playVoice(this, '${m.voiceData}', ${dur})">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="flex-1">
                                <div class="voice-progress" onclick="seekVoice(event, this)">
                                    <div class="voice-progress-fill"></div>
                                </div>
                                <span class="voice-time text-[10px] opacity-60">0:${dur.toString().padStart(2, '0')}</span>
                            </div>
                        </div>
                        ${securityBadges}
                    `;
                } else if (m.type === 'file') {
                    if (m.fileType && m.fileType.startsWith('image/')) {
                        content = `<img src="${m.fileData}" class="rounded-xl max-w-full mb-2 cursor-pointer hover:brightness-90 transition-all shadow-md">` + content;
                    } else {
                        content = `<a href="${m.fileData}" download="${m.fileName}" class="flex items-center space-x-3 bg-black/5 p-3 rounded-xl text-xs font-bold hover:bg-black/10 transition-colors mb-2"><i class="fas fa-file-download text-lg"></i> <div><p class="truncate w-32">${m.fileName}</p><p class="opacity-50 font-normal">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</p></div></a>` + content;
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–∞–Ω–æ–Ω–∏–º–Ω–æ–µ –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ–µ)
                const senderLabel = m.senderName === 'anonymous' ? 'üë§ –ê–Ω–æ–Ω–∏–º' : '';
                const senderHtml = senderLabel && m.senderId !== me.uid ? `<span class="text-[9px] opacity-50 block mb-1">${senderLabel}</span>` : '';
                
                div.innerHTML = senderHtml + content + `<span class="text-[9px] block mt-1 opacity-50 text-right">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</span>`;
                cont.appendChild(div);
                
                // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                if (m.autoDestruct && m.autoDestruct > 0 && m.senderId !== me.uid) {
                    setTimeout(() => {
                        div.style.animation = 'msg-fade-out 0.5s ease forwards';
                        setTimeout(() => div.remove(), 500);
                    }, m.autoDestruct * 1000);
                }
            });
            if(shouldScroll) cont.scrollTop = cont.scrollHeight;
        });
    };

    window.sendMsg = async (extraData = {}) => {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if ((!text && !extraData.type) || !activeChatPartner || !me) return;
        
        const chatId = [me.uid, activeChatPartner.uid].sort().join('_');
        
        // –®–∏—Ñ—Ä—É–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
        const encryptedText = privacySettings.encryption ? encrypt(text) : text;
        
        const msg = {
            text: encryptedText,
            senderId: me.uid,
            senderName: privacySettings.anonymous ? 'anonymous' : me.username,
            timestamp: serverTimestamp(),
            encrypted: privacySettings.encryption,
            autoDestruct: privacySettings.autoDestruct,
            ...extraData
        };

        input.value = '';
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), msg);
            
            const lastMsgText = privacySettings.encryption ? 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ' : (text || (extraData.type === 'file' ? '[–§–∞–π–ª]' : '–°–æ–æ–±—â–µ–Ω–∏–µ'));
            const displayName = privacySettings.anonymous ? '–ê–Ω–æ–Ω–∏–º' : me.username;
            
            const updateChat = async (uid, otherId, otherName, isMe) => {
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'active_chats', otherId), {
                    uid: otherId, 
                    username: otherName, 
                    last: lastMsgText, 
                    lastSenderId: me.uid,
                    timestamp: serverTimestamp()
                }, { merge: true });
            };
            
            await updateChat(me.uid, activeChatPartner.uid, activeChatPartner.username, true);
            await updateChat(activeChatPartner.uid, me.uid, displayName, false);
        } catch (e) {
            console.error("Firebase Error", e);
        }
    };

    window.triggerFile = () => document.getElementById('file-input').click();
    window.handleFile = (input) => {
        const file = input.files[0];
        if (!file) return;

        const MAX_SIZE = 1 * 1024 * 1024; // –õ–∏–º–∏—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 1MB
        const status = document.getElementById('upload-status');
        const pFill = document.getElementById('p-fill');
        const pPerc = document.getElementById('p-percent');
        
        if (file.size > MAX_SIZE) {
            alert("–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 1 –ú–ë –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.");
            input.value = '';
            return;
        }

        status.classList.remove('hidden');
        const reader = new FileReader();
        reader.onprogress = (e) => {
            if (e.lengthComputable) {
                const pct = Math.round((e.loaded / e.total) * 100);
                pFill.style.width = pct + '%';
                pPerc.innerText = pct + '%';
            }
        };

        reader.onload = (e) => {
            status.classList.add('hidden');
            sendMsg({ type: 'file', fileName: file.name, fileType: file.type, fileData: e.target.result });
        };
        reader.readAsDataURL(file);
        input.value = '';
    };

    const emojiCategories = {
        'smileys': {
            icon: 'üòÄ',
            name: '–°–º–∞–π–ª—ã',
            emojis: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','‚ò∫Ô∏è','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','ü•∏','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ']
        },
        'gestures': {
            icon: 'üëã',
            name: '–ñ–µ—Å—Ç—ã',
            emojis: ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ']
        },
        'people': {
            icon: 'üë∂',
            name: '–õ—é–¥–∏',
            emojis: ['üë∂','üßí','üë¶','üëß','üßë','üë±','üë®','üßî','üë©','üßì','üë¥','üëµ','üôç','üôé','üôÖ','üôÜ','üíÅ','üôã','üßè','üôá','ü§¶','ü§∑','üëÆ','üïµÔ∏è','üíÇ','ü•∑','üë∑','ü§¥','üë∏','üë≥','üë≤','üßï','ü§µ','üë∞','ü§∞','ü§±','üëº','üéÖ','ü§∂','ü¶∏','ü¶π','üßô','üßö','üßõ','üßú','üßù','üßû','üßü','üíÜ','üíá','üö∂','üßç','üßé','üèÉ','üíÉ','üï∫','üï¥Ô∏è','üëØ','üßñ','üßó','ü§∏','üèåÔ∏è','üèá','‚õ∑Ô∏è','üèÇ','üèãÔ∏è','ü§º','ü§Ω','ü§æ','ü§∫','‚õπÔ∏è','üèä','üö£','üßò','üõÄ','üõå']
        },
        'animals': {
            icon: 'üê∂',
            name: '–ñ–∏–≤–æ—Ç–Ω—ã–µ',
            emojis: ['üê∂','üêï','ü¶Æ','üêï‚Äçü¶∫','üê©','üê∫','ü¶ä','ü¶ù','üê±','üêà','üêà‚Äç‚¨õ','ü¶Å','üêØ','üêÖ','üêÜ','üê¥','üêé','ü¶Ñ','ü¶ì','ü¶å','ü¶¨','üêÆ','üêÇ','üêÉ','üêÑ','üê∑','üêñ','üêó','üêΩ','üêè','üêë','üêê','üê™','üê´','ü¶ô','ü¶í','üêò','ü¶£','ü¶è','ü¶õ','üê≠','üêÅ','üêÄ','üêπ','üê∞','üêá','üêøÔ∏è','ü¶´','ü¶î','ü¶á','üêª','üêª‚Äç‚ùÑÔ∏è','üê®','üêº','ü¶•','ü¶¶','ü¶®','ü¶ò','ü¶°','üêæ','ü¶É','üêî','üêì','üê£','üê§','üê•','üê¶','üêß','üïäÔ∏è','ü¶Ö','ü¶Ü','ü¶¢','ü¶â','ü¶§','ü™∂','ü¶©','ü¶ö','ü¶ú','üê∏','üêä','üê¢','ü¶é','üêç','üê≤','üêâ','ü¶ï','ü¶ñ','üê≥','üêã','üê¨','ü¶≠','üêü','üê†','üê°','ü¶à','üêô','üêö','üêå','ü¶ã','üêõ','üêú','üêù','ü™≤','üêû','ü¶ó','ü™≥','üï∑Ô∏è','üï∏Ô∏è','ü¶Ç','ü¶ü','ü™∞','ü™±','ü¶†']
        },
        'food': {
            icon: 'üçî',
            name: '–ï–¥–∞',
            emojis: ['üçá','üçà','üçâ','üçä','üçã','üçå','üçç','ü•≠','üçé','üçè','üçê','üçë','üçí','üçì','ü´ê','ü•ù','üçÖ','ü´í','ü••','ü•ë','üçÜ','ü•î','ü•ï','üåΩ','üå∂Ô∏è','ü´ë','ü•í','ü•¨','ü•¶','üßÑ','üßÖ','üçÑ','ü•ú','üå∞','üçû','ü•ê','ü•ñ','ü´ì','ü•®','ü•Ø','ü•û','üßá','üßÄ','üçñ','üçó','ü•©','ü•ì','üçî','üçü','üçï','üå≠','ü•™','üåÆ','üåØ','ü´î','ü•ô','üßÜ','ü•ö','üç≥','ü•ò','üç≤','ü´ï','ü•£','ü•ó','üçø','üßà','üßÇ','ü•´','üç±','üçò','üçô','üçö','üçõ','üçú','üçù','üç†','üç¢','üç£','üç§','üç•','ü•Æ','üç°','ü•ü','ü•†','ü•°','ü¶Ä','ü¶û','ü¶ê','ü¶ë','ü¶™','üç¶','üçß','üç®','üç©','üç™','üéÇ','üç∞','üßÅ','ü•ß','üç´','üç¨','üç≠','üçÆ','üçØ','üçº','ü•õ','‚òï','ü´ñ','üçµ','üç∂','üçæ','üç∑','üç∏','üçπ','üç∫','üçª','ü•Ç','ü•É','ü•§','üßã','üßÉ','üßâ','üßä']
        },
        'activities': {
            icon: '‚öΩ',
            name: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
            emojis: ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèí','üèë','ü•ç','üèè','ü™É','ü•Ö','‚õ≥','ü™Å','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõº','üõ∑','‚õ∏Ô∏è','ü•å','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','ü§º','ü§∏','ü§∫','‚õπÔ∏è','ü§æ','üèåÔ∏è','üèá','üßò','üèÑ','üèä','ü§Ω','üö£','üßó','üö¥','üöµ','üéñÔ∏è','üèÜ','üèÖ','ü•á','ü•à','ü•â','üé™','ü§π','üé≠','ü©∞','üé®','üé¨','üé§','üéß','üéº','üéπ','ü•Å','ü™ò','üé∑','üé∫','ü™ó','üé∏','ü™ï','üéª','üé≤','‚ôüÔ∏è','üéØ','üé≥','üéÆ','üïπÔ∏è','üé∞']
        },
        'travel': {
            icon: 'üöó',
            name: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è',
            emojis: ['üöó','üöï','üöô','üöå','üöé','üèéÔ∏è','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','ü¶Ø','ü¶Ω','ü¶º','üõ¥','üö≤','üõµ','üèçÔ∏è','üõ∫','üö®','üöî','üöç','üöò','üöñ','üö°','üö†','üöü','üöÉ','üöã','üöû','üöù','üöÑ','üöÖ','üöà','üöÇ','üöÜ','üöá','üöä','üöâ','‚úàÔ∏è','üõ´','üõ¨','üõ©Ô∏è','üí∫','üõ∞Ô∏è','üöÄ','üõ∏','üöÅ','üõ∂','‚õµ','üö§','üõ•Ô∏è','üõ≥Ô∏è','‚õ¥Ô∏è','üö¢','‚öì','ü™ù','‚õΩ','üöß','üö¶','üö•','üöè','üó∫Ô∏è','üóø','üóΩ','üóº','üè∞','üèØ','üèüÔ∏è','üé°','üé¢','üé†','‚õ≤','‚õ±Ô∏è','üèñÔ∏è','üèùÔ∏è','üèúÔ∏è','üåã','‚õ∞Ô∏è','üèîÔ∏è','üóª','üèïÔ∏è','‚õ∫','üõñ','üè†','üè°','üèòÔ∏è','üèöÔ∏è','üèóÔ∏è','üè≠','üè¢','üè¨','üè£','üè§','üè•','üè¶','üè®','üè™','üè´','üè©','üíí','üèõÔ∏è','‚õ™','üïå','üïç','üõï','üïã','‚õ©Ô∏è','üõ§Ô∏è','üõ£Ô∏è','üóæ','üéë','üèûÔ∏è','üåÖ','üåÑ','üå†','üéá','üéÜ','üåá','üåÜ','üèôÔ∏è','üåÉ','üåå','üåâ','üåÅ']
        },
        'objects': {
            icon: 'üí°',
            name: '–û–±—ä–µ–∫—Ç—ã',
            emojis: ['‚åö','üì±','üì≤','üíª','‚å®Ô∏è','üñ•Ô∏è','üñ®Ô∏è','üñ±Ô∏è','üñ≤Ô∏è','üïπÔ∏è','üóúÔ∏è','üíΩ','üíæ','üíø','üìÄ','üìº','üì∑','üì∏','üìπ','üé•','üìΩÔ∏è','üéûÔ∏è','üìû','‚òéÔ∏è','üìü','üì†','üì∫','üìª','üéôÔ∏è','üéöÔ∏è','üéõÔ∏è','üß≠','‚è±Ô∏è','‚è≤Ô∏è','‚è∞','üï∞Ô∏è','‚åõ','‚è≥','üì°','üîã','üîå','üí°','üî¶','üïØÔ∏è','ü™î','üßØ','üõ¢Ô∏è','üí∏','üíµ','üí¥','üí∂','üí∑','ü™ô','üí∞','üí≥','üíé','‚öñÔ∏è','ü™ú','üß∞','ü™õ','üîß','üî®','‚öíÔ∏è','üõ†Ô∏è','‚õèÔ∏è','ü™ö','üî©','‚öôÔ∏è','ü™§','üß±','‚õìÔ∏è','üß≤','üî´','üí£','üß®','ü™ì','üî™','üó°Ô∏è','‚öîÔ∏è','üõ°Ô∏è','üö¨','‚ö∞Ô∏è','ü™¶','‚ö±Ô∏è','üè∫','üîÆ','üìø','üßø','üíà','‚öóÔ∏è','üî≠','üî¨','üï≥Ô∏è','ü©π','ü©∫','üíä','üíâ','ü©∏','üß¨','ü¶†','üß´','üß™','üå°Ô∏è','üßπ','ü™†','üß∫','üßª','üöΩ','üö∞','üöø','üõÅ','üõÄ','üßº','ü™•','ü™í','üßΩ','ü™£','üß¥','üõéÔ∏è','üîë','üóùÔ∏è','üö™','ü™ë','üõãÔ∏è','üõèÔ∏è','üõå','üß∏','ü™Ü','üñºÔ∏è','ü™û','ü™ü','üõçÔ∏è','üõí','üéÅ','üéà','üéè','üéÄ','ü™Ñ','ü™Ö','üéä','üéâ','üéé','üèÆ','üéê','üßß','‚úâÔ∏è','üì©','üì®','üìß','üíå','üì•','üì§','üì¶','üè∑Ô∏è','ü™ß','üì™','üì´','üì¨','üì≠','üìÆ','üìØ','üìú','üìÉ','üìÑ','üìë','üßæ','üìä','üìà','üìâ','üóíÔ∏è','üóìÔ∏è','üìÜ','üìÖ','üóëÔ∏è','üìá','üóÉÔ∏è','üó≥Ô∏è','üóÑÔ∏è','üìã','üìÅ','üìÇ','üóÇÔ∏è','üóûÔ∏è','üì∞','üìì','üìî','üìí','üìï','üìó','üìò','üìô','üìö','üìñ','üîñ','üß∑','üîó','üìé','üñáÔ∏è','üìê','üìè','üßÆ','üìå','üìç','‚úÇÔ∏è','üñäÔ∏è','üñãÔ∏è','‚úíÔ∏è','üñåÔ∏è','üñçÔ∏è','üìù','‚úèÔ∏è','üîç','üîé','üîè','üîê','üîí','üîì']
        },
        'symbols': {
            icon: '‚ù§Ô∏è',
            name: '–°–∏–º–≤–æ–ª—ã',
            emojis: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâÔ∏è','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è','‚ò¶Ô∏è','üõê','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå','‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','üÜî','‚öõÔ∏è','üâë','‚ò¢Ô∏è','‚ò£Ô∏è','üì¥','üì≥','üà∂','üàö','üà∏','üà∫','üà∑Ô∏è','‚ú¥Ô∏è','üÜö','üíÆ','üâê','„äôÔ∏è','„äóÔ∏è','üà¥','üàµ','üàπ','üà≤','üÖ∞Ô∏è','üÖ±Ô∏è','üÜé','üÜë','üÖæÔ∏è','üÜò','‚ùå','‚≠ï','üõë','‚õî','üìõ','üö´','üíØ','üí¢','‚ô®Ô∏è','üö∑','üöØ','üö≥','üö±','üîû','üìµ','üö≠','‚ùó','‚ùï','‚ùì','‚ùî','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','„ÄΩÔ∏è','‚ö†Ô∏è','üö∏','üî±','‚öúÔ∏è','üî∞','‚ôªÔ∏è','‚úÖ','üàØ','üíπ','‚ùáÔ∏è','‚ú≥Ô∏è','‚ùé','üåê','üí†','‚ìÇÔ∏è','üåÄ','üí§','üèß','üöæ','‚ôø','üÖøÔ∏è','üõó','üà≥','üàÇÔ∏è','üõÇ','üõÉ','üõÑ','üõÖ','üöπ','üö∫','üöº','‚ößÔ∏è','üöª','üöÆ','üé¶','üì∂','üàÅ','üî£','‚ÑπÔ∏è','üî§','üî°','üî†','üÜñ','üÜó','üÜô','üÜí','üÜï','üÜì','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü','üî¢','#Ô∏è‚É£','*Ô∏è‚É£','‚èèÔ∏è','‚ñ∂Ô∏è','‚è∏Ô∏è','‚èØÔ∏è','‚èπÔ∏è','‚è∫Ô∏è','‚è≠Ô∏è','‚èÆÔ∏è','‚è©','‚è™','‚è´','‚è¨','‚óÄÔ∏è','üîº','üîΩ','‚û°Ô∏è','‚¨ÖÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è','‚ÜóÔ∏è','‚ÜòÔ∏è','‚ÜôÔ∏è','‚ÜñÔ∏è','‚ÜïÔ∏è','‚ÜîÔ∏è','‚Ü™Ô∏è','‚Ü©Ô∏è','‚§¥Ô∏è','‚§µÔ∏è','üîÄ','üîÅ','üîÇ','üîÑ','üîÉ','üéµ','üé∂','‚ûï','‚ûñ','‚ûó','‚úñÔ∏è','üü∞','‚ôæÔ∏è','üí≤','üí±','‚Ñ¢Ô∏è','¬©Ô∏è','¬ÆÔ∏è','üëÅÔ∏è‚Äçüó®Ô∏è','üîö','üîô','üîõ','üîù','üîú','„Ä∞Ô∏è','‚û∞','‚ûø','‚úîÔ∏è','‚òëÔ∏è','üîò','üî¥','üü†','üü°','üü¢','üîµ','üü£','‚ö´','‚ö™','üü§','üî∫','üîª','üî∏','üîπ','üî∂','üî∑','üî≥','üî≤','‚ñ™Ô∏è','‚ñ´Ô∏è','‚óæ','‚óΩ','‚óºÔ∏è','‚óªÔ∏è','üü•','üüß','üü®','üü©','üü¶','üü™','‚¨õ','‚¨ú','üü´','üîà','üîá','üîâ','üîä','üîî','üîï','üì£','üì¢','üí¨','üí≠','üóØÔ∏è','‚ô†Ô∏è','‚ô£Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','üÉè','üé¥','üÄÑ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö','üïõ','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶','üïß']
        },
        'flags': {
            icon: 'üè≥Ô∏è',
            name: '–§–ª–∞–≥–∏',
            emojis: ['üè≥Ô∏è','üè¥','üè¥‚Äç‚ò†Ô∏è','üèÅ','üö©','üéå','üè≥Ô∏è‚Äçüåà','üè≥Ô∏è‚Äç‚ößÔ∏è','üá∫üá≥','üá¶üá´','üá¶üáΩ','üá¶üá±','üá©üáø','üá¶üá∏','üá¶üá©','üá¶üá¥','üá¶üáÆ','üá¶üá∂','üá¶üá¨','üá¶üá∑','üá¶üá≤','üá¶üáº','üá¶üá∫','üá¶üáπ','üá¶üáø','üáßüá∏','üáßüá≠','üáßüá©','üáßüáß','üáßüáæ','üáßüá™','üáßüáø','üáßüáØ','üáßüá≤','üáßüáπ','üáßüá¥','üáßüá¶','üáßüáº','üáßüá∑','üáÆüá¥','üáªüá¨','üáßüá≥','üáßüá¨','üáßüá´','üáßüáÆ','üá∞üá≠','üá®üá≤','üá®üá¶','üáÆüá®','üá®üáª','üáßüá∂','üá∞üáæ','üá®üá´','üáπüá©','üá®üá±','üá®üá≥','üá®üáΩ','üá®üá®','üá®üá¥','üá∞üá≤','üá®üá¨','üá®üá©','üá®üá∞','üá®üá∑','üá®üáÆ','üá≠üá∑','üá®üá∫','üá®üáº','üá®üáæ','üá®üáø','üá©üá∞','üá©üáØ','üá©üá≤','üá©üá¥','üá™üá®','üá™üá¨','üá∏üáª','üá¨üá∂','üá™üá∑','üá™üá™','üá∏üáø','üá™üáπ','üá™üá∫','üá´üá∞','üá´üá¥','üá´üáØ','üá´üáÆ','üá´üá∑','üá¨üá´','üáµüá´','üáπüá´','üá¨üá¶','üá¨üá≤','üá¨üá™','üá©üá™','üá¨üá≠','üá¨üáÆ','üá¨üá∑','üá¨üá±','üá¨üá©','üá¨üáµ','üá¨üá∫','üá¨üáπ','üá¨üá¨','üá¨üá≥','üá¨üáº','üá¨üáæ','üá≠üáπ','üá≠üá≥','üá≠üá∞','üá≠üá∫','üáÆüá∏','üáÆüá≥','üáÆüá©','üáÆüá∑','üáÆüá∂','üáÆüá™','üáÆüá≤','üáÆüá±','üáÆüáπ','üáØüá≤','üáØüáµ','üéå','üáØüá™','üáØüá¥','üá∞üáø','üá∞üá™','üá∞üáÆ','üáΩüá∞','üá∞üáº','üá∞üá¨','üá±üá¶','üá±üáª','üá±üáß','üá±üá∏','üá±üá∑','üá±üáæ','üá±üáÆ','üá±üáπ','üá±üá∫','üá≤üá¥','üá≤üá¨','üá≤üáº','üá≤üáæ','üá≤üáª','üá≤üá±','üá≤üáπ','üá≤üá≠','üá≤üá∂','üá≤üá∑','üá≤üá∫','üáæüáπ','üá≤üáΩ','üá´üá≤','üá≤üá©','üá≤üá®','üá≤üá≥','üá≤üá™','üá≤üá∏','üá≤üá¶','üá≤üáø','üá≤üá≤','üá≥üá¶','üá≥üá∑','üá≥üáµ','üá≥üá±','üá≥üá®','üá≥üáø','üá≥üáÆ','üá≥üá™','üá≥üá¨','üá≥üá∫','üá≥üá´','üá∞üáµ','üá≤üá∞','üá≤üáµ','üá≥üá¥','üá¥üá≤','üáµüá∞','üáµüáº','üáµüá∏','üáµüá¶','üáµüá¨','üáµüáæ','üáµüá™','üáµüá≠','üáµüá≥','üáµüá±','üáµüáπ','üáµüá∑','üá∂üá¶','üá∑üá™','üá∑üá¥','üá∑üá∫','üá∑üáº','üáºüá∏','üá∏üá≤','üá∏üáπ','üá∏üá¶','üá∏üá≥','üá∑üá∏','üá∏üá®','üá∏üá±','üá∏üá¨','üá∏üáΩ','üá∏üá∞','üá∏üáÆ','üá¨üá∏','üá∏üáß','üá∏üá¥','üáøüá¶','üá∞üá∑','üá∏üá∏','üá™üá∏','üá±üá∞','üáßüá±','üá∏üá≠','üá∞üá≥','üá±üá®','üáµüá≤','üáªüá®','üá∏üá©','üá∏üá∑','üá∏üá™','üá®üá≠','üá∏üáæ','üáπüáº','üáπüáØ','üáπüáø','üáπüá≠','üáπüá±','üáπüá¨','üáπüá∞','üáπüá¥','üáπüáπ','üáπüá≥','üáπüá∑','üáπüá≤','üáπüá®','üáπüáª','üáªüáÆ','üá∫üá¨','üá∫üá¶','üá¶üá™','üá¨üáß','üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø','üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø','üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø','üá∫üá∏','üá∫üáæ','üá∫üáø','üáªüá∫','üáªüá¶','üáªüá™','üáªüá≥','üáºüá´','üá™üá≠','üáæüá™','üáøüá≤','üáøüáº']
        }
    };

    let currentEmojiCategory = 'smileys';

    function initEmoji() {
        const tabsContainer = document.getElementById('emoji-tabs');
        const contentContainer = document.getElementById('emoji-content');
        
        // –°–æ–∑–¥–∞–µ–º —Ç–∞–±—ã
        tabsContainer.innerHTML = '';
        Object.keys(emojiCategories).forEach(key => {
            const cat = emojiCategories[key];
            const tab = document.createElement('div');
            tab.className = `emoji-tab ${key === currentEmojiCategory ? 'active' : ''}`;
            tab.innerText = cat.icon;
            tab.title = cat.name;
            tab.onclick = () => selectEmojiCategory(key);
            tabsContainer.appendChild(tab);
        });
        
        renderEmojiCategory(currentEmojiCategory);
        
        // –ü–æ–∏—Å–∫
        document.getElementById('emoji-search-input').oninput = (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (query) {
                searchEmojis(query);
            } else {
                renderEmojiCategory(currentEmojiCategory);
            }
        };
    }

    function selectEmojiCategory(key) {
        currentEmojiCategory = key;
        document.querySelectorAll('.emoji-tab').forEach((tab, i) => {
            tab.classList.toggle('active', Object.keys(emojiCategories)[i] === key);
        });
        document.getElementById('emoji-search-input').value = '';
        renderEmojiCategory(key);
    }

    function renderEmojiCategory(key) {
        const contentContainer = document.getElementById('emoji-content');
        const cat = emojiCategories[key];
        
        contentContainer.innerHTML = `
            <div class="emoji-category-title">${cat.name}</div>
            <div class="emoji-grid"></div>
        `;
        
        const grid = contentContainer.querySelector('.emoji-grid');
        cat.emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.innerText = emoji;
            span.onclick = () => insertEmoji(emoji);
            grid.appendChild(span);
        });
    }

    function searchEmojis(query) {
        const contentContainer = document.getElementById('emoji-content');
        contentContainer.innerHTML = '<div class="emoji-category-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</div><div class="emoji-grid"></div>';
        const grid = contentContainer.querySelector('.emoji-grid');
        
        let found = false;
        Object.values(emojiCategories).forEach(cat => {
            cat.emojis.forEach(emoji => {
                if (emoji.includes(query) || cat.name.toLowerCase().includes(query)) {
                    found = true;
                    const span = document.createElement('span');
                    span.className = 'emoji-item';
                    span.innerText = emoji;
                    span.onclick = () => insertEmoji(emoji);
                    grid.appendChild(span);
                }
            });
        });
        
        if (!found) {
            contentContainer.innerHTML = '<div class="p-4 text-center text-sm opacity-50">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        }
    }

    function insertEmoji(emoji) {
        const input = document.getElementById('msg-input');
        input.value += emoji;
        input.focus();
    }
    
    window.toggleEmoji = () => document.getElementById('emoji-panel').classList.toggle('active');

    // ========== –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ==========
    let mediaRecorder = null;
    let audioChunks = [];
    let voiceTimerInterval = null;
    let voiceStartTime = null;
    let isRecording = false;

    window.startVoice = async () => {
        if (isRecording || !activeChatPartner) return;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };
            
            mediaRecorder.onstop = async () => {
                stream.getTracks().forEach(track => track.stop());
                
                if (audioChunks.length > 0 && isRecording) {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–ª–∏–º–∏—Ç 1MB)
                    if (audioBlob.size > 1 * 1024 * 1024) {
                        alert('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å ~1 –º–∏–Ω—É—Ç–∞)');
                        resetVoiceUI();
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = () => {
                        const duration = Math.floor((Date.now() - voiceStartTime) / 1000);
                        sendMsg({ 
                            type: 'voice', 
                            voiceData: reader.result,
                            voiceDuration: duration
                        });
                    };
                    reader.readAsDataURL(audioBlob);
                }
                
                resetVoiceUI();
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            document.getElementById('voice-btn').classList.add('recording');
            document.getElementById('msg-input').classList.add('hidden');
            document.getElementById('voice-recording-ui').classList.remove('hidden');
            
            voiceStartTime = Date.now();
            voiceTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - voiceStartTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('voice-timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
        }
    };

    window.stopVoice = () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    };

    window.cancelVoice = () => {
        isRecording = false;
        audioChunks = [];
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        resetVoiceUI();
    };

    function resetVoiceUI() {
        isRecording = false;
        document.getElementById('voice-btn').classList.remove('recording');
        document.getElementById('msg-input').classList.remove('hidden');
        document.getElementById('voice-recording-ui').classList.add('hidden');
        document.getElementById('voice-timer').innerText = '0:00';
        
        if (voiceTimerInterval) {
            clearInterval(voiceTimerInterval);
            voiceTimerInterval = null;
        }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
    let currentPlayingAudio = null;

    window.playVoice = (btn, audioData, duration) => {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        if (currentPlayingAudio) {
            currentPlayingAudio.pause();
            currentPlayingAudio.currentTime = 0;
            document.querySelectorAll('.voice-play-btn').forEach(b => {
                b.innerHTML = '<i class="fas fa-play"></i>';
            });
        }
        
        const audio = new Audio(audioData);
        const progressFill = btn.parentElement.querySelector('.voice-progress-fill');
        const timeDisplay = btn.parentElement.querySelector('.voice-time');
        
        if (currentPlayingAudio === audio) {
            currentPlayingAudio = null;
            return;
        }
        
        currentPlayingAudio = audio;
        btn.innerHTML = '<i class="fas fa-pause"></i>';
        
        audio.ontimeupdate = () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = progress + '%';
            const remaining = Math.ceil(audio.duration - audio.currentTime);
            timeDisplay.innerText = `0:${remaining.toString().padStart(2, '0')}`;
        };
        
        audio.onended = () => {
            btn.innerHTML = '<i class="fas fa-play"></i>';
            progressFill.style.width = '0%';
            timeDisplay.innerText = `0:${duration.toString().padStart(2, '0')}`;
            currentPlayingAudio = null;
        };
        
        audio.play();
    };

    document.getElementById('search-input').oninput = async (e) => {
        const val = e.target.value.trim().toLowerCase();
        const res = document.getElementById('search-results');
        if (val.length < 1) { res.classList.add('hidden'); return; }
        
        const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
        res.innerHTML = '';
        res.classList.remove('hidden');
        
        let found = false;
        snap.forEach(d => {
            const u = d.data();
            if (u.username.toLowerCase().includes(val) && u.uid !== me?.uid) {
                found = true;
                const div = document.createElement('div');
                div.className = "p-4 hover:bg-indigo-500/10 cursor-pointer text-sm font-bold flex items-center justify-between group";
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg bg-indigo-500 text-white flex items-center justify-center">${u.username[0]}</div>
                        <span>@${u.username}</span>
                    </div>
                `;
                div.onclick = () => { selectChat(u); res.classList.add('hidden'); e.target.value = ''; };
                res.appendChild(div);
            }
        });
        if(!found) res.innerHTML = '<div class="p-4 text-center text-xs opacity-50 italic">–ù–∏–∫—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
    };

    window.toggleSettings = () => {
        document.getElementById('settings-panel').classList.toggle('active');
        if (me) {
            document.getElementById('settings-username').innerText = '@' + me.username;
            updateSettingsAvatar();
        }
    };

    window.triggerAvatarUpload = () => document.getElementById('avatar-input').click();

    window.handleAvatarUpload = async (input) => {
        const file = input.files[0];
        if (!file || !me) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å 500KB –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏)
        if (file.size > 500 * 1024) {
            alert('–ê–≤–∞—Ç–∞—Ä–∫–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è. –ú–∞–∫—Å–∏–º—É–º 500KB.');
            input.value = '';
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø
        if (!file.type.startsWith('image/')) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            const avatarData = e.target.result;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), {
                avatar: avatarData
            }, { merge: true });

            me.avatar = avatarData;
            updateAllAvatars();
        };
        reader.readAsDataURL(file);
        input.value = '';
    };

    function updateSettingsAvatar() {
        const settingsAvatar = document.getElementById('settings-avatar');
        if (me?.avatar) {
            settingsAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover">`;
        } else {
            settingsAvatar.innerText = me?.username?.[0]?.toUpperCase() || '?';
        }
    }

    function updateAllAvatars() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        const myAvatar = document.getElementById('my-avatar');
        if (me?.avatar) {
            myAvatar.innerHTML = `<img src="${me.avatar}" class="w-full h-full object-cover rounded-2xl">`;
        } else {
            myAvatar.innerHTML = me?.username?.[0]?.toUpperCase() || '?';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        updateSettingsAvatar();
    }
    
    window.setTheme = (t) => {
        document.body.className = `theme-${t} h-screen flex flex-col overflow-hidden`;
        if(me?.uid) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', me.uid), { settings: { theme: t } }, { merge: true });
    };

    document.getElementById('msg-input').onkeydown = e => { if(e.key === 'Enter') sendMsg(); };

    document.addEventListener('mousedown', (e) => {
        const emojiPanel = document.getElementById('emoji-panel');
        if (!emojiPanel.contains(e.target) && !e.target.closest('button')) {
            emojiPanel.classList.remove('active');
        }
    });

    // ========== WebRTC –ó–≤–æ–Ω–∫–∏ ==========
    const iceServers = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };

    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    let currentCallId = null;
    let callTimerInterval = null;
    let callStartTime = null;
    let isVideoCall = false;
    let callUnsub = null;
    let isMuted = false;
    let isVideoOff = false;

    const ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
    ringtone.loop = true;

    // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏
    function listenForCalls() {
        if (!me) return;
        const callRef = doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current');
        
        callUnsub = onSnapshot(callRef, async (snap) => {
            if (snap.exists()) {
                const callData = snap.data();
                if (callData.status === 'ringing' && !currentCallId) {
                    showIncomingCall(callData);
                }
            }
        });
    }

    function showIncomingCall(callData) {
        currentCallId = callData.callId;
        isVideoCall = callData.isVideo;
        
        document.getElementById('caller-avatar').innerText = callData.callerName[0].toUpperCase();
        document.getElementById('caller-name').innerText = '@' + callData.callerName;
        document.getElementById('call-type-label').innerText = isVideoCall ? '–í–∏–¥–µ–æ –∑–≤–æ–Ω–æ–∫' : '–ê—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫';
        document.getElementById('incoming-call-screen').classList.remove('hidden');
        
        ringtone.play().catch(() => {});
    }

    window.startCall = async (withVideo) => {
        if (!activeChatPartner || !me) return;
        
        isVideoCall = withVideo;
        currentCallId = `${me.uid}_${activeChatPartner.uid}_${Date.now()}`;
        
        document.getElementById('callee-avatar').innerText = activeChatPartner.username[0].toUpperCase();
        document.getElementById('callee-name').innerText = '@' + activeChatPartner.username;
        document.getElementById('outgoing-call-screen').classList.remove('hidden');
        
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
                video: withVideo
            });
            
            // –°–æ–∑–¥–∞–µ–º offer
            peerConnection = new RTCPeerConnection(iceServers);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.onicecandidate = async (e) => {
                if (e.candidate) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_caller'), {
                        candidate: e.candidate.toJSON(),
                        timestamp: serverTimestamp()
                    });
                }
            };
            
            peerConnection.ontrack = (e) => {
                remoteStream = e.streams[0];
                document.getElementById('remote-video').srcObject = remoteStream;
            };
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫ –≤ Firebase
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                callerId: me.uid,
                callerName: me.username,
                calleeId: activeChatPartner.uid,
                calleeName: activeChatPartner.username,
                isVideo: withVideo,
                offer: { type: offer.type, sdp: offer.sdp },
                status: 'ringing',
                timestamp: serverTimestamp()
            });
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            await setDoc(doc(db, 'artifacts', appId, 'users', activeChatPartner.uid, 'incoming_call', 'current'), {
                callId: currentCallId,
                callerId: me.uid,
                callerName: me.username,
                isVideo: withVideo,
                status: 'ringing'
            });
            
            // –°–ª—É—à–∞–µ–º –æ—Ç–≤–µ—Ç
            const callDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId);
            onSnapshot(callDocRef, async (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                
                if (data.status === 'answered' && data.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    showActiveCall(activeChatPartner.username);
                }
                
                if (data.status === 'declined' || data.status === 'ended') {
                    endCallCleanup();
                }
            });
            
            // –°–ª—É—à–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_callee'), (snap) => {
                snap.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && peerConnection) {
                        const data = change.doc.data();
                        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                });
            });
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            endCallCleanup();
        }
    };

    window.acceptCall = async () => {
        ringtone.pause();
        ringtone.currentTime = 0;
        document.getElementById('incoming-call-screen').classList.add('hidden');
        
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
                video: isVideoCall
            });
            
            peerConnection = new RTCPeerConnection(iceServers);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.onicecandidate = async (e) => {
                if (e.candidate) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_callee'), {
                        candidate: e.candidate.toJSON(),
                        timestamp: serverTimestamp()
                    });
                }
            };
            
            peerConnection.ontrack = (e) => {
                remoteStream = e.streams[0];
                document.getElementById('remote-video').srcObject = remoteStream;
            };
            
            // –ü–æ–ª—É—á–∞–µ–º offer
            const callDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId));
            const callData = callDoc.data();
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                answer: { type: answer.type, sdp: answer.sdp },
                status: 'answered'
            }, { merge: true });
            
            // –û—á–∏—â–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'), { status: 'cleared' });
            
            // –°–ª—É—à–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç –∑–≤–æ–Ω—è—â–µ–≥–æ
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'ice_candidates_caller'), (snap) => {
                snap.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && peerConnection) {
                        const data = change.doc.data();
                        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                });
            });
            
            // –°–ª—É—à–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), (snap) => {
                if (snap.exists() && snap.data().status === 'ended') {
                    endCallCleanup();
                }
            });
            
            showActiveCall(callData.callerName);
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            declineCall();
        }
    };

    window.declineCall = async () => {
        ringtone.pause();
        ringtone.currentTime = 0;
        document.getElementById('incoming-call-screen').classList.add('hidden');
        
        if (currentCallId) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                status: 'declined'
            }, { merge: true });
            await setDoc(doc(db, 'artifacts', appId, 'users', me.uid, 'incoming_call', 'current'), { status: 'cleared' });
        }
        
        endCallCleanup();
    };

    window.cancelCall = async () => {
        document.getElementById('outgoing-call-screen').classList.add('hidden');
        
        if (currentCallId && activeChatPartner) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                status: 'ended'
            }, { merge: true });
            await setDoc(doc(db, 'artifacts', appId, 'users', activeChatPartner.uid, 'incoming_call', 'current'), { status: 'cleared' });
        }
        
        endCallCleanup();
    };

    window.endCall = async () => {
        if (currentCallId) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), {
                status: 'ended'
            }, { merge: true });
        }
        endCallCleanup();
    };

    function showActiveCall(partnerName) {
        document.getElementById('outgoing-call-screen').classList.add('hidden');
        document.getElementById('incoming-call-screen').classList.add('hidden');
        document.getElementById('active-call-screen').classList.remove('hidden');
        document.getElementById('active-call-name').innerText = '@' + partnerName;
        
        if (localStream) {
            document.getElementById('local-video').srcObject = localStream;
        }
        
        // –¢–∞–π–º–µ—Ä –∑–≤–æ–Ω–∫–∞
        callStartTime = Date.now();
        callTimerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('call-timer').innerText = `${mins}:${secs}`;
        }, 1000);
    }

    function endCallCleanup() {
        document.getElementById('outgoing-call-screen').classList.add('hidden');
        document.getElementById('incoming-call-screen').classList.add('hidden');
        document.getElementById('active-call-screen').classList.add('hidden');
        
        ringtone.pause();
        ringtone.currentTime = 0;
        
        if (callTimerInterval) {
            clearInterval(callTimerInterval);
            callTimerInterval = null;
        }
        
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        remoteStream = null;
        currentCallId = null;
        isMuted = false;
        isVideoOff = false;
        
        document.getElementById('mute-btn').classList.remove('active');
        document.getElementById('video-btn').classList.remove('active');
    }

    window.toggleMute = () => {
        if (!localStream) return;
        isMuted = !isMuted;
        localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
        
        const btn = document.getElementById('mute-btn');
        btn.classList.toggle('active', isMuted);
        btn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
    };

    window.toggleVideo = () => {
        if (!localStream) return;
        isVideoOff = !isVideoOff;
        localStream.getVideoTracks().forEach(track => track.enabled = !isVideoOff);
        
        const btn = document.getElementById('video-btn');
        btn.classList.toggle('active', isVideoOff);
        btn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
    };

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∑–≤–æ–Ω–∫–æ–≤ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const originalShowApp = showApp;
    window.showApp = showApp = function() {
        originalShowApp.call ? originalShowApp.call(this) : originalShowApp();
        listenForCalls();
    };
</script>
</body>
</html>
